<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">use ip modify route table use vip as src trans in multi-IP bonded env</h2>
	<h5 id="">2014-06-18 14:00:16&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020145181134983/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>在某些场景中, 当一个服务器的一块网卡上面配置了多个IP时, 例如虚拟IP, 可能想指定虚拟IP地址作为出口地址.</div><div>例如对这个虚拟IP有鉴权要求的场景. 如PostgreSQL的pg_hba.conf.</div><div>如在集中的流复制standby场景, 当集中的主机DOWN掉的话, 希望把虚拟IP切走, 同时生产机也只允许这个虚拟IP来访问的情况.</div><div>那么需要改写集中流复制的主机的路由表, 让其出口为虚拟IP.&nbsp;</div><div><br></div><div>默认情况下当有多个IP时, 路由是primary优先的.&nbsp;</div><div>如下, 默认的出口是<span style="line-height: 28px;"   >&nbsp; &nbsp; inet 172.16.3.111/24 brd 172.16.3.255 scope global eth0 而不是eth0:1</span></div><div><div style="line-height: 28px;"   ><font size="2"   color="#ff0000"   >[root@db-<span style="line-height: 28px;"   >172-16-3-111</span>&nbsp;network-scripts]# ip addr show</font></div><div style="line-height: 28px;"   ><font size="2"   color="#ff0000"   >1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 16436 qdisc noqueue state UNKNOWN&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   color="#ff0000"   >&nbsp; &nbsp; link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</font></div><div style="line-height: 28px;"   ><font size="2"   color="#ff0000"   >&nbsp; &nbsp; inet 127.0.0.1/8 scope host lo</font></div><div style="line-height: 28px;"   ><font size="2"   color="#ff0000"   >&nbsp; &nbsp; inet6 ::1/128 scope host&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp;valid_lft forever preferred_lft forever</font></div><div style="line-height: 28px;"   ><font size="2"   color="#ff0000"   >2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP qlen 1000</font></div><div style="line-height: 28px;"   ><font size="2"   color="#ff0000"   >&nbsp; &nbsp; link/ether b8:ca:3a:6d:fe:b0 brd ff:ff:ff:ff:ff:ff</font></div><div style="line-height: 28px;"   ><font size="2"   color="#ff0000"   >&nbsp; &nbsp; inet 172.16.3.111/24 brd 172.16.3.255 scope global eth0</font></div><div style="line-height: 28px;"   ><font size="2"   color="#ff0000"   >&nbsp; &nbsp; inet 172.16.3.1/24 brd 172.16.1.255 scope global secondary eth0:1</font></div></div><div style="line-height: 28px;"   ><br></div><div>为了达到指定出口IP的目的, 可以通过修改路由表来实现.</div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 ~]# which ip</font></div><div><font size="2"   color="#ff0000"   >/sbin/ip</font></div><div>在没有创建eth0:1的情况下的默认路由如下 :&nbsp;</div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 ~]# ip route</font></div><div><font size="2"   color="#ff0000"   >172.16.3.0/24 dev eth0 &nbsp;proto kernel &nbsp;scope link &nbsp;src 172.16.3.111&nbsp;</font></div><div><font size="2"   color="#ff0000"   >169.254.0.0/16 dev eth0 &nbsp;scope link &nbsp;metric 1002&nbsp;</font></div><div><font size="2"   color="#ff0000"   >default via 172.16.3.1 dev eth0&nbsp;</font></div><div>新增一个IP地址</div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 ~]# cd /etc/sysconfig/network-scripts/</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# cp ifcfg-eth0 ifcfg-eth0:1</font></div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# vi ifcfg-eth0:1</font></div><div><font size="2"   color="#ff0000"   >DEVICE="eth0:1"</font></div><div><font size="2"   color="#ff0000"   >BOOTPROTO="static"</font></div><div><font size="2"   color="#ff0000"   >IPADDR="172.16.3.105"</font></div><div><font size="2"   color="#ff0000"   >NETMASK="255.255.255.0"</font></div><div><font size="2"   color="#ff0000"   >HWADDR="B8:CA:3A:6D:FE:B0"</font></div><div><font size="2"   color="#ff0000"   >IPV6INIT="no"</font></div><div><font size="2"   color="#ff0000"   >MTU="1500"</font></div><div><font size="2"   color="#ff0000"   >NM_CONTROLLED="no"</font></div><div><font size="2"   color="#ff0000"   >ONBOOT="no"</font></div><div><font size="2"   color="#ff0000"   >TYPE="Ethernet"</font></div><div><font size="2"   color="#ff0000"   >UUID="37fb27ad-4293-43ba-a3b7-8e94fa563384"</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ifup eth0:1</font></div><div><font size="2"   color="#ff0000"   >Determining if ip address 172.16.3.105 is already in use for device eth0...</font></div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ifconfig</font></div><div><font size="2"   color="#ff0000"   >eth0 &nbsp; &nbsp; &nbsp;Link encap:Ethernet &nbsp;HWaddr B8:CA:3A:6D:FE:B0 &nbsp;</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet addr:172.16.3.111 &nbsp;Bcast:172.16.3.255 &nbsp;Mask:255.255.255.0</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet6 addr: fe80::baca:3aff:fe6d:feb0/64 Scope:Link</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP BROADCAST RUNNING MULTICAST &nbsp;MTU:1500 &nbsp;Metric:1</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX packets:536391 errors:0 dropped:0 overruns:0 frame:0</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TX packets:88849 errors:0 dropped:0 overruns:0 carrier:0</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; collisions:0 txqueuelen:1000&nbsp;</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX bytes:718980563 (685.6 MiB) &nbsp;TX bytes:4883966 (4.6 MiB)</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Memory:dcb00000-dcc00000&nbsp;</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >eth0:1 &nbsp; &nbsp;Link encap:Ethernet &nbsp;HWaddr B8:CA:3A:6D:FE:B0 &nbsp;</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet addr:172.16.3.105 &nbsp;Bcast:172.16.3.255 &nbsp;Mask:255.255.255.0</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP BROADCAST RUNNING MULTICAST &nbsp;MTU:1500 &nbsp;Metric:1</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Memory:dcb00000-dcc00000&nbsp;</font></div><div><br></div><div>然后添加路由, 目的是增加一条metric=1的路由, 使得去整个广播域和网关走新增的这个地址出去.</div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ip route add default via 172.16.3.1 dev eth0 src 172.16.3.105 metric 1</font></div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ip route add 172.16.3.0/24 dev eth0 &nbsp;proto kernel &nbsp;scope link &nbsp;src 172.16.3.105 metric 1</font></div><div>然后删除原路由条目</div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ip route del default via 172.16.3.1 dev eth0</font></div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ip route del 172.16.3.0/24 dev eth0 &nbsp;proto kernel &nbsp;scope link &nbsp;src 172.16.3.111</font></div><div>注意, 最好增加2个条目, 如果虚拟IP切走的话, 还能正常走eth0出去的路由. 只是metric改大一点.</div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ip route add default via 172.16.3.1 dev eth0 src 172.16.3.111 metric 100</font></div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ip route add 172.16.3.0/24 dev eth0 &nbsp;proto kernel &nbsp;scope link &nbsp;src 172.16.3.111 metric 100</font></div><div>添加完后的路由表</div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ip route</font></div><div><font size="2"   color="#ff0000"   >172.16.3.0/24 dev eth0 &nbsp;proto kernel &nbsp;scope link &nbsp;src 172.16.3.105 &nbsp;metric 1&nbsp;</font></div><div><font size="2"   color="#ff0000"   >172.16.3.0/24 dev eth0 &nbsp;proto kernel &nbsp;scope link &nbsp;src 172.16.3.111 &nbsp;metric 100&nbsp;</font></div><div><font size="2"   color="#ff0000"   >169.254.0.0/16 dev eth0 &nbsp;scope link &nbsp;metric 1002&nbsp;</font></div><div><font size="2"   color="#ff0000"   >default via 172.16.3.1 dev eth0 &nbsp;src 172.16.3.105 &nbsp;metric 1&nbsp;</font></div><div><font size="2"   color="#ff0000"   >default via 172.16.3.1 dev eth0 &nbsp;metric 100&nbsp;</font></div><div>看看路由有没有生效, 已经使用了我们配置的metric=1的路由条目.</div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ip route get 192.168.1.1</font></div><div><font size="2"   color="#ff0000"   >192.168.1.1 via 172.16.3.1 dev eth0 &nbsp;src 172.16.3.105&nbsp;</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; cache &nbsp;mtu 1500 advmss 1460 hoplimit 64</font></div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ip route get 172.16.3.1</font></div><div><font size="2"   color="#ff0000"   >172.16.3.1 dev eth0 &nbsp;src 172.16.3.105&nbsp;</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; cache &nbsp;mtu 1500 advmss 1460 hoplimit 64</font></div><div><br></div><div>关闭这个虚拟IP, 走metric=100的路由条目</div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ifdown eth0:1</font></div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ip route get 172.16.3.1</font></div><div><font size="2"   color="#ff0000"   >172.16.3.1 dev eth0 &nbsp;src 172.16.3.111&nbsp;</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; cache &nbsp;mtu 1500 advmss 1460 hoplimit 64</font></div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ip route get 192.168.1.1</font></div><div><font size="2"   color="#ff0000"   >192.168.1.1 via 172.16.3.1 dev eth0 &nbsp;src 172.16.3.111&nbsp;</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; cache &nbsp;mtu 1500 advmss 1460 hoplimit 64</font></div><div><br></div><div>关闭eth0:1后, 路由条目自动消失.&nbsp;</div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ip route</font></div><div><font size="2"   color="#ff0000"   >172.16.3.0/24 dev eth0 &nbsp;proto kernel &nbsp;scope link &nbsp;src 172.16.3.111 &nbsp;metric 100&nbsp;<span style="white-space:pre;"   >	</span></font></div><div><font size="2"   color="#ff0000"   >169.254.0.0/16 dev eth0 &nbsp;scope link &nbsp;metric 1002&nbsp;</font></div><div><font size="2"   color="#ff0000"   >default via 172.16.3.1 dev eth0 &nbsp;metric 100&nbsp;</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ifup eth0:1</font></div><div><font size="2"   color="#ff0000"   >Determining if ip address 172.16.3.105 is already in use for device eth0...</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ip route</font></div><div><font size="2"   color="#ff0000"   >172.16.3.0/24 dev eth0 &nbsp;proto kernel &nbsp;scope link &nbsp;src 172.16.3.111 &nbsp;metric 100&nbsp;</font></div><div><font size="2"   color="#ff0000"   >169.254.0.0/16 dev eth0 &nbsp;scope link &nbsp;metric 1002&nbsp;</font></div><div><font size="2"   color="#ff0000"   >default via 172.16.3.1 dev eth0&nbsp;</font></div><div><font size="2"   color="#ff0000"   >default via 172.16.3.1 dev eth0 &nbsp;metric 100&nbsp;</font></div><div><br></div><div>如果虚拟IP切回来, 又要重新写路由, 比较土的方法是重启network服务, 然后执行前面一样的步骤添加路由.</div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# service network restart</font></div><div><font size="2"   color="#ff0000"   >Shutting down interface eth0: &nbsp;[ &nbsp;OK &nbsp;]</font></div><div><font size="2"   color="#ff0000"   >Shutting down loopback interface: &nbsp;[ &nbsp;OK &nbsp;]</font></div><div><font size="2"   color="#ff0000"   >Bringing up loopback interface: &nbsp;[ &nbsp;OK &nbsp;]</font></div><div><font size="2"   color="#ff0000"   >Bringing up interface eth0: &nbsp;Determining if ip address 172.16.3.111 is already in use for device eth0...</font></div><div><font size="2"   color="#ff0000"   >[ &nbsp;OK &nbsp;]</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ip route</font></div><div><font size="2"   color="#ff0000"   >172.16.3.0/24 dev eth0 &nbsp;proto kernel &nbsp;scope link &nbsp;src 172.16.3.111&nbsp;</font></div><div><font size="2"   color="#ff0000"   >169.254.0.0/16 dev eth0 &nbsp;scope link &nbsp;metric 1002&nbsp;</font></div><div><font size="2"   color="#ff0000"   >default via 172.16.3.1 dev eth0&nbsp;</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ip route add default via 172.16.3.1 dev eth0 src 172.16.3.105 metric 1</font></div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ip route add 172.16.3.0/24 dev eth0 &nbsp;proto kernel &nbsp;scope link &nbsp;src 172.16.3.105 metric 1</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ip route del default via 172.16.3.1 dev eth0</font></div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ip route del 172.16.3.0/24 dev eth0 &nbsp;proto kernel &nbsp;scope link &nbsp;src 172.16.3.111</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ip route add default via 172.16.3.1 dev eth0 src 172.16.3.111 metric 100</font></div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ip route add 172.16.3.0/24 dev eth0 &nbsp;proto kernel &nbsp;scope link &nbsp;src 172.16.3.111 metric 100</font></div><div><br></div><div>比较方便的方法是写配置文件, 或者是使用iptables .</div><div>配置文件比较多, 参考</div><div><span style="line-height: 28px;"   ><font size="2"   color="#ff0000"   >/usr/share/doc/initscripts-9.03.40/sysconfig.txt</font></span></div><div><span style="line-height: 28px;"   >这里用到ifup-post调用的ifup-routes</span></div><div><div><font size="2"   color="#ff0000"   >/etc/sysconfig/network-scripts/route-&lt;interface-name&gt;</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >&nbsp; Contains lines that specify additional routes that should be added when the</font></div><div><font size="2"   color="#ff0000"   >&nbsp; associated interface is brought up.</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >&nbsp; The files are processed by the ifup-routes script and uses the /sbin/ipcalc</font></div><div><font size="2"   color="#ff0000"   >&nbsp; utility for all network masks and numbers. Routes are specified using the</font></div><div><font size="2"   color="#ff0000"   >&nbsp; syntax:</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; ADDRESSn=&lt;network&gt;</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; NETMASKn=&lt;network/prefix mask&gt;</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; GATEWAYn=&lt;next-hop router/gateway IP address&gt;</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >&nbsp; The "n" is expected to be consecutive positive integers starting from 0.</font></div><div><font size="2"   color="#ff0000"   >&nbsp; For example:</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; ADDRESS0=192.168.2.0</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; NETMASK0=255.255.255.0</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; GATEWAY0=192.168.1.1</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >&nbsp; adds a network route to the 192.168.2.0 network via the gateway at</font></div><div><font size="2"   color="#ff0000"   >&nbsp; 192.168.1.1. Since you must already have a route to the network of the</font></div><div><font size="2"   color="#ff0000"   >&nbsp; gateway, there is no need to specify a device.</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >&nbsp; Note: The ifup-routes script also supports an older syntax designed to be</font></div><div><font size="2"   color="#ff0000"   >&nbsp; used directly as an argument to "/sbin/ip route add".</font></div><div><font size="2"   color="#ff0000"   >&nbsp; If no "ADDRESSn" lines are found the following will still</font></div><div><font size="2"   color="#ff0000"   >&nbsp; work:</font></div><div><font size="2"   color="#ff0000"   >&nbsp;&nbsp;</font></div><div><font size="2"   color="#ff0000"   >&nbsp; 192.168.2.0/24 dev ppp0</font></div><div><font size="2"   color="#ff0000"   >&nbsp;&nbsp;</font></div><div><font size="2"   color="#ff0000"   >&nbsp; adds a network route to the 192.168.2.0 network through ppp0.</font></div></div><div>所以需要给绑定了多个IP的网络设备写一个自定义路由配置文件</div><div><span style="line-height: 28px;"   ><font size="2"   color="#ff0000"   >/etc/sysconfig/network-scripts/route-eth0</font></span></div><div><span style="line-height: 28px;"   >内容如下 :&nbsp;</span></div><div><div><font size="2"   color="#ff0000"   >172.16.3.0/24 dev eth0 &nbsp;proto kernel &nbsp;scope link &nbsp;src 172.16.3.111 metric 100</font></div><div><font size="2"   color="#ff0000"   >default via 172.16.3.1 dev eth0 src 172.16.3.111 metric 100</font></div><div><font size="2"   color="#ff0000"   >172.16.3.0/24 dev eth0 &nbsp;proto kernel &nbsp;scope link &nbsp;src 172.16.3.105 metric 1</font></div><div><font size="2"   color="#ff0000"   >default via 172.16.3.1 dev eth0 src 172.16.3.105 metric 1</font></div></div><div><font size="3"   ><span style="line-height: 22.75px;"   >这个配置文件是在ifup-post后调用ip route add来添加路由.</span></font></div><div><font size="3"   ><span style="line-height: 22.75px;"   >但是仅此还有问题, 因为默认的话还是会添加2条路由, 网关和本网段的路由.</span></font></div><div><span style="line-height: 28px;"   ><font size="2"   color="#ff0000"   >172.16.3.0/24 dev eth0 &nbsp;proto kernel &nbsp;scope link &nbsp;src 172.16.3.111&nbsp;</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   color="#ff0000"   >default via 172.16.3.1 dev eth0&nbsp;</font></span></div><div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 ~]# ip route</font></div><div><div><font size="2"   color="#ff0000"   >172.16.3.0/24 dev eth0 &nbsp;proto kernel &nbsp;scope link &nbsp;src 172.16.3.111&nbsp;</font></div><div><font size="2"   color="#ff0000"   >172.16.3.0/24 dev eth0 &nbsp;proto kernel &nbsp;scope link &nbsp;src 172.16.3.105 &nbsp;metric 1&nbsp;</font></div><div><font size="2"   color="#ff0000"   >172.16.3.0/24 dev eth0 &nbsp;proto kernel &nbsp;scope link &nbsp;src 172.16.3.111 &nbsp;metric 100&nbsp;</font></div><div><font size="2"   color="#ff0000"   >169.254.0.0/16 dev eth0 &nbsp;scope link &nbsp;metric 1002&nbsp;</font></div><div><font size="2"   color="#ff0000"   >default via 172.16.3.1 dev eth0&nbsp;</font></div><div><font size="2"   color="#ff0000"   >default via 172.16.3.1 dev eth0 &nbsp;src 172.16.3.105 &nbsp;metric 1&nbsp;</font></div><div><font size="2"   color="#ff0000"   >default via 172.16.3.1 dev eth0 &nbsp;src 172.16.3.111 &nbsp;metric 100&nbsp;</font></div></div><div style="font-size: medium;"   >为了去除这两条路由, 需要调整一下配置文件.</div><div style="font-size: medium;"   ><br></div><div style="font-size: medium;"   >[最终的配置 : ]</div><div style="font-size: medium;"   >把网关去掉</div><div><font size="2"   color="#ff0000"   >vi&nbsp;<span style="line-height: 28px;"   >/etc/sysconfig/network</span></font></div><div><font color="#ff0000"   size="2"   ><span style="line-height: 22.75px;"   >and</span></font></div><div><font size="2"   color="#ff0000"   ><span style="line-height: 28px;"   >vi&nbsp;</span><span style="line-height: 28px;"   >/etc/sysconfig/</span>network-scripts/ifcfg-eth0</font></div><div><font size="2"   color="#ff0000"   ><span style="line-height: 28px;"   >vi&nbsp;</span><span style="line-height: 28px;"   >/etc/sysconfig/</span><span style="line-height: 28px;"   >network-scripts/ifcfg-eth0:1</span></font></div><div style="font-size: medium;"   ><span style="line-height: 28px;"   >把</span>GATEWAY=172.16.3.1删除</div><div style="font-size: medium;"   >同时调整</div><div><div style="font-size: 16px; line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   color="#ff0000"   style="line-height: 22.75px;"   >/etc/sysconfig/network-scripts/route-eth0</font></span></div><div style="font-size: 16px; line-height: 28px;"   ><span style="line-height: 28px;"   >最终的内容如下, 优先匹配小的子网掩码 :&nbsp;</span></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   color="#ff0000"   >default via 172.16.3.1 dev eth0 src 172.16.3.111 metric 100</font></div><div style="line-height: 28px;"   ><font size="2"   color="#ff0000"   >172.16.3.0/25 dev eth0 &nbsp;proto kernel &nbsp;scope link &nbsp;src 172.16.3.105 metric 1</font></div><div style="line-height: 28px;"   ><font size="2"   color="#ff0000"   >172.16.3.128/25 dev eth0 &nbsp;proto kernel &nbsp;scope link &nbsp;src 172.16.3.105 metric 1</font></div><div style="line-height: 28px;"   ><font size="2"   color="#ff0000"   >default via 172.16.3.1 dev eth0 src 172.16.3.105 metric 1</font></div></div></div></div></div><div>重启network服务后, 路由表如下 :&nbsp;</div><div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ip route</font></div><div><font size="2"   color="#ff0000"   >172.16.3.0/25 dev eth0 &nbsp;proto kernel &nbsp;scope link &nbsp;src 172.16.3.105 &nbsp;metric 1&nbsp;</font></div><div><font size="2"   color="#ff0000"   >172.16.3.128/25 dev eth0 &nbsp;proto kernel &nbsp;scope link &nbsp;src 172.16.3.105 &nbsp;metric 1&nbsp;</font></div><div><font size="2"   color="#ff0000"   >172.16.3.0/24 dev eth0 &nbsp;proto kernel &nbsp;scope link &nbsp;src 172.16.3.111&nbsp;</font></div><div><font size="2"   color="#ff0000"   >169.254.0.0/16 dev eth0 &nbsp;scope link &nbsp;metric 1002&nbsp;</font></div><div><font size="2"   color="#ff0000"   >default via 172.16.3.1 dev eth0 &nbsp;src 172.16.3.105 &nbsp;metric 1&nbsp;</font></div><div><font size="2"   color="#ff0000"   >default via 172.16.3.1 dev eth0 &nbsp;src 172.16.3.111 &nbsp;metric 100&nbsp;</font></div></div><div>ifup , ifdown, service network等都会自动读取这个配置文件, 所以不需要在手工修改了.</div><div>另外注意, 不要直接使用ip命令对IP进行配置.</div><div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ip route get 192.168.1.1</font></div><div><font size="2"   color="#ff0000"   >192.168.1.1 via 172.16.3.1 dev eth0 &nbsp;src 172.16.3.105&nbsp;</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; cache &nbsp;mtu 1500 advmss 1460 hoplimit 64</font></div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ip route get 172.16.3.1</font></div><div><font size="2"   color="#ff0000"   >172.16.3.1 dev eth0 &nbsp;src 172.16.3.105&nbsp;</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; cache &nbsp;mtu 1500 advmss 1460 hoplimit 64</font></div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ip route get 172.16.3.0</font></div><div><font size="2"   color="#ff0000"   >172.16.3.0 dev eth0 &nbsp;src 172.16.3.105&nbsp;</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; cache &nbsp;mtu 1500 advmss 1460 hoplimit 64</font></div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ip route get 172.16.3.127</font></div><div><font size="2"   color="#ff0000"   >172.16.3.127 dev eth0 &nbsp;src 172.16.3.105&nbsp;</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; cache &nbsp;mtu 1500 advmss 1460 hoplimit 64</font></div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ip route get 172.16.3.128</font></div><div><font size="2"   color="#ff0000"   >172.16.3.128 dev eth0 &nbsp;src 172.16.3.105&nbsp;</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; cache &nbsp;mtu 1500 advmss 1460 hoplimit 64</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ifdown eth0:1</font></div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ip route</font></div><div><font size="2"   color="#ff0000"   >172.16.3.0/24 dev eth0 &nbsp;proto kernel &nbsp;scope link &nbsp;src 172.16.3.111&nbsp;</font></div><div><font size="2"   color="#ff0000"   >169.254.0.0/16 dev eth0 &nbsp;scope link &nbsp;metric 1002&nbsp;</font></div><div><font size="2"   color="#ff0000"   >default via 172.16.3.1 dev eth0 &nbsp;src 172.16.3.111 &nbsp;metric 100&nbsp;</font></div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ifup eth0:1</font></div><div><font size="2"   color="#ff0000"   >Determining if ip address 172.16.3.105 is already in use for device eth0...</font></div><div><font size="2"   color="#ff0000"   >RTNETLINK answers: File exists</font></div><div><font size="2"   color="#ff0000"   >[root@db-172-16-3-111 network-scripts]# ip route</font></div><div><font size="2"   color="#ff0000"   >172.16.3.0/25 dev eth0 &nbsp;proto kernel &nbsp;scope link &nbsp;src 172.16.3.105 &nbsp;metric 1&nbsp;</font></div><div><font size="2"   color="#ff0000"   >172.16.3.128/25 dev eth0 &nbsp;proto kernel &nbsp;scope link &nbsp;src 172.16.3.105 &nbsp;metric 1&nbsp;</font></div><div><font size="2"   color="#ff0000"   >172.16.3.0/24 dev eth0 &nbsp;proto kernel &nbsp;scope link &nbsp;src 172.16.3.111&nbsp;</font></div><div><font size="2"   color="#ff0000"   >169.254.0.0/16 dev eth0 &nbsp;scope link &nbsp;metric 1002&nbsp;</font></div><div><font size="2"   color="#ff0000"   >default via 172.16.3.1 dev eth0 &nbsp;src 172.16.3.105 &nbsp;metric 1&nbsp;</font></div><div><font size="2"   color="#ff0000"   >default via 172.16.3.1 dev eth0 &nbsp;src 172.16.3.111 &nbsp;metric 100&nbsp;</font></div></div><div><br></div><div>[参考]</div><div>1.&nbsp;/usr/share/doc/initscripts-9.03.40/sysconfig.txt</div><div>2. man ip</div><div>3. man ifup</div><div><br></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="use ip modify route table use vip as src trans - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>