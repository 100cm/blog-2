<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">test zfs dedup vs compress which suit in your environment</h2>
	<h5 id="">2014-06-17 16:21:27&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020145173939183/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>你的数据适合压缩还是适合开启去重?</div><div>这个可以拿到你的数据进行评估, 在一个已有使用zdb -S zpname进行评估, 然后使用zdb -DD产生一个报告.</div><div>例如 :&nbsp;</div><div>对zp1 pool的数据块, 采样评估</div><div><div><font size="2"   color="#ff0000"   >[root@db- ~]# zdb -S zp1</font></div><div><font size="2"   color="#ff0000"   >^C</font></div><div>报告deduplicate table</div><div><font size="2"   color="#ff0000"   >[root@db- ~]# zdb -DD zp1</font></div><div><font size="2"   color="#ff0000"   >DDT-sha256-zap-duplicate: 272229 entries, size 291 on disk, 141 in core</font></div><div><font size="2"   color="#ff0000"   >DDT-sha256-zap-unique: 71346264 entries, size 314 on disk, 167 in core</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >DDT histogram (aggregated over all DDTs):</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >bucket &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;allocated &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; referenced &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   color="#ff0000"   >______ &nbsp; ______________________________ &nbsp; ______________________________</font></div><div><font size="2"   color="#ff0000"   >refcnt &nbsp; blocks &nbsp; LSIZE &nbsp; PSIZE &nbsp; DSIZE &nbsp; blocks &nbsp; LSIZE &nbsp; PSIZE &nbsp; DSIZE</font></div><div><font size="2"   color="#ff0000"   >------ &nbsp; ------ &nbsp; ----- &nbsp; ----- &nbsp; ----- &nbsp; ------ &nbsp; ----- &nbsp; ----- &nbsp; -----</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp;1 &nbsp; &nbsp;68.0M &nbsp; 8.50T &nbsp; 1.18T &nbsp; 1.18T &nbsp; &nbsp;68.0M &nbsp; 8.50T &nbsp; 1.18T &nbsp; 1.18T</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp;2 &nbsp; &nbsp; 264K &nbsp; 32.8G &nbsp; 19.3G &nbsp; 19.3G &nbsp; &nbsp; 529K &nbsp; 65.7G &nbsp; 38.5G &nbsp; 38.5G</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp;4 &nbsp; &nbsp;1.64K &nbsp; &nbsp;210M &nbsp; &nbsp;886K &nbsp; &nbsp;886K &nbsp; &nbsp;7.93K &nbsp; 1015M &nbsp; 4.16M &nbsp; 4.16M</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp;8 &nbsp; &nbsp; &nbsp;330 &nbsp; 41.0M &nbsp; &nbsp;167K &nbsp; &nbsp;167K &nbsp; &nbsp;3.18K &nbsp; &nbsp;404M &nbsp; 1.61M &nbsp; 1.61M</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; 16 &nbsp; &nbsp; &nbsp; 59 &nbsp; 7.25M &nbsp; 29.5K &nbsp; 29.5K &nbsp; &nbsp;1.33K &nbsp; &nbsp;168M &nbsp; &nbsp;684K &nbsp; &nbsp;684K</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; 32 &nbsp; &nbsp; &nbsp; 69 &nbsp; 8.62M &nbsp; 34.5K &nbsp; 34.5K &nbsp; &nbsp;3.18K &nbsp; &nbsp;406M &nbsp; 1.59M &nbsp; 1.59M</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; 64 &nbsp; &nbsp; &nbsp; 85 &nbsp; 10.6M &nbsp; 42.5K &nbsp; 42.5K &nbsp; &nbsp;8.07K &nbsp; 1.01G &nbsp; 4.04M &nbsp; 4.04M</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp;128 &nbsp; &nbsp; &nbsp; 72 &nbsp; &nbsp; &nbsp;9M &nbsp; &nbsp; 36K &nbsp; &nbsp; 36K &nbsp; &nbsp;11.4K &nbsp; 1.43G &nbsp; 5.72M &nbsp; 5.72M</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp;256 &nbsp; &nbsp; &nbsp; 59 &nbsp; 7.38M &nbsp; 29.5K &nbsp; 29.5K &nbsp; &nbsp;17.5K &nbsp; 2.19G &nbsp; 8.76M &nbsp; 8.76M</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp;512 &nbsp; &nbsp; &nbsp; &nbsp;5 &nbsp; &nbsp;640K &nbsp; 2.50K &nbsp; 2.50K &nbsp; &nbsp;4.26K &nbsp; &nbsp;546M &nbsp; 2.13M &nbsp; 2.13M</font></div><div><font size="2"   color="#ff0000"   >&nbsp;Total &nbsp; &nbsp;68.3M &nbsp; 8.54T &nbsp; 1.19T &nbsp; 1.19T &nbsp; &nbsp;68.6M &nbsp; 8.58T &nbsp; 1.21T &nbsp; 1.21T</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >dedup = 1.02, compress = 7.06, copies = 1.00, dedup * compress / copies = 7.18</font></div></div><div>从结果来看, 压缩比为7.06, dedup为1.02, 显然这份数据更适合开启压缩.</div><div>另外, dedup需要维持数据块的内存表(DDT), 跟踪deduplicate.</div><div>那么需要多少内存呢? 一般每个数据块需要320字节的内存.</div><div>根据zdb -DD zp1的输出, blocks总共有68.3M个, 那么DDT的大小是68.3M*320约21GB内存.</div><div>如果内存不够, 又需要开启dedup的话, 建议增加ssd作为L2ARC来保持DDT.</div><div><br></div><div>在没有数据的情况下, 没有办法对其进行评估. 所以至少需要一些测试数据.</div><div>我这里的测试数据基本上是一些PostgreSQL csvlog文本文件和tar.bz2文件, 看起来并不适合dedup.</div><div><br></div><div>[注意]</div><div>1. 压缩和去重一样, 都只对enable后的数据提交生效, 已经存在的数据不会被压缩或去重. 只有enable后加入的数据或修改的数据才能被压缩和去重.&nbsp;</div><div>2. 去重的flush操作不是原子操作, 所以断电可能导致数据受损.</div><div><font size="2"   color="#ff0000"   >Further, deduplicated data is not flushed to disk as an atomic transaction. Instead, the blocks are written to disk serially, one block at a time. Thus, this does open you up for corruption in the event of a power failure before the blocks have been written.</font></div><div>3. 去重的属性是在dataset级别设置的, 但是去重是整个zpool中进行的.</div><div>查看去重率也是在zpool get all中看到的.</div><div><div><font size="2"   color="#ff0000"   >[root@db- ~]# zpool get all</font></div><div><font size="2"   color="#ff0000"   >NAME &nbsp;PROPERTY &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; VALUE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SOURCE</font></div><div><font size="2"   color="#ff0000"   >zp1 &nbsp; size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 9.75T &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div><font size="2"   color="#ff0000"   >zp1 &nbsp; capacity &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 12% &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div><font size="2"   color="#ff0000"   >zp1 &nbsp; altroot &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div><font size="2"   color="#ff0000"   >zp1 &nbsp; health &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -</font></div><div><font size="2"   color="#ff0000"   >zp1 &nbsp; guid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5877722976139588848 &nbsp; &nbsp;default</font></div><div><font size="2"   color="#ff0000"   >zp1 &nbsp; version &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div><font size="2"   color="#ff0000"   >zp1 &nbsp; bootfs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; - &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div><font size="2"   color="#ff0000"   >zp1 &nbsp; delegation &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div><font size="2"   color="#ff0000"   >zp1 &nbsp; autoreplace &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div><font size="2"   color="#ff0000"   >zp1 &nbsp; cachefile &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div><font size="2"   color="#ff0000"   >zp1 &nbsp; failmode &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wait &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div><font size="2"   color="#ff0000"   >zp1 &nbsp; listsnapshots &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div><font size="2"   color="#ff0000"   >zp1 &nbsp; autoexpand &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div><font size="2"   color="#ff0000"   >zp1 &nbsp; dedupditto &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div><font size="2"   color="#ff0000"   >zp1 &nbsp; dedupratio &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1.01x &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div><font size="2"   color="#ff0000"   >zp1 &nbsp; free &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8.52T &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div><font size="2"   color="#ff0000"   >zp1 &nbsp; allocated &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1.23T &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div><font size="2"   color="#ff0000"   >zp1 &nbsp; readonly &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div><font size="2"   color="#ff0000"   >zp1 &nbsp; ashift &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div><font size="2"   color="#ff0000"   >zp1 &nbsp; comment &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div><font size="2"   color="#ff0000"   >zp1 &nbsp; expandsize &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div><font size="2"   color="#ff0000"   >zp1 &nbsp; freeing &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div><font size="2"   color="#ff0000"   >zp1 &nbsp; feature@async_destroy &nbsp;enabled &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;local</font></div><div><font size="2"   color="#ff0000"   >zp1 &nbsp; feature@empty_bpobj &nbsp; &nbsp;active &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; local</font></div><div><font size="2"   color="#ff0000"   >zp1 &nbsp; feature@lz4_compress &nbsp; active &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; local</font></div></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://pthree.org/2013/12/18/zfs-administration-appendix-d-the-true-cost-of-deduplication/"   >https://pthree.org/2013/12/18/zfs-administration-appendix-d-the-true-cost-of-deduplication/</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.oracle.com/technetwork/articles/servers-storage-admin/o11-113-size-zfs-dedup-1354231.html"   >http://www.oracle.com/technetwork/articles/servers-storage-admin/o11-113-size-zfs-dedup-1354231.html</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://pthree.org/2012/12/18/zfs-administration-part-xi-compression-and-deduplication/"   >https://pthree.org/2012/12/18/zfs-administration-part-xi-compression-and-deduplication/</a></div><div>4.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201441992944647/"   >http://blog.163.com/digoal@126/blog/static/163877040201441992944647/</a></div><div>5. man zdb</div><div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp;-S</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Simulate the effects of deduplication, constructing a DDT and then display that DDT as with -DD.</font></div></div><div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp;-D</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Display deduplication statistics, including the deduplication ratio (dedup), compression ratio &nbsp;(compress),</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;inflation &nbsp;due &nbsp;to &nbsp;the &nbsp;zfs &nbsp;copies &nbsp;property (copies), and an overall effective ratio (dedup * compress /</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;copies).</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;If specified twice, display a histogram of deduplication &nbsp;statistics, &nbsp;showing &nbsp;the &nbsp;allocated &nbsp;(physically</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;present &nbsp;on &nbsp;disk) &nbsp;and &nbsp;referenced &nbsp;(logically referenced in the pool) block counts and sizes by reference</font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;count.</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;If specified a third time, display the statistics independently for each deduplication table.</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;If specified a fourth time, dump the contents of the deduplication tables describing duplicate blocks.</font></div><div><font size="2"   color="#ff0000"   ><br></font></div><div><font size="2"   color="#ff0000"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;If specified a fifth time, also dump the contents of the deduplication tables describing unique blocks.</font></div></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="test zfs dedup vs compress which suit in your environment - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>