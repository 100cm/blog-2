<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.4 BDR(Bi-Directional Replication), LLSR(Logical Log Stream Replication)</h2>
	<h5 id="">2014-06-27 17:08:54&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020145271362827/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>非常感谢2ND团队的辛勤付出, PostgreSQL 9.4的逻辑流复制模块BDR已经小有所成, 本文将演示一下bdr的使用.</div><div>bi-directional replication顾名思义, 就是互相复制的意思(也称为逻辑流复制), 同样需要利用WAL, 目前为单进程, 以后可能会改进到多进程, 不过即使单进程, 也比目前的其他第三方复制快很多(如slony-I, londiste3).&nbsp;</div><div>目前BDR逻辑流复制的最小粒度为数据库级别, 而PG9.0以来的物理流复制是整个集群级别的.</div><div><br></div><div>注意目前BDR还处于开发阶段, 还没有整合到9.4的主版本中, 大家需要去git.postgresql.org的2nd分支下载进行测试.</div><div>下载地址如下 :&nbsp;</div><div><a target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=2ndquadrant_bdr.git;a=summary"   >http://git.postgresql.org/gitweb/?p=2ndquadrant_bdr.git;a=summary</a></div><div><a target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=2ndquadrant_bdr.git;a=shortlog;h=refs/heads/bdr-next"   >http://git.postgresql.org/gitweb/?p=2ndquadrant_bdr.git;a=shortlog;h=refs/heads/bdr-next</a></div><div>本文的测试架构</div><div><div><img title="PostgreSQL BDR(Bi-Directional Replication), LLSR(Logical Log Stream Replication) - 德哥@Digoal - PostgreSQL"   alt="PostgreSQL BDR(Bi-Directional Replication), LLSR(Logical Log Stream Replication) - 德哥@Digoal - PostgreSQL"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/ZwOme1k3JDYLbna2aCsE-g==/6608902710794367849.png"   ></div>&nbsp;</div><div><br></div><div>复制节点术语, 同一个数据库可能处于多重身份, 视数据流(wal)的方向决定.</div><div>up-stream 指上游节点(类似master)</div><div>down-stream 指复制的下游节点(类似slave)</div><div>但实际上两个节点可以相互复制, 是属于multi-master结构.</div><div><br></div><div>安装简单步骤 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># useradd bdr</font></div><div><font size="2"   ># tar -zxvf 2ndquadrant_bdr-ac5795e.tar.gz</font></div><div><font size="2"   ># cd 2ndquadrant_bdr-ac5795e</font></div><div><font size="2"   ># ./configure --prefix=/home/bdr/pgsql --with-pgport=1314 --with-perl --with-tcl --with-python --with-openssl --with-pam --with-ldap --with-libxml --with-libxslt --enable-thread-safety --enable-dtrace --enable-debug --enable-cassert</font></div><div><font size="2"   ># gmake</font></div><div><font size="2"   ># gmake install</font></div><div><font size="2"   ># cd contrib</font></div><div><font size="2"   ># gmake</font></div><div><font size="2"   ># gmake install</font></div><p></p></pre></div><div><br></div><div>创建数据库集群目录</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 contrib]# mkdir /ssd4/bdr</font></div><div><font size="2"   >[root@db-172-16-3-150 contrib]# chown bdr:bdr /ssd4/bdr</font></div><p></p></pre></div><div>环境变量.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># vi /home/bdr/.bash_profile</font></div><div><font size="2"   >export PS1="$USER@`/bin/hostname -s`-&gt; "</font></div><div><font size="2"   >export PGPORT=1314</font></div><div><font size="2"   >export PGDATA=/ssd4/bdr/pg_root1314</font></div><div><font size="2"   >export LANG=en_US.utf8</font></div><div><font size="2"   >export PGHOME=/home/bdr/pgsql</font></div><div><font size="2"   >export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib:$LD_LIBRARY_PATH</font></div><div><font size="2"   >export DATE=`date +"%Y%m%d%H%M"`</font></div><div><font size="2"   >export PATH=$PGHOME/bin:$PATH:.</font></div><div><font size="2"   >export MANPATH=$PGHOME/share/man:$MANPATH</font></div><div><font size="2"   >export PGUSER=postgres</font></div><div><font size="2"   >export PGHOST=$PGDATA</font></div><div><font size="2"   >export PGDATABASE=digoal</font></div><div><font size="2"   >alias rm='rm -i'</font></div><div><font size="2"   >alias ll='ls -lh'</font></div><p></p></pre></div><div>初始化数据库1</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># su - bdr</font></div><div><font size="2"   >bdr@db-172-16-3-150-&gt; which psql</font></div><div><font size="2"   >~/pgsql/bin/psql</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >bdr@db-172-16-3-150-&gt; initdb -D /ssd4/bdr/pg_root1314 -E UTF8 --locale=C -U postgres -W</font></div><div><font size="2"   >bdr@db-172-16-3-150-&gt; cd $PGDATA</font></div><div><font size="2"   >bdr@db-172-16-3-150-&gt; ll</font></div><div><font size="2"   >total 108K</font></div><div><font size="2"   >drwx------ 5 bdr bdr 4.0K Jun 27 13:29 base</font></div><div><font size="2"   >drwx------ 2 bdr bdr 4.0K Jun 27 13:29 global</font></div><div><font size="2"   >drwx------ 2 bdr bdr 4.0K Jun 27 13:29 pg_clog</font></div><div><font size="2"   >drwx------ 2 bdr bdr 4.0K Jun 27 13:29 pg_committs</font></div><div><font size="2"   >drwx------ 2 bdr bdr 4.0K Jun 27 13:29 pg_dynshmem</font></div><div><font size="2"   >-rw------- 1 bdr bdr 4.4K Jun 27 13:29 pg_hba.conf</font></div><div><font size="2"   >-rw------- 1 bdr bdr 1.6K Jun 27 13:29 pg_ident.conf</font></div><div><font size="2"   >drwx------ 5 bdr bdr 4.0K Jun 27 13:29 pg_llog  # 新增了这个目录, 相比9.4</font></div><div><font size="2"   >drwx------ 4 bdr bdr 4.0K Jun 27 13:29 pg_multixact</font></div><div><font size="2"   >drwx------ 2 bdr bdr 4.0K Jun 27 13:29 pg_notify</font></div><div><font size="2"   >drwx------ 2 bdr bdr 4.0K Jun 27 13:29 pg_replslot</font></div><div><font size="2"   >drwx------ 2 bdr bdr 4.0K Jun 27 13:29 pg_serial</font></div><div><font size="2"   >drwx------ 2 bdr bdr 4.0K Jun 27 13:29 pg_snapshots</font></div><div><font size="2"   >drwx------ 2 bdr bdr 4.0K Jun 27 13:29 pg_stat</font></div><div><font size="2"   >drwx------ 2 bdr bdr 4.0K Jun 27 13:29 pg_stat_tmp</font></div><div><font size="2"   >drwx------ 2 bdr bdr 4.0K Jun 27 13:29 pg_subtrans</font></div><div><font size="2"   >drwx------ 2 bdr bdr 4.0K Jun 27 13:29 pg_tblspc</font></div><div><font size="2"   >drwx------ 2 bdr bdr 4.0K Jun 27 13:29 pg_twophase</font></div><div><font size="2"   >-rw------- 1 bdr bdr &nbsp; &nbsp;4 Jun 27 13:29 PG_VERSION</font></div><div><font size="2"   >drwx------ 3 bdr bdr 4.0K Jun 27 13:29 pg_xlog</font></div><div><font size="2"   >-rw------- 1 bdr bdr &nbsp; 88 Jun 27 13:29 postgresql.auto.conf</font></div><div><font size="2"   >-rw------- 1 bdr bdr &nbsp;21K Jun 27 13:29 postgresql.conf</font></div><p></p></pre></div><div><br></div><div>版本是bdr0601</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >bdr@db-172-16-3-150-&gt; psql -V</font></div><div><font size="2"   >psql (PostgreSQL) 9.4beta1_bdr0601</font></div><p></p></pre></div><div>新增模块的动态链接库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >bdr@db-172-16-3-150-&gt; ll $PGHOME/lib/bdr*</font></div><div><font size="2"   >-rwxr-xr-x 1 root root &nbsp;148K Jun 27 13:28 bdr_output.so</font></div><div><font size="2"   >-rwxr-xr-x 1 root root &nbsp;614K Jun 27 13:28 bdr.so</font></div><p></p></pre></div><div>新增的几个bin</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >bdr@db-172-16-3-150-&gt; ll $PGHOME/bin/bdr*</font></div><div><font size="2"   >-rwxr-xr-x 1 root root 146K Jun 27 13:28 /home/bdr/pgsql/bin/bdr_init_copy</font></div><div><font size="2"   >-rwxr-xr-x 1 root root 2.2K Jun 27 13:28 /home/bdr/pgsql/bin/bdr_initial_load</font></div><p></p></pre></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >bdr@db-172-16-3-150-&gt; bdr_initial_load --help</font></div><div><font size="2"   >Usage: bdr_replica --source &lt;dsn&gt; --target &lt;dsn&gt; [--snapshot &lt;name&gt;] --dir /path/to/dir [--jobs N]</font></div><div><font size="2"   >&lt;dsn&gt; is a libpq conninfo string, e.g. "host=/tmp post=5433 dbnae=xxx"</font></div><div><font size="2"   >bdr@db-172-16-3-150-&gt; bdr_init_copy --help</font></div><div><font size="2"   >bdr_init_copy initializes bdr from PostgreSQL instance made using pg_basebackup.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Usage:</font></div><div><font size="2"   >&nbsp; bdr_init_copy [OPTION]...</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >General options:</font></div><div><font size="2"   >&nbsp; -D, --pgdata=DIRECTORY base backup directory</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Connection options:</font></div><div><font size="2"   >&nbsp; -d, --dbname=CONNSTR &nbsp; connection string</font></div><div><font size="2"   >&nbsp; -h, --host=HOSTNAME &nbsp; &nbsp;database server host or socket directory</font></div><div><font size="2"   >&nbsp; -p, --port=PORT &nbsp; &nbsp; &nbsp; &nbsp;database server port number</font></div><div><font size="2"   >&nbsp; -U, --username=NAME &nbsp; &nbsp;connect as specified database user</font></div><p></p></pre></div><div>配置bdr的参数模板</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >bdr@db-172-16-3-150-&gt; cat $PGHOME/share/doc/extension/bdr.conf.sample</font></div><div><font size="2"   >#</font></div><div><font size="2"   ># This configuration file was installed by the postgresql94-bdr package</font></div><div><font size="2"   >#</font></div><div><font size="2"   ># It enables BDR in PostgreSQL, though it doesn't set up any peers to replicate</font></div><div><font size="2"   ># to/from.</font></div><div><font size="2"   >#</font></div><div><font size="2"   ># To learn how to configure BDR, see:</font></div><div><font size="2"   ># https://wiki.postgresql.org/wiki/BDR_User_Guide</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># Load BDR its self</font></div><div><font size="2"   >shared_preload_libraries = 'bdr'</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># Force WAL logging at logical replication level</font></div><div><font size="2"   >wal_level = 'logical'</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># Enable commit timestamps, which BDR requires</font></div><div><font size="2"   >track_commit_timestamp = on</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># Maximum number of replication slots that may exist. You should set this to</font></div><div><font size="2"   ># the number of nodes you expect to have, plus a reasonable margin for growth.</font></div><div><font size="2"   >#</font></div><div><font size="2"   ># This is a suitable setting for a small installation.</font></div><div><font size="2"   >max_replication_slots = 8</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># Generally you want to set max_wal_senders to the same value plus a few for</font></div><div><font size="2"   ># pg_basebackup runs, streaming replicas, etc.</font></div><div><font size="2"   >#&nbsp;</font></div><div><font size="2"   ># This is a suitable setting for a small installation.</font></div><div><font size="2"   >max_wal_senders = 10</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># Do you want to record conflicts to the bdr.bdr_conflict_history table, not</font></div><div><font size="2"   ># just the log file?</font></div><div><font size="2"   >#bdr.log_conflicts_to_table = off</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># Configure connections to other BDR nodes. See below for a couple of examples.</font></div><div><font size="2"   >bdr.connections = ''</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >#-------------------------------------------------------------------------</font></div><div><font size="2"   ># Remember that you must also add a replication entry to pg_hba.conf; see</font></div><div><font size="2"   ># https://wiki.postgresql.org/wiki/BDR_User_Guide#Configuration</font></div><div><font size="2"   >#-------------------------------------------------------------------------</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >#-------------------------------------------------------------------------</font></div><div><font size="2"   ># Example connection configuration:</font></div><div><font size="2"   >#-------------------------------------------------------------------------</font></div><div><font size="2"   >#</font></div><div><font size="2"   ># bdr.connections = 'node2,node3'</font></div><div><font size="2"   >#</font></div><div><font size="2"   ># bdr.node2_dsn = 'host=node2 dbname=mydb'</font></div><div><font size="2"   ># # Take our initial copy of the data from node2</font></div><div><font size="2"   ># bdr.node2_init_replica=on</font></div><div><font size="2"   ># # and apply it to the local db using this dsn</font></div><div><font size="2"   ># bdr.node2_replica_local_dsn="dbname=mydb user=postgres"</font></div><div><font size="2"   >#&nbsp;</font></div><div><font size="2"   ># bdr.node3_dsn = "host=node3 dbname=mydb"</font></div><div><font size="2"   >#</font></div><p></p></pre></div><div>启动上游节点, 创建数据库, 用户(注意复制用户目前需要超级用户, 因为需要读bdr schema下面的一些表)</div><div>创建几个测试表和数据.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >bdr@db-172-16-3-150-&gt; pg_ctl start</font></div><div><div><font size="2"   >bdr@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 1314 -U postgres postgres</font></div><div><font size="2"   >psql (9.4beta1_bdr0601)</font></div><div><font size="2"   >Type "help" for help.</font></div></div><div><div><font size="2"   >postgres=# create role digoal superuser replication login encrypted password 'digoal';</font></div><div><font size="2"   >CREATE ROLE</font></div><div><font size="2"   >postgres=# create database digoal01;</font></div><div><font size="2"   >CREATE DATABASE</font></div></div><div><div><font size="2"   >postgres=# \c digoal01 digoal&nbsp;</font></div><div><font size="2"   >You are now connected to database "digoal01" as user "digoal".</font></div><div><font size="2"   >digoal01=# create table tbl1(id int primary key, info text, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div></div><div><div><font size="2"   >digoal01=# insert into tbl1 select generate_series(1,100000), md5(random()::text), clock_timestamp();</font></div><div><font size="2"   >INSERT 0 100000</font></div></div><p></p></pre></div><div>初始化下游节点的数据库, 创建下游数据库(注意我们用到不一样的库名, 所以配置上需要特殊化处理)</div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >bdr@db-172-16-3-150-&gt; initdb -D /ssd4/bdr/pg_root1315 -E UTF8 --locale=C -U postgres -W</font></div><div><div><font size="2"   >bdr@db-172-16-3-150-&gt; pg_ctl start -D&nbsp;<span style="line-height: 28px;"   >/ssd4/bdr/pg_root1315 -o&nbsp;</span>"-p 1315"</font></div><div><div><font size="2"   >server starting</font></div><div><font size="2"   >bdr@db-172-16-3-150-&gt; LOG: &nbsp;database system was shut down at 2014-06-27 16:14:39 CST</font></div><div><font size="2"   >LOG: &nbsp;autovacuum launcher started</font></div><div><font size="2"   >LOG: &nbsp;database system is ready to accept connections</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >bdr@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 1315 -U postgres postgres</font></div><div><font size="2"   >psql (9.4beta1_bdr0601)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=# create role digoal superuser replication login encrypted password 'digoal';</font></div><div><font size="2"   >CREATE ROLE</font></div><div><font size="2"   >postgres=# create database digoal02;</font></div><div><font size="2"   >CREATE DATABASE</font></div></div></div><p></p></pre></div></div><div><br></div><div>配置上游戏节点</div><div><div><pre class="prettyprint"   ><p style="line-height: 28px;"   ></p><div style="line-height: 28px;"   ><font size="2"   >cd&nbsp;<span style="line-height: 28px;"   >/ssd4/bdr/pg_root1314</span></font></div><div style="line-height: 28px;"   ><font size="2"   >vi postgresql.conf</font></div><div><div style="line-height: 28px;"   ><font size="2"   >listen_addresses = '0.0.0.0' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# what IP address(es) to listen on;</font></div><div style="line-height: 28px;"   ><font size="2"   >port = 1314 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div style="line-height: 28px;"   ><font size="2"   >max_connections = 100 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div style="line-height: 28px;"   ><font size="2"   >unix_socket_directories = '.' &nbsp; # comma-separated list of directories</font></div><div style="line-height: 28px;"   ><font size="2"   >tcp_keepalives_idle = 60 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPIDLE, in seconds;</font></div><div style="line-height: 28px;"   ><font size="2"   >tcp_keepalives_interval = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPINTVL, in seconds;</font></div><div style="line-height: 28px;"   ><font size="2"   >tcp_keepalives_count = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # TCP_KEEPCNT;</font></div><div style="line-height: 28px;"   ><font size="2"   >shared_buffers = 512MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# min 128kB</font></div><div style="line-height: 28px;"   ><font size="2"   >maintenance_work_mem = 512MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# min 1MB</font></div><div style="line-height: 28px;"   ><font size="2"   >dynamic_shared_memory_type = posix # the default is the first option</font></div><div style="line-height: 28px;"   ><font size="2"   >shared_preload_libraries = 'bdr' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div style="line-height: 28px;"   ><font size="2"   >vacuum_cost_delay = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# 0-100 milliseconds</font></div><div style="line-height: 28px;"   ><font size="2"   >vacuum_cost_limit = 10000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 credits</font></div><div style="line-height: 28px;"   ><font size="2"   >bgwriter_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # 10-10000ms between rounds</font></div><div style="line-height: 28px;"   ><font size="2"   >wal_level = logical &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # minimal, archive, hot_standby or logical</font></div><div style="line-height: 28px;"   ><font size="2"   >checkpoint_segments = 32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# in logfile segments, min 1, 16MB each</font></div><div style="line-height: 28px;"   ><font size="2"   >archive_mode = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # allows archiving to be done</font></div><div style="line-height: 28px;"   ><font size="2"   >archive_command = '/bin/date' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # command to use to archive a logfile segment</font></div><div style="line-height: 28px;"   ><font size="2"   >max_wal_senders = 32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# max number of walsender processes</font></div><div style="line-height: 28px;"   ><font size="2"   >max_replication_slots = 10 &nbsp; &nbsp; &nbsp;# max number of replication slots.</font></div><div style="line-height: 28px;"   ><font size="2"   >track_commit_timestamp = on &nbsp; &nbsp; # collect timestamp of transaction commit</font></div><div style="line-height: 28px;"   ><font size="2"   >effective_cache_size = 96GB</font></div><div style="line-height: 28px;"   ><font size="2"   >log_destination = 'csvlog' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Valid values are combinations of</font></div><div style="line-height: 28px;"   ><font size="2"   >logging_collector = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Enable capturing of stderr and csvlog</font></div><div style="line-height: 28px;"   ><font size="2"   >log_truncate_on_rotation = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # If on, an existing log file with the</font></div><div style="line-height: 28px;"   ><font size="2"   >log_checkpoints = on</font></div><div style="line-height: 28px;"   ><font size="2"   >log_connections = on</font></div><div style="line-height: 28px;"   ><font size="2"   >log_disconnections = on</font></div><div style="line-height: 28px;"   ><font size="2"   >log_error_verbosity = verbose &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # terse, default, or verbose messages</font></div><div style="line-height: 28px;"   ><font size="2"   >log_timezone = 'PRC'</font></div><div style="line-height: 28px;"   ><font size="2"   >log_autovacuum_min_duration = 0 # -1 disables, 0 logs all actions and</font></div><div style="line-height: 28px;"   ><font size="2"   >datestyle = 'iso, mdy'</font></div><div style="line-height: 28px;"   ><font size="2"   >timezone = 'PRC'</font></div><div style="line-height: 28px;"   ><font size="2"   >lc_messages = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for system error message</font></div><div style="line-height: 28px;"   ><font size="2"   >lc_monetary = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for monetary formatting</font></div><div style="line-height: 28px;"   ><font size="2"   >lc_numeric = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for number formatting</font></div><div style="line-height: 28px;"   ><font size="2"   >lc_time = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for time formatting</font></div><div style="line-height: 28px;"   ><font size="2"   >default_text_search_config = 'pg_catalog.english'</font></div><div style="line-height: 28px;"   ><font size="2"   >bdr.connections = 'digoal1315'  # 如果不需要双向复制的话, upstream节点只需要开启bdr shared lib, 其他的这里都不需要配置. 另外需要注意, upstream节点没有配置这里的反向链接的话, down-stream节点的这个库就无法执行写SQL. 只能读. </font></div><div style="line-height: 28px;"   ><font size="2"   >bdr.digoal1315_dsn = 'hostaddr=127.0.0.1 dbname=digoal02 user=digoal port=1315'</font></div><div style="line-height: 28px;"   ><font size="2"   >bdr.digoal1315_local_dbname = 'digoal01'</font></div><div><font size="2"   >bdr.synchronous_commit = off<br>bdr.log_conflicts_to_table = on</font></div></div><div style="line-height: 28px;"   ><font size="2"   ><br></font></div><div style="line-height: 28px;"   ><font size="2"   >vi pg_hba.conf</font></div><div style="line-height: 28px;"   ><font size="2"   >host replication digoal 127.0.0.1/32 trust</font></div><p style="line-height: 28px;"   ></p></pre></div></div><div><br></div><div>配置下游节点</div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >cd&nbsp;<span style="line-height: 28px;"   >/ssd4/bdr/pg_root1315</span></font></div><div style="line-height: 28px;"   ><font size="2"   >vi postgresql.conf</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >listen_addresses = '0.0.0.0' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# what IP address(es) to listen on;</font></div><div style="line-height: 28px;"   ><font size="2"   >port = 1315 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div style="line-height: 28px;"   ><font size="2"   >max_connections = 100 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div style="line-height: 28px;"   ><font size="2"   >unix_socket_directories = '.' &nbsp; # comma-separated list of directories</font></div><div style="line-height: 28px;"   ><font size="2"   >tcp_keepalives_idle = 60 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPIDLE, in seconds;</font></div><div style="line-height: 28px;"   ><font size="2"   >tcp_keepalives_interval = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPINTVL, in seconds;</font></div><div style="line-height: 28px;"   ><font size="2"   >tcp_keepalives_count = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # TCP_KEEPCNT;</font></div><div style="line-height: 28px;"   ><font size="2"   >shared_buffers = 512MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# min 128kB</font></div><div style="line-height: 28px;"   ><font size="2"   >maintenance_work_mem = 512MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# min 1MB</font></div><div style="line-height: 28px;"   ><font size="2"   >dynamic_shared_memory_type = posix # the default is the first option</font></div><div style="line-height: 28px;"   ><font size="2"   >shared_preload_libraries = 'bdr' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div style="line-height: 28px;"   ><font size="2"   >vacuum_cost_delay = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# 0-100 milliseconds</font></div><div style="line-height: 28px;"   ><font size="2"   >vacuum_cost_limit = 10000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 credits</font></div><div style="line-height: 28px;"   ><font size="2"   >bgwriter_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # 10-10000ms between rounds</font></div><div style="line-height: 28px;"   ><font size="2"   >wal_level = logical &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # minimal, archive, hot_standby or logical</font></div><div style="line-height: 28px;"   ><font size="2"   >checkpoint_segments = 32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# in logfile segments, min 1, 16MB each</font></div><div style="line-height: 28px;"   ><font size="2"   >archive_mode = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # allows archiving to be done</font></div><div style="line-height: 28px;"   ><font size="2"   >archive_command = '/bin/date' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # command to use to archive a logfile segment</font></div><div style="line-height: 28px;"   ><font size="2"   >max_wal_senders = 32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# max number of walsender processes</font></div><div style="line-height: 28px;"   ><font size="2"   >max_replication_slots = 10 &nbsp; &nbsp; &nbsp;# max number of replication slots.</font></div><div style="line-height: 28px;"   ><font size="2"   >track_commit_timestamp = on &nbsp; &nbsp; # collect timestamp of transaction commit</font></div><div style="line-height: 28px;"   ><font size="2"   >effective_cache_size = 96GB</font></div><div style="line-height: 28px;"   ><font size="2"   >log_destination = 'csvlog' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Valid values are combinations of</font></div><div style="line-height: 28px;"   ><font size="2"   >logging_collector = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Enable capturing of stderr and csvlog</font></div><div style="line-height: 28px;"   ><font size="2"   >log_truncate_on_rotation = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # If on, an existing log file with the</font></div><div style="line-height: 28px;"   ><font size="2"   >log_checkpoints = on</font></div><div style="line-height: 28px;"   ><font size="2"   >log_connections = on</font></div><div style="line-height: 28px;"   ><font size="2"   >log_disconnections = on</font></div><div style="line-height: 28px;"   ><font size="2"   >log_error_verbosity = verbose &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # terse, default, or verbose messages</font></div><div style="line-height: 28px;"   ><font size="2"   >log_timezone = 'PRC'</font></div><div style="line-height: 28px;"   ><font size="2"   >log_autovacuum_min_duration = 0 # -1 disables, 0 logs all actions and</font></div><div style="line-height: 28px;"   ><font size="2"   >datestyle = 'iso, mdy'</font></div><div style="line-height: 28px;"   ><font size="2"   >timezone = 'PRC'</font></div><div style="line-height: 28px;"   ><font size="2"   >lc_messages = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for system error message</font></div><div style="line-height: 28px;"   ><font size="2"   >lc_monetary = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for monetary formatting</font></div><div style="line-height: 28px;"   ><font size="2"   >lc_numeric = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for number formatting</font></div><div style="line-height: 28px;"   ><font size="2"   >lc_time = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for time formatting</font></div><div style="line-height: 28px;"   ><font size="2"   >default_text_search_config = 'pg_catalog.english'</font></div><div style="line-height: 28px;"   ><font size="2"   >bdr.connections = 'digoal1314'</font></div><div style="line-height: 28px;"   ><font size="2"   >bdr.synchronous_commit = off # 是否开启异步复制, 默认为同步复制.</font></div><div style="line-height: 28px;"   ><font size="2"   >bdr.log_conflicts_to_table = on  # 冲突数据记录到bdr,bdr_conflict_history表.</font></div><div style="line-height: 28px;"   ><font size="2"   >bdr.digoal1314_dsn = 'hostaddr=127.0.0.1 dbname=digoal01 user=digoal port=1314'</font></div><div style="line-height: 28px;"   ><font size="2"   >bdr.digoal1314_local_dbname = 'digoal02'  # 当本地库名和远程连接的不一样时, 需要配置 </font></div><div style="line-height: 28px;"   ><font size="2"   >bdr.digoal1314_init_replica = on  # 是否需要初始化复制</font></div><div style="line-height: 28px;"   ><font size="2"   >bdr.digoal1314_replica_local_dsn = 'hostaddr=127.0.0.1 dbname=digoal02 user=digoal port=1315'  # 初始化复制需要的连接参数</font></div></div><div style="line-height: 28px;"   ><font size="2"   ><br></font></div><div style="line-height: 28px;"   ><font size="2"   >vi pg_hba.conf</font></div><div style="line-height: 28px;"   ><font size="2"   >host replication digoal 127.0.0.1/32 trust</font></div><p></p></pre></div></div><div><br></div><div>重启上游节点和下游节点</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >bdr@db-172-16-3-150-&gt; pg_ctl start -D /ssd4/bdr/pg_root1314</font></div><div><font size="2"   >server starting</font></div><div><font size="2"   >bdr@db-172-16-3-150-&gt; LOG: &nbsp;00000: registering background worker "bdr: digoal02"</font></div><div><font size="2"   >LOCATION: &nbsp;RegisterBackgroundWorker, bgworker.c:732</font></div><div><font size="2"   >LOG: &nbsp;00000: redirecting log output to logging collector process</font></div><div><font size="2"   >HINT: &nbsp;Future log output will appear in directory "pg_log".</font></div><div><font size="2"   >LOCATION: &nbsp;SysLogger_Start, syslogger.c:656</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >bdr@db-172-16-3-150-&gt; pg_ctl start -D /ssd4/bdr/pg_root1315</font></div><div><font size="2"   >server starting</font></div><div><font size="2"   >bdr@db-172-16-3-150-&gt; LOG: &nbsp;00000: registering background worker "bdr: digoal01"</font></div><div><font size="2"   >LOCATION: &nbsp;RegisterBackgroundWorker, bgworker.c:732</font></div><div><font size="2"   >LOG: &nbsp;00000: redirecting log output to logging collector process</font></div><div><font size="2"   >HINT: &nbsp;Future log output will appear in directory "pg_log".</font></div><div><font size="2"   >LOCATION: &nbsp;SysLogger_Start, syslogger.c:656</font></div><p></p></pre></div><div><br></div><div>查看下游节点是否已经成功复制</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >bdr@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 1315 -U digoal digoal02</font></div><div><font size="2"   >psql (9.4beta1_bdr0601)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal02=# \dt</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;List of relations</font></div><div><font size="2"   >&nbsp;Schema | Name | Type &nbsp;| Owner &nbsp;</font></div><div><font size="2"   >--------+------+-------+--------</font></div><div><font size="2"   >&nbsp;public | tbl1 | table | digoal</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal02=# select count(*) from tbl1;</font></div><div><font size="2"   >&nbsp;count &nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp;100000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal02=# \q</font></div><p></p></pre></div><div>新增表测试, 查看是否成功复制 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >bdr@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 1314 -U digoal digoal01</font></div><div><font size="2"   >psql (9.4beta1_bdr0601)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal01=# create table tbl2(id int primary key, info text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal01=# insert into tbl2 select generate_series(1,10000);</font></div><div><font size="2"   >INSERT 0 10000</font></div><div><font size="2"   >digoal01=# \q</font></div><div><font size="2"   >bdr@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 1315 -U digoal digoal02</font></div><div><font size="2"   >psql (9.4beta1_bdr0601)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal02=# \dt</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;List of relations</font></div><div><font size="2"   >&nbsp;Schema | Name | Type &nbsp;| Owner &nbsp;</font></div><div><font size="2"   >--------+------+-------+--------</font></div><div><font size="2"   >&nbsp;public | tbl1 | table | digoal</font></div><div><font size="2"   >&nbsp;public | tbl2 | table | digoal</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal02=# select count(*) from tbl2;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp;10000</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>其他的有兴趣的朋友搭建来玩一玩吧.</div><div><br></div><div>复制进程, 一个数据库需要一个连接. bdr作为work process随数据库实例一起启动.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >bdr &nbsp; &nbsp; &nbsp;23520 &nbsp; &nbsp; 1 &nbsp;0 16:41 pts/0 &nbsp; &nbsp;00:00:00 /home/bdr/pgsql/bin/postgres -D /ssd4/bdr/pg_root1314</font></div><div><font size="2"   >bdr &nbsp; &nbsp; &nbsp;23528 23520 &nbsp;0 16:41 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: logger process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >bdr &nbsp; &nbsp; &nbsp;23530 23520 &nbsp;0 16:41 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: checkpointer process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >bdr &nbsp; &nbsp; &nbsp;23531 23520 &nbsp;0 16:41 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: writer process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >bdr &nbsp; &nbsp; &nbsp;23532 23520 &nbsp;0 16:41 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: wal writer process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >bdr &nbsp; &nbsp; &nbsp;23533 23520 &nbsp;0 16:41 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: autovacuum launcher process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >bdr &nbsp; &nbsp; &nbsp;23534 23520 &nbsp;0 16:41 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: archiver process &nbsp; last was 000000010000000000000005</font></div><div><font size="2"   >bdr &nbsp; &nbsp; &nbsp;23535 23520 &nbsp;0 16:41 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: stats collector process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >bdr &nbsp; &nbsp; &nbsp;23536 23520 &nbsp;0 16:41 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: bgworker: bdr: digoal01 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >bdr &nbsp; &nbsp; &nbsp;23542 &nbsp; &nbsp; 1 &nbsp;0 16:41 pts/0 &nbsp; &nbsp;00:00:00 /home/bdr/pgsql/bin/postgres -D /ssd4/bdr/pg_root1315</font></div><div><font size="2"   >bdr &nbsp; &nbsp; &nbsp;23588 23542 &nbsp;0 16:41 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: logger process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >bdr &nbsp; &nbsp; &nbsp;23597 23542 &nbsp;0 16:41 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: checkpointer process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >bdr &nbsp; &nbsp; &nbsp;23599 23542 &nbsp;0 16:41 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: writer process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >bdr &nbsp; &nbsp; &nbsp;23601 23542 &nbsp;0 16:41 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: wal writer process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >bdr &nbsp; &nbsp; &nbsp;23603 23542 &nbsp;0 16:41 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: autovacuum launcher process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >bdr &nbsp; &nbsp; &nbsp;23604 23542 &nbsp;0 16:41 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: archiver process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >bdr &nbsp; &nbsp; &nbsp;23605 23542 &nbsp;0 16:41 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: stats collector process &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >bdr &nbsp; &nbsp; &nbsp;23607 23542 &nbsp;0 16:41 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: bgworker: bdr: digoal02 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >bdr &nbsp; &nbsp; &nbsp;23651 23542 &nbsp;0 16:42 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: bgworker: bdr (6029519363330269950,1,16385,): digoal1314: apply &nbsp;&nbsp;</font></div><div><font size="2"   >bdr &nbsp; &nbsp; &nbsp;23652 23520 &nbsp;0 16:42 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:02 postgres: wal sender process digoal 127.0.0.1(40480) idle</font></div><div><font size="2"   >bdr &nbsp; &nbsp; &nbsp;23671 23520 &nbsp;0 16:42 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:04 postgres: bgworker: bdr (6029521270843008333,1,16385,): digoal1315: apply &nbsp;&nbsp;</font></div><div><font size="2"   >bdr &nbsp; &nbsp; &nbsp;23672 23542 &nbsp;0 16:42 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:01 postgres: wal sender process digoal 127.0.0.1(10525) idle</font></div><p></p></pre></div><div><br></div><div>反向复制 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >bdr@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 1315 -U digoal digoal02</font></div><div><font size="2"   >psql (9.4beta1_bdr0601)</font></div><div><font size="2"   >Type "help" for help.</font></div></div><div><div><font size="2"   >digoal02=# create table tbl3(id int primary key, info text);</font></div><div><font size="2"   >CREATE TABLE</font></div></div><div><div><font size="2"   >digoal02=# insert into tbl3 select * from tbl2;</font></div><div><font size="2"   >INSERT 0 10000</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >bdr@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 1314 -U digoal digoal01</font></div><div><font size="2"   >psql (9.4beta1_bdr0601)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal01=# \dt</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;List of relations</font></div><div><font size="2"   >&nbsp;Schema | Name | Type &nbsp;| Owner &nbsp;</font></div><div><font size="2"   >--------+------+-------+--------</font></div><div><font size="2"   >&nbsp;public | tbl1 | table | digoal</font></div><div><font size="2"   >&nbsp;public | tbl2 | table | digoal</font></div><div><font size="2"   >&nbsp;public | tbl3 | table | digoal</font></div><div><font size="2"   >(3 rows)</font></div></div><div><div><font size="2"   >digoal01=# select count(*) from tbl3;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp;10000</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>其他测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal01=# truncate tbl3;</font></div><div><font size="2"   >TRUNCATE TABLE</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal02=# select count(*) from tbl3;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;0</font></div><div><span style="line-height: 28px;"   ><font size="2"   >(1 row)</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   ><br></font></span></div><div><font size="2"   >digoal01=# create schema test;</font></div><div><font size="2"   >CREATE SCHEMA</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal02=# \dn</font></div><div><font size="2"   >&nbsp; List of schemas</font></div><div><font size="2"   >&nbsp; Name &nbsp;| &nbsp;Owner &nbsp;&nbsp;</font></div><div><font size="2"   >--------+----------</font></div><div><font size="2"   >&nbsp;bdr &nbsp; &nbsp;| postgres</font></div><div><font size="2"   >&nbsp;public | postgres</font></div><div><font size="2"   >&nbsp;test &nbsp; | digoal</font></div><div><font size="2"   >(3 rows)</font></div></div><p></p></pre></div><div>冲突表</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal01=# \dn</font></div><div><font size="2"   >&nbsp; List of schemas</font></div><div><font size="2"   >&nbsp; Name &nbsp;| &nbsp;Owner &nbsp;&nbsp;</font></div><div><font size="2"   >--------+----------</font></div><div><font size="2"   >&nbsp;bdr &nbsp; &nbsp;| postgres</font></div><div><font size="2"   >&nbsp;public | postgres</font></div><div><font size="2"   >&nbsp;test &nbsp; | digoal</font></div><div><font size="2"   >(3 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal01=# \dt bdr.bdr_</font></div><div><font size="2"   >bdr.bdr_conflict_handlers &nbsp; bdr.bdr_nodes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bdr.bdr_sequence_elections &nbsp;</font></div><div><font size="2"   >bdr.bdr_conflict_history &nbsp; &nbsp;bdr.bdr_queued_commands &nbsp; &nbsp; bdr.bdr_sequence_values &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >bdr.bdr_global_locks &nbsp; &nbsp; &nbsp; &nbsp;bdr.bdr_queued_drops &nbsp; &nbsp; &nbsp; &nbsp;bdr.bdr_votes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >digoal01=# \dt bdr.bdr_conflict_history&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; &nbsp; &nbsp; Name &nbsp; &nbsp; &nbsp; &nbsp; | Type &nbsp;| &nbsp;Owner &nbsp;&nbsp;</font></div><div><font size="2"   >--------+----------------------+-------+----------</font></div><div><font size="2"   >&nbsp;bdr &nbsp; &nbsp;| bdr_conflict_history | table | postgres</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal01=# \d bdr.bdr_conflict_history&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Table "bdr.bdr_conflict_history"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Column &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Modifiers &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >--------------------------+-----------------------------+-----------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;conflict_id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null default nextval('bdr.bdr_conflict_history_id_seq'::regclass)</font></div><div><font size="2"   >&nbsp;local_node_sysid &nbsp; &nbsp; &nbsp; &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;local_conflict_xid &nbsp; &nbsp; &nbsp; | xid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;local_conflict_lsn &nbsp; &nbsp; &nbsp; | pg_lsn &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;local_conflict_time &nbsp; &nbsp; &nbsp;| timestamp with time zone &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;object_schema &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;object_name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;remote_node_sysid &nbsp; &nbsp; &nbsp; &nbsp;| text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;remote_txid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| xid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;remote_commit_time &nbsp; &nbsp; &nbsp; | timestamp with time zone &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;remote_commit_lsn &nbsp; &nbsp; &nbsp; &nbsp;| pg_lsn &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"   >&nbsp;conflict_type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| bdr.bdr_conflict_type &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;conflict_resolution &nbsp; &nbsp; &nbsp;| bdr.bdr_conflict_resolution | not null</font></div><div><font size="2"   >&nbsp;local_tuple &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| json &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;remote_tuple &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | json &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;local_tuple_xmin &nbsp; &nbsp; &nbsp; &nbsp; | xid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;local_tuple_origin_sysid | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;error_message &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;error_sqlstate &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;error_querystring &nbsp; &nbsp; &nbsp; &nbsp;| text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;error_cursorpos &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;error_detail &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;error_hint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;error_context &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;error_columnname &nbsp; &nbsp; &nbsp; &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;error_typename &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;error_constraintname &nbsp; &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;error_filename &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;error_lineno &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;error_funcname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >Indexes:</font></div><div><font size="2"   >&nbsp; &nbsp; "bdr_conflict_history_pkey" PRIMARY KEY, btree (local_node_sysid, conflict_id)</font></div><div><font size="2"   >Check constraints:</font></div><div><font size="2"   >&nbsp; &nbsp; "bdr_conflict_history_error_sqlstate_check" CHECK (length(error_sqlstate) = 5)</font></div><p></p></pre></div><div><br></div><div>复制插槽, 插槽名内包含数据库唯一ID,</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >bdr@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 1315 -U digoal digoal02</font></div><div><font size="2"   >psql (9.4beta1_bdr0601)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal02=# select * from pg_replication_slots ;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slot_name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; plugin &nbsp; | slot_type | datoid | database | active | xmin | catalog_xmin | restart_lsn&nbsp;</font></div><div><font size="2"   >-----------------------------------------+------------+-----------+--------+----------+--------+------+--------------+-------------</font></div><div><font size="2"   >&nbsp;bdr_16385_6029521270843008333_1_16385__ | bdr_output | logical &nbsp; | &nbsp;16385 | digoal02 | t &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 2015 | 0/D038E78</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >bdr@db-172-16-3-150-&gt; pg_controldata&nbsp;</font></div><div><font size="2"   >pg_control version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;937</font></div><div><font size="2"   >Catalog version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 201405111</font></div><div><font size="2"   >Database system identifier: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 6029521270843008333</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal01=# select * from pg_replication_slots ;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slot_name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; plugin &nbsp; | slot_type | datoid | database | active | xmin | catalog_xmin | restart_lsn&nbsp;</font></div><div><font size="2"   >-----------------------------------------+------------+-----------+--------+----------+--------+------+--------------+-------------</font></div><div><font size="2"   >&nbsp;bdr_16385_6029519363330269950_1_16385__ | bdr_output | logical &nbsp; | &nbsp;16385 | digoal01 | t &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 2063 | 0/12CE88D8</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >bdr@db-172-16-3-150-&gt; pg_controldata /ssd4/bdr/pg_root1315</font></div><div><font size="2"   >pg_control version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;937</font></div><div><font size="2"   >Catalog version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 201405111</font></div><div><font size="2"   >Database system identifier: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 6029519363330269950</font></div></div><p></p></pre></div><div><br></div><div><div>暂停</div><div>在任意节点执行 bdr.bdr_apply_pause(), bdr.bdr_apply_resume()</div><div><br></div><div>临时停止逻辑复制</div><div>shutdown downstream数据库, upstream数据库的pg_xlog不会被删除, 所以不能停太久, 否则upstream的xlog可能占满磁盘空间.</div><div><br></div><div>删除逻辑复制</div><div>在upstream节点执行 SELECT pg_drop_replication_slot('slotname') 删除插槽.</div><div>通过pg_replication_slots查看插槽.</div><div>digoal01=# select * from pg_replication_slots ;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slot_name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; plugin &nbsp; | slot_type | datoid | database | active | xmin | catalog_xmin | restart_lsn&nbsp;</div><div>-----------------------------------------+------------+-----------+--------+----------+--------+------+--------------+-------------</div><div>&nbsp;bdr_16385_6029519363330269950_1_16385__ | bdr_output | logical &nbsp; | &nbsp;16385 | digoal01 | t &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 2063 | 0/12CE88D8</div><div>(1 row)</div><div>digoal02=# select * from pg_replication_slots ;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slot_name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; plugin &nbsp; | slot_type | datoid | database | active | xmin | catalog_xmin | restart_lsn&nbsp;</div><div>-----------------------------------------+------------+-----------+--------+----------+--------+------+--------------+-------------</div><div>&nbsp;bdr_16385_6029521270843008333_1_16385__ | bdr_output | logical &nbsp; | &nbsp;16385 | digoal02 | t &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 2015 | 0/D038E78</div><div>(1 row)</div></div><div><br></div><div>[效率测试]</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >psql -h 127.0.0.1 -p 1314 -U digoal digoal01</font></div><div><font size="2"   >create table test(id int primary key, info text, crt_time timestamp);</font></div><div><font size="2"   >create or replace function f(v_id int) returns void as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; update test set info=md5(now()::text),crt_time=now() where id=v_id;</font></div><div><font size="2"   >&nbsp; if not found then</font></div><div><font size="2"   >&nbsp; &nbsp; insert into test(id,info,crt_time) values(v_id,md5(now()::text),now());</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; exception when others then</font></div><div><font size="2"   >&nbsp; &nbsp; return;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql strict;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >vi test.sql</font></div><div><font size="2"   >\setrandom v_id 1 5000000</font></div><div><font size="2"   >select f(:v_id);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pgbench -M prepared -f ./test.sql -n -r -h 127.0.0.1 -p 1314 -U digoal -c 8 -j 4 -T 30 digoal01</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >同步提交延迟, 注意取pgbench结束时与复制完成后的location差异, 大约50MB;</font></div><div><font size="2"   >digoal01=# select * from pg_stat_replication ;</font></div><div><font size="2"   >-[ RECORD 1 ]----+--------------------------------------------</font></div><div><font size="2"   >&nbsp;pid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3563 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;usesysid &nbsp; &nbsp; &nbsp; &nbsp; | 16384 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;usename &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| digoal &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;application_name | bdr (6029519363330269950,1,16385,): receive&nbsp;</font></div><div><font size="2"   >&nbsp;client_addr &nbsp; &nbsp; &nbsp;| 127.0.0.1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;client_hostname &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;client_port &nbsp; &nbsp; &nbsp;| 41869 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;backend_start &nbsp; &nbsp;| 2014-06-27 23:24:18.86267+08 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;backend_xmin &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;state &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| streaming &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;sent_location &nbsp; &nbsp;| 0/1612B060 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;write_location &nbsp; | 0/160A9C20 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;flush_location &nbsp; | 0/160A9C20 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;replay_location &nbsp;| 0/160A9C20 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;sync_priority &nbsp; &nbsp;| 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;sync_state &nbsp; &nbsp; &nbsp; | async</font></div><div><font size="2"   ><br></font></div></div></div><div><div><font size="2"   >同步提交TPS</font></div><div><font size="2"   >pgbench -M prepared -f ./test.sql -n -r -h 127.0.0.1 -p 1314 -U digoal -c 8 -j 4 -T 30 digoal01</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 136383</font></div><div><font size="2"   >latency average: 1.760 ms</font></div><div><font size="2"   >tps = 4545.667101 (including connections establishing)</font></div><div><font size="2"   >tps = 4546.989202 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003936 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom v_id 1 5000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.752829 &nbsp; &nbsp; &nbsp; &nbsp;select f(:v_id);</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >synchronous_commit = off</font></div><div><font size="2"   >异步提交延迟</font><span style="line-height: 21px; font-size: small; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, 宋体;"   >, 注意取pgbench结束时与复制完成后的location差异, 大约50MB;</span></div><div><font size="2"   >digoal01=# select * from pg_stat_replication ;</font></div><div><font size="2"   >-[ RECORD 1 ]----+--------------------------------------------</font></div><div><font size="2"   >&nbsp;pid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3563 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;usesysid &nbsp; &nbsp; &nbsp; &nbsp; | 16384 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;usename &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| digoal &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;application_name | bdr (6029519363330269950,1,16385,): receive&nbsp;</font></div><div><font size="2"   >&nbsp;client_addr &nbsp; &nbsp; &nbsp;| 127.0.0.1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;client_hostname &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;client_port &nbsp; &nbsp; &nbsp;| 41869 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;backend_start &nbsp; &nbsp;| 2014-06-27 23:24:18.86267+08 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;backend_xmin &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;state &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| streaming &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;sent_location &nbsp; &nbsp;| 0/1C861E80 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;write_location &nbsp; | 0/1C7A7F40 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;flush_location &nbsp; | 0/1C7A7F40 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;replay_location &nbsp;| 0/1C7A7F40 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;sync_priority &nbsp; &nbsp;| 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp;sync_state &nbsp; &nbsp; &nbsp; | async</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >synchronous_commit = off</font></div><div><font size="2"   >异步提交TPS</font></div><div><font size="2"   >pgbench -M prepared -f ./test.sql -n -r -h 127.0.0.1 -p 1314 -U digoal -c 8 -j 4 -T 30 digoal01</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 322561</font></div><div><font size="2"   >latency average: 0.744 ms</font></div><div><font size="2"   >tps = 10751.245625 (including connections establishing)</font></div><div><font size="2"   >tps = 10754.180674 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003695 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom v_id 1 5000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.737776 &nbsp; &nbsp; &nbsp; &nbsp;select f(:v_id);</font></div><div><font size="2"   ><br></font></div></div><div><div><font size="2"   >关闭逻辑复制(注意本案逻辑复制的另一台节点在同一台主机, 所以对测试结果有一定影响, 理论上逻辑复制带来的TPS差异没有这么明显)</font></div><div><font size="2"   >同步提交TPS</font></div><div><font size="2"   >pgbench -M prepared -f ./test.sql -n -r -h 127.0.0.1 -p 1314 -U digoal -c 8 -j 4 -T 30 digoal01</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 168087</font></div><div><font size="2"   >latency average: 1.428 ms</font></div><div><font size="2"   >tps = 5602.641345 (including connections establishing)</font></div><div><font size="2"   >tps = 5604.156779 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003864 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom v_id 1 5000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.421089 &nbsp; &nbsp; &nbsp; &nbsp;select f(:v_id);</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >关闭逻辑复制</font></div><div><font size="2"   >异步提交TPS</font></div><div><font size="2"   >pgbench -M prepared -f ./test.sql -n -r -h 127.0.0.1 -p 1314 -U digoal -c 8 -j 4 -T 30 digoal01</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 437412</font></div><div><font size="2"   >latency average: 0.549 ms</font></div><div><font size="2"   >tps = 14579.955311 (including connections establishing)</font></div><div><font size="2"   >tps = 14584.159189 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003585 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom v_id 1 5000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.542548 &nbsp; &nbsp; &nbsp; &nbsp;select f(:v_id);</font></div></div><p></p></pre></div><div><div><br></div></div><div><br></div><div>[其他]</div><div>1. 被复制的库, 所有的对象必须有主键或者非空唯一索引.</div><div><div>2. 复制效率高于SQL replay模式, The apply process makes changes directly rather than generating SQL text and then parse/plan/executing SQL.</div><div>3. 可复制create, insert, update, delete, truncate等SQL.</div><div>4. 不复制unlogged table数据</div><div>5. 不复制temp表定义</div><div>6. down-stream节点如果与apply发生冲突, 将导致复制延迟(与PLSR类似).</div><div>7. 复制对象必须有非空唯一约束或主键.</div><div>8. 支持自定义类型, 注意保持OID一致, (未来版本可能没有这个要求)</div><div>9. down-stream 节点wal replay的顺序遵循commit顺序.</div><div>10. 目前大事务在提交前产生的事务数据在upstream节点存放, 所以容易导致复制延迟, 未来会把这部分数据在down stream节点处理, 以提高replay速度. Larger transactions spill to disk on the upstream master once they reach a certain size. Currently, large transactions can cause increased latency. Future enhancement will be to stream changes to downstream master once they fill the upstream memory buffer, though this is likely to be implemented in 9.5.</div><div>11. notify 不会在down stream节点被接收.</div></div><div><br></div><div><br></div><div><br></div><div>[参考]</div><div><div style="line-height: 28px;"   >1.&nbsp;<a target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=2ndquadrant_bdr.git;a=summary"   >http://git.postgresql.org/gitweb/?p=2ndquadrant_bdr.git;a=summary</a></div><div style="line-height: 28px;"   >2.&nbsp;<a target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=2ndquadrant_bdr.git;a=shortlog;h=refs/heads/bdr-next"   >http://git.postgresql.org/gitweb/?p=2ndquadrant_bdr.git;a=shortlog;h=refs/heads/bdr-next</a></div></div><div>3.&nbsp;<a target="_blank" rel="nofollow" href="https://wiki.postgresql.org/wiki/BDR_Parameter_Reference"   >https://wiki.postgresql.org/wiki/BDR_Parameter_Reference</a></div><div>4.&nbsp;<a target="_blank" rel="nofollow" href="https://wiki.postgresql.org/wiki/BDR_Administration"   >https://wiki.postgresql.org/wiki/BDR_Administration</a></div><div>5.&nbsp;<a target="_blank" rel="nofollow" href="https://wiki.postgresql.org/wiki/Logical%20Log%20Streaming%20Replication?nocache=0.75704200+1403840368"   >https://wiki.postgresql.org/wiki/Logical%20Log%20Streaming%20Replication?nocache=0.75704200+1403840368</a></div><div>6.&nbsp;<a target="_blank" rel="nofollow" href="https://wiki.postgresql.org/wiki/BDR_Reference"   >https://wiki.postgresql.org/wiki/BDR_Reference</a></div><div>7.&nbsp;<a target="_blank" rel="nofollow" href="https://wiki.postgresql.org/wiki/BDR_User_Guide"   >https://wiki.postgresql.org/wiki/BDR_User_Guide</a></div><div>8.&nbsp;<a target="_blank" rel="nofollow" href="https://wiki.postgresql.org/wiki/BDR_Quick_Start"   >https://wiki.postgresql.org/wiki/BDR_Quick_Start</a></div><div><br></div><div><br></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL BDR(Bi-Directional Replication), LLSR(Logical Log Stream Replication) - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>