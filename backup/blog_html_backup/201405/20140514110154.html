<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL column based store in foreign table contributed by citusdb</h2>
	<h5 id="">2014-05-14 11:01:54&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020144141052312/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>cstore_fdw是citusdb推出的一个外部表插件, 支持列存储以及压缩.</div><div>支持的OPTIONS如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >The following parameters can be set on a cstore foreign table object.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><b>filename</b>: The absolute path to the location for storing table data. Before creating your columnar tables, you may want to choose and create a directory to keep your cstore files.</font></div><div><font size="2"   ><b>compression</b>: The compression used for compressing value streams. Valid options are none and pglz. The default is none.</font></div><div><font size="2"   ><b>stripe_row_count</b>: Number of rows per stripe. The default is 150000. Reducing this decreases the amount memory used for loading data and querying, but also decreases the performance.</font></div><div><font size="2"   ><b>block_row_count</b>: Number of rows per column block. The default is 10000. cstore_fdw compresses, creates skip indexes, and reads from disk at the block granularity. Increasing this value helps with compression and results in fewer reads from disk. However, higher values also reduce the probability of skipping over unrelated row blocks.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >You can use PostgreSQL's COPY command to load or append data into the table. You can use PostgreSQL's ANALYZE table_name command to collect statistics about the table. These statistics help the query planner to help determine the most efficient execution plan for each query.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Note. We currently don't support updating table using INSERT, DELETE, and UPDATE commands.</font></div><p></p></pre></div><div>目前可以通过COPY将数据拷贝到cstore外部表, 数据存储在磁盘中, 结合citusdb使用的话, 可以将其存储在HDFS中.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >-- load extension first time after install</font></div><div><font size="2"   >CREATE EXTENSION cstore_fdw;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- create server object</font></div><div><font size="2"   >CREATE SERVER cstore_server FOREIGN DATA WRAPPER cstore_fdw;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- create foreign table</font></div><div><font size="2"   >CREATE FOREIGN TABLE customer_reviews</font></div><div><font size="2"   >(</font></div><div><font size="2"   >&nbsp; &nbsp; customer_id TEXT,</font></div><div><font size="2"   >&nbsp; &nbsp; review_date DATE,</font></div><div><font size="2"   >&nbsp; &nbsp; review_rating INTEGER,</font></div><div><font size="2"   >&nbsp; &nbsp; review_votes INTEGER,</font></div><div><font size="2"   >&nbsp; &nbsp; review_helpful_votes INTEGER,</font></div><div><font size="2"   >&nbsp; &nbsp; product_id CHAR(10),</font></div><div><font size="2"   >&nbsp; &nbsp; product_title TEXT,</font></div><div><font size="2"   >&nbsp; &nbsp; product_sales_rank BIGINT,</font></div><div><font size="2"   >&nbsp; &nbsp; product_group TEXT,</font></div><div><font size="2"   >&nbsp; &nbsp; product_category TEXT,</font></div><div><font size="2"   >&nbsp; &nbsp; product_subcategory TEXT,</font></div><div><font size="2"   >&nbsp; &nbsp; similar_product_ids CHAR(10)[]</font></div><div><font size="2"   >)</font></div><div><font size="2"   >DISTRIBUTE BY APPEND(customer_reviews)</font></div><div><font size="2"   >SERVER cstore_server</font></div><div><font size="2"   >OPTIONS(filename '', compression 'pglz');</font></div><p></p></pre></div><div>在普通的PostgreSQL中使用的话, 也是可以的.</div><div>下面我演示一下在普通的PostgreSQL中使用的方法.</div><div>以PostgreSQL 9.3.3和CentOS 6.x x64为例 :&nbsp;</div><div>首先要添加一个YUM源, 用以安装protobuf-c-devel, 这个是cstore依赖的包.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ]# wget http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</font></div><div><font size="2"   >[root@db-172-16-3-150 ]# wget http://rpms.famillecollet.com/enterprise/remi-release-6.rpm</font></div><div><font size="2"   >[root@db-172-16-3-150 ]# sudo rpm -Uvh remi-release-6*.rpm epel-release-6*.rpm</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-150 ]# vi /etc/yum.repos.d/CentOS-Base.repo</font></div><div><font size="2"   >name=Les RPM de remi pour Enterprise Linux $releasever - $basearch</font></div><div><font size="2"   >#baseurl=http://rpms.famillecollet.com/enterprise/$releasever/remi/$basearch/</font></div><div><font size="2"   >mirrorlist=http://rpms.famillecollet.com/enterprise/$releasever/remi/mirror</font></div><div><font size="2"   >enabled=1</font></div><div><font size="2"   >gpgcheck=1</font></div><div><font size="2"   >gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-remi</font></div><div><font size="2"   >failovermethod=priority</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-150 ]# yum install -y protobuf-c-devel</font></div><p></p></pre></div><div>接下来下载cstore_fdw, 并安装 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ]# git clone https://github.com/citusdata/cstore_fdw</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-150 cstore_fdw]# cd cstore_fdw/</font></div><div><font size="2"   >[root@db-172-16-3-150 cstore_fdw]# export PATH=/home/pg93/pgsql9.3.3/bin:$PATH</font></div><div><font size="2"   >[root@db-172-16-3-150 cstore_fdw]# which pg_config</font></div><div><font size="2"   >/home/pg93/pgsql9.3.3/bin/pg_config</font></div><div><font size="2"   >[root@db-172-16-3-150 cstore_fdw]# gmake clean</font></div><div><font size="2"   >[root@db-172-16-3-150 cstore_fdw]# gmake</font></div><div><font size="2"   >[root@db-172-16-3-150 cstore_fdw]# gmake install</font></div><p></p></pre></div><div>将cstore_fdw动态链接库加载到PostgreSQL的preload库参数中, 重启数据库, 创建extension :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 cstore_fdw]# su - pg93</font></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; cd $PGDATA</font></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; vi postgresql.conf&nbsp;</font></div><div><font size="2"   >shared_preload_libraries = 'cstore_fdw,pg_stat_statements,auto_explain'&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; pg_ctl restart -m fast</font></div><div><font size="2"   >waiting for server to shut down.... done</font></div><div><font size="2"   >server stopped</font></div><div><font size="2"   >server starting</font></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; LOG: &nbsp;00000: loaded library "cstore_fdw"</font></div><div><font size="2"   >LOCATION: &nbsp;load_libraries, miscinit.c:1296</font></div><div><font size="2"   >LOG: &nbsp;00000: loaded library "pg_stat_statements"</font></div><div><font size="2"   >LOCATION: &nbsp;load_libraries, miscinit.c:1296</font></div><div><font size="2"   >LOG: &nbsp;00000: loaded library "auto_explain"</font></div><div><font size="2"   >LOCATION: &nbsp;load_libraries, miscinit.c:1296</font></div><div><font size="2"   >LOG: &nbsp;00000: redirecting log output to logging collector process</font></div><div><font size="2"   >HINT: &nbsp;Future log output will appear in directory "pg_log".</font></div><div><font size="2"   >LOCATION: &nbsp;SysLogger_Start, syslogger.c:649</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; psql</font></div><div><font size="2"   >psql (9.3.3)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# CREATE EXTENSION cstore_fdw;</font></div><div><font size="2"   >CREATE EXTENSION</font></div><p></p></pre></div><div>测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# CREATE SERVER cstore_server FOREIGN DATA WRAPPER cstore_fdw;</font></div><div><font size="2"   >CREATE SERVER</font></div><p></p></pre></div><div>创建一个本地表</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table local (id int, info text, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><p></p></pre></div><div>插入1000万条测试记录</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# insert into local select generate_series(1,10000000),md5(random()::text),clock_timestamp();</font></div><div><font size="2"   >INSERT 0 10000000</font></div><p></p></pre></div><div>创建外部表, filename指定存储到哪个文件, postgresql操作系统的启动用户对这个文件的目录必须有写权限.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create foreign table cstore_tbl (id int, info text, crt_time timestamp)</font></div><div><font size="2"   >digoal-# &nbsp; server cstore_server</font></div><div><font size="2"   >digoal-# &nbsp; options (filename '/ssd3/pg93/cstore_tbl.cstore', compression 'pglz');</font></div><div><font size="2"   >CREATE FOREIGN TABLE</font></div><p></p></pre></div><div>将本地表的数据拷贝到一个外部文件中, 并导入到cstore表.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# copy local to '/ssd3/pg93/local.dmp';</font></div><div><font size="2"   >COPY 10000000</font></div><div><font size="2"   >digoal=# copy cstore_tbl from '/ssd3/pg93/local.dmp';</font></div><div><font size="2"   >COPY 10000000</font></div><p></p></pre></div><div>查看一下本地表的大小, cstore表的大小, 文件的大小, 可以看到cstore在使用了pglz压缩后明显小多了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# \dt+ local&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of relations</font></div><div><font size="2"   >&nbsp;Schema | Name &nbsp;| Type &nbsp;| &nbsp;Owner &nbsp; | &nbsp;Size &nbsp;| Description&nbsp;</font></div><div><font size="2"   >--------+-------+-------+----------+--------+-------------</font></div><div><font size="2"   >&nbsp;public | local | table | postgres | 727 MB |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; ll</font></div><div><font size="2"   >total 1.1G</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 392M May 14 10:38 cstore_tbl.cstore</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 1.2K May 14 10:38 cstore_tbl.cstore.footer</font></div><div><font size="2"   >-rw-r--r-- 1 pg93 pg93 647M May 14 10:37 local.dmp</font></div><p></p></pre></div><div><br></div><div>分析本地表和外部表, 分析效率本地表要高很多.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# analyze local;</font></div><div><font size="2"   >ANALYZE</font></div><div><font size="2"   >Time: 499.031 ms</font></div><div><font size="2"   >digoal=# analyze cstore_tbl ;</font></div><div><font size="2"   >ANALYZE</font></div><div><font size="2"   >Time: 4677.271 ms</font></div><p></p></pre></div><div><br></div><div>对比几个查询的效率, 字符串查询效率差不多, 但是固定长度的数据类型查询效率明显提高 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select count(*) from local&nbsp;</font></div><div><font size="2"   >digoal-# ;</font></div><div><font size="2"   >&nbsp; count &nbsp;&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp;10000000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 1686.153 ms</font></div><div><font size="2"   >digoal=# select count(*) from cstore_tbl ;</font></div><div><font size="2"   >&nbsp; count &nbsp;&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp;10000000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 1655.827 ms</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select * from cstore_tbl where id=1;</font></div><div><font size="2"   >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+----------------------------------+---------------------------</font></div><div><font size="2"   >&nbsp; 1 | d4863ea74e73def99e1ccbf585af97f6 | 2014-05-14 10:33:44.11643</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 40.174 ms</font></div><div><font size="2"   >digoal=# select * from local where id=1;</font></div><div><font size="2"   >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+----------------------------------+---------------------------</font></div><div><font size="2"   >&nbsp; 1 | d4863ea74e73def99e1ccbf585af97f6 | 2014-05-14 10:33:44.11643</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 1722.087 ms</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select * from local where info='d4863ea74e73def99e1ccbf585af97f6';</font></div><div><font size="2"   >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+----------------------------------+---------------------------</font></div><div><font size="2"   >&nbsp; 1 | d4863ea74e73def99e1ccbf585af97f6 | 2014-05-14 10:33:44.11643</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 2319.669 ms</font></div><div><font size="2"   >digoal=# select * from cstore_tbl where info='d4863ea74e73def99e1ccbf585af97f6';</font></div><div><font size="2"   >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+----------------------------------+---------------------------</font></div><div><font size="2"   >&nbsp; 1 | d4863ea74e73def99e1ccbf585af97f6 | 2014-05-14 10:33:44.11643</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 5378.137 ms</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select * from cstore_tbl where crt_time='2014-05-14 10:33:44.11643';</font></div><div><font size="2"   >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+----------------------------------+---------------------------</font></div><div><font size="2"   >&nbsp; 1 | d4863ea74e73def99e1ccbf585af97f6 | 2014-05-14 10:33:44.11643</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 40.382 ms</font></div><div><font size="2"   >digoal=# select * from local where crt_time='2014-05-14 10:33:44.11643';</font></div><div><font size="2"   >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+----------------------------------+---------------------------</font></div><div><font size="2"   >&nbsp; 1 | d4863ea74e73def99e1ccbf585af97f6 | 2014-05-14 10:33:44.11643</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 1876.504 ms</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >[参考]</span></div></div><wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://gigaom.com/2014/04/04/citus-data-builds-a-column-store-for-postgres/"   >https://gigaom.com/2014/04/04/citus-data-builds-a-column-store-for-postgres/</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.citusdata.com/blog/76-postgresql-columnar-store-for-analytics"   >http://www.citusdata.com/blog/76-postgresql-columnar-store-for-analytics</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://github.com/citusdata/cstore_fdw"   >https://github.com/citusdata/cstore_fdw</a></div><div>4.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://citusdata.com/docs/foreign-data#cstore-wrapper"   >http://citusdata.com/docs/foreign-data#cstore-wrapper</a></div><div>5.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.rackspace.com/knowledge_center/article/installing-rhel-epel-repo-on-centos-5x-or-6x"   >http://www.rackspace.com/knowledge_center/article/installing-rhel-epel-repo-on-centos-5x-or-6x</a></div><div>6.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.translattice.com/"   >http://www.translattice.com/</a></div><div>7.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://gigaom.com/2014/05/13/database-vendor-open-sources-postgres-xl-for-scale-out-workloads/"   >http://gigaom.com/2014/05/13/database-vendor-open-sources-postgres-xl-for-scale-out-workloads/</a></div><div><p><br></p><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL column based store in foreign table contributed by citusdb - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">LuckyYear - 2015-01-09 16:33:51</h5>
				<div>博主，看了你关于列存储的实践测试，真是非常感谢，里面有个小小的问题，<div><br></div><div>列存储性能，就我个人使用过的经验看，是只会在你select 的列比较少时才会体现。</div><div><br></div><div>所以，个人建议下次有机会是否可以改为select count(1) 这样测试，也许会有很大的不同。</div><div><br></div><div>另外，我现在要做一个百亿级的数据分析，想用pgsql的列存储到hdfs，有两个问题想咨询下</div><div>1. pgsql行存储和oracle的行存储的数据分析性能，你认为哪个强一些?</div><div>2. pgsql的列存储，我之前就有关注，这个的发展好像比较缓慢，不知道是否有生产的应用实践过，稳定性如何？</div></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 LuckyYear - 2015-01-09 16:33:51</h5>
				<div style="width:600px;">HI, 列存储的话你可以考虑一下monetDB.<div>和ORA比, 目前PG还不支持多核操作, 所以性能会弱很多, 另外目前PG分析函数库也没有ORA那么强大, 你可以考虑一下greenplum.</div><div>和hdfs结合的话, 也是一个不错的方向, 当作pg的外部表来操作.</div><div>pg的foreign data wrap接口非常不错, 已有的FDW你可以参考一下https://wiki.postgresql.org/wiki/Fdw, 如果不能满足需求, 可以自己写FDW.</div></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 LuckyYear - 2015-01-09 16:33:51</h5>
				<div style="width:600px;">count的问题, 对列操作的话可能会快一些(假设不需要扫所有的列).</div>
			</div>
	</div>
</div>
</body>
</html>