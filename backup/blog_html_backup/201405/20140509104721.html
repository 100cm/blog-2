<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL extract points in polygon & path type</h2>
	<h5 id="">2014-05-09 10:47:21&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201449102216329/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">早上群里的一位兄弟问到如何将polygon多边形的交点取出来.<wbr><div>首先查一下手册有没有对应的转换函数, 显然是没有的, 大家可以翻阅如下 :&nbsp;</div><div><a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/functions-geometry.html"   >http://www.postgresql.org/docs/devel/static/functions-geometry.html</a></div><div>然后查对应的cstring格式输出 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# \df *.*poly*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of functions</font></div><div><font size="2"   >&nbsp; &nbsp;Schema &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; Name &nbsp; &nbsp; &nbsp; &nbsp; | Result data type | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Argument data types &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;Type &nbsp;</font></div><div><font size="2"   >------------+----------------------+------------------+-------------------------------------------+--------</font></div><div><font size="2"   >&nbsp;pg_catalog | dist_cpoly &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | double precision | circle, polygon &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | normal</font></div><div><font size="2"   >&nbsp;pg_catalog | gist_poly_compress &nbsp; | internal &nbsp; &nbsp; &nbsp; &nbsp; | internal &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;pg_catalog | gist_poly_consistent | boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| internal, polygon, integer, oid, internal | normal</font></div><div><font size="2"   >&nbsp;pg_catalog | poly_above &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| polygon, polygon &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;pg_catalog | poly_below &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| polygon, polygon &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;pg_catalog | poly_center &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| point &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| polygon &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | normal</font></div><div><font size="2"   >&nbsp;pg_catalog | poly_contain &nbsp; &nbsp; &nbsp; &nbsp; | boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| polygon, polygon &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;pg_catalog | poly_contain_pt &nbsp; &nbsp; &nbsp;| boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| polygon, point &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;pg_catalog | poly_contained &nbsp; &nbsp; &nbsp; | boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| polygon, polygon &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;pg_catalog | poly_distance &nbsp; &nbsp; &nbsp; &nbsp;| double precision | polygon, polygon &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;pg_catalog | poly_in &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| polygon &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| cstring &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | normal</font></div><div><font size="2"   >&nbsp;pg_catalog | poly_left &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| polygon, polygon &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;pg_catalog | poly_npoints &nbsp; &nbsp; &nbsp; &nbsp; | integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| polygon &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | normal</font></div><div><font size="2"   >&nbsp;pg_catalog | poly_out &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | cstring &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| polygon &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | normal</font></div><div><font size="2"   >&nbsp;pg_catalog | poly_overabove &nbsp; &nbsp; &nbsp; | boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| polygon, polygon &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;pg_catalog | poly_overbelow &nbsp; &nbsp; &nbsp; | boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| polygon, polygon &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;pg_catalog | poly_overlap &nbsp; &nbsp; &nbsp; &nbsp; | boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| polygon, polygon &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;pg_catalog | poly_overleft &nbsp; &nbsp; &nbsp; &nbsp;| boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| polygon, polygon &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;pg_catalog | poly_overright &nbsp; &nbsp; &nbsp; | boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| polygon, polygon &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;pg_catalog | poly_recv &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| polygon &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| internal &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;pg_catalog | poly_right &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| polygon, polygon &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;pg_catalog | poly_same &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| polygon, polygon &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;pg_catalog | poly_send &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| bytea &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| polygon &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | normal</font></div><div><font size="2"   >&nbsp;pg_catalog | polygon &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| polygon &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| box &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | normal</font></div><div><font size="2"   >&nbsp;pg_catalog | polygon &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| polygon &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| circle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;pg_catalog | polygon &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| polygon &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| integer, circle &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | normal</font></div><div><font size="2"   >&nbsp;pg_catalog | polygon &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| polygon &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| path &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >&nbsp;pg_catalog | pt_contained_poly &nbsp; &nbsp;| boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| point, polygon &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</font></div><div><font size="2"   >(28 rows)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal=# select poly_out(polygon '((0,0),(1,1),(2,0))');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; poly_out &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------------------</font></div><div><font size="2"   >&nbsp;((0,0),(1,1),(2,0))</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>查看对应的代码</div><div>src/backend/utils/adt/geo_ops.c</div><div>得知polygon其实就是闭环的path, 在内部数据存储上也是相同的.</div><div>PostgreSQL平面几何类型的cstring表述 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp;105 &nbsp;* Data representation is as follows:</font></div><div><font size="2"   >&nbsp;106 &nbsp;* &nbsp;point: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(x,y)</font></div><div><font size="2"   >&nbsp;107 &nbsp;* &nbsp;line segment: &nbsp; &nbsp; &nbsp; [(x1,y1),(x2,y2)]</font></div><div><font size="2"   >&nbsp;108 &nbsp;* &nbsp;box: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(x1,y1),(x2,y2)</font></div><div><font size="2"   >&nbsp;109 &nbsp;* &nbsp;open path: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[(x1,y1),...,(xn,yn)]</font></div><div><font size="2"   >&nbsp;110 &nbsp;* &nbsp;closed path: &nbsp; &nbsp; &nbsp; &nbsp;((x1,y1),...,(xn,yn))</font></div><div><font size="2"   >&nbsp;111 &nbsp;* &nbsp;polygon: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;((x1,y1),...,(xn,yn))</font></div><p></p></pre></div><div><br></div><div>polygon转换成cstring的代码, 显然先转换成了path.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >3478 /*---------------------------------------------------------------</font></div><div><font size="2"   >3479 &nbsp;* poly_out - convert internal POLYGON representation to the</font></div><div><font size="2"   >3480 &nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;character string format "((f8,f8),...,(f8,f8))"</font></div><div><font size="2"   >3481 &nbsp;*---------------------------------------------------------------*/</font></div><div><font size="2"   >3482 Datum</font></div><div><font size="2"   >3483 poly_out(PG_FUNCTION_ARGS)</font></div><div><font size="2"   >3484 {</font></div><div><font size="2"   >3485 &nbsp; &nbsp; POLYGON &nbsp; &nbsp;*poly = PG_GETARG_POLYGON_P(0);</font></div><div><font size="2"   >3486&nbsp;</font></div><div><font size="2"   >3487 &nbsp; &nbsp; PG_RETURN_CSTRING(path_encode(PATH_CLOSED, poly-&gt;npts, poly-&gt;p));</font></div><div><font size="2"   >3488 }</font></div><p></p></pre></div><div><br></div><div><font size="3"   >好了, 我们知道cstring格式了, 就可以对它做分析处理了, 当然最高效的是在geo_ops.c 中加一个C的转换函数.</font></div><div><font size="3"   >对于一般使用者则可以选择使用规则表达式来达到目的.</font></div><div><font size="3"   >例如 :&nbsp;</font></div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select regexp_replace(regexp_replace(regexp_replace(textin(poly_out(polygon '((0,0),(1,1),(2,0))')), '^\((.*)\)$', '{\1}'), '\(', '"(', 'g'), '\)', ')"', 'g')::point[];</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; regexp_replace &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------------------------</font></div><div><font size="2"   >&nbsp;{"(0,0)","(1,1)","(2,0)"}</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div style="font-size: medium;"   >分解一下 :&nbsp;</div><div style="font-size: medium;"   >polygon类型输出 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select polygon '((0,0),(1,1),(2,0))';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;polygon &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------------------</font></div><div><font size="2"   >&nbsp;((0,0),(1,1),(2,0))</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div style="font-size: medium;"   >polygon转换成cstring</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select poly_out(polygon '((0,0),(1,1),(2,0))');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; poly_out &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------------------</font></div><div><font size="2"   >&nbsp;((0,0),(1,1),(2,0))</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div style="font-size: medium;"   >cstring转化成text</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select textin(poly_out(polygon '((0,0),(1,1),(2,0))'));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;textin &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------------------</font></div><div><font size="2"   >&nbsp;((0,0),(1,1),(2,0))</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div style="font-size: medium;"   >替换cstring表述中的最外面的一组小括号为大括号</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select regexp_replace(textin(poly_out(polygon '((0,0),(1,1),(2,0))')), '^\((.*)\)$', '{\1}');</font></div><div><font size="2"   >&nbsp; &nbsp;regexp_replace &nbsp; &nbsp;</font></div><div><font size="2"   >---------------------</font></div><div><font size="2"   >&nbsp;{(0,0),(1,1),(2,0)}</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div style="font-size: medium;"   >替换所有(为"(</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select regexp_replace(regexp_replace(textin(poly_out(polygon '((0,0),(1,1),(2,0))')), '^\((.*)\)$', '{\1}'), '\(', '"(', 'g');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;regexp_replace &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------------</font></div><div><font size="2"   >&nbsp;{"(0,0),"(1,1),"(2,0)}</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div style="font-size: medium;"   ><span style="line-height: 28px;"   >替换所有)为)", 变成规范的point[]格式.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select regexp_replace(regexp_replace(regexp_replace(textin(poly_out(polygon '((0,0),(1,1),(2,0))')), '^\((.*)\)$', '{\1}'), '\(', '"(', 'g'), '\)', ')"', 'g');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; regexp_replace &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------------------------</font></div><div><font size="2"   >&nbsp;{"(0,0)","(1,1)","(2,0)"}</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div style="font-size: medium;"   ><br></div></div><div><font size="3"   >[参考]</font></div><div><font size="3"   >1.&nbsp;<span style="line-height: 28px;"   >src/backend/utils/adt/geo_ops.c</span></font></div><div><span style="line-height: 28px;"   ><font size="3"   >2.&nbsp;</font></span><a style="font-size: 16px; line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/functions-geometry.html"   >http://www.postgresql.org/docs/devel/static/functions-geometry.html</a></div><div><font size="3"   ><br></font></div><div><p><br></p><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL extract points in polygon  path type - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>