<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.4 New Feature - Improve scalability of WAL insertions</h2>
	<h5 id="">2014-05-06 9:26:24&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020144684950776/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL 9.4正在紧锣密鼓的发布中, 这几天git.postgresql.org满是9.4发布前奏的commit.</div><div>9.4的release note中提到了大量9.4相关的新特性, 升级注意事项, 兼容性注意事项, 性能改进, 新增的模块等.</div><div>不过大部分介绍过于简单, 为了更好的帮助大家了解9.4的新特性, 我接下来会对其中的特性进行整理, 找到对应的代码提交信息和手册部分的信息, 帮助大家消化理解. 大家有什么需要的话也可以直接回帖或给我发邮件.</div><div>本文要说的这个特性是Heikki Linnakangas提交的, 关于WAL文件的并行插入的一个特性, 方法是通过增加wal的insert slot, 使得多个backend可以并行的像wal写数据, 增加了高并发下WAL的写速度, 从而提升写的TPS.</div><div>同时这个补丁还有一项改进, 在用户使用pg_switch_xlog()切换日志时, 自动填充0到未写满的xlog文件末尾. 那么后期不需要再使用pg_clearxlogtail工具来维护wal文件.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Improve scalability of WAL insertions.</font></div><div><font size="2"   >author<span>	</span>Heikki Linnakangas &lt;heikki.linnakangas@iki.fi&gt;<span>	</span></font></div><div><font size="2"   >Mon, 8 Jul 2013 08:23:56 +0000 (11:23 +0300)</font></div><div><font size="2"   >committer<span>	</span>Heikki Linnakangas &lt;heikki.linnakangas@iki.fi&gt;<span>	</span></font></div><div><font size="2"   >Mon, 8 Jul 2013 08:23:56 +0000 (11:23 +0300)</font></div><div><font size="2"   >commit<span>	</span>9a20a9b21baa819df1760b36f3c36f25d11fc27b</font></div><div><font size="2"   >tree<span>	</span>d4990fa07af24d6d9544ff5e1b7e4edfb5dd6c12<span>	</span>tree | snapshot</font></div><div><font size="2"   >parent<span>	</span>5372275b4b5fc183c6c6dd4517cfd74d5b641446<span>	</span>commit | diff</font></div><div><font size="2"   >Improve scalability of WAL insertions.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >This patch replaces WALInsertLock with a number of WAL insertion slots,</font></div><div><font size="2"   >allowing multiple backends to insert WAL records to the WAL buffers</font></div><div><font size="2"   >concurrently. This is particularly useful for parallel loading large amounts</font></div><div><font size="2"   >of data on a system with many CPUs.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >This has one user-visible change: switching to a new WAL segment with</font></div><div><font size="2"   >pg_switch_xlog() now fills the remaining unused portion of the segment with</font></div><div><font size="2"   >zeros. This potentially adds some overhead, but it has been a very common</font></div><div><font size="2"   >practice by DBA's to clear the "tail" of the segment with an external</font></div><div><font size="2"   >pg_clearxlogtail utility anyway, to make the WAL files compress better.</font></div><div><font size="2"   >With this patch, it's no longer necessary to do that.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >This patch adds a new GUC, xloginsert_slots, to tune the number of WAL</font></div><div><font size="2"   >insertion slots. Performance testing suggests that the default, 8, works</font></div><div><font size="2"   >pretty well for all kinds of worklods, but I left the GUC in place to allow</font></div><div><font size="2"   >others with different hardware to test that easily. We might want to remove</font></div><div><font size="2"   >that before release.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Reviewed by Andres Freund.</font></div><p></p></pre></div><div>后来slot改成了lock.</div><div><a target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=68a2e52bbaf98f136a96b3a0d734ca52ca440a95"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=68a2e52bbaf98f136a96b3a0d734ca52ca440a95</a></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Replace the XLogInsert slots with regular LWLocks.</font></div><div><font size="2"   >author<span>	</span>Heikki Linnakangas &lt;heikki.linnakangas@iki.fi&gt;<span>	</span></font></div><div><font size="2"   >Fri, 21 Mar 2014 14:06:08 +0000 (15:06 +0100)</font></div><div><font size="2"   >committer<span>	</span>Heikki Linnakangas &lt;heikki.linnakangas@iki.fi&gt;<span>	</span></font></div><div><font size="2"   >Fri, 21 Mar 2014 14:10:48 +0000 (15:10 +0100)</font></div><div><font size="2"   >commit<span>	</span>68a2e52bbaf98f136a96b3a0d734ca52ca440a95</font></div><div><font size="2"   >tree<span>	</span>bf1d45f3055d659e9df2f1c023ede044078cdb21<span>	</span>tree | snapshot</font></div><div><font size="2"   >parent<span>	</span>af930e606a3217db3909029c6c3f8d003ba70920<span>	</span>commit | diff</font></div><div><font size="2"   >Replace the XLogInsert slots with regular LWLocks.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The special feature the XLogInsert slots had over regular LWLocks is the</font></div><div><font size="2"   >insertingAt value that was updated atomically with releasing backends</font></div><div><font size="2"   >waiting on it. Add new functions to the LWLock API to do that, and replace</font></div><div><font size="2"   >the slots with LWLocks. This reduces the amount of duplicated code.</font></div><div><font size="2"   >(There's still some duplication, but at least it's all in lwlock.c now.)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Reviewed by Andres Freund.</font></div><p></p></pre></div><div>对应的配置项 :&nbsp;</div><div>src/backend/utils/misc/guc.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {"xloginsert_locks", PGC_POSTMASTER, WAL_SETTINGS,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; gettext_noop("Sets the number of locks used for concurrent xlog insertions."),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NULL,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GUC_NOT_IN_SAMPLE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;num_xloginsert_locks,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8, 1, 1000,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NULL, NULL, NULL</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; },</font></div><p></p></pre></div><div>这个参数是一个隐含的参数, 所以并没有放在postgresql.conf中.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >src/include/access/xlog.h:extern int &nbsp; &nbsp;num_xloginsert_locks;</font></div><div><font size="2"   >src/backend/access/transam/xlog.c:int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; num_xloginsert_locks = 8;</font></div><div><font size="2"   >src/backend/access/transam/xlog.c: &nbsp; &nbsp; &nbsp; * determined by the num_xloginsert_locks GUC. When an inserter crosses a</font></div><div><font size="2"   >src/backend/access/transam/xlog.c: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lockToTry = MyProc-&gt;pgprocno % num_xloginsert_locks;</font></div><div><font size="2"   >src/backend/access/transam/xlog.c: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lockToTry = (lockToTry + 1) % num_xloginsert_locks;</font></div><div><font size="2"   >src/backend/access/transam/xlog.c: &nbsp; &nbsp; &nbsp;for (i = 0; i &lt; num_xloginsert_locks - 1; i++)</font></div><div><font size="2"   >src/backend/access/transam/xlog.c: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;for (i = 0; i &lt; num_xloginsert_locks; i++)</font></div><div><font size="2"   >src/backend/access/transam/xlog.c: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;LWLockUpdateVar(&amp;WALInsertLocks[num_xloginsert_locks - 1].l.lock,</font></div><div><font size="2"   >src/backend/access/transam/xlog.c: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&amp;WALInsertLocks[num_xloginsert_locks - 1].l.insertingAt,</font></div><div><font size="2"   >src/backend/access/transam/xlog.c: &nbsp; &nbsp; &nbsp;for (i = 0; i &lt; num_xloginsert_locks; i++)</font></div><div><font size="2"   >src/backend/access/transam/xlog.c: &nbsp; &nbsp; &nbsp;size = add_size(size, mul_size(sizeof(WALInsertLockPadded), num_xloginsert_locks + 1));</font></div><div><font size="2"   >src/backend/access/transam/xlog.c: &nbsp; &nbsp; &nbsp;allocptr += sizeof(WALInsertLockPadded) * num_xloginsert_locks;</font></div><div><font size="2"   >src/backend/access/transam/xlog.c: &nbsp; &nbsp; &nbsp;for (i = 0; i &lt; num_xloginsert_locks; i++)</font></div><div><font size="2"   >Binary file src/backend/access/transam/xlog.o matches</font></div><div><font size="2"   >Binary file src/backend/postgres matches</font></div><div><font size="2"   >src/backend/utils/misc/guc.c: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {"xloginsert_locks", PGC_POSTMASTER, WAL_SETTINGS,</font></div><div><font size="2"   >src/backend/utils/misc/guc.c: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &amp;num_xloginsert_locks,</font></div><p></p></pre></div><div><br></div><div>接下来测试一下, 首先我们下载一个最新的镜像.</div><div><a target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=snapshot;h=14ea89366fe321609afc5838ff9fe2ded1cd707d;sf=tgz"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=snapshot;h=14ea89366fe321609afc5838ff9fe2ded1cd707d;sf=tgz</a></div><div>安装 :&nbsp;</div><div><p></p><div><pre class="prettyprint"   ><div><font size="2"   ><span style="line-height: 22.75px;"   ># tar -zxvf postgresql-14ea893.tar.gz</span></font></div><div><font size="2"   ><span style="line-height: 22.75px;"   ># cd postgresql-14ea893</span></font></div><div><font size="2"   ><span style="line-height: 22.75px;"   ># ./configure --prefix=/home/pg94/pgsql9.4devel --with-pgport=1933 --with-perl --with-tcl --with-python --with-openssl --with-pam --without-ldap --with-libxml --with-libxslt --enable-thread-safety --enable-dtrace --enable-debug &amp;&amp; gmake &amp;&amp; gmake install</span></font></div><div><font size="2"   ><span style="line-height: 22.75px;"   >[root@db-172-16-3-150 postgresql-14ea893]# cd contrib/</span></font></div><div><font size="2"   ><span style="line-height: 22.75px;"   >[root@db-172-16-3-150 contrib]# make &amp;&amp; make install</span></font></div><div><font size="2"   ><span style="line-height: 22.75px;"   ># su - pg94</span></font></div><div><font size="2"   ><span style="line-height: 22.75px;"   >$ initdb -D $PGDATA -E UTF8 --locale=C -U postgres -W</span></font></div><div><font size="2"   ><span style="line-height: 22.75px;"   >$ cd $PGDATA</span></font></div><div><font size="2"   ><span style="line-height: 22.75px;"   >$ vi postgresql.conf</span></font></div><div><font size="2"   ><span style="line-height: 22.75px;"   >listen_addresses = '0.0.0.0'</span></font></div><div><font size="2"   ><span style="line-height: 22.75px;"   >unix_socket_directories = '.'</span></font></div><div><font size="2"   ><span style="line-height: 22.75px;"   >log_destination = 'csvlog'</span></font></div><div><font size="2"   ><span style="line-height: 22.75px;"   >logging_collector = on</span></font></div><div><font size="2"   ><span style="line-height: 22.75px;"   >log_truncate_on_rotation = on</span></font></div><div><font size="2"   >shared_buffers = 2048MB</font></div><div><font size="2"   >checkpoint_segments = 128</font></div><div><font size="2"   ><span style="line-height: 22.75px;"   ><br></span></font></div><div><font size="2"   ><span style="line-height: 22.75px;"   >$ pg_ctl start</span></font></div><p></p></pre></div><p></p></div><div>默认的xloginsert_locks是8, 如果要修改的话, 可以在postgresql.conf中追加.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi postgresql.conf</font></div><div><font size="2"   >xloginsert_locks = 16</font></div><div><font size="2"   >-- 然后重启数据库.</font></div><div><div><font size="2"   >pg94@db-172-16-3-150-&gt; psql</font></div><div><font size="2"   >psql (9.4devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# show xloginsert_locks;</font></div><div><font size="2"   >&nbsp;xloginsert_locks&nbsp;</font></div><div><font size="2"   >------------------</font></div><div><font size="2"   >&nbsp;16</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>我们来测试一下并发分别为16, 96的时候, 不同的xloginsert_locks的性能区别.</div><div>xloginsert_locks = 16</div><div><pre class="prettyprint"   ><div><div><font size="2"   >pg94@db-172-16-3-150-&gt; psql</font></div><div><font size="2"   >psql (9.4devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# create table test(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >pg94@db-172-16-3-150-&gt; vi test.sql</font></div><div><font size="2"   >insert into test values (1);</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >pg94@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 16 -j 4 -T 30</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 543243</font></div><div><font size="2"   >latency average: 0.884 ms</font></div><div><font size="2"   >tps = 18106.626121 (including connections establishing)</font></div><div><font size="2"   >tps = 18113.859453 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.881253 &nbsp; &nbsp; &nbsp; &nbsp;insert into test values (1);</font></div></div><div><font size="2"   >pg94@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 96 -j 4 -T 30<br>transaction type: Custom query<br>scaling factor: 1<br>query mode: prepared<br>number of clients: 96<br>number of threads: 4<br>duration: 30 s<br>number of transactions actually processed: 1301440<br>latency average: 2.213 ms<br>tps = 43361.713603 (including connections establishing)<br>tps = 43448.296572 (excluding connections establishing)<br>statement latencies in milliseconds:<br>        2.205792        insert into test values (1);</font></div><p></p></pre></div><div><br></div><div>xloginsert_locks = 8</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg94@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 16 -j 4 -T 30</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 547108</font></div><div><font size="2"   >latency average: 0.877 ms</font></div><div><font size="2"   >tps = 18234.757319 (including connections establishing)</font></div><div><font size="2"   >tps = 18241.764817 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.875033 &nbsp; &nbsp; &nbsp; &nbsp;insert into test values (1);</font></div><div><font size="2"   >pg94@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 96 -j 4 -T 30<br>transaction type: Custom query<br>scaling factor: 1<br>query mode: prepared<br>number of clients: 96<br>number of threads: 4<br>duration: 30 s<br>number of transactions actually processed: 1395674<br>latency average: 2.064 ms<br>tps = 46495.319599 (including connections establishing)<br>tps = 46589.876394 (excluding connections establishing)<br>statement latencies in milliseconds:<br>        2.056935        insert into test values (1);</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >xloginsert_locks = 1</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg94@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 16 -j 4 -T 30</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 30 s</font></div><div><font size="2"   >number of transactions actually processed: 545997</font></div><div><font size="2"   >latency average: 0.879 ms</font></div><div><font size="2"   >tps = 18198.777135 (including connections establishing)</font></div><div><font size="2"   >tps = 18206.206934 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.876758 &nbsp; &nbsp; &nbsp; &nbsp;insert into test values (1);</font></div><div><font size="2"   >pg94@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 96 -j 4 -T 30<br>transaction type: Custom query<br>scaling factor: 1<br>query mode: prepared<br>number of clients: 96<br>number of threads: 4<br>duration: 30 s<br>number of transactions actually processed: 1379191<br>latency average: 2.088 ms<br>tps = 45948.152409 (including connections establishing)<br>tps = 46039.888239 (excluding connections establishing)<br>statement latencies in milliseconds:<br>        2.081494        insert into test values (1);</font></div><p></p></pre></div><div><br></div><div>实际测试结果并没有太大的改进, 显然瓶颈没有出现在xlog buffer insert层面, 所以看不到改进.</div><div>已经和heikki.linnakangas@iki.fi联系. 得到的回复是在单条SQL产生的xlog比较多时会有较大提升. (copy除外)</div><div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >COPY contains a more specialized optimization to reduce XLogInsert&nbsp;</font></div><div><font size="2"   >contention, where it inserts all rows that fit on the heap page as a&nbsp;</font></div><div><font size="2"   >single WAL-logged operation. IOW, copy only creates one WAL record per&nbsp;</font></div><div><font size="2"   >page, not one per record. So copy rarely gets bottlenecked on WAL&nbsp;</font></div><div><font size="2"   >insertions (since version 9.2, where the optimization was added).</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >The optimization in COPY does not apply, if the table contains any&nbsp;</font></div><div><font size="2"   >per-row triggers, or volatile DEFAULT expression, though. So you could&nbsp;</font></div><div><font size="2"   >try creating the table e.g. like "CREATE TABLE test (id int4, ts&nbsp;</font></div><div><font size="2"   >timestamp default clock_timestamp())".</font></div></div><div></div><p></p></pre></div></div><div><br></div><div>以下SQL一次插入10万条记录, 这样的话有了明显的提升.</div><div>xloginsert_locks = 1</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg94@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 16 -j 4 -t 3</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >number of transactions per client: 3</font></div><div><font size="2"   >number of transactions actually processed: 48/48</font></div><div><font size="2"   >latency average: 0.000 ms</font></div><div><font size="2"   >tps = 6.431977 (including connections establishing)</font></div><div><font size="2"   >tps = 6.441740 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 2393.804062 &nbsp; &nbsp; insert into test select generate_series(1,100000);</font></div><p></p></pre></div><div>xloginsert_locks = 16</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg94@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 16 -j 4 -t 3</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >number of transactions per client: 3</font></div><div><font size="2"   >number of transactions actually processed: 48/48</font></div><div><font size="2"   >latency average: 0.000 ms</font></div><div><font size="2"   >tps = 13.386877 (including connections establishing)</font></div><div><font size="2"   >tps = 13.429989 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1156.441188 &nbsp; &nbsp; insert into test select generate_series(1,100000);</font></div><p></p></pre></div><div><br></div><div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >批量导入的测试, 首先排除heap page extended lock的影响后的测试结果, 有些许的性能提升, 原因</span><span style="line-height: 28px;"   >heikki已说明, 见上面</span><span style="line-height: 28px;"   >&nbsp;:&nbsp;</span></div></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# select ctid from test order by ctid desc limit 1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;ctid &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >--------------</font></div><div><font size="2"   >&nbsp;(1488286,73)</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# delete from test where ctid&lt;&gt;'(1488286,73)';</font></div></div><div><div style="line-height: 28px;"   ><font size="2"   >DELETE 336350639</font></div></div><div><font size="2"   >digoal=# vacuum analyze test;</font></div><div><div><font size="2"   >VACUUM</font></div><div><div><font size="2"   >digoal=# \dt+ test</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of relations</font></div><div><font size="2"   >&nbsp;Schema | Name | Type &nbsp;| &nbsp;Owner &nbsp; | Size &nbsp;| Description&nbsp;</font></div><div><font size="2"   >--------+------+-------+----------+-------+-------------</font></div><div><font size="2"   >&nbsp;public | test | table | postgres | 11 GB |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   >digoal=# checkpoint;</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >xloginsert_locks = 16</font></div><div><div><font size="2"   >pg94@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 16 -j 4 -t 3</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >number of transactions per client: 3</font></div><div><font size="2"   >number of transactions actually processed: 48/48</font></div><div><font size="2"   >latency average: 0.000 ms</font></div><div><font size="2"   >tps = 0.673150 (including connections establishing)</font></div><div><font size="2"   >tps = 0.673258 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 23648.140604 &nbsp; &nbsp;copy test from '/home/pg94/test.dmp';</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >xloginsert_locks = 1</font></div><div><div><font size="2"   >pg94@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 16 -j 4 -t 3</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >number of transactions per client: 3</font></div><div><font size="2"   >number of transactions actually processed: 48/48</font></div><div><font size="2"   >latency average: 0.000 ms</font></div><div><font size="2"   >tps = 0.646814 (including connections establishing)</font></div><div><font size="2"   >tps = 0.646913 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 24672.854896 &nbsp; &nbsp;copy test from '/home/pg94/test.dmp';</font></div></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=9a20a9b21baa819df1760b36f3c36f25d11fc27b"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=9a20a9b21baa819df1760b36f3c36f25d11fc27b</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=68a2e52bbaf98f136a96b3a0d734ca52ca440a95"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=68a2e52bbaf98f136a96b3a0d734ca52ca440a95</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/release-9-4.html"   >http://www.postgresql.org/docs/devel/static/release-9-4.html</a></div><div>4.&nbsp;src/backend/utils/misc/guc.c</div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL 9.4 New Feature - Improve scalability of WAL insertions - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>