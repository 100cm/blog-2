<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Pgbouncer add client host & port info to application_name which can identify clients</h2>
	<h5 id="">2014-05-04 9:04:17&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402014448153222/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>使用过pgbouncer的朋友应该知道, 在数据库端看到的client_addr和client_port是pgbouncer服务器的addr和port, 所以使用这个连接池后, 就无法判别真正的客户端和端口是啥了.</div><div>现在pgbouncer为了弥补这个缺陷, 将客户端的IP和端口信息写到了application_name这个连接变量中.</div><div>具体的代码见</div><div><a target="_blank" rel="nofollow" href="https://github.com/pgexperts/pgbouncer-dev/commit/ac9842870517f8c4e4a915fe6b3ccadbcdbdea03"   >https://github.com/pgexperts/pgbouncer-dev/commit/ac9842870517f8c4e4a915fe6b3ccadbcdbdea03</a></div><div><br></div><div>这部分功能目前没有提交到主master分支, 所以使用以下方法下载的代码中不包含这部分更新.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#&nbsp;yum install -y autoconf automake asciidoc xmlto libtool</font></div><div><font size="2"   ># git clone https://github.com/pgexperts/pgbouncer-dev/</font></div><div><font size="2"   ># cd&nbsp;<span style="line-height: 28px;"   >pgbouncer-dev</span></font></div><div><font size="2"   ><span style="line-height: 28px;"   ># git clone&nbsp;</span>https://github.com/markokr/libusual</font></div><div><font size="2"   ># rm -rf lib</font></div><div><font size="2"   ># mv&nbsp;<span style="line-height: 28px;"   >libusual lib</span></font></div><div><font size="2"   ><span style="line-height: 28px;"   >#&nbsp;</span>./autogen.sh</font></div><div><font size="2"   ># ./configure --prefix=/opt/pgbouncer-dev</font></div><div><font size="2"   ># make</font></div><div><font size="2"   ># make install</font></div><p></p></pre></div><div>请使用以下方法下载和安装 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># git clone https://github.com/pgexperts/pgbouncer-dev/archive/appname-hostport.zip</font></div><div><font size="2"   ># unzip appname-hostport.zip</font></div><div><font size="2"   >#&nbsp;cd pgbouncer-dev-appname-hostport/</font></div><div><div style="line-height: 28px;"   ><font size="2"   ><span style="line-height: 28px;"   ># git clone&nbsp;</span>https://github.com/markokr/libusual</font></div><div style="line-height: 28px;"   ><font size="2"   ># rm -rf lib</font></div><div style="line-height: 28px;"   ><font size="2"   ># mv&nbsp;<span style="line-height: 28px;"   >libusual lib</span></font></div><div style="line-height: 28px;"   ><font size="2"   ><span style="line-height: 28px;"   >#&nbsp;</span>./autogen.sh</font></div><div style="line-height: 28px;"   ><font size="2"   ># ./configure --prefix=/opt/pgbouncer-dev</font></div><div style="line-height: 28px;"   ><font size="2"   ># make</font></div><div style="line-height: 28px;"   ><font size="2"   ># make install</font></div></div><p></p></pre></div><div style="line-height: 28px;"   ><br></div><div>配置 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># mkdir /opt/pgbouncer-dev/etc</font></div><div><font size="2"   ># cd&nbsp;<span style="line-height: 28px;"   >/opt/pgbouncer-dev/etc</span></font></div><div><font size="2"   ><span style="line-height: 28px;"   ># vi&nbsp;</span>config.ini</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[databases]</font></div><div><font size="2"   >aliasdb1 = host=172.16.3.33 port=5432 dbname=digoal pool_size=20</font></div><div><font size="2"   >[pgbouncer]</font></div><div><font size="2"   >pool_mode = transaction</font></div><div><font size="2"   >listen_port = 6543</font></div><div><font size="2"   >listen_addr = 0.0.0.0</font></div><div><font size="2"   >application_name_add_host = 1</font></div><div><font size="2"   >auth_type = md5</font></div><div><font size="2"   >auth_file = /opt/pgbouncer-dev/etc/users.txt</font></div><div><font size="2"   >logfile = /opt/pgbouncer-dev/etc/pgbouncer.log</font></div><div><font size="2"   >pidfile = /opt/pgbouncer-dev/etc/pgbouncer.pid</font></div><div><font size="2"   >unix_socket_dir = /opt/pgbouncer-dev/etc</font></div><div><font size="2"   >admin_users = pgadmin</font></div><div><font size="2"   >stats_users = pgmon</font></div><div><font size="2"   >server_reset_query = DISCARD ALL</font></div><div><font size="2"   >server_reset_query =&nbsp;</font></div><div><font size="2"   >server_check_query = select 1</font></div><div><font size="2"   >server_check_delay = 30</font></div><div><font size="2"   >max_client_conn = 50000</font></div><div><font size="2"   >default_pool_size = 20</font></div><div><font size="2"   >reserve_pool_size = 5</font></div><div><font size="2"   >dns_max_ttl = 15</font></div></div><p></p></pre></div><div>配置用户 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >172.16.3.33 :&nbsp;</font></div><div><div><font size="2"   >postgres=# select usename,passwd from pg_shadow where usename='digoal';</font></div><div><font size="2"   >&nbsp;usename | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; passwd &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------+-------------------------------------</font></div><div><font size="2"   >&nbsp;digoal &nbsp;| md5462f71c79368ccf422f8a773ef40074d</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   ># vi&nbsp;users.txt</font></div><div><div><font size="2"   >"pgadmin" "321admin"</font></div><div><font size="2"   >"pgmon" "hello1888"</font></div><div><font size="2"   >"digoal" "md5462f71c79368ccf422f8a773ef40074d"</font></div></div><p></p></pre></div><div>启动 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># chmod 400 users.txt</font></div><div><font size="2"   ># chown -R pg93:pg93 /opt/pgbouncer-dev</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># /opt/pgbouncer-dev/bin/pgbouncer -d -v -u pg93 ./config.ini</font></div><div><div><font size="2"   >[root@db-172-16-3-150 etc]# ps -ewf|grep pgbouncer</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; 11388 &nbsp; &nbsp; 1 &nbsp;0 08:38 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 /opt/pgbouncer-dev/bin/pgbouncer -d -v -u pg93 ./config.ini</font></div></div><p></p></pre></div><div><div>测试, 连接前制定的application_name被保留, 在末尾添加IP和端口信息, 注意这个IP和端口是pgbouncer主机看到的IP和端口, 如果pgbouncer和应用程序放在一台主机的话, 并且连接的是回环地址的话看到的是127.0.0.1. 如下<span style="line-height: 28px;"   >&nbsp;:&nbsp;</span></div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 etc]# su - pg93</font></div><div><div><font size="2"   >pg93@db-172-16-3-150-&gt; psql -h 127.0.0.1 -p 6543 -U digoal aliasdb1</font></div><div><font size="2"   >Password for user digoal:&nbsp;</font></div><div><font size="2"   >psql (9.3.3, server 9.3.2)</font></div><div><font size="2"   >Type "help" for help.</font></div></div><div><div><font size="2"   >aliasdb1=&gt; select * from pg_stat_activity where pid = pg_backend_pid();</font></div><div><font size="2"   >-[ RECORD 1 ]----+-------------------------------------------------------------</font></div><div><font size="2"   >datid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 16404</font></div><div><font size="2"   >datname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| digoal</font></div><div><font size="2"   >pid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 12291</font></div><div><font size="2"   >usesysid &nbsp; &nbsp; &nbsp; &nbsp; | 16405</font></div><div><font size="2"   >usename &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| digoal</font></div><div><font size="2"   >application_name | psql (127.0.0.1:39356)  -- 这个是pgbouncer看到的applicatoin server的ip和端口</font></div><div><font size="2"   >client_addr &nbsp; &nbsp; &nbsp;| 172.16.3.150  -- 这是数据库服务器看到的pgbouncer的IP</font></div><div><font size="2"   >client_hostname &nbsp;|&nbsp;</font></div><div><font size="2"   >client_port &nbsp; &nbsp; &nbsp;| 14195</font></div><div><font size="2"   >backend_start &nbsp; &nbsp;| 2014-05-04 09:01:10.27208+08</font></div><div><font size="2"   >xact_start &nbsp; &nbsp; &nbsp; | 2014-05-04 09:01:12.472866+08</font></div><div><font size="2"   >query_start &nbsp; &nbsp; &nbsp;| 2014-05-04 09:01:12.472866+08</font></div><div><font size="2"   >state_change &nbsp; &nbsp; | 2014-05-04 09:01:12.472867+08</font></div><div><font size="2"   >waiting &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f</font></div><div><font size="2"   >state &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| active</font></div><div><font size="2"   >query &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| select * from pg_stat_activity where pid = pg_backend_pid();</font></div></div><p></p></pre></div><div>不使用回环地址连接, 看到的是正常的IP :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; psql -h 172.16.3.150 -p 6543 -U digoal aliasdb1</font></div><div><font size="2"   >Password for user digoal:&nbsp;</font></div><div><font size="2"   >psql (9.3.3, server 9.3.2)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >aliasdb1=&gt; \x</font></div><div><font size="2"   >Expanded display is on.</font></div><div><font size="2"   >aliasdb1=&gt; select * from pg_stat_activity where pid = pg_backend_pid();</font></div><div><font size="2"   >-[ RECORD 1 ]----+-------------------------------------------------------------</font></div><div><font size="2"   >datid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 16404</font></div><div><font size="2"   >datname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| digoal</font></div><div><font size="2"   >pid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 12291</font></div><div><font size="2"   >usesysid &nbsp; &nbsp; &nbsp; &nbsp; | 16405</font></div><div><font size="2"   >usename &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| digoal</font></div><div><font size="2"   >application_name | psql (172.16.3.150:33013)</font></div><div><font size="2"   >client_addr &nbsp; &nbsp; &nbsp;| 172.16.3.150</font></div><div><font size="2"   >client_hostname &nbsp;|&nbsp;</font></div><div><font size="2"   >client_port &nbsp; &nbsp; &nbsp;| 14195</font></div><div><font size="2"   >backend_start &nbsp; &nbsp;| 2014-05-04 09:01:10.27208+08</font></div><div><font size="2"   >xact_start &nbsp; &nbsp; &nbsp; | 2014-05-04 09:06:03.677831+08</font></div><div><font size="2"   >query_start &nbsp; &nbsp; &nbsp;| 2014-05-04 09:06:03.677831+08</font></div><div><font size="2"   >state_change &nbsp; &nbsp; | 2014-05-04 09:06:03.677832+08</font></div><div><font size="2"   >waiting &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f</font></div><div><font size="2"   >state &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| active</font></div><div><font size="2"   >query &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| select * from pg_stat_activity where pid = pg_backend_pid();</font></div><p></p></pre></div><div><br></div><div>连接后, 会话中设置的application_name将覆盖pgbouncer自定义的application_name :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >aliasdb1=&gt; set application_name='test';</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >aliasdb1=&gt; select * from pg_stat_activity where pid = pg_backend_pid();</font></div><div><font size="2"   >-[ RECORD 1 ]----+-------------------------------------------------------------</font></div><div><font size="2"   >datid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 16404</font></div><div><font size="2"   >datname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| digoal</font></div><div><font size="2"   >pid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 12291</font></div><div><font size="2"   >usesysid &nbsp; &nbsp; &nbsp; &nbsp; | 16405</font></div><div><font size="2"   >usename &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| digoal</font></div><div><font size="2"   >application_name | test</font></div><div><font size="2"   >client_addr &nbsp; &nbsp; &nbsp;| 172.16.3.150</font></div><div><font size="2"   >client_hostname &nbsp;|&nbsp;</font></div><div><font size="2"   >client_port &nbsp; &nbsp; &nbsp;| 14195</font></div><div><font size="2"   >backend_start &nbsp; &nbsp;| 2014-05-04 09:01:10.27208+08</font></div><div><font size="2"   >xact_start &nbsp; &nbsp; &nbsp; | 2014-05-04 09:01:51.068359+08</font></div><div><font size="2"   >query_start &nbsp; &nbsp; &nbsp;| 2014-05-04 09:01:51.068359+08</font></div><div><font size="2"   >state_change &nbsp; &nbsp; | 2014-05-04 09:01:51.06836+08</font></div><div><font size="2"   >waiting &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f</font></div><div><font size="2"   >state &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| active</font></div><div><font size="2"   >query &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| select * from pg_stat_activity where pid = pg_backend_pid();</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://github.com/pgexperts/pgbouncer-dev/commit/ac9842870517f8c4e4a915fe6b3ccadbcdbdea03"   >https://github.com/pgexperts/pgbouncer-dev/commit/ac9842870517f8c4e4a915fe6b3ccadbcdbdea03</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://wiki.postgresql.org/wiki/PgBouncer"   >http://wiki.postgresql.org/wiki/PgBouncer</a></div><div><p><br></p><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="Pgbouncer add client host  port info to application_name which can identify clients - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>