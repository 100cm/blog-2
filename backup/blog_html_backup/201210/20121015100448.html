<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.3 change pg_resetxlog and XLogFileName funtion</h2>
	<h5 id="">2012-10-15 10:04:48&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020129159590908/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>前面一篇BLOG的例子中有用到pg_resetxlog来修改控制文件中对于XLOG的信息, 决定下<span style="line-height: 22px;"  >minimum WAL starting location</span>. 例子用到的是PostgreSQL 9.1的版本.</div><div>修改的值包含TLI, LOG, SEG三部分信息. 如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db-192-168-xxx-xxx-&gt; pg_resetxlog --help</font></div><div><font size="2"  >pg_resetxlog resets the PostgreSQL transaction log.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Usage:</font></div><div><font size="2"  >&nbsp; pg_resetxlog [OPTION]... DATADIR</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Options:</font></div><div><font size="2"  >&nbsp; -e XIDEPOCH &nbsp; &nbsp; set next transaction ID epoch</font></div><div><font size="2"  >&nbsp; -f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;force update to be done</font></div><div><font size="2"  >&nbsp; -l TLI,FILE,SEG force minimum WAL starting location for new transaction log</font></div><div><font size="2"  >&nbsp; -m XID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;set next multitransaction ID</font></div><div><font size="2"  >&nbsp; -n &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;no update, just show extracted control values (for testing)</font></div><div><font size="2"  >&nbsp; -o OID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;set next OID</font></div><div><font size="2"  >&nbsp; -O OFFSET &nbsp; &nbsp; &nbsp; set next multitransaction offset</font></div><div><font size="2"  >&nbsp; -x XID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;set next transaction ID</font></div><div><font size="2"  >&nbsp; --help &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;show this help, then exit</font></div><div><font size="2"  >&nbsp; --version &nbsp; &nbsp; &nbsp; output version information, then exit</font></div><div><font size="2"  >Report bugs to &lt;pgsql-bugs@postgresql.org&gt;.</font></div><p></p></pre></div><div><br></div><div>这个在PostgreSQL 9.3中已经有了修改, 如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pgdev@db-172-16-3-150-&gt; pg_resetxlog --help</font></div><div><font size="2"  >pg_resetxlog resets the PostgreSQL transaction log.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Usage:</font></div><div><font size="2"  >&nbsp; pg_resetxlog [OPTION]... DATADIR</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Options:</font></div><div><font size="2"  >&nbsp; -e XIDEPOCH &nbsp; &nbsp; &nbsp;set next transaction ID epoch</font></div><div><font size="2"  >&nbsp; -f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; force update to be done</font></div><div><font size="2"  >&nbsp; -l xlogfile &nbsp; &nbsp; &nbsp;force minimum WAL starting location for new transaction log</font></div><div><font size="2"  >&nbsp; -m XID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set next multitransaction ID</font></div><div><font size="2"  >&nbsp; -n &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; no update, just show extracted control values (for testing)</font></div><div><font size="2"  >&nbsp; -o OID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set next OID</font></div><div><font size="2"  >&nbsp; -O OFFSET &nbsp; &nbsp; &nbsp; &nbsp;set next multitransaction offset</font></div><div><font size="2"  >&nbsp; -V, --version &nbsp; &nbsp;output version information, then exit</font></div><div><font size="2"  >&nbsp; -x XID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; set next transaction ID</font></div><div><font size="2"  >&nbsp; -?, --help &nbsp; &nbsp; &nbsp; show this help, then exit</font></div><div><font size="2"  >Report bugs to &lt;pgsql-bugs@postgresql.org&gt;.</font></div><p></p></pre></div><div><br></div><div>同时XLogFileName函数, PostgreSQL 9.3的版本也有了改进, 以前的版本SEG的最大值比较别扭, 居然是((2 ^ n) -2).&nbsp;</div><div>新版本已经改成了((2 ^ n) - 1) .</div><div>如下 :&nbsp;</div><div>老版本的信息 : 64MB的wal_segment_size, SEG最大是0x3E = 64 - 2 .</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >-rw------- 1 postgres postgres &nbsp;64M Oct 14 13:20 000000020000180E0000003E</font></div><div><font size="2"  >-rw------- 1 postgres postgres &nbsp;64M Oct 14 13:13 000000020000180F00000000</font></div><p></p></pre></div><div><pre class="prettyprint"  ><p></p><div><span style="line-height: 19px;"  ><font size="2"  >src/include/access/xlog_internal.h</font></span></div><div><font size="2"  >/*</font></div><div><font size="2"  >&nbsp;* These macros encapsulate knowledge about the exact layout of XLog file</font></div><div><font size="2"  >&nbsp;* names, timeline history file names, and archive-status file names.</font></div><div><font size="2"  >&nbsp;*/</font></div><div><font size="2"  >#define MAXFNAMELEN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 64</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >#define XLogFileName(fname, tli, log, seg) &nbsp; &nbsp; &nbsp;\</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; snprintf(fname, MAXFNAMELEN, "%08X%08X%08X", tli, log, seg)</font></div><p></p></pre></div><div>新版本改进后 :&nbsp;<span style="line-height: 22px;"  >16MB的wal_segment_size, SEG最大是0xFF = 256 - 1 .</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >-rw------- 1 pgdev pgdev &nbsp;16M Oct 15 09:42 0000000100000001000000FF</font></div><div><font size="2"  >-rw------- 1 pgdev pgdev &nbsp;16M Oct 15 09:42 000000010000000200000000</font></div><p></p></pre></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >src/include/access/xlog_internal.h</font></div><div><font size="2"  >00165 /*</font></div><div><font size="2"  >00166 &nbsp;* These macros encapsulate knowledge about the exact layout of XLog file</font></div><div><font size="2"  >00167 &nbsp;* names, timeline history file names, and archive-status file names.</font></div><div><font size="2"  >00168 &nbsp;*/</font></div><div><font size="2"  >00169 #define MAXFNAMELEN &nbsp; &nbsp; 64</font></div><div><font size="2"  >00170&nbsp;</font></div><div><font size="2"  >00171 #define XLogFileName(fname, tli, logSegNo) &nbsp;\</font></div><div><font size="2"  >00172 &nbsp; &nbsp; snprintf(fname, MAXFNAMELEN, "%08X%08X%08X", tli, &nbsp; &nbsp; &nbsp; \</font></div><div><font size="2"  >00173 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(uint32) ((logSegNo) / XLogSegmentsPerXLogId), \</font></div><div><font size="2"  >00174 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(uint32) ((logSegNo) % XLogSegmentsPerXLogId))</font></div><p></p></pre></div><div><br></div><div>使用PostgreSQL 9.3修改控制文件TLI,LOG,SEG的命令如下 :&nbsp;</div><div>将XLOG修改到上限后, pg_switch_xlog()同样报错.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pgdev@db-172-16-3-150-&gt; pg_resetxlog -l 00000001FFFFFFFF000000FE $PGDATA</font></div><div><font size="2"  >Transaction log reset</font></div><div><font size="2"  >pgdev@db-172-16-3-150-&gt; pg_ctl start</font></div><div><font size="2"  >server starting</font></div><div><font size="2"  >pgdev@db-172-16-3-150-&gt; LOG: &nbsp;database system was shut down at 2012-10-15 09:52:01 CST</font></div><div><font size="2"  >LOG: &nbsp;autovacuum launcher started</font></div><div><font size="2"  >LOG: &nbsp;database system is ready to accept connections</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >pgdev@db-172-16-3-150-&gt; psql</font></div><div><font size="2"  >psql (9.3devel)</font></div><div><font size="2"  >Type "help" for help.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=# \set VERBOSITY verbose</font></div><div><font size="2"  ><span style="line-height: 22px;"  >digoal</span>=# checkpoint;select pg_switch_xlog();</font></div><div><font size="2"  >CHECKPOINT</font></div><div><font size="2"  >&nbsp; pg_switch_xlog &nbsp;&nbsp;</font></div><div><font size="2"  >-------------------</font></div><div><font size="2"  >&nbsp;FFFFFFFF/FE000108</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ><span style="line-height: 22px;"  >digoal</span>=# checkpoint;select pg_switch_xlog();</font></div><div><font size="2"  >CHECKPOINT</font></div><div><font size="2"  >ERROR: &nbsp;xlog flush request FFFFFFFF/FF0000A8 is not satisfied --- flushed only to 0/28</font></div><div><font size="2"  >STATEMENT: &nbsp;select pg_switch_xlog();</font></div><div><font size="2"  >WARNING: &nbsp;AbortTransaction while in COMMIT state</font></div><div><font size="2"  >WARNING: &nbsp;01000: AbortTransaction while in COMMIT state</font></div><div><font size="2"  >LOCATION: &nbsp;AbortTransaction, xact.c:2276</font></div><div><font size="2"  >ERROR: &nbsp;XX000: xlog flush request FFFFFFFF/FF0000A8 is not satisfied --- flushed only to 0/28</font></div><div><font size="2"  >LOCATION: &nbsp;XLogFlush, xlog.c:2004</font></div><div><font size="2"  ><span style="line-height: 22px;"  >digoal</span>=#&nbsp;</font></div><div><font size="2"  ><span style="line-height: 22px;"  >digoal</span>=# PANIC: &nbsp;xlog write request 0/4000 is past end of log 0/0</font></div><div><font size="2"  >LOG: &nbsp;WAL writer process (PID 15433) was terminated by signal 6: Aborted</font></div><div><font size="2"  >LOG: &nbsp;terminating any other active server processes</font></div><div><font size="2"  >WARNING: &nbsp;terminating connection because of crash of another server process</font></div><div><font size="2"  >DETAIL: &nbsp;The postmaster has commanded this server process to roll back the current transaction and exit, because another server process exited abnormally and possibly corrupted shared memory.</font></div><div><font size="2"  >HINT: &nbsp;In a moment you should be able to reconnect to the database and repeat your command.</font></div><div><font size="2"  >WARNING: &nbsp;terminating connection because of crash of another server process</font></div><div><font size="2"  >DETAIL: &nbsp;The postmaster has commanded this server process to roll back the current transaction and exit, because another server process exited abnormally and possibly corrupted shared memory.</font></div><div><font size="2"  >HINT: &nbsp;In a moment you should be able to reconnect to the database and repeat your command.</font></div><div><font size="2"  >LOG: &nbsp;all server processes terminated; reinitializing</font></div><div><font size="2"  >LOG: &nbsp;database system was interrupted; last known up at 2012-10-15 09:52:28 CST</font></div><div><font size="2"  >LOG: &nbsp;database system was not properly shut down; automatic recovery in progress</font></div><div><font size="2"  >LOG: &nbsp;redo starts at FFFFFFFF/FF000088</font></div><div><font size="2"  >LOG: &nbsp;record with zero length at 0/28</font></div><div><font size="2"  >LOG: &nbsp;redo done at FFFFFFFF/FF000088</font></div><div><font size="2"  >LOG: &nbsp;autovacuum launcher started</font></div><div><font size="2"  >LOG: &nbsp;database system is ready to accept connections</font></div><p></p></pre></div><div><br></div><div>【参考】</div><div>1. How many xlogs | WAL can be generated by PostgreSQL?</div><div><a href="http://blog.163.com/digoal@126/blog/static/1638770402012914112949546/"  >http://blog.163.com/digoal@126/blog/static/1638770402012914112949546/</a></div><wbr></div>
	</div>
</div>
</body>
</html>