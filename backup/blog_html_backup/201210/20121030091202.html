<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">mongoDB javascript TO PostgreSQL DO language</h2>
	<h5 id="">2012-10-30 9:12:02&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201293082737559/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">mongoDB一个非常优秀的功能是支持javascript, 是一个非常便于程序员使用的数据库.<div>例如闪电狗(<a rel="nofollow" href="https://github.com/flash-dog/flash-dog"  >https://github.com/flash-dog/flash-dog) :&nbsp;</a></div><div><span style="color: rgb(51, 51, 51); font-family: Helvetica, arial, freesans, clean, sans-serif; line-height: 22px;"  >应用通过log4j输出日志到mongodb数据库中，闪电狗定时运行脚本分析日志，生成监控曲线和告警。主要优点是不影响业务代码，只需加入几个jar包和修改log4j配置文件就能接入。配置一些javascript小脚本，几乎就能监控所有你想监控的信息，如cpu内存，错误日志百分比，每日访问人数，收入等等</span><br style="color: rgb(51, 51, 51); font-family: Helvetica, arial, freesans, clean, sans-serif; line-height: 22px;"  ><span style="color: rgb(51, 51, 51); font-family: Helvetica, arial, freesans, clean, sans-serif; line-height: 22px;"  >该项目由</span><a style="margin: 0px; padding: 0px; border: 0px; color: rgb(65, 131, 196); text-decoration: none; font-family: Helvetica, arial, freesans, clean, sans-serif; line-height: 22px; " rel="nofollow" href="http://www.sky-mobi.com/"  >杭州斯凯网络</a><span style="color: rgb(51, 51, 51); font-family: Helvetica, arial, freesans, clean, sans-serif; line-height: 22px;"  >开源，目前已经在公司内部支付等关键业务中使用，对创业团队和中小型公司有较大吸引力。目前只支持java的log4j和logback日志输出，通过简单扩展可以支持其他语言。</span><br>mongoDB作为文档数据库, 还有一个比较特殊的特性是它不需要创建表, 不需要指定字段. 存储的是BSON类型. 类似JSON.</div><div>目前PostgreSQL 9.2已经引入了JSON类型, 但是功能还不是很完善. 目前只做到了格式的检查以及2个函数(array to json和row to json)</div><div>当然以后PostgreSQL 对JSON的支持应该会越来越好.</div><div><br></div><div>如果要让闪电狗支持PostgreSQL , 首先要让程序员适应PostgreSQL 的plpgsql函数语言. 另外就是需要创建表(mongoDB不需要创建).&nbsp;</div><div>为什么要让闪电狗支持PostgreSQL呢?&nbsp;</div><div>原因有几个 :&nbsp;</div><div>1. mongoDB的存储是BIN文件, 每个数据库一个目录, 当数据膨胀后只能repair(锁库, 非常慢) 或者删除数据库 来释放空间.</div><div>2. mongoDB的锁粒度太粗糙, 容易带来锁性能隐患.</div><div><br></div><div>下面以闪电狗某业务为例, 讲讲如何将javascript转换成PostgreSQL DO plpgsql.</div><div>1. mongoDB中存储的日志信息表 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >dog0:PRIMARY&gt; db.sms_plat_mrp.findOne()</font></div><div><font size="2"  >{</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; "_id" : ObjectId("508ebb67de5d47b91ef5b8a3"),</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; "timestamp" : ISODate("2012-10-29T17:22:47.616Z"),</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; "level" : "INFO",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; "thread" : "DubboServerHandler-thread-183",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; "message" : "unknow tag:212, just ignore.",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; "loggerName" : {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "fullyQualifiedClassName" : "stc.skymobi.bean.tlv.decode.decoders.BeanTLVDecoder",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "package" : [</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "stc",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "skymobi",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "bean",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "tlv",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "decode",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "decoders",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "BeanTLVDecoder"</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ],</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "className" : "BeanTLVDecoder"</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; },</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; "fileName" : "BeanTLVDecoder.java",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; "method" : "decode",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; "lineNumber" : "93",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; "class" : {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "fullyQualifiedClassName" : "stc.skymobi.bean.tlv.decode.decoders.BeanTLVDecoder",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "package" : [</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "stc",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "skymobi",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "bean",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "tlv",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "decode",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "decoders",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "BeanTLVDecoder"</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ],</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "className" : "BeanTLVDecoder"</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; },</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; "host" : {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "process" : "20592@10_10_10_130.localdomain",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "name" : "10_10_10_130.localdomain",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "ip" : "10.10.10.130"</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  >}</font></div><p></p></pre></div><div><br></div><div>转换成PostgreSQL的表, 我这里使用的是PostgreSQL 9.2, 未使用JSON类型, 因为现在JSON类型还不是很成熟.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create table sms_plat_mrp (</font></div><div><font size="2"  >&nbsp; create_time timestamp(0),&nbsp;</font></div><div><font size="2"  >&nbsp; level text,&nbsp;</font></div><div><font size="2"  >&nbsp; thread text,&nbsp;</font></div><div><font size="2"  >&nbsp; message text, &nbsp;</font></div><div><font size="2"  >&nbsp; loggerName text,</font></div><div><font size="2"  >&nbsp; fileName text,</font></div><div><font size="2"  >&nbsp; method text,</font></div><div><font size="2"  >&nbsp; lineNumber int,</font></div><div><font size="2"  >&nbsp; class text,</font></div><div><font size="2"  >&nbsp; host text</font></div><div><font size="2"  >);</font></div><div><font size="2"  >create index idx_sms_plat_mrp on sms_plat_mrp (create_time);</font></div><p></p></pre></div><div>需要一个时间索引, 因为统计都是基于时间段的.</div><div><br></div><div>插入两条测试数据到PostgreSQL数据库</div><div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >insert into sms_plat_mrp (create_time, level, thread, message, loggername, filename, method, linenumber, class, host)</font></div><div><font size="2"  >values (</font></div><div><font size="2"  >now(),&nbsp;</font></div><div><font size="2"  >'WARN',&nbsp;</font></div><div><font size="2"  >'DubboServerHandler-thread-198',&nbsp;</font></div><div><font size="2"  >'订单skyChargeId=13505384817011247601的当前状态是PaySuccess，不能正常接收付费结果报告msgid=20714337&amp;payid=13505384817011247601&amp;appid=428021&amp;appver=2&amp;type=3&amp;hsman=ahong&amp;hstype=ah24a&amp;imei=358511012403055&amp;imsi=460021298968285&amp;provider=0&amp;msgcen=8613800913500&amp;portv=101101180&amp;vmv=1964&amp;smsid=30116326&amp;status=0&amp;price=100&amp;dest=106680061&amp;spcode=11&amp;feecode=9SK&amp;sendtime=20716256&amp;statustime=20722283', '{</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "fullyQualifiedClassName" : "com.skymobi.pay.netsms.service.SmsPayServiceImpl",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "package" : [</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "com",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "skymobi",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "pay",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "netsms",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "service",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "SmsPayServiceImpl"</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ],</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "className" : "SmsPayServiceImpl"</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; }',&nbsp;</font></div><div><font size="2"  >'SmsPayServiceImpl.java',&nbsp;</font></div><div><font size="2"  >'isIgnorePayResult',</font></div><div><font size="2"  >209,</font></div><div><font size="2"  >'{</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "fullyQualifiedClassName" : "com.skymobi.pay.netsms.service.SmsPayServiceImpl",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "package" : [</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "com",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "skymobi",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "pay",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "netsms",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "service",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "SmsPayServiceImpl"</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ],</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "className" : "SmsPayServiceImpl"</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; }',</font></div><div><font size="2"  >'{</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "process" : "20592@10_10_10_130.localdomain",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "name" : "10_10_10_130.localdomain",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "ip" : "10.10.10.130"</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; }'</font></div><div><font size="2"  >);</font></div><div><br></div><div><font size="2"  >insert into sms_plat_mrp (create_time, level, thread, message, loggername, filename, method, linenumber, class, host)</font></div><div><font size="2"  >values (</font></div><div><font size="2"  >now(),&nbsp;</font></div><div><font size="2"  >'INFO',</font></div><div><font size="2"  >'DubboServerHandler-thread-183',</font></div><div><font size="2"  >$$receive a pay request SmsPayOrder{id=0, price=100, cap=null, merchantID='10100', VMV=2009, instanceID=49856, orderID='c2c2102012102915383122536', productID='null', productName='null', channelId=0, IMEI='358679881004234', IMSI='460027776410995', HSV=102070009, terminal='sm240', factory='ylt', skyid=256784221, createTime=Mon Oct 29 15:38:36 CST 2012, msgcen='null', status=Init, cpDealResult=un_notice, ropDealResult=un_notice, merchantPasswd='null', skyChargeId='null', failCode=0, payInstanceId=0, realPrice=0, payType=3, appId=428021, appName='maopaoqipai', appVersion='2', businessId='null', businessName='null', channelName='null', portalId='1008', portalName='null', ip='117.136.14.101', network='null', failDesc='null', mobiPhone='null', payResultInfo='null', ext1='', ext2='', ext3='', payRequestInfo='null', notifyAddress='null'}$$,</font></div><div><font size="2"  >'{</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "fullyQualifiedClassName" : "com.skymobi.pay.netsms.service.SmsPayServiceImpl",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "package" : [</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "com",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "skymobi",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "pay",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "netsms",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "service",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "SmsPayServiceImpl"</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ],</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "className" : "SmsPayServiceImpl"</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; }',</font></div><div><font size="2"  >'SmsPayServiceImpl.java',</font></div><div><font size="2"  >'commitOrder',</font></div><div><font size="2"  >67,</font></div><div><font size="2"  >'{</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "fullyQualifiedClassName" : "com.skymobi.pay.netsms.service.SmsPayServiceImpl",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "package" : [</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "com",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "skymobi",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "pay",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "netsms",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "service",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "SmsPayServiceImpl"</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ],</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "className" : "SmsPayServiceImpl"</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; }',</font></div><div><font size="2"  >'{</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "process" : "20592@10_10_10_130.localdomain",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "name" : "10_10_10_130.localdomain",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "ip" : "10.10.10.130"</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; }');</font></div></div><div></div><p></p></pre></div></div><div>2. 接下来看一下闪电狗用到的javascript.&nbsp;</div><div>基本上是基于前面的日志表进行统计, 将统计后的数据插入另一张表. 所以在PostgreSQL数据库中需要创建另一张表.</div><div><pre class="prettyprint"  ><p><font size="2"  >create table sms_plat_access_metrics (create_time timestamp(0), name text, value numeric);</font></p></pre></div><div><br></div><div>2.1</div><div><div>//统计错误日志占比</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >err=db.sms_plat_mrp.find({'level':'ERROR',timestamp:{$gt:new Date(new Date - 300000)}}).count()</font></div><div><font size="2"  >total=db.sms_plat_mrp.find({timestamp:{$gt:new Date(new Date - 300000)}}).count();</font></div><div><font size="2"  >if(total==0)total=1;</font></div><div><font size="2"  >value=err*100/total;</font></div><div><font size="2"  >db.sms_plat_access_metrics.save({name:'错误日志百分比',value:value,timeStamp:new Date().getTime()});</font></div><div><font size="2"  >return value;</font></div><p></p></pre></div></div><div><br></div><div>转换成PostgreSQL :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >do language plpgsql $$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >v_create_time timestamp(0);</font></div><div><font size="2"  >v_name text;</font></div><div><font size="2"  >v_value text;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >insert into sms_plat_access_metrics (create_time, name, value)&nbsp;</font></div><div><font size="2"  >&nbsp; select now(), '错误日志百分比', sum(case level when 'ERROR' then 1 else 0 end)/(1+count(*)) from sms_plat_mrp</font></div><div><font size="2"  >&nbsp; &nbsp; where create_time &gt; (now() - interval '300 second')</font></div><div><font size="2"  >&nbsp; returning create_time,name,value into v_create_time,v_name,v_value;</font></div><div><font size="2"  >raise notice '%, %, %', v_create_time,v_name,v_value;</font></div><div><font size="2"  >return;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$$;</font></div><p></p></pre></div><div><br></div><div>2.2</div><div><div>//统计日志里某些数字总值，如每5分钟收入等</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >m=function () {&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;result = this.message.match(".*money=(\\d+)");&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;if (result) {&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pricePaied = new NumberLong(result[1]); &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;emit("pricePaied", pricePaied);&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;}&nbsp;</font></div><div><font size="2"  >&nbsp;&nbsp;</font></div><div><font size="2"  >&nbsp;} &nbsp;</font></div><div><font size="2"  >&nbsp;&nbsp;</font></div><div><font size="2"  >&nbsp;r= function (key, values) {&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;var total = 0;&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;for (var i = 0; i &lt; values.length; i++) {&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;total += values[i];&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;}&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;return total;&nbsp;</font></div><div><font size="2"  >&nbsp;} &nbsp;&nbsp;</font></div><div><font size="2"  >&nbsp;res=db.sms_plat_mrp.mapReduce(m, r, {out:"sms_plat_mrp_output", query:{timestamp:{$gt:new Date(new Date - 300000)}}});&nbsp;</font></div><div><font size="2"  >&nbsp;pricePaied=db.sms_plat_mrp_output.findOne({_id:"pricePaied"});</font></div><div><font size="2"  >&nbsp;if(pricePaied)&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; v=pricePaied.value;&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp;else&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;v=0; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp;db.sms_plat_access_metrics.save({name:"5分钟收入",value:v,timeStamp:new Date().getTime()});&nbsp;</font></div><div><font size="2"  >&nbsp;return res;&nbsp;</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"  >转换成PostgreSQL :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >do language plpgsql $$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >v_create_time timestamp(0);</font></div><div><font size="2"  >v_name text;</font></div><div><font size="2"  >v_value text;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >insert into sms_plat_access_metrics (create_time, name, value)&nbsp;</font></div><div><font size="2"  >&nbsp; select now(), '5分钟收入', sum(mon::numeric) from&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; ( select unnest(regexp_matches(message,'.*money=([[:digit:]]+)')) AS mon from sms_plat_mrp</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; where create_time &gt; (now() - interval '300 second') ) t</font></div><div><font size="2"  >&nbsp; &nbsp; returning create_time,name,value into v_create_time,v_name,v_value;</font></div><div><font size="2"  >raise notice '%, %, %', v_create_time,v_name,v_value;</font></div><div><font size="2"  >return;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$$;</font></div><p></p></pre></div></div><div><br></div><div>2.3</div><div><div>//统计日志里某些关键字频率，并提取到告警邮件里</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp;var &nbsp; metric_name="异常数据次数"; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >&nbsp;var cur = db.sms_plat_mrp.find({message:/系统错误/,timestamp:{$gt:new Date(new Date - 60*60*1000)}});&nbsp;</font></div><div><font size="2"  >&nbsp; var content = ""; &nbsp;</font></div><div><font size="2"  >&nbsp; var count=0;&nbsp;</font></div><div><font size="2"  >&nbsp; cur.forEach( function(log) {&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; count++;&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; content =content+"\n "+log.timestamp.toLocaleDateString()+" "+ log.timestamp.toLocaleTimeString() +" " +log["message"];&nbsp;</font></div><div><font size="2"  >&nbsp; });&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp;db.sms_plat_access_metrics.save({name:metric_name,value:count, content:content,timeStamp:new Date().getTime()});&nbsp;</font></div><div><font size="2"  >&nbsp;return &nbsp; &nbsp;"次数:"+ count +" \n内容"+content;</font></div><p></p></pre></div><div><span style="line-height: 22px;"  ><br></span></div><div><span style="line-height: 22px;"  >转换成PostgreSQL :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >do language plpgsql $$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >v_create_time timestamp(0);</font></div><div><font size="2"  >v_name text;</font></div><div><font size="2"  >v_value text;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >insert into sms_plat_access_metrics (create_time, name, value)&nbsp;</font></div><div><font size="2"  >&nbsp; select now(), '异常数据次数', count(*) from sms_plat_mrp</font></div><div><font size="2"  >&nbsp; &nbsp; where message ~ '系统错误' and create_time &gt; (now() - interval '1 hour')&nbsp;</font></div><div><font size="2"  >&nbsp; returning create_time,name,value into v_create_time,v_name,v_value;</font></div><div><font size="2"  >raise notice '%, %, %', v_create_time,v_name,v_value;</font></div><div><font size="2"  >return;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$$;</font></div><p></p></pre></div></div><div><br></div><div>2.4</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >var now = new Date;</font></div><div><font size="2"  >&nbsp;var o=db.sms_plat_mrp.findOne({"className":"org.log4mongo.contrib.JvmMonitor",timestamp:{$gt:new Date(now - 3*60*1000)}});</font></div><div><font size="2"  >&nbsp;if(o){</font></div><div><font size="2"  ><span> </span>result = o.message.match(".*memoryUsed=(\\d+).*cpuUsed=(\\d+).*threadCount=(\\d+)");</font></div><div><font size="2"  >&nbsp; &nbsp;var memoryUsed = result[1]/1024;</font></div><div><font size="2"  >&nbsp; &nbsp;var cpuUsed = result[2];</font></div><div><font size="2"  >&nbsp; &nbsp;var threadCount = result[3];</font></div><div><font size="2"  >&nbsp; &nbsp;db.sms_plat_access_metrics.save({name:"memoryUsed (M)",value:memoryUsed,timeStamp:now.getTime()}); &nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp;db.sms_plat_access_metrics.save({name:"cpuUsed",value:cpuUsed,timeStamp:now.getTime()}); &nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp;db.sms_plat_access_metrics.save({name:"threadCount",value:threadCount,timeStamp:now.getTime()}); &nbsp;</font></div><div><font size="2"  >&nbsp; return "cpuUsed="+ cpuUsed &nbsp;+" memoryUsed="+memoryUsed &nbsp;+" threadCount="+threadCount;</font></div><div><font size="2"  >&nbsp; }</font></div><div><font size="2"  >&nbsp;return "无记录";</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"  >转换成PostgreSQL :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >do language plpgsql $$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >&nbsp; ref refcursor;</font></div><div><font size="2"  >&nbsp; result text[];</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >&nbsp; open ref for</font></div><div><font size="2"  >&nbsp; &nbsp; select regexp_matches(message, '.*memoryUsed=([[:digit:]]+).*cpuUsed=([[:digit:]]+).*threadCount=([[:digit:]]+)') as res from sms_plat_mrp&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; where loggerName ~ '"className" = "org.log4mongo.contrib.JvmMonitor"'&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; and create_time &gt; (now() - interval '1 hour')</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; and message ~ '.*memoryUsed=([[:digit:]]+).*cpuUsed=([[:digit:]]+).*threadCount=([[:digit:]]+)';</font></div><div><font size="2"  >loop</font></div><div><font size="2"  >&nbsp; fetch ref into result;</font></div><div><font size="2"  >&nbsp; if found then</font></div><div><font size="2"  >&nbsp; &nbsp; insert into sms_plat_access_metrics (create_time, name, value)&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;values (now(), 'memoryUsed (M)', (result[1])::numeric / 1024);</font></div><div><font size="2"  >&nbsp; &nbsp; raise notice 'memoryUsed (M): %', (result[1])::numeric / 1024;</font></div><div><font size="2"  >&nbsp; &nbsp; insert into sms_plat_access_metrics (create_time, name, value)&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;values (now(), 'cpuUsed', result[2]);</font></div><div><font size="2"  >&nbsp; &nbsp; raise notice 'cpuUsed', result[2];</font></div><div><font size="2"  >&nbsp; &nbsp; insert into sms_plat_access_metrics (create_time, name, value)&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;values (now(), 'threadCount', result[3]);</font></div><div><font size="2"  >&nbsp; &nbsp; raise notice 'threadCount', result[3];</font></div><div><font size="2"  >&nbsp; else</font></div><div><font size="2"  >&nbsp; &nbsp; close ref;</font></div><div><font size="2"  >&nbsp; &nbsp; exit;</font></div><div><font size="2"  >&nbsp; end if;</font></div><div><font size="2"  >end loop;</font></div><div><font size="2"  >return;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$$;</font></div><p></p></pre></div></div><div><br></div><div>【小结】</div><div>1. 用PostgreSQL的DO语法替代javascript是不错的选择, 不需要创建PostgreSQL函数, 方便开发人员修改和调试.&nbsp;</div><div>2. javascript中使用return 返回方便开发人员测试脚本, 而PostgreSQL中同样可以使用raise notice 来输出结果, 方便开发人员调试.</div><div>3. mongoDB支持capped collection, 可以限定表的SIZE和记录数, 达到后将rotate. 而PostgreSQL不支持这种表. 但是可以通过定时任务来达到同样的目的, 下次讲讲PostgreSQL实现capped table.</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201293051423810/"  >《PostgreSQL rotate table like mongoDB's capped collection》</a></div><div><br></div><div>【参考】</div><div>1.&nbsp;<a rel="nofollow" href="https://github.com/flash-dog/flash-dog"  >https://github.com/flash-dog/flash-dog</a></div><div>2.&nbsp;<a rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/sql-do.html"  >http://www.postgresql.org/docs/9.2/static/sql-do.html</a></div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">hill - 2012-10-30 9:57:57</h5>
				<div>先赞1个！<div>对于我们普通程序员来说，还是有点难懂，挑战不小</div></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 hill - 2012-10-30 9:57:57</h5>
				<div style="width:600px;">感谢珊哥指点, PLPGSQL的用法在&nbsp;http://www.postgresql.org/docs/9.2/static/plpgsql.html<div>面向过程的语言, 程序员应该很好懂.</div></div>
			</div>
	</div>
</div>
</body>
</html>