<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">timestamptz_out and EncodeDateTime modified, no timezone and BC output.</h2>
	<h5 id="">2012-10-09 11:24:13&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402012991064920/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>前段时间一位兄弟问到的问题, 他们需要从GreenPlum中抽取数据到Oracle数据库, 对于timestamptz类型, 导出的数据可能带了时区和公元前的信息, 在导入Oracle前需要做文本处理。 所以显得比较麻烦.</div><div>那么有没有参数可以关闭时区和公元前的显示呢?</div><div>datestyle是一个时间格式的显示参数, 但是没有<span style="line-height: 22px;"  >关闭时区和公元前的显示的效果.</span></div><div>比较通用的解决办法是使用to_char进行格式化输出. 但是当你的表很多的时候, 编辑起来就非常麻烦了.</div><div>所以能不能有其他办法呢?</div><div>下面是通过修改源码, 来实现这个目的,&nbsp;</div><div>1. 去除timetz或者timestamptz的时区以及公元前标示的显示.</div><div>2. 去除date类型的<span style="line-height: 22px;"  >公元前标示的显示.</span></div><div><span style="line-height: 22px;"  >3. 仅仅改变显示, 不改变数据存储.</span></div><div>涉及的修改如下 :&nbsp;</div><div><div>1.&nbsp;</div><div>src/backend/utils/adt/timestamp.c</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >00484 timestamptz_out(PG_FUNCTION_ARGS)</font></div><div><font size="2"  >00485 {</font></div><div><font size="2"  >00486 &nbsp; &nbsp; TimestampTz dt = PG_GETARG_TIMESTAMPTZ(0);</font></div><div><font size="2"  >00487 &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *result;</font></div><div><font size="2"  >00488 &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; tz;</font></div><div><font size="2"  >00489 &nbsp; &nbsp; struct pg_tm tt,</font></div><div><font size="2"  >00490 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*tm = &amp;tt;</font></div><div><font size="2"  >00491 &nbsp; &nbsp; fsec_t &nbsp; &nbsp; &nbsp;fsec;</font></div><div><font size="2"  >00492 &nbsp; &nbsp; const char *tzn;</font></div><div><font size="2"  >00493 &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; &nbsp;buf[MAXDATELEN + 1];</font></div><div><font size="2"  >00494&nbsp;</font></div><div><font size="2"  >00495 &nbsp; &nbsp; if (TIMESTAMP_NOT_FINITE(dt))</font></div><div><font size="2"  >00496 &nbsp; &nbsp; &nbsp; &nbsp; EncodeSpecialTimestamp(dt, buf);</font></div><div><font size="2"  >00497 &nbsp; &nbsp; else if (timestamp2tm(dt, &amp;tz, tm, &amp;fsec, &amp;tzn, NULL) == 0)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // old src // EncodeDateTime(tm, fsec, true, tz, tzn, DateStyle, buf);&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // modified by digoal , 不打印时区</font></div><div><font size="2"  ><span> </span> &nbsp; &nbsp;EncodeDateTime(tm, fsec, false, 0, NULL, DateStyle, buf);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // end modified by digoal</font></div><div><font size="2"  >00499 &nbsp; &nbsp; else</font></div><div><font size="2"  >00500 &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,</font></div><div><font size="2"  >00501 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode(ERRCODE_DATETIME_VALUE_OUT_OF_RANGE),</font></div><div><font size="2"  >00502 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("timestamp out of range")));</font></div><div><font size="2"  >00503&nbsp;</font></div><div><font size="2"  >00504 &nbsp; &nbsp; result = pstrdup(buf);</font></div><div><font size="2"  >00505 &nbsp; &nbsp; PG_RETURN_CSTRING(result);</font></div><div><font size="2"  >00506 }</font></div><p></p></pre></div><div><br></div><div>2.&nbsp;</div><div>src/backend/utils/adt/datetime.c</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >03637 /* EncodeDateOnly()</font></div><div><font size="2"  >03638 &nbsp;* Encode date as local time.</font></div><div><font size="2"  >03639 &nbsp;*/</font></div><div><font size="2"  >03640 void</font></div><div><font size="2"  >03641 EncodeDateOnly(struct pg_tm * tm, int style, char *str)</font></div><div><font size="2"  >03642 {</font></div><div><font size="2"  >03643 &nbsp; &nbsp; Assert(tm-&gt;tm_mon &gt;= 1 &amp;&amp; tm-&gt;tm_mon &lt;= MONTHS_PER_YEAR);</font></div><div><font size="2"  >03644&nbsp;</font></div><div><font size="2"  >03645 &nbsp; &nbsp; switch (style)</font></div><div><font size="2"  >03646 &nbsp; &nbsp; {</font></div><div><font size="2"  >03647 &nbsp; &nbsp; &nbsp; &nbsp; case USE_ISO_DATES:</font></div><div><font size="2"  >03648 &nbsp; &nbsp; &nbsp; &nbsp; case USE_XSD_DATES:</font></div><div><font size="2"  >03649 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* compatible with ISO date formats */</font></div><div><font size="2"  >03650 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (tm-&gt;tm_year &gt; 0)</font></div><div><font size="2"  >03651 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sprintf(str, "%04d-%02d-%02d",</font></div><div><font size="2"  >03652 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tm-&gt;tm_year, tm-&gt;tm_mon, tm-&gt;tm_mday);</font></div><div><font size="2"  >03653 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"  >/* modified by digoal , old</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sprintf(str, "%04d-%02d-%02d %s",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -(tm-&gt;tm_year - 1), tm-&gt;tm_mon, tm-&gt;tm_mday, "BC");</font></div><div><font size="2"  >*/</font></div><div><font size="2"  >// modified by digoal , new , date类型, 当DateStyle=USE_ISO_DATES或USE_XSD_DATES时不打印公元前标示</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sprintf(str, "%04d-%02d-%02d",</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -(tm-&gt;tm_year - 1), tm-&gt;tm_mon, tm-&gt;tm_mday);</font></div><div><font size="2"  >// end modified by digoal , new</font></div><div><font size="2"  >03656 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >03679 &nbsp; &nbsp; &nbsp; &nbsp; case USE_POSTGRES_DATES:</font></div><div><font size="2"  >03680 &nbsp; &nbsp; &nbsp; &nbsp; default:</font></div><div><font size="2"  >03681 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* traditional date-only style for Postgres */</font></div><div><font size="2"  >03682 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (DateOrder == DATEORDER_DMY)</font></div><div><font size="2"  >03683 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sprintf(str, "%02d-%02d", tm-&gt;tm_mday, tm-&gt;tm_mon);</font></div><div><font size="2"  >03684 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"  >03685 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sprintf(str, "%02d-%02d", tm-&gt;tm_mon, tm-&gt;tm_mday);</font></div><div><font size="2"  >03686 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (tm-&gt;tm_year &gt; 0)</font></div><div><font size="2"  >03687 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sprintf(str + 5, "-%04d", tm-&gt;tm_year);</font></div><div><font size="2"  >03688 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"  >/* modified by digoal, old</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sprintf(str + 5, "-%04d %s", -(tm-&gt;tm_year - 1), "BC");</font></div><div><font size="2"  >*/</font></div><div><font size="2"  >// modified by digoal, new</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sprintf(str + 5, "-%04d", -(tm-&gt;tm_year - 1));</font></div><div><font size="2"  >// end modified by digoal, new</font></div><div><font size="2"  >03690 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >03716 /* EncodeDateTime()</font></div><div><font size="2"  >03717 &nbsp;* Encode date and time interpreted as local time.</font></div><div><font size="2"  >03718 &nbsp;*</font></div><div><font size="2"  >03719 &nbsp;* tm and fsec are the value to encode, print_tz determines whether to include</font></div><div><font size="2"  >03720 &nbsp;* a time zone (the difference between timestamp and timestamptz types), tz is</font></div><div><font size="2"  >03721 &nbsp;* the numeric time zone offset, tzn is the textual time zone, which if</font></div><div><font size="2"  >03722 &nbsp;* specified will be used instead of tz by some styles, style is the date</font></div><div><font size="2"  >03723 &nbsp;* style, str is where to write the output.</font></div><div><font size="2"  >03724 &nbsp;*</font></div><div><font size="2"  >03725 &nbsp;* Supported date styles:</font></div><div><font size="2"  >03726 &nbsp;* &nbsp;Postgres - day mon hh:mm:ss yyyy tz</font></div><div><font size="2"  >03727 &nbsp;* &nbsp;SQL - mm/dd/yyyy hh:mm:ss.ss tz</font></div><div><font size="2"  >03728 &nbsp;* &nbsp;ISO - yyyy-mm-dd hh:mm:ss+/-tz</font></div><div><font size="2"  >03729 &nbsp;* &nbsp;German - dd.mm.yyyy hh:mm:ss tz</font></div><div><font size="2"  >03730 &nbsp;* &nbsp;XSD - yyyy-mm-ddThh:mm:ss.ss+/-tz</font></div><div><font size="2"  >03731 &nbsp;*/</font></div><div><font size="2"  >03732 void</font></div><div><font size="2"  >03733 EncodeDateTime(struct pg_tm * tm, fsec_t fsec, bool print_tz, int tz, const char *tzn, int style, char *str)</font></div><div><font size="2"  >03734 {</font></div><div><font size="2"  >03735 &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; day;</font></div><div><font size="2"  >03736&nbsp;</font></div><div><font size="2"  >03737 &nbsp; &nbsp; Assert(tm-&gt;tm_mon &gt;= 1 &amp;&amp; tm-&gt;tm_mon &lt;= MONTHS_PER_YEAR);</font></div><div><font size="2"  >03738&nbsp;</font></div><div><font size="2"  >03739 &nbsp; &nbsp; /*</font></div><div><font size="2"  >03740 &nbsp; &nbsp; &nbsp;* Negative tm_isdst means we have no valid time zone translation.</font></div><div><font size="2"  >03741 &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"  >03742 &nbsp; &nbsp; if (tm-&gt;tm_isdst &lt; 0)</font></div><div><font size="2"  >03743 &nbsp; &nbsp; &nbsp; &nbsp; print_tz = false;</font></div><div><font size="2"  >03744&nbsp;</font></div><div><font size="2"  >03745 &nbsp; &nbsp; switch (style)</font></div><div><font size="2"  >03746 &nbsp; &nbsp; {</font></div><div><font size="2"  >03747 &nbsp; &nbsp; &nbsp; &nbsp; case USE_ISO_DATES:</font></div><div><font size="2"  >03748 &nbsp; &nbsp; &nbsp; &nbsp; case USE_XSD_DATES:</font></div><div><font size="2"  >03749 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Compatible with ISO-8601 date formats */</font></div><div><font size="2"  >03750&nbsp;</font></div><div><font size="2"  >03751 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (style == USE_ISO_DATES)</font></div><div><font size="2"  >03752 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sprintf(str, "%04d-%02d-%02d %02d:%02d:",</font></div><div><font size="2"  >03753 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (tm-&gt;tm_year &gt; 0) ? tm-&gt;tm_year : -(tm-&gt;tm_year - 1),</font></div><div><font size="2"  >03754 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tm-&gt;tm_mon, tm-&gt;tm_mday, tm-&gt;tm_hour, tm-&gt;tm_min);</font></div><div><font size="2"  >03755 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"  >03756 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sprintf(str, "%04d-%02d-%02dT%02d:%02d:",</font></div><div><font size="2"  >03757 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (tm-&gt;tm_year &gt; 0) ? tm-&gt;tm_year : -(tm-&gt;tm_year - 1),</font></div><div><font size="2"  >03758 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tm-&gt;tm_mon, tm-&gt;tm_mday, tm-&gt;tm_hour, tm-&gt;tm_min);</font></div><div><font size="2"  >03759&nbsp;</font></div><div><font size="2"  >03760 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AppendTimestampSeconds(str + strlen(str), tm, fsec);</font></div><div><font size="2"  >03761&nbsp;</font></div><div><font size="2"  >03762 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (print_tz)</font></div><div><font size="2"  >03763 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; EncodeTimezone(str, tz, style);</font></div><div><font size="2"  >03764&nbsp;</font></div><div><font size="2"  >/* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// modified by digoal , 当DateStyle=USE_ISO_DATES或USE_XSD_DATES时不打印公元前标示</font></div><div><font size="2"  >03765 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (tm-&gt;tm_year &lt;= 0)</font></div><div><font size="2"  >03766 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sprintf(str + strlen(str), " BC");</font></div><div><font size="2"  >*/</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >03824 &nbsp; &nbsp; &nbsp; &nbsp; case USE_POSTGRES_DATES:</font></div><div><font size="2"  >03825 &nbsp; &nbsp; &nbsp; &nbsp; default:</font></div><div><font size="2"  >03826 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Backward-compatible with traditional Postgres abstime dates */</font></div><div><font size="2"  >03827&nbsp;</font></div><div><font size="2"  >03828 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; day = date2j(tm-&gt;tm_year, tm-&gt;tm_mon, tm-&gt;tm_mday);</font></div><div><font size="2"  >03829 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tm-&gt;tm_wday = j2day(day);</font></div><div><font size="2"  >03830&nbsp;</font></div><div><font size="2"  >03831 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; strncpy(str, days[tm-&gt;tm_wday], 3);</font></div><div><font size="2"  >03832 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; strcpy(str + 3, " ");</font></div><div><font size="2"  >03833&nbsp;</font></div><div><font size="2"  >03834 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (DateOrder == DATEORDER_DMY)</font></div><div><font size="2"  >03835 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sprintf(str + 4, "%02d %3s", tm-&gt;tm_mday, months[tm-&gt;tm_mon - 1]);</font></div><div><font size="2"  >03836 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"  >03837 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sprintf(str + 4, "%3s %02d", months[tm-&gt;tm_mon - 1], tm-&gt;tm_mday);</font></div><div><font size="2"  >03838&nbsp;</font></div><div><font size="2"  >03839 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sprintf(str + 10, " %02d:%02d:", tm-&gt;tm_hour, tm-&gt;tm_min);</font></div><div><font size="2"  >03840&nbsp;</font></div><div><font size="2"  >03841 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; AppendTimestampSeconds(str + strlen(str), tm, fsec);</font></div><div><font size="2"  >03842&nbsp;</font></div><div><font size="2"  >03843 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sprintf(str + strlen(str), " %04d",</font></div><div><font size="2"  >03844 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (tm-&gt;tm_year &gt; 0) ? tm-&gt;tm_year : -(tm-&gt;tm_year - 1));</font></div><div><font size="2"  >03845&nbsp;</font></div><div><font size="2"  >03846 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (print_tz)</font></div><div><font size="2"  >03847 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >03848 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (tzn)</font></div><div><font size="2"  >03849 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sprintf(str + strlen(str), " %.*s", MAXTZLEN, tzn);</font></div><div><font size="2"  >03850 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"  >03851 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >03852 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"  >03853 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* We have a time zone, but no string version. Use the</font></div><div><font size="2"  >03854 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* numeric form, but be sure to include a leading space to</font></div><div><font size="2"  >03855 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* avoid formatting something which would be rejected by</font></div><div><font size="2"  >03856 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* the date/time parser later. - thomas 2001-10-19</font></div><div><font size="2"  >03857 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"  >03858 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sprintf(str + strlen(str), " ");</font></div><div><font size="2"  >03859 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; EncodeTimezone(str, tz, style);</font></div><div><font size="2"  >03860 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  >03861 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  >03862&nbsp;</font></div><div><font size="2"  >/* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// modified by digoal, 当DateStyle=USE_POSTGRES_DATES时不打印公元前标示</font></div><div><font size="2"  >03863 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (tm-&gt;tm_year &lt;= 0)</font></div><div><font size="2"  >03864 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sprintf(str + strlen(str), " BC");</font></div><div><font size="2"  >*/</font></div><p></p></pre></div><div><br></div><div>修改完后,&nbsp;</div><div>1. 关闭数据库</div><div>2. 将老的bin目录重命名为其他名字.&nbsp;</div><div>3. 重新编译修改后的源码文件</div><div>4. 使用新的BIN目录重启数据库</div><div>测试使用新的BIN目录连接数据库查看格式是否生效 :&nbsp;</div></div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal=# show datestyle;</font></div><div><font size="2"  >&nbsp;DateStyle&nbsp;</font></div><div><font size="2"  >-----------</font></div><div><font size="2"  >&nbsp;ISO, MDY</font></div><div><font size="2"  >(1 row)</font></div></div><div><div><font size="2"  >digoal=# select date 'January 8, 99 BC +8';</font></div><div><font size="2"  >&nbsp; &nbsp; date &nbsp; &nbsp;</font></div><div><font size="2"  >------------</font></div><div><font size="2"  >&nbsp;0099-01-08</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=# select timestamptz 'January 8, 99 BC +8';</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;timestamptz &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >---------------------</font></div><div><font size="2"  >&nbsp;0099-01-08 00:05:52</font></div><div><font size="2"  >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>修改datestyle后查看是否显示公元前标示 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# set datestyle='sql';</font></div><div><font size="2"  >SET</font></div><div><font size="2"  >digoal=# select timestamptz 'January 8, 99 BC +8';</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; timestamptz &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >------------------------</font></div><div><font size="2"  >&nbsp;01/08/0099 00:05:52 BC</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=# select date 'January 8, 99 BC +8';</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;date &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >---------------</font></div><div><font size="2"  >&nbsp;01/08/0099 BC</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div><div>使用老的BIN目录重启数据库, 重新测试格式是否回到以前, 显示时区和公元前的信息 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal=&gt; show datestyle;</font></div><div><font size="2"  >&nbsp;DateStyle&nbsp;</font></div><div><font size="2"  >-----------</font></div><div><font size="2"  >&nbsp;ISO, MDY</font></div><div><font size="2"  >(1 row)</font></div></div><div><div><font size="2"  >digoal=&gt; select timestamptz 'January 8, 99 BC +8';</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;timestamptz &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >---------------------------------</font></div><div><font size="2"  >&nbsp;0099-01-08 00:05:52+08:05:52 BC</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=&gt; select date 'January 8, 99 BC +8';</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;date &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >---------------</font></div><div><font size="2"  >&nbsp;0099-01-08 BC</font></div><div><font size="2"  >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>测试数据存储是否正确, 是否存储了公元以及时区信息.</div><div>使用新的BIN目录创建的表和插入的数据, 在<span style="line-height: 22px;"  >DateStyle='ISO' 时不显示时区和公元信息.</span></div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# create table t (tstz timestamptz, dt date);</font></div><div><font size="2"  >CREATE TABLE</font></div><div><font size="2"  >digoal=# insert into t values (timestamptz 'January 8, 99 BC', date 'January 8, 99 BC');</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=# insert into t values (now(),current_date);</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=# show datestyle;</font></div><div><font size="2"  >&nbsp;DateStyle&nbsp;</font></div><div><font size="2"  >-----------</font></div><div><font size="2"  >&nbsp;ISO, MDY</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >digoal=# select * from t;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tstz &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; dt &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >----------------------------+------------</font></div><div><font size="2"  >&nbsp;0099-01-08 00:00:00 &nbsp; &nbsp; &nbsp; &nbsp;| 0099-01-08</font></div><div><font size="2"  >&nbsp;2012-10-09 11:25:55.327655 | 2012-10-09</font></div><div><font size="2"  >(2 rows)</font></div><p></p></pre></div><div>修改<span style="line-height: 22px;"  >DateStyle=‘SQL’后显示公元信息 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# set datestyle='SQL';</font></div><div><font size="2"  >SET</font></div><div><font size="2"  >digoal=# select * from t;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tstz &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;dt &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >----------------------------+---------------</font></div><div><font size="2"  >&nbsp;01/08/0099 00:00:00 BC &nbsp; &nbsp; | 01/08/0099 BC</font></div><div><font size="2"  >&nbsp;10/09/2012 11:25:55.327655 | 10/09/2012</font></div><div><font size="2"  >(2 rows)</font></div><p></p></pre></div><div><br></div><div>将BIN文件替换为老的BIN文件, 重启数据库,&nbsp;<span style="line-height: 22px;"  >DateStyle='ISO‘时将正确显示时区和公元信息.</span></div><div><span style="line-height: 22px;"  >所以数据存储是正常的.</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pgdev@db-172-16-3-150-&gt; mv pgsql9.3 pgsql9.3-notzbc</font></div><div><font size="2"  >pgdev@db-172-16-3-150-&gt; mv pgsql9.3-raw pgsql9.3</font></div><div><font size="2"  >pgdev@db-172-16-3-150-&gt; pg_ctl start</font></div><div><font size="2"  >server starting</font></div><div><font size="2"  >pgdev@db-172-16-3-150-&gt; LOG: &nbsp;database system was shut down at 2012-10-09 11:26:45 CST</font></div><div><font size="2"  >LOG: &nbsp;autovacuum launcher started</font></div><div><font size="2"  >LOG: &nbsp;database system is ready to accept connections</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >pgdev@db-172-16-3-150-&gt; psql</font></div><div><font size="2"  >psql (9.3devel)</font></div><div><font size="2"  >Type "help" for help.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=# select * from t;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tstz &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;dt &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >---------------------------------+---------------</font></div><div><font size="2"  >&nbsp;0099-01-08 00:00:00+08:05:52 BC | 0099-01-08 BC</font></div><div><font size="2"  >&nbsp;2012-10-09 11:25:55.327655+08 &nbsp; | 2012-10-09</font></div><div><font size="2"  >(2 rows)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=# show datestyle;</font></div><div><font size="2"  >&nbsp;DateStyle&nbsp;</font></div><div><font size="2"  >-----------</font></div><div><font size="2"  >&nbsp;ISO, MDY</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div></div><div>测试pg_dump导出是否受到同样的影响 :&nbsp;</div><div>1. 修改源码后的BIN</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pgdev@db-172-16-3-150-&gt; pg_ctl stop -m fast</font></div><div><font size="2"  >waiting for server to shut down....LOG: &nbsp;received fast shutdown request</font></div><div><font size="2"  >LOG: &nbsp;aborting any active transactions</font></div><div><font size="2"  >LOG: &nbsp;autovacuum launcher shutting down</font></div><div><font size="2"  >LOG: &nbsp;shutting down</font></div><div><font size="2"  >LOG: &nbsp;database system is shut down</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp;done</font></div><div><font size="2"  >server stopped</font></div><div><font size="2"  >pgdev@db-172-16-3-150-&gt;&nbsp;</font></div><div><font size="2"  >pgdev@db-172-16-3-150-&gt;&nbsp;</font></div><div><font size="2"  >pgdev@db-172-16-3-150-&gt; mv pgsql9.3 pgsql9.3-raw</font></div><div><font size="2"  >pgdev@db-172-16-3-150-&gt; mv pgsql9.3-notzbc pgsql9.3</font></div><div><font size="2"  >pgdev@db-172-16-3-150-&gt; pg_ctl start</font></div><div><font size="2"  >server starting</font></div><div><font size="2"  >pgdev@db-172-16-3-150-&gt; LOG: &nbsp;database system was shut down at 2012-10-09 13:17:39 CST</font></div><div><font size="2"  >LOG: &nbsp;autovacuum launcher started</font></div><div><font size="2"  >LOG: &nbsp;database system is ready to accept connections</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >pgdev@db-172-16-3-150-&gt; pg_dump -t t</font></div><div><font size="2"  >--</font></div><div><font size="2"  >-- PostgreSQL database dump</font></div><div><font size="2"  >--</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >SET statement_timeout = 0;</font></div><div><font size="2"  >SET client_encoding = 'UTF8';</font></div><div><font size="2"  >SET standard_conforming_strings = on;</font></div><div><font size="2"  >SET check_function_bodies = false;</font></div><div><font size="2"  >SET client_min_messages = warning;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >SET search_path = public, pg_catalog;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >SET default_tablespace = '';</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >SET default_with_oids = false;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >--</font></div><div><font size="2"  >-- Name: t; Type: TABLE; Schema: public; Owner: postgres; Tablespace:&nbsp;</font></div><div><font size="2"  >--</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >CREATE TABLE t (</font></div><div><font size="2"  >&nbsp; &nbsp; tstz timestamp with time zone,</font></div><div><font size="2"  >&nbsp; &nbsp; dt date</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ><br></font></div><div><font size="2"  >ALTER TABLE public.t OWNER TO postgres;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >--</font></div><div><font size="2"  >-- Data for Name: t; Type: TABLE DATA; Schema: public; Owner: postgres</font></div><div><font size="2"  >--</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >COPY t (tstz, dt) FROM stdin;</font></div><div><font size="2"  >0099-01-08 00:00:00 &nbsp; &nbsp; 0099-01-08</font></div><div><font size="2"  >2012-10-09 11:25:55.327655 &nbsp; &nbsp; &nbsp;2012-10-09</font></div><div><font size="2"  >\.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ><br></font></div><div><font size="2"  >--</font></div><div><font size="2"  >-- PostgreSQL database dump complete</font></div><div><font size="2"  >--</font></div><p></p></pre></div><div>2. 修改源码前的BIN</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pgdev@db-172-16-3-150-&gt; pg_ctl stop -m fast</font></div><div><font size="2"  >waiting for server to shut down...LOG: &nbsp;received fast shutdown request</font></div><div><font size="2"  >LOG: &nbsp;aborting any active transactions</font></div><div><font size="2"  >.LOG: &nbsp;autovacuum launcher shutting down</font></div><div><font size="2"  >LOG: &nbsp;shutting down</font></div><div><font size="2"  >LOG: &nbsp;database system is shut down</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp;done</font></div><div><font size="2"  >server stopped</font></div><div><font size="2"  >pgdev@db-172-16-3-150-&gt;&nbsp;</font></div><div><font size="2"  >pgdev@db-172-16-3-150-&gt; mv pgsql9.3 pgsql9.3-notzbc</font></div><div><font size="2"  >pgdev@db-172-16-3-150-&gt; mv pgsql9.3-raw pgsql9.3</font></div><div><font size="2"  >pgdev@db-172-16-3-150-&gt; pg_ctl start</font></div><div><font size="2"  >server starting</font></div><div><font size="2"  >pgdev@db-172-16-3-150-&gt; LOG: &nbsp;database system was shut down at 2012-10-09 13:18:26 CST</font></div><div><font size="2"  >LOG: &nbsp;autovacuum launcher started</font></div><div><font size="2"  >LOG: &nbsp;database system is ready to accept connections</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >pgdev@db-172-16-3-150-&gt; which psql</font></div><div><font size="2"  >~/pgsql9.3/bin/psql</font></div><div><font size="2"  >pgdev@db-172-16-3-150-&gt; pg_dump -t t</font></div><div><font size="2"  >--</font></div><div><font size="2"  >-- PostgreSQL database dump</font></div><div><font size="2"  >--</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >SET statement_timeout = 0;</font></div><div><font size="2"  >SET client_encoding = 'UTF8';</font></div><div><font size="2"  >SET standard_conforming_strings = on;</font></div><div><font size="2"  >SET check_function_bodies = false;</font></div><div><font size="2"  >SET client_min_messages = warning;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >SET search_path = public, pg_catalog;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >SET default_tablespace = '';</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >SET default_with_oids = false;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >--</font></div><div><font size="2"  >-- Name: t; Type: TABLE; Schema: public; Owner: postgres; Tablespace:&nbsp;</font></div><div><font size="2"  >--</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >CREATE TABLE t (</font></div><div><font size="2"  >&nbsp; &nbsp; tstz timestamp with time zone,</font></div><div><font size="2"  >&nbsp; &nbsp; dt date</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ><br></font></div><div><font size="2"  >ALTER TABLE public.t OWNER TO postgres;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >--</font></div><div><font size="2"  >-- Data for Name: t; Type: TABLE DATA; Schema: public; Owner: postgres</font></div><div><font size="2"  >--</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >COPY t (tstz, dt) FROM stdin;</font></div><div><font size="2"  >0099-01-08 00:00:00+08:05:52 BC 0099-01-08 BC</font></div><div><font size="2"  >2012-10-09 11:25:55.327655+08 &nbsp; 2012-10-09</font></div><div><font size="2"  >\.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ><br></font></div><div><font size="2"  >--</font></div><div><font size="2"  >-- PostgreSQL database dump complete</font></div><div><font size="2"  >--</font></div><p></p></pre></div></div><div><br></div><div>【参考】</div><div>1.&nbsp;<a rel="nofollow" href="http://doxygen.postgresql.org/"  >http://doxygen.postgresql.org/</a></div><div>2.&nbsp;src/backend/utils/adt/timestamp.c</div><div>3.&nbsp;src/backend/utils/adt/datetime.c</div>4. 使用objdump或者nm查看到bin/postgres, lib/libpgtypes.a, lib/libpgtypes.so.3.4 包含了修改过的timestamptz_out和EncodeDateOnly 函数.<div>所以替换这几个文件也是可以的.</div></div>
	</div>
</div>
</body>
</html>