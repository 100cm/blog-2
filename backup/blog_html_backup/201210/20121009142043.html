<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">group by & distinct tuning case : use WITH RECURSIVE and min() function</h2>
	<h5 id="">2012-10-09 14:20:43&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020129851138327/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div><div><div>今天要说的这个优化是从前面一篇讲解《<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020128142829610/"  >performance tuning case :use cursor or trigger replace group by and order by</a>》的延展.</div><div>例如一个表中有一个字段是性别, 这个表不管有多少条记录, 性别这个字段一般来说也就2个值</div><div>select count(distinct sex) from table; 得到的结果当然是2. 但是如果数据量很大的情况下, 这种运算就非常耗时, 下面来测试一下 :&nbsp;</div><div>PostgreSQL :&nbsp;</div><div>测试表</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; create table sex (sex char(1), otherinfo text);</font></div><div><font size="2"  >CREATE TABLE</font></div><p></p></pre></div><div>测试数据</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; insert into sex select 'm', generate_series(1,10000000)||'this is test';</font></div><div><font size="2"  >INSERT 0 10000000</font></div><div><font size="2"  >digoal=&gt; insert into sex select 'w', generate_series(1,10000000)||'this is test';</font></div><div><font size="2"  >INSERT 0 10000000</font></div><p></p></pre></div><div>测试SQL1</div><div><pre class="prettyprint"  ><p></p><div><span style="line-height: 22px;"  ><font size="2"  >digoal=&gt;&nbsp;\timing on</font></span></div><div><font size="2"  >digoal=&gt; select count(distinct sex) from sex;</font></div><div><font size="2"  >&nbsp;count&nbsp;</font></div><div><font size="2"  >-------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;2</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >Time: 47254.221 ms</font></div><p></p></pre></div><div>测试SQL2</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select sex from sex t group by sex;</font></div><div><font size="2"  >&nbsp;sex&nbsp;</font></div><div><font size="2"  >-----</font></div><div><font size="2"  >&nbsp;w</font></div><div><font size="2"  >&nbsp;m</font></div><div><font size="2"  >(2 rows)</font></div><div><font size="2"  >Time: 6534.433 ms</font></div><p></p></pre></div><div>执行计划</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; explain select count(distinct sex) from sex;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >---------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Aggregate &nbsp;(cost=377385.25..377385.26 rows=1 width=2)</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;Seq Scan on sex &nbsp;(cost=0.00..327386.00 rows=19999700 width=2)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=&gt; explain select sex from sex t group by sex;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >-----------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;HashAggregate &nbsp;(cost=377385.25..377385.27 rows=2 width=2)</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;Seq Scan on sex t &nbsp;(cost=0.00..327386.00 rows=19999700 width=2)</font></div><p></p></pre></div><div><br></div><div>创建索引</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; create index idx_sex_1 on sex(sex);</font></div><div><font size="2"  >CREATE INDEX</font></div><div><font size="2"  >digoal=&gt; set enable_seqscan=off;</font></div><div><font size="2"  >SET</font></div><p></p></pre></div><div>使用索引后的执行计划, PostgreSQL可以使用Index Only Scan.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; explain select count(distinct sex) from sex;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >--------------------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Aggregate &nbsp;(cost=532235.01..532235.02 rows=1 width=2)</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;Index Only Scan using idx_sex_1 on sex &nbsp;(cost=0.00..482234.97 rows=20000016 width=2)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=&gt; explain select sex from sex t group by sex;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----------------------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Group &nbsp;(cost=0.00..532235.01 rows=2 width=2)</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;Index Only Scan using idx_sex_1 on sex t &nbsp;(cost=0.00..482234.97 rows=20000016 width=2)</font></div><p></p></pre></div><div>创建索引后SQL耗时</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select count(distinct sex) from sex;</font></div><div><font size="2"  >&nbsp;count&nbsp;</font></div><div><font size="2"  >-------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;2</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >Time: 49589.947 ms</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=&gt; select sex from sex t group by sex;</font></div><div><font size="2"  >&nbsp;sex&nbsp;</font></div><div><font size="2"  >-----</font></div><div><font size="2"  >&nbsp;m</font></div><div><font size="2"  >&nbsp;w</font></div><div><font size="2"  >(2 rows)</font></div><div><font size="2"  >Time: 6608.053 ms</font></div><p></p></pre></div><div><br></div><div>Oracle测试 :&nbsp;</div><div>测试表</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >SQL&gt; create table sex(sex char(1), otherinfo varchar2(64));</font></div><div><font size="2"  >Table created.</font></div><p></p></pre></div><div>测试数据</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >SQL&gt; insert into sex select 'm', rownum||'this is test' from dual connect by level &lt;=10000001;</font></div><div><font size="2"  >10000001 rows created.</font></div><div><font size="2"  >SQL&gt; commit;</font></div><div><font size="2"  >Commit complete.</font></div><div><font size="2"  >SQL&gt; insert into sex select 'w', rownum||'this is test' from dual connect by level &lt;=10000001;</font></div><div><font size="2"  >10000001 rows created.</font></div><div><font size="2"  >SQL&gt; commit;</font></div><div><font size="2"  >Commit complete.</font></div><p></p></pre></div><div>测试SQL1:</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >SQL&gt; set autotrace on</font></div><div><font size="2"  >SQL&gt; set timing on</font></div><div><font size="2"  >SQL&gt; select count(distinct sex) from sex;</font></div><div><font size="2"  >COUNT(DISTINCTSEX)</font></div><div><font size="2"  >------------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2</font></div><div><font size="2"  >Elapsed: 00:00:03.62</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Execution Plan</font></div><div><font size="2"  >----------------------------------------------------------</font></div><div><font size="2"  >Plan hash value: 2096505595</font></div><div><font size="2"  >---------------------------------------------------------------------------</font></div><div><font size="2"  >| Id &nbsp;| Operation &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| Name | Rows &nbsp;| Bytes | Cost (%CPU)| Time &nbsp; &nbsp; |</font></div><div><font size="2"  >---------------------------------------------------------------------------</font></div><div><font size="2"  >| &nbsp; 0 | SELECT STATEMENT &nbsp; | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; 1 | &nbsp; &nbsp; 3 | 13106 &nbsp; (3)| 00:02:38 |</font></div><div><font size="2"  >| &nbsp; 1 | &nbsp;SORT GROUP BY &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; 1 | &nbsp; &nbsp; 3 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|</font></div><div><font size="2"  >| &nbsp; 2 | &nbsp; TABLE ACCESS FULL| SEX &nbsp;| &nbsp; &nbsp;24M| &nbsp; &nbsp;69M| 13106 &nbsp; (3)| 00:02:38 |</font></div><div><font size="2"  >---------------------------------------------------------------------------</font></div><div><font size="2"  >Note</font></div><div><font size="2"  >-----</font></div><div><font size="2"  >&nbsp; &nbsp;- dynamic sampling used for this statement</font></div><div><font size="2"  >Statistics</font></div><div><font size="2"  >----------------------------------------------------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp;recursive calls</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp;db block gets</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; 74074 &nbsp;consistent gets</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp;physical reads</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp;redo size</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 525 &nbsp;bytes sent via SQL*Net to client</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 487 &nbsp;bytes received via SQL*Net from client</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 &nbsp;SQL*Net roundtrips to/from client</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 &nbsp;sorts (memory)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp;sorts (disk)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 &nbsp;rows processed</font></div><p></p></pre></div><div><br></div><div>测试SQL2</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >SQL&gt; select sex from sex t group by sex;</font></div><div><font size="2"  >S</font></div><div><font size="2"  >-</font></div><div><font size="2"  >w</font></div><div><font size="2"  >m</font></div><div><font size="2"  >Elapsed: 00:00:03.23</font></div><div><font size="2"  >Execution Plan</font></div><div><font size="2"  >----------------------------------------------------------</font></div><div><font size="2"  >Plan hash value: 2807610159</font></div><div><font size="2"  >---------------------------------------------------------------------------</font></div><div><font size="2"  >| Id &nbsp;| Operation &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| Name | Rows &nbsp;| Bytes | Cost (%CPU)| Time &nbsp; &nbsp; |</font></div><div><font size="2"  >---------------------------------------------------------------------------</font></div><div><font size="2"  >| &nbsp; 0 | SELECT STATEMENT &nbsp; | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;24M| &nbsp; &nbsp;69M| 14908 &nbsp;(14)| 00:02:59 |</font></div><div><font size="2"  >| &nbsp; 1 | &nbsp;HASH GROUP BY &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;24M| &nbsp; &nbsp;69M| 14908 &nbsp;(14)| 00:02:59 |</font></div><div><font size="2"  >| &nbsp; 2 | &nbsp; TABLE ACCESS FULL| SEX &nbsp;| &nbsp; &nbsp;24M| &nbsp; &nbsp;69M| 13106 &nbsp; (3)| 00:02:38 |</font></div><div><font size="2"  >---------------------------------------------------------------------------</font></div><div><font size="2"  >Note</font></div><div><font size="2"  >-----</font></div><div><font size="2"  >&nbsp; &nbsp;- dynamic sampling used for this statement</font></div><div><font size="2"  >Statistics</font></div><div><font size="2"  >----------------------------------------------------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp;recursive calls</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp;db block gets</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; 74074 &nbsp;consistent gets</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp;physical reads</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp;redo size</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 563 &nbsp;bytes sent via SQL*Net to client</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 487 &nbsp;bytes received via SQL*Net from client</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 &nbsp;SQL*Net roundtrips to/from client</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp;sorts (memory)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp;sorts (disk)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 &nbsp;rows processed</font></div><p></p></pre></div><div><br></div><div>创建索引</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >SQL&gt; create index idx_sex_1 on sex(sex);</font></div><div><font size="2"  >Index created.</font></div><div><font size="2"  >Elapsed: 00:00:33.40</font></div><p></p></pre></div><div>创建索引后的测试, 执行时间没有明显变化.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >SQL&gt; select count(distinct sex) from sex;</font></div><div><font size="2"  >COUNT(DISTINCTSEX)</font></div><div><font size="2"  >------------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2</font></div><div><font size="2"  >Elapsed: 00:00:04.32</font></div><div><font size="2"  >Execution Plan</font></div><div><font size="2"  >----------------------------------------------------------</font></div><div><font size="2"  >Plan hash value: 1805173869</font></div><div><font size="2"  >-----------------------------------------------------------------------------------</font></div><div><font size="2"  >| Id &nbsp;| Operation &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Name &nbsp; &nbsp; &nbsp;| Rows &nbsp;| Bytes | Cost (%CPU)| Time &nbsp; &nbsp; |</font></div><div><font size="2"  >-----------------------------------------------------------------------------------</font></div><div><font size="2"  >| &nbsp; 0 | SELECT STATEMENT &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; 1 | &nbsp; &nbsp; 3 | &nbsp;6465 &nbsp; (3)| 00:01:18 |</font></div><div><font size="2"  >| &nbsp; 1 | &nbsp;SORT GROUP BY &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; 1 | &nbsp; &nbsp; 3 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|</font></div><div><font size="2"  >| &nbsp; 2 | &nbsp; INDEX FAST FULL SCAN| IDX_SEX_1 | &nbsp; &nbsp;24M| &nbsp; &nbsp;69M| &nbsp;6465 &nbsp; (3)| 00:01:18 |</font></div><div><font size="2"  >-----------------------------------------------------------------------------------</font></div><div><font size="2"  >Note</font></div><div><font size="2"  >-----</font></div><div><font size="2"  >&nbsp; &nbsp;- dynamic sampling used for this statement</font></div><div><font size="2"  >Statistics</font></div><div><font size="2"  >----------------------------------------------------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5 &nbsp;recursive calls</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp;db block gets</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; 36421 &nbsp;consistent gets</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; 36300 &nbsp;physical reads</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp;redo size</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 525 &nbsp;bytes sent via SQL*Net to client</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 487 &nbsp;bytes received via SQL*Net from client</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 &nbsp;SQL*Net roundtrips to/from client</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 &nbsp;sorts (memory)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp;sorts (disk)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 &nbsp;rows processed</font></div><div><font size="2"  >SQL&gt; select sex from sex t group by sex;</font></div><div><font size="2"  >S</font></div><div><font size="2"  >-</font></div><div><font size="2"  >w</font></div><div><font size="2"  >m</font></div><div><font size="2"  >Elapsed: 00:00:03.21</font></div><div><font size="2"  >Execution Plan</font></div><div><font size="2"  >----------------------------------------------------------</font></div><div><font size="2"  >Plan hash value: 2807610159</font></div><div><font size="2"  >---------------------------------------------------------------------------</font></div><div><font size="2"  >| Id &nbsp;| Operation &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| Name | Rows &nbsp;| Bytes | Cost (%CPU)| Time &nbsp; &nbsp; |</font></div><div><font size="2"  >---------------------------------------------------------------------------</font></div><div><font size="2"  >| &nbsp; 0 | SELECT STATEMENT &nbsp; | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;24M| &nbsp; &nbsp;69M| 14908 &nbsp;(14)| 00:02:59 |</font></div><div><font size="2"  >| &nbsp; 1 | &nbsp;HASH GROUP BY &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;24M| &nbsp; &nbsp;69M| 14908 &nbsp;(14)| 00:02:59 |</font></div><div><font size="2"  >| &nbsp; 2 | &nbsp; TABLE ACCESS FULL| SEX &nbsp;| &nbsp; &nbsp;24M| &nbsp; &nbsp;69M| 13106 &nbsp; (3)| 00:02:38 |</font></div><div><font size="2"  >---------------------------------------------------------------------------</font></div><div><font size="2"  >Note</font></div><div><font size="2"  >-----</font></div><div><font size="2"  >&nbsp; &nbsp;- dynamic sampling used for this statement</font></div><div><font size="2"  >Statistics</font></div><div><font size="2"  >----------------------------------------------------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5 &nbsp;recursive calls</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp;db block gets</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; 74170 &nbsp;consistent gets</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp;physical reads</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp;redo size</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 563 &nbsp;bytes sent via SQL*Net to client</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 487 &nbsp;bytes received via SQL*Net from client</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 &nbsp;SQL*Net roundtrips to/from client</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp;sorts (memory)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp;sorts (disk)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 &nbsp;rows processed</font></div><p></p></pre></div></div><div><br></div><div>对比以上测试, Oracle的性能要明显优于PostgreSQL.</div><div>将count(distinct sex)修改如下后PostgreSQL的执行速度有明显改善, 但是性能还是低于Oracle一截, 约一半.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select count(*) from (select sex from sex t group by sex) t;</font></div><div><font size="2"  >&nbsp;count&nbsp;</font></div><div><font size="2"  >-------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;2</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >Time: 6231.965 ms</font></div><p></p></pre></div><div><br></div><div>那么如何优化呢?</div><div>在PostgreSQL中的递归SQL在这里就派上大用场了, 结合btree索引扫描. 性能可以提升几万倍.</div><div>来看如下优化过程 :&nbsp;</div><div>创建测试表 :&nbsp;</div><div><pre class="prettyprint"  ><p><font size="2"  >create table user_download_log (user_id int not null, listid int not null, apkid int not null, get_time timestamp(0) not null, otherinfo text);</font></p></pre></div><div>插入测试数据</div><div><pre class="prettyprint"  ><p><font size="2"  >insert into user_download_log select generate_series(0,10000000),generate_series(0,10000000),generate_series(0,10000000),generate_series(clock_timestamp(),clock_timestamp()+interval '10000000 min',interval '1 min'), 'this is test';</font></p></pre></div><div>创建索引 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create index i1 on user_download_log (user_id);</font></div><div><font size="2"  >create index i2 on user_download_log (otherinfo);</font></div><p></p></pre></div><div>查看数据分布 :&nbsp;</div><div>用来说明递归SQL适合哪种场景的优化.</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >select count(distinct user_id), count(distinct otherinfo) from user_download_log;</font></div></div><div><div><font size="2"  >&nbsp; count &nbsp; | count&nbsp;</font></div><div><font size="2"  >----------+-------</font></div><div><font size="2"  >&nbsp;10000001 | &nbsp; &nbsp; 1</font></div></div><p></p></pre></div></div><div>查看未优化时以下SQL的执行计划以及耗时.</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; explain analyze select count(distinct otherinfo) from user_download_log;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >----</font></div><div><font size="2"  >&nbsp;Aggregate &nbsp;(cost=208334.36..208334.37 rows=1 width=13) (actual time=6295.493..6295.494 rows=1 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;Seq Scan on user_download_log &nbsp;(cost=0.00..183334.29 rows=10000029 width=13) (actual time=0.014..1612.333 rows=10000001 loops</font></div><div><font size="2"  >=1)</font></div><div><font size="2"  >&nbsp;Total runtime: 6295.550 ms</font></div><p></p></pre></div><div>优化后的SQL :&nbsp;</div></div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; with recursive skip as (</font></div><div><font size="2"  >digoal(&gt; &nbsp; (</font></div><div><font size="2"  >digoal(&gt; &nbsp; &nbsp; select min(t.otherinfo) as otherinfo from user_download_log t where t.otherinfo is not null</font></div><div><font size="2"  >digoal(&gt; &nbsp; )</font></div><div><font size="2"  >digoal(&gt; &nbsp; union all</font></div><div><font size="2"  >digoal(&gt; &nbsp; (</font></div><div><font size="2"  >digoal(&gt; &nbsp; &nbsp; select (select min(t.otherinfo) from user_download_log t where t.otherinfo &gt; s.otherinfo and t.otherinfo is not null)&nbsp;</font></div><div><font size="2"  >digoal(&gt; &nbsp; &nbsp; &nbsp; from skip s where s.otherinfo is not null</font></div><div><font size="2"  >digoal(&gt; &nbsp; ) &nbsp;-- 这里的where s.otherinfo is not null 一定要加,否则就死循环了.</font></div><div><font size="2"  >digoal(&gt; )&nbsp;</font></div><div><font size="2"  >digoal-&gt; select count(distinct otherinfo) from skip;</font></div><div><font size="2"  >&nbsp;count&nbsp;</font></div><div><font size="2"  >-------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>优化后的SQL执行计划以及耗时, 性能提升了36390倍, 相比Oracle也提升了上万倍.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; explain analyze with recursive skip as (</font></div><div><font size="2"  >&nbsp; (</font></div><div><font size="2"  >&nbsp; &nbsp; select min(t.otherinfo) as otherinfo from user_download_log t where t.otherinfo is not null</font></div><div><font size="2"  >&nbsp; )</font></div><div><font size="2"  >&nbsp; union all</font></div><div><font size="2"  >&nbsp; (</font></div><div><font size="2"  >&nbsp; &nbsp; select (select min(t.otherinfo) from user_download_log t where t.otherinfo &gt; s.otherinfo and t.otherinfo is not null)&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; from skip s where s.otherinfo is not null</font></div><div><font size="2"  >&nbsp; ) &nbsp;-- 这里的where s.otherinfo is not null 一定要加,否则就死循环了.</font></div><div><font size="2"  >)&nbsp;</font></div><div><font size="2"  >select count(distinct otherinfo) from skip;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >-----------------------------------------</font></div><div><font size="2"  >&nbsp;Aggregate &nbsp;(cost=10.55..10.56 rows=1 width=32) (actual time=0.094..0.094 rows=1 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp;CTE skip</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;-&gt; &nbsp;Recursive Union &nbsp;(cost=0.03..8.28 rows=101 width=32) (actual time=0.044..0.073 rows=2 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Result &nbsp;(cost=0.03..0.04 rows=1 width=0) (actual time=0.042..0.042 rows=1 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;InitPlan 1 (returns $1)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Limit &nbsp;(cost=0.00..0.03 rows=1 width=13) (actual time=0.038..0.039 rows=1 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Only Scan using i2 on user_download_log t &nbsp;(cost=0.00..296844.61 rows=10000029 width=13) (actual&nbsp;</font></div><div><font size="2"  >time=0.037..0.037 rows=1 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (otherinfo IS NOT NULL)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Heap Fetches: 1</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;WorkTable Scan on skip s &nbsp;(cost=0.00..0.62 rows=10 width=32) (actual time=0.013..0.013 rows=0 loops=2)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (otherinfo IS NOT NULL)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Rows Removed by Filter: 0</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SubPlan 3</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Result &nbsp;(cost=0.03..0.04 rows=1 width=0) (actual time=0.018..0.018 rows=1 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;InitPlan 2 (returns $3)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Limit &nbsp;(cost=0.00..0.03 rows=1 width=13) (actual time=0.017..0.017 rows=0 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Only Scan using i2 on user_download_log t &nbsp;(cost=0.00..107284.96 rows=3333343 width=13) (</font></div><div><font size="2"  >actual time=0.015..0.015 rows=0 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: ((otherinfo &gt; s.otherinfo) AND (otherinfo IS NOT NULL))</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Heap Fetches: 0</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;CTE Scan on skip &nbsp;(cost=0.00..2.02 rows=101 width=32) (actual time=0.047..0.077 rows=2 loops=1)</font></div><div><font size="2"  >&nbsp;Total runtime: 0.173 ms</font></div><div><font size="2"  >(21 rows)</font></div><p></p></pre></div></div><div><br></div><div>换一个字段, 数据分布广泛的字段上使用以上优化方法, 看是否妥当, 以下是原始SQL的执行计划以及耗时 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; explain analyze select count(distinct user_id) from user_download_log;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp;</font></div><div><font size="2"  >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >---</font></div><div><font size="2"  >&nbsp;Aggregate &nbsp;(cost=208334.36..208334.37 rows=1 width=4) (actual time=4008.858..4008.858 rows=1 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;Seq Scan on user_download_log &nbsp;(cost=0.00..183334.29 rows=10000029 width=4) (actual time=0.014..1606.607 rows=10000001 loops=</font></div><div><font size="2"  >1)</font></div><div><font size="2"  >&nbsp;Total runtime: 4008.916 ms</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"  >换一个字段, 数据分布广泛的字段上使用以上优化方法, 看是否妥当, 以下是采用递归SQL后的执行计划以及耗时 :&nbsp;</span></div><div><span style="line-height: 22px;"  >显然性能是下降的, 所以使用递归SQL不适合数据分布广泛的字段的group by或者count(distinct)操作.</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; explain analyze with recursive skip as (</font></div><div><font size="2"  >&nbsp; (</font></div><div><font size="2"  >&nbsp; &nbsp; select min(t.user_id) as user_id from user_download_log t where t.user_id is not null</font></div><div><font size="2"  >&nbsp; )</font></div><div><font size="2"  >&nbsp; union all</font></div><div><font size="2"  >&nbsp; (</font></div><div><font size="2"  >&nbsp; &nbsp; select (select min(t.user_id) from user_download_log t where t.user_id &gt; s.user_id and t.user_id is not null)&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; from skip s where s.user_id is not null</font></div><div><font size="2"  >&nbsp; ) &nbsp;-- 这里的where s.user_id is not null 一定要加,否则就死循环了.</font></div><div><font size="2"  >)&nbsp;</font></div><div><font size="2"  >select count(distinct user_id) from skip;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >-----------------------------------------------</font></div><div><font size="2"  >&nbsp;Aggregate &nbsp;(cost=10.44..10.45 rows=1 width=4) (actual time=186741.338..186741.339 rows=1 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp;CTE skip</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;-&gt; &nbsp;Recursive Union &nbsp;(cost=0.03..8.17 rows=101 width=4) (actual time=0.047..178296.238 rows=10000002 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Result &nbsp;(cost=0.03..0.04 rows=1 width=0) (actual time=0.046..0.046 rows=1 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;InitPlan 1 (returns $1)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Limit &nbsp;(cost=0.00..0.03 rows=1 width=4) (actual time=0.042..0.042 rows=1 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Only Scan using i1 on user_download_log t &nbsp;(cost=0.00..285759.50 rows=10000029 width=4) (actual t</font></div><div><font size="2"  >ime=0.040..0.040 rows=1 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (user_id IS NOT NULL)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Heap Fetches: 1</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;WorkTable Scan on skip s &nbsp;(cost=0.00..0.61 rows=10 width=4) (actual time=0.017..0.017 rows=1 loops=10000002)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (user_id IS NOT NULL)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Rows Removed by Filter: 0</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SubPlan 3</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Result &nbsp;(cost=0.03..0.04 rows=1 width=0) (actual time=0.016..0.016 rows=1 loops=10000001)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;InitPlan 2 (returns $3)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Limit &nbsp;(cost=0.00..0.03 rows=1 width=4) (actual time=0.015..0.015 rows=1 loops=10000001)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Only Scan using i1 on user_download_log t &nbsp;(cost=0.00..103588.85 rows=3333343 width=4) (a</font></div><div><font size="2"  >ctual time=0.014..0.014 rows=1 loops=10000001)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: ((user_id &gt; s.user_id) AND (user_id IS NOT NULL))</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Heap Fetches: 10000000</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;CTE Scan on skip &nbsp;(cost=0.00..2.02 rows=101 width=4) (actual time=0.050..183449.391 rows=10000002 loops=1)</font></div><div><font size="2"  >&nbsp;Total runtime: 186909.323 ms</font></div><div><font size="2"  >(21 rows)</font></div><div><font size="2"  >Time: 186910.482 ms</font></div><p></p></pre></div><div><br></div><div>以下是同样的数据结构以及测试数据在Oracle下的测试.</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >oracle@db1-&gt; sqlplus "/ as sysdba"</font></div><div><font size="2"  >SQL*Plus: Release 10.2.0.4.0 - Production on Mon Oct 8 17:28:58 2012</font></div><div><font size="2"  >Copyright (c) 1982, 2007, Oracle. &nbsp;All Rights Reserved.</font></div><div><font size="2"  >Connected to:</font></div><div><font size="2"  >Oracle Database 10g Enterprise Edition Release 10.2.0.4.0 - 64bit Production</font></div><div><font size="2"  >With the Partitioning, OLAP, Data Mining and Real Application Testing options</font></div></div><div><div><font size="2"  >SQL&gt; create table test (id int, otherinfo varchar2(32)) nologging;</font></div><div><font size="2"  >Table created.</font></div><div><font size="2"  >SQL&gt; insert into test select rownum,'this is test' from dual connect by level &lt;=10000001;</font></div><div><font size="2"  >10000001 rows created.</font></div><div><font size="2"  >SQL&gt; commit;</font></div></div><div><font size="2"  >SQL&gt; create index i1 on test(id);</font></div><div><font size="2"  >SQL&gt; create index i2 on test(otherinfo);</font></div><div><font size="2"  >SQL&gt; explain plan for select count(distinct id) from test;</font></div><div><div><font size="2"  >Explained.</font></div><div><font size="2"  >SQL&gt; select * from table(dbms_xplan.display());</font></div><div><font size="2"  >PLAN_TABLE_OUTPUT</font></div><div><font size="2"  >--------------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >Plan hash value: 1403727100</font></div><div><font size="2"  >------------------------------------------------------------------------------</font></div><div><font size="2"  >| Id &nbsp;| Operation &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Name | Rows &nbsp;| Bytes | Cost (%CPU)| Time &nbsp; &nbsp; |</font></div><div><font size="2"  >------------------------------------------------------------------------------</font></div><div><font size="2"  >| &nbsp; 0 | SELECT STATEMENT &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; 1 | &nbsp; &nbsp;13 | &nbsp;4178 &nbsp; (3)| 00:00:51 |</font></div><div><font size="2"  >| &nbsp; 1 | &nbsp;SORT GROUP BY &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; 1 | &nbsp; &nbsp;13 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|</font></div><div><font size="2"  >| &nbsp; 2 | &nbsp; INDEX FAST FULL SCAN| I1 &nbsp; | &nbsp;9834K| &nbsp; 121M| &nbsp;4178 &nbsp; (3)| 00:00:51 |</font></div><div><font size="2"  >------------------------------------------------------------------------------</font></div><div><font size="2"  >Note</font></div><div><font size="2"  >-----</font></div><div><font size="2"  >&nbsp; &nbsp;- dynamic sampling used for this statement</font></div><div><font size="2"  >13 rows selected.</font></div><div><font size="2"  >SQL&gt; explain plan for select count(distinct otherinfo) from test;</font></div><div><font size="2"  >Explained.</font></div><div><font size="2"  >SQL&gt; select * from table(dbms_xplan.display());</font></div><div><font size="2"  >PLAN_TABLE_OUTPUT</font></div><div><font size="2"  >--------------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >Plan hash value: 2603667166</font></div><div><font size="2"  >---------------------------------------------------------------------------</font></div><div><font size="2"  >| Id &nbsp;| Operation &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| Name | Rows &nbsp;| Bytes | Cost (%CPU)| Time &nbsp; &nbsp; |</font></div><div><font size="2"  >---------------------------------------------------------------------------</font></div><div><font size="2"  >| &nbsp; 0 | SELECT STATEMENT &nbsp; | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; 1 | &nbsp; &nbsp;18 | &nbsp;5837 &nbsp; (3)| 00:01:11 |</font></div><div><font size="2"  >| &nbsp; 1 | &nbsp;SORT GROUP BY &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; 1 | &nbsp; &nbsp;18 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|</font></div><div><font size="2"  >| &nbsp; 2 | &nbsp; TABLE ACCESS FULL| TEST | &nbsp;9834K| &nbsp; 168M| &nbsp;5837 &nbsp; (3)| 00:01:11 |</font></div><div><font size="2"  >---------------------------------------------------------------------------</font></div><div><font size="2"  >Note</font></div><div><font size="2"  >-----</font></div><div><font size="2"  >&nbsp; &nbsp;- dynamic sampling used for this statement</font></div><div><font size="2"  >13 rows selected.</font></div></div><div><font size="2"  >SQL&gt; set timing on</font></div><div><div><font size="2"  >SQL&gt; select count(distinct otherinfo) from test;</font></div><div><font size="2"  >COUNT(DISTINCTOTHERINFO)</font></div><div><font size="2"  >------------------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"  >Elapsed: 00:00:02.49</font></div><div><font size="2"  >SQL&gt; select count(distinct id) from test;</font></div><div><font size="2"  >COUNT(DISTINCTID)</font></div><div><font size="2"  >-----------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;10000001</font></div><div><font size="2"  >Elapsed: 00:00:07.13</font></div></div><p></p></pre></div><div>从执行耗时可以看出PostgreSQL在数据分布稀疏的字段上使用递归SQL优化后的性能相比Oracle有41213倍的性能提升.</div><div><br></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >【其他】</span></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >-- 递归查询中不允许使用聚合函数 :&nbsp;</span></div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >with recursive skip as (</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; (</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; select min(t.otherinfo) as otherinfo from user_download_log t where t.otherinfo is not null</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; )</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; union all</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; (</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; select min(t.otherinfo) from user_download_log t, skip s&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; &nbsp; where t.otherinfo &gt; s.otherinfo&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; &nbsp; and t.otherinfo is not null</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; &nbsp; and s.otherinfo is not null</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; ) &nbsp;-- 这里的where s.otherinfo is not null 一定要加,否则就死循环了.</font></div><div style="line-height: 22px;"  ><font size="2"  >)&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  >select * from skip;</font></div><div style="line-height: 22px;"  ><font size="2"  >ERROR: &nbsp;aggregate functions not allowed in a recursive query's recursive term</font></div><div style="line-height: 22px;"  ><font size="2"  >LINE 7: &nbsp; &nbsp; select min(t.otherinfo) from user_download_log t, skip s...</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div style="line-height: 22px;"  ><font size="2"  >Time: 0.581 ms</font></div><p></p></pre></div><div style="line-height: 22px;"  >-- 修改如下 :&nbsp;</div></div></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >with recursive skip as (</font></div><div><font size="2"  >&nbsp; (</font></div><div><font size="2"  >&nbsp; &nbsp; select min(t.otherinfo) as otherinfo from user_download_log t where t.otherinfo is not null</font></div><div><font size="2"  >&nbsp; )</font></div><div><font size="2"  >&nbsp; union all</font></div><div><font size="2"  >&nbsp; (</font></div><div><font size="2"  >&nbsp; &nbsp; select (select min(t.otherinfo) from user_download_log t where t.otherinfo &gt; s.otherinfo and t.otherinfo is not null)&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; from skip s where s.otherinfo is not null</font></div><div><font size="2"  >&nbsp; ) &nbsp;-- 这里的where s.otherinfo is not null 一定要加,否则就死循环了.</font></div><div><font size="2"  >)&nbsp;</font></div><div><font size="2"  >select * from skip;</font></div><p></p></pre></div></div>【补充】<div>细心的朋友发现Oracle测试中未对表进行分析, 以下是分析后的结果, 执行计划无变化 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >SQL&gt; analyze table sex estimate statistics for all columns sample 10 percent;</font></div><div><font size="2"  >Table analyzed.</font></div><div><font size="2"  >SQL&gt; analyze index idx_sex_1 estimate statistics sample 10 percent;<br>Index analyzed.</font></div><div><font size="2"  >SQL&gt; select sex from sex t group by sex;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >S</font></div><div><font size="2"  >-</font></div><div><font size="2"  >w</font></div><div><font size="2"  >m</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Elapsed: 00:00:03.17</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Execution Plan</font></div><div><font size="2"  >----------------------------------------------------------</font></div><div><font size="2"  >Plan hash value: 2807610159</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >---------------------------------------------------------------------------</font></div><div><font size="2"  >| Id &nbsp;| Operation &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| Name | Rows &nbsp;| Bytes | Cost (%CPU)| Time &nbsp; &nbsp; |</font></div><div><font size="2"  >---------------------------------------------------------------------------</font></div><div><font size="2"  >| &nbsp; 0 | SELECT STATEMENT &nbsp; | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; 2 | &nbsp; &nbsp; 2 | 14519 &nbsp;(12)| 00:02:55 |</font></div><div><font size="2"  >| &nbsp; 1 | &nbsp;HASH GROUP BY &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; 2 | &nbsp; &nbsp; 2 | 14519 &nbsp;(12)| 00:02:55 |</font></div><div><font size="2"  >| &nbsp; 2 | &nbsp; TABLE ACCESS FULL| SEX &nbsp;| &nbsp; &nbsp;20M| &nbsp; &nbsp;19M| 13062 &nbsp; (2)| 00:02:37 |</font></div><div><font size="2"  >---------------------------------------------------------------------------</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Statistics</font></div><div><font size="2"  >----------------------------------------------------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 &nbsp;recursive calls</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp;db block gets</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; 74074 &nbsp;consistent gets</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp;physical reads</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp;redo size</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 563 &nbsp;bytes sent via SQL*Net to client</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 487 &nbsp;bytes received via SQL*Net from client</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 &nbsp;SQL*Net roundtrips to/from client</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp;sorts (memory)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp;sorts (disk)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 &nbsp;rows processed</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >SQL&gt; select count(distinct sex) from sex;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >COUNT(DISTINCTSEX)</font></div><div><font size="2"  >------------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Elapsed: 00:00:03.85</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Execution Plan</font></div><div><font size="2"  >----------------------------------------------------------</font></div><div><font size="2"  >Plan hash value: 1805173869</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >-----------------------------------------------------------------------------------</font></div><div><font size="2"  >| Id &nbsp;| Operation &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Name &nbsp; &nbsp; &nbsp;| Rows &nbsp;| Bytes | Cost (%CPU)| Time &nbsp; &nbsp; |</font></div><div><font size="2"  >-----------------------------------------------------------------------------------</font></div><div><font size="2"  >| &nbsp; 0 | SELECT STATEMENT &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; 1 | &nbsp; &nbsp; 1 | &nbsp;6454 &nbsp; (3)| 00:01:18 |</font></div><div><font size="2"  >| &nbsp; 1 | &nbsp;SORT GROUP BY &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; 1 | &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|</font></div><div><font size="2"  >| &nbsp; 2 | &nbsp; INDEX FAST FULL SCAN| IDX_SEX_1 | &nbsp; &nbsp;20M| &nbsp; &nbsp;19M| &nbsp;6454 &nbsp; (3)| 00:01:18 |</font></div><div><font size="2"  >-----------------------------------------------------------------------------------</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Statistics</font></div><div><font size="2"  >----------------------------------------------------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 &nbsp;recursive calls</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp;db block gets</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; 36325 &nbsp;consistent gets</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp;physical reads</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp;redo size</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 525 &nbsp;bytes sent via SQL*Net to client</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 487 &nbsp;bytes received via SQL*Net from client</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 &nbsp;SQL*Net roundtrips to/from client</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 &nbsp;sorts (memory)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp;sorts (disk)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 &nbsp;rows processed</font></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>