<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL XLOG fsync simple introduce</h2>
	<h5 id="">2012-10-16 10:34:19&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201291575523922/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>一、where is the tuples? datafile, blocks.</div><div>从上到下的顺序查找.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >1. PostgreSQL shared buffer</font></div><div><font size="2"  >2. OS FileSystem cache</font></div><div><font size="2"  >3. storage cache(raid card or controller's cache)</font></div><div><font size="2"  >4. disk cache (almost disabled)</font></div><div><font size="2"  >5. disk</font></div><p></p></pre></div><div>二、How point to tuples?</div><div><pre class="prettyprint"  ><p><font size="2"  >Index(optional) &nbsp;-&gt; &nbsp;Heap page -&gt; itemid -&gt; item(tuple).</font></p></pre></div><div>三、which tuples can be saw by client? must satisfied two factors below at the same time.</div><pre class="prettyprint"  ><p><font size="2"  >1. xmin , xmax in tuple. -- client can see the tuples xid before the client's xid or database's current xid.<wbr></font></p><div><font size="2"  >2. transaction (xmin or xmax) status (t_infomask). -- client can see tuples has been commited success.</font></div><p></p></pre><div><span style="line-height: 22px;"  >后面将举例</span>使用pageinspect来举例说明这两点.</div><div><br></div><div>四、transaction Durable(ACID - Durable) :&nbsp;</div><div>async commit &amp; sync commit</div><div><pre class="prettyprint"  ><p><font size="2"  >1. the transaction's redo info (xlog buffer) fsynced to disk .&nbsp;</font></p></pre></div><div>后面将举例使用strace 跟踪系统接口write和<span style="line-height: 22px;"  >fsync的</span>调用.</div><div><br></div><div>五、which process does "wal fsync"?</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >1. wal writer process</font></div><div><font size="2"  >2. backend process</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >后面将举例</span><span style="line-height: 22px;"  >使用strace 跟踪系统接口write和</span><span style="line-height: 22px;"  >fsync的</span><span style="line-height: 22px;"  >调用.</span></div><div><br></div><div>六、WAL fsync parameters</div><div><a rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/runtime-config-wal.html#RUNTIME-CONFIG-WAL-SETTINGS"  >http://www.postgresql.org/docs/9.2/static/runtime-config-wal.html#RUNTIME-CONFIG-WAL-SETTINGS</a></div><div><br></div><div>举例 :&nbsp;</div><div>1. pageinspect的例子, 观察xmin, xmax, t_infomask的值. t_infomask的值见参考部分.</div><div>安装postgresql, 这里使用PostgreSQL 9.3, 从github上下载.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >useradd pgdev</font></div><div><font size="2"  >vi /home/pgdev/.bash_profile</font></div><div><div><font size="2"  >export PS1="$USER@`/bin/hostname -s`-&gt; "</font></div><div><font size="2"  >export PGPORT=9300</font></div><div><font size="2"  >export PGUSER=postgres</font></div><div><font size="2"  >export PGDATA=/data04/pgdev/pg_root</font></div><div><font size="2"  >export LANG=en_US.utf8</font></div><div><font size="2"  >export PGHOME=/home/pgdev/pgsql9.3</font></div><div><font size="2"  >export PGHOST=$PGDATA</font></div><div><font size="2"  >export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib</font></div><div><font size="2"  >export DATE=`date +"%Y%m%d%H%M"`</font></div><div><font size="2"  >export PATH=$PGHOME/bin:$PATH:.</font></div><div><font size="2"  >export MANPATH=$PGHOME/share/man:$MANPATH</font></div><div><font size="2"  >alias rm='rm -i'</font></div><div><font size="2"  >alias ll='ls -lh'</font></div></div><div><font size="2"  ><br></font></div><div><div><font size="2"  >wget https://nodeload.github.com/postgres/postgres/zipball/master</font></div><div><font size="2"  >unzip postgresql-snapshot.zip</font></div><div><font size="2"  >cd postgresql</font></div><div><font size="2"  >./configure --prefix=/home/pgdev/pgsql9.3 --with-pgport=9300 --with-perl --with-python --with-tcl --with-openssl --with-pam--without-ldap --with-libxml --with-libxslt --enable-thread-safety --with-wal-blocksize=16 --enable-debug &amp;&amp; gmake</font></div><div><font size="2"  >gmake install</font></div><div><font size="2"  >cd postgresql/contrib/pageinspect</font></div><div><font size="2"  >. /home/pgdev/.bash_profile</font></div><div><font size="2"  >gmake</font></div><div><font size="2"  >gmake install</font></div><div><font size="2"  >su - pgdev</font></div><div><font size="2"  >initdb</font></div></div><p></p></pre></div><div><div>创建测试库, 表.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# create role digoal nosuperuser nocreatedb nocreaterole noinherit login encrypted password 'DIGOAL';</font></div><div><font size="2"  >CREATE ROLE</font></div><div><font size="2"  >postgres=# create database digoal with owner digoal;</font></div><div><font size="2"  >CREATE DATABASE</font></div><div><font size="2"  >postgres=# \c digoal postgres</font></div><div><font size="2"  >You are now connected to database "digoal" as user "postgres".</font></div><div><font size="2"  >digoal=# create extension pageinspect;</font></div><div><font size="2"  >CREATE EXTENSION</font></div><div><font size="2"  >digoal=# \c digoal digoal</font></div><div><font size="2"  >You are now connected to database "digoal" as user "digoal".</font></div><div><font size="2"  >digoal=&gt; create schema digoal ;</font></div><div><font size="2"  >CREATE SCHEMA</font></div><div><font size="2"  >digoal=&gt; create table t (id serial primary key, info text);</font></div><div><font size="2"  >CREATE TABLE</font></div><p></p></pre></div><div>使用pageinspect对heap信息讲解 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; insert into t(info) values ('digoal');</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=&gt; select ctid,* from t;</font></div><div><font size="2"  >&nbsp;ctid &nbsp;| id | &nbsp;info &nbsp;</font></div><div><font size="2"  >-------+----+--------</font></div><div><font size="2"  >&nbsp;(0,1) | &nbsp;1 | digoal</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >digoal=&gt; \c digoal postgres</font></div><div><font size="2"  >You are now connected to database "digoal" as user "postgres".</font></div><div><font size="2"  >digoal=# select * from heap_page_items(get_raw_page('digoal.t',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 35 | &nbsp; 1746 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2306 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>信息 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >lp = 1 ( 对应 ctid(0,1) 里面的 1 )</font></div><div><font size="2"  >t_infomask = 2306 ( = 0x0902 = 0x0002 + 0x0100 + 0x0800 )</font></div><div><font size="2"  >HEAP_HASVARWIDTH 0x0002</font></div><div><font size="2"  >HEAP_XMIN_COMMITTED 0x0100</font></div><div><font size="2"  >HEAP_XMAX_INVALID 0x0800</font></div><div><font size="2"  >t_xmin = 1746</font></div><div><font size="2"  >t_xmax = 0</font></div><p></p></pre></div><div>解释 :&nbsp;</div><div>这条记录的t_infomax由3个值相加得到, 分别是HEAP_HASVARWIDTH,HEAP_XMIN_COMMITTED,HEAP_XMAX_INVALID. 表示这条记录的xmin已经提交, 同时xmax无效, 表示是新插入的记录. HEAP_HASVARWIDTH表示这条记录有变长字段.</div><div>所以这条记录能被后起的会话(分配了更新的xid的会话)看见. 如下(xid = 1747, 较t_xmin=1746 更新) :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# select txid_current();</font></div><div><font size="2"  >&nbsp;txid_current&nbsp;</font></div><div><font size="2"  >--------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1747</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >digoal=# select * from digoal.t;</font></div><div><font size="2"  >&nbsp;id | &nbsp;info &nbsp;</font></div><div><font size="2"  >----+--------</font></div><div><font size="2"  >&nbsp; 1 | digoal</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div><div>接下来举一个插入并回滚的例子 :&nbsp;</div><div>session 1:</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# begin;</font></div><div><font size="2"  >BEGIN</font></div><div><font size="2"  >digoal=# insert into digoal.t(info) values('rollback');</font></div><div><font size="2"  >INSERT 0 1</font></div><p></p></pre></div><div><br></div><div>session 2:</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# select txid_current();</font></div><div><font size="2"  >&nbsp;txid_current&nbsp;</font></div><div><font size="2"  >--------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1749</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >digoal=# select * from heap_page_items(get_raw_page('digoal.t',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 35 | &nbsp; 1746 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2306 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 2 | &nbsp; 8112 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 37 | &nbsp; 1748 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2050 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(2 rows)</font></div><p></p></pre></div><div>注意, 使用pageinspect分析的是块信息, 所以能见度较高, 无视xmin,xmax. 这里看到了会话1新插入的行. 信息如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >lp = 2 ( 对应 ctid(0,2) 里面的 2 )</font></div><div><font size="2"  >t_infomask = 2050 ( = 0x0802 = 0x0002 + 0x0800 )</font></div><div><font size="2"  >HEAP_HASVARWIDTH 0x0002</font></div><div><font size="2"  >HEAP_XMAX_INVALID 0x0800</font></div><div><font size="2"  >t_xmin = 1748</font></div><div><font size="2"  >t_xmax = 0</font></div><p></p></pre></div><div>从以上信息可以分析, 这条记录的事务号是1748. 当前这个tuple的事务还未提交, 因为少了HEAP_XMIN_COMMITTED标记.</div><div>所以即使会话2的txid比会话1更新, 也看不到这条记录 (这个和事务隔离级别有关, PostgreSQL最低事务隔离级别=read committed)</div><div>所以在会话2中现在看不到这条记录.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# select * from digoal.t;</font></div><div><font size="2"  >&nbsp;id | &nbsp;info &nbsp;</font></div><div><font size="2"  >----+--------</font></div><div><font size="2"  >&nbsp; 1 | digoal</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div><div>session 1:</div><div>回滚 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# rollback;</font></div><div><font size="2"  >ROLLBACK</font></div><p></p></pre></div><div><br></div><div>session 2:</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# select * from heap_page_items(get_raw_page('digoal.t',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 35 | &nbsp; 1746 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,1) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2306 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 2 | &nbsp; 8112 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 37 | &nbsp; 1748 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2050 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(2 rows)</font></div><p></p></pre></div><div>PostgreSQL的回滚操作非常迅速, 从heap_page_items得到的信息中也可以验证, 显然, 回滚时, 数据块没有变化. 这条记录的t_infomask维持0x0802.&nbsp;</div><div><br></div><div>接下来举一个更新的例子 :&nbsp;</div><div>session 1:</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# begin;</font></div><div><font size="2"  >BEGIN</font></div><div><font size="2"  >digoal=# update digoal.t set info='new' where id=1;</font></div><div><font size="2"  >UPDATE 1</font></div><p></p></pre></div><div><br></div><div>session 2:</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# select * from heap_page_items(get_raw_page('digoal.t',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 35 | &nbsp; 1746 | &nbsp; 1750 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,3) &nbsp;| &nbsp; &nbsp; &nbsp; 16386 | &nbsp; &nbsp; &nbsp; &nbsp;258 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 2 | &nbsp; 8112 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 37 | &nbsp; 1748 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2050 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 3 | &nbsp; 8080 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 32 | &nbsp; 1750 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,3) &nbsp;| &nbsp; &nbsp; &nbsp; 32770 | &nbsp; &nbsp; &nbsp;10242 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(3 rows)</font></div><p></p></pre></div><div>解释:</div><div>ctid=(0,1)的记录t_xmax变成了1750, t_infomask变成258 = 0x0102 (HEAP_HASVARWIDTH, HEAP_XMIN_COMMITTED) 说明此时xmin和xmax都是有效的, 但是xmax还未提交. 因此其他会话能看到ctid=(0,1)这条. t_ctid=(0,3), 表示这条记录同时指向ctid=(0,3)的记录.</div><div><br></div><div>同时新增了ctid=(0,3)的记录, t_xmin=1750, t_infomask = 10242 = 0x2802 (HEAP_UPDATED, HEAP_XMAX_INVALID, HEAP_HASVARWIDTH) 说明这条记录的xmin是有效的, 但是还未提交.</div><div><br></div><div>session 1:</div><div><pre class="prettyprint"  ><p><font size="2"  >COMMIT;</font></p></pre></div><div><br></div><div>session 2:</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# select * from digoal.t;</font></div><div><font size="2"  >&nbsp;id | info&nbsp;</font></div><div><font size="2"  >----+------</font></div><div><font size="2"  >&nbsp; 1 | new</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >digoal=# select * from heap_page_items(get_raw_page('digoal.t',0));</font></div><div><font size="2"  >&nbsp;lp | lp_off | lp_flags | lp_len | t_xmin | t_xmax | t_field3 | t_ctid | t_infomask2 | t_infomask | t_hoff | t_bits | t_oid&nbsp;</font></div><div><font size="2"  >----+--------+----------+--------+--------+--------+----------+--------+-------------+------------+--------+--------+-------</font></div><div><font size="2"  >&nbsp; 1 | &nbsp; 8152 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 35 | &nbsp; 1746 | &nbsp; 1750 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,3) &nbsp;| &nbsp; &nbsp; &nbsp; 16386 | &nbsp; &nbsp; &nbsp; 1282 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 2 | &nbsp; 8112 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 37 | &nbsp; 1748 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,2) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp; &nbsp; 2562 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; 3 | &nbsp; 8080 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; 32 | &nbsp; 1750 | &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | (0,3) &nbsp;| &nbsp; &nbsp; &nbsp; 32770 | &nbsp; &nbsp; &nbsp;10498 | &nbsp; &nbsp; 24 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(3 rows)</font></div><p></p></pre></div><div>session1提交后,&nbsp;</div><div>ctid=(0,1)的记录t_infomask变成1282 = 0x0502 (HEAP_HASVARWIDTH, HEAP_XMIN_COMMITTED, HEAP_XMAX_COMMITTED) 说明此时xmin和xmax都是有效并提交的状态. t_ctid=(0,3), 表示这条记录同时指向ctid=(0,3)的记录. (对于repeatable read和serializeable read的隔离级别, 读取哪条tuple, 就要分辨t_xmin和t_xmax了. 还有vacuum进程也需要看这两个值)</div><div>ctid=(0,3)的记录, t_infomask = 10498 = 0x2902 (HEAP_UPDATED, HEAP_XMIN_COMMITTED, HEAP_XMAX_INVALID, HEAP_HASVARWIDTH) 说明这条记录的xmin是有效的, 并已提交.</div></div><div><br></div><div>2. 使用strace跟踪fdatasync调用举例</div><div>下面使用的是PostgreSQL 9.3 devel版本进行的测试.</div><div><div>session 1 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# select pg_backend_pid();</font></div><div><font size="2"  >&nbsp;pg_backend_pid&nbsp;</font></div><div><font size="2"  >----------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;9499</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >digoal=# show synchronous_commit;</font></div><div><font size="2"  >&nbsp;synchronous_commit&nbsp;</font></div><div><font size="2"  >--------------------</font></div><div><font size="2"  >&nbsp;on</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >digoal=# show wal_sync_method;</font></div><div><font size="2"  >&nbsp;wal_sync_method&nbsp;</font></div><div><font size="2"  >-----------------</font></div><div><font size="2"  >&nbsp;fdatasync</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div><div>session 2 :</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pgdev@db-172-16-3-150-&gt; ps -ewf|grep pgdev</font></div><div><font size="2"  >pgdev &nbsp; &nbsp; 8393 &nbsp; &nbsp; 1 &nbsp;0 08:26 pts/5 &nbsp; &nbsp;00:00:00 /home/pgdev/pgsql9.3/bin/postgres</font></div><div><font size="2"  >pgdev &nbsp; &nbsp; 8395 &nbsp;8393 &nbsp;0 08:26 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: checkpointer process &nbsp;&nbsp;</font></div><div><font size="2"  >pgdev &nbsp; &nbsp; 8396 &nbsp;8393 &nbsp;0 08:26 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: writer process &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >pgdev &nbsp; &nbsp; 8397 &nbsp;8393 &nbsp;0 08:26 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: wal writer process &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >pgdev &nbsp; &nbsp; 8398 &nbsp;8393 &nbsp;0 08:26 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: autovacuum launcher process &nbsp;&nbsp;</font></div><div><font size="2"  >pgdev &nbsp; &nbsp; 8399 &nbsp;8393 &nbsp;0 08:26 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: stats collector process &nbsp;&nbsp;</font></div><div><font size="2"  >pgdev &nbsp; &nbsp; 9499 &nbsp;8393 &nbsp;0 09:08 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: postgres digoal [local] idle</font></div><p></p></pre></div><div>跟踪wal writer 进程</div><div><pre class="prettyprint"  ><p><font size="2"  >strace -p 8397</font></p></pre></div><div>整个过程中没有跟踪到wal writer进程有系统调用操作.</div><div><br></div><div>session 3 :&nbsp;</div><div>跟踪backend 进程</div><div><pre class="prettyprint"  ><p><font size="2"  >strace -p 9499</font></p></pre></div><div>回滚测试 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ># session 1 (begin;)</font></div><div><font size="2"  >recvfrom(8, "Q\0\0\0\vbegin;\0", 8192, 0, NULL, NULL) = 12</font></div><div><font size="2"  >sendto(8, "C\0\0\0\nBEGIN\0Z\0\0\0\5T", 17, 0, NULL, 0) = 17</font></div><div><font size="2"  ># session 1 (insert into digoal.t (info) values ('test');)</font></div><div><font size="2"  >recvfrom(8, "Q\0\0\0001insert into digoal.t (info)"..., 8192, 0, NULL, NULL) = 50</font></div><div><font size="2"  >sendto(8, "C\0\0\0\17INSERT 0 1\0Z\0\0\0\5T", 22, 0, NULL, 0) = 22</font></div><div><font size="2"  ># session 1 (rollback;)</font></div><div><font size="2"  >recvfrom(8, "Q\0\0\0\16rollback;\0", 8192, 0, NULL, NULL) = 15</font></div><div><font size="2"  >kill(8397, SIGUSR1) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = 0</font></div><div><font size="2"  >sendto(7, "\2\0\0\0`\1\0\0006@\0\0\3\0\0\0\0\0\0\0\1\0\0\0\0\0\0\0\0\0\0\0"..., 352, 0, NULL, 0) = 352</font></div><div><font size="2"  >sendto(8, "C\0\0\0\rROLLBACK\0Z\0\0\0\5I", 20, 0, NULL, 0) = 20</font></div><p></p></pre></div><div>注意到, rollback<span style="line-height: 22px;"  >时backend process和wal writer process都</span>没有写xlog文件的操作(write或者fdatasync都没看到). (但是, 并不代表rollback掉的事务就不产生XLOG信息了, 产生xlog信息是在每个SQL执行过程中产生的, commit只是触发了fsync操作. 这些XLOG信息其实已经在wal buffer里面了, 后面会有例子来讲这个.)</div><div>更加详细的调用需要使用gdb来跟踪. strace很多信息都跟踪不到.</div><div><br></div><div>提交测试 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ># session 1 (begin;)</font></div><div><font size="2"  >recvfrom(8, "Q\0\0\0\vbegin;\0", 8192, 0, NULL, NULL) = 12</font></div><div><font size="2"  >sendto(8, "C\0\0\0\nBEGIN\0Z\0\0\0\5T", 17, 0, NULL, 0) = 17</font></div><div><font size="2"  ># session 1 (insert into digoal.t (info) values ('test');)</font></div><div><font size="2"  >recvfrom(8, "Q\0\0\0001insert into digoal.t (info)"..., 8192, 0, NULL, NULL) = 50</font></div><div><font size="2"  >sendto(8, "C\0\0\0\17INSERT 0 1\0Z\0\0\0\5T", 22, 0, NULL, 0) = 22</font></div><div><font size="2"  ># session 1 (commit;)</font></div><div><font size="2"  >recvfrom(8, "Q\0\0\0\fcommit;\0", 8192, 0, NULL, NULL) = 13</font></div><div><font size="2"  >lseek(16, 327680, SEEK_SET) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = 327680</font></div><div><font size="2"  >write(16, "u\320\5\0\1\0\0\0\0\0\5\2\0\0\0\0O\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"..., 16384) = 16384</font></div><div><font size="2"  >fdatasync(16) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = 0</font></div><div><font size="2"  >sendto(7, "\2\0\0\0`\1\0\0006@\0\0\3\0\0\0\1\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"..., 352, 0, NULL, 0) = 352</font></div><div><font size="2"  >sendto(8, "C\0\0\0\vCOMMIT\0Z\0\0\0\5I", 18, 0, NULL, 0) = 18</font></div><p></p></pre></div><div>注意到, commit时, backend process写xlog文件(查看该进程的fd)并调用fdatasync写入磁盘.</div><div>查看fd=16打开的是什么文件?</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >cd /proc/9499/fd</font></div><div><font size="2"  >ll</font></div><div><font size="2"  >lrwx------ 1 pgdev pgdev 64 Oct 16 09:21 16 -&gt; /data04/pgdev/pg_root/pg_xlog/000000010000000000000002</font></div><p></p></pre></div></div><div><br></div><div>3.&nbsp;<span style="line-height: 22px;"  >使用strace跟踪fdatasync调用举例</span></div><div>以下使用的是PostgreSQL 9.1.3的版本进行的测试 :&nbsp;</div><div><div>session 1 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db-172-16-3-40-&gt; psql -h 127.0.0.1</font></div><div><font size="2"  >psql (9.1.3)</font></div><div><font size="2"  >Type "help" for help.</font></div><div><font size="2"  >postgres=# show synchronous_commit;</font></div><div><font size="2"  >&nbsp;synchronous_commit&nbsp;</font></div><div><font size="2"  >--------------------</font></div><div><font size="2"  >&nbsp;on</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# show wal_sync_method;</font></div><div><font size="2"  >&nbsp;wal_sync_method&nbsp;</font></div><div><font size="2"  >-----------------</font></div><div><font size="2"  >&nbsp;fdatasync</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >postgres=# select pg_backend_pid();</font></div><div><font size="2"  >&nbsp;pg_backend_pid&nbsp;</font></div><div><font size="2"  >----------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 26479</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div><div>session 2 :</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db-172-16-3-40-&gt; ps -ewf|grep postgres</font></div><div><font size="2"  >postgres 21941 &nbsp; &nbsp; 1 &nbsp;0 Oct15 pts/5 &nbsp; &nbsp;00:00:29 /opt/pgsql/bin/postgres</font></div><div><font size="2"  >postgres 21948 21941 &nbsp;0 Oct15 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:11 postgres: logger process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 21950 21941 &nbsp;0 Oct15 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: writer process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 21951 21941 &nbsp;0 Oct15 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: wal writer process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 21952 21941 &nbsp;0 Oct15 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: autovacuum launcher process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 21953 21941 &nbsp;0 Oct15 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: stats collector process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 26479 21941 &nbsp;0 09:02 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: postgres postgres 127.0.0.1(17658) idle</font></div><p></p></pre></div><div>跟踪wal writer 进程</div><div><pre class="prettyprint"  ><p><font size="2"  >strace -p 21951</font></p></pre></div><div>回滚测试 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ># session 1 (insert into digoal.t (info) values ('test');)</font></div><div><font size="2"  >lseek(5, 7520256, SEEK_SET) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = 7520256</font></div><div><font size="2"  >write(5, "f\320\1\0\1\0\0\0\0\0\0\0\0\300rH\22\0\0\0pi\1\0\0\0\0\0\0\0\0\0"..., 8192) = 8192</font></div><div><font size="2"  >fdatasync(5) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 0</font></div><div><font size="2"  ># session 1 (rollback;)</font></div><div><font size="2"  >write(5, "f\320\1\0\1\0\0\0\0\0\0\0\0\340rH\210\1\0\0\377\377\1\0\345/\0\0enab"..., 8192) = 8192</font></div><div><font size="2"  >fdatasync(5) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 0</font></div><p></p></pre></div><div>fd信息如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db-172-16-3-40 fd]# cd /proc/26479/fd</font></div><div><font size="2"  >[root@db-172-16-3-40 fd]# ll 5</font></div><div><font size="2"  >lrwx------ 1 postgres postgres 64 Oct 16 09:09 5 -&gt; /pgdata/digoal/1921/data02/pg_root/base/12699/12505</font></div><div><font size="2"  >postgres=# select pg_relation_filepath('t'::regclass);</font></div><div><font size="2"  >&nbsp;pg_relation_filepath&nbsp;</font></div><div><font size="2"  >----------------------</font></div><div><font size="2"  >&nbsp;base/12699/16923</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>wal writer进程写的居然是pg_am这个系统表, 暂时还不知道啥原因.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select relname,relkind,pg_relation_filepath(oid) from pg_class where pg_relation_filepath(oid) ~ '12505';</font></div><div><font size="2"  >&nbsp;relname | relkind | pg_relation_filepath&nbsp;</font></div><div><font size="2"  >---------+---------+----------------------</font></div><div><font size="2"  >&nbsp;pg_am &nbsp; | r &nbsp; &nbsp; &nbsp; | base/12699/12505</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div><div>session 3 :&nbsp;</div><div>跟踪backend 进程</div><div><pre class="prettyprint"  ><p><font size="2"  >strace -p 26479</font></p></pre></div><div>回滚测试 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ># session 1 (begin;)</font></div><div><font size="2"  >recvfrom(7, "Q\0\0\0\vbegin;\0", 8192, 0, NULL, NULL) = 12</font></div><div><font size="2"  >close(40) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = 0</font></div><div><font size="2"  >sendto(7, "C\0\0\0\nBEGIN\0Z\0\0\0\5T", 17, 0, NULL, 0) = 17</font></div><div><font size="2"  ># session 1 (insert into digoal.t (info) values ('test');)</font></div><div><font size="2"  >recvfrom(7, "Q\0\0\0,insert into t (info) values"..., 8192, 0, NULL, NULL) = 45</font></div><div><font size="2"  >open("base/12699/16923_fsm", O_RDWR) &nbsp; &nbsp;= -1 ENOENT (No such file or directory)</font></div><div><font size="2"  >open("base/12699/16923", O_RDWR) &nbsp; &nbsp; &nbsp; &nbsp;= 18</font></div><div><font size="2"  >lseek(18, 0, SEEK_END) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 0</font></div><div><font size="2"  >lseek(18, 0, SEEK_END) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 0</font></div><div><font size="2"  >write(18, "\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"..., 8192) = 8192</font></div><div><font size="2"  >open("base/12699/16930", O_RDWR) &nbsp; &nbsp; &nbsp; &nbsp;= 40</font></div><div><font size="2"  >read(40, "\0\0\0\0\0\0\0\0\1\0\0\0000\0\360\37\360\37\4 \0\0\0\0b1\5\0\2\0\0\0"..., 8192) = 8192</font></div><div><font size="2"  >open("base/12699/16930_fsm", O_RDWR) &nbsp; &nbsp;= -1 ENOENT (No such file or directory)</font></div><div><font size="2"  >lseek(40, 0, SEEK_END) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 8192</font></div><div><font size="2"  >write(40, "\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"..., 8192) = 8192</font></div><div><font size="2"  >close(40) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = 0</font></div><div><font size="2"  >sendto(7, "C\0\0\0\17INSERT 0 1\0Z\0\0\0\5T", 22, 0, NULL, 0) = 22</font></div><div><font size="2"  ># session 1 (rollback;)</font></div><div><font size="2"  >recvfrom(7, "Q\0\0\0\16rollback;\0", 8192, 0, NULL, NULL) = 15</font></div><div><font size="2"  >sendto(6, "\2\0\0\0\300\3\0\0\2331\0\0\t\0\0\0\0\0\0\0\1\0\0\0\353\4\0\0\0\0\0\0"..., 960, 0, NULL, 0) = 960</font></div><div><font size="2"  >sendto(6, "\2\0\0\0\270\1\0\0\2331\0\0\4\0\0\0\0\0\0\0\0\0\0\0v\n\0\0\0\0\0\0"..., 440, 0, NULL, 0) = 440</font></div><div><font size="2"  >sendto(7, "C\0\0\0\rROLLBACK\0Z\0\0\0\5I", 20, 0, NULL, 0) = 20</font></div><p></p></pre></div><div>注意到, rollback时backend process和wal writer process<span style="line-height: 22px;"  >都</span><span style="line-height: 22px;"  >没有写xlog文件的操作(write或者fdatasync都没看到)</span>. 但是有write fsm文件的操作.</div><div><span style="line-height: 22px;"  >更加详细的调用需要使用gdb来跟踪. strace很多信息都跟踪不到.</span></div><div><br></div><div>提交测试 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ># session 1 (begin;)</font></div><div><font size="2"  >recvfrom(7, "Q\0\0\0\vbegin;\0", 8192, 0, NULL, NULL) = 12</font></div><div><font size="2"  >sendto(7, "C\0\0\0\nBEGIN\0Z\0\0\0\5T", 17, 0, NULL, 0) = 17</font></div><div><font size="2"  ># session 1 (insert into digoal.t (info) values ('test');)</font></div><div><font size="2"  >recvfrom(7, "Q\0\0\0,insert into t (info) values"..., 8192, 0, NULL, NULL) = 45</font></div><div><font size="2"  >sendto(7, "C\0\0\0\17INSERT 0 1\0Z\0\0\0\5T", 22, 0, NULL, 0) = 22</font></div><div><font size="2"  ># session 1 (commit;)</font></div><div><font size="2"  >recvfrom(7, "Q\0\0\0\fcommit;\0", 8192, 0, NULL, NULL) = 13</font></div><div><font size="2"  >write(38, "f\320\1\0\1\0\0\0\0\0\0\0\0\340rH\210\1\0\0\377\377\1\0\345/\0\0enab"..., 8192) = 8192</font></div><div><font size="2"  >fdatasync(38) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = 0</font></div><div><font size="2"  >sendto(6, "\2\0\0\0P\1\0\0\2331\0\0\3\0\0\0\1\0\0\0\0\0\0\0\33B\0\0\0\0\0\0"..., 336, 0, NULL, 0) = 336</font></div><div><font size="2"  >sendto(7, "C\0\0\0\vCOMMIT\0Z\0\0\0\5I", 18, 0, NULL, 0) = 18</font></div><p></p></pre></div><div>注意到, commit时, backend process写xlog文件(查看该进程的fd)并调用fdatasync写入磁盘.</div><div>查看fd=38打开的是什么文件?</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db-172-16-3-40-&gt; cd /proc/26479/fd</font></div><div><font size="2"  >postgres@db-172-16-3-40-&gt; ll 38</font></div><div><font size="2"  >lrwx------ 1 postgres postgres 64 Oct 16 09:09 38 -&gt; /pgdata/digoal/1921/data01/pg_xlog/000000010000000000000012</font></div><p></p></pre></div></div><div>4. gdb</div><div>以下使用PostgreSQL 9.3 devel版本进行测试.</div><div>session 1 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pgdev@db-172-16-3-150-&gt; psql</font></div><div><font size="2"  >psql (9.3devel)</font></div><div><font size="2"  >Type "help" for help.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=# \c digoal postgres</font></div><div><font size="2"  >You are now connected to database "digoal" as user "postgres".</font></div><div><font size="2"  >digoal=# select pg_backend_pid();</font></div><div><font size="2"  >&nbsp;pg_backend_pid&nbsp;</font></div><div><font size="2"  >----------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 12872</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div><div>session 2 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >pgdev@db-172-16-3-150-&gt; gdb</font></div><div><font size="2"  >GNU gdb (GDB) Red Hat Enterprise Linux (7.0.1-37.el5)</font></div><div><font size="2"  >Copyright (C) 2009 Free Software Foundation, Inc.</font></div><div><font size="2"  >License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</font></div><div><font size="2"  >This is free software: you are free to change and redistribute it.</font></div><div><font size="2"  >There is NO WARRANTY, to the extent permitted by law. &nbsp;Type "show copying"</font></div><div><font size="2"  >and "show warranty" for details.</font></div><div><font size="2"  >This GDB was configured as "x86_64-redhat-linux-gnu".</font></div><div><font size="2"  >For bug reporting instructions, please see:</font></div><div><font size="2"  >&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</font></div><div><font size="2"  >(gdb) attach 12872</font></div><div><font size="2"  >Attaching to process 12872</font></div><div><font size="2"  >Reading symbols from /home/pgdev/pgsql9.3/bin/postgres...done.</font></div><div><font size="2"  >Reading symbols from /usr/lib64/libxslt.so.1...(no debugging symbols found)...done.</font></div><div><font size="2"  >Loaded symbols for /usr/lib64/libxslt.so.1</font></div><div><font size="2"  >Reading symbols from /usr/lib64/libxml2.so.2...(no debugging symbols found)...done.</font></div><div><font size="2"  >Loaded symbols for /usr/lib64/libxml2.so.2</font></div><div><font size="2"  >Reading symbols from /lib64/libssl.so.6...(no debugging symbols found)...done.</font></div><div><font size="2"  >Loaded symbols for /lib64/libssl.so.6</font></div><div><font size="2"  >Reading symbols from /lib64/libcrypto.so.6...(no debugging symbols found)...done.</font></div><div><font size="2"  >Loaded symbols for /lib64/libcrypto.so.6</font></div><div><font size="2"  >Reading symbols from /lib64/libcrypt.so.1...(no debugging symbols found)...done.</font></div><div><font size="2"  >Loaded symbols for /lib64/libcrypt.so.1</font></div><div><font size="2"  >Reading symbols from /lib64/libdl.so.2...(no debugging symbols found)...done.</font></div><div><font size="2"  >Loaded symbols for /lib64/libdl.so.2</font></div><div><font size="2"  >Reading symbols from /lib64/libm.so.6...(no debugging symbols found)...done.</font></div><div><font size="2"  >Loaded symbols for /lib64/libm.so.6</font></div><div><font size="2"  >Reading symbols from /lib64/libc.so.6...(no debugging symbols found)...done.</font></div><div><font size="2"  >Loaded symbols for /lib64/libc.so.6</font></div><div><font size="2"  >Reading symbols from /lib64/libz.so.1...(no debugging symbols found)...done.</font></div><div><font size="2"  >Loaded symbols for /lib64/libz.so.1</font></div><div><font size="2"  >Reading symbols from /usr/lib64/libgssapi_krb5.so.2...(no debugging symbols found)...done.</font></div><div><font size="2"  >Loaded symbols for /usr/lib64/libgssapi_krb5.so.2</font></div><div><font size="2"  >Reading symbols from /usr/lib64/libkrb5.so.3...(no debugging symbols found)...done.</font></div><div><font size="2"  >Loaded symbols for /usr/lib64/libkrb5.so.3</font></div><div><font size="2"  >Reading symbols from /lib64/libcom_err.so.2...(no debugging symbols found)...done.</font></div><div><font size="2"  >Loaded symbols for /lib64/libcom_err.so.2</font></div><div><font size="2"  >Reading symbols from /usr/lib64/libk5crypto.so.3...(no debugging symbols found)...done.</font></div><div><font size="2"  >Loaded symbols for /usr/lib64/libk5crypto.so.3</font></div><div><font size="2"  >Reading symbols from /lib64/ld-linux-x86-64.so.2...(no debugging symbols found)...done.</font></div><div><font size="2"  >Loaded symbols for /lib64/ld-linux-x86-64.so.2</font></div><div><font size="2"  >Reading symbols from /usr/lib64/libkrb5support.so.0...(no debugging symbols found)...done.</font></div><div><font size="2"  >Loaded symbols for /usr/lib64/libkrb5support.so.0</font></div><div><font size="2"  >Reading symbols from /lib64/libkeyutils.so.1...(no debugging symbols found)...done.</font></div><div><font size="2"  >Loaded symbols for /lib64/libkeyutils.so.1</font></div><div><font size="2"  >Reading symbols from /lib64/libresolv.so.2...(no debugging symbols found)...done.</font></div><div><font size="2"  >Loaded symbols for /lib64/libresolv.so.2</font></div><div><font size="2"  >Reading symbols from /lib64/libselinux.so.1...(no debugging symbols found)...done.</font></div><div><font size="2"  >Loaded symbols for /lib64/libselinux.so.1</font></div><div><font size="2"  >Reading symbols from /lib64/libsepol.so.1...(no debugging symbols found)...done.</font></div><div><font size="2"  >Loaded symbols for /lib64/libsepol.so.1</font></div><div><font size="2"  >Reading symbols from /lib64/libnss_files.so.2...(no debugging symbols found)...done.</font></div><div><font size="2"  >Loaded symbols for /lib64/libnss_files.so.2</font></div><div><font size="2"  >warning: no loadable sections found in added symbol-file system-supplied DSO at 0x7fff05bc9000</font></div><div><font size="2"  >0x000000345fad4ef5 in recv () from /lib64/libc.so.6</font></div></div><div><div><font size="2"  >(gdb) b fdatasync</font></div><div><font size="2"  >Breakpoint 1 at 0x345facda60</font></div></div><div><div><font size="2"  >(gdb) c</font></div><div><font size="2"  >Continuing.</font></div></div><p></p></pre></div><div><br></div><div>session 1 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# begin;</font></div><div><font size="2"  >BEGIN</font></div><div><font size="2"  >digoal=# insert into digoal.t (info) values ('test');</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=# end;</font></div><p></p></pre></div><div><br></div><div>session 2 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >Breakpoint 1, 0x000000345facda60 in fdatasync () from /lib64/libc.so.6</font></div><div><div><font size="2"  >(gdb) bt</font></div><div><font size="2"  >#0 &nbsp;0x000000345facda60 in fdatasync () from /lib64/libc.so.6</font></div><div><font size="2"  >#1 &nbsp;0x0000000000491a19 in issue_xlog_fsync (fd=35, segno=3) at xlog.c:8215</font></div><div><font size="2"  >#2 &nbsp;0x0000000000497507 in XLogWrite (WriteRqst=..., flexible=0 '\000', xlog_switch=0 '\000') at xlog.c:1697</font></div><div><font size="2"  >#3 &nbsp;0x0000000000497a38 in XLogFlush (record=50343800) at xlog.c:1976</font></div><div><font size="2"  >#4 &nbsp;0x0000000000488dfb in RecordTransactionCommit () at xact.c:1125</font></div><div><font size="2"  >#5 &nbsp;CommitTransaction () at xact.c:1876</font></div><div><font size="2"  >#6 &nbsp;0x000000000048a9b9 in CommitTransactionCommand () at xact.c:2622</font></div><div><font size="2"  >#7 &nbsp;0x000000000062fbb3 in finish_xact_command () at postgres.c:2421</font></div><div><font size="2"  >#8 &nbsp;0x0000000000631e65 in exec_simple_query (query_string=0x34651f0 "end;") at postgres.c:1085</font></div><div><font size="2"  >#9 &nbsp;0x0000000000632c2d in PostgresMain (argc=&lt;value optimized out&gt;, argv=&lt;value optimized out&gt;, username=&lt;value optimized out&gt;)</font></div><div><font size="2"  >&nbsp; &nbsp; at postgres.c:3976</font></div><div><font size="2"  >#10 0x00000000005f5267 in ServerLoop () at postmaster.c:3671</font></div><div><font size="2"  >#11 0x00000000005f7e91 in PostmasterMain (argc=1, argv=0x33b2d10) at postmaster.c:1185</font></div><div><font size="2"  >#12 0x00000000005967b3 in main (argc=1, argv=&lt;value optimized out&gt;) at main.c:197</font></div></div><p></p></pre></div><div><br></div><div>5. 那么fsync xlog 的操作是不是只在commit 的时候发生呢?</div><div>当然不是, 上面没有观察到rollback时写XLOG是因为wal buffer设得较大, 没有被写满, 同时数据库中没有其他会话有commit操作.</div><div>真正发生fsync xlog有几种可能, 1. &nbsp;commit的时候. &nbsp;2. wal buffer被写满的时候.</div><div>下面使用大批量插入进行测试就能看出, 此时wal writer进程将会发生写xlog的操作.</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# begin;insert into t (info) select generate_series(1,10000000);</font></div><div><font size="2"  >BEGIN</font></div><div><font size="2"  >INSERT 0 10000000</font></div><p></p></pre></div><div>跟踪wal writer进程, 未提交时也发生了xlog write :&nbsp;</div><div><span style="font-size: small;"  >postgres@db-172-16-3-40-&gt; strace -p 21951&nbsp;</span><br><pre class="prettyprint"  ><div><div><font size="2"  >Process 21951 attached - interrupt to quit</font></div><div><div><font size="2"  >open("pg_xlog/000000010000000000000021", O_RDWR) = 5</font></div><div><font size="2"  >write(5, "f\320\2\0\1\0\0\0\0\0\0\0\0\0\0\204\355\377_O\305\277^O\0\0\0\4\0 \0\0"..., 303104) = 303104</font></div><div><font size="2"  >fdatasync(5) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 0</font></div></div></div><div><font size="2"  >....write..</font></div><div><span style="line-height: 22px;"  ><font size="2"  >close(5) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 0</font></span></div><div><div><font size="2"  >open("pg_xlog/000000010000000000000022", O_RDWR) = 5</font></div><div><font size="2"  >write(5, "f\320\2\0\1\0\0\0\0\0\0\0\0\0\0\210\355\377_O\305\277^O\0\0\0\4\0 \0\0"..., 245760) = 245760</font></div><div><font size="2"  >fdatasync(5) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 0</font></div></div><div><span style="line-height: 22px;"  ><font size="2"  >....write..</font></span></div><div><span style="line-height: 22px;"  ><font size="2"  >close(5) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 0</font></span></div><div><div><font size="2"  >open("pg_xlog/000000010000000000000023", O_RDWR) = 5</font></div><div><font size="2"  >write(5, "f\320\3\0\1\0\0\0\0\0\0\0\0\0\0\214\355\377_O\305\277^O\0\0\0\4\0 \0\0"..., 344064) = 344064</font></div><div><font size="2"  >fdatasync(5) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 0</font></div></div><div><span style="line-height: 22px;"  ><font size="2"  >....write..</font></span></div><div><span style="line-height: 22px;"  ><font size="2"  >close(5) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 0</font></span></div><div><div><font size="2"  >open("pg_xlog/000000010000000000000024", O_RDWR) = -1 ENOENT (No such file or directory)</font></div><div><font size="2"  >unlink("pg_xlog/xlogtemp.21951") &nbsp; &nbsp; &nbsp; &nbsp;= -1 ENOENT (No such file or directory)</font></div><div><font size="2"  >open("pg_xlog/xlogtemp.21951", O_RDWR|O_CREAT|O_EXCL, 0600) = 5</font></div><div><font size="2"  >write(5, "\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"..., 8192) = 8192</font></div></div><div><font size="2"  >... 省略多行同样的初始化xlog文件的操作.</font></div><div><div><font size="2"  >fsync(5) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 0</font></div><div><font size="2"  >close(5) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 0</font></div></div><div><div><font size="2"  >stat("pg_xlog/000000010000000000000024", 0x7fff4b204c30) = -1 ENOENT (No such file or directory)</font></div><div><font size="2"  >link("pg_xlog/xlogtemp.21951", "pg_xlog/000000010000000000000024") = 0</font></div><div><font size="2"  >unlink("pg_xlog/xlogtemp.21951") &nbsp; &nbsp; &nbsp; &nbsp;= 0</font></div><div><font size="2"  >open("pg_xlog/000000010000000000000024", O_RDWR) = 5</font></div><div><font size="2"  >write(5, "f\320\2\0\1\0\0\0\0\0\0\0\0\0\0\220\355\377_O\305\277^O\0\0\0\4\0 \0\0"..., 303104) = 303104</font></div><div><font size="2"  >fdatasync(5) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 0</font></div></div><div><span style="line-height: 22px;"  ><font size="2"  >....write.....</font></span></div><div><span style="font-size: small; line-height: 22px;"  >...... </span></div><div><font size="2"  ><span style="line-height: 19px;"  >close(5)                                = 0<br>open("pg_xlog/000000010000000000000028", O_RDWR) = -1 ENOENT (No such file or directory)<br>unlink("pg_xlog/xlogtemp.21951")        = -1 ENOENT (No such file or directory)<br>open("pg_xlog/xlogtemp.21951", O_RDWR|O_CREAT|O_EXCL, 0600) = 5<br>write(5, "\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0"..., 8192) = 8192</span></font></div><div><font size="2"  ><span style="line-height: 19px;"  >............</span></font></div><div><font size="2"  >stat("pg_xlog/000000010000000000000028", 0x7fff4b204c30) = -1 ENOENT (No such file or directory)<br>link("pg_xlog/xlogtemp.21951", "pg_xlog/000000010000000000000028") = 0<br>unlink("pg_xlog/xlogtemp.21951")        = 0<br>open("pg_xlog/000000010000000000000028", O_RDWR) = 5<br>write(5, "f\320\2\0\1\0\0\0\0\0\0\0\0\0\0\240\355\377_O\305\277^O\0\0\0\4\0 \0\0"..., 311296) = 311296<br>fdatasync(5)                            = 0</font></div><p></p></pre></div></div><div><span style="line-height: 22px;"  >跟踪backend process :</span></div><div><div style="line-height: 22px;"  ><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >postgres@db-172-16-3-40-&gt; strace -p 26479&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  ># 仅当commit时backend process进程会对xlog进行写操作</font></div><div style="line-height: 22px;"  ><font size="2"  >Process 26479 attached - interrupt to quit</font></div><div style="line-height: 22px;"  ><font size="2"  >recvfrom(7, "Q\0\0\0\fcommit;\0", 8192, 0, NULL, NULL) = 13</font></div><div style="line-height: 22px;"  ><font size="2"  >fadvise64(38, 0, 0, POSIX_FADV_DONTNEED) = 0</font></div><div style="line-height: 22px;"  ><font size="2"  >close(38) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = 0</font></div><div style="line-height: 22px;"  ><font size="2"  >open("pg_xlog/000000010000000000000028", O_RDWR) = 38</font></div><div style="line-height: 22px;"  ><font size="2"  >lseek(38, 56131584, SEEK_SET) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = 56131584</font></div><div style="line-height: 22px;"  ><font size="2"  >write(38, "f\320\1\0\1\0\0\0\0\0\0\0\0\200X\243\"\0\0\0\177\6\0\0\2331\0\0\"B\0\0"..., 8192) = 8192</font></div><div style="line-height: 22px;"  ><font size="2"  >fdatasync(38) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = 0</font></div><div style="line-height: 22px;"  ><font size="2"  >sendto(6, "\2\0\0\0\210\2\0\0\2331\0\0\6\0\0\0\1\0\0\0\0\0\0\0\33B\0\0\0\0\0\0"..., 648, 0, NULL, 0) = 648</font></div><div style="line-height: 22px;"  ><font size="2"  >sendto(7, "C\0\0\0\vCOMMIT\0Z\0\0\0\5I", 18, 0, NULL, 0) = 18</font></div><div style="line-height: 22px;"  ><font size="2"  ><br style="line-height: 22px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  >[root@db-172-16-3-40 fd]# cd /proc/26479/fd</font></div><div style="line-height: 22px;"  ><font size="2"  >[root@db-172-16-3-40 fd]# ll 38</font></div><div style="line-height: 22px;"  ><font size="2"  >lrwx------ 1 postgres postgres 64 Oct 16 09:09 38 -&gt; /pgdata/digoal/1921/data01/pg_xlog/000000010000000000000028</font></div><p></p></pre></div></div><div>因此在使用流复制的primary-standby环境中, standby可以迅速的接收到主节点已经fsync到disk的xlog信息. 取决于wal buffer是否满, 或者系统中有commit. 那么主节点上fsync到磁盘的xlog信息将被sender process(每10ms或者每次commit后被唤醒)发送给standby 的receiver process.</div><div><br></div><div>【参考】</div><div>1. Use pageinspect EXTENSION view PostgreSQL Page's raw infomation</div><div><a href="http://blog.163.com/digoal@126/blog/static/16387704020114273265960/"  >http://blog.163.com/digoal@126/blog/static/16387704020114273265960/</a></div><div>2.&nbsp;<a rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/pageinspect.html"  >http://www.postgresql.org/docs/9.2/static/pageinspect.html</a></div><div>3.&nbsp;<a rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/runtime-config-wal.html#RUNTIME-CONFIG-WAL-SETTINGS"  >http://www.postgresql.org/docs/9.2/static/runtime-config-wal.html#RUNTIME-CONFIG-WAL-SETTINGS</a></div><div><div>4. USE GDB debug postgres</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201252605924116/"  >http://blog.163.com/digoal@126/blog/static/163877040201252605924116/</a></div></div><div>5. t_infomask标示 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >htup.h</font></div><div><div><font size="2"  >00158 /*</font></div><div><font size="2"  >00159 &nbsp;* information stored in t_infomask:</font></div><div><font size="2"  >00160 &nbsp;*/</font></div><div><font size="2"  >00161 #define HEAP_HASNULL &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0x0001 &nbsp;/* has null attribute(s) */</font></div><div><font size="2"  >00162 #define HEAP_HASVARWIDTH &nbsp; &nbsp; &nbsp; &nbsp;0x0002 &nbsp;/* has variable-width attribute(s) */</font></div><div><font size="2"  >00163 #define HEAP_HASEXTERNAL &nbsp; &nbsp; &nbsp; &nbsp;0x0004 &nbsp;/* has external stored attribute(s) */</font></div><div><font size="2"  >00164 #define HEAP_HASOID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x0008 &nbsp;/* has an object-id field */</font></div><div><font size="2"  >00165 /* bit 0x0010 is available */</font></div><div><font size="2"  >00166 #define HEAP_COMBOCID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x0020 &nbsp;/* t_cid is a combo cid */</font></div><div><font size="2"  >00167 #define HEAP_XMAX_EXCL_LOCK &nbsp; &nbsp; 0x0040 &nbsp;/* xmax is exclusive locker */</font></div><div><font size="2"  >00168 #define HEAP_XMAX_SHARED_LOCK &nbsp; 0x0080 &nbsp;/* xmax is shared locker */</font></div><div><font size="2"  >00169 /* if either LOCK bit is set, xmax hasn't deleted the tuple, only locked it */</font></div><div><font size="2"  >00170 #define HEAP_IS_LOCKED &nbsp;(HEAP_XMAX_EXCL_LOCK | HEAP_XMAX_SHARED_LOCK)</font></div><div><font size="2"  >00171 #define HEAP_XMIN_COMMITTED &nbsp; &nbsp; 0x0100 &nbsp;/* t_xmin committed */</font></div><div><font size="2"  >00172 #define HEAP_XMIN_INVALID &nbsp; &nbsp; &nbsp; 0x0200 &nbsp;/* t_xmin invalid/aborted */</font></div><div><font size="2"  >00173 #define HEAP_XMAX_COMMITTED &nbsp; &nbsp; 0x0400 &nbsp;/* t_xmax committed */</font></div><div><font size="2"  >00174 #define HEAP_XMAX_INVALID &nbsp; &nbsp; &nbsp; 0x0800 &nbsp;/* t_xmax invalid/aborted */</font></div><div><font size="2"  >00175 #define HEAP_XMAX_IS_MULTI &nbsp; &nbsp; &nbsp;0x1000 &nbsp;/* t_xmax is a MultiXactId */</font></div><div><font size="2"  >00176 #define HEAP_UPDATED &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0x2000 &nbsp;/* this is UPDATEd version of row */</font></div><div><font size="2"  >00177 #define HEAP_MOVED_OFF &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0x4000 &nbsp;/* moved to another place by pre-9.0</font></div><div><font size="2"  >00178 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* VACUUM FULL; kept for binary</font></div><div><font size="2"  >00179 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* upgrade support */</font></div><div><font size="2"  >00180 #define HEAP_MOVED_IN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x8000 &nbsp;/* moved from another place by pre-9.0</font></div><div><font size="2"  >00181 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* VACUUM FULL; kept for binary</font></div><div><font size="2"  >00182 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* upgrade support */</font></div><div><font size="2"  >00183 #define HEAP_MOVED (HEAP_MOVED_OFF | HEAP_MOVED_IN)</font></div><div><font size="2"  >00184&nbsp;</font></div><div><font size="2"  >00185 #define HEAP_XACT_MASK &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0xFFE0 &nbsp;/* visibility-related bits */</font></div></div><p></p></pre></div>6. wal buffer :&nbsp;<div><pre class="prettyprint"  ><p></p><div><font size="2"  >wal_buffers (integer)</font></div><div><font size="2"  >The amount of shared memory used for WAL data that has not yet been written to disk. The default setting of -1 selects a size equal to 1/32nd (about 3%) of shared_buffers, but not less than 64kB nor more than the size of one WAL segment, typically 16MB. This value can be set manually if the automatic choice is too large or too small, but any positive value less than 32kB will be treated as 32kB. This parameter can only be set at server start.</font></div><div><font size="2"  >The contents of the WAL buffers are written out to disk at every transaction commit, so extremely large values are unlikely to provide a significant benefit. However, setting this value to at least a few megabytes can improve write performance on a busy server where many clients are committing at once. The auto-tuning selected by the default setting of -1 should give reasonable results in most cases.</font></div><div><font size="2"  >Increasing this parameter might cause PostgreSQL to request more System V shared memory than your operating system's default configuration allows. See Section 17.4.1 for information on how to adjust those parameters, if necessary.</font></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>