<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">use with recursive or function recursive get the innest string in multi-lables html</h2>
	<h5 id="">2015-03-13 11:02:12&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201521311041398/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>如何取出最内的标签内的字符串?</div><div>方法有多种多样, 这里举例一下, 一种用递归查询, 一种用函数.</div><div>个人推荐函数比较清晰明了. 递归查询没有写好的话, 也是很费事的.</div><div>测试如下</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create table t1(col1 text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# insert into t1 values ('&lt;p&gt;&lt;span style="font-size:16px;font-family:宋体"&gt;南京：连云港&lt;/span&gt;&lt;p&gt;');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >postgres=# insert into t1 values ('&lt;p&gt;&lt;span style="font-size:16px;font-family:宋体"&gt;南京：连云港&lt;/span&gt;&lt;p&gt;');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >postgres=# insert into t1 values ('&lt;p&gt;&lt;span style="font-size:16px;font-family:宋体"&gt;南京：连云港&lt;/span&gt;&lt;p&gt;');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >postgres=# insert into t1 values ('abc');<br>INSERT 0 1</font></div><p></p></pre></div><div><br></div><div>递归查询</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# with recursive t(col1) as (select col1 from t1 union all select substring(col1,'&gt;(.*)&lt;') from t where substring(col1,'&gt;(.*)&lt;') is not null) select * from t where substring(col1,'&gt;(.*)&lt;') is null;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;col1 &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >--------------</font></div><div><font size="2"   >&nbsp;abc</font></div><div><font size="2"   >&nbsp;南京：连云港</font></div><div><font size="2"   >&nbsp;南京：连云港</font></div><div><font size="2"   >&nbsp;南京：连云港</font></div><div><font size="2"   >(3 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# with recursive t(col1) as (select col1 from t1 where ctid='(0,1)' union all select substring(col1,'&gt;(.*)&lt;') from t where substring(col1,'&gt;(.*)&lt;') is not null) select * from t where substring(col1,'&gt;(.*)&lt;') is null;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;col1 &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >--------------</font></div><div><font size="2"   >&nbsp;南京：连云港</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>函数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# create or replace function f_test(i_str text) returns text as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; v_str text := substring(i_str,'&gt;(.*)&lt;');</font></div><div><font size="2"   >begin&nbsp;</font></div><div><font size="2"   >&nbsp; if v_str is null then&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; return i_str ;</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; return f_test(v_str);</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql strict;</font></div><div><font size="2"   >CREATE FUNCTION</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres=# select f_test(col1) from t1;</font></div><div><font size="2"   >&nbsp; &nbsp; f_test &nbsp; &nbsp;</font></div><div><font size="2"   >--------------</font></div><div><font size="2"   >&nbsp;南京：连云港</font></div><div><font size="2"   >&nbsp;南京：连云港</font></div><div><font size="2"   >&nbsp;南京：连云港</font></div><div><font size="2"   >&nbsp;abc</font></div><div><font size="2"   >(3 rows)</font></div></div><p></p></pre></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.4/static/queries-with.html"   >http://www.postgresql.org/docs/9.4/static/queries-with.html</a></div><div><br></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="use with recursive or function recursive get the innest string in multi-lables html - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>