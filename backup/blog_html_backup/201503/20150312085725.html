<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">use function generate foreign table DDL in postgresql</h2>
	<h5 id="">2015-03-12 8:57:25&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201521162114359/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>为了实现跨库的表级同步, 方法很多, 例如可以用dblink+触发器, 外部表+物化视图, londiste3,.....</div><div>方法参考如下 :&nbsp;</div><div><div>PostgreSQL 表级远程数据复制之 - 基于DBLINK和触发器的远程数据复制的实现</div><div>&nbsp; -- &nbsp;表级同步或异步复制, 多主双向可读写的数据复制</div><div>&nbsp; -- &nbsp;通用的基于触发器的数据复制逻辑实现</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201321125220134/"   >http://blog.163.com/digoal@126/blog/static/163877040201321125220134/</a></div></div><div><div>PostgreSQL 基于表的逻辑复制方法, Londiste3</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201242945632912/"   >http://blog.163.com/digoal@126/blog/static/163877040201242945632912/</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201243051338137/"   >http://blog.163.com/digoal@126/blog/static/163877040201243051338137/</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012431102448951/"   >http://blog.163.com/digoal@126/blog/static/1638770402012431102448951/</a></div></div><div><div>PostgreSQL 基于表的逻辑复制,同步方法, Londiste3 - 级联复制的使用</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020125441314324/"   >http://blog.163.com/digoal@126/blog/static/16387704020125441314324/</a></div></div><div><div>一个开源的跨数据库产品的逻辑数据复制工具 - SymmetricDS</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201472110018991/"   >http://blog.163.com/digoal@126/blog/static/163877040201472110018991/</a></div></div><div><div>PostgreSQL 表级远程数据复制之 - 基于DBLINK和触发器的远程数据复制的实现</div><div>&nbsp; -- &nbsp;表级异步复制, 从一个数据源(读写)复制到多个数据源(只读)</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012731203716/"   >http://blog.163.com/digoal@126/blog/static/1638770402012731203716/</a></div><div>PostgreSQL 表级远程数据复制之 - 基于DBLINK和触发器的远程数据复制的实现</div><div>&nbsp; -- &nbsp;表级异步复制, 多主双向可读写的数据复制</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012731944439/"   >http://blog.163.com/digoal@126/blog/static/1638770402012731944439/</a></div><div>PostgreSQL 表级远程数据复制之 - 基于DBLINK和触发器的远程数据复制的实现</div><div>&nbsp; -- &nbsp;表级同步或异步复制, 多主双向可读写的数据复制</div><div>&nbsp; -- &nbsp;通用的基于触发器的数据复制逻辑实现</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201321125220134/"   >http://blog.163.com/digoal@126/blog/static/163877040201321125220134/</a></div></div><div><br></div><div>本文主要讲一下使用物化视图来负责的方法, 因为PostgreSQL 9.4加入了物化视图增量同步(其实是通过UK或PK进行比对), 所以使用物化视图也是不错的方法.</div><div>如果要生成大量的外部表, 写代码闲麻烦的话, 可以通过如下方法快速的生成外部表的DDL.</div><div>创建postgresql外部表fdw</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create extension postgres_fdw;</font></div><div><font size="2"   >CREATE EXTENSION</font></div><p></p></pre></div><div>创建server, 指定远端数据库的ip, port, dbname</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create server fs foreign data wrapper postgres_fdw options (hostaddr '172.16.3.150', port '1921', dbname 'postgres');</font></div><div><font size="2"   >CREATE SERVER</font></div><p></p></pre></div><div>创建一个本地角色</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create role test login encrypted password 'test';</font></div><div><font size="2"   >CREATE ROLE</font></div><p></p></pre></div><div>配置本地角色teset使用server的user mapping, 指定连接到server的用户,密码.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# CREATE USER MAPPING FOR test SERVER fs OPTIONS (user 'postgres', password 'postgres');</font></div><div><font size="2"   >CREATE USER MAPPING</font></div><p></p></pre></div><div>将server的使用权给本地用户test</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# grant usage on FOREIGN SERVER &nbsp;fs to test;</font></div><div><font size="2"   >GRANT</font></div><p></p></pre></div><div>假设远端有一个表是orig</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \d orig</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;Table "public.orig"</font></div><div><font size="2"   >&nbsp;Column | &nbsp;Type &nbsp; | Modifiers</font></div><div><font size="2"   >--------+---------+-----------</font></div><div><font size="2"   >&nbsp;id &nbsp; &nbsp; | integer |&nbsp;</font></div><div><font size="2"   >&nbsp;x &nbsp; &nbsp; &nbsp;| numeric |&nbsp;</font></div><p></p></pre></div><div>在test 用户下创建外部表</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \c postgres test</font></div><div><font size="2"   >You are now connected to database "postgres" as user "test".</font></div><div><font size="2"   >postgres=&gt; create foreign table f_orig (id int, x numeric) server fs options(schema_name 'public', table_name 'orig');</font></div><div><font size="2"   >CREATE FOREIGN TABLE</font></div><p></p></pre></div><div>配置远端数据库的 pg_hba.conf, 允许访问.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-172-16-3-150-&gt; cd $PGDATA</font></div><div><font size="2"   >postgres@db-172-16-3-150-&gt; vi pg_hba.conf</font></div><div><font size="2"   >host all all 0.0.0.0/0 md5</font></div><div><font size="2"   >"pg_hba.conf" 94L, 4495C written</font></div><div><font size="2"   >postgres@db-172-16-3-150-&gt; pg_ctl reload</font></div><div><font size="2"   >server signaled</font></div><p></p></pre></div><div>测试外部表的访问</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \c postgres test</font></div><div><font size="2"   >You are now connected to database "postgres" as user "test".</font></div><div><font size="2"   >postgres=&gt; select * from f_orig;</font></div><div><font size="2"   >&nbsp; id &nbsp;| &nbsp; x &nbsp; &nbsp;</font></div><div><font size="2"   >------+--------</font></div><div><font size="2"   >&nbsp; &nbsp; 1 | &nbsp;93.23</font></div><div><font size="2"   >&nbsp; &nbsp; 2 | &nbsp;95.24</font></div><div><font size="2"   >&nbsp; &nbsp; 3 | &nbsp;95.19</font></div><div><font size="2"   >.............</font></div><p></p></pre></div><div>为了快速刷新物化视图, 原表最好有UK或PK</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=&gt; \c postgres postgres</font></div><div><font size="2"   >You are now connected to database "postgres" as user "postgres".</font></div><div><font size="2"   >postgres=# \d orig</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;Table "public.orig"</font></div><div><font size="2"   >&nbsp;Column | &nbsp;Type &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"   >--------+---------+-----------</font></div><div><font size="2"   >&nbsp;id &nbsp; &nbsp; | integer |&nbsp;</font></div><div><font size="2"   >&nbsp;x &nbsp; &nbsp; &nbsp;| numeric |&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# create unique index uk_orig on orig(id);</font></div><div><font size="2"   >CREATE INDEX</font></div><p></p></pre></div><div><br></div><div>使用如下函数自动生成外部表的DDL, 需要指定本地表的schema, tbl_name, 以及外部表需要创建在哪个schema下, 外部表的名称.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 21px;"   >create or replace function create_ft(i_schema name, i_tbl name, i_ftschema text, i_ftname text) returns text as $$<br>declare<br>  v_attname name;<br>  v_type text;<br>  v_sql text;<br>  v_nt text := '';<br>  v_oid oid;<br>begin<br>  select oid into v_oid from pg_class where relnamespace=(select oid from pg_namespace where nspname=i_schema) and relname=i_tbl;<br>  v_sql := 'create foreign table '||i_ftschema||'.'||i_ftname||' (';<br>  for v_attname,v_type in SELECT a.attname,<br>    pg_catalog.format_type(a.atttypid, a.atttypmod)<br>    FROM pg_catalog.pg_attribute a<br>    WHERE a.attrelid = v_oid AND a.attnum &gt; 0 AND NOT a.attisdropped<br>    ORDER BY a.attnum <br>  LOOP<br>    v_nt := v_nt||v_attname||' '||v_type||','||chr(10);<br>  END LOOP;<br>  select regexp_replace(v_nt,','||chr(10)||'$','') into v_nt;<br>  v_sql := v_sql||v_nt||$_$) server fs options(schema_name '$_$||i_schema||$_$', table_name '$_$||i_tbl||$_$');$_$;<br>  return v_sql;<br>end;<br>$$ language plpgsql strict;</span></font></div><p></p></pre></div><wbr><div>如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select create_ft('pg_catalog','pg_class','public','f_orig');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;create_ft &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;create foreign table public.f_orig (relname name, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;relnamespace oid, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;reltype oid, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;reloftype oid, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;relowner oid, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;relam oid, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;relfilenode oid, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;reltablespace oid, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;relpages integer, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;reltuples real, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;relallvisible integer, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;reltoastrelid oid, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;relhasindex boolean, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;relisshared boolean, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;relpersistence "char", &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;relkind "char", &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;relnatts smallint, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;relchecks smallint, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;relhasoids boolean, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;relhaspkey boolean, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;relhasrules boolean, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;relhastriggers boolean, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;relhassubclass boolean, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;relispopulated boolean, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;relreplident "char", &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp;relfrozenxid xid, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;relminmxid xid, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;relacl aclitem[], &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp;reloptions text[]) server fs options(schema_name 'pg_catalog', table_name 'pg_class');</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>创建物化视图</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \c postgres test</font></div><div><font size="2"   >You are now connected to database "postgres" as user "test".</font></div><div><font size="2"   >postgres=&gt; create materialized view mv1 as select * from f_orig;</font></div><div><font size="2"   >SELECT 1053</font></div><p></p></pre></div><div>快速刷新, 物化视图必须有UK或PK.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=&gt; create unique index uk_mv1 on mv1(id);</font></div><div><font size="2"   >CREATE INDEX</font></div><div><font size="2"   >postgres=&gt; refresh materialized view concurrently mv1;</font></div><div><font size="2"   >REFRESH MATERIALIZED VIEW</font></div><p></p></pre></div><div>如果不想输出换行符, 修改函数如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create or replace function create_ft(i_schema name, i_tbl name, i_ftschema text, i_ftname text) returns text as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; v_attname name;</font></div><div><font size="2"   >&nbsp; v_type text;</font></div><div><font size="2"   >&nbsp; v_sql text;</font></div><div><font size="2"   >&nbsp; v_nt text := '';</font></div><div><font size="2"   >&nbsp; v_oid oid;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; select oid into v_oid from pg_class where relnamespace=(select oid from pg_namespace where nspname=i_schema) and relname=i_tbl;</font></div><div><font size="2"   >&nbsp; v_sql := 'create foreign table '||i_ftschema||'.'||i_ftname||' (';</font></div><div><font size="2"   >&nbsp; for v_attname,v_type in SELECT a.attname,</font></div><div><font size="2"   >&nbsp; &nbsp; pg_catalog.format_type(a.atttypid, a.atttypmod)</font></div><div><font size="2"   >&nbsp; &nbsp; FROM pg_catalog.pg_attribute a</font></div><div><font size="2"   >&nbsp; &nbsp; WHERE a.attrelid = v_oid AND a.attnum &gt; 0 AND NOT a.attisdropped</font></div><div><font size="2"   >&nbsp; &nbsp; ORDER BY a.attnum&nbsp;</font></div><div><font size="2"   >&nbsp; LOOP</font></div><div><font size="2"   >&nbsp; &nbsp; v_nt := v_nt||v_attname||' '||v_type||',';</font></div><div><font size="2"   >&nbsp; END LOOP;</font></div><div><font size="2"   >&nbsp; select regexp_replace(v_nt,',$','') into v_nt;</font></div><div><font size="2"   >&nbsp; v_sql := v_sql||v_nt||$_$) server fs options(schema_name '$_$||i_schema||$_$', table_name '$_$||i_tbl||$_$');$_$;</font></div><div><font size="2"   >&nbsp; return v_sql;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql strict;</font></div><p></p></pre></div><div>批量输出DDL</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# copy (select create_ft('public',tablename,'public','ft_'||tablename) from pg_tables where schemaname='public') to '/home/postgres/p';</font></div><div><font size="2"   >COPY 14</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres=&gt; \!</font></div><div><font size="2"   >[postgres@db-172-16-3-150 ~]$ cat p</font></div><div><font size="2"   >create foreign table public.ft_p4 (ov integer,v_id integer,r_chkv numeric,p_yv numeric,r_xv numeric,dev numeric,v_slope numeric,v_inter numeric,v_r2 numeric,sampcnt integer) server fs options(schema_name 'public', table_name 'p4');</font></div><div><font size="2"   >create foreign table public.ft_tmp1 (id integer,x numeric,y numeric) server fs options(schema_name 'public', table_name 'tmp1');</font></div><div><font size="2"   >create foreign table public.ft_tmp2 (id integer,x numeric,y numeric) server fs options(schema_name 'public', table_name 'tmp2');</font></div><div><font size="2"   >create foreign table public.ft_tmp3 (id integer,x numeric,y numeric) server fs options(schema_name 'public', table_name 'tmp3');</font></div><div><font size="2"   >create foreign table public.ft_tmp4 (id integer,x numeric,y numeric) server fs options(schema_name 'public', table_name 'tmp4');</font></div><div><font size="2"   >create foreign table public.ft_p2 (ov integer,v_id integer,r_chkv numeric,p_yv numeric,r_xv numeric,dev numeric,v_slope numeric,v_inter numeric,v_r2 numeric,sampcnt integer) server fs options(schema_name 'public', table_name 'p2');</font></div><div><font size="2"   >create foreign table public.ft_zjdr (id numeric) server fs options(schema_name 'public', table_name 'zjdr');</font></div><div><font size="2"   >create foreign table public.ft_zj (id integer,cnt numeric) server fs options(schema_name 'public', table_name 'zj');</font></div><div><font size="2"   >create foreign table public.ft_t1 (c1 text,c2 numeric,c3 numeric,c4 numeric,c5 numeric,c6 numeric,c7 numeric) server fs options(schema_name 'public', table_name 't1');</font></div><div><font size="2"   >create foreign table public.ft_test (id integer,cnt numeric) server fs options(schema_name 'public', table_name 'test');</font></div><div><font size="2"   >create foreign table public.ft_orig (id integer,x numeric) server fs options(schema_name 'public', table_name 'orig');</font></div><div><font size="2"   >create foreign table public.ft_tmp (id integer,x numeric,y numeric) server fs options(schema_name 'public', table_name 'tmp');</font></div><div><font size="2"   >create foreign table public.ft_p3 (ov integer,v_id integer,r_chkv numeric,p_yv numeric,r_xv numeric,dev numeric,v_slope numeric,v_inter numeric,v_r2 numeric,sampcnt integer) server fs options(schema_name 'public', table_name 'p3');</font></div><div><font size="2"   >create foreign table public.ft_p1 (ov integer,v_id integer,r_chkv numeric,p_yv numeric,r_xv numeric,dev numeric,v_slope numeric,v_inter numeric,v_r2 numeric,sampcnt integer) server fs options(schema_name 'public', table_name 'p1');</font></div></div><p></p></pre></div><div><br></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="2015年03月11日 - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>