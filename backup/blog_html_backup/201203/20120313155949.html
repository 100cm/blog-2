<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL性能优化综合案例讲解 - 2</h2>
	<h5 id="">2012-03-13 15:59:49&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201221333411196/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div style="line-height: 22px;"   ><div style="line-height: 22px;"   >上节:&nbsp;</div><div style="line-height: 22px;"   ><a style="line-height: 22px; " target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201221382150858/"   >http://blog.163.com/digoal@126/blog/static/163877040201221382150858/</a></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >【声明】</span></div><div style="line-height: 22px;"   >欢迎转载, 注明出处.</div><div style="line-height: 22px;"   ><br></div></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >【调优阶段8】</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >1. 压力测试</span></div><div><div><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 1 -f /home/postgres/test/login0.sql -j 1 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal &gt;./log.login0 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 1 -f /home/postgres/test/login1.sql -j 1 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal &gt;./log.login1 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 2 -f /home/postgres/test/login2.sql -j 2 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal &gt;./log.login2 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 2 -f /home/postgres/test/login3.sql -j 2 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal &gt;./log.login3 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 2 -f /home/postgres/test/login4.sql -j 2 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal &gt;./log.login4 &amp;</font></div><p></p></pre></div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >2. 测试结果</span></div><div><div style="line-height: 22px;"   >cat log.log*</div><div><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 296485</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 1647.130827 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 1647.153173 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003394 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 4000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.599293 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_0(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 270077</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 1500.414232 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 1500.434330 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.004436 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 4000001 8000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.656274 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_1(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 2</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 2</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 543390</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 3018.814281 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 3018.901510 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.004553 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 8000001 12000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.652033 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_2(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 2</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 2</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 592774</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 3293.147194 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 3293.235012 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003446 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 12000001 16000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.599297 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_3(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 2</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 2</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 593614</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 3297.831371 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 3297.946707 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003421 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 16000001 20000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.598465 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_4(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >总计 :&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 12757.337905 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 12757.670732 (excluding connections establishing)</font></div><p></p></pre></div></div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >3. 瓶颈分析与优化</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >测试中我们使用的数据库服务器cpu是8核的服务器, 根据以往的经验, 当活跃的进程数等于核数的2倍时可以发挥CPU的最大能力.</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >所以我们通过增加并发连接来看看到底有多少性能提升.</span></div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >【调优阶段9】</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >1. 压力测试</span></div><div><div><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 2 -f /home/postgres/test/login0.sql -j 2 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal &gt;./log.login0 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 2 -f /home/postgres/test/login1.sql -j 2 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal &gt;./log.login1 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 4 -f /home/postgres/test/login2.sql -j 4 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal &gt;./log.login2 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 4 -f /home/postgres/test/login3.sql -j 4 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal &gt;./log.login3 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 4 -f /home/postgres/test/login4.sql -j 4 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal &gt;./log.login4 &amp;</font></div><p></p></pre></div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >2. 测试结果</span></div><div><div style="line-height: 22px;"   >cat log.log*</div><div><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 2</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 2</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 375743</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 2087.443600 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 2087.489913 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003492 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 4000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.949744 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_0(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 2</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 2</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 367801</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 2043.313370 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 2043.386454 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003710 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 4000001 8000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.969828 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_1(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 4</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 4</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 730267</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 4057.007177 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 4057.148280 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003962 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 8000001 12000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.976372 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_2(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 4</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 4</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 738398</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 4101.985844 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 4102.135039 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003615 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 12000001 16000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.966314 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_3(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 4</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 4</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 732793</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 4070.957105 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 4071.200533 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003882 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 16000001 20000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.973208 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_4(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >总计 :&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 16360.707096 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 16361.360219 (excluding connections establishing)</font></div><p></p></pre></div></div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >3. 瓶颈分析与优化</span></div><div><div style="line-height: 22px;"   >继续增加连接,tps还可以再提高吗? : 不可以.</div><div style="line-height: 22px;"   >8核的机器16个活动的会话基本上就到达它的上限了.&nbsp;</div><div style="line-height: 22px;"   >因此要提高tps还可以加CPU.</div><div style="line-height: 22px;"   >下面增加连接到30个的测试结果证明了上面的结论.</div><div><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 6 -f /home/postgres/test/login0.sql -j 6 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal &gt;./log.login0 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 6 -f /home/postgres/test/login1.sql -j 6 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal &gt;./log.login1 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 6 -f /home/postgres/test/login2.sql -j 6 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal &gt;./log.login2 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 6 -f /home/postgres/test/login3.sql -j 6 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal &gt;./log.login3 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 6 -f /home/postgres/test/login4.sql -j 6 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal &gt;./log.login4 &amp;</font></div><p></p></pre></div><div style="line-height: 22px;"   >结果</div><div style="line-height: 22px;"   >cat log.log*</div><div><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 6</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 6</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 544811</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 3026.494301 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 3026.608244 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003768 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 4000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.973230 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_0(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 6</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 6</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 544485</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 3024.298399 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 3024.468785 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003735 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 4000001 8000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.974466 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_1(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 6</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 6</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 544778</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 3025.262019 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 3025.469901 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003707 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 8000001 12000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.973661 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_2(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 6</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 6</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 542008</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 3010.921306 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 3011.146550 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003662 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 12000001 16000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.983714 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_3(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 6</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 6</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 539505</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 2996.511493 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 2996.874239 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003768 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 16000001 20000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.992923 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_4(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >总计 :&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 15083.487518 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 15084.567719 (excluding connections establishing)</font></div></pre></div></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >连接数超过2倍核数后根本不会有性能提升了, 这台服务器的潜力基本上挖掘得差不多了.</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >接下来就需要通过增加服务器来提升数据库的整体性能了.</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >首先要用到的是PostgreSQL的流复制, 通过hot standby可以进行读写分离, 也就是将SELECT的请求分发到hot standby上.</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >(需要注意跨库事务的问题, 如standby的延时, 这里不详细阐述)</span></div><div style="line-height: 22px;"   >新建查询函数和插入更新函数 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >create or replace function f_user_login_sel_0</font></div><div style="line-height: 22px;"   ><font size="2"   >(i_userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_engname text,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_cnname text,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_occupation text,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_birthday date,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_signname text,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_email text,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_qq numeric</font></div><div style="line-height: 22px;"   ><font size="2"   >)</font></div><div style="line-height: 22px;"   ><font size="2"   >as $BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   >select userid,engname,cnname,occupation,birthday,signname,email,qq</font></div><div style="line-height: 22px;"   ><font size="2"   >into o_userid,o_engname,o_cnname,o_occupation,o_birthday,o_signname,o_email,o_qq</font></div><div style="line-height: 22px;"   ><font size="2"   >from user_info_0 where userid=i_userid;</font></div><div style="line-height: 22px;"   ><font size="2"   >return;</font></div><div style="line-height: 22px;"   ><font size="2"   >end;</font></div><div style="line-height: 22px;"   ><font size="2"   >$BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   >language plpgsql;</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >create or replace function f_user_login_sel_1</font></div><div style="line-height: 22px;"   ><font size="2"   >(i_userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_engname text,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_cnname text,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_occupation text,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_birthday date,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_signname text,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_email text,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_qq numeric</font></div><div style="line-height: 22px;"   ><font size="2"   >)</font></div><div style="line-height: 22px;"   ><font size="2"   >as $BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   >select userid,engname,cnname,occupation,birthday,signname,email,qq</font></div><div style="line-height: 22px;"   ><font size="2"   >into o_userid,o_engname,o_cnname,o_occupation,o_birthday,o_signname,o_email,o_qq</font></div><div style="line-height: 22px;"   ><font size="2"   >from user_info_1 where userid=i_userid;</font></div><div style="line-height: 22px;"   ><font size="2"   >return;</font></div><div style="line-height: 22px;"   ><font size="2"   >end;</font></div><div style="line-height: 22px;"   ><font size="2"   >$BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   >language plpgsql;</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >create or replace function f_user_login_sel_2</font></div><div style="line-height: 22px;"   ><font size="2"   >(i_userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_engname text,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_cnname text,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_occupation text,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_birthday date,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_signname text,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_email text,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_qq numeric</font></div><div style="line-height: 22px;"   ><font size="2"   >)</font></div><div style="line-height: 22px;"   ><font size="2"   >as $BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   >select userid,engname,cnname,occupation,birthday,signname,email,qq</font></div><div style="line-height: 22px;"   ><font size="2"   >into o_userid,o_engname,o_cnname,o_occupation,o_birthday,o_signname,o_email,o_qq</font></div><div style="line-height: 22px;"   ><font size="2"   >from user_info_2 where userid=i_userid;</font></div><div style="line-height: 22px;"   ><font size="2"   >return;</font></div><div style="line-height: 22px;"   ><font size="2"   >end;</font></div><div style="line-height: 22px;"   ><font size="2"   >$BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   >language plpgsql;</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >create or replace function f_user_login_sel_3</font></div><div style="line-height: 22px;"   ><font size="2"   >(i_userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_engname text,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_cnname text,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_occupation text,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_birthday date,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_signname text,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_email text,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_qq numeric</font></div><div style="line-height: 22px;"   ><font size="2"   >)</font></div><div style="line-height: 22px;"   ><font size="2"   >as $BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   >select userid,engname,cnname,occupation,birthday,signname,email,qq</font></div><div style="line-height: 22px;"   ><font size="2"   >into o_userid,o_engname,o_cnname,o_occupation,o_birthday,o_signname,o_email,o_qq</font></div><div style="line-height: 22px;"   ><font size="2"   >from user_info_3 where userid=i_userid;</font></div><div style="line-height: 22px;"   ><font size="2"   >return;</font></div><div style="line-height: 22px;"   ><font size="2"   >end;</font></div><div style="line-height: 22px;"   ><font size="2"   >$BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   >language plpgsql;</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >create or replace function f_user_login_sel_4</font></div><div style="line-height: 22px;"   ><font size="2"   >(i_userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_engname text,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_cnname text,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_occupation text,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_birthday date,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_signname text,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_email text,</font></div><div style="line-height: 22px;"   ><font size="2"   >OUT o_qq numeric</font></div><div style="line-height: 22px;"   ><font size="2"   >)</font></div><div style="line-height: 22px;"   ><font size="2"   >as $BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   >select userid,engname,cnname,occupation,birthday,signname,email,qq</font></div><div style="line-height: 22px;"   ><font size="2"   >into o_userid,o_engname,o_cnname,o_occupation,o_birthday,o_signname,o_email,o_qq</font></div><div style="line-height: 22px;"   ><font size="2"   >from user_info_4 where userid=i_userid;</font></div><div style="line-height: 22px;"   ><font size="2"   >return;</font></div><div style="line-height: 22px;"   ><font size="2"   >end;</font></div><div style="line-height: 22px;"   ><font size="2"   >$BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   >language plpgsql;</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >create or replace function f_user_login_insupd_0</font></div><div style="line-height: 22px;"   ><font size="2"   >(i_userid int</font></div><div style="line-height: 22px;"   ><font size="2"   >)</font></div><div style="line-height: 22px;"   ><font size="2"   >returns int as $BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   >insert into user_login_rec (userid,login_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div style="line-height: 22px;"   ><font size="2"   >update user_session_0 set logintime=now(),login_count=login_count+1 where userid=i_userid;</font></div><div style="line-height: 22px;"   ><font size="2"   >return 0;</font></div><div style="line-height: 22px;"   ><font size="2"   >exception</font></div><div style="line-height: 22px;"   ><font size="2"   >when others then</font></div><div style="line-height: 22px;"   ><font size="2"   >return 1;</font></div><div style="line-height: 22px;"   ><font size="2"   >end;</font></div><div style="line-height: 22px;"   ><font size="2"   >$BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   >language plpgsql;</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >create or replace function f_user_login_insupd_1</font></div><div style="line-height: 22px;"   ><font size="2"   >(i_userid int</font></div><div style="line-height: 22px;"   ><font size="2"   >)</font></div><div style="line-height: 22px;"   ><font size="2"   >returns int as $BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   >insert into user_login_rec (userid,login_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div style="line-height: 22px;"   ><font size="2"   >update user_session_1 set logintime=now(),login_count=login_count+1 where userid=i_userid;</font></div><div style="line-height: 22px;"   ><font size="2"   >return 0;</font></div><div style="line-height: 22px;"   ><font size="2"   >exception</font></div><div style="line-height: 22px;"   ><font size="2"   >when others then</font></div><div style="line-height: 22px;"   ><font size="2"   >return 1;</font></div><div style="line-height: 22px;"   ><font size="2"   >end;</font></div><div style="line-height: 22px;"   ><font size="2"   >$BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   >language plpgsql;</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >create or replace function f_user_login_insupd_2</font></div><div style="line-height: 22px;"   ><font size="2"   >(i_userid int</font></div><div style="line-height: 22px;"   ><font size="2"   >)</font></div><div style="line-height: 22px;"   ><font size="2"   >returns int as $BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   >insert into user_login_rec (userid,login_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div style="line-height: 22px;"   ><font size="2"   >update user_session_2 set logintime=now(),login_count=login_count+1 where userid=i_userid;</font></div><div style="line-height: 22px;"   ><font size="2"   >return 0;</font></div><div style="line-height: 22px;"   ><font size="2"   >exception</font></div><div style="line-height: 22px;"   ><font size="2"   >when others then</font></div><div style="line-height: 22px;"   ><font size="2"   >return 1;</font></div><div style="line-height: 22px;"   ><font size="2"   >end;</font></div><div style="line-height: 22px;"   ><font size="2"   >$BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   >language plpgsql;</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >create or replace function f_user_login_insupd_3</font></div><div style="line-height: 22px;"   ><font size="2"   >(i_userid int</font></div><div style="line-height: 22px;"   ><font size="2"   >)</font></div><div style="line-height: 22px;"   ><font size="2"   >returns int as $BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   >insert into user_login_rec (userid,login_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div style="line-height: 22px;"   ><font size="2"   >update user_session_3 set logintime=now(),login_count=login_count+1 where userid=i_userid;</font></div><div style="line-height: 22px;"   ><font size="2"   >return 0;</font></div><div style="line-height: 22px;"   ><font size="2"   >exception</font></div><div style="line-height: 22px;"   ><font size="2"   >when others then</font></div><div style="line-height: 22px;"   ><font size="2"   >return 1;</font></div><div style="line-height: 22px;"   ><font size="2"   >end;</font></div><div style="line-height: 22px;"   ><font size="2"   >$BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   >language plpgsql;</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >create or replace function f_user_login_insupd_4</font></div><div style="line-height: 22px;"   ><font size="2"   >(i_userid int</font></div><div style="line-height: 22px;"   ><font size="2"   >)</font></div><div style="line-height: 22px;"   ><font size="2"   >returns int as $BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   >insert into user_login_rec (userid,login_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div style="line-height: 22px;"   ><font size="2"   >update user_session_4 set logintime=now(),login_count=login_count+1 where userid=i_userid;</font></div><div style="line-height: 22px;"   ><font size="2"   >return 0;</font></div><div style="line-height: 22px;"   ><font size="2"   >exception</font></div><div style="line-height: 22px;"   ><font size="2"   >when others then</font></div><div style="line-height: 22px;"   ><font size="2"   >return 1;</font></div><div style="line-height: 22px;"   ><font size="2"   >end;</font></div><div style="line-height: 22px;"   ><font size="2"   >$BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   >language plpgsql;</font></div></pre></div></div><div style="line-height: 22px;"   >hot standby库也需要将数据加载到内存, 具体操作略.</div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >【调优阶段10】</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >1. 测试脚本</span></div><div><div style="line-height: 22px;"   >cat log*</div><div><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >\setrandom userid 1 4000000</font></div><div style="line-height: 22px;"   ><font size="2"   >SELECT f_user_login_insupd_0(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >\setrandom userid 4000001 8000000</font></div><div style="line-height: 22px;"   ><font size="2"   >SELECT f_user_login_insupd_1(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >\setrandom userid 8000001 12000000</font></div><div style="line-height: 22px;"   ><font size="2"   >SELECT f_user_login_insupd_2(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >\setrandom userid 12000001 16000000</font></div><div style="line-height: 22px;"   ><font size="2"   >SELECT f_user_login_insupd_3(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >\setrandom userid 16000001 20000000</font></div><div style="line-height: 22px;"   ><font size="2"   >SELECT f_user_login_insupd_4(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >\setrandom userid 1 4000000</font></div><div style="line-height: 22px;"   ><font size="2"   >SELECT f_user_login_sel_0(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >\setrandom userid 4000001 8000000</font></div><div style="line-height: 22px;"   ><font size="2"   >SELECT f_user_login_sel_1(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >\setrandom userid 8000001 12000000</font></div><div style="line-height: 22px;"   ><font size="2"   >SELECT f_user_login_sel_2(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >\setrandom userid 12000001 16000000</font></div><div style="line-height: 22px;"   ><font size="2"   >SELECT f_user_login_sel_3(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >\setrandom userid 16000001 20000000</font></div><div style="line-height: 22px;"   ><font size="2"   >SELECT f_user_login_sel_4(:userid);</font></div><p></p></pre></div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div></div><div style="line-height: 22px;"   >2. 压力测试</div><div><div><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 3 -f /home/postgres/test_zsplit/login_sel0.sql -j 3 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal &gt;./log.login_sel0 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 3 -f /home/postgres/test_zsplit/login_sel1.sql -j 3 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal &gt;./log.login_sel1 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 3 -f /home/postgres/test_zsplit/login_sel2.sql -j 3 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal &gt;./log.login_sel2 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 3 -f /home/postgres/test_zsplit/login_sel3.sql -j 3 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal &gt;./log.login_sel3 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 4 -f /home/postgres/test_zsplit/login_sel4.sql -j 4 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal &gt;./log.login_sel4 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 3 -f /home/postgres/test_zsplit/login_insupd0.sql -j 3 -n -T 180 -h 172.16.3.150 -p 1921 -U digoal digoal &gt;./log.login_insupd0 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 3 -f /home/postgres/test_zsplit/login_insupd1.sql -j 3 -n -T 180 -h 172.16.3.150 -p 1921 -U digoal digoal &gt;./log.login_insupd1 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 3 -f /home/postgres/test_zsplit/login_insupd2.sql -j 3 -n -T 180 -h 172.16.3.150 -p 1921 -U digoal digoal &gt;./log.login_insupd2 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 3 -f /home/postgres/test_zsplit/login_insupd3.sql -j 3 -n -T 180 -h 172.16.3.150 -p 1921 -U digoal digoal &gt;./log.login_insupd3 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 4 -f /home/postgres/test_zsplit/login_insupd4.sql -j 4 -n -T 180 -h 172.16.3.150 -p 1921 -U digoal digoal &gt;./log.login_insupd4 &amp;</font></div><p></p></pre></div></div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div><div style="line-height: 22px;"   >3. 测试结果</div><div style="line-height: 22px;"   >hot standby的测试数据 :&nbsp;</div><div><div style="line-height: 22px;"   >cat log.login_sel*</div><div><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 552618</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 3012.767914 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 3012.877330 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003166 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 4000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.988247 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_sel_0(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 750314</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 4089.671930 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 4089.771337 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003030 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 4000001 8000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.726462 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_sel_1(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 727839</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 3967.242817 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 3967.364415 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003260 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 8000001 12000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.748466 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_sel_2(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 715952</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 3903.028278 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 3903.130455 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003077 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 12000001 16000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.761439 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_sel_3(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 4</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 4</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 964366</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 5257.974345 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 5258.120849 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003153 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 16000001 20000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.753196 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_sel_4(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >总计 :&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 20230.685284 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 20231.264386 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >primary的测试数据 :&nbsp;</font></span></div><div style="line-height: 22px;"   ><font size="2"   >cat log.login_insupd*</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 745415</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 4141.145602 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 4141.250129 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003236 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 4000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.716912 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_insupd_0(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 737761</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 4098.582645 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 4098.704693 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003360 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 4000001 8000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.723997 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_insupd_1(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 761171</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 4228.709500 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 4228.817139 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003333 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 8000001 12000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.701648 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_insupd_2(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 761960</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 4233.031271 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 4233.166856 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003306 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 12000001 16000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.700967 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_insupd_3(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 4</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 4</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 999167</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 5550.893825 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 5551.246720 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.003385 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 16000001 20000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.712689 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_insupd_4(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >总计 :&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 22252.362843 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 22253.185537 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >QPS :&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >qps = 20230.685284 + (22252.362843 * 2) (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >qps = 20231.264386 + (22253.185537 * 2) (excluding connections establishing)</font></div><p></p></pre></div></div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div><div style="line-height: 22px;"   >4. 瓶颈分析与优化</div><div><div style="line-height: 22px;"   >主节点 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >avg-cpu: &nbsp;%user &nbsp; %nice %system %iowait &nbsp;%steal &nbsp; %idle</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 56.30 &nbsp; &nbsp;0.00 &nbsp; 21.72 &nbsp; &nbsp;4.24 &nbsp; &nbsp;0.00 &nbsp; 17.73</font></div><div style="line-height: 22px;"   ><font size="2"   >Device: &nbsp; &nbsp; &nbsp; &nbsp; rrqm/s &nbsp; wrqm/s &nbsp; r/s &nbsp; w/s &nbsp; rsec/s &nbsp; wsec/s avgrq-sz avgqu-sz &nbsp; await &nbsp;svctm &nbsp;%util</font></div><div style="line-height: 22px;"   ><font size="2"   >sda &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div style="line-height: 22px;"   ><font size="2"   >sda1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div style="line-height: 22px;"   ><font size="2"   >sda2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div style="line-height: 22px;"   ><font size="2"   >sda3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div style="line-height: 22px;"   ><font size="2"   >sdc &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.00 &nbsp;2781.50 &nbsp;0.00 93.50 &nbsp; &nbsp; 0.00 22876.00 &nbsp; 244.66 &nbsp; &nbsp; 0.09 &nbsp; &nbsp;0.93 &nbsp; 0.90 &nbsp; 8.40</font></div><div style="line-height: 22px;"   ><font size="2"   >sdd &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.00 10656.50 &nbsp;0.00 2302.50 &nbsp; &nbsp; 0.00 105300.00 &nbsp; &nbsp;45.73 &nbsp; 108.00 &nbsp; 27.85 &nbsp; 0.43 100.05</font></div><div style="line-height: 22px;"   ><font size="2"   >dm-0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 2875.50 &nbsp; &nbsp; 0.00 23004.00 &nbsp; &nbsp; 8.00 &nbsp; &nbsp; 2.56 &nbsp; &nbsp;0.89 &nbsp; 0.03 &nbsp; 8.30</font></div><div style="line-height: 22px;"   ><font size="2"   >dm-1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 12943.00 &nbsp; &nbsp; 0.00 103544.00 &nbsp; &nbsp; 8.00 &nbsp; 569.00 &nbsp; 34.94 &nbsp; 0.08 100.10</font></div><div style="line-height: 22px;"   ><font size="2"   >dm-2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 2832.50 &nbsp; &nbsp; 0.00 22660.00 &nbsp; &nbsp; 8.00 &nbsp; &nbsp; 2.55 &nbsp; &nbsp;0.90 &nbsp; 0.03 &nbsp; 8.05</font></div><div style="line-height: 22px;"   ><font size="2"   >dm-3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 41.50 &nbsp; &nbsp; 0.00 &nbsp; 332.00 &nbsp; &nbsp; 8.00 &nbsp; &nbsp; 0.02 &nbsp; &nbsp;0.54 &nbsp; 0.06 &nbsp; 0.25</font></div><div style="line-height: 22px;"   ><font size="2"   >dm-4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;1.50 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;12.00 &nbsp; &nbsp; 8.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div style="line-height: 22px;"   ><font size="2"   >dm-5 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;1.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 8.00 &nbsp; &nbsp; 8.00 &nbsp; &nbsp; 0.01 &nbsp; &nbsp;0.00 &nbsp; 4.00 &nbsp; 0.40</font></div><div style="line-height: 22px;"   ><font size="2"   >dm-6 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 11545.50 &nbsp; &nbsp; 0.00 92364.00 &nbsp; &nbsp; 8.00 &nbsp; 505.23 &nbsp; 33.04 &nbsp; 0.08 &nbsp;91.75</font></div><div style="line-height: 22px;"   ><font size="2"   >dm-7 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 1396.50 &nbsp; &nbsp; 0.00 11172.00 &nbsp; &nbsp; 8.00 &nbsp; &nbsp;63.54 &nbsp; 50.65 &nbsp; 0.15 &nbsp;20.65</font></div><p></p></pre></div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div><div style="line-height: 22px;"   >standby节点 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >avg-cpu: &nbsp;%user &nbsp; %nice %system %iowait &nbsp;%steal &nbsp; %idle</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp;0.00 &nbsp; &nbsp;0.31 &nbsp; 12.87 &nbsp; &nbsp;0.00 &nbsp; 86.82</font></div><div style="line-height: 22px;"   ><font size="2"   >Device: &nbsp; &nbsp; &nbsp; &nbsp; rrqm/s &nbsp; wrqm/s &nbsp; r/s &nbsp; w/s &nbsp; rsec/s &nbsp; wsec/s avgrq-sz avgqu-sz &nbsp; await &nbsp;svctm &nbsp;%util</font></div><div style="line-height: 22px;"   ><font size="2"   >cciss/c0d0 &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp;1222.39 &nbsp;0.00 996.52 &nbsp; &nbsp; 0.00 19136.32 &nbsp; &nbsp;19.20 &nbsp; 113.22 &nbsp;116.63 &nbsp; 1.00 &nbsp;99.55</font></div><div style="line-height: 22px;"   ><font size="2"   >cciss/c0d0p1 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 2.99 &nbsp;0.00 &nbsp;1.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;31.84 &nbsp; &nbsp;32.00 &nbsp; &nbsp; 0.10 &nbsp;101.50 101.50 &nbsp;10.10</font></div><div style="line-height: 22px;"   ><font size="2"   >cciss/c0d0p2 &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div style="line-height: 22px;"   ><font size="2"   >cciss/c0d0p3 &nbsp; &nbsp; &nbsp;0.00 &nbsp;1219.40 &nbsp;0.00 995.52 &nbsp; &nbsp; 0.00 19104.48 &nbsp; &nbsp;19.19 &nbsp; 113.12 &nbsp;116.64 &nbsp; 1.00 &nbsp;99.55</font></div><div style="line-height: 22px;"   ><font size="2"   >cciss/c0d1 &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div style="line-height: 22px;"   ><font size="2"   >cciss/c0d2 &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp;1384.08 &nbsp;0.00 251.74 &nbsp; &nbsp; 0.00 13297.51 &nbsp; &nbsp;52.82 &nbsp; 142.31 &nbsp;522.75 &nbsp; 3.95 &nbsp;99.55</font></div><div style="line-height: 22px;"   ><font size="2"   >cciss/c0d3 &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div style="line-height: 22px;"   ><font size="2"   >cciss/c0d4 &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div style="line-height: 22px;"   ><font size="2"   >cciss/c0d5 &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div style="line-height: 22px;"   ><font size="2"   >dm-0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div style="line-height: 22px;"   ><font size="2"   >dm-1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 1638.81 &nbsp; &nbsp; 0.00 13110.45 &nbsp; &nbsp; 8.00 &nbsp; 946.36 &nbsp;538.61 &nbsp; 0.61 &nbsp;99.55</font></div><div style="line-height: 22px;"   ><font size="2"   >dm-2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div style="line-height: 22px;"   ><font size="2"   >dm-3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div style="line-height: 22px;"   ><font size="2"   >dm-4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp; 0.00 &nbsp; &nbsp;0.00 &nbsp; 0.00 &nbsp; 0.00</font></div><div style="line-height: 22px;"   ><font size="2"   >dm-5 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0.00 &nbsp; &nbsp; 0.00 &nbsp;0.00 2193.03 &nbsp; &nbsp; 0.00 17544.28 &nbsp; &nbsp; 8.00 &nbsp; 275.53 &nbsp;132.89 &nbsp; 0.45 &nbsp;99.55</font></div><p></p></pre></div><div style="line-height: 22px;"   >显然IO到达瓶颈了. 为什么每次IO都顶不住呢? 是的, 机械硬盘的随机IOPS能力就是这么差, 不要有太高的奢望.</div></div><div style="line-height: 22px;"   >要提升IOPS要么就用高端存储要么就选择SSD硬盘. 下次有机会找块ssd硬盘来测试一下它的iops能力到底有多强.</div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   >那么这些IO是怎么产生的呢?</div><div style="line-height: 22px;"   >1. 主库的IO来自insert和update请求.</div><div style="line-height: 22px;"   >2. hot standby的IO来自stream data recovery.</div><div style="line-height: 22px;"   >因为我的测试环境没有办法扩存储, 所以这里就不通过扩存储来解决这个瓶颈了, 还是加服务器.&nbsp;</div><div style="line-height: 22px;"   >但是这次加2台服务器, 1台用来做hot standby. 另一台我要把insert请求剥离过去.</div><div style="line-height: 22px;"   >也就是总共用4台服务器.</div><div style="line-height: 22px;"   >具体的操作如下 :&nbsp;</div><div><div style="line-height: 22px;"   >初始化新增的日志库 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >create table user_login_rec</font></div><div style="line-height: 22px;"   ><font size="2"   >(userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   >login_time timestamp without time zone,</font></div><div style="line-height: 22px;"   ><font size="2"   >ip inet</font></div><div style="line-height: 22px;"   ><font size="2"   >);</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >create table user_logout_rec</font></div><div style="line-height: 22px;"   ><font size="2"   >(userid int,</font></div><div style="line-height: 22px;"   ><font size="2"   >logout_time timestamp without time zone,</font></div><div style="line-height: 22px;"   ><font size="2"   >ip inet</font></div><div style="line-height: 22px;"   ><font size="2"   >);</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >create or replace function f_user_login_ins</font></div><div style="line-height: 22px;"   ><font size="2"   >(i_userid int)</font></div><div style="line-height: 22px;"   ><font size="2"   >returns int as $BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   >insert into user_login_rec (userid,login_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div style="line-height: 22px;"   ><font size="2"   >return 0;</font></div><div style="line-height: 22px;"   ><font size="2"   >exception</font></div><div style="line-height: 22px;"   ><font size="2"   >when others then</font></div><div style="line-height: 22px;"   ><font size="2"   >return 1;</font></div><div style="line-height: 22px;"   ><font size="2"   >end;</font></div><div style="line-height: 22px;"   ><font size="2"   >$BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   >language plpgsql;</font></div><p></p></pre></div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div><div style="line-height: 22px;"   >主库新增函数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >create or replace function f_user_login_upd_0</font></div><div style="line-height: 22px;"   ><font size="2"   >(i_userid int</font></div><div style="line-height: 22px;"   ><font size="2"   >)</font></div><div style="line-height: 22px;"   ><font size="2"   >returns int as $BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   >update user_session_0 set logintime=now(),login_count=login_count+1 where userid=i_userid;</font></div><div style="line-height: 22px;"   ><font size="2"   >return 0;</font></div><div style="line-height: 22px;"   ><font size="2"   >exception</font></div><div style="line-height: 22px;"   ><font size="2"   >when others then</font></div><div style="line-height: 22px;"   ><font size="2"   >return 1;</font></div><div style="line-height: 22px;"   ><font size="2"   >end;</font></div><div style="line-height: 22px;"   ><font size="2"   >$BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   >language plpgsql;</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >create or replace function f_user_login_upd_1</font></div><div style="line-height: 22px;"   ><font size="2"   >(i_userid int</font></div><div style="line-height: 22px;"   ><font size="2"   >)</font></div><div style="line-height: 22px;"   ><font size="2"   >returns int as $BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   >update user_session_1 set logintime=now(),login_count=login_count+1 where userid=i_userid;</font></div><div style="line-height: 22px;"   ><font size="2"   >return 0;</font></div><div style="line-height: 22px;"   ><font size="2"   >exception</font></div><div style="line-height: 22px;"   ><font size="2"   >when others then</font></div><div style="line-height: 22px;"   ><font size="2"   >return 1;</font></div><div style="line-height: 22px;"   ><font size="2"   >end;</font></div><div style="line-height: 22px;"   ><font size="2"   >$BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   >language plpgsql;</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >create or replace function f_user_login_upd_2</font></div><div style="line-height: 22px;"   ><font size="2"   >(i_userid int</font></div><div style="line-height: 22px;"   ><font size="2"   >)</font></div><div style="line-height: 22px;"   ><font size="2"   >returns int as $BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   >update user_session_2 set logintime=now(),login_count=login_count+1 where userid=i_userid;</font></div><div style="line-height: 22px;"   ><font size="2"   >return 0;</font></div><div style="line-height: 22px;"   ><font size="2"   >exception</font></div><div style="line-height: 22px;"   ><font size="2"   >when others then</font></div><div style="line-height: 22px;"   ><font size="2"   >return 1;</font></div><div style="line-height: 22px;"   ><font size="2"   >end;</font></div><div style="line-height: 22px;"   ><font size="2"   >$BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   >language plpgsql;</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >create or replace function f_user_login_upd_3</font></div><div style="line-height: 22px;"   ><font size="2"   >(i_userid int</font></div><div style="line-height: 22px;"   ><font size="2"   >)</font></div><div style="line-height: 22px;"   ><font size="2"   >returns int as $BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   >update user_session_3 set logintime=now(),login_count=login_count+1 where userid=i_userid;</font></div><div style="line-height: 22px;"   ><font size="2"   >return 0;</font></div><div style="line-height: 22px;"   ><font size="2"   >exception</font></div><div style="line-height: 22px;"   ><font size="2"   >when others then</font></div><div style="line-height: 22px;"   ><font size="2"   >return 1;</font></div><div style="line-height: 22px;"   ><font size="2"   >end;</font></div><div style="line-height: 22px;"   ><font size="2"   >$BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   >language plpgsql;</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >create or replace function f_user_login_upd_4</font></div><div style="line-height: 22px;"   ><font size="2"   >(i_userid int</font></div><div style="line-height: 22px;"   ><font size="2"   >)</font></div><div style="line-height: 22px;"   ><font size="2"   >returns int as $BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   >declare</font></div><div style="line-height: 22px;"   ><font size="2"   >begin</font></div><div style="line-height: 22px;"   ><font size="2"   >update user_session_4 set logintime=now(),login_count=login_count+1 where userid=i_userid;</font></div><div style="line-height: 22px;"   ><font size="2"   >return 0;</font></div><div style="line-height: 22px;"   ><font size="2"   >exception</font></div><div style="line-height: 22px;"   ><font size="2"   >when others then</font></div><div style="line-height: 22px;"   ><font size="2"   >return 1;</font></div><div style="line-height: 22px;"   ><font size="2"   >end;</font></div><div style="line-height: 22px;"   ><font size="2"   >$BODY$</font></div><div style="line-height: 22px;"   ><font size="2"   >language plpgsql;</font></div></pre></div><div style="line-height: 22px;"   >再增加一台standby, 流复制过程略, 请参考我写过的流复制环境搭建BLOG.</div><div style="line-height: 22px;"   >《PostgreSQL HOT STANDBY using Stream》</div><div style="line-height: 22px;"   ><a style="line-height: 22px; " href="http://blog.163.com/digoal@126/blog/static/16387704020110442050808/"   >http://blog.163.com/digoal@126/blog/static/16387704020110442050808/</a></div><div style="line-height: 22px;"   >优化当前环境如下,</div><div><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >primary : 172.16.3.150</font></div><div style="line-height: 22px;"   ><font size="2"   >standby1 : 172.16.3.33</font></div><div style="line-height: 22px;"   ><font size="2"   >standby2 : 172.16.3.39</font></div><div style="line-height: 22px;"   ><font size="2"   >logdb : 172.16.3.40</font></div><p></p></pre></div></div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >【调优阶段11】</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >1. 测试脚本</span></div><div><div style="line-height: 22px;"   >postgres@db5-&gt; cat login_ins.sql&nbsp;</div><div><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >\setrandom userid 1 20000000</font></div><div style="line-height: 22px;"   ><font size="2"   >SELECT f_user_login_ins(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >postgres@db5-&gt; cat login_sel*</font></div><div style="line-height: 22px;"   ><font size="2"   >\setrandom userid 1 4000000</font></div><div style="line-height: 22px;"   ><font size="2"   >SELECT f_user_login_sel_0(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >\setrandom userid 4000001 8000000</font></div><div style="line-height: 22px;"   ><font size="2"   >SELECT f_user_login_sel_1(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >\setrandom userid 8000001 12000000</font></div><div style="line-height: 22px;"   ><font size="2"   >SELECT f_user_login_sel_2(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >\setrandom userid 12000001 16000000</font></div><div style="line-height: 22px;"   ><font size="2"   >SELECT f_user_login_sel_3(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >\setrandom userid 16000001 20000000</font></div><div style="line-height: 22px;"   ><font size="2"   >SELECT f_user_login_sel_4(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >postgres@db5-&gt; cat login_upd*</font></div><div style="line-height: 22px;"   ><font size="2"   >\setrandom userid 1 4000000</font></div><div style="line-height: 22px;"   ><font size="2"   >SELECT f_user_login_upd_0(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >\setrandom userid 4000001 8000000</font></div><div style="line-height: 22px;"   ><font size="2"   >SELECT f_user_login_upd_1(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >\setrandom userid 8000001 12000000</font></div><div style="line-height: 22px;"   ><font size="2"   >SELECT f_user_login_upd_2(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >\setrandom userid 12000001 16000000</font></div><div style="line-height: 22px;"   ><font size="2"   >SELECT f_user_login_upd_3(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >\setrandom userid 16000001 20000000</font></div><div style="line-height: 22px;"   ><font size="2"   >SELECT f_user_login_upd_4(:userid);</font></div><p></p></pre></div></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >2. 压力测试</span></div><div><div><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 3 -f /home/postgres/test_zsplit/login_sel0.sql -j 3 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal &gt;./log.login33_sel0 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 3 -f /home/postgres/test_zsplit/login_sel1.sql -j 3 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal &gt;./log.login33_sel1 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 3 -f /home/postgres/test_zsplit/login_sel2.sql -j 3 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal &gt;./log.login33_sel2 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 3 -f /home/postgres/test_zsplit/login_sel3.sql -j 3 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal &gt;./log.login33_sel3 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 4 -f /home/postgres/test_zsplit/login_sel4.sql -j 4 -n -T 180 -h 172.16.3.33 -p 1921 -U digoal digoal &gt;./log.login33_sel4 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 3 -f /home/postgres/test_zsplit/login_sel0.sql -j 3 -n -T 180 -h 172.16.3.39 -p 1921 -U digoal digoal &gt;./log.login39_sel0 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 3 -f /home/postgres/test_zsplit/login_sel1.sql -j 3 -n -T 180 -h 172.16.3.39 -p 1921 -U digoal digoal &gt;./log.login39_sel1 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 3 -f /home/postgres/test_zsplit/login_sel2.sql -j 3 -n -T 180 -h 172.16.3.39 -p 1921 -U digoal digoal &gt;./log.login39_sel2 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 3 -f /home/postgres/test_zsplit/login_sel3.sql -j 3 -n -T 180 -h 172.16.3.39 -p 1921 -U digoal digoal &gt;./log.login39_sel3 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 4 -f /home/postgres/test_zsplit/login_sel4.sql -j 4 -n -T 180 -h 172.16.3.39 -p 1921 -U digoal digoal &gt;./log.login39_sel4 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 3 -f /home/postgres/test_zsplit/login_upd0.sql -j 3 -n -T 180 -h 172.16.3.150 -p 1921 -U digoal digoal &gt;./log.login_upd0 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 3 -f /home/postgres/test_zsplit/login_upd1.sql -j 3 -n -T 180 -h 172.16.3.150 -p 1921 -U digoal digoal &gt;./log.login_upd1 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 3 -f /home/postgres/test_zsplit/login_upd2.sql -j 3 -n -T 180 -h 172.16.3.150 -p 1921 -U digoal digoal &gt;./log.login_upd2 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 3 -f /home/postgres/test_zsplit/login_upd3.sql -j 3 -n -T 180 -h 172.16.3.150 -p 1921 -U digoal digoal &gt;./log.login_upd3 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 4 -f /home/postgres/test_zsplit/login_upd4.sql -j 4 -n -T 180 -h 172.16.3.150 -p 1921 -U digoal digoal &gt;./log.login_upd4 &amp;</font></div><div style="line-height: 22px;"   ><font size="2"   >pgbench -M prepared -r -c 16 -f /home/postgres/test_zsplit/login_ins.sql -j 16 -n -T 180 -h 172.16.3.40 -p 1921 -U digoal digoal &gt;./log.login_ins &amp;</font></div><p></p></pre></div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >3. 测试结果</span></div><div><div style="line-height: 22px;"   >cat log.login33_sel*</div><div><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 1534211</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 8523.315651 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 8523.524318 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002438 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 4000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.346514 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_sel_0(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 1533785</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 8520.894378 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 8521.168645 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002423 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 4000001 8000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.346564 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_sel_1(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 1544585</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 8580.974433 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 8581.260902 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002448 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 8000001 12000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.344071 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_sel_2(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 1482080</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 8233.719776 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 8234.138037 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002435 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 12000001 16000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.358877 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_sel_3(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 4</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 4</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 1982503</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 11013.842899 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 11014.329592 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002422 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 16000001 20000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.357698 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_sel_4(:userid);</font></div><p></p></pre></div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div><div style="line-height: 22px;"   >cat log.login39_sel*</div><div><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 1534696</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 8526.005287 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 8526.221472 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002436 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 4000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.346352 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_sel_0(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 1542513</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 8569.192037 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 8569.392061 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002416 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 4000001 8000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.344625 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_sel_1(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 1508389</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 8379.888796 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 8380.257897 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002426 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 8000001 12000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.352536 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_sel_2(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 1491690</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 8287.124725 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 8287.453198 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002464 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 12000001 16000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.356436 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_sel_3(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 4</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 4</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 2014650</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 11192.426565 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 11192.867173 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002418 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 16000001 20000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.351905 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_sel_4(:userid);</font></div><p></p></pre></div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div><div style="line-height: 22px;"   >cat log.login_ins&nbsp;</div><div><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 16</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 16</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 7091331</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 39394.952222 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 39397.035365 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002984 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 20000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.399208 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_ins(:userid);</font></div><p></p></pre></div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   >cat log.login_upd*</div><div><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 968016</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 5377.633815 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 5377.769568 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002434 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 4000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.552395 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_upd_0(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 965529</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 5363.841108 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 5364.017826 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002461 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 4000001 8000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.553797 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_upd_1(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 969904</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 5388.302421 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 5388.476038 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002436 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 8000001 12000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.551348 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_upd_2(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 3</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 990833</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 5504.605729 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 5504.844893 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002448 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 12000001 16000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.539510 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_upd_3(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   >transaction type: Custom query</font></div><div style="line-height: 22px;"   ><font size="2"   >scaling factor: 1</font></div><div style="line-height: 22px;"   ><font size="2"   >query mode: prepared</font></div><div style="line-height: 22px;"   ><font size="2"   >number of clients: 4</font></div><div style="line-height: 22px;"   ><font size="2"   >number of threads: 4</font></div><div style="line-height: 22px;"   ><font size="2"   >duration: 180 s</font></div><div style="line-height: 22px;"   ><font size="2"   >number of transactions actually processed: 1316258</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 7312.497604 (including connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >tps = 7312.837009 (excluding connections establishing)</font></div><div style="line-height: 22px;"   ><font size="2"   >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002405 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 16000001 20000000</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.541622 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_upd_4(:userid);</font></div><div style="line-height: 22px;"   ><font size="2"   ><br style="line-height: 22px;"   ></font></div><div style="line-height: 22px;"   ><font size="2"   >总计 :&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >QPS :&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >158169.217446 ( select 89827.384547, insert 39394.952222, update 28946.880677 )</font></div><div style="line-height: 22px;"   ><font size="2"   >158175.593994 ( select 89830.613295, insert 39397.035365, update 28947.945334 )</font></div><p></p></pre></div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >4. 瓶颈分析与优化</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >如果前面的拆库是纵向的拆的话, 那么接下来要提升性能就得横向的来拆了.</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >例如 :&nbsp;</span></div><div><div>select能力可以通过数据库流复制扩展, 9.2以后可以级联复制因此基本上可以做到不影响主库性能的情况下无限扩展.</div><div>insert能力可以通过增加logdb服务器扩展, 无限扩展.</div><div>update能力可以通过将表拆分到多个服务器上, 无限扩展.</div><div>横向分库,需要考虑跨库事务的问题, 1.plproxy</div><div>参考 :&nbsp;</div><div>《A Smart PostgreSQL extension plproxy 2.2 practices》</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201192535630895/"   >http://blog.163.com/digoal@126/blog/static/163877040201192535630895/</a></div></div><div><br></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >【调优阶段12】</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >本文的最后一个阶段, 由于服务器有限, 所以我这里测试的是一个节点的性能, 以前测试过plproxy, 性能是线性扩展的.</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >因此测试一个节点基本上就可以推算出多节点的性能.</span></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >1. 压力测试</span></div><div><div><pre class="prettyprint"   ><p><font size="2"   >pgbench -M prepared -r -c 16 -f /home/postgres/test_zsplit/login_upd0.sql -j 16 -n -T 180 -h 172.16.3.150 -p 1921 -U digoal digoal &gt;./log.login_upd0 &amp;</font></p></pre></div><div>2. 测试结果</div><div>cat log.login_upd0</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 16</font></div><div><font size="2"   >duration: 180 s</font></div><div><font size="2"   >number of transactions actually processed: 6015759</font></div><div><font size="2"   >tps = 33416.574452 (including connections establishing)</font></div><div><font size="2"   >tps = 33419.030898 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002152 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 4000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.473792 &nbsp; &nbsp; &nbsp; &nbsp;SELECT f_user_login_upd_0(:userid);</font></div><div><font size="2"   >因此5个节点的性能约等于 :&nbsp;</font></div><div><font size="2"   >tps = 167082.872260 ( 33416.574452 * 5 ) (including connections establishing)</font></div><div><font size="2"   >tps = 167095.154490 ( 33419.030898 * 5 ) (excluding connections establishing)</font></div><p></p></pre></div></div><div>3. 瓶颈分析与优化</div><div>同11阶段 :&nbsp;</div><div><div style="line-height: 22px;"   >select能力可以通过数据库流复制扩展, 9.2以后可以级联复制因此基本上可以做到不影响主库性能的情况下无限扩展.</div><div style="line-height: 22px;"   >insert能力可以通过增加logdb服务器扩展, 无限扩展.</div><div style="line-height: 22px;"   >update能力可以通过将表拆分到多个服务器上, 无限扩展.</div><div style="line-height: 22px;"   >横向分库,需要考虑跨库事务的问题, 1.plproxy</div></div><div><br></div><div style="line-height: 22px;"   >【调优性能图表1】</div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><img title="PostgreSQL性能优化综合案例讲解 - 2 - 德哥@Digoal - The Heart,The World."   alt="PostgreSQL性能优化综合案例讲解 - 2 - 德哥@Digoal - The Heart,The World."   src="http://img7.ph.126.net/fm_9PMN1ka493SvjnTNAWw==/1175439502761017587.jpg"   style="line-height: 22px; border-style: initial; border-color: initial; margin-top: 0px; margin-right: 10px; margin-bottom: 0px; margin-left: 0px;"   ></div>&nbsp;</div><div style="line-height: 22px;"   >【调优性能图表2】</div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><img title="PostgreSQL性能优化综合案例讲解 - 2 - 德哥@Digoal - The Heart,The World."   alt="PostgreSQL性能优化综合案例讲解 - 2 - 德哥@Digoal - The Heart,The World."   src="http://img3.ph.126.net/FdAGlJ9zhC6tGdcNdQP1hg==/631911322732736153.jpg"   style="line-height: 22px; border-style: initial; border-color: initial; margin-top: 0px; margin-right: 10px; margin-bottom: 0px; margin-left: 0px;"   ></div>&nbsp;</div><div style="line-height: 22px;"   ><br style="line-height: 22px;"   ></div><div style="line-height: 22px;"   >【其他可优化点补充】</div><div style="line-height: 22px;"   >1.&nbsp;批量提交,降低IO请求量, 并发请求很高的场景. 但是当并发场景这么高的时候已经可以考虑增加服务器分库了.</div><div style="line-height: 22px;"   >相关参数</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#commit_delay = 0</font></div><div><font size="2"   >#commit_siblings = 5</font></div><p></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >参考《Test PostgreSQL 9.1's group commit》</span></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402011102214142132/"   >http://blog.163.com/digoal@126/blog/static/1638770402011102214142132/</a></div><div style="line-height: 22px;"   >2.&nbsp;连接池,如pgbouncer(适用于短连接, 大量空闲连接的情况.)</div><div style="line-height: 22px;"   >3. 绑定变量, 性能提升参考</div><div><div style="line-height: 22px;"   >《how many performance decreased use dynamic SQL》</div><div style="line-height: 22px;"   ><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402011109103953350/"   >http://blog.163.com/digoal@126/blog/static/1638770402011109103953350/</a></div><div style="line-height: 22px;"   >4. user_session中记录了用户的登陆统计信息和退出统计信息, 由于MVCC特性, 每次更新都会新产生一条tuple, 因此如果将登陆和退出的统计拆开, &nbsp;就能减少新增的tuple的大小. 一定程度上提升性能.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >user_session_login (userid,&nbsp;logintime,&nbsp;login_count)</font></div></div><div><font size="2"   >user_session_logout (userid, logouttime, online_interval)</font></div><p></p></pre></div></div><div style="line-height: 22px;"   >5. OS级别也有可以优化的地方, 比如文件系统的mount参数可以加上noatime.</div><div style="line-height: 22px;"   >6. 服务器硬件也有可以优化的地方, 比如numa.</div><div><div>7. PostgreSQL也还有可以微调的参数, 比如bgwriter_lru_maxpages和bgwriter_lru_multiplier它们的值也将影响数据库和文件系统交互的频率以及每次交互产生的io请求数.</div><div style="line-height: 22px;"   >8. 在做分表优化的时候, 本例使用的是按userid分段拆分成了5个表. 其实还可以按hash取模拆, 按时间段拆等等. 拆分的关键是尽量按照常用的条件字段进行拆分. 另外需要注意的是, 我这里没有提到PostgreSQL的partition table的实现, 而是直接使用应用端来识别数据在哪个分区. 原因是PostgreSQL的partition table需要通过rule或者触发器来实现, 大量的消耗数据库服务器的CPU, 不推荐使用. 性能下降和Oracle的比较可参考,</div></div><div><div>&nbsp; 《execute plan difference between Oracle and PostgreSQL's partition table》</div><div>&nbsp;&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201212432441676/"   >http://blog.163.com/digoal@126/blog/static/163877040201212432441676/</a></div><div>&nbsp; 《Compare Oracle's &amp; PostgreSQL's Partition Table write performance》</div><div>&nbsp;&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201123084853271/"   >http://blog.163.com/digoal@126/blog/static/163877040201123084853271/</a></div><div>&nbsp; 《PostgreSQL partition table's arithmetic tuning example》</div><div>&nbsp;&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402011210114036419/"   >http://blog.163.com/digoal@126/blog/static/1638770402011210114036419/</a></div></div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   >【小结】</div><div style="line-height: 22px;"   >1. 诊断角度</div><div style="line-height: 22px;"   >操作系统层面:&nbsp;<span style="line-height: 22px;"   >查看CPU, IO.</span></div><div style="line-height: 22px;"   >数据库层面:&nbsp;</div><div style="line-height: 22px;"   >查看pg_stat_statements</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;Column &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; Type &nbsp; &nbsp; &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"   >---------------------+------------------+-----------</font></div><div><font size="2"   >&nbsp;userid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;dbid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;query &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;calls &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;total_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| double precision |&nbsp;</font></div><div><font size="2"   >&nbsp;rows &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;shared_blks_hit &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;shared_blks_read &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;shared_blks_written | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;local_blks_hit &nbsp; &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;local_blks_read &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;local_blks_written &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;temp_blks_read &nbsp; &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;temp_blks_written &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><p></p></pre></div><div>其他pg_stat性能视图</div><div>日志中的long SQL,</div><div><div>2. 优化角度</div><div>参数, SQL, 架构, 连接池, 表空间拆分, 存储cache, 分表, 分库</div></div><div><br></div><div style="line-height: 22px;"   >【参考】</div><div><div>1.《PostgreSQL HOT STANDBY using Stream》</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020110442050808/"   >http://blog.163.com/digoal@126/blog/static/16387704020110442050808/</a></div><div>2.《A Smart PostgreSQL extension plproxy 2.2 practices》</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201192535630895/"   >http://blog.163.com/digoal@126/blog/static/163877040201192535630895/</a></div><div>3.《Test PostgreSQL 9.1's group commit》</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402011102214142132/"   >http://blog.163.com/digoal@126/blog/static/1638770402011102214142132/</a></div><div>4.《how many performance decreased use dynamic SQL》</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402011109103953350/"   >http://blog.163.com/digoal@126/blog/static/1638770402011109103953350/</a></div><div>5.《execute plan difference between Oracle and PostgreSQL's partition table》</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201212432441676/"   >http://blog.163.com/digoal@126/blog/static/163877040201212432441676/</a></div><div>6.《Compare Oracle's &amp; PostgreSQL's Partition Table write performance》</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201123084853271/"   >http://blog.163.com/digoal@126/blog/static/163877040201123084853271/</a></div><div>7.《PostgreSQL partition table's arithmetic tuning example》</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402011210114036419/"   >http://blog.163.com/digoal@126/blog/static/1638770402011210114036419/</a></div><div>8.《Use pgbench test Your PostgreSQL DBSystem performace》</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201151534631313/"   >http://blog.163.com/digoal@126/blog/static/163877040201151534631313/</a></div><div>9.《Use pg_test_fsync test which wal_sync_method is fastest in your filesystem》</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201141795025354/"   >http://blog.163.com/digoal@126/blog/static/163877040201141795025354/</a></div><div>10.《a powerful upgrade from pgfincore 1.0》</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402011630102117658/"   >http://blog.163.com/digoal@126/blog/static/1638770402011630102117658/</a></div><div>11.《use posix_fadvise pre-cache frequency data》</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201062944945126/"   >http://blog.163.com/digoal@126/blog/static/163877040201062944945126/</a></div><div>12.《TOAST table with pgfincore》</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020120524144140/"   >http://blog.163.com/digoal@126/blog/static/16387704020120524144140/</a></div><div>13.《PostgreSQL and Oracle's async commit》</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020121229223072/"   >http://blog.163.com/digoal@126/blog/static/16387704020121229223072/</a></div></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL性能优化综合案例讲解 - 2 - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">freya - 2014-09-19 14:57:45</h5>
				<div>以前看不能完全领会，，现在看感觉分厂赞！！谢谢德哥。。</div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 freya - 2014-09-19 14:57:45</h5>
				<div style="width:600px;">优化需要下功夫, 勤加修炼. 回过头去看以前写的文章, 有些观点还是比较片面的.</div>
			</div>
			<div id="">
				<h5 id="">zhangqhd511 - 2013-12-11 14:56:16</h5>
				<div>德哥真的用心。感谢。辛苦。</div>
			</div>
			<div id="">
				<h5 id="">刺客 - 2013-04-09 10:48:49</h5>
				<div>感谢博主,最近刚学这个.</div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 刺客 - 2013-04-09 10:48:49</h5>
				<div style="width:600px;">希望对PostgreSQL爱好者有所帮助.</div>
			</div>
			<div id="">
				<h5 id="">码农 - 2013-02-04 11:15:47</h5>
				<div>看得好晕。。这些是不是只有DBA才去做的，一般码农做不了啊。。。</div>
			</div>
			<div id="">
				<h5 id="">subaochen@126 - 2012-10-29 15:38:56</h5>
				<div>分析的不错，博主下了不少功夫！</div>
			</div>
	</div>
</div>
</body>
</html>