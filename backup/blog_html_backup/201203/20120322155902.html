<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Ruby Study 11 : Blocks, Procs, and Lambdas</h2>
	<h5 id="">2012-03-22 15:59:02&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402012221105853250/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><font size="2"  style="line-height: 23px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"  ><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  style="line-height: 23px;"  ><span style="line-height: 23px;"  >Block在前面的讲解中已经多次用到, 这个章节来详细讲解一下.</span></font></font></div><div><font size="2"  style="line-height: 23px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"  ><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  style="line-height: 23px;"  ><span style="line-height: 23px;"  >需要注意的是Block在1.8和1.9中有一些</span></font></font><span style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; font-size: small; line-height: 23px;"  >特性</span><span style="line-height: 23px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; font-size: small;"  >是截然不同的, 所以需要特别注意. 尽量避免发生这样的情况, 否则你的代码在1.8可以跑, 1.9就有可能出问题了</span></div><div><font size="2"  style="line-height: 23px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"  ><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  style="line-height: 23px;"  ><span style="line-height: 23px;"  >1. What is a Block?</span></font></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >看个例子 :&nbsp;</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><div style="line-height: 23px;"  ><pre class="prettyprint"  ><p></p><div>3.times <span style="background-color: rgb(51, 204, 204);"  >do |i|</span></div><div><span style="background-color: rgb(51, 204, 204);"  >&nbsp; &nbsp; puts( i )</span></div><div><span style="background-color: rgb(51, 204, 204);"  >end</span></div><div><br></div><div><div>3.times <span style="background-color: rgb(0, 255, 255);"  >{ |i|</span></div><div><span style="background-color: rgb(0, 255, 255);"  >&nbsp; &nbsp; puts( i )</span></div><div><span style="background-color: rgb(0, 255, 255);"  >}</span></div></div><p></p></pre></div><div style="line-height: 23px;"  >蓝底的部分就是Block. 即do end,和{}的部分.</div><div style="line-height: 23px;"  >Block由声明部分和代码部分组成, 声明部分是do end或{}. 代码部分包含Block parameters ( ||中的就是Block parameters, 多个用逗号隔开如|a,b| )和代码.</div><div style="line-height: 23px;"  >Block parameter的值来自调用这个Block的方法,&nbsp;<span style="line-height: 23px;"  >或者由yield方法的参数传递.</span></div><div style="line-height: 23px;"  ><span style="line-height: 23px;"  >例如 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div>b1 = proc{|x| x+1}</div><div>p b1.yield(1)</div><p></p></pre></div><div style="line-height: 23px;"  >执行结果</div><div style="line-height: 23px;"  ><pre class="prettyprint"  ><p>2</p></pre></div><div style="line-height: 23px;"  ><span style="line-height: 23px;"  ><br></span></div><div style="line-height: 23px;"  ><span style="line-height: 23px;"  >2. Line Breaks are Significant</span></div><div style="line-height: 23px;"  ><span style="line-height: 23px;"  >指接收Block的方法和Block的首定义如do或{ 必须在同一行, 否则会报语法错误.</span></div><div style="line-height: 23px;"  ><span style="line-height: 23px;"  >例如, 正确的写法 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><div>3.times do |i|</div><div>&nbsp; &nbsp; puts( i )</div><div>end</div></div><div>或</div><div><div>3.times { |i|</div><div>&nbsp; &nbsp; puts( i )</div><div>}</div></div><p></p></pre></div><div>错误的写法 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div>3.times&nbsp;</div><div>do |i|</div><div>&nbsp; &nbsp; puts( i )</div><div>end</div></div><div>或</div><div><div>3.times&nbsp;</div><div>{ |i|</div><div>&nbsp; &nbsp; puts( i )</div><div>}</div></div><p></p></pre></div><div style="line-height: 23px;"  ><span style="line-height: 23px;"  ><br></span></div></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >3. Nameless Function</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >Block非常像没有名字的方法, 例如 :&nbsp;</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><div style="line-height: 23px;"  ><pre class="prettyprint"  ><p></p><div>{ |i|</div><div>&nbsp; &nbsp; puts( i )</div><div>}</div><p></p></pre></div><div style="line-height: 23px;"  >它对应有名字的方法 :&nbsp;</div><div style="line-height: 23px;"  ><pre class="prettyprint"  ><p></p><div>def aMethod( i )</div><div>&nbsp; &nbsp;puts( i )</div><div>end</div><p></p></pre></div><div style="line-height: 23px;"  >它们的调用场景 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div>for i in (0..2) do</div><div>&nbsp; &nbsp; aMethod(i)</div><div>end</div><div><br></div><div>(0..2).each do |x|</div><div>&nbsp; &nbsp; puts(x)</div><div>end</div><p></p></pre></div></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >得到的结果是一样的 :&nbsp;</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  ><div><pre class="prettyprint"  ><p></p><div>0</div><div>1</div><div>2</div><p></p></pre></div><div><br></div></span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >4. Look Familiar?</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >前面的章节已经列举过一些例子, 很多Ruby自带的class的public instance method 都可以接收Block. 处理一些iterate的操作.</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >例如 :&nbsp;</span></font></div><div><pre class="prettyprint"  ><p></p><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >(0..2).each { |x| puts(x) }</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >3.times { |x| puts(x) }</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >0.upto(2) { |x| puts(x) }</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >2.downto(0) { |x| puts(x) }</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >[1,2,3,4].each { |x| puts(x) }</span></font></div><p></p></pre></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >另一种是loop方法, 在Kernel类中定义的方法. 大部分类都继承自Kernel所以可以使用该方法.</span></font></div><div><pre class="prettyprint"  ><p></p><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >arr = [1,2,3,4]</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >i = 0</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >loop do</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >&nbsp; puts(arr[i])</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >&nbsp; i += 1</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >&nbsp; if ( i == arr.length ) then</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >&nbsp; &nbsp; break</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >&nbsp; end</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >end</span></font></div><p></p></pre></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  ><br></span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >5. Blocks and Arrays</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >接下来列举一些Array类使用BLOCK的例子,</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >collect方法可以用于产生一个新的对象, 其他的如each不会产生一个新对象. 下面的例子就可以看出.</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><div style="line-height: 23px;"  ><pre class="prettyprint"  ><p></p><div style="line-height: 23px;"  >b1 = [1,2,3].collect {|x| x*2}</div><div style="line-height: 23px;"  >p b1</div><div style="line-height: 23px;"  >结果</div><div>[2, 4, 6]</div><p></p></pre></div></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><div style="line-height: 23px;"  ><pre class="prettyprint"  ><p></p><div style="line-height: 23px;"  >b2 = ['hello','i','am','digoal'].collect {|x| x.capitalize}</div><div style="line-height: 23px;"  >p b2</div><div style="line-height: 23px;"  >结果</div><div>["Hello", "I", "Am", "Digoal"]</div><p></p></pre></div></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >each的例子 :&nbsp;</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><div style="line-height: 23px;"  ><pre class="prettyprint"  ><p></p><div style="line-height: 23px;"  >b2 = ['hello','i','am','digoal'].each {|x| x.capitalize}</div><div style="line-height: 23px;"  >p b2</div><div style="line-height: 23px;"  >结果</div><div>["hello", "i", "am", "digoal"]</div><p></p></pre></div></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >使用修改接收方法的对象的方法.</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><div style="line-height: 23px;"  ><pre class="prettyprint"  ><p></p><div style="line-height: 23px;"  >b2 = ['hello','i','am','digoal'].each {|x| x.capitalize!}</div><div style="line-height: 23px;"  >p b2</div><div style="line-height: 23px;"  >结果</div><div>["Hello", "I", "Am", "Digoal"]</div><p></p></pre></div></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >但是请注意capitalize!方法如果对象没有被改变则返回nil. 例如,本来就是首字母大写的, 或者空格.</span></font></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >p 'A'.capitalize!</font></div><div><font size="2"  >p ' '.capitalize!</font></div><div><font size="2"  >p 'Abc'.capitalize!</font></div><div><font size="2"  >结果</font></div><div><font size="2"  >nil</font></div><div><font size="2"  >nil</font></div><div><font size="2"  >nil</font></div><p></p></pre></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >另外需要注意的是nil无法转换为string, 所以当把nil强加到String对象的时候会报错</span></font></div><div><pre class="prettyprint"  ><p></p><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  >p 'abc' &lt;&lt; nil</font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  >报错</font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  >can't convert nil into String (TypeError)</font></div><p></p></pre></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >String有一个比较好玩的方法each_byte.它会把字符串每个字符转换成ASCII, Fixnum的chr方法则可以吧数字转化成字符.</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >例如 :&nbsp;</span></font></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >"hello world".each_byte{|x| p x.chr.capitalize}</font></div><div><font size="2"  >p 10.chr</font></div><div><font size="2"  >结果</font></div><div><div><font size="2"  >"H"</font></div><div><font size="2"  >"E"</font></div><div><font size="2"  >"L"</font></div><div><font size="2"  >"L"</font></div><div><font size="2"  >"O"</font></div><div><font size="2"  >" "</font></div><div><font size="2"  >"W"</font></div><div><font size="2"  >"O"</font></div><div><font size="2"  >"R"</font></div><div><font size="2"  >"L"</font></div><div><font size="2"  >"D"</font></div><div><font size="2"  >"\n"</font></div></div><p></p></pre></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 20px;"  ><br></span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >6. Procs and Lambdas</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >Block在Ruby中不是一个对象, 也不能独立存在.&nbsp;</span></font></div><div><pre class="prettyprint"  ><p></p><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  >print({|x| x*2}.calss)</font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  >报错 :&nbsp;</font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><div>C:/Users/digoal/Desktop/new.rb:1: syntax error, unexpected '|', expecting '}'</div><div>print({|x| x*2}.calss)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; ^</div><div>C:/Users/digoal/Desktop/new.rb:1: syntax error, unexpected '}', expecting $end</div><div>print({|x| x*2}.calss)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</div></font></div><p></p></pre></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >以上为什么会报错呢, 因为block不能独立存在, 在参数中穿进去的Ruby会认为是一个Hash对象. 所以这里会报语法错误.</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >但是可以使用Proc的对象来存储块.</span></font></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >p1 = Proc.new {|x| x*2}</font></div><div><font size="2"  >p2 = proc {|x| x*3}</font></div><div><font size="2"  >p3 = lambda {|x| x*4}</font></div><div><font size="2"  >p p1,p2,p3</font></div><div><font size="2"  >结果 :&nbsp;</font></div><div><div><font size="2"  >#&lt;Proc:0x1f2cab0@C:/Users/digoal/Desktop/new.rb:1&gt;</font></div><div><font size="2"  >#&lt;Proc:0x1f2ca98@C:/Users/digoal/Desktop/new.rb:2&gt;</font></div><div><font size="2"  >#&lt;Proc:0x1f2ca80@C:/Users/digoal/Desktop/new.rb:3 (lambda)&gt;</font></div></div><p></p></pre></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >注意以下写法都是错误的 , block一般不能作为一个普通的argument传递给方法, 除非是后面讲到的&amp;方法来传递或者传递Proc对象.</span></font></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >p1 = Proc.new( {|x| x*2} )</font></div><div><font size="2"  >p2 = proc( {|x| x*3} )</font></div><div><font size="2"  >p3 = lambda( {|x| x*4} )</font></div><p></p></pre></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  ><br></span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >7. Block or Hash</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >Block和Hash对象都可以用大括号来定义.</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >所以Block不是作为参数传递给方法的, 因此不会在方法后使用括弧把传递的block包围起来.</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >而Hash既可以不用括弧也可以使用括弧. 因此就有点糊涂了 , 到底定义的是一个Hash对象还是Block呢?</span></font></div><div><pre class="prettyprint"  ><p></p><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >puts( {1=&gt;2}.class ) &nbsp; &nbsp; #&lt;= Hash</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >puts( {}.class ) &nbsp; &nbsp; &nbsp; &nbsp; #&lt;= Hash</span></font></div><p></p></pre></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >但是</span></font></div><div><pre class="prettyprint"  ><p></p><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >puts{}.class</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >print{}.class&nbsp;</span></font></div><p></p></pre></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >这两个是当做block处理的. 因此等同于</span></font></div><div><div><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  style="line-height: 20px;"  ><span style="line-height: 23px;"  >(puts{}).class</span></font></div><div style="line-height: 22px;"  ><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  style="line-height: 20px;"  ><span style="line-height: 23px;"  >(print{}).class&nbsp;</span></font></div><p></p></pre></div></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  ><br></span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >8. Creating Objects from Blocks</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >虽然block不是对象, 但是可以通过Proc类来存储block. 换句话说block就是Proc对象.</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >创建Proc对象有三个方法 :&nbsp;</span></font></div><div><pre class="prettyprint"  ><p></p><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >Proc.new</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >proc</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >lambda</span></font></div><p></p></pre></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >它们可以通过call来执行block中的内容.</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >其中lambda和proc(ruby 1.8)创建的Proc对象在调用时会检查block的block argument.&nbsp;</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >proc(ruby 1.9)和Proc.new创建的block在调用时不检查.</span></font></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >a = Proc.new{|x,y,z| x = y*z; puts(x) }</font></div><div><font size="2"  >a.call(2,5,10,100) &nbsp; &nbsp; &nbsp; &nbsp;# This is not an error</font></div><div><font size="2"  >b = lambda{|x,y,z| x = y*z; puts(x) }</font></div><div><font size="2"  >b.call(2,5,10,100) &nbsp; &nbsp; &nbsp; &nbsp;# This is an error</font></div><div><font size="2"  >puts('---Block #2---' )</font></div><div><font size="2"  >c = proc{|x,y,z| x = y*z; puts(x) }</font></div><div><font size="2"  >c.call(2,5,10,100) &nbsp; &nbsp; &nbsp; &nbsp;# This is an error in Ruby 1.8</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Not an error in Ruby 1.9</font></div><p></p></pre></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 20px;"  ><br></span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >9. What Is a Closure</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >Closure指的是它在创建完后就锁定了它带的本地变量和实例变量等的作用域. 而不是在使用这个Closure时的作用域.</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >例如 :&nbsp;</span></font></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >x = "hello world"</font></div><div><font size="2"  >ablock = Proc.new { puts( x ) }</font></div><div><font size="2"  >def aMethod( aBlockArg )</font></div><div><font size="2"  >&nbsp; &nbsp; x = "goodbye"</font></div><div><font size="2"  >&nbsp; &nbsp; aBlockArg.call</font></div><div><font size="2"  >end</font></div><div><font size="2"  >puts( x )</font></div><div><font size="2"  >ablock.call</font></div><div><font size="2"  >aMethod( ablock )</font></div><div><font size="2"  >ablock.call</font></div><div><font size="2"  >puts( x )</font></div><div><font size="2"  >执行结果 :&nbsp;</font></div><div><div><font size="2"  >hello world</font></div><div><font size="2"  >hello world</font></div><div><font size="2"  >hello world</font></div><div><font size="2"  >hello world</font></div><div><font size="2"  >hello world</font></div></div><p></p></pre></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >x是main对象的本地变量, ablock这个Proc对象在创建的时候, 它的x 这个变量指的是main对象的x本地变量.</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >所以在方法aMethod中调用这个BLOCK时, 虽然aMethod中也有一个x本地变量, 但是它和main对象的x变量其实是两个变量.</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >ablock对象打印的是main的x变量. 因为它是在创建的时候就已经决定了的.</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  ><br></span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >10. yield</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >要让一个方法可以接收block消息. 其中的一种方法是在这个方法中使用yield方法.</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >yield( 这里的参数将传递给block argument )</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >例如 :&nbsp;</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><div style="line-height: 23px;"  ><pre class="prettyprint"  ><p></p><div style="line-height: 23px;"  >def aMethod</div><div style="line-height: 23px;"  >&nbsp; &nbsp; yield</div><div style="line-height: 23px;"  >end</div><div>aMethod{ puts( "Good morning" ) }</div><p></p></pre></div></font></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >def m1(x)</font></div><div><font size="2"  >&nbsp; &nbsp; yield(x)</font></div><div><font size="2"  >end</font></div><div><font size="2"  >m1(10) {|i| p i*2}</font></div><div><font size="2"  ><span style="line-height: 19px;"  >结果</span></font></div><div><font size="2"  >20</font></div><p></p></pre></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >前面已经讲过了, block和hash的定义都使用了大括号, 所以当作为参数传递时, block不在方法的括弧内传递, 而是在括弧外或不使用括弧. hash对象则在括弧内传递.</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >例如以下将报错 :&nbsp;</span></font></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >def m1</font></div><div><font size="2"  >&nbsp; &nbsp; yield</font></div><div><font size="2"  >end</font></div><div><font size="2"  >m1( {|i| p i*2} )</font></div><div><font size="2"  >报错 :&nbsp;</font></div><div><div><font size="2"  >C:/Users/digoal/Desktop/new.rb:4: syntax error, unexpected '|', expecting '}'</font></div><div><font size="2"  >m1( {|i| p i*2} )</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; ^</font></div><div><font size="2"  >C:/Users/digoal/Desktop/new.rb:4: syntax error, unexpected tIDENTIFIER, expecting keyword_do or '{' or '('</font></div><div><font size="2"  >m1( {|i| p i*2} )</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^</font></div><div><font size="2"  >C:/Users/digoal/Desktop/new.rb:4: syntax error, unexpected '}', expecting $end</font></div><div><font size="2"  >m1( {|i| p i*2} )</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div></div><p></p></pre></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 20px;"  ><br></span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >11. Blocks Within Blocks</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >在block中使用block的例子:&nbsp;</span></font></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >def m1(x)</font></div><div><font size="2"  >&nbsp; &nbsp; yield(x)</font></div><div><font size="2"  >end</font></div><div><font size="2"  >[1,2,3,4].each do |x|</font></div><div><font size="2"  >&nbsp; &nbsp; m1(x) {|i| puts(x*2)}</font></div><div><font size="2"  >end</font></div><div><font size="2"  >输出</font></div><div><div><font size="2"  >2</font></div><div><font size="2"  >4</font></div><div><font size="2"  >6</font></div><div><font size="2"  >8</font></div></div><p></p></pre></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  ><br></span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >12. Passing Named Proc Arguments</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >前面的例子都是使用yield来接收block消息的. 它不能作为参数传递给方法. &nbsp;接下来的例子是作为参数传递给方法的. 因此需要传递的是Proc对象.</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >另一种是在参数名前面加一个&amp;表示这个参数必须是一个Proc对象或匿名block. 因此传递给它的时候可以使用 &amp;Proc对象名 或者 在括弧外传递匿名block.</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >对于&amp;定义的参数, 在方法中使用时, 可以用 参数名.call 或 yield来接收.</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >例1 :&nbsp;</span></font></div><div><p></p><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >def abc( a, b, c )</font></div><div><font size="2"  >&nbsp; &nbsp; a.call</font></div><div><font size="2"  >&nbsp; &nbsp; b.call</font></div><div><font size="2"  >&nbsp; &nbsp; c.call</font></div><div><font size="2"  >&nbsp; &nbsp; yield</font></div><div><font size="2"  >end</font></div><div><div><font size="2"  >a = lambda{ puts "one" }</font></div><div><font size="2"  >b = lambda{ puts "two" }</font></div><div><font size="2"  >c = proc{ puts "three" }</font></div><div><font size="2"  >abc(a, b, c ){ puts "four" }</font></div></div><p></p></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >结果 :&nbsp;</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  ><div>one</div><div>two</div><div>three</div><div>four</div></span></font></div><p></p></pre></div></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >例2 :&nbsp;</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><div><pre class="prettyprint"  ><p></p><div><div>def abc2( &amp;d )</div><div>&nbsp; &nbsp; d.call("call")   # 当参数为&amp;定义的时候, call可以接收<span style="line-height: 19px; font-family: Arial, Helvetica, simsun, u5b8bu4f53;"  >匿名块或者用&amp;定义的参数传递进来的Proc对象.</span></div><div>&nbsp; &nbsp; yield("yield")   # yield可以接收匿名块或者用&amp;定义的参数传递进来的Proc对象.</div><div>end</div><div><br></div><div>p1 = lambda {|x| puts "digoal " + x}</div><div><br></div><div>abc2(&amp;p1)</div><div>abc2 {|x| puts "digoal " + x}</div></div><div>结果 :&nbsp;</div><div><div>digoal call</div><div>digoal yield</div><div>digoal call</div><div>digoal yield</div></div><p></p></pre></div><div style="line-height: 23px;"  >例3 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div>def abc3( a, b, c, &amp;d)</div><div>&nbsp; &nbsp; a.call</div><div>&nbsp; &nbsp; b.call</div><div>&nbsp; &nbsp; c.call</div><div>&nbsp; &nbsp; d.call &nbsp; &nbsp; &nbsp; &nbsp;# first call block &amp;d</div><div>&nbsp; &nbsp; yield &nbsp; &nbsp; &nbsp; &nbsp; # then yield block &amp;d</div><div>end</div><p></p></pre></div><div style="line-height: 23px;"  >最后需要注意的是, 在块中使用的block argument. 也就是在||中的变量名, 最好不要和外部的变量名重名.</div><div style="line-height: 23px;"  >因为在1.8中, 外面是能看到block的本地变量的, 也就是说block的本地变量和外部的本地变量是想通的, 如果重名block argument的值变动后将影响到外部的变量.</div><div style="line-height: 23px;"  >但是在1.9中, block 的本地变量和外部的变量是完全隔离的. 相互不会影响. 除非是直接修改对象, 也就是object_id相同的情况下, 对这个object的原始值进行修改.</div><div style="line-height: 23px;"  >1.9 例如 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div>x = "hello"</div><div>p1 = lambda {|x| x = x + " world"}</div><div>p2 = lambda {|x| x = x &lt;&lt; " world"}</div><div>p1.call(x)  # 在block内部, 赋值的时候产生了一个新的对象. 因此=号左边的x指向了新对象, 是个新的object_id,</div><div>p x</div><div>p2.call(x)  <span style="line-height: 19px; font-family: Arial, Helvetica, simsun, u5b8bu4f53;"  ># 在block内部, 赋值的时候没有产生一个新的对象. 因此=号左边的x指向的还是接收到的x的object_id.</span></div><div>p x</div></div><div>结果</div><div><div>"hello"</div><div>"hello world"</div></div><p></p></pre></div><div style="line-height: 23px;"  >1.9 另一个例子 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div>x = "hello"</div><div>p1 = lambda {|x| y = x&nbsp;</div><div>&nbsp; &nbsp; y = y + " world"}</div><div>p2 = lambda {|x| y = x</div><div>&nbsp; &nbsp; y = y &lt;&lt; " world"}</div><div>p1.call(x)</div><div>p x</div><div>p2.call(x)</div><div>p x</div></div><div>结果 :&nbsp;</div><div><div>"hello"</div><div>"hello world"</div></div><p></p></pre></div></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >另一个例子, 说明1.8和1.9的不同 :&nbsp;</span></font></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >a = "hello world"</font></div><div><font size="2"  >def foo</font></div><div><font size="2"  >&nbsp; &nbsp; yield 100</font></div><div><font size="2"  >end</font></div><div><font size="2"  >puts( a )</font></div><div><font size="2"  >foo{ |a| puts( a ) }</font></div><div><font size="2"  >puts( a )</font></div><div><font size="2"  >结果 :&nbsp;</font></div><div><div><font size="2"  >Ruby 1.8 displays this: 说明1.8的block中的变量和外面的变量重名是很危险的.</font></div><div><font size="2"  >hello world</font></div><div><font size="2"  >100</font></div><div><font size="2"  >100</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Ruby 1.9 displays this:</font></div><div><font size="2"  >hello world</font></div><div><font size="2"  >100</font></div><div><font size="2"  >hello world</font></div></div><p></p></pre></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 20px;"  ><br></span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >13. Precedence Rules</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >前面已经讲过block可以使用do end或者{}来定义. 但是他们的优先级是不一样的.</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >例如</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  ><div>foo bar do |s| puts( s ) end 相当于 foo(bar)&nbsp;<span style="line-height: 20px;"  >do |s| puts( s ) end</span><span style="line-height: 23px;"  ></span></div><div>foo bar{ |s| puts(s) } 相当于&nbsp;<span style="line-height: 20px;"  >foo( bar{ |s| puts(s) } )</span></div></span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  ><br></span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  ><div><pre class="prettyprint"  ><p></p><div>def foo( b )</div><div>&nbsp; &nbsp; puts("---in foo---")</div><div>&nbsp; &nbsp; a = 'foo'</div><div>&nbsp; &nbsp; if block_given?</div><div>&nbsp; &nbsp; &nbsp; &nbsp; puts( "(Block passed to foo)" )</div><div>&nbsp; &nbsp; &nbsp; &nbsp; yield( a )</div><div>&nbsp; &nbsp; else</div><div>&nbsp; &nbsp; &nbsp; &nbsp; puts( "(no block passed to foo)" )</div><div>&nbsp; &nbsp; end</div><div>&nbsp; &nbsp; puts( "in foo, arg b = #{b}" )</div><div>&nbsp; &nbsp; return "returned by " &lt;&lt; a</div><div>end</div><div>def bar</div><div>&nbsp; &nbsp; puts("---in bar---")</div><div>&nbsp; &nbsp; a = 'bar'</div><div>&nbsp; &nbsp; if block_given?</div><div>&nbsp; &nbsp; &nbsp; &nbsp; puts( "(Block passed to bar)" )</div><div>&nbsp; &nbsp; &nbsp; &nbsp; yield( a )</div><div>&nbsp; &nbsp; else</div><div>&nbsp; &nbsp; &nbsp; &nbsp; puts( "(no block passed to bar)" )</div><div>&nbsp; &nbsp; end</div><div>&nbsp; &nbsp; return "returned by " &lt;&lt; a</div><div>end</div><div>foo bar do |s| puts( s ) end &nbsp; &nbsp; &nbsp; # 1) do..end block</div><div>puts("!!!!!next!!!!!")</div><div>foo bar{ |s| puts(s) } &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # 2) {..} block</div><p></p></pre></div><div>执行结果 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div>---in bar---</div><div>(no block passed to bar)</div><div>---in foo---</div><div>(Block passed to foo)</div><div>foo</div><div>in foo, arg b = returned by bar</div><div>!!!!!next!!!!!</div><div>---in bar---</div><div>(Block passed to bar)</div><div>bar</div><div>---in foo---</div><div>(no block passed to foo)</div><div>in foo, arg b = returned by bar</div><p></p></pre></div></span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >这个例子中用到了Kernel的public instance method : block_given?</span></font></div><div><div jquery="79"  ><pre class="prettyprint"  ><p></p><div jquery="79"  ><font size="2"  ><span>block_given? → true or false iterator? → true or  false</span> <span>click to toggle source</span>  </font></div><font size="2"  > </font><div jquery="16"  ><font size="2"  > </font><p><font size="2"  >Returns <tt>true</tt> if <tt>yield</tt> would execute a block in the current  context. The <tt>iterator?</tt> form is mildly deprecated. </font></p><pre><font size="2"  >   def try      if block_given?        yield      else        "no block"      end    end    try                  #=&gt; "no block"    try { "hello" }      #=&gt; "hello"    try do "hello" end   #=&gt; "hello"</font></pre></div><p></p></pre></div><div jquery="16"  ><pre><p></p><div><div jquery="16"  ><pre><span style="line-height: 23px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; font-size: small;"  >14. Blocks as Iterators</span></pre><pre><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 20px;"  >Block经常用在重复调用的场合, 例如 3.times { ... } , [1,2,3].each { ... } 等. 当然还可以写自己的类来应用这种重复的工作.</span></font></pre><pre><pre class="prettyprint"  ><p></p><pre><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  >def timesRepeat( aNum )     for i in 1..aNum do          yield i     end end timesRepeat( 3 ){  |i| puts("[#{i}] hello world") }</font></pre><pre><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  >结果</font></pre><pre><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  >[1] hello world [2] hello world [3] hello world</font></pre><p></p></pre></pre><pre><pre class="prettyprint"  ><p></p><pre><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 20px;"  >class MyArray &lt; Array     def initialize( anArray )         super( anArray )     end     def timesRepeat( aNum )         aNum.times{   # start block 1...              | num |              self.each{   # start block 2...                   | anitem |                   yield( "[#{num}] :: '#{anitem}'" )              }            # ...end block 2         }             # ...end block 1     end end  numarr = MyArray.new( [1,2,3] ) numarr.timesRepeat( 2  ){ |x| puts(x) }</span></font></pre><pre><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 20px;"  >结果</span></font></pre><pre><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  >[0] :: '1' [0] :: '2' [0] :: '3' [1] :: '1' [1] :: '2' [1] :: '3'</font></pre><p></p></pre></pre><pre><pre class="prettyprint"  ><p></p><pre><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 20px;"  >multiarr =  [ ['one','two','three','four'],   [1,    2,    3,      4     ],   [:a,   :b,   :c,    :d     ]     ]  multiarr.each{ |arr|     multiarr[0].length.times{|i|         puts(arr[i])     } }  puts("!!!! next !!!!")  multiarr[0].length.times{|i|     multiarr.each{ |arr|         puts(arr[i])     } }</span></font></pre><pre><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 20px;"  >结果 : </span></font></pre><pre><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  >one two three four 1 2 3 4 a b c d !!!! next !!!! one 1 a two 2 b three 3 c four 4 d</font></pre><p></p></pre></pre><pre><span style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; font-size: small; line-height: 23px;"  >15. Returning Blocks from Methods</span></pre><pre><span style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; font-size: small; line-height: 23px;"  >为什么要讲从方法中返回block呢, 还记不记得前面讲过的Block是Closure, 它的本地变量对应的是这个Closure创建时所在的范围内的本地变量.</span></pre><pre><span style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; font-size: small; line-height: 23px;"  >这个特性也叫creatively.</span></pre><pre><pre class="prettyprint"  ><p></p><pre><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 20px;"  >x = "hello world" ablock = Proc.new { puts( x ) }</span></font></pre><pre><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  >def aMethod( aBlockArg )     x = "goodbye"     aBlockArg.call            #=&gt; "hello world" end</font></pre><p></p></pre></pre><pre><span style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; font-size: small; line-height: 23px;"  >返回Proc对象的例子 : </span></pre><pre><pre class="prettyprint"  ><p><font size="2"  >def calcTax( taxRate )     return lambda{         |subtotal|             subtotal * taxRate     }  end salesTax = calcTax( 0.10 ) vat = calcTax( 0.175 ) print( "Tax due on book = ") print( salesTax.call( 10 ) )       #=&gt; 1.0 print( "\nVat due on DVD = ") print( vat.call( 10 ) )            #=&gt; 1.75</font></p></pre></pre><pre><span style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; font-size: small; line-height: 23px;"  ><br></span></pre><pre><span style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; font-size: small; line-height: 23px;"  >16. Blocks and Instance Variables</span></pre><pre><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >了解了Block具有Creatively特性之后 , 在想一想如果block中用到了instance variable的时候, 这个instance variable如何和调用这个block的对象里面的instance method重名了, block会使用哪个instance variable呢.</span></font></pre><pre><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >答案还是Creatively.</span></font></pre><pre><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >例如 : </span></font></pre><pre><pre class="prettyprint"  ><p></p><pre><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  >aClos = lambda{      @hello &lt;&lt; " yikes!"     puts("in #{self} object of class #{self.class}, @hello = #{@hello}") }  def aFunc( aClosure )     @hello = "hello world"     aClosure.call end  aFunc(aClos)  puts('!!!! next !!!!')  class X     def y( b )         @hello = "I say, I say, I say!!!"         puts( "   [In X.y]" )         puts("in #{self} object of class #{self.class}, @hello = #{@hello}")         puts( "   [In X.y] when block is called..." )         b.call     end end  x = X.new  x.y( aClos )<span style="line-height: 23px;"  > </span></font></pre><div><span style="line-height: 23px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; font-size: small;"  >结果</span></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  >in main object of class Object, @hello = hello world yikes! !!!! next !!!!    [In X.y] in #&lt;X:0x1e8c040&gt; object of class X, @hello = I say, I say, I say!!!    [In X.y] when block is called... in main object of class Object, @hello = hello world yikes! yikes!</font></div><p></p></pre></pre><pre><span style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; font-size: small; line-height: 23px;"  ><br></span></pre></div></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >17. Blocks and Local Variables</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >1.8和1.9的不同之处是,</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >1.9 block外部的本地变量和block argument同名时, 在block内部这个变量的值被改变时不影响外面的值. (直接修改原对象的除外, 前面有例子了)</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >1.8 </span></font><span style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; font-size: small; line-height: 23px;"  >block外部的本地变量和block argument同名时, 在block内部这个变量的值被改变后, 外面的变量的值也随之修改.</span></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >例如 : </span></font></div><div><pre class="prettyprint"  ><p><font size="2"  >c3 = proc{ <br>    |x|<br>    x + 100<br>}</font></p><p><font size="2"  >x = 3000<br>someval=1000<br>someval=c3.call(someval); puts(someval)    #=&gt; 1100<br>someval=c3.call(someval); puts(someval)    #=&gt; 1200<br>puts( x ) # Ruby 1.8, x = 1100. Ruby 1.9, x = 3000</font></p></pre></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >但是, 不管在1.8还是1.9中. </span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 23px;"  >外部都不能访问block的内部变量(就是说外面没有与之同名的变量名)</span></font><span style="line-height: 23px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; font-size: small;"  >.</span></div><div><pre class="prettyprint"  ><p></p><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 20px;"  >c3 = proc{      |x|     z = x + 100 } x = 3000 someval=1000 someval=c3.call(someval); puts(someval)    #=&gt; 1100 someval=c3.call(someval); puts(someval)    #=&gt; 1200 puts( x ) # Ruby 1.8, x = 1100. Ruby 1.9, x = 3000 print("x=[#{defined?(x)}],z=[#{defined?(z)}]") puts(z)</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 20px;"  >结果</span></font></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  >C:/Users/digoal/Desktop/new.rb:11:in `&lt;main&gt;': undefined local variable or method `z' for main:Object (NameError) 1100 1200 3000 x=[local-variable],z=[]</font></div><p></p></pre></div><p></p></pre></div></div><div><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  size="2"  ><span style="line-height: 20px;"  >又一个例子 :&nbsp;</span></font></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >def foo</font></div><div><font size="2"  >&nbsp; &nbsp; a = 100</font></div><div><font size="2"  >&nbsp; &nbsp; [1,2,3].each do |b|</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; c = b&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; a = b</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; print("a=#{a}, b=#{b}, c=#{c}\n")</font></div><div><font size="2"  >&nbsp; &nbsp; end</font></div><div><font size="2"  >&nbsp; &nbsp; print("Outside block: a=#{a}\n") # Can't print #{b} and #{c} here!!!</font></div><div><font size="2"  >end</font></div><div><font size="2"  >foo</font></div><div><font size="2"  >结果</font></div><div><div><font size="2"  >a=1, b=1, c=1</font></div><div><font size="2"  >a=2, b=2, c=2</font></div><div><font size="2"  >a=3, b=3, c=3</font></div><div><font size="2"  >Outside block: a=3</font></div></div><p></p></pre></div><font size="2"  ><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  ><div style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"  ><span style="line-height: 23px;"  >再看一个例子</span></div><div><div><pre class="prettyprint"  ><p></p><div>x = "digoal"</div><div>p x.object_id</div><div><br></div><div>p1 = proc do |x|</div><div>&nbsp; &nbsp; p x</div><div>&nbsp; &nbsp; p x.object_id &nbsp;# 等于block外面的x的object_id</div><div>&nbsp; &nbsp; x = x + " hello" &nbsp;# 赋值是新增了一个对象,所以不等于x的object_id</div><div>&nbsp; &nbsp; p x.object_id</div><div>&nbsp; &nbsp; p x</div><div>end</div><div><br></div><div>p2 = proc do |y|</div><div>&nbsp; &nbsp; y &lt;&lt; " hello" &nbsp;# 将直接修改原始值, 因此block外部的x的值将被修改</div><div>end</div><div><br></div><div>p1.call(x)</div><div>p x.object_id &nbsp;# x的object_id与开始时一致</div><div>p x &nbsp;# 与开始时一致</div><div><br></div><div>p2.call(x)</div><div>p x.object_id &nbsp;# x的object_id与开始时一致</div><div>p x &nbsp;# 是修改后的值</div><p></p></pre></div><div style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; line-height: 23px;"  ><br></div></div><div style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; line-height: 23px;"  ><font size="2"  style="line-height: 23px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"  ><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  style="line-height: 23px;"  ><span style="line-height: 23px;"  >最后是一个特例, 在for do end的block中这种情况不存在, 它这里的BLOCK中的本地变量可被外部访问 :&nbsp;</span></font></font></div><div style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; line-height: 23px;"  ><font size="2"  style="line-height: 23px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"  ><font color="#333333"  face="Arial, Helvetica, simsun, u5b8bu4f53"  style="line-height: 23px;"  ><span style="line-height: 23px;"  ><div><pre class="prettyprint"  ><p></p><div>def foo2</div><div>&nbsp; &nbsp; a = 100</div><div>&nbsp; &nbsp; for b in [1,2,3] do&nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; c = b&nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; a = b</div><div>&nbsp; &nbsp; &nbsp; &nbsp; print("a=#{a}, b=#{b}, c=#{c}\n")</div><div>&nbsp; &nbsp; end</div><div>&nbsp; &nbsp; print("Outside block: a=#{a}, b=#{b}, c=#{b}\n") &nbsp;&nbsp;</div><div>end</div><div>foo2</div><div>结果 :&nbsp;</div><div><div>a=1, b=1, c=1</div><div>a=2, b=2, c=2</div><div>a=3, b=3, c=3</div><div>Outside block: a=3, b=3, c=3</div></div><p></p></pre></div><div>也就是是for接收的block里面的本地变量在外部可以访问.</div></span></font></font></div><div style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; line-height: 23px;"  ><br></div><span style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; line-height: 23px;"  >【参考】</span></font></font><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"  ><font size="2"  style="line-height: 23px;"  >The Book Of Ruby</font></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"  ><font size="2"  style="line-height: 23px;"  >Ruby 1.9.3 API</font></div><wbr></div>
	</div>
</div>
</body>
</html>