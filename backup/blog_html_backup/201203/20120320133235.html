<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.1.3 plpgsql debugger module</h2>
	<h5 id="">2012-03-20 13:32:35&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201222011550296/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>[更新]</div><div>该项目更新为pldebugger</div><div><a target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=pldebugger.git;a=summary"   >http://git.postgresql.org/gitweb/?p=pldebugger.git;a=summary</a></div><div><br></div><div>今天一位网友在群里面问PostgreSQL 9.0如何debug 函数. 我记得在8.3的时候有一个插件叫edb-debugger是可以使用的. 手头上没有9.0的数据库, 于是测试了一下在9.1上能不能用, 结果是编译不通过.</div><div>最后找到了解决办法, 记录如下.</div><div><br></div>在pgfoundry中有一个开源的edb-debugger插件可以用来调试PostgreSQL的PLPGSQL函数.<div><a rel="nofollow" href="http://pgfoundry.org/projects/edb-debugger/"   >http://pgfoundry.org/projects/edb-debugger/</a>&nbsp;</div><div>但是这个版本太老, 在PostgreSQL 9.1中无法编译通过, 报错如下.</div><div><div>&nbsp;<span style="font-size: small;"   >make&nbsp;</span></div><pre class="prettyprint"   ><p></p><div><font size="2"   >Makefile:63: warning: overriding commands for target `install'</font></div><div><font size="2"   >../../src/makefiles/pgxs.mk:120: warning: ignoring old commands for target `install'</font></div><div><font size="2"   >Makefile:77: warning: overriding commands for target `installdirs'</font></div><div><font size="2"   >../../src/makefiles/pgxs.mk:150: warning: ignoring old commands for target `installdirs'</font></div><div><font size="2"   >gcc -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wformat-security -fno-strict-aliasing -fwrapv -fpic &nbsp;-I. -I. -I../../src/include -D_GNU_SOURCE -I/usr/include/libxml2 &nbsp; -c -o pldbgapi.o pldbgapi.c</font></div><div><font size="2"   >pldbgapi.c: In function ‘pldbg_attach_to_port’:</font></div><div><font size="2"   >pldbgapi.c:346: warning: implicit declaration of function ‘MAKE_OFFSET’</font></div><div><font size="2"   >pldbgapi.c: In function ‘pldbg_wait_for_target’:</font></div><div><font size="2"   >pldbgapi.c:474: warning: implicit declaration of function ‘SHM_OFFSET_VALID’</font></div><div><font size="2"   >pldbgapi.c:476: warning: implicit declaration of function ‘MAKE_PTR’</font></div><div><font size="2"   >pldbgapi.c:476: warning: cast to pointer from integer of different size</font></div><div><font size="2"   >gcc -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wformat-security -fno-strict-aliasing -fwrapv -fpic &nbsp;-L../../src/port &nbsp;-Wl,-rpath,'/opt/pgsql/lib',--enable-new-dtags &nbsp;-shared -o pldbgapi.so pldbgapi.o</font></div><div><font size="2"   >gcc -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wformat-security -fno-strict-aliasing -fwrapv -fpic &nbsp;-I. -I. -I../../src/include -D_GNU_SOURCE -I/usr/include/libxml2 &nbsp; -c -o targetinfo.o targetinfo.c</font></div><div><font size="2"   >targetinfo.c: In function ‘getTriggerFuncOid’:</font></div><div><font size="2"   >targetinfo.c:268: error: ‘SnapshotNow’ undeclared (first use in this function)</font></div><div><font size="2"   >targetinfo.c:268: error: (Each undeclared identifier is reported only once</font></div><div><font size="2"   >targetinfo.c:268: error: for each function it appears in.)</font></div><div><font size="2"   >targetinfo.c: In function ‘getProcOidBySig’:</font></div><div><font size="2"   >targetinfo.c:508: error: too few arguments to function ‘FuncnameGetCandidates’</font></div><div><font size="2"   >targetinfo.c: In function ‘getProcOidByName’:</font></div><div><font size="2"   >targetinfo.c:555: error: too few arguments to function ‘FuncnameGetCandidates’</font></div><div><font size="2"   >make: *** [targetinfo.o] Error 1</font></div><div><font size="2"   >rm pldbgapi.o</font></div><p></p></pre></div><div>不知道为什么不更新了, 作者是这两位.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Korry Douglas (korry.douglas@enterprisedb.com)</font></div><div><font size="2"   >Dave Page (dave.page@enterprisedb.com)</font></div><p></p></pre></div><div>在EDB发布的EDB-AS版本中是包含了debugger的.</div><div>只是直接把它的so文件拷贝到开源版本的PostgreSQL中无法使用.</div><div>例如我把EDB-AS 9.1.2.2版本的$libdir/plugins/plugin_debugger.so文件拷贝到开源的PostgreSQL $PGHOME/lib/plugins/目录下.</div><div>配置postgresql.conf</div><div><pre class="prettyprint"   ><p><font size="2"   >shared_preload_libraries = '$libdir/plugins/plugin_debugger'</font></p></pre></div><div>在启动数据库时报错如下 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >FATAL: &nbsp;could not load library "/opt/pgsql/lib/plugins/plugin_debugger.so": /opt/pgsql/lib/plugins/plugin_debugger.so: undefined symbol: NonSPLFunctionContext</font></p></pre></div><div>这个<span style="line-height: 22px;"   >NonSPLFunctionContext在PostgresPlus/</span>9.1AS/include/server/utils/elog.h 文件里面定义的.</div><div>但是把它拷贝到开源的PostgreSQL的/opt/pgsql/include/server/utils/elog.h后依旧.</div><div><br></div><div>虽然pgfoundry里面提供下载的只有0.9.3版本, 庆幸的是cvs里面有最新的.</div><div>请见参考链接, 把这些文件下载过了后放到源码的contrib目录里面新建一个debugger目录.</div><div>编译过程 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >su - root</font></div><div><font size="2"   >. /home/postgres/.bash_profile</font></div><div><font size="2"   >cd /opt/soft_bak/postgresql-9.1.3/contrib/debugger/</font></div><div><font size="2"   >make</font></div><div><font size="2"   >make install</font></div><p></p></pre></div><div>修改数据库配置文件 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi&nbsp;$PGDATA/postgresql.conf</font></div><div><span style="line-height: 19px;"   ><font size="2"   >shared_preload_libraries = '$libdir/plugins/plugin_debugger'</font></span></div><p></p></pre></div><div>重启数据库,</div><div>在需要调试的数据库里面使用超级用户安装函数和类.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >psql -h 127.0.0.1 digoal postgres -f /opt/pgsql/share/contrib/pldbgapi.sql&nbsp;</font></div><div><font size="2"   >CREATE TYPE</font></div><div><font size="2"   >CREATE TYPE</font></div><div><font size="2"   >CREATE TYPE</font></div><div><font size="2"   >CREATE TYPE</font></div><div><font size="2"   >CREATE TYPE</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >CREATE FUNCTION</font></div><p></p></pre></div><div>创建一个测试函数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create or replace function debugger_test (i int) returns int as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >v_result int;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >v_result := 0;</font></div><div><font size="2"   >if i&lt;0 then</font></div><div><font size="2"   >&nbsp; raise notice 'Please enter i &gt;=0.';</font></div><div><font size="2"   >&nbsp; raise exception '';</font></div><div><font size="2"   >end if;</font></div><div><font size="2"   >for x in 0..i loop</font></div><div><font size="2"   >v_result := v_result + x;</font></div><div><font size="2"   >end loop;</font></div><div><font size="2"   >return v_result;</font></div><div><font size="2"   >exception</font></div><div><font size="2"   >when others then</font></div><div><font size="2"   >&nbsp; v_result := 0;</font></div><div><font size="2"   >&nbsp; return v_result;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql;</font></div><p></p></pre></div><div>使用pgAdmin登陆到这个数据库, 右键点击函数的时候就有调试选项了.</div><div><div><img title="PostgreSQL 9.1.3 plpgsql debugger module - 德哥@Digoal - The Heart,The World."   alt="PostgreSQL 9.1.3 plpgsql debugger module - 德哥@Digoal - The Heart,The World."   style="margin:0 10px 0 0;"   src="http://img6.ph.126.net/awRd3UXhZ_P1BYvYHxWXmw==/2589569785755366666.jpg"   ></div><div><br></div><div>一个调试页面截图 :&nbsp;</div><div><div><img title="PostgreSQL 9.1.3 plpgsql debugger module - 德哥@Digoal - The Heart,The World."   alt="PostgreSQL 9.1.3 plpgsql debugger module - 德哥@Digoal - The Heart,The World."   style="margin:0 10px 0 0;"   src="http://img6.ph.126.net/LCBUPao2fbRzIpKRy6Q7ig==/5717539629272462236.jpg"   ></div>&nbsp;</div>&nbsp;【参考】</div><div><a rel="nofollow" href="http://pgfoundry.org/forum/forum.php?set=custom&amp;forum_id=657&amp;style=nested&amp;max_rows=25&amp;submit=Change+View"   >http://pgfoundry.org/forum/forum.php?set=custom&amp;forum_id=657&amp;style=nested&amp;max_rows=25&amp;submit=Change+View</a> </div><div><a rel="nofollow" href="http://www.pgadmin.org/docs/1.14/debugger.html"   >http://www.pgadmin.org/docs/1.14/debugger.html</a></div><div><a rel="nofollow" href="http://cvs.pgfoundry.org/cgi-bin/cvsweb.cgi/edb-debugger/server/?hideattic=0#dirlist"   >http://cvs.pgfoundry.org/cgi-bin/cvsweb.cgi/edb-debugger/server/</a></div><div><div style="text-align: -webkit-auto;"   ><a target="_blank" rel="nofollow" href="http://git.postgresql.org/git/pldebugger.git"   >http://git.postgresql.org/git/pldebugger.git&nbsp;</a></div>使用git安装:<wbr></div><div><div>PostgreSQL plpgsql function debugging module : pldebugger</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020125511841144/"   >http://blog.163.com/digoal@126/blog/static/16387704020125511841144/</a></div></div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">越狱迷失 - 2013-06-10 22:18:09</h5>
				<div>德哥,现在redis_fdw,已经支持hash了.</div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 越狱迷失 - 2013-06-10 22:18:09</h5>
				<div style="width:600px;">好的.</div>
			</div>
	</div>
</div>
</body>
</html>