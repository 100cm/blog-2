<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL row exchange case.</h2>
	<h5 id="">2012-03-19 15:02:53&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201221911845750/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">今天介绍一个PostgreSQL 行交换的例子.<wbr><div>在现实中可能有一些需求是需要对一个表的其中两行的记录进行交换的,(除了主键).</div><div>具体的思路是查询出原来的两行的记录, 然后分两次更新响应的记录.</div><div>需要注意的是原来的记录被查出来之后, 可能被其他的用户更新, 为了避免这种情况的发生, 需要用到行锁.</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >create table top1000 (id int primary key,username text not null unique deferrable,score numeric);</font></p></pre></div><div>插入测试数据 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >insert into top1000 select generate_series(1,1000),'digoal'||generate_series(1,1000),generate_series(1,1000);</font></p></pre></div><div><br></div><div>创建行交换函数(使用nowait可以有效防止死锁或长时间等待) :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create or replace function exchange_rows(i_id1 int,i_id2 int) returns int as</font></div><div><font size="2"   >$$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >v_username1 text;</font></div><div><font size="2"   >v_score1 numeric;</font></div><div><font size="2"   >v_username2 text;</font></div><div><font size="2"   >v_score2 numeric;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >select username,score into v_username1,v_score1 from top1000 where id=i_id1 for update nowait;</font></div><div><font size="2"   >select username,score into v_username2,v_score2 from top1000 where id=i_id2 for update nowait;</font></div><div><font size="2"   >update top1000 set username=v_username1,score=v_score1 where id=i_id2;</font></div><div><font size="2"   >update top1000 set username=v_username2,score=v_score2 where id=i_id1;</font></div><div><font size="2"   >return 0;</font></div><div><font size="2"   >exception&nbsp;</font></div><div><font size="2"   >when others then</font></div><div><font size="2"   >raise notice 'ErrorNO %',SQLSTATE;</font></div><div><font size="2"   >return 1;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$</font></div><div><font size="2"   >language plpgsql;</font></div><p></p></pre></div><div>行交换测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >Time: 0.095 ms</font></div><div><font size="2"   >digoal=&gt; set constraints top1000_username_key deferred;</font></div><div><font size="2"   >SET CONSTRAINTS</font></div><div><font size="2"   >Time: 0.200 ms</font></div><div><font size="2"   >digoal=&gt; select * from exchange_rows(1,2);</font></div><div><font size="2"   >&nbsp;exchange_rows&nbsp;</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >Time: 0.827 ms</font></div><div><font size="2"   >digoal=&gt; end;</font></div><div><font size="2"   >COMMIT</font></div><div><font size="2"   >Time: 0.159 ms</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=&gt; select * from top1000 where id in (1,2);</font></div><div><font size="2"   >&nbsp;id | username | score&nbsp;</font></div><div><font size="2"   >----+----------+-------</font></div><div><font size="2"   >&nbsp; 2 | digoal1 &nbsp;| &nbsp; &nbsp; 1</font></div><div><font size="2"   >&nbsp; 1 | digoal2 &nbsp;| &nbsp; &nbsp; 2</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   >Time: 0.428 ms</font></div><p></p></pre></div><div>由于行交换的中间过程会产生违反唯一约束的情况, 所以需要做行交换的表在唯一约束上需要使用deferrable关键字.</div><div>事务开始时需要设置该约束为deferred的.</div><div><br></div><div>方法2, 使用with语法.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create or replace function exchange_rows(i_id1 int,i_id2 int) returns int as</font></div><div><font size="2"   >$$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >value int;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >value := 1;</font></div><div><font size="2"   >with</font></div><div><font size="2"   >o1 as (select username,score from top1000 where id=i_id1 for update nowait),</font></div><div><font size="2"   >o2 as (select username,score from top1000 where id=i_id2 for update nowait),</font></div><div><font size="2"   >u1 as (update top1000 set username=o2.username,score=o2.score from o1,o2 where id=i_id1),</font></div><div><font size="2"   >u2 as (update top1000 set username=o1.username,score=o1.score from o1,o2 where id=i_id2)</font></div><div><font size="2"   >select 0 into value;</font></div><div><font size="2"   >return value;</font></div><div><font size="2"   >exception</font></div><div><font size="2"   >when others then</font></div><div><font size="2"   >raise notice 'ErrorNO %',SQLSTATE;</font></div><div><font size="2"   >return value;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$</font></div><div><font size="2"   >language plpgsql;</font></div><p></p></pre></div><div>测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select * from exchange_rows(2,3);</font></div><div><font size="2"   >&nbsp;exchange_rows&nbsp;</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Time: 1.575 ms</font></div><div><font size="2"   >digoal=&gt; select * from top1000 where id in (2,3);</font></div><div><font size="2"   >&nbsp;id | username | score&nbsp;</font></div><div><font size="2"   >----+----------+-------</font></div><div><font size="2"   >&nbsp; 3 | digoal3 &nbsp;| &nbsp; &nbsp; 3</font></div><div><font size="2"   >&nbsp; 2 | digoal1 &nbsp;| &nbsp; &nbsp; 1</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Time: 0.443 ms</font></div><p></p></pre></div><div><br></div><div>方法3, 不锁行也可以做, 不过在update的过程中可能导致死锁. 因此不建议使用.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create or replace function exchange_rows(i_id1 int,i_id2 int) returns int as</font></div><div><font size="2"   >$$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >v_username1 text;</font></div><div><font size="2"   >v_score1 numeric;</font></div><div><font size="2"   >v_xmin1 int;</font></div><div><font size="2"   >v_cnt1 int;</font></div><div><font size="2"   >v_username2 text;</font></div><div><font size="2"   >v_score2 numeric;</font></div><div><font size="2"   >v_xmin2 int;</font></div><div><font size="2"   >v_cnt2 int;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >v_cnt1 := 0;</font></div><div><font size="2"   >v_cnt2 := 0;</font></div><div><font size="2"   >select xmin,username,score into v_xmin1,v_username1,v_score1 from top1000 where id=i_id1;</font></div><div><font size="2"   >select xmin,username,score into v_xmin2,v_username2,v_score2 from top1000 where id=i_id2;</font></div><div><font size="2"   >update top1000 set username=v_username1,score=v_score1 where id=i_id2 and xmin=v_xmin2;</font></div><div><font size="2"   >GET DIAGNOSTICS v_cnt1 = ROW_COUNT;</font></div><div><font size="2"   >update top1000 set username=v_username2,score=v_score2 where id=i_id1 and xmin=v_xmin1;</font></div><div><font size="2"   >GET DIAGNOSTICS v_cnt2 = ROW_COUNT;</font></div><div><font size="2"   >if ( (v_cnt1+v_cnt2) &lt;&gt; 2 ) then</font></div><div><font size="2"   >&nbsp; raise exception 'at least one row changed when exchanging.v_cnt1:%, v_cnt2:%.',v_cnt1,v_cnt2;</font></div><div><font size="2"   >&nbsp; return 1;</font></div><div><font size="2"   >end if;</font></div><div><font size="2"   >return 0;</font></div><div><font size="2"   >exception&nbsp;</font></div><div><font size="2"   >when others then</font></div><div><font size="2"   >raise notice 'ErrorNO %',SQLSTATE;</font></div><div><font size="2"   >return 1;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$</font></div><div><font size="2"   >language plpgsql;</font></div><p></p></pre></div><div>测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >Time: 0.253 ms</font></div><div><font size="2"   >digoal=&gt; set constraints top1000_username_key deferred;</font></div><div><font size="2"   >SET CONSTRAINTS</font></div><div><font size="2"   >Time: 0.244 ms</font></div><div><font size="2"   >digoal=&gt; select * from exchange_rows(2,3);</font></div><div><font size="2"   >&nbsp;exchange_rows&nbsp;</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Time: 1.342 ms</font></div><div><font size="2"   >digoal=&gt; end;</font></div><div><font size="2"   >COMMIT</font></div><div><font size="2"   >Time: 0.259 ms</font></div><div><font size="2"   >digoal=&gt; select * from top1000 where id in (2,3);</font></div><div><font size="2"   >&nbsp;id | username | score&nbsp;</font></div><div><font size="2"   >----+----------+-------</font></div><div><font size="2"   >&nbsp; 3 | digoal3 &nbsp;| &nbsp; &nbsp; 3</font></div><div><font size="2"   >&nbsp; 2 | digoal1 &nbsp;| &nbsp; &nbsp; 1</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Time: 0.596 ms</font></div><p></p></pre></div><div><br></div><div>还有一种with的方法, 在PostgreSQL版本的with支持update后可选这种方法.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# create table t4(id int primary key, info text, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# insert into t4 values (1,'abc',now());</font></div><div><font size="2"   >INSERT 0 1</font></div></div><div><div><font size="2"   >postgres=# insert into t4 values (2,'def',now());</font></div><div><font size="2"   >INSERT 0 1</font></div></div><div><font size="2"   >方法如下, 需要交换的两条记录的ID放在id in(1,2)这里 :&nbsp;</font></div><div><div><font size="2"   >postgres=# with t1(id,info) as (select id,info from t4 where id in (1,2)) update t4 set info=t1.info from t1 where t4.id&lt;&gt;t1.id returning * ;</font></div><div><font size="2"   >&nbsp;id | info | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| id | info&nbsp;</font></div><div><font size="2"   >----+------+----------------------------+----+------</font></div><div><font size="2"   >&nbsp; 2 | abc &nbsp;| 2015-03-13 16:31:07.464255 | &nbsp;1 | abc</font></div><div><font size="2"   >&nbsp; 1 | def &nbsp;| 2015-03-13 16:31:01.711353 | &nbsp;2 | def</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   >UPDATE 2</font></div><div><font size="2"   >交换记录后如下 :&nbsp;</font></div><div><font size="2"   >postgres=# select * from t4;</font></div><div><font size="2"   >&nbsp;id | info | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+------+----------------------------</font></div><div><font size="2"   >&nbsp; 2 | abc &nbsp;| 2015-03-13 16:31:07.464255</font></div><div><font size="2"   >&nbsp; 1 | def &nbsp;| 2015-03-13 16:31:01.711353</font></div><div><font size="2"   >(2 rows)</font></div></div><p></p></pre></div><div><br></div><div><br></div><div>最后举一个实际应用的例子 :&nbsp;</div><div>假设id是排名, 任何一个低等级的人都可以向比他高3级以内的人挑战, 挑战结束时双方通过比较最终的得分判断谁赢谁输.</div><div>挑战成功则交换名次以及更新积分, 挑战失败则只更新积分.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create or replace function exchange_rows(i_username1 text,i_score1 numeric,i_id2 int,i_score2 numeric) returns int as</font></div><div><font size="2"   >$$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >value int;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >value := 1;</font></div><div><font size="2"   >with</font></div><div><font size="2"   >o1 as (select id,username,score+i_score1 as score from top1000 where username=i_username1 for update nowait),</font></div><div><font size="2"   >o2 as (select id,username,score+i_score2 as score from top1000 where id=i_id2 for update nowait),</font></div><div><font size="2"   >u1 as (update top1000 set username=case when o1.score&gt;o2.score then o2.username else o1.username end,score=case when o1.score&gt;o2.score then o2.score else o1.score end from o1,o2 where top1000.id=o1.id),</font></div><div><font size="2"   >u2 as (update top1000 set username=case when o1.score&gt;o2.score then o1.username else o2.username end,score=case when o1.score&gt;o2.score then o1.score else o2.score end from o1,o2 where top1000.id=o2.id)</font></div><div><font size="2"   >select 0 into value;</font></div><div><font size="2"   >return value;</font></div><div><font size="2"   >exception</font></div><div><font size="2"   >when others then</font></div><div><font size="2"   >raise notice 'ErrorNO %',SQLSTATE;</font></div><div><font size="2"   >return value;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$</font></div><div><font size="2"   >language plpgsql;</font></div><p></p></pre></div><div><div>假设当前的1, 2名分别为digoal1和digoal2.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select * from top1000 where id in (1,2);</font></div><div><font size="2"   >&nbsp;id | username | score&nbsp;</font></div><div><font size="2"   >----+----------+-------</font></div><div><font size="2"   >&nbsp; 1 | digoal1 &nbsp;| 125.0</font></div><div><font size="2"   >&nbsp; 2 | digoal2 &nbsp;| &nbsp;72.0</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div><br></div><div>接下来是digoal2向第一名发起挑战的结果. 显然是digoal2的最终得分高于第一名, 因此挑战胜利更换名次并更新积分.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select * from exchange_rows('digoal2', 100.0, 1, 10.0);</font></div><div><font size="2"   >&nbsp;exchange_rows&nbsp;</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>最新的名次 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select * from top1000 where id in (1,2);</font></div><div><font size="2"   >&nbsp;id | username | score&nbsp;</font></div><div><font size="2"   >----+----------+-------</font></div><div><font size="2"   >&nbsp; 1 | digoal2 &nbsp;| 172.0</font></div><div><font size="2"   >&nbsp; 2 | digoal1 &nbsp;| 135.0</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div><br></div><div>接下来是digoal1向第一名发起挑战, 但是挑战失败了, digoal2还是第一名. 所以只更新积分, 名次不变.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select * from exchange_rows('digoal1', 10.0, 1, 10.0);</font></div><div><font size="2"   >&nbsp;exchange_rows&nbsp;</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=&gt; select * from top1000 where id in (1,2);</font></div><div><font size="2"   >&nbsp;id | username | score&nbsp;</font></div><div><font size="2"   >----+----------+-------</font></div><div><font size="2"   >&nbsp; 1 | digoal2 &nbsp;| 182.0</font></div><div><font size="2"   >&nbsp; 2 | digoal1 &nbsp;| 145.0</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div><br></div></div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">showdy1984 - 2012-03-19 17:37:31</h5>
				<div>感谢德哥的帮助。。<IMG src="http://b.bst.126.net/common/portrait/face/preview/face1.gif"  ></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 showdy1984 - 2012-03-19 17:37:31</h5>
				<div style="width:600px;"><img src="http://b.bst.126.net/common/portrait/face/preview/face0.gif"  >不客气,有空常来.</div>
			</div>
	</div>
</div>
</body>
</html>