<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">population & sample covariance, standard deviation Aggregate in PostgreSQL</h2>
	<h5 id="">2015-02-28 16:09:06&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201512835135264/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><span style="line-height: 28px;"   >PostgreSQL自带了一些常用的统计学聚合函数, 非常好用.</span></div><div><span style="line-height: 28px;"   >本文介绍一下方差和标准差的一些聚合函数.</span></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >总体方差 : population&nbsp;covariance</span></div><div><wbr><div>总体标准差 :&nbsp;<span style="line-height: 28px;"   >population&nbsp;</span>standard deviation</div><div>样本方差 :&nbsp;sample&nbsp;covariance</div><div>样本标准差 :&nbsp;sample&nbsp;standard deviation</div></div><div>均值 : &nbsp;mean</div><div><br></div><div>样本均值和样本方差的介绍 :&nbsp;</div><div><a target="_blank" rel="nofollow" href="http://en.wikipedia.org/wiki/Sample_mean_and_sample_covariance"   >http://en.wikipedia.org/wiki/Sample_mean_and_sample_covariance</a></div><div>均值介绍 :&nbsp;</div><div><a target="_blank" rel="nofollow" href="http://en.wikipedia.org/wiki/Mean"   >http://en.wikipedia.org/wiki/Mean</a></div><div><br></div><div>对方差, 标准差, 均值不了解的话, 建议参考网易公开课, 统计学.</div><div>浅显易懂.</div><div><a target="_blank" href="http://v.163.com/special/Khan/khstatistics.html"   >http://v.163.com/special/Khan/khstatistics.html</a></div><div><a target="_blank" rel="nofollow" href="http://v.ku6.com/playlist/index_6598382.html"   >http://v.ku6.com/playlist/index_6598382.html</a></div><div><br></div><div>PostgreSQL计算方差, 标准差的聚合函数如下 :&nbsp;</div><div><a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/functions-aggregate.html"   >http://www.postgresql.org/docs/devel/static/functions-aggregate.html</a></div><div><table border="1"   style="margin: 2ex 0px 2ex 2ex; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border-spacing: 0px; border-collapse: collapse; border: 2px solid rgb(167, 198, 223); color: rgb(0, 0, 0); font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: normal; background-color: rgb(224, 236, 239);"   ><tbody><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><code>stddev(<tt style="font-style: italic; font-size: 1em;"   >expression</tt>)</code></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>smallint</tt>,&nbsp;<tt>int</tt>,&nbsp;<tt>bigint</tt>,&nbsp;<tt>real</tt>,&nbsp;<tt>double precision</tt>, or&nbsp;<tt>numeric</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>double precision</tt>&nbsp;for floating-point arguments, otherwise&nbsp;<tt>numeric</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >historical alias for&nbsp;<code>stddev_samp</code></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><code>stddev_pop(<tt style="font-style: italic; font-size: 1em;"   >expression</tt>)</code></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>smallint</tt>,&nbsp;<tt>int</tt>,&nbsp;<tt>bigint</tt>,&nbsp;<tt>real</tt>,&nbsp;<tt>double precision</tt>, or&nbsp;<tt>numeric</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>double precision</tt>&nbsp;for floating-point arguments, otherwise&nbsp;<tt>numeric</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >population standard deviation of the input values</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(239, 239, 239);"   ><code>stddev_samp(<tt style="font-style: italic; font-size: 1em;"   >expression</tt>)</code></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(239, 239, 239);"   ><tt>smallint</tt>,&nbsp;<tt>int</tt>,&nbsp;<tt>bigint</tt>,&nbsp;<tt>real</tt>,&nbsp;<tt>double precision</tt>, or&nbsp;<tt>numeric</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(239, 239, 239);"   ><tt>double precision</tt>&nbsp;for floating-point arguments, otherwise&nbsp;<tt>numeric</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(239, 239, 239);"   >sample standard deviation of the input values</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><code>variance</code>(<tt style="font-style: italic;"   >expression</tt>)</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>smallint</tt>,&nbsp;<tt>int</tt>,&nbsp;<tt>bigint</tt>,&nbsp;<tt>real</tt>,&nbsp;<tt>double precision</tt>, or&nbsp;<tt>numeric</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>double precision</tt>&nbsp;for floating-point arguments, otherwise&nbsp;<tt>numeric</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >historical alias for&nbsp;<code>var_samp</code></td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><code>var_pop</code>(<tt style="font-style: italic;"   >expression</tt>)</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>smallint</tt>,&nbsp;<tt>int</tt>,&nbsp;<tt>bigint</tt>,&nbsp;<tt>real</tt>,&nbsp;<tt>double precision</tt>, or&nbsp;<tt>numeric</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>double precision</tt>&nbsp;for floating-point arguments, otherwise&nbsp;<tt>numeric</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >population variance of the input values (square of the population standard deviation)</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><code>var_samp</code>(<tt style="font-style: italic;"   >expression</tt>)</td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>smallint</tt>,&nbsp;<tt>int</tt>,&nbsp;<tt>bigint</tt>,&nbsp;<tt>real</tt>,&nbsp;<tt>double precision</tt>, or&nbsp;<tt>numeric</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>double precision</tt>&nbsp;for floating-point arguments, otherwise&nbsp;<tt>numeric</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >sample variance of the input values (square of the sample standard deviation)</td></tr></table></div><div>其中stddev和variance是stddev_samp和var_samp的别名.</div><div>这些函数用于计算数据集的总体/样本 方差,总体/样本 标准差.</div><div>例如 :&nbsp;</div><div>1,2,3,100 这组数据共4个值, 总体均值和样本均值分别为 :&nbsp;</div><div>(1+2+3+100)/4 = 26.5</div><div>总体方差 : ((1-26.5)^2 +&nbsp;<span style="line-height: 28px;"   >(2-26.5)^2 +&nbsp;</span><span style="line-height: 28px;"   >(3-26.5)^2 +&nbsp;</span><span style="line-height: 28px;"   >(100-26.5)^2)/4 = 1801.25</span></div><div>样本方差 :&nbsp;<span style="line-height: 28px;"   >((1-26.5)^2 +&nbsp;</span><span style="line-height: 28px;"   >(2-26.5)^2 +&nbsp;</span><span style="line-height: 28px;"   >(3-26.5)^2 +&nbsp;</span><span style="line-height: 28px;"   >(100-26.5)^2)/(4-1) = 2401.6666....</span></div><div>总体标准差 : 平方根(<span style="line-height: 28px;"   >总体方差</span><span style="line-height: 28px;"   >) =&nbsp;</span><span style="line-height: 28px;"   >42.4411357058220109</span></div><div>样本标准差 :&nbsp;<span style="line-height: 28px;"   >平方根(样本</span><span style="line-height: 28px;"   >方差</span><span style="line-height: 28px;"   >) =&nbsp;</span><span style="line-height: 28px;"   >49.0068022489395513</span></div><div>使用PostgreSQL计算如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select variance(id) from (values(1),(2),(3),(100)) as t(id);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;variance &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp;2401.6666666666666667</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# select var_pop(id) from (values(1),(2),(3),(100)) as t(id);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; var_pop &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp;1801.2500000000000000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# select var_samp(id) from (values(1),(2),(3),(100)) as t(id);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;var_samp &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp;2401.6666666666666667</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# select stddev(id) from (values(1),(2),(3),(100)) as t(id);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;stddev &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------------------</font></div><div><font size="2"   >&nbsp;49.0068022489395513</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# select stddev_pop(id) from (values(1),(2),(3),(100)) as t(id);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;stddev_pop &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------------------</font></div><div><font size="2"   >&nbsp;42.4411357058220109</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# select stddev_samp(id) from (values(1),(2),(3),(100)) as t(id);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;stddev_samp &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------------------</font></div><div><font size="2"   >&nbsp;49.0068022489395513</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>[参考]</div><div>1.&nbsp;src/backend/utils/adt/float.c</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=========================</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;FLOAT AGGREGATE OPERATORS</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=========================</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;float8_accum &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;- accumulate for AVG(), variance aggregates, etc.</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;float4_accum &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;- same, but input data is float4</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;float8_avg &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;- produce final result for float AVG()</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;float8_var_samp &nbsp; &nbsp; &nbsp; &nbsp; - produce final result for float VAR_SAMP()</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;float8_var_pop &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;- produce final result for float VAR_POP()</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;float8_stddev_samp &nbsp; &nbsp; &nbsp;- produce final result for float STDDEV_SAMP()</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;float8_stddev_pop &nbsp; &nbsp; &nbsp; - produce final result for float STDDEV_POP()</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* The transition datatype for all these aggregates is a 3-element array</font></div><div><font size="2"   >&nbsp;* of float8, holding the values N, sum(X), sum(X*X) in that order.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Note that we represent N as a float to avoid having to build a special</font></div><div><font size="2"   >&nbsp;* datatype. &nbsp;Given a reasonable floating-point implementation, there should</font></div><div><font size="2"   >&nbsp;* be no accuracy loss unless N exceeds 2 ^ 52 or so (by which time the</font></div><div><font size="2"   >&nbsp;* user will have doubtless lost interest anyway...)</font></div><div><font size="2"   >&nbsp;*/</font></div></div><div><font size="2"   >..................</font></div><div><div><font size="2"   >Datum</font></div><div><font size="2"   >float8_var_pop(PG_FUNCTION_ARGS)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ArrayType &nbsp;*transarray = PG_GETARG_ARRAYTYPE_P(0);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; float8 &nbsp; &nbsp; *transvalues;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; float8 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;N,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sumX,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sumX2,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; numerator;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; transvalues = check_float8_array(transarray, "float8_var_pop", 3);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; N = transvalues[0];</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; sumX = transvalues[1];</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; sumX2 = transvalues[2];</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Population variance is undefined when N is 0, so return NULL */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (N == 0.0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; numerator = N * sumX2 - sumX * sumX;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; CHECKFLOATVAL(numerator, isinf(sumX2) || isinf(sumX), true);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Watch out for roundoff error producing a negative numerator */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (numerator &lt;= 0.0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_FLOAT8(0.0);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_FLOAT8(numerator / (N * N));</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Datum</font></div><div><font size="2"   >float8_var_samp(PG_FUNCTION_ARGS)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ArrayType &nbsp;*transarray = PG_GETARG_ARRAYTYPE_P(0);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; float8 &nbsp; &nbsp; *transvalues;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; float8 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;N,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sumX,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sumX2,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; numerator;</font></div></div><div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; transvalues = check_float8_array(transarray, "float8_var_samp", 3);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; N = transvalues[0];</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; sumX = transvalues[1];</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; sumX2 = transvalues[2];</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Sample variance is undefined when N is 0 or 1, so return NULL */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (N &lt;= 1.0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; numerator = N * sumX2 - sumX * sumX;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; CHECKFLOATVAL(numerator, isinf(sumX2) || isinf(sumX), true);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Watch out for roundoff error producing a negative numerator */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (numerator &lt;= 0.0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_FLOAT8(0.0);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_FLOAT8(numerator / (N * (N - 1.0)));</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Datum</font></div><div><font size="2"   >float8_stddev_pop(PG_FUNCTION_ARGS)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ArrayType &nbsp;*transarray = PG_GETARG_ARRAYTYPE_P(0);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; float8 &nbsp; &nbsp; *transvalues;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; float8 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;N,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sumX,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sumX2,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; numerator;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; transvalues = check_float8_array(transarray, "float8_stddev_pop", 3);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; N = transvalues[0];</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; sumX = transvalues[1];</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; sumX2 = transvalues[2];</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Population stddev is undefined when N is 0, so return NULL */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (N == 0.0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();</font></div></div><div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; numerator = N * sumX2 - sumX * sumX;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; CHECKFLOATVAL(numerator, isinf(sumX2) || isinf(sumX), true);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Watch out for roundoff error producing a negative numerator */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (numerator &lt;= 0.0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_FLOAT8(0.0);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_FLOAT8(sqrt(numerator / (N * N)));</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Datum</font></div><div><font size="2"   >float8_stddev_samp(PG_FUNCTION_ARGS)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ArrayType &nbsp;*transarray = PG_GETARG_ARRAYTYPE_P(0);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; float8 &nbsp; &nbsp; *transvalues;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; float8 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;N,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sumX,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sumX2,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; numerator;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; transvalues = check_float8_array(transarray, "float8_stddev_samp", 3);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; N = transvalues[0];</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; sumX = transvalues[1];</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; sumX2 = transvalues[2];</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Sample stddev is undefined when N is 0 or 1, so return NULL */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (N &lt;= 1.0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; numerator = N * sumX2 - sumX * sumX;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; CHECKFLOATVAL(numerator, isinf(sumX2) || isinf(sumX), true);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Watch out for roundoff error producing a negative numerator */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (numerator &lt;= 0.0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_FLOAT8(0.0);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_FLOAT8(sqrt(numerator / (N * (N - 1.0))));</font></div></div><div><font size="2"   >}</font></div><p></p></pre></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="population  sample covariance, standard deviation Aggregate in PostgreSQL - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>