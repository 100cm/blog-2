<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">compare mongo 3.0.0 rc7 & PostgreSQL 9.3.5 insert use python</h2>
	<h5 id="">2015-02-04 14:55:38&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402015142858224/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>测试机用的CentOS 6.6 x64 96G内存, 8核, 数据文件放在 OCZ SSD</div><div>下载mongo 3.0</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># tar -zxvf mongodb-linux-x86_64-3.0.0-rc7.gz</font></div><div><font size="2"   ># cd mongodb-linux-x86_64-3.0.0-rc7</font></div><div><font size="2"   ># cd bin/</font></div><p></p></pre></div><div>创建数据文件目录</div><pre class="prettyprint"   ><p></p><div><font size="2"   ># mkdir -p&nbsp;/data01/mongodb</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >启动数据库, 参数全部在命令行中</span></div><pre class="prettyprint"   ><p><font size="2"   ># ./mongod --port 5281 --bind_ip 0.0.0.0 --maxConns 10000 --logpath /tmp/mongo.log --logappend --logRotate reopen --pidfilepath /tmp/mongo.pid --noauth --dbpath /data01/mongodb --fork</font></p><p><font size="2"   ><br></font></p><p><font size="2"   >2015-02-04T23:23:42.438+0800 I CONTROL  ***** SERVER RESTARTED *****<br>2015-02-04T23:23:42.470+0800 I CONTROL  [initandlisten] MongoDB starting : pid=627122 port=5281 dbpath=/data01/mongodb 64-bit host=localhost.localdomain<br>2015-02-04T23:23:42.470+0800 I CONTROL  [initandlisten] ** WARNING: You are running this process as the root user, which is not recommended.<br>2015-02-04T23:23:42.470+0800 I CONTROL  [initandlisten] <br>2015-02-04T23:23:42.471+0800 I CONTROL  [initandlisten] db version v3.0.0-rc7<br>2015-02-04T23:23:42.471+0800 I CONTROL  [initandlisten] git version: e4c60053b2967e16f765fa25d16aa6d629faa196<br>2015-02-04T23:23:42.471+0800 I CONTROL  [initandlisten] build info: Linux build14.nj1.10gen.cc 2.6.32-431.3.1.el6.x86_64 #1 SMP Fri Jan 3 21:39:27 UTC 2014 x86_64 BOOST_LIB_VERSION=1_49<br>2015-02-04T23:23:42.471+0800 I CONTROL  [initandlisten] allocator: tcmalloc<br>2015-02-04T23:23:42.471+0800 I CONTROL  [initandlisten] options: { net: { bindIp: "0.0.0.0", maxIncomingConnections: 10000, port: 5281 }, processManagement: { fork: true, pidFilePath: "/tmp/mongo.pid" }, security: { authorization: "disabled" }, storage: { dbPath: "/data01/mongodb" }, systemLog: { destination: "file", logAppend: true, logRotate: "reopen", path: "/tmp/mongo.log" } }<br>2015-02-04T23:23:42.483+0800 I JOURNAL  [initandlisten] journal dir=/data01/mongodb/journal<br>2015-02-04T23:23:42.483+0800 I JOURNAL  [initandlisten] recover : no journal files present, no recovery needed<br>2015-02-04T23:23:42.586+0800 I JOURNAL  [durability] Durability thread started<br>2015-02-04T23:23:42.587+0800 I JOURNAL  [journal writer] Journal writer thread started<br>2015-02-04T23:23:42.594+0800 I NETWORK  [initandlisten] waiting for connections on port 5281</font></p></pre><font size="2"   ><wbr></font><div><span style="line-height: 28px;"   >下载,安装 pymongo驱动</span></div><div><a target="_blank" rel="nofollow" href="https://pypi.python.org/pypi/pymongo/"   >https://pypi.python.org/pypi/pymongo/</a></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># wget&nbsp;https://pypi.python.org/packages/source/p/pymongo/pymongo-2.8.tar.gz#md5=23100361c9af1904eb2d7722f2658114</font></div><div><font size="2"   ># tar -zxvf pymongo-2.8.tar.gz</font></div><div><font size="2"   ># cd pymongo-2.8</font></div><div><font size="2"   ># python setup.py install</font></div><p></p></pre></div><div>退出pymongo的源码目录</div><div>测试</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   ># cd</font></div><div><font size="2"   >[root@localhost ~]# python</font></div><div><font size="2"   >Python 3.4.2 (default, Jan 27 2015, 00:11:11)&nbsp;</font></div><div><font size="2"   >[GCC 4.8.2 20140120 (Red Hat 4.8.2-16)] on linux</font></div><div><font size="2"   >Type "help", "copyright", "credits" or "license" for more information.</font></div><div><font size="2"   >&gt;&gt;&gt; import pymongo</font></div></div><div><font size="2"   ># 因为我们这里使用的是单节点mongo, 所以使用MongoClient链接即可, 如果用到了master-slave或replica, 最好使用对应的链接接口.</font></div><div><font size="2"   >&gt;&gt;&gt; c=pymongo.MongoClient(host='127.0.0.1',port=5281,max_pool_size=1000)</font></div><div><font size="2"   ># 创建或连接到一个数据库</font></div><div><div><div><font size="2"   >&gt;&gt;&gt; db = c.test_database</font></div><div><font size="2"   ># 创建或使用一个已有的collection</font></div><div><font size="2"   >&gt;&gt;&gt; collection = db.test_collection</font></div><div><font size="2"   ># 生成条dict记录</font></div><div><font size="2"   >&gt;&gt;&gt; row={'id':1, 'username': 'digoal.zhou', 'age':32, 'email':'digoal@126.com', 'qq':'276732431'}</font></div><div><font size="2"   >&gt;&gt;&gt; row</font></div><div><font size="2"   >{'age': 32, 'qq': '276732431', 'email': 'digoal@126.com', 'id': 1, 'username': 'digoal.zhou'}</font></div><div><font size="2"   >&gt;&gt;&gt; type(row)</font></div><div><font size="2"   >&lt;class 'dict'&gt;</font></div><div><font size="2"   ># 插入到collection</font></div><div><font size="2"   >&gt;&gt;&gt; collection.insert(row)</font></div><div><font size="2"   >ObjectId('54d22c8de138238e62bcd73f')</font></div><div><font size="2"   >&gt;&gt;&gt; collection</font></div><div><font size="2"   >Collection(Database(MongoClient('127.0.0.1', 5281), 'test_database'), 'test_collection')</font></div><div><font size="2"   ># 注意再次插入为什么失败呢?</font></div><div><font size="2"   ># 原因是insert后row被变更了, 自动添加一个_id, 即mongodb 中唯一标识一个document的值, 必须唯一.</font></div><div><font size="2"   >&gt;&gt;&gt; r1=collection.insert(row)</font></div><div><font size="2"   >Traceback (most recent call last):</font></div><div><font size="2"   >&nbsp; File "&lt;stdin&gt;", line 1, in &lt;module&gt;</font></div><div><font size="2"   >&nbsp; File "/usr/local/lib/python3.4/site-packages/pymongo-2.8-py3.4-linux-x86_64.egg/pymongo/collection.py", line 410, in insert</font></div><div><font size="2"   >&nbsp; &nbsp; _check_write_command_response(results)</font></div><div><font size="2"   >&nbsp; File "/usr/local/lib/python3.4/site-packages/pymongo-2.8-py3.4-linux-x86_64.egg/pymongo/helpers.py", line 202, in _check_write_command_response</font></div><div><font size="2"   >&nbsp; &nbsp; raise DuplicateKeyError(error.get("errmsg"), 11000, error)</font></div><div><font size="2"   >pymongo.errors.DuplicateKeyError: E11000 duplicate key error index: test_database.test_collection.$_id_ dup key: { : ObjectId('54d22c8de138238e62bcd73f') }</font></div></div><div><div><font size="2"   >&gt;&gt;&gt; print(row)</font></div><div><font size="2"   >{'age': 32, 'qq': '276732431', 'email': 'digoal@126.com', '_id': ObjectId('54d22d37e138238e62bcd740'), 'id': 1, 'username': 'digoal.zhou'}</font></div></div></div><p></p></pre></div><div><br></div><div>测试mongodb插入性能</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># vi test.py</font></div><div><font size="2"   ><span style="line-height: 21px;"   >import pymongo<br>import time</span></font></div><div><font size="2"   ><span style="line-height: 21px;"   ><br></span></font></div><div><font size="2"   ><span style="line-height: 21px;"   ># 使用unix socket连接</span></font></div><div><font size="2"   >c=pymongo.MongoClient('/tmp/mongodb-5281.sock')<br># c=pymongo.MongoClient(host='127.0.0.1',port=5281,max_pool_size=1000)<br>db = c.test_database<br>db.drop_collection('test_collection')<br>collection = db.test_collection<br>print(time.time())<br>print(collection.count())<br>for i in range(0,1000000):<br>  collection.insert({'id':1, 'username': 'digoal.zhou', 'age':32, 'email':'digoal@126.com', 'qq':'276732431'})<br>print(time.time())<br>print(collection.count())</font></div><p></p></pre></div><div>测试结果 :&nbsp;</div><div>100万条记录, 单线程插入耗时378秒.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># python ./test.py</font></div><div><font size="2"   ><span style="line-height: 21px;"   >1423061694.137046<br>0<br>1423062072.2314758<br>1000000</span></font></div><p></p></pre></div><div><br></div><div>对比测试同一台主机的postgresql插入性能 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >$ vi test.py</font></div><div><font size="2"   >import postgresql</font></div><div><font size="2"   >import time</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># 使用unix socket连接</font></div><div><font size="2"   >conn = { "user": "postgres",&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"database": "postgres",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"unix": "/data01/pgdata/pg_root/.s.PGSQL.1921"</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >db = postgresql.open(**conn)</font></div><div><font size="2"   >db.execute("drop table if exists tt")</font></div><div><font size="2"   >db.execute("create table tt(id int, username name, age int2, email text, qq text)")</font></div><div><font size="2"   >ins = db.prepare("insert into tt values($1,$2,$3,$4,$5)")</font></div><div><font size="2"   >print(time.time())</font></div><div><font size="2"   ><span style="line-height: 21px;"   >print(db.query("select count(1) as a from tt"))</span></font></div><div><font size="2"   >for i in range(0,1000000):</font></div><div><font size="2"   >&nbsp; ins(1,'digoal.zhou',32,'digoal@126.com','276732431')</font></div><div><font size="2"   >print(time.time())</font></div><div><font size="2"   ><span style="line-height: 21px;"   >print(db.query("select count(1) as a from tt"))</span></font></div><p></p></pre></div><div>测试结果 :</div><div><span style="line-height: 28px;"   >100万条记录, 单线程插入耗时187秒.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 21px;"   >$ python test.py</span></font></div><div><font size="2"   ><span style="line-height: 21px;"   >1423062311.1081557<br>[(0,)]<br>1423062498.4938233<br>[(1000000,)]</span></font></div><p></p></pre></div><div><br></div><div>测试结果仅供参考.</div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://api.mongodb.org/python/current/api/pymongo/index.html"   >http://api.mongodb.org/python/current/api/pymongo/index.html</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020151210840303/"   >http://blog.163.com/digoal@126/blog/static/16387704020151210840303/</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="compare mongo 3.0.0 rc7  PostgreSQL 9.3.5 insert use python - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>