<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">psycopg2 postgresql driver for python don't support prepared statement Direct</h2>
	<h5 id="">2015-02-05 15:03:57&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402015151653642/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div><span style="line-height: 28px;"   >前面使用py-postgresql测试过PostgreSQL性能, 可能是这个驱动效率较低, 我们接下来使用psycopg2测试一下.</span></div><div>psycopg2使用libpq接口, 支持2PC, 支持异步提交等,&nbsp;<span style="line-height: 28px;"   >但是不支持绑定变量.</span></div><div>安装</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@localhost ~]# . /home/postgres/.bash_profile&nbsp;</font></div><div><font size="2"   >root@localhost-&gt; which pg_config</font></div><div><font size="2"   >/opt/pgsql9.3.5/bin/pg_config</font></div></div><font size="2"   >[root@localhost ~]# pip3.4 install psycopg2 --upgrade</font><div><font size="2"   >或</font></div><div><span style="line-height: 28px;"   ><font size="2"   >[root@localhost ~]# pip3.4 install psycopg2</font></span></div><p></p></pre></div></div><div><br></div><div>异步操作, 对数据库端来说意义不大, 因为在执行的话, 不能再次提交SQL请求.</div><div>如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >import psycopg2</font></div><div><font size="2"   >import time</font></div><div><font size="2"   >import select</font></div><div><font size="2"   >conn = psycopg2.connect(database="postgres", user="postgres", password="postgres", host="/data01/pgdata/pg_root", port="1921", async=True)</font></div><div><div><font size="2"   >&gt;&gt;&gt; def wait(conn):</font></div><div><font size="2"   >... &nbsp; &nbsp; while 1:</font></div><div><font size="2"   >... &nbsp; &nbsp; &nbsp; &nbsp; state = conn.poll()</font></div><div><font size="2"   >... &nbsp; &nbsp; &nbsp; &nbsp; if state == psycopg2.extensions.POLL_OK:</font></div><div><font size="2"   >... &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break</font></div><div><font size="2"   >... &nbsp; &nbsp; &nbsp; &nbsp; elif state == psycopg2.extensions.POLL_WRITE:</font></div><div><font size="2"   >... &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; select.select([], [conn.fileno()], [])</font></div><div><font size="2"   >... &nbsp; &nbsp; &nbsp; &nbsp; elif state == psycopg2.extensions.POLL_READ:</font></div><div><font size="2"   >... &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; select.select([conn.fileno()], [], [])</font></div><div><font size="2"   >... &nbsp; &nbsp; &nbsp; &nbsp; else:</font></div><div><font size="2"   >... &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; raise psycopg2.OperationalError("poll() returned %s" % state)</font></div><div><font size="2"   >...&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >wait(conn)</font></div><div><font size="2"   >curs = conn.cursor()</font></div><div><font size="2"   >curs.execute("insert into tt values(%(id)s, 'digoal.zhou', 32, 'digoal@126.com', '276732431')", {"id": 1})</font></div><div><div><font size="2"   >curs.execute("insert into tt values(%(id)s, 'digoal.zhou', 32, 'digoal@126.com', '276732431')", {"id": 1})</font></div><div><font size="2"   >Traceback (most recent call last):</font></div><div><font size="2"   >&nbsp; File "&lt;stdin&gt;", line 1, in &lt;module&gt;</font></div><div><font size="2"   >psycopg2.ProgrammingError: execute cannot be used while an asynchronous query is underway</font></div><div><font size="2"   >&gt;&gt;&gt; wait(curs.connection)</font></div></div><div><div><font size="2"   >&gt;&gt;&gt; wait(curs.connection)</font></div><div><font size="2"   >&gt;&gt;&gt; curs.execute("insert into tt values(%(id)s, 'digoal.zhou', 32, 'digoal@126.com', '276732431')", {"id": 1})</font></div><div><font size="2"   >&gt;&gt;&gt; wait(curs.connection)</font></div><div><font size="2"   >&gt;&gt;&gt; curs.execute("insert into tt values(%(id)s, 'digoal.zhou', 32, 'digoal@126.com', '276732431')", {"id": 1})</font></div><div><font size="2"   >&gt;&gt;&gt; wait(curs.connection)</font></div><div><font size="2"   >&gt;&gt;&gt; conn.poll()</font></div><div><font size="2"   >0</font></div><div><font size="2"   >&gt;&gt;&gt; curs.execute("insert into tt values(%(id)s, 'digoal.zhou', 32, 'digoal@126.com', '276732431')", {"id": 1})</font></div><div><font size="2"   >&gt;&gt;&gt; conn.poll()</font></div><div><font size="2"   >0</font></div><div><font size="2"   >&gt;&gt;&gt; curs.execute("insert into tt values(%(id)s, 'digoal.zhou', 32, 'digoal@126.com', '276732431')", {"id": 1})</font></div><div><font size="2"   >&gt;&gt;&gt; conn.poll()</font></div><div><font size="2"   >0</font></div><div><font size="2"   >&gt;&gt;&gt; psycopg2.extensions.POLL_OK</font></div><div><font size="2"   >0</font></div><div><font size="2"   >&gt;&gt;&gt; psycopg2.extensions.POLL_WRITE</font></div><div><font size="2"   >2</font></div><div><font size="2"   >&gt;&gt;&gt; psycopg2.extensions.POLL_READ</font></div><div><font size="2"   >1</font></div></div></div><p></p></pre></div><div><div><br></div><div>同时psycopg2不支持prepared statement</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&gt;&gt;&gt; curs.prepare("insert into tt values(%(id)s, 'digoal.zhou', 32, 'digoal@126.com', '276732431')")</font></div><div><font size="2"   >Traceback (most recent call last):</font></div><div><font size="2"   >&nbsp; File "&lt;stdin&gt;", line 1, in &lt;module&gt;</font></div><div><font size="2"   >AttributeError: 'psycopg2._psycopg.cursor' object has no attribute 'prepare'</font></div><div><font size="2"   >&gt;&gt;&gt; dir(curs)</font></div><div><font size="2"   >['__class__', '__delattr__', '__dir__', '__doc__', '__enter__', '__eq__', '__exit__', '__format__', '__ge__', '__getattribute__', '__gt__', '__hash__', '__init__', '__iter__', '__le__', '__lt__', '__ne__', '__new__', '__next__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__', 'arraysize', 'binary_types', 'callproc', 'cast', 'close', 'closed', 'connection', 'copy_expert', 'copy_from', 'copy_to', 'description', 'execute', 'executemany', 'fetchall', 'fetchmany', 'fetchone', 'itersize', 'lastrowid', 'mogrify', 'name', 'nextset', 'query', 'row_factory', 'rowcount', 'rownumber', 'scroll', 'scrollable', 'setinputsizes', 'setoutputsize', 'statusmessage', 'string_types', 'typecaster', 'tzinfo_factory', 'withhold']</font></div><p></p></pre></div><div><br></div><div>为什么这么说呢?, 调用<span style="line-height: 28px;"   >curs.execute("insert into tt values(%(id)s, 'digoal.zhou', 32, 'digoal@126.com', '276732431')", {"id": 1})</span></div><div><span style="line-height: 28px;"   >你觉得是绑定变量吗? 看看PostgreSQL的日志吧 :&nbsp;</span></div><pre class="prettyprint"   ><p></p><div><font size="2"   >2015-02-05 22:37:32.901 CST,"postgres","postgres",69785,"[local]",54d37ee8.11099,1,"idle",2015-02-05 22:32:08 CST,3/1996971,0,LOG,00000,"statement: insert into tt values(1, 'digoal.zhou', 32, 'digoal@126.com', '276732431')",,,,,,,,"exec_simple_query, postgres.c:890",""</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >调用的是exec_simple_query接口, 当然不是绑定变量.</span></div><div><br></div><div>间接的使用绑定变量, 但实际上SQL调用的还是<span style="line-height: 28px;"   >exec_simple_query接口, 只是在处理execute这个SQL时使用到了绑定变量.</span></div><div><span style="line-height: 28px;"   >这个是较老的用法.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&gt;&gt;&gt; curs.execute("prepare pre1(int) as insert into tt values($1, 'digoal.zhou', 32, 'digoal@126.com', '276732431')")</font></div><div><font size="2"   >&gt;&gt;&gt; conn.poll()</font></div><div><font size="2"   >0</font></div><div><font size="2"   >&gt;&gt;&gt; curs.execute("execute pre1(1)")</font></div><div><font size="2"   >&gt;&gt;&gt; conn.poll()</font></div><div><font size="2"   >0</font></div><div><font size="2"   >&gt;&gt;&gt; curs.execute("execute pre1(1)")</font></div><div><font size="2"   >&gt;&gt;&gt; conn.poll()</font></div><div><font size="2"   >0</font></div><p></p></pre></div><div>PostgreSQL日志 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >2015-02-05 22:50:42.678 CST,"postgres","postgres",69785,"[local]",54d37ee8.11099,5,"idle",2015-02-05 22:32:08 CST,3/1996975,0,LOG,00000,"statement: prepare pre1(int) as insert into tt values($1, 'digoal.zhou', 32, 'digoal@126.com', '276732431')",,,,,,,,"exec_simple_query, postgres.c:890",""</font></div><div><font size="2"   >2015-02-05 22:50:59.425 CST,"postgres","postgres",69785,"[local]",54d37ee8.11099,6,"idle",2015-02-05 22:32:08 CST,3/1996976,0,LOG,00000,"statement: execute pre1(1)","prepare: prepare pre1(int) as insert into tt values($1, 'digoal.zhou', 32, 'digoal@126.com', '276732431')",,,,,,,"exec_simple_query, postgres.c:890",""</font></div><div><font size="2"   >2015-02-05 22:51:22.425 CST,"postgres","postgres",69785,"[local]",54d37ee8.11099,7,"idle",2015-02-05 22:32:08 CST,3/1996977,0,LOG,00000,"statement: execute pre1(1)","prepare: prepare pre1(int) as insert into tt values($1, 'digoal.zhou', 32, 'digoal@126.com', '276732431')",,,,,,,"exec_simple_query, postgres.c:890",""</font></div><p></p></pre></div><div><br></div><div>效率如何呢?</div><div>使用8个线程插入100W数据, 耗时41秒.</div><div>py-postgresql驱动耗时226秒, psycopg2效率高了很多, 接近pgbench的16秒了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost ~]# cat t.py</font></div><div><font size="2"   >import psycopg2</font></div><div><font size="2"   >import time</font></div><div><font size="2"   >import threading</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >class n_t(threading.Thread): &nbsp; #The timer class is derived from the class threading.Thread</font></div><div><font size="2"   >&nbsp; def __init__(self, num):</font></div><div><font size="2"   >&nbsp; &nbsp; threading.Thread.__init__(self)</font></div><div><font size="2"   >&nbsp; &nbsp; self.thread_num = num</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; def run(self): #Overwrite run() method, put what you want the thread do here</font></div><div><font size="2"   >&nbsp; &nbsp; conn = psycopg2.connect(database="postgres", user="postgres", password="postgres", host="/data01/pgdata/pg_root", port="1921")</font></div><div><font size="2"   >&nbsp; &nbsp; curs = conn.cursor()</font></div><div><font size="2"   >&nbsp; &nbsp; conn.autocommit=True</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; start_t = time.time()</font></div><div><font size="2"   >&nbsp; &nbsp; print("TID:" + str(self.thread_num) + " " + str(start_t))</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; for i in range(self.thread_num*125000, (self.thread_num+1)*125000):</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; curs.execute("insert into tt values(%(id)s, 'digoal.zhou', 32, 'digoal@126.com', '276732431')", {"id": i})</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; stop_t = time.time()</font></div><div><font size="2"   >&nbsp; &nbsp; print("TID:" + str(self.thread_num) + " " + str(stop_t))</font></div><div><font size="2"   >&nbsp; &nbsp; print(stop_t-start_t)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >def test():</font></div><div><font size="2"   >&nbsp; t_names = dict()</font></div><div><font size="2"   >&nbsp; for i in range(0,8):</font></div><div><font size="2"   >&nbsp; &nbsp; t_names[i] = n_t(i)&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; t_names[i].start()</font></div><div><font size="2"   >&nbsp; return</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >if __name__ == '__main__':</font></div><div><font size="2"   >&nbsp; test()</font></div><p></p></pre></div><div>测试结果 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost ~]# python t.py</font></div><div><font size="2"   >TID:0 1423148404.5820847</font></div><div><font size="2"   >TID:1 1423148404.5828164</font></div><div><font size="2"   >TID:2 1423148404.5850544</font></div><div><font size="2"   >TID:3 1423148404.58532</font></div><div><font size="2"   >TID:4 1423148404.5861893</font></div><div><font size="2"   >TID:5 1423148404.5867805</font></div><div><font size="2"   >TID:6 1423148404.5882406</font></div><div><font size="2"   >TID:7 1423148404.588671</font></div><div><font size="2"   >TID:2 1423148445.146449</font></div><div><font size="2"   >40.561394691467285</font></div><div><font size="2"   >TID:7 1423148445.2051861</font></div><div><font size="2"   >40.616515159606934</font></div><div><font size="2"   >TID:6 1423148445.2321012</font></div><div><font size="2"   >40.64386057853699</font></div><div><font size="2"   >TID:1 1423148445.263236</font></div><div><font size="2"   >40.68041968345642</font></div><div><font size="2"   >TID:5 1423148445.2703242</font></div><div><font size="2"   >40.68354368209839</font></div><div><font size="2"   >TID:0 1423148445.2967775</font></div><div><font size="2"   >40.71469283103943</font></div><div><font size="2"   >TID:3 1423148445.3065617</font></div><div><font size="2"   >40.72124171257019</font></div><div><font size="2"   >TID:4 1423148445.3345916</font></div><div><font size="2"   >40.74840235710144</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select count(*),count(distinct id) from tt;<br>  count  |  count  <br>---------+---------<br> 1000000 | 1000000<br>(1 row)</font></div><p></p></pre></div><div><br></div><div>[参考]</div><div>1.&nbsp;<a target="_blank" rel="nofollow" href="https://wiki.postgresql.org/wiki/Python"   >https://wiki.postgresql.org/wiki/Python</a></div><div>2.&nbsp;<a target="_blank" rel="nofollow" href="https://wiki.postgresql.org/wiki/Using_psycopg2_with_PostgreSQL"   >https://wiki.postgresql.org/wiki/Using_psycopg2_with_PostgreSQL</a><br><wbr><div>3.&nbsp;<a target="_blank" rel="nofollow" href="http://initd.org/psycopg/docs/index.html"   >http://initd.org/psycopg/docs/index.html</a></div><div><br></div></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="psycopg2 postgresql driver for python dont support prepared statement Direct - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a><br></div></div>
	</div>
</div>
</body>
</html>