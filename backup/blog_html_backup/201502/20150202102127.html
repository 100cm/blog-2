<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">compare python use py-postgresql & direct pgbench's performance</h2>
	<h5 id="">2015-02-02 10:21:27&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020151210840303/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div><div style="line-height: 28px;"   >使用py-postgresql驱动链接PostgreSQL, 使用unix socket链接.</div><div style="line-height: 28px;"   >测试插入性能, 单线程插入100万数据需要172秒.</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >$ vi test.py</font></div><div style="line-height: 28px;"   ><font size="2"   >import postgresql</font></div><div style="line-height: 28px;"   ><font size="2"   >import time</font></div><div style="line-height: 28px;"   ><font size="2"   >conn = { "user": "postgres",&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"database": "postgres",</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"unix": "/data01/pgdata/pg_root/.s.PGSQL.1921"</font></div><div style="line-height: 28px;"   ><font size="2"   >}</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >db = postgresql.open(**conn)</font></div><div style="line-height: 28px;"   ><font size="2"   >db.execute("create table if not exists tt(id int)")</font></div><div style="line-height: 28px;"   ><font size="2"   >ins = db.prepare("insert into tt values($1)")</font></div><div style="line-height: 28px;"   ><font size="2"   >print(time.time())</font></div><div style="line-height: 28px;"   ><font size="2"   >for i in range(0,1000000):</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; ins(i)</font></div><div style="line-height: 28px;"   ><font size="2"   >print(time.time())</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >postgres@localhost-&gt; python test.py</font></div><div style="line-height: 28px;"   ><font size="2"   >1422871147.8219907</font></div><div style="line-height: 28px;"   ><font size="2"   >1422871319.8280523</font></div><div style="line-height: 28px;"   ><font size="2"   >耗费172秒</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >TOP</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;593328 postgres &nbsp;20 &nbsp; 0 &nbsp;189128 &nbsp;16960 &nbsp; 7632 R &nbsp;81.3 &nbsp;0.0 &nbsp; 0:09.31 /usr/local/bin/python3 test.py &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;593329 postgres &nbsp;20 &nbsp; 0 8628412 &nbsp;26260 &nbsp;24088 S &nbsp;32.2 &nbsp;0.0 &nbsp; 0:04.41 postgres: postgres postgres [local] idle &nbsp;</font></div><p></p></pre></div></div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >使用while循环亦如此 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres@localhost-&gt; cat test.py</font></div><div><font size="2"   >import postgresql</font></div><div><font size="2"   >import time</font></div><div><font size="2"   >conn = { "user": "postgres",&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"database": "postgres",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"unix": "/data01/pgdata/pg_root/.s.PGSQL.1921"</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >db = postgresql.open(**conn)</font></div><div><font size="2"   >db.execute("create table if not exists tt(id int)")</font></div><div><font size="2"   >ins = db.prepare("insert into tt values($1)")</font></div><div><font size="2"   >print(time.time())</font></div><div><font size="2"   >i = 0</font></div><div><font size="2"   >while i&lt;1000000:</font></div><div><font size="2"   >&nbsp; ins(i)</font></div><div><font size="2"   >&nbsp; i=i+1</font></div><div><font size="2"   >print(time.time())</font></div></div><div><font size="2"   ><br></font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >postgres@localhost-&gt; python test.py</font></div><div style="line-height: 28px;"   ><font size="2"   >1422872074.1050985</font></div><div style="line-height: 28px;"   ><font size="2"   >1422872255.3471527</font></div></div><p></p></pre></div><div style="line-height: 28px;"   ><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@localhost-&gt; cat test.py</font></div><div><font size="2"   >import postgresql</font></div><div><font size="2"   >import time</font></div><div><font size="2"   >conn = { "user": "postgres",&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"database": "postgres",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"unix": "/data01/pgdata/pg_root/.s.PGSQL.1921"</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >db = postgresql.open(**conn)</font></div><div><font size="2"   >db.execute("create table if not exists tt(id int)")</font></div><div><font size="2"   >ins = db.prepare("insert into tt values($1)")</font></div><div><font size="2"   >print(time.time())</font></div><div><font size="2"   >i = 0</font></div><div><font size="2"   >while i&lt;1000000:</font></div><div><font size="2"   >&nbsp; ins(i)</font></div><div><font size="2"   >&nbsp; i=i+1</font></div><div><font size="2"   >print(time.time())</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >使用pgbench单线程插入100万, 只需要55秒.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@localhost-&gt; pgbench -M prepared -n -r -f ./test.sql -c 1 -j 1 -t 1000000</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 1</font></div><div><font size="2"   >number of threads: 1</font></div><div><font size="2"   >number of transactions per client: 1000000</font></div><div><font size="2"   >number of transactions actually processed: 1000000/1000000</font></div><div><font size="2"   >tps = 18156.624380 (including connections establishing)</font></div><div><font size="2"   >tps = 18157.507920 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.001353 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 0 1000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.052901 &nbsp; &nbsp; &nbsp; &nbsp;insert into tt values (:id)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select 1000000/18157.507920;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; ?column? &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------------------</font></div><div><font size="2"   >&nbsp;55.0736369994104345</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>之前使用sysbench测试和pgbench测试相差也巨大.</div></div><div>sysbench, py-postgresql和C+libpq比性能损耗差距巨大.</div><div>python循环消耗极低, 看样子还是在驱动上, 未使用异步接口:&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >print(time.time())</font></div><div><font size="2"   >for i in range(0,1000000):</font></div><div><font size="2"   >&nbsp; pass</font></div><div><font size="2"   >print(time.time())</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres@localhost-&gt; python test.py</font></div><div><font size="2"   >1422872588.5488484</font></div><div><font size="2"   >1422872588.610911</font></div></div><p></p></pre></div><div><br></div><div><br></div><div>其他</div><div>1. py-postgresql的例子</div><div>事务使用db.xact():</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&gt;&gt;&gt; import postgresql</font></div><div><font size="2"   >&gt;&gt;&gt; db = postgresql.open('pq://user:password@host:port/database')</font></div><div><font size="2"   >&gt;&gt;&gt; db.execute("CREATE TABLE emp (emp_first_name text, emp_last_name text, emp_salary numeric)")</font></div><div><font size="2"   >&gt;&gt;&gt; make_emp = db.prepare("INSERT INTO emp VALUES ($1, $2, $3)")</font></div><div><font size="2"   >&gt;&gt;&gt; make_emp("John", "Doe", "75,322")</font></div><div><font size="2"   >&gt;&gt;&gt; with db.xact():</font></div><div><font size="2"   >... &nbsp;make_emp("Jane", "Doe", "75,322")</font></div><div><font size="2"   >... &nbsp;make_emp("Edward", "Johnson", "82,744")</font></div><div><font size="2"   >...</font></div><p></p></pre></div><div><br></div><div><br></div><div>[参考]</div>1.&nbsp;<wbr><a target="_blank" rel="nofollow" href="https://pypi.python.org/pypi/py-postgresql/1.1.0"   >https://pypi.python.org/pypi/py-postgresql/</a><div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="compare python use py-postgresql  direct pgbenchs performance - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a><br></div></div>
	</div>
</div>
</body>
</html>