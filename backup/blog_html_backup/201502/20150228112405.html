<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL attr correlation for values(logical order) & ctid (physcial order)</h2>
	<h5 id="">2015-02-28 11:24:05&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201512810112541/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>PostgreSQL统计信息中, 有一个相关性的统计, 在pg_stats.correlation中可以查看到,&nbsp;</div><div>统计值范围从-1到1, 趋向于-1表示逆向相关, 趋向于1表示正向相关, 趋向于0表示不相关.</div><div><pre><p></p><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \d pg_stats</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; View "pg_catalog.pg_stats"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Column &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; Type &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"   >------------------------+----------+-----------</font></div><div><font size="2"   >&nbsp;schemaname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | name &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;tablename &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| name &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;attname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| name &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;inherited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| boolean &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;null_frac &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| real &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;avg_width &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| integer &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;n_distinct &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | real &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;most_common_vals &nbsp; &nbsp; &nbsp; | anyarray |&nbsp;</font></div><div><font size="2"   >&nbsp;most_common_freqs &nbsp; &nbsp; &nbsp;| real[] &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;histogram_bounds &nbsp; &nbsp; &nbsp; | anyarray |&nbsp;</font></div><div><font size="2"   >&nbsp;correlation &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| real &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;most_common_elems &nbsp; &nbsp; &nbsp;| anyarray |&nbsp;</font></div><div><font size="2"   >&nbsp;most_common_elem_freqs | real[] &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;elem_count_histogram &nbsp; | real[] &nbsp; |&nbsp;</font></div><p></p></pre></div><p></p></pre></div><div><span style="line-height: 28px;"   >correlation的</span>含义是什么呢?</div><div>即列的物理顺序和列的逻辑顺序的相关性.</div><div>相关性越高, 走索引扫描的离散块扫描更少, 也就是说, 相关性越高, 走索引扫描的离散块扫描代价越低.</div><div>相关性在其他领域也有非常重要的应用, 例如广告投入和销售额的数据, 看百度提到的例子 :&nbsp;</div><div><div style="color: rgb(51, 51, 51); margin: 15px 0px 5px; text-indent: 2em; line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;"   >软件公司在全国有许多<a style="text-decoration: none; color: rgb(19, 110, 194);" target="_blank" rel="nofollow" href="http://baike.baidu.com/view/46500.htm"   >代理商</a>，为研究它的财务软件产品的广告投入与<a style="text-decoration: none; color: rgb(19, 110, 194);" target="_blank" rel="nofollow" href="http://baike.baidu.com/view/978270.htm"   >销售额</a>的关系，统计人员随机选择10家代理商进行观察，搜集到年广告投入费和月平均销售额的数据，并编制成<a style="text-decoration: none; color: rgb(19, 110, 194);" target="_blank" rel="nofollow" href="http://baike.baidu.com/view/4477555.htm"   >相关表</a>，见表1:</div><div style="color: rgb(51, 51, 51); margin: 15px 0px 5px; text-indent: 2em; line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;"   ><b>表1　<a style="text-decoration: none; color: rgb(19, 110, 194);" target="_blank" rel="nofollow" href="http://baike.baidu.com/view/1987435.htm"   >广告费</a>与月平均销售额相关表　单位：万元</b></div><table><tbody><tr><th style="margin: 0px; padding: 2px 10px; line-height: 22px; height: 23px; border: 1px solid rgb(230, 230, 230); text-align: center; background-color: rgb(249, 249, 249);"   ><div style="color: rgb(51, 51, 51); margin: 0px; line-height: 24px;"   >年广告费投入</div></th><th style="margin: 0px; padding: 2px 10px; line-height: 22px; height: 23px; border: 1px solid rgb(230, 230, 230); text-align: center; background-color: rgb(249, 249, 249);"   ><div style="color: rgb(51, 51, 51); margin: 0px; line-height: 24px;"   >月均销售额</div></th></tr><tr><td style="margin: 0px; padding: 2px 10px; line-height: 22px; height: 22px; border: 1px solid rgb(230, 230, 230);"   ><div style="color: rgb(51, 51, 51); margin: 0px; line-height: 24px;"   >12.5　　15.3　　23.2　　26.4　　33.5　　34.4　　39.4　　45.2　　55.4　　60.9</div></td><td style="margin: 0px; padding: 2px 10px; line-height: 22px; height: 22px; border: 1px solid rgb(230, 230, 230);"   ><div style="color: rgb(51, 51, 51); margin: 0px; line-height: 24px;"   >21.2　　23.9　　32.9　　34.1　　42.5　　43.2　　49.0　　52.8　　59.4　　63.5</div></td></tr></table><div style="color: rgb(51, 51, 51); margin: 15px 0px 5px; text-indent: 2em; line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;"   >参照表1，可计算相关系数如表2：</div><table><tbody><tr><th style="margin: 0px; padding: 2px 10px; line-height: 22px; height: 23px; border: 1px solid rgb(230, 230, 230); text-align: center; background-color: rgb(249, 249, 249);"   ><div style="color: rgb(51, 51, 51); margin: 0px; line-height: 24px;"   >序号</div></th><th style="margin: 0px; padding: 2px 10px; line-height: 22px; height: 23px; border: 1px solid rgb(230, 230, 230); text-align: center; background-color: rgb(249, 249, 249);"   ><div style="color: rgb(51, 51, 51); margin: 0px; line-height: 24px;"   >广告投入(万元)<br>　　x</div></th><th style="margin: 0px; padding: 2px 10px; line-height: 22px; height: 23px; border: 1px solid rgb(230, 230, 230); text-align: center; background-color: rgb(249, 249, 249);"   ><div style="color: rgb(51, 51, 51); margin: 0px; line-height: 24px;"   >月均销售额(万元)<br>　　y</div></th><th style="margin: 0px; padding: 2px 10px; line-height: 22px; height: 23px; border: 1px solid rgb(230, 230, 230); text-align: center; background-color: rgb(249, 249, 249);"   ><div style="color: rgb(51, 51, 51); margin: 0px; line-height: 24px;"   ><div><img></div></div></th><th style="margin: 0px; padding: 2px 10px; line-height: 22px; height: 23px; border: 1px solid rgb(230, 230, 230); text-align: center; background-color: rgb(249, 249, 249);"   ><div style="color: rgb(51, 51, 51); margin: 0px; line-height: 24px;"   ><div><img></div></div></th><th style="margin: 0px; padding: 2px 10px; line-height: 22px; height: 23px; border: 1px solid rgb(230, 230, 230); text-align: center; background-color: rgb(249, 249, 249);"   ><div style="color: rgb(51, 51, 51); margin: 0px; line-height: 24px;"   ><div><img></div></div></th></tr><tr><td style="margin: 0px; padding: 2px 10px; line-height: 22px; height: 22px; border: 1px solid rgb(230, 230, 230);"   ><div style="color: rgb(51, 51, 51); margin: 0px; line-height: 24px;"   >1　　2　　3　　4　　5　　6　　7　　8　　9　　10</div></td><td style="margin: 0px; padding: 2px 10px; line-height: 22px; height: 22px; border: 1px solid rgb(230, 230, 230);"   ><div style="color: rgb(51, 51, 51); margin: 0px; line-height: 24px;"   >12.5　　15.3　　23.2　　26.4　　33.5　　34.4　　39.4　　45.2　　55.4　　60.9</div></td><td style="margin: 0px; padding: 2px 10px; line-height: 22px; height: 22px; border: 1px solid rgb(230, 230, 230);"   ><div style="color: rgb(51, 51, 51); margin: 0px; line-height: 24px;"   >21.2　　23.9　　32.9　　34.1　　42.5　　43.2　　49.0　　52.8　　59.4　　63.5</div></td><td style="margin: 0px; padding: 2px 10px; line-height: 22px; height: 22px; border: 1px solid rgb(230, 230, 230);"   ><div style="color: rgb(51, 51, 51); margin: 0px; line-height: 24px;"   >156.25　　234.09　　538.24　　696.96　　1122.25　　1183.36　　1552.36　　2043.04　　3069.16　　3708.81</div></td><td style="margin: 0px; padding: 2px 10px; line-height: 22px; height: 22px; border: 1px solid rgb(230, 230, 230);"   ><div style="color: rgb(51, 51, 51); margin: 0px; line-height: 24px;"   >449.44　　571.21　　1082.41　　1162.81　　1806.25　　1866.24　　2401.00　　2787.84　　3528.36　　4032.25</div></td><td style="margin: 0px; padding: 2px 10px; line-height: 22px; height: 22px; border: 1px solid rgb(230, 230, 230);"   ><div style="color: rgb(51, 51, 51); margin: 0px; line-height: 24px;"   >265.00　　365.67　　763.28　　900.24　　1423.75　　1486.08　　1930.60　　2386.56　　3290.76　　3867.15</div></td></tr><tr><td style="margin: 0px; padding: 2px 10px; line-height: 22px; height: 22px; border: 1px solid rgb(230, 230, 230);"   ><div style="color: rgb(51, 51, 51); margin: 0px; line-height: 24px;"   >合计</div></td><td style="margin: 0px; padding: 2px 10px; line-height: 22px; height: 22px; border: 1px solid rgb(230, 230, 230);"   ><div style="color: rgb(51, 51, 51); margin: 0px; line-height: 24px;"   >346.2</div></td><td style="margin: 0px; padding: 2px 10px; line-height: 22px; height: 22px; border: 1px solid rgb(230, 230, 230);"   ><div style="color: rgb(51, 51, 51); margin: 0px; line-height: 24px;"   >422.5</div></td><td style="margin: 0px; padding: 2px 10px; line-height: 22px; height: 22px; border: 1px solid rgb(230, 230, 230);"   ><div style="color: rgb(51, 51, 51); margin: 0px; line-height: 24px;"   >14304.52</div></td><td style="margin: 0px; padding: 2px 10px; line-height: 22px; height: 22px; border: 1px solid rgb(230, 230, 230);"   ><div style="color: rgb(51, 51, 51); margin: 0px; line-height: 24px;"   >19687.81</div></td><td style="margin: 0px; padding: 2px 10px; line-height: 22px; height: 22px; border: 1px solid rgb(230, 230, 230);"   ><div style="color: rgb(51, 51, 51); margin: 0px; line-height: 24px;"   >16679.09</div></td></tr></table><ul style="margin-top: 0px; margin-bottom: 14px; margin-left: 2em; list-style: none; font-family: arial, 宋体, sans-serif; font-size: 14px; line-height: 24px;"   ><li style="margin: 0px; padding: 0px 0px 0px 14px; list-style-type: none; background-repeat: no-repeat;"   ><div style="color: rgb(51, 51, 51); margin: 0px; line-height: 24px;"   >=0.9942</div></li></ul><div style="color: rgb(51, 51, 51); margin: 15px 0px 5px; text-indent: 2em; line-height: 24px; font-family: arial, 宋体, sans-serif; font-size: 14px;"   >相关系数为0.9942，说明广告投入费与月平均销售额之间有高度的线性正相关关系。</div></div><div>相关性越高, 说明广告投入和销售额的关系越明显.</div><div>相关性是如何计算的呢? 实际上是 "协方差(x,y)除以(平方根(方差(x)*方差(y)))" .&nbsp;</div><div><div><img title="Postgresql attr correlation for values(logical order)  ctid (physcial order) - 德哥@Digoal - PostgreSQL research"   alt="Postgresql attr correlation for values(logical order)  ctid (physcial order) - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/KrnexHxWvm3a86AuZN_nmg==/6630117787652273823.png"   ></div></div><div><br></div><div>在运维领域, 也可以做相对应的统计, 例如服务器的内存使用量, 负载, 进程数, 网络吞吐量, 用户请求量, 用户请求响应时间 等数据, 可以做相关性的统计, 观察他们之间的关系.</div><div>接下来进入正题, 看看PostgreSQL是如何计算列的逻辑和物理顺序相关性的</div><div>首选看一下pg_stats这个视图对应的correlation是怎么来的</div><div><pre><p></p><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \d+ pg_stats</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; CASE</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WHEN s.stakind1 = 3 THEN s.stanumbers1[1]</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WHEN s.stakind2 = 3 THEN s.stanumbers2[1]</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WHEN s.stakind3 = 3 THEN s.stanumbers3[1]</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WHEN s.stakind4 = 3 THEN s.stanumbers4[1]</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WHEN s.stakind5 = 3 THEN s.stanumbers5[1]</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ELSE NULL::real</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; END AS correlation,</font></div><div><font size="2"   >。。。</font></div><div><font size="2"   >   FROM pg_statistic s<br>     JOIN pg_class c ON c.oid = s.starelid<br>     JOIN pg_attribute a ON c.oid = a.attrelid AND a.attnum = s.staattnum<br>     LEFT JOIN pg_namespace n ON n.oid = c.relnamespace<br>  WHERE NOT a.attisdropped AND has_column_privilege(c.oid, a.attnum, 'select'::text);</font></div><p></p></pre></div><p></p></pre></div><div>其实是来自pg_statistic这个表, corr的统计是在analyze中完成的.</div><div>相关性计算的代码如下, 注意是采样统计 :&nbsp;</div><div><span style="line-height: 28px;"   >src/backend/commands/analyze.c</span></div><div><pre><p></p><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></span></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Now scan the values in order, find the most common on<wbr>es, and also</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* accumulate ordering-correlation statistics.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* To determine which are most common, we first have to count the</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* number of duplicates of each value. &nbsp;The duplicates are adjacent in</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* the sorted list, so a brute-force approach is to compare successive</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* datum values until we find two that are not equal. However, that</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* requires N-1 invocations of the datum comparison routine, which are</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* completely redundant with work that was done during the sort. &nbsp;(The</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* sort algorithm must at some point have compared each pair of items</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* that are adjacent in the sorted order; otherwise it could not know</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* that it's ordered the pair correctly.) We exploit this by having</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* compare_scalars remember the highest tupno index that each</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* ScalarItem has been found equal to. &nbsp;At the end of the sort, a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* ScalarItem's tupnoLink will still point to itself if and on<wbr>ly if it</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* is the last item of its group of duplicates (since the group will</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* be ordered by tupno).</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; corr_xysum = 0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ndistinct = 0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nmultiple = 0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dups_cnt = 0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for (i = 0; i &lt; values_cnt; i++)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; tupno = values[i].tupno;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; corr_xysum += ((double) i) * ((double) tupno);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dups_cnt++;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (tupnoLink[tupno] == tupno)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Reached end of duplicates of this value */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ndistinct++;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (dups_cnt &gt; 1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; nmultiple++;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (track_cnt &lt; num_mcv ||</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dups_cnt &gt; track[track_cnt - 1].count)</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Found a new item for the mcv list; find its</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* position, bubbling down old items if needed. Loop</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* invariant is that j points at an empty/ replaceable</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* slot.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; j;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (track_cnt &lt; num_mcv)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; track_cnt++;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for (j = track_cnt - 1; j &gt; 0; j--)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (dups_cnt &lt;= track[j - 1].count)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; track[j].count = track[j - 1].count;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; track[j].first = track[j - 1].first;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; track[j].count = dups_cnt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; track[j].first = i + 1 - dups_cnt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dups_cnt = 0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div></div><div><font size="2"   ><br></font></div><div><span style="line-height: 28px;"   ><font size="2"   >.........................</font></span></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Generate a correlation entry if there are multiple values */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (values_cnt &gt; 1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MemoryContext old_context;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; float4 &nbsp; &nbsp; *corrs;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; double &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;corr_xsum,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; corr_x2sum;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Must copy the target values into anl_context */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; old_context = MemoryContextSwitchTo(stats-&gt;anl_context);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; corrs = (float4 *) palloc(sizeof(float4));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MemoryContextSwitchTo(old_context);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*----------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Since we know the x and y value sets are both</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0, 1, ..., values_cnt-1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* we have sum(x) = sum(y) =</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(values_cnt-1)*values_cnt / 2</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* and sum(x^2) = sum(y^2) =</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(values_cnt-1)*values_cnt*(2*values_cnt-1) / 6.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*----------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; corr_xsum = ((double) (values_cnt - 1)) *</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ((double) values_cnt) / 2.0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; corr_x2sum = ((double) (values_cnt - 1)) *</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ((double) values_cnt) * (double) (2 * values_cnt - 1) / 6.0;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* And the correlation coefficient reduces to */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; corrs[0] = (values_cnt * corr_xysum - corr_xsum * corr_xsum) /</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (values_cnt * corr_x2sum - corr_xsum * corr_xsum);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stats-&gt;stakind[slot_idx] = STATISTIC_KIND_CORRELATION;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stats-&gt;staop[slot_idx] = mystats-&gt;ltopr;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stats-&gt;stanumbers[slot_idx] = corrs;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; stats-&gt;numnumbers[slot_idx] = 1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slot_idx++;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div></div><p></p></pre></div><p></p></pre></div><div>PostgreSQL 提供了相关性统计的函数, corr供用户使用.</div><div>参考</div><div><a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.4/static/functions-aggregate.html"   >http://www.postgresql.org/docs/9.4/static/functions-aggregate.html</a></div><div><span style="line-height: 28px;"   >corr代码如下 :&nbsp;</span></div><div><span style="line-height: 28px;"   >src/backend/utils/adt/float.c</span></div><div><pre><p></p><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >Datum</font></div><div><font size="2"   >float8_corr(PG_FUNCTION_ARGS)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ArrayType &nbsp;*transarray = PG_GETARG_ARRAYTYPE_P(0);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; float8 &nbsp; &nbsp; *transvalues;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; float8 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;N,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sumX,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sumX2,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sumY,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sumY2,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sumXY,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; numeratorX,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; numeratorY,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; numeratorXY;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; transvalues = check_float8_array(transarray, "float8_corr", 6);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; N = transvalues[0];</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; sumX = transvalues[1];</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; sumX2 = transvalues[2];</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; sumY = transvalues[3];</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; sumY2 = transvalues[4];</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; sumXY = transvalues[5];</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* if N is 0 we should return NULL */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (N &lt; 1.0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; numeratorX = N * sumX2 - sumX * sumX;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; CHECKFLOATVAL(numeratorX, isinf(sumX2) || isinf(sumX), true);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; numeratorY = N * sumY2 - sumY * sumY;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; CHECKFLOATVAL(numeratorY, isinf(sumY2) || isinf(sumY), true);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; numeratorXY = N * sumXY - sumX * sumY;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; CHECKFLOATVAL(numeratorXY, isinf(sumXY) || isinf(sumX) ||</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; isinf(sumY), true);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (numeratorX &lt;= 0 || numeratorY &lt;= 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_FLOAT8(numeratorXY / sqrt(numeratorX * numeratorY));</font></div></div><div><font size="2"   >}</font></div><p></p></pre></div><p></p></pre></div><div>我们可以用corr来验证PostgreSQL的采样统计, 但是注意, 要验证的话, 数据量小一点比较好, 这样的话PG会全量采样, 和corr得到的结果一致, 如果数据量太大, 得到的结果可能有少量偏差.</div><div><div><pre><p></p><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create table t(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# insert into t values (2),(5),(8),(3),(4),(6),(9),(7),(1);</font></div><div><font size="2"   >INSERT 0 9</font></div><p></p></pre></div><p></p></pre></div><div>行号, ID值如下</div><div><pre><p></p><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select ctid,* from t;</font></div><div><font size="2"   >&nbsp;ctid &nbsp;| id&nbsp;</font></div><div><font size="2"   >-------+----</font></div><div><font size="2"   >&nbsp;(0,1) | &nbsp;2</font></div><div><font size="2"   >&nbsp;(0,2) | &nbsp;5</font></div><div><font size="2"   >&nbsp;(0,3) | &nbsp;8</font></div><div><font size="2"   >&nbsp;(0,4) | &nbsp;3</font></div><div><font size="2"   >&nbsp;(0,5) | &nbsp;4</font></div><div><font size="2"   >&nbsp;(0,6) | &nbsp;6</font></div><div><font size="2"   >&nbsp;(0,7) | &nbsp;9</font></div><div><font size="2"   >&nbsp;(0,8) | &nbsp;7</font></div><div><font size="2"   >&nbsp;(0,9) | &nbsp;1</font></div><div><font size="2"   >(9 rows)</font></div><p></p></pre></div><p></p></pre></div></div><div>使用窗口函数进行输出</div><div><pre><p></p><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from (select row_number() over(order by ctid) as rn, * from t) as t(rn,id);</font></div><div><font size="2"   >&nbsp;rn | id&nbsp;</font></div><div><font size="2"   >----+----</font></div><div><font size="2"   >&nbsp; 1 | &nbsp;2</font></div><div><font size="2"   >&nbsp; 2 | &nbsp;5</font></div><div><font size="2"   >&nbsp; 3 | &nbsp;8</font></div><div><font size="2"   >&nbsp; 4 | &nbsp;3</font></div><div><font size="2"   >&nbsp; 5 | &nbsp;4</font></div><div><font size="2"   >&nbsp; 6 | &nbsp;6</font></div><div><font size="2"   >&nbsp; 7 | &nbsp;9</font></div><div><font size="2"   >&nbsp; 8 | &nbsp;7</font></div><div><font size="2"   >&nbsp; 9 | &nbsp;1</font></div><div><font size="2"   >(9 rows)</font></div><p></p></pre></div><p></p></pre></div><div>分析 :&nbsp;</div><div><pre><p></p><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# analyze t;</font></div><div><font size="2"   >ANALYZE</font></div><p></p></pre></div><p></p></pre></div><div>查询统计信息的<span style="line-height: 28px;"   >correlation &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span></div><div><pre><p></p><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from pg_stats where attname ='id' and tablename='t';</font></div><div><font size="2"   >-[ RECORD 1 ]----------+--------------------</font></div><div><font size="2"   >schemaname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | public</font></div><div><font size="2"   >tablename &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| t</font></div><div><font size="2"   >attname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| id</font></div><div><font size="2"   >inherited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f</font></div><div><font size="2"   >null_frac &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"   >avg_width &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 4</font></div><div><font size="2"   >n_distinct &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | -1</font></div><div><font size="2"   >most_common_vals &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >most_common_freqs &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >histogram_bounds &nbsp; &nbsp; &nbsp; | {1,2,3,4,5,6,7,8,9}</font></div><div><font size="2"   >correlation &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 0.116667</font></div><div><font size="2"   >most_common_elems &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >most_common_elem_freqs |&nbsp;</font></div><div><font size="2"   >elem_count_histogram &nbsp; |&nbsp;</font></div><p></p></pre></div><p></p></pre></div><div>结果和corr得到的结果一致</div><div><pre><p></p><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select corr(rn,id) from (select row_number() over(order by ctid) as rn, * from t) as t(rn,id);</font></div><div><font size="2"   >-[ RECORD 1 ]-----------</font></div><div><font size="2"   >corr | 0.116666666666667</font></div><p></p></pre></div><p></p></pre></div><div>如果随机插入大量数据, 因此采样的关系, 分析得到的相关性可能和实际的相关性有偏差</div><div><pre><p></p><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# insert into t select * from generate_series(1,100000) order by random();</font></div><div><font size="2"   >INSERT 0 100000</font></div><p></p></pre></div><p></p></pre></div><div>如下 :&nbsp;</div><div><pre><p></p><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# select ctid,* from t limit 100;</font></div><div><font size="2"   >&nbsp; ctid &nbsp; | &nbsp;id &nbsp;&nbsp;</font></div><div><font size="2"   >---------+-------</font></div><div><font size="2"   >&nbsp;(0,1) &nbsp; | &nbsp; &nbsp; 2</font></div><div><font size="2"   >&nbsp;(0,2) &nbsp; | &nbsp; &nbsp; 5</font></div><div><font size="2"   >&nbsp;(0,3) &nbsp; | &nbsp; &nbsp; 8</font></div><div><font size="2"   >&nbsp;(0,4) &nbsp; | &nbsp; &nbsp; 3</font></div><div><font size="2"   >&nbsp;(0,5) &nbsp; | &nbsp; &nbsp; 4</font></div><div><font size="2"   >&nbsp;(0,6) &nbsp; | &nbsp; &nbsp; 6</font></div><div><font size="2"   >&nbsp;(0,7) &nbsp; | &nbsp; &nbsp; 9</font></div><div><font size="2"   >&nbsp;(0,8) &nbsp; | &nbsp; &nbsp; 7</font></div><div><font size="2"   >&nbsp;(0,9) &nbsp; | &nbsp; &nbsp; 1</font></div><div><font size="2"   >&nbsp;(0,10) &nbsp;| &nbsp;4607</font></div><div><font size="2"   >&nbsp;(0,11) &nbsp;| 39521</font></div><div><font size="2"   >&nbsp;(0,12) &nbsp;| 92869</font></div><div><font size="2"   >&nbsp;(0,13) &nbsp;| 80094</font></div><div><font size="2"   >&nbsp;(0,14) &nbsp;| 13214</font></div><div><font size="2"   >&nbsp;(0,15) &nbsp;| 15509</font></div><div><font size="2"   >&nbsp;(0,16) &nbsp;| &nbsp;8380</font></div><div><font size="2"   >&nbsp;(0,17) &nbsp;| 22281</font></div><div><font size="2"   >&nbsp;(0,18) &nbsp;| 99252</font></div><div><font size="2"   >&nbsp;(0,19) &nbsp;| 60018</font></div><div><font size="2"   >&nbsp;(0,20) &nbsp;| 55716</font></div></div><div><font size="2"   >....</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres=# analyze t;</font></div><div><font size="2"   >ANALYZE</font></div><div><font size="2"   >postgres=# select correlation from pg_stats where attname ='id' and tablename='t';</font></div><div><font size="2"   >&nbsp;correlation &nbsp;</font></div><div><font size="2"   >--------------</font></div><div><font size="2"   >&nbsp;-0.000263469</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><p></p></pre></div><div>和实际相关性偏差较大</div><div><pre><p></p><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select corr(rn,id) from (select row_number() over(order by ctid) as rn, * from t) as t(rn,id);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; corr &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------------------</font></div><div><font size="2"   >&nbsp;0.00110293570728894</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><p></p></pre></div><div>修改id列的采样系数, 重新分析, 得到的相关性结果和实际的相关性基本一致.</div><div><pre><p></p><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# alter table t alter column id SET STATISTICS 10000;</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >postgres=# analyze t;</font></div><div><font size="2"   >ANALYZE</font></div><div><font size="2"   >postgres=# select correlation from pg_stats where attname ='id' and tablename='t';</font></div><div><font size="2"   >&nbsp;correlation&nbsp;</font></div><div><font size="2"   >-------------</font></div><div><font size="2"   >&nbsp; 0.00110296</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><p></p></pre></div><div><br></div><div>[参考]</div><div>1.&nbsp;<a target="_blank" rel="nofollow" href="http://zh.wikipedia.org/zh-cn/%E7%9B%B8%E5%85%B3"   >http://zh.wikipedia.org/zh-cn/%E7%9B%B8%E5%85%B3</a></div><div>2.&nbsp;<a target="_blank" rel="nofollow" href="http://baike.baidu.com/view/172091.htm"   >http://baike.baidu.com/view/172091.htm</a></div><div>3.&nbsp;<a target="_blank" rel="nofollow" href="http://en.wikipedia.org/wiki/Correlation_and_dependence"   >http://en.wikipedia.org/wiki/Correlation_and_dependence</a></div><div>4.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.4/static/functions-aggregate.html"   >http://www.postgresql.org/docs/9.4/static/functions-aggregate.html</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="Postgresql attr correlation for values(logical order)  ctid (physcial order) - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div></div>
	</div>
</div>
</body>
</html>