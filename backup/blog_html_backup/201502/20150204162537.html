<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">use python threading multi-thread test PostgreSQL & mongodb insert tps</h2>
	<h5 id="">2015-02-04 16:25:37&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020151435825593/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><span style="line-height: 28px;"   >前面两篇测试了一下python单线程压mongo和PostgreSQL的性能.</span></div><div><span style="line-height: 28px;"   >相比PostgreSQL的pgbench, python用到的这两个驱动未使用异步接口, 对性能影响极大.</span></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402015142858224/"   >http://blog.163.com/digoal@126/blog/static/1638770402015142858224/</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020151210840303/"   >http://blog.163.com/digoal@126/blog/static/16387704020151210840303/</a></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >本文使用threading这个模块, 测试一下多线程的性能.</span></div><div><span style="line-height: 28px;"   >PostgreSQL测试脚本, 使用8个线程 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >$ vi test.py</font></div><div><font size="2"   >import threading</font></div><div><font size="2"   >import time</font></div><div><font size="2"   >import postgresql</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >conn = { "user": "postgres",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"database": "postgres",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"unix": "/data01/pgdata/pg_root/.s.PGSQL.1921"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >db = postgresql.open(**conn)</font></div><div><font size="2"   >db.execute("drop table if exists tt")</font></div><div><font size="2"   >db.execute("create table tt(id int, username name, age int2, email text, qq text)")</font></div><div><font size="2"   >print(db.query("select count(1) as a from tt"))</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >class n_t(threading.Thread): &nbsp; #The timer class is derived from the class threading.Thread</font></div><div><font size="2"   >&nbsp; def __init__(self, num):</font></div><div><font size="2"   >&nbsp; &nbsp; threading.Thread.__init__(self)</font></div><div><font size="2"   >&nbsp; &nbsp; self.thread_num = num</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; def run(self): #Overwrite run() method, put what you want the thread do here</font></div><div><font size="2"   >&nbsp; &nbsp; conn = { "user": "postgres",&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"database": "postgres",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"unix": "/data01/pgdata/pg_root/.s.PGSQL.1921"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; db = postgresql.open(**conn)</font></div><div><font size="2"   >&nbsp; &nbsp; ins = db.prepare("insert into tt values($1,$2,$3,$4,$5)")</font></div><div><font size="2"   >&nbsp; &nbsp; start_t = time.time()</font></div><div><font size="2"   >&nbsp; &nbsp; print("TID:" + str(self.thread_num) + " " + str(start_t))</font></div><div><font size="2"   >&nbsp; &nbsp; for i in range(0,125000):</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; ins(1,'digoal.zhou',32,'digoal@126.com','276732431')</font></div><div><font size="2"   >&nbsp; &nbsp; stop_t = time.time()</font></div><div><font size="2"   >&nbsp; &nbsp; print("TID:" + str(self.thread_num) + " " + str(stop_t))</font></div><div><font size="2"   >&nbsp; &nbsp; print(stop_t-start_t)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >def test():</font></div><div><font size="2"   >&nbsp; t_names = dict()</font></div><div><font size="2"   >&nbsp; for i in range(0, 8):</font></div><div><font size="2"   >&nbsp; &nbsp; t_names[i] = n_t(i)&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; t_names[i].start()</font></div><div><font size="2"   >&nbsp; return</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >if __name__ == '__main__':</font></div><div><font size="2"   >&nbsp; test()</font></div><p></p></pre></div><div>测试结果 :&nbsp;</div><div><span style="line-height: 28px;"   >比单线程187秒还慢了几十秒.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@localhost-&gt; python test.py</font></div><div><font size="2"   >[(0,)]</font></div><div><font size="2"   >TID:0 1423065305.517401</font></div><div><font size="2"   >TID:3 1423065305.5209844</font></div><div><font size="2"   >TID:1 1423065305.52123</font></div><div><font size="2"   >TID:5 1423065305.5240796</font></div><div><font size="2"   >TID:4 1423065305.5249543</font></div><div><font size="2"   >TID:6 1423065305.5266497</font></div><div><font size="2"   >TID:2 1423065305.5301073</font></div><div><font size="2"   >TID:7 1423065305.533195</font></div><div><font size="2"   >TID:5 1423065526.6725013</font></div><div><font size="2"   >221.14842176437378</font></div><div><font size="2"   >TID:7 1423065528.599816</font></div><div><font size="2"   >223.06662106513977</font></div><div><font size="2"   >TID:6 1423065529.8911068</font></div><div><font size="2"   >224.36445713043213</font></div><div><font size="2"   >TID:2 1423065530.6830883</font></div><div><font size="2"   >225.15298104286194</font></div><div><font size="2"   >TID:4 1423065531.1566184</font></div><div><font size="2"   >225.63166403770447</font></div><div><font size="2"   >TID:1 1423065531.4046018</font></div><div><font size="2"   >225.88337182998657</font></div><div><font size="2"   >TID:3 1423065531.4168346</font></div><div><font size="2"   >225.8958501815796</font></div><div><font size="2"   >TID:0 1423065531.5486302</font></div><div><font size="2"   >226.03122925758362</font></div><p></p></pre></div><div><br></div><div>mongodb测试脚本, 同样使用8个线程 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># vi test.py</font></div><div><div><font size="2"   >import threading</font></div><div><font size="2"   >import time</font></div><div><font size="2"   >import pymongo</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >c=pymongo.MongoClient('/tmp/mongodb-5281.sock')</font></div><div><font size="2"   >db = c.test_database</font></div><div><font size="2"   >db.drop_collection('test_collection')</font></div><div><font size="2"   >collection = db.test_collection</font></div><div><font size="2"   >print(collection.count())</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >class n_t(threading.Thread): &nbsp; #The timer class is derived from the class threading.Thread</font></div><div><font size="2"   >&nbsp; def __init__(self, num):</font></div><div><font size="2"   >&nbsp; &nbsp; threading.Thread.__init__(self)</font></div><div><font size="2"   >&nbsp; &nbsp; self.thread_num = num</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; def run(self): #Overwrite run() method, put what you want the thread do here</font></div><div><font size="2"   >&nbsp; &nbsp; c=pymongo.MongoClient('/tmp/mongodb-5281.sock')</font></div><div><font size="2"   >&nbsp; &nbsp; db = c.test_database</font></div><div><font size="2"   >&nbsp; &nbsp; collection = db.test_collection</font></div><div><font size="2"   >&nbsp; &nbsp; start_t = time.time()</font></div><div><font size="2"   >&nbsp; &nbsp; print("TID:" + str(self.thread_num) + " " + str(start_t))</font></div><div><font size="2"   >&nbsp; &nbsp; for i in range(0,125000):</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; collection.insert({'id':1, 'username': 'digoal.zhou', 'age':32, 'email':'digoal@126.com', 'qq':'276732431'})</font></div><div><font size="2"   >&nbsp; &nbsp; stop_t = time.time()</font></div><div><font size="2"   >&nbsp; &nbsp; print("TID:" + str(self.thread_num) + " " + str(stop_t))</font></div><div><font size="2"   >&nbsp; &nbsp; print(stop_t-start_t)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >def test():</font></div><div><font size="2"   >&nbsp; t_names = dict()</font></div><div><font size="2"   >&nbsp; for i in range(0,8):</font></div><div><font size="2"   >&nbsp; &nbsp; t_names[i] = n_t(i)&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; t_names[i].start()</font></div><div><font size="2"   >&nbsp; return</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >if __name__ == '__main__':</font></div><div><font size="2"   >&nbsp; test()</font></div></div><p></p></pre></div><div>测试结果和单线程测试结果差不多 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost ~]# python test.py</font></div><div><font size="2"   >0</font></div><div><font size="2"   >TID:0 1423066038.8190722</font></div><div><font size="2"   >TID:1 1423066038.819762</font></div><div><font size="2"   >TID:2 1423066038.8214562</font></div><div><font size="2"   >TID:3 1423066038.8254952</font></div><div><font size="2"   >TID:4 1423066038.827397</font></div><div><font size="2"   >TID:5 1423066038.8303092</font></div><div><font size="2"   >TID:6 1423066038.8326738</font></div><div><font size="2"   >TID:7 1423066038.8461218</font></div><div><font size="2"   >TID:5 1423066400.8412485</font></div><div><font size="2"   >362.0109393596649</font></div><div><font size="2"   >TID:3 1423066402.4937685</font></div><div><font size="2"   >363.6682732105255</font></div><div><font size="2"   >TID:2 1423066402.8351183</font></div><div><font size="2"   >364.01366209983826</font></div><div><font size="2"   >TID:4 1423066402.9675741</font></div><div><font size="2"   >364.14017701148987</font></div><div><font size="2"   >TID:1 1423066403.0420506</font></div><div><font size="2"   >364.222288608551</font></div><div><font size="2"   >TID:0 1423066403.284279</font></div><div><font size="2"   >364.465206861496</font></div><div><font size="2"   >TID:6 1423066403.6458826</font></div><div><font size="2"   >364.81320881843567</font></div><div><font size="2"   >TID:7 1423066403.6860046</font></div><div><font size="2"   >364.839882850647</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># ./mongo 127.0.0.1:5281/test_database<br>MongoDB shell version: 3.0.0-rc7<br>connecting to: 127.0.0.1:5281/test_database</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&gt; db.test_collection.count()<br>1000000</font></div><p></p></pre></div><div><br></div><div>最后附上PostgreSQL pgbench使用8线程的测试结果 :&nbsp;</div><div>耗时仅16秒, 比使用python测试的性能高出不少. (跑了800W事务, 所以要处以8和前面的结果比)</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@localhost-&gt; vi test.sql</font></div><div><font size="2"   >insert into tt values (1,'digoal.zhou',32,'digoal@126.com','276732431');</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres@localhost-&gt; pgbench -M prepared -n -r -f ./test.sql -c 8 -j 4 -t 1000000<br>transaction type: Custom query<br>scaling factor: 1<br>query mode: prepared<br>number of clients: 8<br>number of threads: 4<br>number of transactions per client: 1000000<br>number of transactions actually processed: 8000000/8000000<br>tps = 64215.539716 (including connections establishing)<br>tps = 64219.452898 (excluding connections establishing)<br>statement latencies in milliseconds:<br>        0.118040        insert into tt values (1,'digoal.zhou',32,'digoal@126.com','276732431');</font></div><p></p></pre></div><div><br></div><div><br></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="use python threading multi-thread test PostgreSQL  mongodb insert tps - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>