<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">How to Point to a Item</h2>
	<h5 id="">2011-03-16 15:26:08&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201121624816721/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><br>  <div style="line-height: 120%; margin-top: 7.68pt; margin-bottom: 0pt; margin-left: 0.38in; text-indent: -0.38in; text-align: left; direction: ltr; unicode-bidi: embed; vertical-align: baseline;"  ><span style="font-size: 32pt;"  ><span style="color: rgb(255, 153, 0); font-family: Wingdings; font-size: 90%;"  ></span></span><font size="2"  ><span style="font-size: 32pt; font-family: &quot;Times New Roman&quot;; color: black;"  >ItemPointers</span><span style="font-size: 32pt; font-family: &quot;Times New Roman&quot;; color: black;"  > (index) -&gt; </span><span style="font-size: 32pt; font-family: &quot;Times New Roman&quot;; color: black;"  >指向<br>ItemId</span><span style="font-size: 32pt; font-family: &quot;Times New Roman&quot;; color: black;"  > (Array of (</span><span style="font-size: 32pt; font-family: &quot;Times New Roman&quot;; color: black;"  >lp_off:15bit</span><span style="font-size: 32pt; font-family: &quot;Times New Roman&quot;; color: black;"  >, </span><span style="font-size: 32pt; font-family: &quot;Times New Roman&quot;; color: black;"  >lp_flags:2bit,lp_len:15</span><span style="font-size: 32pt; font-family: &quot;Times New Roman&quot;; color: black;"  >) pairs pointing to the actual items. 4 bytes per item.) -&gt; 指向<br>Item (</span><span style="font-size: 32pt; font-family: &quot;Times New Roman&quot;; color: black;"  >tuple</span><span style="font-size: 32pt; font-family: &quot;Times New Roman&quot;; color: black;"  >)</span></font><span style="font-size: 32pt; font-family: &quot;Times New Roman&quot;; color: black;"  > </span></div>  <br><br>在PostgreSQL中 , 一个PAGE被pageinit之后的格式大概如下 : <br>&nbsp;* +----------------+---------------------------------+<br>&nbsp;* | PageHeaderData | linp1 linp2 linp3 ...&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; |<br>&nbsp;* +-----------+----+---------------------------------+<br>&nbsp;* | ... linpN |&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; |<br>&nbsp;* +-----------+--------------------------------------+<br>&nbsp;* |&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp; ^ pd_lower&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; |<br>&nbsp;* |&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; |<br>&nbsp;* |&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;v pd_upper&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; |<br>&nbsp;* +-------------+------------------------------------+<br>&nbsp;* |&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;| tupleN ...&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; |<br>&nbsp;* +-------------+------------------+-----------------+<br>&nbsp;* |&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; ... tuple3 tuple2 tuple1 | "special space" |<br>&nbsp;* +--------------------------------+-----------------+<br>&nbsp;*&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ^ pd_special<br>special space 是一个可选区域，如INDEX，可能会用到这个区域。对于HEAP TABLE来说这个区域不存在。<br>PageHeaderData占用24字节。<br>linpn是一个队列，包含ItemIdData，指向本PAGE内的tupleN（每个ItemIdData占用4字节,包含了len_offset,flag和tuple的length）。（空间从PAGE头部紧跟开始分配）<br>详细定义如下 : <br>typedef struct ItemIdData<br>{<br>&nbsp;&nbsp;&nbsp; unsigned&nbsp;&nbsp;&nbsp; lp_off:15,&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; /* offset to tuple (from start of page) */ # 之前我已经在另一篇博客提到最大的PAGESIZE=32K，因此这里的OFFSET15个比特位刚好够用.<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; lp_flags:2,&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; /* state of item pointer, see below */<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; lp_len:15;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; /* byte length of tuple */<br>} ItemIdData;<br>/*<br>&nbsp;* lp_flags has these possible states.&nbsp;&nbsp;&nbsp; An UNUSED line pointer is available<br>&nbsp;* for immediate re-use, the other states are not.<br>&nbsp;*/<br>#define LP_UNUSED&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; /* unused (should always have lp_len=0) */<br>#define LP_NORMAL&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 1&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; /* used (should always have lp_len&gt;0) */<br>#define LP_REDIRECT&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 2&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; /* HOT redirect (should have lp_len=0) */<br>#define LP_DEAD&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; 3&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; /* dead, may or may not have storage */<br>/*<br>&nbsp;* Item offsets and lengths are represented by these types when<br>&nbsp;* they're not actually stored in an ItemIdData.<br>&nbsp;*/<br>tupleN是真实的行记录数据，里面包含了行头部信息，可选的NULL BITMAP和OID信息以及列的值。（空间从PAGE的尾部或pd_special开始<br>反向分配）<br>从PAGE的结构可以看出定位到linpN就可以找到tuple了.<br>ItemPointers 由blockid和itemID组成。<br>ItemPointers point into this array rather than pointing directly to a tuple.<br>ItemPointers 指向ItemIdData的好处是不论TUPLE在PAGE里面怎么变化，只要ItemIdData的位置没有变化，索引的ItemPointer就不需要变化。<br>如下情况 : Because a tuple's ItemPointer points to its ItemId entry rather than its actual<br>byte-offset position, tuples can be physically shuffled on a page whenever the need arises.<br><br>下面来举例说明一下:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Table "digoal.tbl_user_info_single"<br>&nbsp; Column&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Type&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Modifiers <br>-----------+-----------------------+-----------<br>&nbsp;id&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | bigint&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | not null<br>&nbsp;firstname | character varying(32) | <br>&nbsp;lastname&nbsp; | character varying(32) | <br>&nbsp;corp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | character varying(64) | <br>&nbsp;age&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | integer&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | <br>insert into tbl_user_info_single select generate_series(1,10000000),'zhou','digoal','sky-mobi',27;<br>digoal=&gt; select max(ctid) from tbl_user_info_single;<br>&nbsp;&nbsp;&nbsp;&nbsp; ctid&nbsp;&nbsp;&nbsp;&nbsp; <br>--------------<br>&nbsp;(1066667,89)<br>从这里也可以预估出数据文件的大小(前提是这是一个新建的空表,因为多次DML和VACUUM后就不准确了)。<br>digoal=&gt; select * from pg_settings where name ~ 'block';<br>-[ RECORD 1 ]--------------------------------------------<br>name&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | block_size<br>setting&nbsp;&nbsp;&nbsp; | 8192<br>unit&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | <br>category&nbsp;&nbsp; | Preset Options<br>short_desc | Shows the size of a disk block.<br>extra_desc | <br>context&nbsp;&nbsp;&nbsp; | internal<br>vartype&nbsp;&nbsp;&nbsp; | integer<br>source&nbsp;&nbsp;&nbsp;&nbsp; | default<br>min_val&nbsp;&nbsp;&nbsp; | 8192<br>max_val&nbsp;&nbsp;&nbsp; | 8192<br>enumvals&nbsp;&nbsp; | <br>boot_val&nbsp;&nbsp; | 8192<br>reset_val&nbsp; | 8192<br>sourcefile | <br>sourceline | <br>从而计算出 这个表的SIZE=1066667*8K=8333MB<br>digoal=&gt; select pg_relation_filepath('tbl_user_info_single');<br>-[ RECORD 1 ]--------+-----------------------------------------------<br>pg_relation_filepath | pg_tblspc/16401/PG_9.0_201008051/16402/2062407<br><br>digoal=&gt; \q<br>postgres@db-172-16-3-33-&gt; ll $PGDATA/pg_tblspc/16401/PG_9.0_201008051/16402/2062407*<br>-rw------- 1 postgres postgres 8.0G Mar 16 14:45 /database/pgdata/tbs1/pg_root/pg_tblspc/16401/PG_9.0_201008051/16402/2062407<br>-rw------- 1 postgres postgres 142M Mar 16 14:45 /database/pgdata/tbs1/pg_root/pg_tblspc/16401/PG_9.0_201008051/16402/2062407.1<br>-rw------- 1 postgres postgres 2.1M Mar 16 14:15 /database/pgdata/tbs1/pg_root/pg_tblspc/16401/PG_9.0_201008051/16402/2062407_fsm<br><br>和前面的计算结果吻合。</div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">ss - 2014-03-21 10:42:04</h5>
				<div>goog<img src="http://b.bst.126.net/common/portrait/face/preview/face0.gif"  ></div>
			</div>
	</div>
</div>
</body>
</html>