<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL Streaming Replication COMMAND used in psql</h2>
	<h5 id="">2013-08-23 9:50:47&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201372391832582/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>CF里面在讨论是否要添加一个查看数据库system id的函数,&nbsp;pg_system_identifier();</div><div><a rel="nofollow" href="http://www.postgresql.org/message-id/flat/5215346B.7070800@dalibo.com#5215346B.7070800@dalibo.com"   >http://www.postgresql.org/message-id/flat/5215346B.7070800@dalibo.com#5215346B.7070800@dalibo.com</a></div><div>这个函数的用途和pg_controldata输出的Database system identifier值其实是一个效果.</div><div>只是它的目的是可以用SQL来得到这个值.</div><div>看到后面发现一个很有趣的东西,&nbsp;<span style="line-height: 22px;"   >Fujii Masao回复的如下 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >BTW, you can see the system identifier by executing IDENTIFY_SYSTEM</font></div><div><font size="2"   >command in replication connection as follows:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >1. Change the server settings so that the server can accept the</font></div><div><font size="2"   >&nbsp; &nbsp;replication connection</font></div><div><font size="2"   >2. Connect to the server in replication mode</font></div><div><font size="2"   >3. Execute IDENTIFY_SYSTEM command in replication connection</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >$ psql "replication=1"</font></div><div><font size="2"   >=# IDENTIFY_SYSTEM;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; systemid &nbsp; &nbsp; &nbsp; | timeline | &nbsp;xlogpos</font></div><div><font size="2"   >---------------------+----------+-----------</font></div><div><font size="2"   >&nbsp;5914930202950905854 | &nbsp; &nbsp; &nbsp; &nbsp;1 | 0/183F720</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >This is not good way for a user, though ;P</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&gt; I don't know if that's justification enough, which is</font></div><div><font size="2"   >&gt; why I didn't add it to the commitfest yet.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >You can add the patch to CF, and then hear the opinions from other people</font></div><div><font size="2"   >during CF.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Regards,</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >--&nbsp;</font></div><div><font size="2"   >Fujii Masao</font></div><p></p></pre></div><div>原来还可以这么玩, 于是乎找了一个测试库试一试.</div><div>172.16.3.33 主库 (host replication postgres 172.16.3.0/24 md5)</div><div>172.16.3.39 备库</div><div>在172.16.3.39上以standby角色去连接172.16.3.33的主库.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg94@db-172-16-3-39-&gt; psql "replication=1" -h 172.16.3.33 -U postgres</font></div><div><font size="2"   >Password for user postgres:&nbsp;</font></div><div><font size="2"   >psql (9.4devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=#&nbsp;</font></div></div><div><div><font size="2"   >digoal=# IDENTIFY_SYSTEM;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; systemid &nbsp; &nbsp; &nbsp; | timeline | &nbsp;xlogpos &nbsp;&nbsp;</font></div><div><font size="2"   >---------------------+----------+------------</font></div><div><font size="2"   >&nbsp;5912195073286594075 | &nbsp; &nbsp; &nbsp; &nbsp;1 | 6/80000668</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>得到的值和<span style="line-height: 22px;"   >pg_controldata一致.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg94@db-172-16-3-33-&gt; pg_controldata |grep identifier</font></div><div><font size="2"   >Database system identifier: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5912195073286594075</font></div><div><font size="2"   >Maximum length of identifiers: &nbsp; &nbsp; &nbsp; &nbsp;64</font></div><p></p></pre></div><div>除了使用<span style="line-height: 22px;"   >IDENTIFY_SYSTEM, replication protocol还支持其他的命令.</span></div><div><span style="line-height: 22px;"   >详见 :&nbsp;</span></div><div><a rel="nofollow" href="http://www.postgresql.org/docs/devel/static/protocol-replication.html"   >http://www.postgresql.org/docs/devel/static/protocol-replication.html</a></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >IDENTIFY_SYSTEM</font></div><div><font size="2"   >TIMELINE_HISTORY tli</font></div><div><font size="2"   >START_REPLICATION XXX/XXX TIMELINE tli</font></div><div><font size="2"   >BASE_BACKUP [LABEL 'label'] [PROGRESS] [FAST] [WAL] [NOWAIT]</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >包括pg_basebackup , 也是使用流复制协议进行数据复制的.</span></div><div>另外几个命令也可以在psql命令行中使用, 例如 :&nbsp;</div><div>在主节点pg_xlog中创建一个history文件.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-33 pg_basebackup]# su - pg94</font></div><div><font size="2"   >pg94@db-172-16-3-33-&gt; cd $PGDATA</font></div><div><font size="2"   >pg94@db-172-16-3-33-&gt; vi pg_xlog/00000002.history&nbsp;</font></div></div><div><div><font size="2"   >test line 1</font></div><div><font size="2"   >test line 2</font></div></div><div><font size="2"   >使用流复制命令接收history文件内容.</font></div><div><div><font size="2"   >digoal=# TIMELINE_HISTORY 2;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;filename &nbsp; &nbsp; | &nbsp; content &nbsp;&nbsp;</font></div><div><font size="2"   >------------------+-------------</font></div><div><font size="2"   >&nbsp;00000002.history | test line 1+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | test line 2+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>其他命令 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from pg_current_xlog_location();</font></div><div><font size="2"   >&nbsp;pg_current_xlog_location&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;6/800007A8</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# START_REPLICATION 6/80000700 TIMELINE 1;<br>unexpected PQresultStatus: 8</font></div><div><font size="2"   >digoal=# START_REPLICATION 6/80000700 TIMELINE 1;</font></div><div><font size="2"   >PQexec not allowed during COPY BOTH</font></div><p></p></pre></div><div>BASE_BACKUP 是做基础备份的, 数据比较庞大.</div><div><br></div>[参考]<wbr><div>1.&nbsp;src/backend/replication/repl_gram.y</div><div>2.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/protocol-replication.html"   >http://www.postgresql.org/docs/devel/static/protocol-replication.html</a></div><div>3.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/message-id/flat/5215346B.7070800@dalibo.com#5215346B.7070800@dalibo.com"   >http://www.postgresql.org/message-id/flat/5215346B.7070800@dalibo.com#5215346B.7070800@dalibo.com</a></div><div>4.&nbsp;src/interfaces/libpq/libpq-int.h</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* PGconn stores all the state data associated with a single connection</font></div><div><font size="2"   >&nbsp;* to a backend.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >struct pg_conn</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Saved values of connection options */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *pghost; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* the machine on which the server is running */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *pghostaddr; &nbsp; &nbsp; &nbsp; &nbsp; /* the numeric IP address of the machine on</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* which the server is running. &nbsp;Takes</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* precedence over above. */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *pgport; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* the server's communication port */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *pgunixsocket; &nbsp; &nbsp; &nbsp; /* the Unix-domain socket that the server is</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* listening on; if NULL, uses a default</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* constructed from pgport */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *pgtty; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* tty on which the backend messages is</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* displayed (OBSOLETE, NOT USED) */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *connect_timeout; &nbsp; &nbsp;/* connection timeout (numeric string) */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *client_encoding_initial; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* encoding to use */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *pgoptions; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* options to start the backend with */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *appname; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* application name */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *fbappname; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* fallback application name */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *dbName; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* database name */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *replication; &nbsp; &nbsp; &nbsp; &nbsp;/* connect as the replication standby? */</font></div></div><div><font size="2"   >replication指定是否以standby连接到主库.</font></div><div><font size="2"   >... 其他略.</font></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>