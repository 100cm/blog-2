<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL How can i decode the NUMERIC precision and scale in pg_attribute.atttypmod</h2>
	<h5 id="">2013-08-17 7:56:01&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201371763839672/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>早上给一个系统扩numeric长度,&nbsp;</div><div>扩字段SQL,&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >alter table test alter column col type numeric(10,0);</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >因为有众多子表, 在主表上操作完后准备检查一下所有的子表是否都自动扩展了长度.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select attrelid::regclass,atttypmod from pg_attribute&nbsp;</font></div><div><font size="2"   >where attrelid in (select oid from pg_class where relname ~ '^test')&nbsp;</font></div><div><font size="2"   >and attname='col';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; attrelid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| atttypmod&nbsp;</font></div><div><font size="2"   >----------------------------+-----------</font></div><div><font size="2"   >&nbsp;test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;655364</font></div><div><font size="2"   >&nbsp;test_20120210 | &nbsp; &nbsp;655364</font></div><p></p></pre></div><div>这里的atttypmod看起来和其他类型的不太一样, 定长类型的话这里直接就是字段字节数, 如果是变长类型, 那么是头+实际占用字节数.</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201351743331312/"   >http://blog.163.com/digoal@126/blog/static/163877040201351743331312/</a></div><div>对于numeric的精度计算和小数位计算, 通过atttypmod如何得到呢?</div><div>可以通过以下函数 :&nbsp;</div><div>information_schema._pg_numeric_precision</div><div>information_schema._pg_numeric_scale</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select information_schema._pg_numeric_scale(1700,655364);</font></div><div><font size="2"   >&nbsp;_pg_numeric_scale&nbsp;</font></div><div><font size="2"   >-------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=&gt; select information_schema._pg_numeric_precision(1700,655364);</font></div><div><font size="2"   >&nbsp;_pg_numeric_precision&nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 10</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>函数定义中用到的21, 23,20 ,1700等是数据类型的oid. pg_type.oid.</div><div>例如1700</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select typname from pg_type where oid=1700;</font></div><div><font size="2"   >&nbsp;typname&nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;numeric</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >具体的计算方法通过源码中numeric类型定义也能看出.</span></div><div>参见本文末尾.</div><div>也可以用这个函数</div><div>src/backend/utils/adt/format_type.c</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* SQL function: format_type(type_oid, typemod)</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* `type_oid' is from pg_type.oid, `typemod' is from</font></div><div><font size="2"   >&nbsp;* pg_attribute.atttypmod. This function will get the type name and</font></div><div><font size="2"   >&nbsp;* format it and the modifier to canonical SQL format, if the type is</font></div><div><font size="2"   >&nbsp;* a standard type. Otherwise you just get pg_type.typname back,</font></div><div><font size="2"   >&nbsp;* double quoted if it contains funny characters or matches a keyword.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* If typemod is NULL then we are formatting a type name in a context where</font></div><div><font size="2"   >&nbsp;* no typemod is available, eg a function argument or result type. &nbsp;This</font></div><div><font size="2"   >&nbsp;* yields a slightly different result from specifying typemod = -1 in some</font></div><div><font size="2"   >&nbsp;* cases. &nbsp;Given typemod = -1 we feel compelled to produce an output that</font></div><div><font size="2"   >&nbsp;* the parser will interpret as having typemod -1, so that pg_dump will</font></div><div><font size="2"   >&nbsp;* produce CREATE TABLE commands that recreate the original state. &nbsp;But</font></div><div><font size="2"   >&nbsp;* given NULL typemod, we assume that the parser's interpretation of</font></div><div><font size="2"   >&nbsp;* typemod doesn't matter, and so we are willing to output a slightly</font></div><div><font size="2"   >&nbsp;* "prettier" representation of the same type. &nbsp;For example, type = bpchar</font></div><div><font size="2"   >&nbsp;* and typemod = NULL gets you "character", whereas typemod = -1 gets you</font></div><div><font size="2"   >&nbsp;* "bpchar" --- the former will be interpreted as character(1) by the</font></div><div><font size="2"   >&nbsp;* parser, which does not yield typemod -1.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* XXX encoding a meaning in typemod = NULL is ugly; it'd have been</font></div><div><font size="2"   >&nbsp;* cleaner to make two functions of one and two arguments respectively.</font></div><div><font size="2"   >&nbsp;* Not worth changing it now, however.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >Datum</font></div><div><font size="2"   >format_type(PG_FUNCTION_ARGS)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; type_oid;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; typemod;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *result;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Since this function is not strict, we must test for null args */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (PG_ARGISNULL(0))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();</font></div></div><div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; type_oid = PG_GETARG_OID(0);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (PG_ARGISNULL(1))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result = format_type_internal(type_oid, -1, false, true, false);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; typemod = PG_GETARG_INT32(1);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result = format_type_internal(type_oid, typemod, true, true, false);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_TEXT_P(cstring_to_text(result));</font></div><div><font size="2"   >}</font></div></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/1638770402013424113324797/"   >http://blog.163.com/digoal@126/blog/static/1638770402013424113324797/</a></div><div>2.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201351743331312/"   >http://blog.163.com/digoal@126/blog/static/163877040201351743331312/</a></div><div>3.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://stackoverflow.com/questions/3350148/where-are-numeric-precision-and-scale-for-a-field-found-in-the-pg-catalog-tables"   >http://stackoverflow.com/questions/3350148/where-are-numeric-precision-and-scale-for-a-field-found-in-the-pg-catalog-tables</a></div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >SELECT</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; CASE atttypid</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;WHEN 21 /*int2*/ THEN 16</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;WHEN 23 /*int4*/ THEN 32</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;WHEN 20 /*int8*/ THEN 64</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;WHEN 1700 /*numeric*/ THEN</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CASE WHEN atttypmod = -1</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;THEN null</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ELSE ((atttypmod - 4) &gt;&gt; 16) &amp; 65535 &nbsp; &nbsp; -- calculate the precision</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;END</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;WHEN 700 /*float4*/ THEN 24 /*FLT_MANT_DIG*/</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;WHEN 701 /*float8*/ THEN 53 /*DBL_MANT_DIG*/</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ELSE null</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; END &nbsp; AS numeric_precision,</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; CASE&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; WHEN atttypid IN (21, 23, 20) THEN 0</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; WHEN atttypid IN (1700) THEN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; CASE&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WHEN atttypmod = -1 THEN null &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ELSE (atttypmod - 4) &amp; 65535 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-- calculate the scale &nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; END</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;ELSE null</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; END AS numeric_scale,</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; *</font></div><div style="line-height: 22px;"   ><font size="2"   >FROM&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; pg_attribute ;</font></div><p></p></pre></div></div><div>4.&nbsp;src/backend/utils/adt/numeric.c</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >/*</font></span></div><div><div><font size="2"   >&nbsp;* numeric() -</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;This is a special function called by the Postgres database system</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;before a value is stored in a tuple's attribute. The precision and</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;scale of the attribute have to be applied on the value.</font></div><div><font size="2"   >&nbsp;*/</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Get the precision and scale out of the typmod value</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; tmp_typmod = typmod - VARHDRSZ;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; precision = (tmp_typmod &gt;&gt; 16) &amp; 0xffff;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; scale = tmp_typmod &amp; 0xffff;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; maxdigits = precision - scale;</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"   >5.&nbsp;src/include/c.h</span></div><pre class="prettyprint"   ><p></p><div><font size="2"   >#define VARHDRSZ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;((int32) sizeof(int32))</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >6.&nbsp;src/backend/catalog/information_schema.sql</span></div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >information_schema._pg_numeric_precision</font></div><div style="line-height: 22px;"   ><font size="2"   >information_schema._pg_numeric_scale</font></div><p></p></pre></div></div><div style="line-height: 22px;"   >精度</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE FUNCTION _pg_numeric_precision(typid oid, typmod int4) RETURNS integer</font></div><div><font size="2"   >&nbsp; &nbsp; LANGUAGE sql</font></div><div><font size="2"   >&nbsp; &nbsp; IMMUTABLE</font></div><div><font size="2"   >&nbsp; &nbsp; RETURNS NULL ON NULL INPUT</font></div><div><font size="2"   >&nbsp; &nbsp; AS</font></div><div><font size="2"   >$$SELECT</font></div><div><font size="2"   >&nbsp; CASE $1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;WHEN 21 /*int2*/ THEN 16</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;WHEN 23 /*int4*/ THEN 32</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;WHEN 20 /*int8*/ THEN 64</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;WHEN 1700 /*numeric*/ THEN</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CASE WHEN $2 = -1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;THEN null</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ELSE (($2 - 4) &gt;&gt; 16) &amp; 65535</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;END</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;WHEN 700 /*float4*/ THEN 24 /*FLT_MANT_DIG*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;WHEN 701 /*float8*/ THEN 53 /*DBL_MANT_DIG*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ELSE null</font></div><div><font size="2"   >&nbsp; END$$;</font></div><p></p></pre></div><div>小数位</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE FUNCTION _pg_numeric_scale(typid oid, typmod int4) RETURNS integer</font></div><div><font size="2"   >&nbsp; &nbsp; LANGUAGE sql</font></div><div><font size="2"   >&nbsp; &nbsp; IMMUTABLE</font></div><div><font size="2"   >&nbsp; &nbsp; RETURNS NULL ON NULL INPUT</font></div><div><font size="2"   >&nbsp; &nbsp; AS</font></div><div><font size="2"   >$$SELECT</font></div><div><font size="2"   >&nbsp; CASE WHEN $1 IN (21, 23, 20) THEN 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;WHEN $1 IN (1700) THEN</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CASE WHEN $2 = -1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;THEN null</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ELSE ($2 - 4) &amp; 65535</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;END</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;ELSE null</font></div><div><font size="2"   >&nbsp; END$$;</font></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>