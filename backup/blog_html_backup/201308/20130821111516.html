<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">modify citusdb's mongo_fdw extension delete the ismaster and collection count command</h2>
	<h5 id="">2013-08-21 11:15:16&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020137211111138/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>上一篇blog &lt;citusdb's mongo_fdw one query do what?&nbsp;&gt; 叙述了mongo_fdw在执行一次SQL查询时在mongodb中都执行了些啥?</div><div>一次mongo_fdw外部表查询, 在mongodb中一共需要建立和断开3次连接, 同时调用了3次ismaster的命令以及2次被查表的count计数查询. 最后才是真正和SQL有关的查询(db.mongo_test.find{id: 1}).</div><div>详见 :&nbsp;</div><div><a href="http://blog.163.com/digoal@126/blog/static/1638770402013721103316334/"   >http://blog.163.com/digoal@126/blog/static/1638770402013721103316334/</a></div><div>本文将对mongo_fdw进行修改, 去除不必要的查询, 例如ismaster去除方法如下 :&nbsp;</div><div>vi mongo-c-driver-v0.8/src/mongo.c</div><div><pre class="prettyprint"   ><div><font size="2"   >MONGO_EXPORT int mongo_client( mongo *conn , const char *host, int port ) {</font></div><div><font size="2"   >&nbsp; &nbsp; mongo_init( conn );</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; conn-&gt;primary = (mongo_host_port*)bson_malloc( sizeof( mongo_host_port ) );</font></div><div><font size="2"   >&nbsp; &nbsp; snprintf( conn-&gt;primary-&gt;host, MAXHOSTNAMELEN, "%s", host);</font></div><div><font size="2"   >&nbsp; &nbsp; conn-&gt;primary-&gt;port = port;</font></div><div><font size="2"   >&nbsp; &nbsp; conn-&gt;primary-&gt;next = NULL;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; if( mongo_env_socket_connect( conn, host, port ) != MONGO_OK )</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return MONGO_ERROR;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; return MONGO_OK;</font></div><div><font size="2"   >&nbsp; &nbsp; //return mongo_check_is_master( conn );</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >重新编译mongo_fdw, 重启数据库.</span></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from f_mongo_test where id=1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;_id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >--------------------------+----+----------------------------------+---------------------</font></div><div><font size="2"   >&nbsp;5213373b09405fb9802e3d91 | &nbsp;1 | 47e77a34c50df1a84b2e08c17c3d2942 | 2013-08-20 14:03:17</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>查看mongodb日志输出, ismaster的command已经没有了 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Wed Aug 21 10:51:00.224 [initandlisten] connection accepted from anonymous unix socket #1 (1 connection now open)</font></div><div><font size="2"   >Wed Aug 21 10:51:00.224 [conn1] run command test.$cmd { count: "mongo_test" }</font></div><div><font size="2"   >Wed Aug 21 10:51:00.224 [conn1] opening db: &nbsp;test</font></div><div><font size="2"   >Wed Aug 21 10:51:00.241 [conn1] command test.$cmd command: { count: "mongo_test" } ntoreturn:1 keyUpdates:0 locks(micros) W:17329 r:33 reslen:48 17ms</font></div><div><font size="2"   >Wed Aug 21 10:51:00.242 [initandlisten] connection accepted from anonymous unix socket #2 (2 connections now open)</font></div><div><font size="2"   >Wed Aug 21 10:51:00.242 [conn2] run command test.$cmd { count: "mongo_test" }</font></div><div><font size="2"   >Wed Aug 21 10:51:00.242 [conn2] command test.$cmd command: { count: "mongo_test" } ntoreturn:1 keyUpdates:0 locks(micros) r:19 reslen:48 0ms</font></div><div><font size="2"   >Wed Aug 21 10:51:00.242 [conn1] end connection anonymous unix socket (1 connection now open)</font></div><div><font size="2"   >Wed Aug 21 10:51:00.242 [conn2] end connection anonymous unix socket (0 connections now open)</font></div><div><font size="2"   >Wed Aug 21 10:51:00.242 [initandlisten] connection accepted from anonymous unix socket #3 (1 connection now open)</font></div><div><font size="2"   >Wed Aug 21 10:51:00.243 [conn3] query test.mongo_test query: { id: 1 } ntoreturn:0 ntoskip:0 nscanned:1 keyUpdates:0 locks(micros) r:269 nreturned:1 reslen:111 0ms</font></div><div><font size="2"   >Wed Aug 21 10:51:00.243 [conn3] end connection anonymous unix socket (0 connections now open)</font></div><p></p></pre></div><div><br></div><div>但是collection的count查询还在, 接下来就是去掉这个count查询 :&nbsp;</div><div>vi mongo_fdw.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >所有涉及ForeignTableDocumentCount计算的都改成如下 :&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; documentCount = 5000000;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; //documentCount = ForeignTableDocumentCount(foreignTableId);</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >重新编译mongo_fdw, 重启数据库.</span></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from f_mongo_test where id=1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;_id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >--------------------------+----+----------------------------------+---------------------</font></div><div><font size="2"   >&nbsp;5213373b09405fb9802e3d91 | &nbsp;1 | 47e77a34c50df1a84b2e08c17c3d2942 | 2013-08-20 14:03:17</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>现在很干净了, 只有真实的query :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Wed Aug 21 10:59:30.793 [initandlisten] connection accepted from anonymous unix socket #5 (1 connection now open)</font></div><div><font size="2"   >Wed Aug 21 10:59:30.794 [conn5] query test.mongo_test query: { id: 1 } ntoreturn:0 ntoskip:0 nscanned:1 keyUpdates:0 locks(micros) r:48 nreturned:1 reslen:111 0ms</font></div><div><font size="2"   >Wed Aug 21 10:59:30.794 [conn5] end connection anonymous unix socket (0 connections now open)</font></div><p></p></pre></div><div>接下来使用同一个pgbench, 压一下, 结果得到了几倍的性能提升 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg94@db-172-16-3-33-&gt; pgbench -M simple -n -r -f ./test.sql -h 127.0.0.1 -p 1919 -U postgres -c 24 -j 12 -T 60 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: simple</font></div><div><font size="2"   >number of clients: 24</font></div><div><font size="2"   >number of threads: 12</font></div><div><font size="2"   >duration: 60 s</font></div><div><font size="2"   >number of transactions actually processed: 509537</font></div><div><font size="2"   >tps = 8491.139011 (including connections establishing)</font></div><div><font size="2"   >tps = 8494.350858 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.002101 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 5000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 2.821037 &nbsp; &nbsp; &nbsp; &nbsp;select 1 from f_mongo_test where id=:id;</font></div><p></p></pre></div><div>利用率</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Cpu(s): 19.9%us, &nbsp;7.0%sy, &nbsp;0.0%ni, 64.0%id, &nbsp;0.0%wa, &nbsp;0.4%hi, &nbsp;8.7%si, &nbsp;0.0%st</font></div><div><font size="2"   >&nbsp; PID USER &nbsp; &nbsp; &nbsp;PR &nbsp;NI &nbsp;VIRT &nbsp;RES &nbsp;SHR S %CPU %MEM &nbsp; &nbsp;TIME+ &nbsp;COMMAND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >12660 mongo &nbsp; &nbsp; 25 &nbsp; 0 3263m 839m 808m R 247.4 10.5 &nbsp;11:02.88 mongod -f ./mongod.conf&nbsp;</font></div><p></p></pre></div><div><pre class="prettyprint"   ><div><font size="2"   >&gt; db.serverStatus().opcounters</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "insert" : 1,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query" : 1474344,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "update" : 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "delete" : 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "getmore" : 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "command" : 2244147</font></div><div><font size="2"   >}</font></div><div><font size="2"   >修改mongo_fdw后, command没有增加了.</font></div><div><font size="2"   >&gt; db.serverStatus().opcounters</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "insert" : 1,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "query" : 1983883,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "update" : 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "delete" : 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "getmore" : 0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "command" : 2244149</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div>从cpu利用率和tps计算mongodb在CPU使用率100%时的理想性能如下 :&nbsp;</div><div><div>digoal=# select 8491/0.199;</div><div>&nbsp; &nbsp; &nbsp; ?column? &nbsp; &nbsp; &nbsp;</div><div>--------------------</div><div>&nbsp;42668.341708542714</div><div>(1 row)</div></div><div>这个结果是可以参考的. 在不使用连接池的情况下mongodb可以提供的按照pk进行查询能力约为<span style="line-height: 22px;"   >42668每秒</span><span style="line-height: 22px;"   >.</span></div><div>在没有连接池的情况下能提供如此强大的qps, 得益于线程处理. 换成pg不使用连接池的话会很惨烈.</div><div>同一的环境下, PostgreSQL使用连接池大概108939每秒.</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201372011056128/"   >http://blog.163.com/digoal@126/blog/static/163877040201372011056128/</a></div><div><span style="line-height: 22px;"   >换成pg不使用连接池的话, tps只有500多 : 遇到这样的短连接, 对于pg来说, 必须使用连接池, 例如pgbouncer. 可以有效的解决进程创建的问题.</span></div><div><span style="line-height: 22px;"   ><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-33-&gt; pgbench -M simple -C -n -r -f ./test.sql -c 32 -j 32 -T 10 postgres</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: simple</font></div><div><font size="2"   >number of clients: 32</font></div><div><font size="2"   >number of threads: 32</font></div><div><font size="2"   >duration: 10 s</font></div><div><font size="2"   >number of transactions actually processed: 5631</font></div><div><font size="2"   >tps = 560.028412 (including connections establishing)</font></div><div><font size="2"   >tps = 21743.965148 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.004776 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 5000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.292578 &nbsp; &nbsp; &nbsp; &nbsp;select * from mongo_test where id=:id;</font></div><p></p></pre></div><div>大部分开销在进程创建上.</div></span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[mongo@db-172-16-3-33 etc]$ sar -c 1 100000</font></div><div><font size="2"   >Linux 2.6.18-274.el5 (db-172-16-3-33.sky-mobi.com) &nbsp; &nbsp; &nbsp;08/21/2013</font></div><div><font size="2"   >02:14:29 PM &nbsp; &nbsp;proc/s</font></div><div><font size="2"   >02:14:30 PM &nbsp; &nbsp;583.00</font></div><div><font size="2"   >02:14:31 PM &nbsp; &nbsp;578.79</font></div><p></p></pre></div><div><br></div><div><span style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; line-height: 25px;"   >[参考]</span><wbr style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >1.&nbsp;<a style="line-height: 22px; text-decoration: none; color: rgb(85, 108, 136);" href="http://blog.163.com/digoal@126/blog/static/163877040201372011056128/"   >http://blog.163.com/digoal@126/blog/static/163877040201372011056128/</a></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >2.&nbsp;<a style="line-height: 22px; text-decoration: none; color: rgb(85, 108, 136);" href="http://blog.163.com/digoal@126/blog/static/16387704020137218443650/"   >http://blog.163.com/digoal@126/blog/static/16387704020137218443650/</a></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >3.&nbsp;<a style="line-height: 22px; text-decoration: none; color: rgb(85, 108, 136);" href="http://blog.163.com/digoal@126/blog/static/16387704020137204136657/"   >http://blog.163.com/digoal@126/blog/static/16387704020137204136657/</a></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >4.&nbsp;<a style="line-height: 22px; text-decoration: none; color: rgb(85, 108, 136);" href="http://blog.163.com/digoal@126/blog/static/163877040201321984940903/"   >http://blog.163.com/digoal@126/blog/static/163877040201321984940903/</a></div></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >5.&nbsp;<a style="font-family: Arial, Helvetica, sans-serif; line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/1638770402013721103316334/"   >http://blog.163.com/digoal@126/blog/static/1638770402013721103316334/</a></div><wbr></div>
	</div>
</div>
</body>
</html>