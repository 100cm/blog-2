<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL pending patch: window funciton lag & lead support SQL standard { RESPECT | IGNORE } NULLS</h2>
	<h5 id="">2013-08-23 8:05:53&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201372374341993/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>在SQL标准中, lag和lead窗口函数是支持保留或忽略空值的. 例如 :&nbsp;<span style="line-height: 22px;"   >在Oracle 11g中, 语法如下.</span></div><div><pre style="line-height: normal;"   ><pre class="prettyprint"   ><p></p><div><pre style="line-height: normal;"   ><font size="2"   ><b>LAG</b>
  { ( value_expr [, offset [, default]]) [ { <b>RESPECT</b> | <b>IGNORE</b> } <b>NULLS</b> ] 
  | ( value_expr [ { <b>RESPECT</b> | <b>IGNORE</b> } <b>NULLS</b> ] [, offset [, default]] )
  }
  <b>OVER</b> ([ query_partition_clause ] order_by_clause)</font></pre></div><div><font size="2"   ><span style="font-family: Tahoma, sans-serif; line-height: normal;"   >{</span><code style="line-height: normal;"   >RESPECT</code><span style="font-family: Tahoma, sans-serif; line-height: normal;"   >&nbsp;|&nbsp;</span><code style="line-height: normal;"   >IGNORE</code><span style="font-family: Tahoma, sans-serif; line-height: normal;"   >}&nbsp;</span><code style="line-height: normal;"   >NULLS</code><span style="font-family: Tahoma, sans-serif; line-height: normal;"   >&nbsp;determines whether null values of&nbsp;</span><code style="line-height: normal;"   ><span style="font-style: italic;"   >value_expr</span></code><span style="font-family: Tahoma, sans-serif; line-height: normal;"   >&nbsp;are included in or eliminated from the calculation. The default is&nbsp;</span><code style="line-height: normal;"   >RESPECT</code><span style="font-family: Tahoma, sans-serif; line-height: normal;"   >&nbsp;</span><code style="line-height: normal;"   >NULLS</code><span style="font-family: Tahoma, sans-serif; line-height: normal;"   >.</span></font></div><p></p></pre></pre></div><div>目前PostgreSQL不支持IGNORE nulls, 参见.</div><div><a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/functions-window.html"   >http://www.postgresql.org/docs/devel/static/functions-window.html</a></div><div><b style="font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: 18.2399997711182px; background-color: rgb(238, 238, 221);"   >Note:</b><span style="font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: 18.2399997711182px; background-color: rgb(238, 238, 221);"   >&nbsp;The SQL standard defines a&nbsp;</span><tt style="line-height: 18.2399997711182px; background-color: rgb(238, 238, 221);"   >RESPECT NULLS</tt><span style="font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: 18.2399997711182px; background-color: rgb(238, 238, 221);"   >&nbsp;or&nbsp;</span><tt style="line-height: 18.2399997711182px; background-color: rgb(238, 238, 221);"   >IGNORE NULLS</tt><span style="font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: 18.2399997711182px; background-color: rgb(238, 238, 221);"   >&nbsp;option for&nbsp;</span><code style="margin-left: 0px; margin-right: 0px; -webkit-box-shadow: none; box-shadow: none; line-height: 18.2399997711182px; background-color: rgb(238, 238, 221);"   >lead</code><span style="font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: 18.2399997711182px; background-color: rgb(238, 238, 221);"   >,&nbsp;</span><code style="margin-left: 0px; margin-right: 0px; -webkit-box-shadow: none; box-shadow: none; line-height: 18.2399997711182px; background-color: rgb(238, 238, 221);"   >lag</code><span style="font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: 18.2399997711182px; background-color: rgb(238, 238, 221);"   >,</span><code style="margin-left: 0px; margin-right: 0px; -webkit-box-shadow: none; box-shadow: none; line-height: 18.2399997711182px; background-color: rgb(238, 238, 221);"   >first_value</code><span style="font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: 18.2399997711182px; background-color: rgb(238, 238, 221);"   >,&nbsp;</span><code style="margin-left: 0px; margin-right: 0px; -webkit-box-shadow: none; box-shadow: none; line-height: 18.2399997711182px; background-color: rgb(238, 238, 221);"   >last_value</code><span style="font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: 18.2399997711182px; background-color: rgb(238, 238, 221);"   >, and&nbsp;</span><code style="margin-left: 0px; margin-right: 0px; -webkit-box-shadow: none; box-shadow: none; line-height: 18.2399997711182px; background-color: rgb(238, 238, 221);"   >nth_value</code><span style="font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: 18.2399997711182px; background-color: rgb(238, 238, 221);"   >. This is not implemented in&nbsp;</span><span style="font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: 18.2399997711182px; background-color: rgb(238, 238, 221);"   >PostgreSQL</span><span style="font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: 18.2399997711182px; background-color: rgb(238, 238, 221);"   >: the behavior is always the same as the standard's default, namely&nbsp;</span><tt style="line-height: 18.2399997711182px; background-color: rgb(238, 238, 221);"   >RESPECT NULLS</tt><span style="font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: 18.2399997711182px; background-color: rgb(238, 238, 221);"   >. Likewise, the standard's&nbsp;</span><tt style="line-height: 18.2399997711182px; background-color: rgb(238, 238, 221);"   >FROM FIRST</tt><span style="font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: 18.2399997711182px; background-color: rgb(238, 238, 221);"   >&nbsp;or&nbsp;</span><tt style="line-height: 18.2399997711182px; background-color: rgb(238, 238, 221);"   >FROM LAST</tt><span style="font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: 18.2399997711182px; background-color: rgb(238, 238, 221);"   >&nbsp;option for&nbsp;</span><code style="margin-left: 0px; margin-right: 0px; -webkit-box-shadow: none; box-shadow: none; line-height: 18.2399997711182px; background-color: rgb(238, 238, 221);"   >nth_value</code><span style="font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: 18.2399997711182px; background-color: rgb(238, 238, 221);"   >&nbsp;is not implemented: only the default</span><tt style="line-height: 18.2399997711182px; background-color: rgb(238, 238, 221);"   >FROM FIRST</tt><span style="font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: 18.2399997711182px; background-color: rgb(238, 238, 221);"   >&nbsp;behavior is supported. (You can achieve the result of&nbsp;</span><tt style="line-height: 18.2399997711182px; background-color: rgb(238, 238, 221);"   >FROM LAST</tt><span style="font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: 18.2399997711182px; background-color: rgb(238, 238, 221);"   >&nbsp;by reversing the</span><tt style="line-height: 18.2399997711182px; background-color: rgb(238, 238, 221);"   >ORDER BY</tt><span style="font-family: verdana, sans-serif; font-size: 12.1599998474121px; line-height: 18.2399997711182px; background-color: rgb(238, 238, 221);"   >&nbsp;ordering.)</span></div><div><br></div><div>PostgreSQL的补丁下载 :&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >wget http://www.postgresql.org/message-id/attachment/29641/lead-lag-ignore-nulls.patch</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >打补丁简单步骤如下 :&nbsp;</span></div><div><div>下载补丁前1天的postgresql 源码 snapshot.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=snapshot;h=e5592c61adb0766eaee53ec07d2f05783d1c6548;sf=tgz</font></div><div><font size="2"   >tar -zxvf&nbsp;<span style="line-height: 22px;"   >postgresql-e5592c6.tar.gz</span></font></div><p></p></pre></div><div>下载补丁</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >[root@db-172-16-3-40 soft_bak]# cd postgresql-e5592c6</font></span></div><div><font size="2"   >wget http://www.postgresql.org/message-id/attachment/29641/lead-lag-ignore-nulls.patch</font></div><p></p></pre></div><div>应用补丁</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-40 postgresql-e5592c6]# patch -p1 &lt; ./lead-lag-ignore-nulls.patch&nbsp;</font></div><div><font size="2"   >patching file doc/src/sgml/func.sgml</font></div><div><font size="2"   >Hunk #1 succeeded at 12279 (offset 4 lines).</font></div><div><font size="2"   >Hunk #3 succeeded at 12309 (offset 4 lines).</font></div><div><font size="2"   >Hunk #5 succeeded at 12420 (offset 4 lines).</font></div><div><font size="2"   >patching file src/backend/executor/nodeWindowAgg.c</font></div><div><font size="2"   >patching file src/backend/nodes/bitmapset.c</font></div><div><font size="2"   >patching file src/backend/parser/gram.y</font></div><div><font size="2"   >Hunk #4 succeeded at 11526 (offset -257 lines).</font></div><div><font size="2"   >Hunk #6 succeeded at 12612 (offset -257 lines).</font></div><div><font size="2"   >patching file src/backend/parser/parse_agg.c</font></div><div><font size="2"   >patching file src/backend/parser/parse_func.c</font></div><div><font size="2"   >patching file src/backend/utils/adt/ruleutils.c</font></div><div><font size="2"   >patching file src/backend/utils/adt/windowfuncs.c</font></div><div><font size="2"   >patching file src/include/nodes/bitmapset.h</font></div><div><font size="2"   >patching file src/include/nodes/parsenodes.h</font></div><div><font size="2"   >Hunk #1 succeeded at 403 (offset 5 lines).</font></div><div><font size="2"   >patching file src/include/parser/kwlist.h</font></div><div><font size="2"   >patching file src/include/windowapi.h</font></div><div><font size="2"   >patching file src/test/regress/expected/window.out</font></div><div><font size="2"   >patching file src/test/regress/sql/window.sql</font></div><p></p></pre></div><div>打完补丁后, 如果是新安装库, 需要执行configure, 如果是已安装的, 只需要gmake和gmake install即可.</div><div><pre class="prettyprint"   ><p><font size="2"   >[root@db-172-16-3-40 postgresql-e5592c6]# ./configure --prefix=/home/pg94/pgsql9.4devel --with-pgport=2999 --with-perl --with-tcl --with-python --with-openssl --with-pam --without-ldap --with-libxml --with-libxslt --enable-thread-safety --with-wal-blocksize=16 --enable-dtrace &amp;&amp; gmake &amp;&amp; gmake install</font></p></pre></div></div><div>初始化数据库等操作略, 下面要演示一下打完补丁后这个语法在pg中是否有效了 :&nbsp;</div><div>在<span style="line-height: 22px;"   >src/test/regress/expected/window.out中也包含了该部分语法的演示.</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg94@db-172-16-3-40-&gt; psql</font></div><div><font size="2"   >psql (9.4devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=#&nbsp;</font></div></div><div><div><font size="2"   >digoal=# create table test(id int primary key, num int, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# insert into test values (1, 101, now());</font></div><div><span style="line-height: 22px;"   ><font size="2"   >digoal=# insert into test values (2, 102, now());</font></span></div><div><span style="line-height: 22px;"   ><font size="2"   >digoal=# insert into test values (3, null, now());</font></span></div><div><span style="line-height: 22px;"   ><font size="2"   >digoal=# insert into test values (4, null, now());</font></span></div><div><span style="line-height: 22px;"   ><font size="2"   >digoal=# insert into test values (5, 103, now());</font></span></div><div><span style="line-height: 22px;"   ><font size="2"   >digoal=# insert into test values (6, 104, now());</font></span></div><div><span style="line-height: 22px;"   ><font size="2"   >digoal=# insert into test values (7, 106, now());</font></span></div><div><span style="line-height: 22px;"   ><font size="2"   >digoal=# insert into test values (8, null, now());</font></span></div><div><span style="line-height: 22px;"   ><font size="2"   >digoal=# insert into test values (9, 105, now());</font></span></div></div><p></p></pre></div><div><div>digoal=# \pset null 空</div><div>Null display is "空".</div><div>当使用ignore nulls时, num为空值的行不计数. 所以id=3,4,5的前一行的num都取102.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select *,lag(num,1) ignore nulls over (order by id) from test;</font></div><div><font size="2"   >&nbsp;id | num | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| lag&nbsp;</font></div><div><font size="2"   >----+-----+----------------------------+-----</font></div><div><font size="2"   >&nbsp; 1 | 101 | 2013-08-23 07:59:27.772587 | &nbsp;空</font></div><div><font size="2"   >&nbsp; 2 | 102 | 2013-08-23 07:59:31.188448 | 101</font></div><div><font size="2"   >&nbsp; 3 | &nbsp;空 | 2013-08-23 07:59:36.001469 | 102</font></div><div><font size="2"   >&nbsp; 4 | &nbsp;空 | 2013-08-23 07:59:39.826797 | 102</font></div><div><font size="2"   >&nbsp; 5 | 103 | 2013-08-23 07:59:49.70349 &nbsp;| 102</font></div><div><font size="2"   >&nbsp; 6 | 104 | 2013-08-23 07:59:58.774687 | 103</font></div><div><font size="2"   >&nbsp; 7 | 106 | 2013-08-23 08:00:04.444463 | 104</font></div><div><font size="2"   >&nbsp; 8 | &nbsp;空 | 2013-08-23 08:00:09.669465 | 106</font></div><div><font size="2"   >&nbsp; 9 | 105 | 2013-08-23 08:00:17.067823 | 106</font></div><div><font size="2"   >(9 rows)</font></div><p></p></pre></div><div>默认和oracle一样, 采用respect nulls.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# select *,lag(num,1) respect nulls over (order by id) from test;</font></div><div><font size="2"   >&nbsp;id | num | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| lag&nbsp;</font></div><div><font size="2"   >----+-----+----------------------------+-----</font></div><div><font size="2"   >&nbsp; 1 | 101 | 2013-08-23 07:59:27.772587 | &nbsp;空</font></div><div><font size="2"   >&nbsp; 2 | 102 | 2013-08-23 07:59:31.188448 | 101</font></div><div><font size="2"   >&nbsp; 3 | &nbsp;空 | 2013-08-23 07:59:36.001469 | 102</font></div><div><font size="2"   >&nbsp; 4 | &nbsp;空 | 2013-08-23 07:59:39.826797 | &nbsp;空</font></div><div><font size="2"   >&nbsp; 5 | 103 | 2013-08-23 07:59:49.70349 &nbsp;| &nbsp;空</font></div><div><font size="2"   >&nbsp; 6 | 104 | 2013-08-23 07:59:58.774687 | 103</font></div><div><font size="2"   >&nbsp; 7 | 106 | 2013-08-23 08:00:04.444463 | 104</font></div><div><font size="2"   >&nbsp; 8 | &nbsp;空 | 2013-08-23 08:00:09.669465 | 106</font></div><div><font size="2"   >&nbsp; 9 | 105 | 2013-08-23 08:00:17.067823 | &nbsp;空</font></div><div><font size="2"   >(9 rows)</font></div></div><div><div><font size="2"   >digoal=# select *,lag(num,1) over (order by id) from test;</font></div><div><font size="2"   >&nbsp;id | num | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| lag&nbsp;</font></div><div><font size="2"   >----+-----+----------------------------+-----</font></div><div><font size="2"   >&nbsp; 1 | 101 | 2013-08-23 07:59:27.772587 | &nbsp;空</font></div><div><font size="2"   >&nbsp; 2 | 102 | 2013-08-23 07:59:31.188448 | 101</font></div><div><font size="2"   >&nbsp; 3 | &nbsp;空 | 2013-08-23 07:59:36.001469 | 102</font></div><div><font size="2"   >&nbsp; 4 | &nbsp;空 | 2013-08-23 07:59:39.826797 | &nbsp;空</font></div><div><font size="2"   >&nbsp; 5 | 103 | 2013-08-23 07:59:49.70349 &nbsp;| &nbsp;空</font></div><div><font size="2"   >&nbsp; 6 | 104 | 2013-08-23 07:59:58.774687 | 103</font></div><div><font size="2"   >&nbsp; 7 | 106 | 2013-08-23 08:00:04.444463 | 104</font></div><div><font size="2"   >&nbsp; 8 | &nbsp;空 | 2013-08-23 08:00:09.669465 | 106</font></div><div><font size="2"   >&nbsp; 9 | 105 | 2013-08-23 08:00:17.067823 | &nbsp;空</font></div><div><font size="2"   >(9 rows)</font></div></div><p></p></pre></div></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/message-id/flat/CA+=vxNa5_N1q5q5OkxC0aQnNdbo2Ru6GVw+86wk+oNsUNJDLig@mail.gmail.com#CA+=vxNa5_N1q5q5OkxC0aQnNdbo2Ru6GVw+86wk+oNsUNJDLig@mail.gmail.com"   >http://www.postgresql.org/message-id/flat/CA+=vxNa5_N1q5q5OkxC0aQnNdbo2Ru6GVw+86wk+oNsUNJDLig@mail.gmail.com#CA+=vxNa5_N1q5q5OkxC0aQnNdbo2Ru6GVw+86wk+oNsUNJDLig@mail.gmail.com</a></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL pending patch: window funciton lag  lead support SQL standard { RESPECT | IGNORE } NULLS - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>