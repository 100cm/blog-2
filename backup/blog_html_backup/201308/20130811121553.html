<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL pg_stats used to estimate top freps values. and explain rows</h2>
	<h5 id="">2013-08-11 12:15:53&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013710105353862/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><span style="line-height: 22px;"   >本文要聊的是如何利用统计信息规避一些复杂的精确统计.&nbsp;</span></div><div>去年写过一篇关于 PostgreSQL 9.2 新增array元素统计收集的相关文章.&nbsp;<span style="line-height: 22px;"   >本文也会讲到.</span></div><div><a href="http://blog.163.com/digoal@126/blog/static/16387704020124180182088/"   >http://blog.163.com/digoal@126/blog/static/16387704020124180182088/</a></div><div><pre class="prettyprint"   ><div><div><font size="2"   >Release 9.2</font></div><div><font size="2"   >Release Date: 2012-09-10</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp;* Move the frequently accessed members of the PGPROC shared memory</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;array to a separate array (Pavan Deolasee, Heikki Linnakangas,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;Robert Haas)</font></div></div><p></p></pre></div><div>在日常的数据库统计中, count(*), 排名这类的统计非常多, 同时这类统计的开销也非常大, 特别是当表的数据量巨大时.</div><span style="line-height: 22px;"   >接下来模拟几个场景.</span><div>1. 统计某条件下的记录条数.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# create table test_1 (id serial4 primary key, info text, appid int, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# insert into test_1 (info,appid,crt_time) select md5(random()::text),round(10000*random())::int,clock_timestamp() from generate_series(1,2000000);</font></div></div><div><font size="2"   >INSERT 0 2000000</font></div><p></p></pre></div><div>默认的统计目标值为100</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# show default_statistics_target ;</font></div><div><font size="2"   >-[ RECORD 1 ]-------------+----</font></div><div><font size="2"   >default_statistics_target | 100</font></div></div><div><div><font size="2"   >digoal=# analyze test_1;</font></div><div><font size="2"   >ANALYZE</font></div><div><font size="2"   >-- 为了得到准确的统计信息, 如果没有打开autovacuum, 最好手动收集一次统计信息.</font></div><div><font size="2"   >digoal=# select * from pg_stat_all_tables where relname='test_1';</font></div><div><font size="2"   >-[ RECORD 1 ]-----+------------------------------</font></div><div><font size="2"   >relid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 91368</font></div><div><font size="2"   >schemaname &nbsp; &nbsp; &nbsp; &nbsp;| public</font></div><div><font size="2"   >relname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | test_1</font></div><div><font size="2"   >seq_scan &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 1</font></div><div><font size="2"   >seq_tup_read &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"   >idx_scan &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"   >idx_tup_fetch &nbsp; &nbsp; | 0</font></div><div><font size="2"   >n_tup_ins &nbsp; &nbsp; &nbsp; &nbsp; | 2000000</font></div><div><font size="2"   >n_tup_upd &nbsp; &nbsp; &nbsp; &nbsp; | 0</font></div><div><font size="2"   >n_tup_del &nbsp; &nbsp; &nbsp; &nbsp; | 0</font></div><div><font size="2"   >n_tup_hot_upd &nbsp; &nbsp; | 0</font></div><div><font size="2"   >n_live_tup &nbsp; &nbsp; &nbsp; &nbsp;| 2000000</font></div><div><font size="2"   >n_dead_tup &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"   >last_vacuum &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >last_autovacuum &nbsp; |&nbsp;</font></div><div><font size="2"   >last_analyze &nbsp; &nbsp; &nbsp;| 2013-08-11 11:15:04.975523+08</font></div><div><font size="2"   >last_autoanalyze &nbsp;| 2013-08-11 11:14:53.663951+08</font></div><div><font size="2"   >vacuum_count &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"   >autovacuum_count &nbsp;| 0</font></div><div><font size="2"   >analyze_count &nbsp; &nbsp; | 1</font></div><div><font size="2"   >autoanalyze_count | 1</font></div></div><p></p></pre></div><div>查询appid=1的记录数有多少</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select count(*) from test_1 where appid=1;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp;189</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>使用explain输出appid=1的记录数有多少, 这里显示为197. 和使用count(*)得到的存在一点差异.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# explain select * from test_1 where appid=1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Seq Scan on test_1 &nbsp;(cost=0.00..45619.00 rows=197 width=49)</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: (appid = 1)</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div></div><div>如果将统计目标调整为10000, 采样行数会大大增加, 消耗的资源加大.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# alter table test_1 alter column appid SET STATISTICS 10000;</font></div><div><font size="2"   >ALTER TABLE</font></div></div><div><div><font size="2"   >digoal=# analyze verbose test_1;</font></div><div><font size="2"   >INFO: &nbsp;analyzing "public.test_1"</font></div><div><font size="2"   >INFO: &nbsp;"test_1": scanned 20619 of 20619 pages, containing 2000000 live rows and 0 dead rows; 2000000 rows in sample, 2000000 estimated total rows</font></div><div><font size="2"   >ANALYZE</font></div></div><p></p></pre></div><div><div>但是统计行数更加准确了, 现在为188. 只相差1行.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# explain select * from test_1 where appid=1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Seq Scan on test_1 &nbsp;(cost=0.00..45619.00 rows=188 width=49)</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: (appid = 1)</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div></div><div>范围查询看看是否准确呢?</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# explain select * from test_1 where appid&gt;1000;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Seq Scan on test_1 &nbsp;(cost=0.00..45619.00 rows=1800419 width=49)</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: (appid &gt; 1000)</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div>也非常准确.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select count(*) from test_1 where appid&gt;1000;</font></div><div><font size="2"   >&nbsp; count &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;1800263</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>误差为 :&nbsp;0.00008665</div><div>组合条件的输出行评估 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# explain select * from test_1 where appid&gt;1000 and crt_time&gt;now();</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Seq Scan on test_1 &nbsp;(cost=0.00..55619.00 rows=180 width=49)</font></div><div><font size="2"   >&nbsp; &nbsp;Filter: ((appid &gt; 1000) AND (crt_time &gt; now()))</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   >digoal=# select * from test_1 where appid&gt;1000 and crt_time&gt;now();</font></div><div><font size="2"   >&nbsp;id | info | appid | crt_time&nbsp;</font></div><div><font size="2"   >----+------+-------+----------</font></div><div><font size="2"   >(0 rows)</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >2. 分组排行, 例如要查询哪个appid的记录条数最多.</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# alter table test_1 alter column appid SET STATISTICS 100;</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >digoal=# analyze verbose test_1;</font></div><div><font size="2"   >INFO: &nbsp;analyzing "public.test_1"</font></div><div><font size="2"   >INFO: &nbsp;"test_1": scanned 20619 of 20619 pages, containing 2000000 live rows and 0 dead rows; 30000 rows in sample, 2000000 estimated total rows</font></div><div><font size="2"   >ANALYZE</font></div></div><div><div><font size="2"   >digoal=# select most_common_vals,most_common_freqs from pg_stats where tablename='test_1' and attname='appid';</font></div><div><font size="2"   >-[ RECORD 1 ]-----+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >most_common_vals &nbsp;| {3677,6460,1210,1291,2052,3374,3633,4386,4729,4756,5602,320,383,479,906,1003,1018,1102,1243,2594,2625,2762,3092,3243,3376,3511,4842,5595,5967,6135,6412,6821,6824,6966,7828,7984,8118,8310,8378,8952,9012,9840,9922,22,68,359,632,899,933,1034,1227,1369,1554,1615,1706,1744,1824,1995,2034,2056,2215,2412,2770,2988,3488,3722,3780,3834,3937,4079,4124,4224,4424,4723,4811,4870,5287,5490,5596,5609,5665,5751,5881,6236,6562,6656,6694,6827,6865,6980,6996,7008,7021,7097,7274,7285,7289,7330,7367,7449}</font></div><div><font size="2"   >most_common_freqs | {0.0004,0.000366667,0.000333333,0.000333333,0.000333333,0.000333333,0.000333333,0.000333333,0.000333333,0.000333333,0.000333333,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667}</font></div></div><p></p></pre></div><div>值太均匀, 所以这个不准确.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select appid,count(*) from test_1 group by appid order by count(*) desc limit 100;</font></div><div><font size="2"   >&nbsp;appid | count&nbsp;</font></div><div><font size="2"   >-------+-------</font></div><div><font size="2"   >&nbsp; 9853 | &nbsp; 253</font></div><div><font size="2"   >&nbsp; 6502 | &nbsp; 249</font></div><div><font size="2"   >&nbsp; 1688 | &nbsp; 249</font></div><div><font size="2"   >&nbsp; &nbsp;464 | &nbsp; 249</font></div><div><font size="2"   >&nbsp; 9974 | &nbsp; 248</font></div><div><font size="2"   >&nbsp; 1540 | &nbsp; 248</font></div><div><font size="2"   >&nbsp; 6622 | &nbsp; 247</font></div><div><font size="2"   >&nbsp; 6669 | &nbsp; 247</font></div><div><font size="2"   >&nbsp; 4643 | &nbsp; 247</font></div><div><font size="2"   >&nbsp; 1046 | &nbsp; 246</font></div><div><font size="2"   >&nbsp; 3051 | &nbsp; 246</font></div><div><font size="2"   >&nbsp; 6359 | &nbsp; 246</font></div><div><font size="2"   >&nbsp; 9103 | &nbsp; 246</font></div><div><font size="2"   >&nbsp; &nbsp;348 | &nbsp; 246</font></div><div><font size="2"   >&nbsp; 2213 | &nbsp; 244</font></div><div><font size="2"   >&nbsp; &nbsp;138 | &nbsp; 244</font></div><div><font size="2"   >&nbsp; 8135 | &nbsp; 244</font></div><div><font size="2"   >&nbsp; 3980 | &nbsp; 244</font></div><div><font size="2"   >&nbsp; 5870 | &nbsp; 243</font></div><div><font size="2"   >&nbsp; 9349 | &nbsp; 243</font></div><div><font size="2"   >&nbsp; 6210 | &nbsp; 243</font></div><div><font size="2"   >&nbsp; 4575 | &nbsp; 243</font></div><div><font size="2"   >&nbsp; 3421 | &nbsp; 242</font></div><div><font size="2"   >&nbsp; &nbsp;207 | &nbsp; 242</font></div><div><font size="2"   >&nbsp; 3224 | &nbsp; 242</font></div><div><font size="2"   >&nbsp; 7056 | &nbsp; 242</font></div><div><font size="2"   >&nbsp; 4561 | &nbsp; 242</font></div><div><font size="2"   >&nbsp; 8770 | &nbsp; 241</font></div><div><font size="2"   >&nbsp; 3011 | &nbsp; 241</font></div><div><font size="2"   >&nbsp; 3731 | &nbsp; 241</font></div><div><font size="2"   >&nbsp; 4951 | &nbsp; 241</font></div><div><font size="2"   >&nbsp; 1066 | &nbsp; 240</font></div><div><font size="2"   >&nbsp; 5501 | &nbsp; 240</font></div><div><font size="2"   >&nbsp; 9354 | &nbsp; 240</font></div><div><font size="2"   >&nbsp; 7430 | &nbsp; 240</font></div><div><font size="2"   >&nbsp; 7621 | &nbsp; 240</font></div><div><font size="2"   >&nbsp; 2058 | &nbsp; 240</font></div><div><font size="2"   >&nbsp; 5460 | &nbsp; 240</font></div><div><font size="2"   >&nbsp; 6578 | &nbsp; 239</font></div><div><font size="2"   >&nbsp; 7431 | &nbsp; 239</font></div><div><font size="2"   >&nbsp; 5473 | &nbsp; 239</font></div><div><font size="2"   >&nbsp; 7305 | &nbsp; 239</font></div><div><font size="2"   >&nbsp; 9563 | &nbsp; 239</font></div><div><font size="2"   >&nbsp; 3275 | &nbsp; 239</font></div><div><font size="2"   >&nbsp; 2968 | &nbsp; 239</font></div><div><font size="2"   >&nbsp; 8825 | &nbsp; 239</font></div><div><font size="2"   >&nbsp; 3426 | &nbsp; 238</font></div><div><font size="2"   >&nbsp; 3850 | &nbsp; 238</font></div><div><font size="2"   >&nbsp; 6835 | &nbsp; 238</font></div><div><font size="2"   >&nbsp; 5928 | &nbsp; 238</font></div><div><font size="2"   >&nbsp; 8567 | &nbsp; 238</font></div><div><font size="2"   >&nbsp; 4083 | &nbsp; 238</font></div><div><font size="2"   >&nbsp; 1137 | &nbsp; 238</font></div><div><font size="2"   >&nbsp; 4862 | &nbsp; 238</font></div><div><font size="2"   >&nbsp; 4238 | &nbsp; 238</font></div><div><font size="2"   >&nbsp; 1058 | &nbsp; 238</font></div><div><font size="2"   >&nbsp; 6745 | &nbsp; 237</font></div><div><font size="2"   >&nbsp; 5854 | &nbsp; 237</font></div><div><font size="2"   >&nbsp; 3196 | &nbsp; 237</font></div><div><font size="2"   >&nbsp; 3165 | &nbsp; 237</font></div><div><font size="2"   >&nbsp; &nbsp;724 | &nbsp; 237</font></div><div><font size="2"   >&nbsp; 9643 | &nbsp; 237</font></div><div><font size="2"   >&nbsp; 7326 | &nbsp; 237</font></div><div><font size="2"   >&nbsp; 6661 | &nbsp; 237</font></div><div><font size="2"   >&nbsp; 3685 | &nbsp; 236</font></div><div><font size="2"   >&nbsp; 2590 | &nbsp; 236</font></div><div><font size="2"   >&nbsp; 9685 | &nbsp; 236</font></div><div><font size="2"   >&nbsp; 8366 | &nbsp; 236</font></div><div><font size="2"   >&nbsp; 3931 | &nbsp; 236</font></div><div><font size="2"   >&nbsp; 7074 | &nbsp; 236</font></div><div><font size="2"   >&nbsp; 6140 | &nbsp; 236</font></div><div><font size="2"   >&nbsp; 4402 | &nbsp; 236</font></div><div><font size="2"   >&nbsp; 4635 | &nbsp; 236</font></div><div><font size="2"   >&nbsp; 7628 | &nbsp; 236</font></div><div><font size="2"   >&nbsp; 5967 | &nbsp; 236</font></div><div><font size="2"   >&nbsp; &nbsp; 24 | &nbsp; 236</font></div><div><font size="2"   >&nbsp; &nbsp;987 | &nbsp; 236</font></div><div><font size="2"   >&nbsp; 2472 | &nbsp; 236</font></div><div><font size="2"   >&nbsp; 8724 | &nbsp; 236</font></div><div><font size="2"   >&nbsp; 6404 | &nbsp; 236</font></div><div><font size="2"   >&nbsp; 9504 | &nbsp; 235</font></div><div><font size="2"   >&nbsp; 5816 | &nbsp; 235</font></div><div><font size="2"   >&nbsp; 1261 | &nbsp; 235</font></div><div><font size="2"   >&nbsp; 5551 | &nbsp; 235</font></div><div><font size="2"   >&nbsp; &nbsp;874 | &nbsp; 235</font></div><div><font size="2"   >&nbsp; 1880 | &nbsp; 235</font></div><div><font size="2"   >&nbsp; 5248 | &nbsp; 235</font></div><div><font size="2"   >&nbsp; &nbsp;404 | &nbsp; 235</font></div><div><font size="2"   >&nbsp; 5738 | &nbsp; 235</font></div><div><font size="2"   >&nbsp; &nbsp;583 | &nbsp; 235</font></div><div><font size="2"   >&nbsp; 7799 | &nbsp; 235</font></div><div><font size="2"   >&nbsp; 2362 | &nbsp; 235</font></div><div><font size="2"   >&nbsp; 1789 | &nbsp; 235</font></div><div><font size="2"   >&nbsp; 7707 | &nbsp; 235</font></div><div><font size="2"   >&nbsp; 3091 | &nbsp; 234</font></div><div><font size="2"   >&nbsp; 9245 | &nbsp; 234</font></div><div><font size="2"   >&nbsp; 6107 | &nbsp; 234</font></div><div><font size="2"   >&nbsp; 8657 | &nbsp; 234</font></div><div><font size="2"   >&nbsp; 7460 | &nbsp; 234</font></div><div><font size="2"   >&nbsp; 2252 | &nbsp; 234</font></div><div><font size="2"   >(100 rows)</font></div><p></p></pre></div><div>当倾斜较大时, 就特别准.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# &nbsp;insert into test_1 (info,appid,crt_time) select 'test',1,now() from generate_series(1,100000);</font></div><div><font size="2"   >INSERT 0 100000</font></div><div><font size="2"   >digoal=# analyze verbose test_1;</font></div><div><font size="2"   >INFO: &nbsp;analyzing "public.test_1"</font></div><div><font size="2"   >INFO: &nbsp;"test_1": scanned 21262 of 21262 pages, containing 2101000 live rows and 0 dead rows; 30000 rows in sample, 2101000 estimated total rows</font></div><div><font size="2"   >ANALYZE</font></div><div><font size="2"   >digoal=# select appid,count(*) from test_1 group by appid order by count(*) desc limit 5;</font></div><div><font size="2"   >&nbsp;appid | count &nbsp;</font></div><div><font size="2"   >-------+--------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;1 | 101189</font></div><div><font size="2"   >&nbsp; 9853 | &nbsp; &nbsp;253</font></div><div><font size="2"   >&nbsp; 6502 | &nbsp; &nbsp;249</font></div><div><font size="2"   >&nbsp; &nbsp;464 | &nbsp; &nbsp;249</font></div><div><font size="2"   >&nbsp; 1688 | &nbsp; &nbsp;249</font></div><div><font size="2"   >(5 rows)</font></div><p></p></pre></div><div>显然<span style="line-height: 22px;"   >most_common_vals中采样准确了, appid=1确实是记录数最多的.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select most_common_vals,most_common_freqs from pg_stats where tablename='test_1' and attname='appid';</font></div><div><font size="2"   >-[ RECORD 1 ]-----+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >most_common_vals &nbsp;| {1,2972,94,207,1998,4883,1766,2557,3202,3941,4057,6457,7011,7412,8000,8516,9793,9948,10,90,100,140,276,382,595,1242,1315,1328,1334,1346,1388,2142,2465,2592,2879,2997,3589,3793,3950,4066,4418,4454,4800,5049,5074,5119,5265,5564,5796,5934,5947,6198,6205,6235,6288,6508,6691,6822,6826,6937,7048,7055,7079,7198,7201,7270,7938,8592,8872,9020,9214,9222,9292,9400,9501,9547,9659,9719,9856,9859,7,147,172,185,200,208,405,454,463,529,559,585,622,648,722,729,743,763,777,778}</font></div><div><font size="2"   >most_common_freqs | {0.0474333,0.000366667,0.000333333,0.000333333,0.000333333,0.000333333,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.0003,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000266667,0.000233333,0.000233333,0.000233333,0.000233333,0.000233333,0.000233333,0.000233333,0.000233333,0.000233333,0.000233333,0.000233333,0.000233333,0.000233333,0.000233333,0.000233333,0.000233333,0.000233333,0.000233333,0.000233333,0.000233333}</font></div><p></p></pre></div><div><br></div><wbr style="line-height: 22px;"   ><div style="line-height: 22px;"   >3. 数组的元素值排行统计</div><div style="line-height: 22px;"   >例如有一个表中记录了客户允许的应用程序信息, 应用程序存储为一个数组, 程序以id形式存到数组中.</div><div style="line-height: 22px;"   >如果要统计全国终端中最火爆的程序排行.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table test_2(id serial primary key, appid int[], crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><p></p></pre></div><div>假设appid为0-10的程序比较火爆, 模拟100秒插入请求.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi test.sql</font></div><div><font size="2"   >insert into test_2(appid) select array_agg(appid) appid_agg from (select round(10*random())::int as appid from generate_series(1,20)) t;</font></div><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; pgbench -M prepared -n -r -f ./test.sql -c 16 -j 4 -T 100 digoal</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 100 s</font></div><div><font size="2"   >number of transactions actually processed: 389701</font></div><div><font size="2"   >tps = 3896.755035 (including connections establishing)</font></div><div><font size="2"   >tps = 3897.686073 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 4.103117 &nbsp; &nbsp; &nbsp; &nbsp;insert into test_2(appid) select array_agg(appid) appid_agg from (select round(10*random())::int as appid from generate_series(1,20)) t;</font></div></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"   >假设appid为10以上的程序不火爆, &nbsp;模拟10秒插入请求.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi test.sql</font></div><div><font size="2"   >insert into test_2(appid) select array_agg(appid) appid_agg from (select round(1000*random())::int as appid from generate_series(1,20)) t;</font></div><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; pgbench -M prepared -n -r -f ./test.sql -c 16 -j 4 -T 10 digoal</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 10 s</font></div><div><font size="2"   >number of transactions actually processed: 37256</font></div><div><font size="2"   >tps = 3718.362208 (including connections establishing)</font></div><div><font size="2"   >tps = 3725.838361 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 4.290334 &nbsp; &nbsp; &nbsp; &nbsp;insert into test_2(appid) select array_agg(appid) appid_agg from (select round(1000*random())::int as appid from generate_series(1,20)) t;</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"   >总记录数如下 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 22px;"   ><font size="2"   >digoal=# select count(*) from test_2;</font></span></div><div><div><font size="2"   >&nbsp;count &nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp;472583</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>收集统计信息</div><div><div>digoal=# analyze verbose test_2;</div><div>INFO: &nbsp;analyzing "public.test_2"</div><div>INFO: &nbsp;"test_2": scanned 8184 of 8184 pages, containing 472583 live rows and 0 dead rows; 30000 rows in sample, 472583 estimated total rows</div><div>ANALYZE</div></div><div>通过group by和order by获取实际的排名 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select appid,count(*) from (select unnest(appid) as appid from test_2) t group by appid order by count(*) desc limit 20;</font></div><div><font size="2"   >&nbsp;appid | count &nbsp;</font></div><div><font size="2"   >-------+--------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;9 | 872831</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;6 | 871908</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;3 | 871867</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;7 | 871551</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;8 | 871436</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;4 | 871391</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;1 | 871051</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;5 | 870770</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;2 | 870692</font></div><div><font size="2"   >&nbsp; &nbsp; 10 | 435583</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;0 | 435342</font></div><div><font size="2"   >&nbsp; &nbsp;387 | &nbsp; &nbsp;831</font></div><div><font size="2"   >&nbsp; &nbsp; 69 | &nbsp; &nbsp;824</font></div><div><font size="2"   >&nbsp; &nbsp;665 | &nbsp; &nbsp;822</font></div><div><font size="2"   >&nbsp; &nbsp;703 | &nbsp; &nbsp;816</font></div><div><font size="2"   >&nbsp; &nbsp;651 | &nbsp; &nbsp;811</font></div><div><font size="2"   >&nbsp; &nbsp;520 | &nbsp; &nbsp;809</font></div><div><font size="2"   >&nbsp; &nbsp;435 | &nbsp; &nbsp;809</font></div><div><font size="2"   >&nbsp; &nbsp;783 | &nbsp; &nbsp;806</font></div><div><font size="2"   >&nbsp; &nbsp;671 | &nbsp; &nbsp;806</font></div><div><font size="2"   >(20 rows)</font></div><p></p></pre></div><div><br></div><div><div>接下来要用9.2新增的array 统计信息查看排名了 :&nbsp;</div><div>注意元素的收集个数为default_statistics_target 的10倍, 这个可以参考源码 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >+ &nbsp; /*</font></div><div><font size="2"   >+ &nbsp; &nbsp;* Set up static pointer for use by subroutines. &nbsp;We wait till here in</font></div><div><font size="2"   >+ &nbsp; &nbsp;* case std_compute_stats somehow recursively invokes us (probably not</font></div><div><font size="2"   >+ &nbsp; &nbsp;* possible, but ...)</font></div><div><font size="2"   >+ &nbsp; &nbsp;*/</font></div><div><font size="2"   >+ &nbsp; array_extra_data = extra_data;</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+ &nbsp; /*</font></div><div><font size="2"   >+ &nbsp; &nbsp;* We want statistics_target * 10 elements in the MCELEM array. This</font></div><div><font size="2"   >+ &nbsp; &nbsp;* multiplier is pretty arbitrary, but is meant to reflect the fact that</font></div><div><font size="2"   >+ &nbsp; &nbsp;* the number of individual elements tracked in pg_statistic ought to be</font></div><div><font size="2"   >+ &nbsp; &nbsp;* more than the number of values for a simple scalar column.</font></div><div><font size="2"   >+ &nbsp; &nbsp;*/</font></div><div><font size="2"   >+ &nbsp; num_mcelem = stats-&gt;attr-&gt;attstattarget * 10;</font></div><p></p></pre></div><div>所以默认<span style="line-height: 22px;"   >default_statistics_target=100的情况下, 将会收集1000个数组型元素的出现概率.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select array_length(most_common_elems,1),array_length(most_common_elem_freqs,1) from pg_stats where tablename='test_2' and attname='appid';</font></div><div><font size="2"   >-[ RECORD 1 ]+-----</font></div><div><font size="2"   >array_length | 1000</font></div><div><font size="2"   >array_length | 1003</font></div><p></p></pre></div></div><div>most_common_elem_freqs中最后3个的值代表min, max, null_freqs. 具体见</div><div><a href="http://blog.163.com/digoal@126/blog/static/16387704020124180182088/"   >http://blog.163.com/digoal@126/blog/static/16387704020124180182088/</a></div><div>如果把统计信息修改为50, 那么统计信息的元素个数将变成500.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# alter table test_2 alter column appid set statistics 50;</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >digoal=# analyze verbose test_2;</font></div><div><font size="2"   >INFO: &nbsp;analyzing "public.test_2"</font></div><div><font size="2"   >INFO: &nbsp;"test_2": scanned 8184 of 8184 pages, containing 472583 live rows and 0 dead rows; 30000 rows in sample, 472583 estimated total rows</font></div><div><font size="2"   >ANALYZE</font></div><div><font size="2"   >digoal=# select array_length(most_common_elems,1),array_length(most_common_elem_freqs,1) from pg_stats where tablename='test_2' and attname='appid';</font></div><div><font size="2"   >-[ RECORD 1 ]+----</font></div><div><font size="2"   >array_length | 500</font></div><div><font size="2"   >array_length | 503</font></div><p></p></pre></div><div>下面是统计信息 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select most_common_elems,most_common_elem_freqs from pg_stats where tablename='test_2' and attname='appid';</font></div><div><font size="2"   >most_common_elems &nbsp; &nbsp; &nbsp;| {0,1,2,3,4,5,6,7,8,9,10,12,13,15,16,17,18,22,23,24,27,30,31,32,34,35,36,37,40,41,42,44,49,50,52,55,56,60,63,67,69,73,77,78,81,85,89,90,94,95,97,100,101,103,104,108,109,114,116,117,120,121,123,125,128,132,133,134,136,139,140,143,144,146,149,150,151,152,153,154,155,158,159,162,165,167,170,172,173,174,175,180,182,183,184,186,189,192,196,197,200,202,208,209,210,211,214,217,221,222,226,227,232,233,234,239,241,242,243,245,246,249,250,253,254,259,260,263,264,265,268,269,272,273,275,276,277,281,283,287,288,289,291,294,295,296,297,300,301,304,305,307,311,315,316,317,318,322,324,325,333,334,335,338,340,342,344,346,348,351,352,353,354,355,357,359,362,363,365,366,367,368,370,374,376,377,379,382,384,387,389,391,393,397,398,400,401,402,406,407,410,415,418,419,420,422,423,424,425,428,430,431,432,433,434,436,437,438,441,442,443,445,446,448,449,450,451,455,456,457,458,460,463,464,465,467,470,471,472,474,476,478,481,483,484,486,488,490,491,492,494,495,496,498,499,503,504,505,510,512,513,514,515,518,520,522,523,529,530,532,538,539,542,543,545,553,556,559,560,562,565,567,568,569,571,572,574,575,576,579,580,582,587,588,589,593,596,597,599,601,605,606,607,608,609,610,612,616,617,619,621,622,624,626,628,631,632,637,638,642,644,646,648,655,656,657,660,661,663,664,665,666,667,669,670,672,675,678,679,681,682,683,685,687,689,691,692,693,696,697,698,699,701,702,703,707,708,709,712,714,716,718,719,720,722,723,724,725,727,728,729,734,735,736,738,741,742,743,744,746,747,752,753,759,760,761,762,763,767,769,770,772,773,775,776,777,778,779,782,784,785,787,788,789,790,791,792,795,797,799,800,801,804,805,807,809,811,815,816,818,819,824,825,827,828,829,830,831,832,833,836,838,840,842,843,844,847,848,850,851,854,858,860,861,862,864,865,868,869,870,873,874,875,880,881,884,886,893,894,895,898,900,904,906,907,912,913,914,922,924,928,931,933,939,941,942,944,946,947,954,955,956,957,960,961,962,963,965,967,968,970,972,975,978,987,988,991,994,996,997}</font></div><div><font size="2"   >most_common_elem_freqs | {0.590833,0.810967,0.809233,0.808433,0.807467,0.806667,0.808067,0.8102,0.806233,0.808367,0.588033,0.00186667,0.0019,0.0018,0.0018,0.00183333,0.00193333,0.00176667,0.002,0.00176667,0.00223333,0.00163333,0.00213333,0.0019,0.00193333,0.0017,0.00166667,0.00166667,0.00163333,0.00186667,0.00176667,0.0022,0.00206667,0.00196667,0.00183333,0.00163333,0.0018,0.002,0.0017,0.0017,0.00166667,0.00183333,0.00173333,0.0017,0.0017,0.00163333,0.00183333,0.00173333,0.00193333,0.0017,0.0017,0.0018,0.00173333,0.00176667,0.00166667,0.00213333,0.0021,0.00173333,0.00193333,0.00186667,0.00166667,0.0019,0.00166667,0.00213333,0.0021,0.00176667,0.00163333,0.00173333,0.00176667,0.00176667,0.00186667,0.00193333,0.00176667,0.00173333,0.0019,0.00193333,0.00176667,0.002,0.00176667,0.00173333,0.00173333,0.00186667,0.00173333,0.00166667,0.0021,0.00163333,0.00193333,0.00176667,0.00166667,0.00176667,0.00163333,0.00193333,0.00166667,0.00166667,0.00193333,0.00176667,0.0017,0.00163333,0.00176667,0.00196667,0.002,0.00196667,0.00213333,0.0017,0.00193333,0.00173333,0.00176667,0.00166667,0.0018,0.00163333,0.0021,0.00216667,0.00203333,0.00193333,0.0019,0.00176667,0.00193333,0.00176667,0.00193333,0.00176667,0.00166667,0.00186667,0.00196667,0.00173333,0.0019,0.002,0.00193333,0.0021,0.00166667,0.0017,0.00166667,0.00196667,0.0019,0.0019,0.00163333,0.0017,0.00163333,0.0023,0.00173333,0.00186667,0.00193333,0.00173333,0.0017,0.00166667,0.00166667,0.00173333,0.0018,0.00166667,0.00183333,0.0018,0.00173333,0.00163333,0.0017,0.00176667,0.00176667,0.00166667,0.0019,0.00163333,0.00166667,0.00163333,0.0017,0.00196667,0.0021,0.00166667,0.0019,0.00173333,0.00166667,0.002,0.00233333,0.0017,0.00163333,0.00183333,0.0018,0.00186667,0.00183333,0.00186667,0.0019,0.0018,0.00166667,0.00196667,0.0018,0.00176667,0.0017,0.00166667,0.00163333,0.00166667,0.00163333,0.0017,0.00166667,0.0018,0.00166667,0.00173333,0.0017,0.0017,0.002,0.00176667,0.00166667,0.00186667,0.00166667,0.00183333,0.00163333,0.00176667,0.00183333,0.00183333,0.00173333,0.0018,0.0018,0.0017,0.00166667,0.0018,0.0018,0.0017,0.00186667,0.00166667,0.00193333,0.0018,0.0017,0.0019,0.00163333,0.00173333,0.00203333,0.0017,0.00166667,0.002,0.00163333,0.00186667,0.002,0.0019,0.00163333,0.0017,0.00186667,0.00163333,0.00173333,0.00166667,0.0018,0.00203333,0.00166667,0.00166667,0.00186667,0.0018,0.0018,0.00163333,0.0019,0.00186667,0.00166667,0.00203333,0.00176667,0.00166667,0.002,0.00163333,0.00186667,0.00183333,0.00186667,0.00176667,0.00166667,0.00196667,0.0021,0.0018,0.00186667,0.00193333,0.00196667,0.0017,0.00176667,0.0018,0.0017,0.0017,0.00183333,0.00173333,0.0021,0.002,0.0019,0.00193333,0.0018,0.00166667,0.00173333,0.00183333,0.0017,0.00176667,0.0018,0.00196667,0.00206667,0.0018,0.00173333,0.00186667,0.00173333,0.00186667,0.00166667,0.0017,0.00183333,0.00173333,0.0018,0.00163333,0.00203333,0.0018,0.00166667,0.00216667,0.00183333,0.0017,0.00166667,0.0018,0.00163333,0.00183333,0.0019,0.00163333,0.00183333,0.0018,0.00206667,0.0017,0.00176667,0.00196667,0.00163333,0.00166667,0.00206667,0.0017,0.0018,0.00196667,0.00166667,0.00193333,0.00173333,0.00166667,0.0017,0.00173333,0.0018,0.00206667,0.00166667,0.00166667,0.00186667,0.00163333,0.0017,0.00163333,0.00186667,0.00173333,0.00166667,0.00183333,0.0018,0.002,0.00163333,0.00176667,0.00206667,0.00173333,0.00183333,0.00173333,0.00163333,0.00173333,0.00183333,0.00163333,0.00163333,0.00203333,0.00173333,0.0017,0.00196667,0.00176667,0.00166667,0.00173333,0.0018,0.0018,0.00173333,0.00183333,0.0019,0.002,0.00176667,0.002,0.00173333,0.00203333,0.0018,0.00163333,0.00173333,0.00166667,0.00166667,0.00213333,0.00173333,0.00163333,0.00183333,0.002,0.00203333,0.00166667,0.0019,0.00173333,0.00166667,0.00193333,0.0017,0.00166667,0.00176667,0.0017,0.0017,0.00166667,0.00166667,0.0018,0.00163333,0.0017,0.00203333,0.00193333,0.00176667,0.00176667,0.0019,0.0018,0.00176667,0.00166667,0.0018,0.0019,0.00196667,0.00173333,0.00173333,0.0018,0.0018,0.00166667,0.00166667,0.00213333,0.0018,0.00206667,0.00173333,0.00163333,0.00166667,0.00166667,0.00176667,0.00166667,0.0017,0.00186667,0.00176667,0.00183333,0.00176667,0.002,0.00163333,0.0017,0.0018,0.00206667,0.00186667,0.0018,0.00173333,0.00196667,0.0017,0.0017,0.0018,0.00173333,0.0017,0.0017,0.00203333,0.0018,0.0018,0.00163333,0.00173333,0.00176667,0.00163333,0.0017,0.00213333,0.0017,0.00186667,0.00206667,0.00163333,0.0017,0.00176667,0.00163333,0.0021,0.0018,0.0021,0.00173333,0.00196667,0.00166667,0.00183333,0.0017,0.0018,0.00196667,0.00166667,0.00166667,0.00206667,0.00166667,0.00163333,0.00186667,0.0018,0.00186667,0.0017,0.00203333,0.00206667,0.00233333,0.0018,0.00216667,0.0017,0.00163333,0.0019,0.00173333,0.0018,0.00196667,0.00186667,0.0018,0.00176667,0.0017,0.0017,0.0018,0.0017,0.00176667,0.00166667,0.00166667,0.00196667,0.00186667,0.0021,0.00163333,0.0019,0.00176667,0.0018,0.00163333,0.00163333,0.810967,0}</font></div><p></p></pre></div><div>注意这里不是按照appid频率排序的, 所以还需要处理一下.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from&nbsp;</font></div><div><font size="2"   >(select row_number() over(partition by r) as rn,ele from (select unnest(most_common_elems::text::int[]) ele,2 as r from pg_stats where tablename='test_2' and attname='appid') t) t1</font></div><div><font size="2"   >join</font></div><div><font size="2"   >(select row_number() over(partition by r) as rn,freq from (select unnest(most_common_elem_freqs) freq,2 as r from pg_stats where tablename='test_2' and attname='appid') t) t2</font></div><div><font size="2"   >on (t1.rn=t2.rn) order by t2.freq desc limit 20;</font></div><div><font size="2"   >&nbsp;rn &nbsp;| ele | rn &nbsp;| &nbsp; &nbsp;freq &nbsp; &nbsp;</font></div><div><font size="2"   >-----+-----+-----+------------</font></div><div><font size="2"   >&nbsp; &nbsp;2 | &nbsp; 1 | &nbsp; 2 | &nbsp; 0.810967</font></div><div><font size="2"   >&nbsp; &nbsp;8 | &nbsp; 7 | &nbsp; 8 | &nbsp; &nbsp; 0.8102</font></div><div><font size="2"   >&nbsp; &nbsp;3 | &nbsp; 2 | &nbsp; 3 | &nbsp; 0.809233</font></div><div><font size="2"   >&nbsp; &nbsp;4 | &nbsp; 3 | &nbsp; 4 | &nbsp; 0.808433</font></div><div><font size="2"   >&nbsp; 10 | &nbsp; 9 | &nbsp;10 | &nbsp; 0.808367</font></div><div><font size="2"   >&nbsp; &nbsp;7 | &nbsp; 6 | &nbsp; 7 | &nbsp; 0.808067</font></div><div><font size="2"   >&nbsp; &nbsp;5 | &nbsp; 4 | &nbsp; 5 | &nbsp; 0.807467</font></div><div><font size="2"   >&nbsp; &nbsp;6 | &nbsp; 5 | &nbsp; 6 | &nbsp; 0.806667</font></div><div><font size="2"   >&nbsp; &nbsp;9 | &nbsp; 8 | &nbsp; 9 | &nbsp; 0.806233</font></div><div><font size="2"   >&nbsp; &nbsp;1 | &nbsp; 0 | &nbsp; 1 | &nbsp; 0.590833</font></div><div><font size="2"   >&nbsp; 11 | &nbsp;10 | &nbsp;11 | &nbsp; 0.588033</font></div><div><font size="2"   >&nbsp;474 | 939 | 474 | 0.00233333</font></div><div><font size="2"   >&nbsp;169 | 348 | 169 | 0.00233333</font></div><div><font size="2"   >&nbsp;138 | 281 | 138 | &nbsp; &nbsp; 0.0023</font></div><div><font size="2"   >&nbsp; 21 | &nbsp;27 | &nbsp;21 | 0.00223333</font></div><div><font size="2"   >&nbsp; 32 | &nbsp;44 | &nbsp;32 | &nbsp; &nbsp; 0.0022</font></div><div><font size="2"   >&nbsp;476 | 942 | 476 | 0.00216667</font></div><div><font size="2"   >&nbsp;296 | 593 | 296 | 0.00216667</font></div><div><font size="2"   >&nbsp;112 | 227 | 112 | 0.00216667</font></div><div><font size="2"   >&nbsp; 56 | 108 | &nbsp;56 | 0.00213333</font></div><div><font size="2"   >(20 rows)</font></div><p></p></pre></div><div>前10完全准确, 但是由于前8的记录数偏差太小, 所以前8的排名顺序可能不准确.</div><div>例如从统计信息中取出的排名 :&nbsp;</div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >&nbsp;rn &nbsp;| ele | rn &nbsp;| &nbsp; &nbsp;freq &nbsp; &nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >-----+-----+-----+------------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp;2 | &nbsp; 1 | &nbsp; 2 | &nbsp; 0.810967</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp;8 | &nbsp; 7 | &nbsp; 8 | &nbsp; &nbsp; 0.8102</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp;3 | &nbsp; 2 | &nbsp; 3 | &nbsp; 0.809233</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp;4 | &nbsp; 3 | &nbsp; 4 | &nbsp; 0.808433</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; 10 | &nbsp; 9 | &nbsp;10 | &nbsp; 0.808367</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp;7 | &nbsp; 6 | &nbsp; 7 | &nbsp; 0.808067</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp;5 | &nbsp; 4 | &nbsp; 5 | &nbsp; 0.807467</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp;6 | &nbsp; 5 | &nbsp; 6 | &nbsp; 0.806667</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp;9 | &nbsp; 8 | &nbsp; 9 | &nbsp; 0.806233</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp;1 | &nbsp; 0 | &nbsp; 1 | &nbsp; 0.590833</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; 11 | &nbsp;10 | &nbsp;11 | &nbsp; 0.588033</font></div><p></p></pre></div></div><div style="line-height: 22px;"   >实际排名 :&nbsp;</div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >&nbsp;appid | count &nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >-------+--------</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp;9 | 872831</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp;6 | 871908</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp;3 | 871867</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp;7 | 871551</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp;8 | 871436</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp;4 | 871391</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp;1 | 871051</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp;5 | 870770</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp;2 | 870692</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; 10 | 435583</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp;0 | 435342</font></div><p></p></pre></div></div><div style="line-height: 22px;"   >非常OK , 这对于大数据的统计来说, 无疑是非常重要的参考.</div><div style="line-height: 22px;"   ><br></div><div>[注意]</div><div>1. 数据统计信息, 占用空间超过<span style="line-height: 22px;"   >ARRAY_WIDTH_THRESHOLD的数组不会进入统计范畴.</span></div><div>src/backend/utils/adt/array_typanalyze.c</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >+/*</font></div><div><font size="2"   >+ * To avoid consuming too much memory, IO and CPU load during analysis, and/or</font></div><div><font size="2"   >+ * too much space in the resulting pg_statistic rows, we ignore arrays that</font></div><div><font size="2"   >+ * are wider than ARRAY_WIDTH_THRESHOLD (after detoasting!). &nbsp;Note that this</font></div><div><font size="2"   >+ * number is considerably more than the similar WIDTH_THRESHOLD limit used</font></div><div><font size="2"   >+ * in analyze.c's standard typanalyze code.</font></div><div><font size="2"   >+ */</font></div><div><font size="2"   >+#define ARRAY_WIDTH_THRESHOLD 0x10000</font></div></div><div><font size="2"   >....</font></div><div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; /* Skip too-large values. */</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; if (toast_raw_datum_size(value) &gt; ARRAY_WIDTH_THRESHOLD)</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; continue;</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; analyzed_rows++;</font></div></div><p></p></pre></div><div><br></div><div>[参考]</div><div>1.&nbsp;<a rel="nofollow" href="http://www.postgresql.org/message-id/flat/E1S408V-0008Ng-A5@gemulon.postgresql.org#E1S408V-0008Ng-A5@gemulon.postgresql.org"   >http://www.postgresql.org/message-id/flat/E1S408V-0008Ng-A5@gemulon.postgresql.org#E1S408V-0008Ng-A5@gemulon.postgresql.org</a></div><div>2.&nbsp;<a rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commitdiff;h=0e5e167aaea4ceb355a6e20eec96c4f7d05527ab"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commitdiff;h=0e5e167aaea4ceb355a6e20eec96c4f7d05527ab</a></div>3.&nbsp;<a rel="nofollow" href="http://www.postgresql.org/docs/devel/static/view-pg-stats.html"   >http://www.postgresql.org/docs/devel/static/view-pg-stats.html</a><div>4.&nbsp;<a rel="nofollow" href="http://www.postgresql.org/docs/devel/static/runtime-config-query.html#GUC-DEFAULT-STATISTICS-TARGET"   >http://www.postgresql.org/docs/devel/static/runtime-config-query.html#GUC-DEFAULT-STATISTICS-TARGET</a></div><div>5.&nbsp;<a rel="nofollow" href="http://www.postgresql.org/docs/devel/static/planner-stats.html"   >http://www.postgresql.org/docs/devel/static/planner-stats.html</a></div><div>6.&nbsp;<a rel="nofollow" href="http://www.postgresql.org/docs/devel/static/row-estimation-examples.html"   >http://www.postgresql.org/docs/devel/static/row-estimation-examples.html</a></div><div>7.&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020124180182088/"   >http://blog.163.com/digoal@126/blog/static/16387704020124180182088/</a></div></div></div>
	</div>
</div>
</body>
</html>