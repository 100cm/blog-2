<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">citusdb's mongo_fdw one query do what?</h2>
	<h5 id="">2013-08-21 10:46:24&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013721103316334/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>在使用pgbench和mongo_fdw测试mongodb数据库性能时, 发现一个mongodb外部表的查询, 在mongodb中查看serverStatus().opcounters发现带来了1个query以及5个左右的command. 而不是1个query, 1个command.</div><div><a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201321984940903/"   >http://blog.163.com/digoal@126/blog/static/163877040201321984940903/</a></div><div>那么到底1个mongo_fdw外部表的查询, 都执行了些啥呢?</div><div>本文将要揭晓这个答案.</div><div>首先要修改mongodb配置文件, 记录日志项, 如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#where to log</font></div><div><font size="2"   >logpath=/tmp/mongo.log</font></div><div><font size="2"   ># Verbose logging output.</font></div><div><font size="2"   >verbose = true</font></div><div><font size="2"   ># Set oplogging level where n is</font></div><div><font size="2"   ># &nbsp; 0=off (default)</font></div><div><font size="2"   ># &nbsp; 1=W</font></div><div><font size="2"   ># &nbsp; 2=R</font></div><div><font size="2"   ># &nbsp; 3=both</font></div><div><font size="2"   ># &nbsp; 7=W+some reads</font></div><div><font size="2"   >diaglog = 3</font></div><p></p></pre></div><div>重启mongodb数据库.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[mongo@db-172-16-3-33 etc]$ mongo 127.0.0.1:5281/admin</font></div><div><font size="2"   >&gt;&nbsp;db.shutdownServer()</font></div><div><font size="2"   >[mongo@db-172-16-3-33 etc]$ numactl --interleave=all mongod -f ./mongod.conf</font></div><p></p></pre></div><div><br></div><div>在数据库中查询外部表 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from f_mongo_test where id=1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;_id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >--------------------------+----+----------------------------------+---------------------</font></div><div><font size="2"   >&nbsp;5213373b09405fb9802e3d91 | &nbsp;1 | 47e77a34c50df1a84b2e08c17c3d2942 | 2013-08-20 14:03:17</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>查看mongodb日志输出 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Wed Aug 21 10:35:52.559 [initandlisten] connection accepted from anonymous unix socket #29 (2 connections now open)</font></div><div><font size="2"   >Wed Aug 21 10:35:52.559 [conn29] run command admin.$cmd { ismaster: 1 }</font></div><div><font size="2"   >Wed Aug 21 10:35:52.559 [conn29] command admin.$cmd command: { ismaster: 1 } ntoreturn:1 keyUpdates:0 &nbsp;reslen:115 0ms</font></div><div><font size="2"   >Wed Aug 21 10:35:52.559 [conn29] run command test.$cmd { count: "mongo_test" }</font></div><div><font size="2"   >Wed Aug 21 10:35:52.559 [conn29] command test.$cmd command: { count: "mongo_test" } ntoreturn:1 keyUpdates:0 locks(micros) r:15 reslen:48 0ms</font></div><div><font size="2"   >Wed Aug 21 10:35:52.559 [conn29] end connection anonymous unix socket (1 connection now open)</font></div><div><font size="2"   >Wed Aug 21 10:35:52.559 [initandlisten] connection accepted from anonymous unix socket #30 (3 connections now open)</font></div><div><font size="2"   >Wed Aug 21 10:35:52.559 [conn30] run command admin.$cmd { ismaster: 1 }</font></div><div><font size="2"   >Wed Aug 21 10:35:52.559 [conn30] command admin.$cmd command: { ismaster: 1 } ntoreturn:1 keyUpdates:0 &nbsp;reslen:115 0ms</font></div><div><font size="2"   >Wed Aug 21 10:35:52.559 [conn30] run command test.$cmd { count: "mongo_test" }</font></div><div><font size="2"   >Wed Aug 21 10:35:52.559 [conn30] command test.$cmd command: { count: "mongo_test" } ntoreturn:1 keyUpdates:0 locks(micros) r:9 reslen:48 0ms</font></div><div><font size="2"   >Wed Aug 21 10:35:52.559 [conn30] end connection anonymous unix socket (1 connection now open)</font></div><div><font size="2"   >Wed Aug 21 10:35:52.559 [initandlisten] connection accepted from anonymous unix socket #31 (2 connections now open)</font></div><div><font size="2"   >Wed Aug 21 10:35:52.559 [conn31] run command admin.$cmd { ismaster: 1 }</font></div><div><font size="2"   >Wed Aug 21 10:35:52.559 [conn31] command admin.$cmd command: { ismaster: 1 } ntoreturn:1 keyUpdates:0 &nbsp;reslen:115 0ms</font></div><div><font size="2"   >Wed Aug 21 10:35:52.560 [conn31] query test.mongo_test query: { id: 1 } ntoreturn:0 ntoskip:0 nscanned:1 keyUpdates:0 locks(micros) r:129 nreturned:1 reslen:111 0ms</font></div><div><font size="2"   >Wed Aug 21 10:35:52.560 [conn31] end connection anonymous unix socket (1 connection now open)</font></div><p></p></pre></div><div><br></div><div>在PostgreSQL中再次查询 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from f_mongo_test where id=2;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;_id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >--------------------------+----+----------------------------------+---------------------</font></div><div><font size="2"   >&nbsp;5213373b09405fb9802e3d92 | &nbsp;2 | 2d94ce6a7c3896b393c79a0b0162b3b2 | 2013-08-20 14:03:17</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>mongodb日志输出 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Wed Aug 21 10:36:08.347 [DataFileSync] flushing mmaps took 0ms &nbsp;for 7 files</font></div><div><font size="2"   >Wed Aug 21 10:36:08.347 [DataFileSync] flushing diag log</font></div><div><font size="2"   >Wed Aug 21 10:36:08.565 [TTLMonitor] query local.system.indexes query: { expireAfterSeconds: { $exists: true } } ntoreturn:0 ntoskip:0 nscanned:0 keyUpdates:0 locks(micros) r:5999 nreturned:0 reslen:20 6ms</font></div><div><font size="2"   >Wed Aug 21 10:36:08.565 [TTLMonitor] query test.system.indexes query: { expireAfterSeconds: { $exists: true } } ntoreturn:0 ntoskip:0 nscanned:2 keyUpdates:0 locks(micros) r:68 nreturned:0 reslen:20 0ms</font></div><div><font size="2"   >Wed Aug 21 10:36:09.263 [initandlisten] connection accepted from anonymous unix socket #32 (2 connections now open)</font></div><div><font size="2"   >Wed Aug 21 10:36:09.263 [conn32] run command admin.$cmd { ismaster: 1 }</font></div><div><font size="2"   >Wed Aug 21 10:36:09.263 [conn32] command admin.$cmd command: { ismaster: 1 } ntoreturn:1 keyUpdates:0 &nbsp;reslen:115 0ms</font></div><div><font size="2"   >Wed Aug 21 10:36:09.263 [conn32] run command test.$cmd { count: "mongo_test" }</font></div><div><font size="2"   >Wed Aug 21 10:36:09.263 [conn32] command test.$cmd command: { count: "mongo_test" } ntoreturn:1 keyUpdates:0 locks(micros) r:20 reslen:48 0ms</font></div><div><font size="2"   >Wed Aug 21 10:36:09.263 [conn32] end connection anonymous unix socket (1 connection now open)</font></div><div><font size="2"   >Wed Aug 21 10:36:09.263 [initandlisten] connection accepted from anonymous unix socket #33 (3 connections now open)</font></div><div><font size="2"   >Wed Aug 21 10:36:09.263 [conn33] run command admin.$cmd { ismaster: 1 }</font></div><div><font size="2"   >Wed Aug 21 10:36:09.263 [conn33] command admin.$cmd command: { ismaster: 1 } ntoreturn:1 keyUpdates:0 &nbsp;reslen:115 0ms</font></div><div><font size="2"   >Wed Aug 21 10:36:09.263 [conn33] run command test.$cmd { count: "mongo_test" }</font></div><div><font size="2"   >Wed Aug 21 10:36:09.263 [conn33] command test.$cmd command: { count: "mongo_test" } ntoreturn:1 keyUpdates:0 locks(micros) r:9 reslen:48 0ms</font></div><div><font size="2"   >Wed Aug 21 10:36:09.263 [conn33] end connection anonymous unix socket (1 connection now open)</font></div><div><font size="2"   >Wed Aug 21 10:36:09.263 [initandlisten] connection accepted from anonymous unix socket #34 (2 connections now open)</font></div><div><font size="2"   >Wed Aug 21 10:36:09.264 [conn34] run command admin.$cmd { ismaster: 1 }</font></div><div><font size="2"   >Wed Aug 21 10:36:09.264 [conn34] command admin.$cmd command: { ismaster: 1 } ntoreturn:1 keyUpdates:0 &nbsp;reslen:115 0ms</font></div><div><font size="2"   >Wed Aug 21 10:36:09.264 [conn34] query test.mongo_test query: { id: 2 } ntoreturn:0 ntoskip:0 nscanned:1 keyUpdates:0 locks(micros) r:79 nreturned:1 reslen:111 0ms</font></div><div><font size="2"   >Wed Aug 21 10:36:09.264 [conn34] end connection anonymous unix socket (1 connection now open)</font></div><p></p></pre></div></div><div>从以上日志可以看到.</div><div><span style="line-height: 22px;"   >一次mongo_fdw外部表查询, 在mongodb中一共需要建立和断开3次连接, 同时调用了3次ismaster的命令以及2次被查表的count计数查询. 最后才是真正和SQL有关的查询(db.mongo_test.find{id: 1}).</span></div><div><span style="line-height: 22px;"   >所以说使用mongo_fdw来压mongodb的性能是不可取的.&nbsp;</span></div><div><span style="line-height: 22px;"   >除非去掉这些command, 同时使用mongodb连接池.</span></div><div>如何去除这些没有必要的command, 参考下一篇blog :&nbsp;</div><div><a href="http://blog.163.com/digoal@126/blog/static/16387704020137211111138/"   >http://blog.163.com/digoal@126/blog/static/16387704020137211111138/</a></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201372011056128/"   >http://blog.163.com/digoal@126/blog/static/163877040201372011056128/</a></div><div>2.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020137218443650/"   >http://blog.163.com/digoal@126/blog/static/16387704020137218443650/</a></div><div>3.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020137204136657/"   >http://blog.163.com/digoal@126/blog/static/16387704020137204136657/</a></div><div>4.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201321984940903/"   >http://blog.163.com/digoal@126/blog/static/163877040201321984940903/</a></div></div>
	</div>
</div>
</body>
</html>