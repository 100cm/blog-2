<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL fail-back able stream replication configuration</h2>
	<h5 id="">2013-08-08 10:56:01&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020137894542352/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>几天前测试过一个PostgreSQL 的fail-back补丁, 发现fail-back未成功,&nbsp;</div><div><a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020137551911457/"   >http://blog.163.com/digoal@126/blog/static/16387704020137551911457/</a></div><div>这个bug实际上是另一个补丁引起的.</div><div><a rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=91c3613d3748d881706c3e60d8221ea92833ac1a"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=91c3613d3748d881706c3e60d8221ea92833ac1a</a></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Fix assertion failure by an immediate shutdown.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >In PM_WAIT_DEAD_END state, checkpointer process must be dead already.</font></div><div><font size="2"   >But an immediate shutdown could make postmaster's state machine</font></div><div><font size="2"   >transition to PM_WAIT_DEAD_END state even if checkpointer process is</font></div><div><font size="2"   >still running, &nbsp;and which caused assertion failure. This bug was introduced</font></div><div><font size="2"   >in commit 457d6cf049c57cabe9b46ea13f26138040a214ec.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >This patch ensures that postmaster's state machine doesn't transition to</font></div><div><font size="2"   >PM_WAIT_DEAD_END state in an immediate shutdown while checkpointer</font></div><div><font size="2"   >process is running.</font></div><p></p></pre></div><div>因为切换时用到了stop -m immediate.</div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >fail-back的这个补丁实际上还是有效的. 因为它解决了以下问题 :&nbsp;</span></div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >&gt;You mean to make the master wait the data page write until WAL has been&nbsp;<span style="line-height: 22px;"   >not only</span></font></div><div style="line-height: 22px;"   ><font size="2"   >&gt;flushed to disk but also replicated to the standby?</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;Yes. Master should not write the data page before corresponding WAL</font></div><div style="line-height: 22px;"   ><font size="2"   >records have been replicated to the standby. The WAL records have been</font></div><div style="line-height: 22px;"   ><font size="2"   >flushed to disk on both master and standby.</font></div><p></p></pre></div></div><div style="line-height: 22px;"   >使用这个src snapshot.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ]# tar -zxvf postgresql-91c3613.tar.gz</font></div><div><font size="2"   >[root@db-172-16-3-39 ]# cd postgresql-91c3613</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-39 postgresql-91c3613]# patch -p1 &lt; ../postgresql-e5592c6/failback_safe_standby_v4.patch&nbsp;</font></div><div><font size="2"   >patching file src/backend/access/transam/clog.c</font></div><div><font size="2"   >patching file src/backend/access/transam/slru.c</font></div><div><font size="2"   >patching file src/backend/access/transam/twophase.c</font></div><div><font size="2"   >patching file src/backend/access/transam/xact.c</font></div><div><font size="2"   >patching file src/backend/access/transam/xlog.c</font></div><div><font size="2"   >Hunk #1 succeeded at 1209 (offset -15 lines).</font></div><div><font size="2"   >Hunk #2 succeeded at 2991 (offset -5 lines).</font></div><div><font size="2"   >Hunk #3 succeeded at 3119 (offset -15 lines).</font></div><div><font size="2"   >Hunk #4 succeeded at 8228 (offset -4 lines).</font></div><div><font size="2"   >Hunk #5 succeeded at 8379 (offset -15 lines).</font></div><div><font size="2"   >patching file src/backend/catalog/storage.c</font></div><div><font size="2"   >patching file src/backend/replication/syncrep.c</font></div><div><font size="2"   >patching file src/backend/storage/buffer/bufmgr.c</font></div><div><font size="2"   >patching file src/backend/utils/cache/relmapper.c</font></div><div><font size="2"   >Hunk #1 succeeded at 774 (offset 53 lines).</font></div><div><font size="2"   >patching file src/backend/utils/misc/guc.c</font></div><div><font size="2"   >Hunk #2 succeeded at 3302 (offset 13 lines).</font></div><div><font size="2"   >patching file src/backend/utils/misc/postgresql.conf.sample</font></div><div><font size="2"   >patching file src/backend/utils/time/tqual.c</font></div><div><font size="2"   >Hunk #1 succeeded at 60 (offset -2 lines).</font></div><div><font size="2"   >Hunk #2 succeeded at 118 (offset -1 lines).</font></div><div><font size="2"   >patching file src/include/access/xlog.h</font></div><div><font size="2"   >patching file src/include/replication/syncrep.h</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-39 postgresql-91c3613]# ./configure --prefix=/home/pg94/pgsql9.4devel --with-pgport=2999 --with-perl --with-tcl --with-python --with-openssl --with-pam --without-ldap --with-libxml --with-libxslt --enable-thread-safety --with-wal-blocksize=16 &amp;&amp; gmake &amp;&amp; gmake install</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-39 postgresql-91c3613]# cd contrib/</font></div><div><font size="2"   >[root@db-172-16-3-39 postgresql-91c3613]# gmake &amp;&amp; gmake install</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg94@db-172-16-3-39-&gt; initdb -D $PGDATA -E UTF8 --locale=C -W -U postgres -k</font></div><p></p></pre></div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   >本文将分几个常见重新测试 &nbsp;:&nbsp;</div><div style="line-height: 22px;"   >一.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >synchronous_commit = remote_write</font></div><div><font size="2"   >synchronous_transfer = all</font></div><div><font size="2"   >fail-back成功.</font></div><div><font size="2"   >使用这种配置, 在master节点stop -m immediate后, &nbsp;standby promote, 最后成功的完成了master节点的fail-back.&nbsp;</font></div><div><div><font size="2"   >pg94@db-172-16-3-33-&gt; pgbench -M prepared -f ./test.sql -r -n -h $PGDATA -p 2999 -U postgres -c 16 -j 4 -T 10 --progress=1 digoal</font></div><div><font size="2"   >progress: 1.0 s, 4996.2 tps, 3.202 ms lat</font></div><div><font size="2"   >progress: 2.0 s, 13594.8 tps, 1.177 ms lat</font></div><div><font size="2"   >progress: 3.0 s, 8177.5 tps, 1.957 ms lat</font></div><div><font size="2"   >progress: 4.0 s, 16563.1 tps, 0.966 ms lat</font></div><div><font size="2"   >progress: 5.0 s, 9317.0 tps, 1.717 ms lat</font></div><div><font size="2"   >progress: 6.0 s, 2228.6 tps, 7.179 ms lat</font></div><div><font size="2"   >progress: 7.0 s, 2128.4 tps, 7.517 ms lat</font></div><div><font size="2"   >progress: 8.0 s, 14069.0 tps, 1.137 ms lat</font></div><div><font size="2"   >progress: 9.0 s, 13270.4 tps, 1.206 ms lat</font></div><div><font size="2"   >progress: 10.0 s, 2715.9 tps, 5.891 ms lat</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 10 s</font></div><div><font size="2"   >number of transactions actually processed: 87190</font></div><div><font size="2"   >tps = 8708.791555 (including connections establishing)</font></div><div><font size="2"   >tps = 8728.552746 (excluding connections establishing)</font></div></div><p></p></pre></div><div><br></div><div>二.</div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><div style="line-height: 22px;"   ><font size="2"   >synchronous_commit = off</font></div><div style="line-height: 22px;"   ><font size="2"   >synchronous_transfer = all</font></div></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >使用这种配置, fail-back失败.&nbsp;</font></span></div><div style="line-height: 22px;"   ><font size="2"   ><span style="line-height: 22px;"   >原因在于</span><span style="line-height: 22px;"   >synchronous_commit = off, xlog flush前不需要等待远程节点接收到xlog信息的反馈.</span></font></div><div><div><font size="2"   >pg94@db-172-16-3-39-&gt; pgbench -M prepared -f ./test.sql -r -n -h $PGDATA -p 2999 -U postgres -c 16 -j 4 -T 10 --progress=1 digoal</font></div><div><font size="2"   >progress: 1.0 s, 30353.8 tps, 0.527 ms lat</font></div><div><font size="2"   >progress: 2.0 s, 40421.5 tps, 0.396 ms lat</font></div><div><font size="2"   >progress: 3.0 s, 43310.1 tps, 0.369 ms lat</font></div><div><font size="2"   >progress: 4.0 s, 43606.8 tps, 0.367 ms lat</font></div><div><font size="2"   >progress: 5.0 s, 44466.9 tps, 0.360 ms lat</font></div><div><font size="2"   >progress: 6.0 s, 44329.6 tps, 0.361 ms lat</font></div><div><font size="2"   >progress: 7.0 s, 45618.9 tps, 0.351 ms lat</font></div><div><font size="2"   >progress: 8.0 s, 44800.0 tps, 0.357 ms lat</font></div><div><font size="2"   >progress: 9.0 s, 44561.3 tps, 0.359 ms lat</font></div><div><font size="2"   >progress: 10.0 s, 45660.3 tps, 0.350 ms lat</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 10 s</font></div><div><font size="2"   >number of transactions actually processed: 427175</font></div><div><font size="2"   >tps = 42693.877478 (including connections establishing)</font></div><div><font size="2"   >tps = 42769.866355 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.371739 &nbsp; &nbsp; &nbsp; &nbsp;select func();</font></div></div><p></p></pre></div></div><div>三.</div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><div style="line-height: 22px;"   ><font size="2"   >synchronous_commit = remote_write</font></div><div style="line-height: 22px;"   ><font size="2"   >synchronous_transfer = data_flush</font></div></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >使用这种配置, fail-back失败.&nbsp;</font></span></div><div style="line-height: 22px;"   ><font size="2"   ><span style="line-height: 22px;"   >原因在于</span><span style="line-height: 22px;"   >synchronous_transfer = data_flush</span><span style="line-height: 22px;"   >, 因为提交状态不需要等待远程节点的反馈.&nbsp;</span></font></div></div><div><div><font size="2"   >pg94@db-172-16-3-39-&gt; pgbench -M prepared -f ./test.sql -r -n -h $PGDATA -p 2999 -U postgres -c 16 -j 4 -T 10 --progress=1 digoal</font></div><div><font size="2"   >progress: 1.0 s, 11883.3 tps, 1.346 ms lat</font></div><div><font size="2"   >progress: 2.0 s, 14745.8 tps, 1.085 ms lat</font></div><div><font size="2"   >progress: 3.0 s, 18044.3 tps, 0.887 ms lat</font></div><div><font size="2"   >progress: 4.0 s, 17891.5 tps, 0.894 ms lat</font></div><div><font size="2"   >progress: 5.0 s, 19712.9 tps, 0.812 ms lat</font></div><div><font size="2"   >progress: 6.0 s, 21122.7 tps, 0.757 ms lat</font></div><div><font size="2"   >progress: 7.0 s, 20677.3 tps, 0.774 ms lat</font></div><div><font size="2"   >progress: 8.0 s, 20585.9 tps, 0.777 ms lat</font></div><div><font size="2"   >progress: 9.0 s, 22592.0 tps, 0.708 ms lat</font></div><div><font size="2"   >progress: 10.0 s, 22884.6 tps, 0.699 ms lat</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 10 s</font></div><div><font size="2"   >number of transactions actually processed: 190163</font></div><div><font size="2"   >tps = 19003.894258 (including connections establishing)</font></div><div><font size="2"   >tps = 19036.122314 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.837460 &nbsp; &nbsp; &nbsp; &nbsp;select func();</font></div></div><p></p></pre></div></div><div><br></div><div>四.</div><div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >synchronous_commit = remote_write</font></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >synchronous_standby_names = '*'</font></span></div><div style="line-height: 22px;"   ><font size="2"   >synchronous_transfer = data_flush</font></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   ><span style="line-height: 22px;"   >synchronous_standby_names节点</span>fail-back成功.</font></div><div style="line-height: 22px;"   ><font size="2"   >使用这种配置, 在master节点stop -m immediate后, &nbsp;standby promote, 最后成功的完成了master节点的fail-back.&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >因为<span style="line-height: 22px;"   >synchronous_standby_names节点commit信息的xlog信息需要等待standby节点的反馈, 同时又配置了</span><span style="line-height: 22px;"   >synchronous_transfer</span><span style="line-height: 22px;"   >&nbsp;= data_flush. 所以可以fail-back.</span></font></div></div></div><div><div><div><font size="2"   >pg94@db-172-16-3-33-&gt; pgbench -M prepared -f ./test.sql -r -n -h $PGDATA -p 2999 -U postgres -c 16 -j 4 -T 10 --progress=1 digoal</font></div><div><font size="2"   >progress: 1.1 s, 4081.8 tps, 3.920 ms lat</font></div><div><font size="2"   >progress: 2.0 s, 6884.0 tps, 2.324 ms lat</font></div><div><font size="2"   >progress: 3.0 s, 6905.0 tps, 2.317 ms lat</font></div><div><font size="2"   >progress: 4.0 s, 8633.6 tps, 1.853 ms lat</font></div><div><font size="2"   >progress: 5.0 s, 9102.9 tps, 1.758 ms lat</font></div><div><font size="2"   >progress: 6.0 s, 11641.0 tps, 1.374 ms lat</font></div><div><font size="2"   >progress: 7.0 s, 9036.4 tps, 1.771 ms lat</font></div><div><font size="2"   >progress: 8.0 s, 11832.6 tps, 1.352 ms lat</font></div><div><font size="2"   >progress: 9.0 s, 8994.9 tps, 1.779 ms lat</font></div><div><font size="2"   >progress: 10.0 s, 12888.9 tps, 1.241 ms lat</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 10 s</font></div><div><font size="2"   >number of transactions actually processed: 89877</font></div><div><font size="2"   >tps = 8981.651756 (including connections establishing)</font></div><div><font size="2"   >tps = 9001.796363 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.774194 &nbsp; &nbsp; &nbsp; &nbsp;select func();</font></div></div></div><p></p></pre></div></div></div><div><br></div><div>五.</div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><div style="line-height: 22px;"   ><font size="2"   >synchronous_commit = remote_write</font></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >synchronous_standby_names = '*'</font></span></div><div style="line-height: 22px;"   ><font size="2"   >synchronous_transfer = commit</font></div></div><div style="line-height: 22px;"   ><font size="2"   ><span style="line-height: 22px;"   >synchronous_standby_names节点</span><span style="line-height: 22px;"   >fail-back成功.</span></font></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >使用这种配置, 在master节点stop -m immediate后, &nbsp;standby promote, 最后成功的完成了master节点的fail-back.&nbsp;</font></div><div style="line-height: 22px;"   ><font size="2"   >某些情况可能失败. 就是补丁中提到的</font></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >&gt;You mean to make the master wait the data page write until WAL has been&nbsp;<span style="line-height: 22px;"   >not only</span></font></div><div style="line-height: 22px;"   ><font size="2"   >&gt;flushed to disk but also replicated to the standby?</font></div></div></div><div><div><font size="2"   >pg94@db-172-16-3-39-&gt; pgbench -M prepared -f ./test.sql -r -n -h $PGDATA -p 2999 -U postgres -c 16 -j 4 -T 10 --progress=1 digoal</font></div><div><font size="2"   >progress: 1.0 s, 8192.0 tps, 1.953 ms lat</font></div><div><font size="2"   >progress: 2.0 s, 11442.8 tps, 1.398 ms lat</font></div><div><font size="2"   >progress: 3.0 s, 8907.9 tps, 1.796 ms lat</font></div><div><font size="2"   >progress: 4.0 s, 11571.7 tps, 1.383 ms lat</font></div><div><font size="2"   >progress: 5.2 s, 9421.1 tps, 1.698 ms lat</font></div><div><font size="2"   >progress: 6.0 s, 10646.7 tps, 1.503 ms lat</font></div><div><font size="2"   >progress: 7.0 s, 12180.4 tps, 1.314 ms lat</font></div><div><font size="2"   >progress: 8.0 s, 10138.0 tps, 1.578 ms lat</font></div><div><font size="2"   >progress: 9.1 s, 8649.3 tps, 1.850 ms lat</font></div><div><font size="2"   >progress: 10.0 s, 13784.1 tps, 1.161 ms lat</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 10 s</font></div><div><font size="2"   >number of transactions actually processed: 104424</font></div><div><font size="2"   >tps = 10436.464782 (including connections establishing)</font></div><div><font size="2"   >tps = 10453.188998 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1.527362 &nbsp; &nbsp; &nbsp; &nbsp;select func();</font></div></div><p></p></pre></div></div><div><br></div><div><span style="line-height: 22px;"   >[小结]</span></div><div>1. 为了能够实现fail-back, 主节点的配置至少包含如下级别的配置.</div><div><div style="line-height: 22px;"   >synchronous_commit = remote_write | on</div><div style="line-height: 22px;"   >synchronous_transfer = all</div></div><div style="line-height: 22px;"   >但是性能影响就比较大, 因为xlog flush无法使用异步模式.</div><div style="line-height: 22px;"   >或者开启同步复制模式.</div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=91c3613d3748d881706c3e60d8221ea92833ac1a"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=91c3613d3748d881706c3e60d8221ea92833ac1a</a></div><div>2.&nbsp;<a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/16387704020137551911457/"   >http://blog.163.com/digoal@126/blog/static/16387704020137551911457/</a></div><div>3.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.postgresql.org/message-id/flat/CAF8Q-Gxg3PQTf71NVECe-6OzRaew5pWhk7yQtbJgWrFu513s+Q@mail.gmail.com#CAF8Q-Gxg3PQTf71NVECe-6OzRaew5pWhk7yQtbJgWrFu513s+Q@mail.gmail.com"   >http://www.postgresql.org/message-id/flat/CAF8Q-Gxg3PQTf71NVECe-6OzRaew5pWhk7yQtbJgWrFu513s+Q@mail.gmail.com#CAF8Q-Gxg3PQTf71NVECe-6OzRaew5pWhk7yQtbJgWrFu513s+Q@mail.gmail.com</a></div></div>
	</div>
</div>
</body>
</html>