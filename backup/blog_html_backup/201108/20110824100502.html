<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL advisory locks</h2>
	<h5 id="">2011-08-24 10:05:02&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201172492217830/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL 9.1 新增了一个事务级的advisory lock，原来只有SESSION级的。</div><div>事务级别的advisory lock不能显性的释放。</div><div>advisory lock和系统的MVCC不是一个概念，基本上完全不相干。锁的数量由&nbsp;<span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  ><a style="color: rgb(0, 102, 162); text-decoration: underline; " rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/runtime-config-locks.html#GUC-MAX-LOCKS-PER-TRANSACTION"  >max_locks_per_transaction</a>&nbsp;and&nbsp;<a style="color: rgb(0, 102, 162); text-decoration: underline; " rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/runtime-config-connection.html#GUC-MAX-CONNECTIONS"  >max_connections</a>&nbsp;决定。</span></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 18px;"  >advisory lock可以在pg_locks视图里面看到。</span></font></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 18px;"  >SESSION级的advisory lock一旦获取，需要手工释放或者SESSION 结束后自动释放。SESSION级别的advisory lock还有一个和事务锁不一样的风格。</span></font></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 18px;"  >如:</span></font></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 18px;"  >1. 在一个begin; end;之间获取SESSION级别的advisory lock时，事务被回滚</span></font><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >或者事务FAILED</span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >的话SESSION advisory锁不会被回滚。</span></div><div><pre class="prettyprint"  ><p></p><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >digoal=&gt; begin;</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >BEGIN</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >digoal=&gt; select pg_advisory_lock(1);</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >&nbsp;pg_advisory_lock&nbsp;</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >------------------</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >&nbsp;</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >(1 row)</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  ><br></span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >digoal=&gt; rollback;</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >ROLLBACK</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >digoal=&gt; select * from pg_locks where objid=1;</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >&nbsp;locktype | database | relation | page | tuple | virtualxid | transactionid | classid | objid | objsubid | virtualtransaction | &nbsp;pid</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >&nbsp; | &nbsp; &nbsp; mode &nbsp; &nbsp; &nbsp;| granted&nbsp;</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >----------+----------+----------+------+-------+------------+---------------+---------+-------+----------+--------------------+-----</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >--+---------------+---------</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >&nbsp;advisory | &nbsp; &nbsp;16386 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp;1 | 2/9186 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2598</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >8 | ExclusiveLock | t</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >(1 row)</span></font></div><p></p></pre></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  ><br></span></font></div><div><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >2. 在一个begin; end;之间释放SESSION级别的advisory lock时，事务被回滚或者事务FAILED的话SESSION advisory锁仍被释放。</span></div><div><pre class="prettyprint"  ><p></p><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >digoal=&gt; select pg_advisory_lock(1);</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >&nbsp;pg_advisory_lock&nbsp;</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >------------------</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >&nbsp;</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >(1 row)</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  ><br></span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >digoal=&gt; begin;</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >BEGIN</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >digoal=&gt; select pg_advisory_unlock(1);</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >&nbsp;pg_advisory_unlock&nbsp;</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >--------------------</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >&nbsp;t</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >(1 row)</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  ><br></span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >digoal=&gt; rollback;</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >ROLLBACK</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >digoal=&gt; select * from pg_locks where objid=1;</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >&nbsp;locktype | database | relation | page | tuple | virtualxid | transactionid | classid | objid | objsubid | virtualtransaction | pid&nbsp;</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >| mode | granted&nbsp;</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >----------+----------+----------+------+-------+------------+---------------+---------+-------+----------+--------------------+-----</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >+------+---------</span></font></div><div><font face="verdana, sans-serif"  size="2"  ><span style="line-height: 19px;"  >(0 rows)</span></font></div><p></p></pre></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  ><br></span></font></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  >3. 同一个session 级别的advisory lock可以在一个SESSION里面多次获取，但是释放也要多次释放。</span></font></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  >如下，获取两次，释放两次。</span></font></div><div><font face="verdana, sans-serif"  ><div><pre class="prettyprint"  ><p></p><div style="line-height: 19px;"  ><font size="2"  >digoal=&gt; select pg_advisory_lock(1);</font></div><div style="line-height: 19px;"  ><font size="2"  >&nbsp;pg_advisory_lock&nbsp;</font></div><div style="line-height: 19px;"  ><font size="2"  >------------------</font></div><div style="line-height: 19px;"  ><font size="2"  >&nbsp;</font></div><div style="line-height: 19px;"  ><font size="2"  >(1 row)</font></div><div style="line-height: 19px;"  ><font size="2"  ><br></font></div><div style="line-height: 19px;"  ><font size="2"  >digoal=&gt; select pg_advisory_lock(1);</font></div><div style="line-height: 19px;"  ><font size="2"  >&nbsp;pg_advisory_lock&nbsp;</font></div><div style="line-height: 19px;"  ><font size="2"  >------------------</font></div><div style="line-height: 19px;"  ><font size="2"  >&nbsp;</font></div><div style="line-height: 19px;"  ><font size="2"  >(1 row)</font></div><div style="line-height: 19px;"  ><font size="2"  ><br></font></div><div style="line-height: 19px;"  ><font size="2"  >digoal=&gt; select pg_advisory_unlock(1);</font></div><div style="line-height: 19px;"  ><font size="2"  >&nbsp;pg_advisory_unlock&nbsp;</font></div><div style="line-height: 19px;"  ><font size="2"  >--------------------</font></div><div style="line-height: 19px;"  ><font size="2"  >&nbsp;t</font></div><div style="line-height: 19px;"  ><font size="2"  >(1 row)</font></div><div style="line-height: 19px;"  ><font size="2"  ><br></font></div><div style="line-height: 19px;"  ><font size="2"  >digoal=&gt; select * from pg_locks where objid=1;</font></div><div style="line-height: 19px;"  ><font size="2"  >&nbsp;locktype | database | relation | page | tuple | virtualxid | transactionid | classid | objid | objsubid | virtualtransaction | &nbsp;pid</font></div><div style="line-height: 19px;"  ><font size="2"  >&nbsp; | &nbsp; &nbsp; mode &nbsp; &nbsp; &nbsp;| granted&nbsp;</font></div><div style="line-height: 19px;"  ><font size="2"  >----------+----------+----------+------+-------+------------+---------------+---------+-------+----------+--------------------+-----</font></div><div style="line-height: 19px;"  ><font size="2"  >--+---------------+---------</font></div><div style="line-height: 19px;"  ><font size="2"  >&nbsp;advisory | &nbsp; &nbsp;16386 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp;1 | 2/9198 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2598</font></div><div style="line-height: 19px;"  ><font size="2"  >8 | ExclusiveLock | t</font></div><div style="line-height: 19px;"  ><font size="2"  >(1 row)</font></div><div style="line-height: 19px;"  ><font size="2"  ><br></font></div><div style="line-height: 19px;"  ><font size="2"  >digoal=&gt; select pg_advisory_unlock(1);</font></div><div style="line-height: 19px;"  ><font size="2"  >&nbsp;pg_advisory_unlock&nbsp;</font></div><div style="line-height: 19px;"  ><font size="2"  >--------------------</font></div><div style="line-height: 19px;"  ><font size="2"  >&nbsp;t</font></div><div style="line-height: 19px;"  ><font size="2"  >(1 row)</font></div><div style="line-height: 19px;"  ><font size="2"  ><br></font></div><div style="line-height: 19px;"  ><font size="2"  >digoal=&gt; select * from pg_locks where objid=1;</font></div><div style="line-height: 19px;"  ><font size="2"  >&nbsp;locktype | database | relation | page | tuple | virtualxid | transactionid | classid | objid | objsubid | virtualtransaction | pid&nbsp;</font></div><div style="line-height: 19px;"  ><font size="2"  >| mode | granted&nbsp;</font></div><div style="line-height: 19px;"  ><font size="2"  >----------+----------+----------+------+-------+------------+---------------+---------+-------+----------+--------------------+-----</font></div><div style="line-height: 19px;"  ><font size="2"  >+------+---------</font></div><div style="line-height: 19px;"  ><font size="2"  >(0 rows)</font></div><p></p></pre></div><div style="font-size: 12px; line-height: 19px;"  ><br></div><div style="font-size: 12px; line-height: 19px;"  >4. session和transaction 级别的lock在同一个SESSION中共用锁空间，所以在TRANSACTION中获取到了锁，在同一个SESSION中也可以获取到。另一个SESSION就获取不到。TRANSACTION ADVISORY LOCK不可以显性释放，会自动在事务结束（包含提交或回滚，正常或不正常）后释放。</div><div style="font-size: 12px; line-height: 19px;"  >如下</div><div style="font-size: 12px; line-height: 19px;"  >SESSION A：</div><div><div><pre class="prettyprint"  ><p></p><div><span style="line-height: 19px;"  ><font size="2"  >digoal=&gt; begin;</font></span></div><div><span style="line-height: 19px;"  ><font size="2"  >BEGIN</font></span></div><div><span style="line-height: 19px;"  ><font size="2"  >digoal=&gt; select pg_advisory_xact_lock(1);</font></span></div><div><span style="line-height: 19px;"  ><font size="2"  >&nbsp;pg_advisory_xact_lock&nbsp;</font></span></div><div><span style="line-height: 19px;"  ><font size="2"  >-----------------------</font></span></div><div><span style="line-height: 19px;"  ><font size="2"  >&nbsp;</font></span></div><div><span style="line-height: 19px;"  ><font size="2"  >(1 row)</font></span></div><p></p></pre></div><div><span style="font-size: 12px; line-height: 19px;"  >这里获取到事务级的ADVISORY 锁。</span></div><div><span style="font-size: 12px; line-height: 19px;"  ><br></span></div><div><pre class="prettyprint"  ><p></p><div><span style="line-height: 19px;"  ><font size="2"  >digoal=&gt; select pg_advisory_lock(1);</font></span></div><div><span style="line-height: 19px;"  ><font size="2"  >&nbsp;pg_advisory_lock&nbsp;</font></span></div><div><span style="line-height: 19px;"  ><font size="2"  >------------------</font></span></div><div><span style="line-height: 19px;"  ><font size="2"  >&nbsp;</font></span></div><div><span style="line-height: 19px;"  ><font size="2"  >(1 row)</font></span></div><p></p></pre></div><div><span style="font-size: 12px; line-height: 19px;"  >这里获取到SESSION ADVISORY LOCK。</span></div><div><span style="font-size: 12px; line-height: 19px;"  ><br></span></div><div><pre class="prettyprint"  ><p></p><div><span style="line-height: 19px;"  ><font size="2"  >digoal=&gt; end;</font></span></div><div><span style="line-height: 19px;"  ><font size="2"  >COMMIT</font></span></div><p></p></pre></div><div><span style="font-size: 12px; line-height: 19px;"  >这里自动释放了TRANSACTION ADVISORY LOCK。</span></div><div><span style="font-size: 12px; line-height: 19px;"  >SESSION B:</span></div><div><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt; select pg_advisory_lock(1);</font></p></pre></div><div><span style="font-size: 12px; line-height: 19px;"  >等待中。。。</span></div><div><span style="font-size: 12px; line-height: 19px;"  ><br></span></div><div><span style="font-size: 12px; line-height: 19px;"  >SESSION A:</span></div><div><pre class="prettyprint"  ><p></p><div><span style="line-height: 19px;"  ><font size="2"  >digoal=&gt; select * from pg_locks where objid=1;</font></span></div><div><span style="line-height: 19px;"  ><font size="2"  >&nbsp;locktype | database | relation | page | tuple | virtualxid | transactionid | classid | objid | objsubid | virtualtransaction | &nbsp;pid</font></span></div><div><span style="line-height: 19px;"  ><font size="2"  >&nbsp; | &nbsp; &nbsp; mode &nbsp; &nbsp; &nbsp;| granted&nbsp;</font></span></div><div><span style="line-height: 19px;"  ><font size="2"  >----------+----------+----------+------+-------+------------+---------------+---------+-------+----------+--------------------+-----</font></span></div><div><span style="line-height: 19px;"  ><font size="2"  >--+---------------+---------</font></span></div><div><span style="line-height: 19px;"  ><font size="2"  >&nbsp;advisory | &nbsp; &nbsp;16386 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp;1 | 2/9202 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2598</font></span></div><div><span style="line-height: 19px;"  ><font size="2"  >8 | ExclusiveLock | t</font></span></div><div><span style="line-height: 19px;"  ><font size="2"  >&nbsp;advisory | &nbsp; &nbsp;16386 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp;1 | 4/76 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2645</font></span></div><div><span style="line-height: 19px;"  ><font size="2"  >0 | ExclusiveLock | f</font></span></div><div><span style="line-height: 19px;"  ><font size="2"  >(2 rows)</font></span></div><p></p></pre></div><div><span style="font-size: 12px; line-height: 19px;"  >看到SESSION B在等待这个锁。</span></div><div><span style="font-size: 12px; line-height: 19px;"  ><br></span></div><div><pre class="prettyprint"  ><p></p><div><span style="line-height: 19px;"  ><font size="2"  >digoal=&gt; select pg_advisory_unlock(1);</font></span></div><div><span style="line-height: 19px;"  ><font size="2"  >&nbsp;pg_advisory_unlock&nbsp;</font></span></div><div><span style="line-height: 19px;"  ><font size="2"  >--------------------</font></span></div><div><span style="line-height: 19px;"  ><font size="2"  >&nbsp;t</font></span></div><div><span style="line-height: 19px;"  ><font size="2"  >(1 row)</font></span></div><p></p></pre></div><div><span style="font-size: 12px; line-height: 19px;"  >这里释放了SESSION A 的SESSION ADVISORY LOCK。</span></div></div></font><span style="font-family: verdana, sans-serif;"  ><div style="line-height: 19px; font-size: 12px;"  ><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 19px;"  ><br></span></div></span><pre class="prettyprint"  ><p><font size="2"  ><span style="font-family: verdana, sans-serif; line-height: 19px;"  >digoal=&gt; select * from pg_locks where objid=1;</span><font face="verdana, sans-serif"  ></font></font></p><div><div><font face="verdana, sans-serif"  ><span style="line-height: 19px;"  ><font size="2"  >&nbsp;locktype | database | relation | page | tuple | virtualxid | transactionid | classid | objid | objsubid | virtualtransaction | &nbsp;pid</font></span></font></div><div><font face="verdana, sans-serif"  ><span style="line-height: 19px;"  ><font size="2"  >&nbsp; | &nbsp; &nbsp; mode &nbsp; &nbsp; &nbsp;| granted&nbsp;</font></span></font></div><div><font face="verdana, sans-serif"  ><span style="line-height: 19px;"  ><font size="2"  >----------+----------+----------+------+-------+------------+---------------+---------+-------+----------+--------------------+-----</font></span></font></div><div><font face="verdana, sans-serif"  ><span style="line-height: 19px;"  ><font size="2"  >--+---------------+---------</font></span></font></div><div><font face="verdana, sans-serif"  ><span style="line-height: 19px;"  ><font size="2"  >&nbsp;advisory | &nbsp; &nbsp;16386 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; 1 | &nbsp; &nbsp; &nbsp; &nbsp;1 | 4/0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2645</font></span></font></div><div><font face="verdana, sans-serif"  ><span style="line-height: 19px;"  ><font size="2"  >0 | ExclusiveLock | t</font></span></font></div><div><font face="verdana, sans-serif"  ><span style="line-height: 19px;"  ><font size="2"  >(1 row)</font></span></font></div></div><p></p></pre><font face="verdana, sans-serif"  ><div><span style="font-size: 12px; line-height: 19px;"  >可以看到B已经获得了这个锁。</span></div><div><span style="font-size: 12px; line-height: 19px;"  ><br></span></div><div><span style="font-size: 12px; line-height: 19px;"  >由于advisory lock和MVCC不相干。所以不存在和MVCC锁的冲突。适合特殊场景的应用，降低锁冲突或者长时间持锁带来的数据库（如VACUUM释放空间,这个我很久前的BLOG有写过）压力。</span></div><div><span style="font-size: 12px; line-height: 19px;"  ><br></span></div><div><span style="font-size: 12px; line-height: 19px;"  >advisory lock的应用场景举例(应用控制的锁)：</span></div><div><span style="font-size: 12px; line-height: 19px;"  >比如数据库里面存储了文件和ID的对应关系，应用程序需要长时间得获得一个锁，然后对文件进行修改，再释放锁。</span></div><div><span style="font-size: 12px; line-height: 19px;"  >测试数据:</span></div><div><pre class="prettyprint"  ><p></p><div><span style="line-height: 19px;"  ><font size="2"  >digoal=&gt; create table tbl_file_info (id int primary key,file_path text);</font></span></div><div><span style="line-height: 19px;"  ><font size="2"  >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "tbl_file_info_pkey" for table "tbl_file_info"</font></span></div><div><span style="line-height: 19px;"  ><font size="2"  >CREATE TABLE</font></span></div><div><span style="line-height: 19px;"  ><font size="2"  >digoal=&gt; insert into tbl_file_info values (1,'/home/postgres/advisory_lock_1.txt');</font></span></div><div><span style="line-height: 19px;"  ><font size="2"  >INSERT 0 1</font></span></div><div><span style="line-height: 19px;"  ><font size="2"  >digoal=&gt; insert into tbl_file_info values (2,'/home/postgres/advisory_lock_2.txt');</font></span></div><div><span style="line-height: 19px;"  ><font size="2"  >INSERT 0 1</font></span></div><div><span style="line-height: 19px;"  ><font size="2"  >digoal=&gt; insert into tbl_file_info values (3,'/home/postgres/advisory_lock_3.txt');</font></span></div><div><span style="line-height: 19px;"  ><font size="2"  >INSERT 0 1</font></span></div><p></p></pre></div><div><span style="font-size: 12px; line-height: 19px;"  ><br></span></div><div><span style="font-size: 12px; line-height: 19px;"  >SESSION A:</span></div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select pg_advisory_lock(id),file_path from tbl_file_info where id=1;</font></div><div><font size="2"  >&nbsp;pg_advisory_lock | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; file_path &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >------------------+------------------------------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | /home/postgres/advisory_lock_1.txt</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div style="line-height: 19px; font-size: 12px;"  >应用程序对/home/postgres/advisory_lock_1.txt文件进行编辑之后，再释放这个advisory锁。</div><div style="line-height: 19px; font-size: 12px;"  ><br></div></div><div><span style="font-size: 12px; line-height: 19px;"  >SESSION B:</span></div></font><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 19px;"  >当SESSIONA在编辑</span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 19px;"  >/home/postgres/advisory_lock_1.txt这个文件的时候，无法获得这个锁，所以可以确保不会同时编辑这个文件。</span><div style="font-family: verdana, sans-serif;"  ><span style="font-size: 12px; line-height: 19px;"  ><br></span></div><div style="font-family: verdana, sans-serif;"  ><span style="font-size: 12px; line-height: 19px;"  ><br></span></div><div style="font-family: verdana, sans-serif;"  ><span style="font-size: 12px; line-height: 19px;"  >如果不使用advisory lock,改用MVCC,来看看如何 :&nbsp;</span></div><div style="font-family: verdana, sans-serif;"  ><span style="font-size: 12px; line-height: 19px;"  >仍旧使用以上的测试数据，</span></div><div><font><div style="font-family: Arial, Helvetica, sans-serif; font-size: 14px; line-height: 22px;"  ><span style="line-height: 19px; font-size: 12px;"  >SESSION A:</span></div><div><div style="font-family: verdana, sans-serif;"  ><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; begin;</font></div><div><font size="2"  >BEGIN</font></div><div><font size="2"  >digoal=&gt; select file_path from tbl_file_info where id=1 for update;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;file_path &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >------------------------------------</font></div><div><font size="2"  >&nbsp;/home/postgres/advisory_lock_1.txt</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre><span style="font-family: Arial, Helvetica, sans-serif; font-size: 12px; line-height: 19px;"  >应用程序对/home/postgres/advisory_lock_1.txt文件进行编辑之后，再释放这个锁。</span></div><div><div style="font-family: Arial, Helvetica, sans-serif;"  ><pre class="prettyprint"  ><p></p><div style="font-family: Arial, Helvetica, sans-serif; line-height: 19px;"  ><font size="2"  >digoal=&gt; end;</font></div><div style="font-family: Arial, Helvetica, sans-serif; line-height: 19px;"  ><font size="2"  >COMMIT</font></div><p></p></pre></div><div style="font-family: Arial, Helvetica, sans-serif; font-size: 12px; line-height: 19px;"  >因此这个SESSION在编辑文件的时候，需要保持这个事务，一方面降低了数据库使用的并发性，另一方面带来了长事务，会有回收不了DEAD TUPLE空间的问题，参考我以前写过的BLOG。</div><div style="font-family: Arial, Helvetica, sans-serif; font-size: 12px; line-height: 19px;"  ><a href="http://blog.163.com/digoal@126/blog/static/163877040201011162912604/"  >http://blog.163.com/digoal@126/blog/static/163877040201011162912604/</a></div><div><span style="font-size: 12px; line-height: 19px;"  >DETAIL: &nbsp;xxxx dead row versions cannot be removed yet.</span></div></div><div style="font-family: Arial, Helvetica, sans-serif; font-size: 12px; line-height: 19px;"  ><br style="line-height: 19px;"  ></div></div><div style="font-family: Arial, Helvetica, sans-serif; font-size: 14px; line-height: 22px;"  ><span style="line-height: 19px; font-size: 12px;"  >SESSION B:</span></div></font><span style="line-height: 19px; font-family: verdana, sans-serif; font-size: 12px;"  >当SESSIONA在编辑&nbsp;</span><span style="line-height: 19px; font-family: verdana, sans-serif; font-size: 12px;"  >/home/postgres/advisory_lock_1.txt 这个文件的时候，如果需要更改同一个文件，同样，先获得锁然后操作。</span></div><div style="font-family: verdana, sans-serif;"  ><pre class="prettyprint"  ><p><font size="2"  >digoal=&gt; select file_path from tbl_file_info where id=1 for update;</font></p></pre></div><div style="font-family: verdana, sans-serif;"  ><span style="font-size: 12px; line-height: 19px;"  >等待SESSION A释放锁。</span></div><font face="verdana, sans-serif"  ><div style="font-size: 12px; line-height: 19px;"  ><br></div></font></div><div>【参考】</div><div><a rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/functions-admin.html#FUNCTIONS-ADVISORY-LOCKS"  >http://www.postgresql.org/docs/9.1/static/functions-admin.html#FUNCTIONS-ADVISORY-LOCKS</a></div><div><a rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/explicit-locking.html#ADVISORY-LOCKS"  >http://www.postgresql.org/docs/9.1/static/explicit-locking.html#ADVISORY-LOCKS</a></div></div>
	</div>
</div>
</body>
</html>