<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL archive_cleanup_command in multi-standby environment</h2>
	<h5 id="">2011-08-05 13:08:41&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201175113131947/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>在standby的配置文件recovery.conf里面，可以配置一个参数<span style="font-family: monospace; font-size: 12px; line-height: normal;">archive_cleanup_command用于清除不再需要的归档文件.</span></div>%r<wbr><div><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;">Any&nbsp;<tt>%r</tt>&nbsp;is replaced by the name of the file containing the last valid restart point. That is the earliest file that must be&nbsp;<span style="font-weight: bold;"><i>kept</i></span>&nbsp;to allow a restore to be restartable, and so all files earlier than&nbsp;<tt>%r</tt>&nbsp;may be safely removed.</span></div><div><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"><br></span></div><div><font face="verdana, sans-serif"><span style="font-size: 12px; line-height: 18px;">但是，在多个standby的环境下，相互之间是不知道对方的restart point的。所以如果各自配置了</span></font><span style="font-family: monospace; font-size: 12px; line-height: 19px; white-space: pre;">pg_archivecleanup的话，可能删除别的节点还需要的XLOG。</span></div><div><span style="font-family: monospace; font-size: 12px; line-height: 19px; white-space: pre;"><br></span></div><div><span style="font-family: monospace; font-size: 12px; line-height: 19px; white-space: pre;">解决这个问题需要统一来管理每个STANDBY的%r信息。</span></div><div><span style="font-family: monospace; font-size: 12px; line-height: 19px; white-space: pre;"><br></span></div><div><span style="font-family: monospace; font-size: 12px; line-height: 19px; white-space: pre;">例如</span><span style="font-family: monospace; font-size: 12px; line-height: normal;">archive_cleanup_command里面配置一个脚本，</span></div><div><span style="font-family: monospace; font-size: 12px; line-height: normal;">1. 首次插入，以后更新本standby的 %r 到primary 数据库。</span></div><div><span style="font-family: monospace; font-size: 12px; line-height: normal;">2. 从记录表里面找到一个所有配置为活动的standby里面最小的%r进行清除操作。</span></div><div><span style="font-family: monospace; font-size: 12px; line-height: normal;"><br></span></div><div><font face="monospace"><span style="font-size: 12px; line-height: normal;"><div>digoal=&gt; \d archive_restart_point</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Table "digoal.archive_restart_point"</div><div>&nbsp; &nbsp;Column &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Modifiers&nbsp;</div><div>-------------+-----------------------------+-----------</div><div>&nbsp;id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | not null</div><div>&nbsp;hostname &nbsp; &nbsp;| text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</div><div>&nbsp;point &nbsp; &nbsp; &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</div><div>&nbsp;status &nbsp; &nbsp; &nbsp;| boolean &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</div><div>&nbsp;comment &nbsp; &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</div><div>&nbsp;crt_time &nbsp; &nbsp;| timestamp without time zone |&nbsp;</div><div>&nbsp;modify_time | timestamp without time zone |&nbsp;</div><div>Indexes:</div><div>&nbsp; &nbsp; "archive_restart_point_pkey" PRIMARY KEY, btree (id)</div></span></font></div><div><span style="font-family: monospace; font-size: 12px; line-height: normal;"><br></span></div><div><span style="font-family: monospace; font-size: 12px; line-height: normal;"><br></span></div><div><span style="font-family: monospace; font-size: 12px; line-height: normal;"><br></span></div><div><span style="font-family: monospace; font-size: 12px; line-height: normal;"><br></span></div><div><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"><br></span></div><div><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"><br></span></div><div><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"><br></span></div><div><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"><br></span></div></div>
	</div>
</div>
</body>
</html>