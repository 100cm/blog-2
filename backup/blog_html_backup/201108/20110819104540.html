<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">BUG: Database FATAL case , when add unpreloaded library custom_variable_classes during db running.</h2>
	<h5 id="">2011-08-19 10:45:40&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402011719103737580/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>今天出了一个比较悲喜交夹的故障 。 学到东西了，也造成故障了。还好故障时间比较短。</div><div><div>2011-08-19 10:26:08.720 CST,,,28695,,4e4636d0.7017,6,,2011-08-13 16:33:20 CST,,0,LOG,00000,"received SIGHUP, reloading configuration</div><div>&nbsp;files",,,,,,,,,""</div><div>2011-08-19 10:26:08.721 CST,,,28695,,4e4636d0.7017,7,,2011-08-13 16:33:20 CST,,0,LOG,00000,"parameter ""custom_variable_classes"" ch</div><div>anged to ""pg_stat_statements""",,,,,,,,,""</div><div>2011-08-19 10:26:08.721 CST,,,28695,,4e4636d0.7017,8,,2011-08-13 16:33:20 CST,,0,<font color="#993300"  >FATAL</font>,42704,"unrecognized configuration parameter "</div><div>"pg_stat_statements.max""",,,,,,,,,""</div></div><div>故障发生时刻，数据库日志输出的错误日志如上。</div><div><br></div><div>原因是，当一台正在运行的数据库，去修改custom_variable_classes 这个参数，同时这个custom的这个参数依赖preload的库，但是库又没有提前加载的情况下，并且添加了custom_variable_classes 的子类目参数的时候。</div><div>数据库会FATAL掉。</div><div><br></div><div>重现 :&nbsp;</div><div>一个正在运行的数据库，其中的参数如下:</div><div># shared_preload_libraries = '' &nbsp; # (change requires restart)&nbsp;</div><div># custom_variable_classes = ''&nbsp;</div><div>也就是没有配置自定义参数。</div><div>接下来修改这个参数，（shared_preload_libraries = 这个参数配不配都一样FATAL）</div><div><div>custom_variable_classes = 'pg_stat_statements'</div><div>pg_stat_statements.max = 1000</div><div>pg_stat_statements.track = all</div></div><div>然后pg_ctl reload参数文件。输出前面提到的日志，数据库随之FATAL ：</div><div><br></div><div>另外，如果这几个参数是在数据库没有启动的时候配置的，数据库可以正常启动，不会FATAL。</div><div><br></div><div>正常加载自定义参数的方法。</div><div>同时修改参数文件，</div><div><div style="line-height: 22px;"  ># shared_preload_libraries = '' &nbsp; # (change requires restart)&nbsp;</div><div style="line-height: 22px;"  ># custom_variable_classes = ''&nbsp;</div></div><div>重启数据库。</div><div><br></div><div>再来一个测试如下:</div><div>vi postgresql.conf</div><div><div><div>custom_variable_classes = 'pg_stat_statements,test'</div><div>pg_stat_statements.max = 1000</div><div>pg_stat_statements.track = all</div><div>test.max = 1</div><div>"postgresql.conf" 552L, 19089C written &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div><div>postgres@db5-&gt; pg_ctl reload</div><div>server signaled</div></div><div><br></div><div>2011-08-19 10:44:19.381 CST,,,24895,,4e4dc9f2.613f,4,,2011-08-19 10:26:58 CST,,0,LOG,00000,"received SIGHUP, reloading configuration</div><div>&nbsp;files",,,,,,,,,""</div><div>2011-08-19 10:44:19.382 CST,,,24895,,4e4dc9f2.613f,5,,2011-08-19 10:26:58 CST,,0,LOG,00000,"parameter ""custom_variable_classes"" ch</div><div>anged to ""pg_stat_statements,test""",,,,,,,,,""</div><div>2011-08-19 10:44:19.382 CST,,,24895,,4e4dc9f2.613f,6,,2011-08-19 10:26:58 CST,,0,FATAL,42704,"unrecognized configuration parameter "</div><div>"test.max""",,,,,,,,,""</div></div><div>又FATAL了。</div><div><br></div><div><br></div><div>算是一个BUG吧。错误代码是42704&nbsp;</div><div><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: normal;"  ><table border="1"  style="margin-left: 2ex; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; border-collapse: collapse; margin-top: 2ex; margin-right: 0px; margin-bottom: 2ex; background-color: rgb(224, 236, 239); border-top-width: 2px; border-right-width: 2px; border-bottom-width: 2px; border-left-width: 2px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223);"  ><tbody><tr><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;"  ><tt>42704</tt></td><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;"  ><tt>undefined_object</tt></td></tr></table></span></div><div>postgresql 9.0.4, postgresql 9.1 beta2都有这个问题。</div><div><br></div><div>PostgreSQL 9.1rc1 版本已经没有这个问题了。</div><div>日志如下 :&nbsp;</div><div><div>custom_variable_classes = 'pg_stat_statements,test'</div><div>pg_stat_statements.max = 1000</div><div>pg_stat_statements.track = all</div><div>test.ok = 1</div></div><div><br></div><div><div>2011-08-24 15:17:47.897 CST,,,15830,,4e54a520.3dd6,2,,2011-08-24 15:15:44 CST,,0,LOG,00000,"received SIGHUP, reloading configuration files",,,,,,,,,""</div><div>2011-08-24 15:17:47.898 CST,,,15830,,4e54a520.3dd6,3,,2011-08-24 15:15:44 CST,,0,LOG,00000,"parameter ""custom_variable_classes"" changed to ""pg_stat_statements,test""",,,,,,,,,""</div><div>2011-08-24 15:17:47.898 CST,,,15830,,4e54a520.3dd6,4,,2011-08-24 15:15:44 CST,,0,LOG,00000,"parameter ""test.ok"" changed to ""1""",,,,,,,,,""</div></div><div>数据库没有因此而FATAL掉。</div><div><br></div><br><wbr></div>
	</div>
</div>
</body>
</html>