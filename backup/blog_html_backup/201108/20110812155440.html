<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">pg_control file recover</h2>
	<h5 id="">2011-08-12 15:54:40&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201171233710582/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">今天一位朋友在问pg_control文件丢失或损坏是否可以启动PostgreSQL的问题，于是在测试系统尝试了一下。<wbr><div>首先记录下正常情况下的pg_controldata信息如下:这个信息非常有用，需要用于恢复.</div><div><div><pre class="prettyprint"  ><div><font size="2"  >pg_control version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;903</font></div><div><font size="2"  >Catalog version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 201008051</font></div><div><font size="2"  >Database system identifier: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5556352067747738614</font></div><div><font size="2"  >Database cluster state: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; shut down</font></div><div><font size="2"  >pg_control last modified: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Fri 12 Aug 2011 03:12:16 PM CST</font></div><div><font size="2"  >Latest checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 23/50000020</font></div><div><font size="2"  >Prior checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;23/4C000020</font></div><div><font size="2"  >Latest checkpoint's REDO location: &nbsp; &nbsp;23/50000020</font></div><div><font size="2"  >Latest checkpoint's TimeLineID: &nbsp; &nbsp; &nbsp; 6</font></div><div><font size="2"  >Latest checkpoint's NextXID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/4710</font></div><div><font size="2"  >Latest checkpoint's NextOID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2082697</font></div><div><font size="2"  >Latest checkpoint's NextMultiXactId: &nbsp;1</font></div><div><font size="2"  >Latest checkpoint's NextMultiOffset: &nbsp;0</font></div><div><font size="2"  >Latest checkpoint's oldestXID: &nbsp; &nbsp; &nbsp; &nbsp;655</font></div><div><font size="2"  >Latest checkpoint's oldestXID's DB: &nbsp; 1</font></div><div><font size="2"  >Latest checkpoint's oldestActiveXID: &nbsp;0</font></div><div><font size="2"  >Time of latest checkpoint: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Fri 12 Aug 2011 03:12:16 PM CST</font></div><div><font size="2"  >Minimum recovery ending location: &nbsp; &nbsp; 0/0</font></div><div><font size="2"  >Backup start location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/0</font></div><div><font size="2"  >Current wal_level setting: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;hot_standby</font></div><div><font size="2"  >Current max_connections setting: &nbsp; &nbsp; &nbsp;2000</font></div><div><font size="2"  >Current max_prepared_xacts setting: &nbsp; 50</font></div><div><font size="2"  >Current max_locks_per_xact setting: &nbsp; 64</font></div><div><font size="2"  >Maximum data alignment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8</font></div><div><font size="2"  >Database block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8192</font></div><div><font size="2"  >Blocks per segment of large relation: 1048576</font></div><div><font size="2"  >WAL block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8192</font></div><div><font size="2"  >Bytes per WAL segment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;67108864</font></div><div><font size="2"  >Maximum length of identifiers: &nbsp; &nbsp; &nbsp; &nbsp;64</font></div><div><font size="2"  >Maximum columns in an index: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;32</font></div><div><font size="2"  >Maximum size of a TOAST chunk: &nbsp; &nbsp; &nbsp; &nbsp;1996</font></div><div><font size="2"  >Date/time type storage: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 64-bit integers</font></div><div><font size="2"  >Float4 argument passing: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;by value</font></div><div><font size="2"  >Float8 argument passing: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;by value</font></div><p></p></pre></div></div><div><br></div><div>然后删除$PGDATA/global/pg_control文件，启动数据库 .</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pg_ctl start</font></div><div><font size="2"  >pg_ctl: another server might be running; trying to start server anyway</font></div><div><font size="2"  >postgres: could not find the database system</font></div><div><font size="2"  >Expected to find it in the directory "/database/pgdata/tbs1/pg_root",</font></div><div><font size="2"  >but could not open file "/database/pgdata/tbs1/pg_root/global/pg_control": No such file or directory</font></div><div><font size="2"  >pg_ctl: could not start server</font></div><div><font size="2"  >Examine the log output.</font></div><p></p></pre></div><div>是的，报错。</div><div><br></div><div>恢复pg_control如下:</div><div><div>首先 touch $PGDATA/global/pg_control</div><div><br></div><div><div>然后 pg_resetxlog $PGDATA</div><div><pre class="prettyprint"  ><p></p><div><div><div><font size="2"  >pg_resetxlog: pg_control exists but is broken or unknown version; ignoring it</font></div><div><font size="2"  >Guessed pg_control values:</font></div></div></div><div><div><font size="2"  >First log file ID after reset: &nbsp; &nbsp; &nbsp; &nbsp;35</font></div><div><font size="2"  >First log file segment after reset: &nbsp; 38</font></div><div><font size="2"  >pg_control version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;903</font></div><div><font size="2"  >Catalog version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 201008051</font></div><div><font size="2"  >Database system identifier: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5639864756195480479</font></div><div><font size="2"  >Latest checkpoint's TimeLineID: &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"  >Latest checkpoint's NextXID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/3</font></div><div><font size="2"  >Latest checkpoint's NextOID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;10000</font></div><div><font size="2"  >Latest checkpoint's NextMultiXactId: &nbsp;1</font></div><div><font size="2"  >Latest checkpoint's NextMultiOffset: &nbsp;0</font></div><div><font size="2"  >Latest checkpoint's oldestXID: &nbsp; &nbsp; &nbsp; &nbsp;3</font></div><div><font size="2"  >Latest checkpoint's oldestXID's DB: &nbsp; 0</font></div><div><font size="2"  >Latest checkpoint's oldestActiveXID: &nbsp;0</font></div><div><font size="2"  >Maximum data alignment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8</font></div><div><font size="2"  >Database block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8192</font></div><div><font size="2"  >Blocks per segment of large relation: 1048576</font></div><div><font size="2"  >WAL block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8192</font></div><div><font size="2"  >Bytes per WAL segment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;67108864</font></div><div><font size="2"  >Maximum length of identifiers: &nbsp; &nbsp; &nbsp; &nbsp;64</font></div><div><font size="2"  >Maximum columns in an index: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;32</font></div><div><font size="2"  >Maximum size of a TOAST chunk: &nbsp; &nbsp; &nbsp; &nbsp;1996</font></div><div><font size="2"  >Date/time type storage: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 64-bit integers</font></div><div><font size="2"  >Float4 argument passing: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;by value</font></div><div><font size="2"  >Float8 argument passing: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;by value</font></div><div><font size="2"  >If these values seem acceptable, use -f to force reset.</font></div></div><p></p></pre></div></div></div><div><br></div><div>从上面的值可以看出以下数值已经和正常情况下不一样了：</div><div><div style="line-height: 22px;"  ><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >Latest checkpoint's TimeLineID: &nbsp; &nbsp; &nbsp; 1</font></div><div style="line-height: 22px;"  ><font size="2"  >Latest checkpoint's NextXID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/3</font></div><div style="line-height: 22px;"  ><font size="2"  >Latest checkpoint's NextOID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;10000</font></div><div style="line-height: 22px;"  ><font size="2"  >Latest checkpoint's NextMultiXactId: &nbsp;1</font></div><div style="line-height: 22px;"  ><font size="2"  >Latest checkpoint's NextMultiOffset: &nbsp;0</font></div><div style="line-height: 22px;"  ><font size="2"  >Latest checkpoint's oldestXID: &nbsp; &nbsp; &nbsp; &nbsp;3</font></div><div style="line-height: 22px;"  ><font size="2"  >Latest checkpoint's oldestXID's DB: &nbsp; 0</font></div><div style="line-height: 22px;"  ><font size="2"  >Latest checkpoint's oldestActiveXID: &nbsp;0</font></div><p></p></pre></div></div><div style="line-height: 22px;"  ><br></div><div style="line-height: 22px;"  >接下来重建pg_control</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pg_resetxlog -f $PGDATA</font></div><div><font size="2"  >pg_resetxlog: pg_control exists but is broken or unknown version; ignoring it</font></div><div><font size="2"  >Transaction log reset</font></div><p></p></pre></div><div><br></div><div>重建完后，先不启动数据库，看看重建的pg_control当前的信息 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pg_controldata&nbsp;</font></div><div><font size="2"  >pg_control version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;903</font></div><div><font size="2"  >Catalog version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 201008051</font></div><div><font size="2"  >Database system identifier: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5639864833504827199</font></div><div><font size="2"  >Database cluster state: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; shut down</font></div><div><font size="2"  >pg_control last modified: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Fri 12 Aug 2011 03:15:59 PM CST</font></div><div><font size="2"  >Latest checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 23/98000020</font></div><div><font size="2"  >Prior checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/0</font></div><div><font size="2"  >Latest checkpoint's REDO location: &nbsp; &nbsp;23/98000020</font></div><div><font size="2"  >Latest checkpoint's TimeLineID: &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"  >Latest checkpoint's NextXID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/3</font></div><div><font size="2"  >Latest checkpoint's NextOID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;10000</font></div><div><font size="2"  >Latest checkpoint's NextMultiXactId: &nbsp;1</font></div><div><font size="2"  >Latest checkpoint's NextMultiOffset: &nbsp;0</font></div><div><font size="2"  >Latest checkpoint's oldestXID: &nbsp; &nbsp; &nbsp; &nbsp;3</font></div><div><font size="2"  >Latest checkpoint's oldestXID's DB: &nbsp; 0</font></div><div><font size="2"  >Latest checkpoint's oldestActiveXID: &nbsp;0</font></div><div><font size="2"  >Time of latest checkpoint: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Fri 12 Aug 2011 03:15:59 PM CST</font></div><div><font size="2"  >Minimum recovery ending location: &nbsp; &nbsp; 0/0</font></div><div><font size="2"  >Backup start location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/0</font></div><div><font size="2"  >Current wal_level setting: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;minimal</font></div><div><font size="2"  >Current max_connections setting: &nbsp; &nbsp; &nbsp;100</font></div><div><font size="2"  >Current max_prepared_xacts setting: &nbsp; 0</font></div><div><font size="2"  >Current max_locks_per_xact setting: &nbsp; 64</font></div><div><font size="2"  >Maximum data alignment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8</font></div><div><font size="2"  >Database block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8192</font></div><div><font size="2"  >Blocks per segment of large relation: 1048576</font></div><div><font size="2"  >WAL block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8192</font></div><div><font size="2"  >Bytes per WAL segment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;67108864</font></div><div><font size="2"  >Maximum length of identifiers: &nbsp; &nbsp; &nbsp; &nbsp;64</font></div><div><font size="2"  >Maximum columns in an index: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;32</font></div><div><font size="2"  >Maximum size of a TOAST chunk: &nbsp; &nbsp; &nbsp; &nbsp;1996</font></div><div><font size="2"  >Date/time type storage: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 64-bit integers</font></div><div><font size="2"  >Float4 argument passing: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;by value</font></div><div><font size="2"  >Float8 argument passing: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;by value</font></div><p></p></pre></div><div><br></div><div>可以看出以下信息和正常的pg_control信息不一致:</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >Database system identifier: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5639864833504827199</font></div><div><font size="2"  >pg_control last modified: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Fri 12 Aug 2011 03:15:59 PM CST</font></div><div><font size="2"  >Latest checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 23/98000020</font></div><div><font size="2"  >Prior checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/0</font></div><div><font size="2"  >Latest checkpoint's REDO location: &nbsp; &nbsp;23/98000020</font></div><div><font size="2"  >Latest checkpoint's TimeLineID: &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"  >Latest checkpoint's NextXID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/3</font></div><div><font size="2"  >Latest checkpoint's NextOID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;10000</font></div><div><font size="2"  >Latest checkpoint's NextMultiXactId: &nbsp;1</font></div><div><font size="2"  >Latest checkpoint's NextMultiOffset: &nbsp;0</font></div><div><font size="2"  >Latest checkpoint's oldestXID: &nbsp; &nbsp; &nbsp; &nbsp;3</font></div><div><font size="2"  >Latest checkpoint's oldestXID's DB: &nbsp; 0</font></div><div><font size="2"  >Latest checkpoint's oldestActiveXID: &nbsp;0</font></div><div><font size="2"  >Time of latest checkpoint: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Fri 12 Aug 2011 03:15:59 PM CST</font></div><div><font size="2"  >Minimum recovery ending location: &nbsp; &nbsp; 0/0</font></div><div><font size="2"  >Backup start location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/0</font></div><div><font size="2"  >Current wal_level setting: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;minimal</font></div><div><font size="2"  >Current max_connections setting: &nbsp; &nbsp; &nbsp;100</font></div><div><font size="2"  >Current max_prepared_xacts setting: &nbsp; 0</font></div><p></p></pre></div><div><br></div><div>接下来启动数据库</div><div><pre class="prettyprint"  ><p><font size="2"  >pg_ctl start $PGDATA</font></p></pre></div><div>再次查看控制文件的信息</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pg_control version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;903</font></div><div><font size="2"  >Catalog version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 201008051</font></div><div><font size="2"  >Database system identifier: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5639864833504827199</font></div><div><font size="2"  >Database cluster state: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; in production</font></div><div><font size="2"  >pg_control last modified: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Fri 12 Aug 2011 03:17:22 PM CST</font></div><div><font size="2"  >Latest checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 23/98000020</font></div><div><font size="2"  >Prior checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/0</font></div><div><font size="2"  >Latest checkpoint's REDO location: &nbsp; &nbsp;23/98000020</font></div><div><font size="2"  >Latest checkpoint's TimeLineID: &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"  >Latest checkpoint's NextXID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/3</font></div><div><font size="2"  >Latest checkpoint's NextOID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;10000</font></div><div><font size="2"  >Latest checkpoint's NextMultiXactId: &nbsp;1</font></div><div><font size="2"  >Latest checkpoint's NextMultiOffset: &nbsp;0</font></div><div><font size="2"  >Latest checkpoint's oldestXID: &nbsp; &nbsp; &nbsp; &nbsp;3</font></div><div><font size="2"  >Latest checkpoint's oldestXID's DB: &nbsp; 0</font></div><div><font size="2"  >Latest checkpoint's oldestActiveXID: &nbsp;0</font></div><div><font size="2"  >Time of latest checkpoint: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Fri 12 Aug 2011 03:15:59 PM CST</font></div><div><font size="2"  >Minimum recovery ending location: &nbsp; &nbsp; 0/0</font></div><div><font size="2"  >Backup start location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/0</font></div><div><font size="2"  >Current wal_level setting: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;hot_standby</font></div><div><font size="2"  >Current max_connections setting: &nbsp; &nbsp; &nbsp;2000</font></div><div><font size="2"  >Current max_prepared_xacts setting: &nbsp; 50</font></div><div><font size="2"  >Current max_locks_per_xact setting: &nbsp; 64</font></div><div><font size="2"  >Maximum data alignment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8</font></div><div><font size="2"  >Database block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8192</font></div><div><font size="2"  >Blocks per segment of large relation: 1048576</font></div><div><font size="2"  >WAL block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8192</font></div><div><font size="2"  >Bytes per WAL segment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;67108864</font></div><div><font size="2"  >Maximum length of identifiers: &nbsp; &nbsp; &nbsp; &nbsp;64</font></div><div><font size="2"  >Maximum columns in an index: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;32</font></div><div><font size="2"  >Maximum size of a TOAST chunk: &nbsp; &nbsp; &nbsp; &nbsp;1996</font></div><div><font size="2"  >Date/time type storage: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 64-bit integers</font></div><div><font size="2"  >Float4 argument passing: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;by value</font></div><div><font size="2"  >Float8 argument passing: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;by value</font></div><p></p></pre></div><div><br></div><div>某些信息已经和正常情况下的pg_control信息一致了，有一些是来自参数文件的内容。</div><div>现在不一致的信息如下:</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >Database system identifier: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5639864833504827199</font></div><div><font size="2"  >pg_control last modified: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Fri 12 Aug 2011 03:17:22 PM CST</font></div><div><font size="2"  >Latest checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 23/98000020</font></div><div><font size="2"  >Prior checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/0</font></div><div><font size="2"  >Latest checkpoint's REDO location: &nbsp; &nbsp;23/98000020</font></div><div><font size="2"  >Latest checkpoint's TimeLineID: &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"  >Latest checkpoint's NextXID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/3</font></div><div><font size="2"  >Latest checkpoint's NextOID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;10000</font></div><div><font size="2"  >Latest checkpoint's NextMultiXactId: &nbsp;1</font></div><div><font size="2"  >Latest checkpoint's NextMultiOffset: &nbsp;0</font></div><div><font size="2"  >Latest checkpoint's oldestXID: &nbsp; &nbsp; &nbsp; &nbsp;3</font></div><div><font size="2"  >Latest checkpoint's oldestXID's DB: &nbsp; 0</font></div><div><font size="2"  >Latest checkpoint's oldestActiveXID: &nbsp;0</font></div><div><font size="2"  >Time of latest checkpoint: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Fri 12 Aug 2011 03:15:59 PM CST</font></div><p></p></pre></div><div>这些没有办法从参数文件获取。</div><div><br></div><div>OK，pg_control文件修复完成，但是问题来了。所有的用户，库都看不见了，但是数据还在，并且能进库，查看数据，但是就是在pg_class这种数据表里面看不到数据，原因是MVCC带来的假象，数据看似消失了。(执行完VACUUM就真的消失了)</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db-172-16-3-33-&gt; psql -h 127.0.0.1 -l</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of databases</font></div><div><font size="2"  >&nbsp;Name | Owner | Encoding | Collation | Ctype | Access privileges&nbsp;</font></div><div><font size="2"  >------+-------+----------+-----------+-------+-------------------</font></div><div><font size="2"  >(0 rows)</font></div><p></p></pre></div><div><br></div><div>修正消失的数据 , 通过修改控制文件的&nbsp;</div><div><pre class="prettyprint"  ><p><font size="2"  >Latest checkpoint's NextXID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/4710 :&nbsp;</font></p></pre></div><div>TIMELINE我这里就没修正，不过最好能修正还是修正。</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db-172-16-3-33-&gt; pg_ctl stop -m fast</font></div><div><font size="2"  >postgres@db-172-16-3-33-&gt; pg_resetxlog -x 4710 $PGDATA</font></div><div><font size="2"  >Transaction log reset</font></div><div><font size="2"  >postgres@db-172-16-3-33-&gt; pg_ctl start</font></div><div><font size="2"  >server starting</font></div><div><font size="2"  >postgres@db-172-16-3-33-&gt; psql -h 127.0.0.1 -l</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of databases</font></div><div><font size="2"  >&nbsp; &nbsp; Name &nbsp; &nbsp; | &nbsp; &nbsp;Owner &nbsp; &nbsp;| Encoding | Collation | Ctype | &nbsp; Access privileges &nbsp;&nbsp;</font></div><div><font size="2"  >-------------+-------------+----------+-----------+-------+-----------------------</font></div><div><font size="2"  >&nbsp;digoal &nbsp; &nbsp; &nbsp;| digoal &nbsp; &nbsp; &nbsp;| UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; | digoal=CTc/digoal &nbsp; &nbsp;+</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | role_b=c/digoal &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | =CTc/digoal</font></div><div><font size="2"  >&nbsp;fingerprint | fingerprint | UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >&nbsp;pgwatch &nbsp; &nbsp; | pgwatch &nbsp; &nbsp; | UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >&nbsp;postgres &nbsp; &nbsp;| postgres &nbsp; &nbsp;| UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >&nbsp;template0 &nbsp; | postgres &nbsp; &nbsp;| UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; | =c/postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | postgres=CTc/postgres</font></div><div><font size="2"  >&nbsp;template1 &nbsp; | postgres &nbsp; &nbsp;| UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; | =c/postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | postgres=CTc/postgres</font></div><div><font size="2"  >(6 rows)</font></div><p></p></pre></div><div>现在就正常了。</div><div>以上恢复过程风险较大，请勿模仿。</div><div>可靠的恢复操作请见另一篇BLOG :&nbsp;</div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020130109400557/"  >http://blog.163.com/digoal@126/blog/static/16387704020130109400557/</a></div>
	</div>
</div>
</body>
</html>