<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">[PostgreSQL] Using <Partial Index> speedup max,min search</h2>
	<h5 id="">2010-07-05 12:01:43&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402010650143575/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><p>今天在给数据仓库ETL做优化的时候，发现PostgreSQL一个比较奇怪的问题。</p> <p>首先介绍一下环境：</p> <p>有一个表需要被数据仓库的ETL程序抽取，表名暂且叫tbl_test，数据量大概在1亿左右。</p> <p>修改标记字段为modifytime,允许空,BTREE索引。</p> <p>创建标记字段为createtime,允许空,无索引。</p> <p>抽取的时候按照modifytime范围取值进行抽取。</p> <p>问题来了：</p> <p></p><pre class="prettyprint"  ><p></p><p><font size="2"  >select max(modifytime) from tbl_ups_user_info;</font></p> <p><font size="2"  >Time: 10563.757 ms</font></p> <p><font size="2"  >select min(modifytime) from tbl_ups_user_info;</font></p> <p><font size="2"  >Time: 0.901 ms</font></p><p></p></pre> <p>差别实在太大了。</p> <p>执行计划如下：</p> <p></p><pre class="prettyprint"  ><p></p><p><font size="2"  >skyups=&gt; explain analyze select max(modifytime) from tbl_ups_user_info;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; QUERY PLAN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>------------------------------------------------------------------------------------------------------------------------------------<br>------------------------------------------------------------<br>&nbsp;Result&nbsp; (cost=0.05..0.06 rows=1 width=0) (actual time=11801.932..11801.932 rows=1 loops=1)<br>&nbsp;&nbsp; InitPlan 1 (returns $0)<br>&nbsp;&nbsp;&nbsp;&nbsp; -&gt;&nbsp; Limit&nbsp; (cost=0.00..0.05 rows=1 width=8) (actual time=11801.925..11801.926 rows=1 loops=1)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;&nbsp; Index Scan Backward using idx_tbl_ups_user_info_modifytime on tbl_ups_user_info&nbsp; (cost=0.00..1644338.43 rows=32003931<br>&nbsp;width=8) (actual time=11801.922..11801.922 rows=1 loops=1)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Filter: (modifytime IS NOT NULL)<br>&nbsp;Total runtime: 11801.985 ms<br>(6 rows)</font></p> <p><font size="2"  >Time: 11803.978 ms<br>skyups=&gt; explain analyze select min(modifytime) from tbl_ups_user_info;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; QUERY PLAN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>------------------------------------------------------------------------------------------------------------------------------------<br>-------------------------------------------<br>&nbsp;Result&nbsp; (cost=0.05..0.06 rows=1 width=0) (actual time=0.067..0.067 rows=1 loops=1)<br>&nbsp;&nbsp; InitPlan 1 (returns $0)<br>&nbsp;&nbsp;&nbsp;&nbsp; -&gt;&nbsp; Limit&nbsp; (cost=0.00..0.05 rows=1 width=8) (actual time=0.064..0.064 rows=1 loops=1)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; -&gt;&nbsp; Index Scan using idx_tbl_ups_user_info_modifytime on tbl_ups_user_info&nbsp; (cost=0.00..1644338.43 rows=32003931 width=8)<br>&nbsp;(actual time=0.063..0.063 rows=1 loops=1)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Filter: (modifytime IS NOT NULL)<br>&nbsp;Total runtime: 0.109 ms<br>(6 rows)</font></p> <p><font size="2"  >Time: 0.942 ms</font></p><p></p></pre> <p>从执行计划上看，预计COST是一致的，但是真实时间差了1万倍以上，分析差别在 Index Scan Backward using idx_tbl_ups_user_info_modifytime ，但是索引是平衡二叉树索引，理论上来说得出结果的时间一致才对。</p> <p>为了验证，把索引修改为desc排序的索引。</p> <p>结果还是一样，MAX得到的时间还是要10多秒。</p> <p>于是想到会不会是空在作怪，默认情况下，空是被认为是最大的。是不是在做max取值时去搜索了空呢？</p> <p>赶紧来验证一把：</p> <p></p><pre class="prettyprint"  ><p><font size="2"  >select count(*) from tbl_test where modifytime is null;</font></p></pre> <p>9千万条记录.</p> <p></p><pre class="prettyprint"  ><p><font size="2"  >select count(*) from tbl_test where createtime is null;</font></p></pre> <p>0条记录</p> <p></p><pre class="prettyprint"  ><p></p><p><font size="2"  >create index idx_test_2 on tbl_test (createtime) ;</font></p> <p><font size="2"  >select min(createtime) from tbl_test;</font></p><p></p></pre> <p>0.9毫秒</p> <p></p><pre class="prettyprint"  ><p><font size="2"  >select min(createtime) from tbl_test;</font></p></pre> <p>0.9毫秒</p> <p>果然，问题就处在空。</p> <p>&nbsp;</p> <p>解决这个问题只需要建立partial索引。</p> <p>如下:</p> <p></p><pre class="prettyprint"  ><p><font size="2"  >create index idx_test_1 on tbl_test(modifytime) where modifytime is not null;</font></p></pre> <p>再次搜索</p> <p>max(modifytime)和min(modifytime)时间都在1毫秒以内了。</p> <p>后记：</p> <p>PostgreSQL 二叉树索引不记录空值，那么应该没有必要再搜索索引之外的其他PAGE才对，这点有点费解。</p> <p>两次索引的大小如下</p> <p>第一种情况:</p> <p></p><pre class="prettyprint"  ><p></p><p><font size="2"  >create index idx_test_1 on tbl_test(modifytime);</font></p> <p><font size="4"  >1023MB;</font></p> <p><font size="2"  >skyups=&gt; explain select count(*) from tbl_ups_user_info where modifytime is not null;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; QUERY PLAN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>---------------------------------------------------------------------------------<br>&nbsp;Aggregate&nbsp; (cost=963192.07..963192.08 rows=1 width=0)<br>&nbsp;&nbsp; -&gt;&nbsp; Seq Scan on tbl_ups_user_info&nbsp; (cost=0.00..962603.70 rows=235346 width=0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Filter: (modifytime IS NOT NULL)<br>(3 rows)</font></p> <p><font size="2"  >Time: 1.669 ms<br>skyups=&gt; explain select count(*) from tbl_ups_user_info where modifytime is&nbsp; null;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; QUERY PLAN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>-----------------------------------------------------------------------------------<br>&nbsp;Aggregate&nbsp; (cost=1042064.76..1042064.77 rows=1 width=0)<br>&nbsp;&nbsp; -&gt;&nbsp; Seq Scan on tbl_ups_user_info&nbsp; (cost=0.00..962603.70 rows=31784424 width=0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Filter: (modifytime IS NULL)<br>(3 rows)</font></p> <p><font size="2"  >Time: 0.547 ms</font></p><p></p></pre> <p>第二种情况:</p> <p></p><pre class="prettyprint"  ><p></p><p><font size="2"  >create index idx_test_1 on tbl_test(modifytime) where modifytime is not null;</font></p> <p><font size="4"  >4MB;</font></p> <p><font size="2"  >skyups=&gt; explain select count(*) from tbl_ups_user_info where modifytime is&nbsp; null;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; QUERY PLAN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>-----------------------------------------------------------------------------------<br>&nbsp;Aggregate&nbsp; (cost=1042082.04..1042082.05 rows=1 width=0)<br>&nbsp;&nbsp; -&gt;&nbsp; Seq Scan on tbl_ups_user_info&nbsp; (cost=0.00..962607.48 rows=31789824 width=0)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Filter: (modifytime IS NULL)<br>(3 rows)</font></p> <p><font size="2"  >Time: 1.771 ms<br>skyups=&gt; explain select count(*) from tbl_ups_user_info where modifytime is not null;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; QUERY PLAN&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>--------------------------------------------------------------------------------------------------------------------------<br>&nbsp;Aggregate&nbsp; (cost=231425.54..231425.55 rows=1 width=0)<br>&nbsp;&nbsp; -&gt;&nbsp; Index Scan using idx_tbl_ups_user_info_modifytime on tbl_ups_user_info&nbsp; (cost=0.00..230849.98 rows=230224 width=0)<br>(2 rows)</font></p> <p><font size="2"  >Time: 0.588 ms</font></p><p></p></pre> <p>&nbsp;</p> <p>总结：</p> <p>1. 二叉树索引中记录了modifytime is null的row page 和item号.（注意，在ORACLE中二叉树索引是不包含空的）</p> <p>这个从建立索引的语法中就可以理解：</p> <p></p><pre class="prettyprint"  ><p><font size="2"  >CREATE INDEX test2_info_nulls_low ON test2 (info NULLS FIRST);<br>CREATE INDEX test3_desc_index ON test3 (id DESC NULLS LAST);</font></p></pre> <p>2. 当需要使用max和min这类函数时，如果被运算的字段包含较多的空或者没有使用NOT NULL约束，建议在建立索引时使用partial索引。避免而外的PAGE扫描。</p></div>
	</div>
</div>
</body>
</html>