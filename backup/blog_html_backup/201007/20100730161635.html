<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">use pg_reorg re-organize tables in postgresql avoid LONG time AccessExclusiveLock</h2>
	<h5 id="">2010-07-30 16:16:35&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201063041635986/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><p>了解PostgreSQL存储原理的话，应该知道PostgreSQL在大量的更新删除插入操作后。会出现垃圾空间，索引也会变得比正常的情况大一些，直接导致的后果是，BUFFER空间浪费，IO请求增加，数据库性能下降。</p>  <p>一般通过vacuum来回收这些垃圾空间。但是这些还不够，为了达到更好的性能，一般需要重建表或者把表按顺序重新处理存储。通常reindex和cluster&nbsp;在更新频繁的大表上操作的话会引起锁等待的问题。</p>  <p>下面的话介绍一下使用pg_reorg组建，解决锁等待的问题，由于作者给出的说明文档实在太少了，所以我稍微写一下，方便大家使用：</p>  <p>来看看作者是怎么说的（不需要加载任何锁，太好了.有点类似ORACLE的在线重定义）：</p>  <p>pg_reorg can re-organize tables on a postgres database <font size="4"   ><strong>without any locks</strong> </font>so that <br>you can retrieve or update rows in tables being reorganized. <br>The module is developed to be a better alternative of CLUSTER and VACUUM FULL.</p>  <p>1. 下载</p>  <p>到pgfoundry下载源代码</p>  <p><a rel="nofollow" href="http://pgfoundry.org/frs/download.php/2745/pg_reorg-1.1.3.tar.gz"   >http://pgfoundry.org/frs/download.php/2745/pg_reorg-1.1.3.tar.gz</a></p>  <p>2. 安装</p>  <p>安装的套路其实很简单，加载到源码中编译即可。</p>  <p>解压后拷贝源代码目录到$PG_SOURCE/contrib</p>  <p>su - postgres</p>  <p>cd $PG_SOURCE/contrib/pg_reorg-1.1.3</p>  <p>USE_PGXS=1 gmake</p>  <p>su - root</p>  <p>. /home/postgres/.bash_profile (can find pg_config)</p>  <p>cd $PG_SOURCE/contrib/pg_reorg-1.1.3</p>  <p>USE_PGXS=1 gmake install</p>  <p>3. 加载</p>  <p>su - postgres</p>  <p>cd $PG_HOME/share/contrib</p>  <p>psql yourdb superuser -f ./pg_reorg.sql</p>  <p>4. 使用范例</p>  <p>要使用pg_reorg vacuum full或cluster表。表必须有主键。</p>  <p>如：</p>  <p>test=&gt; create table tbl_test1 (id int primary key,name varchar(10));<br>NOTICE:&nbsp; CREATE TABLE / PRIMARY KEY will create implicit index "tbl_test1_pkey" for table "tbl_test1"<br>CREATE TABLE<br>test=&gt; insert into tbl_test1 (id,name) select generate_series(1,10000),'digoal';<br>INSERT 0 10000<br>test=&gt; delete from tbl_Test1;<br>DELETE 10000<br>test=&gt; select pg_relation_size('tbl_test1');<br>&nbsp;pg_relation_size <br>------------------<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 450560<br>(1 row)</p>  <p>test=&gt; insert into tbl_test1 (id,name) select generate_series(1,10000),'digoal';<br>INSERT 0 10000<br>test=&gt; select pg_relation_size('tbl_test1');<br>&nbsp;pg_relation_size <br>------------------<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 892928<br>(1 row)</p>  <p>test=&gt; delete from tbl_Test1;<br>DELETE 10000<br>test=&gt; select pg_relation_size('tbl_test1');<br>&nbsp;pg_relation_size <br>------------------<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 892928<br>(1 row)</p>  <p>test=&gt; select pg_relation_size('tbl_test1_pkey');<br>&nbsp;pg_relation_size <br>------------------<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 245760<br>(1 row)</p>  <p>test=&gt; insert into tbl_test1 (id,name) select generate_series(1,10000),'digoal';<br>INSERT 0 10000<br>test=&gt; select pg_relation_size('tbl_test1_pkey');<br>&nbsp;pg_relation_size <br>------------------<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 245760<br>(1 row)</p>  <p>test=&gt; delete from tbl_Test1;<br>DELETE 10000<br>test=&gt; insert into tbl_test1 (id,name) select generate_series(10001,20000),'digoal';<br>INSERT 0 10000<br>test=&gt; select pg_relation_size('tbl_test1_pkey');<br>&nbsp;pg_relation_size <br>------------------<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 466944<br>(1 row)</p>  <p>test=&gt; select pg_relation_size('tbl_test1');<br>&nbsp;pg_relation_size <br>------------------<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1335296<br>(1 row)</p>  <p>处理后回到初始大小：</p>  <p><a rel="nofollow" href="mailto:postgres@db-172-16-3-33"   >postgres@db-172-16-3-33</a>-&gt; pg_reorg --help<br>pg_reorg re-organizes a PostgreSQL database.</p>  <p>Usage:<br>&nbsp; pg_reorg [OPTION]... [DBNAME]<br>Options:<br>&nbsp; -a, --all&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; reorg all databases<br>&nbsp; -t, --table=TABLE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; reorg specific table only<br>&nbsp; -n, --no-order&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do vacuum full instead of cluster<br>&nbsp; -o, --order-by=columns&nbsp;&nbsp;&nbsp; order by columns instead of cluster keys<br>&nbsp; -T, --wait-timeout=secs&nbsp;&nbsp; timeout to cancel other backends on conflict.<br>&nbsp; -Z, --no-analyze&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; don't analyze at end</p>  <p>Connection options:<br>&nbsp; -d, --dbname=DBNAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; database to connect<br>&nbsp; -h, --host=HOSTNAME&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; database server host or socket directory<br>&nbsp; -p, --port=PORT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; database server port<br>&nbsp; -U, --username=USERNAME&nbsp;&nbsp; user name to connect as<br>&nbsp; -w, --no-password&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; never prompt for password<br>&nbsp; -W, --password&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; force password prompt</p>  <p>Generic options:<br>&nbsp; -e, --echo&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo queries<br>&nbsp; -E, --elevel=LEVEL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set output message level<br>&nbsp; --help&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; show this help, then exit<br>&nbsp; --version&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; output version information, then exit</p>  <p>Read the website for details. &lt;<a rel="nofollow" href="http://reorg.projects.postgresql.org/"   >http://reorg.projects.postgresql.org/</a>&gt;<br>Report bugs to &lt;<a rel="nofollow" href="mailto:reorg-general@lists.pgfoundry.org"   >reorg-general@lists.pgfoundry.org</a>&gt;.<br><a rel="nofollow" href="mailto:postgres@db-172-16-3-33"   >postgres@db-172-16-3-33</a>-&gt; pg_reorg -t test.tbl_test1 -o id -d test -U postgres<br><a rel="nofollow" href="mailto:postgres@db-172-16-3-33"   >postgres@db-172-16-3-33</a>-&gt; psql test test<br>psql (9.0beta2)<br>Type "help" for help.</p>  <p>test=&gt; select pg_relation_size('tbl_test1');<br>&nbsp;pg_relation_size <br>------------------<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 450560<br>(1 row)</p>  <p>test=&gt; select pg_relation_size('tbl_test1_pkey');<br>&nbsp;pg_relation_size <br>------------------<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 245760<br>(1 row)</p>  <p>同时可以看出，INDEX的值不变的话，怎么删除插入都不会改变INDEX的大小。</p>[参考]<div>1. http://pgxn.org/dist/pg_repack</div></div>
	</div>
</div>
</body>
</html>