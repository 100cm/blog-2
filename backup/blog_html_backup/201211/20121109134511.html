<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Oracle funciton convert to PostgreSQL plpgsql funciton example - 1</h2>
	<h5 id="">2012-11-09 13:45:11&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201210904138281/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>在日常使用中可能经常用到Oracle到PostgreSQL之间的函数转换. 下面举几个例子, 可以作为参考.</div><div><br></div><div>1. Oracle :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >CREATE OR REPLACE FUNCTION func_1 ( digoal_no &nbsp; &nbsp;IN VARCHAR2, &nbsp;--卡号</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cardPwd &nbsp; IN VARCHAR2, --密码</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; digoal_oid &nbsp; IN VARCHAR2 &nbsp;--订单号</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;)</font></div><div><font size="2"  >&nbsp; &nbsp;RETURN SYS_REFCURSOR</font></div><div><font size="2"  >IS</font></div><div><font size="2"  >&nbsp; &nbsp;result &nbsp; &nbsp; &nbsp; &nbsp; SYS_REFCURSOR; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-- 输出的游标</font></div><div><font size="2"  >&nbsp; &nbsp;v_result &nbsp; &nbsp; &nbsp; NUMBER; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -- 销卡结果</font></div><div><font size="2"  >&nbsp; &nbsp;v_digoal_pamount &nbsp; &nbsp;NUMBER; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -- 卡实际面额</font></div><div><font size="2"  >&nbsp; &nbsp;v_sign &nbsp; &nbsp; &nbsp; &nbsp; VARCHAR2 (256);</font></div><div><font size="2"  >&nbsp; &nbsp;v_digoal_no &nbsp; &nbsp; &nbsp; VARCHAR2 (50);</font></div><div><font size="2"  >&nbsp; &nbsp;v_userPwd &nbsp; &nbsp; &nbsp;VARCHAR2 (50);</font></div><div><font size="2"  >&nbsp; &nbsp;v_digoal_oid &nbsp; &nbsp; &nbsp;VARCHAR2 (50);</font></div><div><font size="2"  >&nbsp; &nbsp;v_cardPwd &nbsp; &nbsp; &nbsp;VARCHAR2 (50);</font></div><div><font size="2"  >&nbsp; &nbsp;v_digoal_amount &nbsp; NUMBER;</font></div><div><font size="2"  >&nbsp; &nbsp;v_status &nbsp; &nbsp; &nbsp; CHAR (1);</font></div><div><font size="2"  >&nbsp; &nbsp;v_expriydate &nbsp; DATE;</font></div><div><font size="2"  >&nbsp; &nbsp;v_row &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;NUMBER;</font></div><div><font size="2"  >BEGIN</font></div><div><font size="2"  >&nbsp; &nbsp;v_result := 200;</font></div><div><font size="2"  >&nbsp; &nbsp;v_digoal_pamount := 0;</font></div><div><font size="2"  >&nbsp; &nbsp;v_digoal_no := digoal_no;</font></div><div><font size="2"  >&nbsp; &nbsp;v_userPwd := cardPwd;</font></div><div><font size="2"  >&nbsp; &nbsp;v_digoal_oid := digoal_oid;</font></div><div><font size="2"  >&nbsp; &nbsp;v_row := 0;</font></div><div><font size="2"  >&nbsp; &nbsp;--根据卡号获取记录</font></div><div><font size="2"  >&nbsp; &nbsp;SELECT cardpwd,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; digoal_amount,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; status,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; expiretime,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; verifystring</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;INTO v_cardPwd,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v_digoal_amount,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v_status,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v_expriydate,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v_sign</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;FROM TBL_CARD_INFO</font></div><div><font size="2"  >&nbsp; &nbsp; WHERE digoal_no = v_digoal_no;</font></div><div><font size="2"  >&nbsp; &nbsp;--密码匹配</font></div><div><font size="2"  >&nbsp; &nbsp;IF (v_cardPwd &lt;&gt; v_userPwd)</font></div><div><font size="2"  >&nbsp; &nbsp;THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; v_result := 140002;</font></div><div><font size="2"  >&nbsp; &nbsp;ELSE</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; IF (v_expriydate IS NULL)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_result := 140001;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; --过期时间判断</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; ELSE</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;IF (SYSDATE &gt;= v_expriydate)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v_result := 140003;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ELSE</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --卡状态判断</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IF (v_status = '0')</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--初始状态</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_result := 140001;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ELSIF (v_status = '2')</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--封停状态</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_result := 140010;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ELSIF (v_status = '3')</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--过期状态</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_result := 140003;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ELSIF (v_status = '4')</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--已使用状态</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_result := 140004;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ELSE</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--正常状态</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;UPDATE TBL_CARD_INFO</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SET status = '4',</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; usetime = SYSDATE,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; updatetime = SYSDATE,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; remark = v_digoal_oid</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WHERE digoal_no = v_digoal_no AND status &lt;&gt; '4';</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_row := SQL%ROWCOUNT;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;IF (v_row = 1)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --判断影响行,如果为一行则表示成功消卡</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v_digoal_pamount := v_digoal_amount;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ELSE</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --判断影响行,如果为零行，则表示卡状态已经被改变</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v_digoal_pamount := 0;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v_result := 140004;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;END IF;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; END IF;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;END IF;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; END IF;</font></div><div><font size="2"  >&nbsp; &nbsp;END IF;</font></div><div><font size="2"  >&nbsp; &nbsp;COMMIT;</font></div><div><font size="2"  >&nbsp; &nbsp;OPEN result FOR</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; SELECT v_result AS result, v_digoal_pamount AS digoal_pamount, v_sign AS signStr</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; FROM DUAL;</font></div><div><font size="2"  >&nbsp; &nbsp;RETURN result;</font></div><div><font size="2"  >EXCEPTION</font></div><div><font size="2"  >&nbsp; &nbsp;WHEN NO_DATA_FOUND</font></div><div><font size="2"  >&nbsp; &nbsp;THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; v_result := 140001;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; OPEN result FOR</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SELECT v_result AS result,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v_digoal_pamount AS digoal_pamount,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v_sign AS signStr</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;FROM DUAL;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; RETURN result;</font></div><div><font size="2"  >&nbsp; &nbsp;WHEN OTHERS</font></div><div><font size="2"  >&nbsp; &nbsp;THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; ROLLBACK;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; v_result := 140009;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; OPEN result FOR</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SELECT v_result AS result,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v_digoal_pamount AS digoal_pamount,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v_sign AS signStr</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;FROM DUAL;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; RETURN result;</font></div><div><font size="2"  >END func_1;</font></div><p></p></pre></div><div>&nbsp;</div><div>1. PostgreSQL :&nbsp;</div><div>修改几处,&nbsp;</div><div>1. 输入变量名与表内字段重名, 所以需要修改输入变量名.</div><div>2. 游标输出改成record输出.</div><div>3. 增加exception信息捕获和输出.</div><div>RAISE notice 'SQLSTATE:%, SQLERRM:%.', SQLSTATE, SQLERRM;</div><div>4. if else end if;太多, 其中一个改成CASE END CASE;</div><div>5. 字段类型名修改, 这里使用text, 以后如果表的字段长度扩充的, 不需要修改这个函数.</div><div>6. sysdate对应now().</div><div>7. 获取行数v_row := SQL%ROWCOUNT;对应 GET DIAGNOSTICS v_row = ROW_COUNT;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >CREATE OR REPLACE FUNCTION func_1&nbsp;</font></div><div><font size="2"  >(i_digoal_no &nbsp;IN text, &nbsp;-- 卡号</font></div><div><font size="2"  >&nbsp;i_cardpwd &nbsp; IN text, &nbsp;-- 密码</font></div><div><font size="2"  >&nbsp;i_digoal_oid &nbsp; IN text, &nbsp;-- 订单号</font></div><div><font size="2"  >&nbsp;v_result &nbsp;OUT numeric, &nbsp;-- 销卡结果</font></div><div><font size="2"  >&nbsp;v_digoal_pamount &nbsp;OUT numeric, &nbsp;-- 卡实际面额</font></div><div><font size="2"  >&nbsp;v_sign &nbsp; &nbsp;OUT &nbsp;text</font></div><div><font size="2"  >) returns record as $_$</font></div><div><font size="2"  >DECLARE</font></div><div><font size="2"  >&nbsp; &nbsp;v_digoal_no &nbsp; &nbsp; &nbsp; text;</font></div><div><font size="2"  >&nbsp; &nbsp;v_userpwd &nbsp; &nbsp; &nbsp;text;</font></div><div><font size="2"  >&nbsp; &nbsp;v_digoal_oid &nbsp; &nbsp; &nbsp;text;</font></div><div><font size="2"  >&nbsp; &nbsp;v_cardpwd &nbsp; &nbsp; &nbsp;text;</font></div><div><font size="2"  >&nbsp; &nbsp;v_digoal_amount &nbsp; numeric;</font></div><div><font size="2"  >&nbsp; &nbsp;v_status &nbsp; &nbsp; &nbsp; char(1);</font></div><div><font size="2"  >&nbsp; &nbsp;v_expriydate &nbsp; timestamp without time zone;</font></div><div><font size="2"  >&nbsp; &nbsp;v_row &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;INT8;</font></div><div><font size="2"  >BEGIN</font></div><div><font size="2"  >&nbsp; &nbsp;v_result := 200;</font></div><div><font size="2"  >&nbsp; &nbsp;v_digoal_pamount := 0;</font></div><div><font size="2"  >&nbsp; &nbsp;v_digoal_no := i_digoal_no;</font></div><div><font size="2"  >&nbsp; &nbsp;v_userpwd := i_cardPwd;</font></div><div><font size="2"  >&nbsp; &nbsp;v_digoal_oid := i_digoal_oid;</font></div><div><font size="2"  >&nbsp; &nbsp;v_row := 0;</font></div><div><font size="2"  >&nbsp; &nbsp;-- 根据卡号获取记录</font></div><div><font size="2"  >&nbsp; &nbsp;SELECT cardpwd,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; digoal_amount,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; status,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; expiretime,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; verifystring</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;INTO v_cardpwd,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v_digoal_amount,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v_status,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v_expriydate,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v_sign</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;FROM TBL_CARD_INFO</font></div><div><font size="2"  >&nbsp; &nbsp; WHERE digoal_no = v_digoal_no limit 1;</font></div><div><font size="2"  >&nbsp; &nbsp;IF NOT FOUND THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; v_result := 140001;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; RETURN;</font></div><div><font size="2"  >&nbsp; &nbsp;END IF;</font></div><div><font size="2"  >&nbsp; &nbsp;-- 密码匹配</font></div><div><font size="2"  >&nbsp; &nbsp;IF (v_cardpwd &lt;&gt; v_userpwd) THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; v_result := 140002;</font></div><div><font size="2"  >&nbsp; &nbsp;ELSE</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; IF (v_expriydate IS NULL) THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_result := 140001;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; -- 过期时间判断</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; ELSE</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;IF (now() &gt;= v_expriydate) THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v_result := 140003;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ELSE</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --卡状态判断</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CASE v_status</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;WHEN '0' THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; --初始状态</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_result := 140001;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WHEN '2' THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--封停状态</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_result := 140010;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WHEN '3' THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--过期状态</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_result := 140003;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WHEN '4' THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--已使用状态</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_result := 140004;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ELSE</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--正常状态</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;UPDATE TBL_CARD_INFO</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SET status = '4',</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; usetime = now(),</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; updatetime = now(),</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; remark = v_digoal_oid</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WHERE digoal_no = v_digoal_no AND status &lt;&gt; '4';</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;GET DIAGNOSTICS v_row = ROW_COUNT;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;IF (v_row = 1) THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --判断影响行,如果为一行则表示成功消卡</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v_digoal_pamount := v_digoal_amount;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ELSE</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --判断影响行, 如果为零行，则表示卡状态已经被改变</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v_digoal_pamount := 0;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v_result := 140004;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;END IF;</font></div><div><font size="2"  >/* 这里也可以使用FOUND变量来进行判断, 代替上面的IF ... THEN ... ELSE ... END IF;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;IF FOUND THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_digoal_pamount := v_digoal_amount;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ELSE</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_digoal_pamount := 0;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_result := 140004;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;END IF;</font></div><div><font size="2"  >*/</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; END CASE;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;END IF;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; END IF;</font></div><div><font size="2"  >&nbsp; &nbsp;END IF;</font></div><div><font size="2"  >&nbsp; &nbsp;RETURN;</font></div><div><font size="2"  >EXCEPTION&nbsp;</font></div><div><font size="2"  >&nbsp; WHEN OTHERS THEN</font></div><div><font size="2"  >&nbsp; &nbsp; v_result := 140009;</font></div><div><font size="2"  >&nbsp; &nbsp; RAISE notice 'SQLSTATE:%, SQLERRM:%.', SQLSTATE, SQLERRM;</font></div><div><font size="2"  >&nbsp; &nbsp; RETURN;</font></div><div><font size="2"  >END;</font></div><div><font size="2"  >$_$ language plpgsql;</font></div><p></p></pre></div><div><br></div><div>2. Oracle :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >CREATE OR REPLACE FUNCTION func_2 (</font></div><div><font size="2"  >&nbsp; &nbsp;dealerId &nbsp; &nbsp; &nbsp; IN NUMBER, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--商户编号</font></div><div><font size="2"  >&nbsp; &nbsp;skyId &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;IN NUMBER, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --密码</font></div><div><font size="2"  >&nbsp; &nbsp;digoal_oid &nbsp; &nbsp; &nbsp; &nbsp;IN VARCHAR2, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --订单号</font></div><div><font size="2"  >&nbsp; &nbsp;paydigoal_oid &nbsp; &nbsp; IN VARCHAR2, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --支付订单号</font></div><div><font size="2"  >&nbsp; &nbsp;orderMoney &nbsp; &nbsp; IN NUMBER, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--订单金额，单位：分</font></div><div><font size="2"  >&nbsp; &nbsp;digoal &nbsp; &nbsp; &nbsp; IN NUMBER, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--支付金额，单位：分</font></div><div><font size="2"  >&nbsp; &nbsp;status &nbsp; &nbsp; &nbsp; &nbsp; IN VARCHAR2, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--状态</font></div><div><font size="2"  >&nbsp; &nbsp;failureCause &nbsp; IN VARCHAR2, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--失败原因</font></div><div><font size="2"  >&nbsp; &nbsp;terminalIp &nbsp; &nbsp; IN VARCHAR2, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--终端IP</font></div><div><font size="2"  >&nbsp; &nbsp;requestIp &nbsp; &nbsp; &nbsp;IN VARCHAR2, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--请求IP</font></div><div><font size="2"  >&nbsp; &nbsp;serverId &nbsp; &nbsp; &nbsp; IN VARCHAR2, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--服务编号</font></div><div><font size="2"  >&nbsp; &nbsp;areaId &nbsp; &nbsp; &nbsp; &nbsp; IN VARCHAR2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --区域编号</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;)</font></div><div><font size="2"  >&nbsp; &nbsp;RETURN SYS_REFCURSOR</font></div><div><font size="2"  >IS</font></div><div><font size="2"  >&nbsp; &nbsp;result &nbsp; &nbsp; &nbsp; &nbsp; SYS_REFCURSOR;</font></div><div><font size="2"  >&nbsp; &nbsp;v_result &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; INTEGER; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--输出的值</font></div><div><font size="2"  >&nbsp; &nbsp;v_dealerId &nbsp; &nbsp; &nbsp; NUMBER (8); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --商户编号</font></div><div><font size="2"  >&nbsp; &nbsp;v_skyId &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;NUMBER (10); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--密码</font></div><div><font size="2"  >&nbsp; &nbsp;v_digoal_oid &nbsp; &nbsp; &nbsp; &nbsp;VARCHAR2 (50); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --订单号</font></div><div><font size="2"  >&nbsp; &nbsp;v_paydigoal_oid &nbsp; &nbsp; VARCHAR2 (50); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --支付订单号</font></div><div><font size="2"  >&nbsp; &nbsp;v_orderMoney &nbsp; &nbsp; NUMBER (8); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--订单金额，单位：分</font></div><div><font size="2"  >&nbsp; &nbsp;v_digoal &nbsp; &nbsp; &nbsp; NUMBER (8); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--支付金额，单位：分</font></div><div><font size="2"  >&nbsp; &nbsp;v_status &nbsp; &nbsp; &nbsp; &nbsp; VARCHAR2 (1); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --状态</font></div><div><font size="2"  >&nbsp; &nbsp;v_failureCause &nbsp; VARCHAR2 (6); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --失败原因</font></div><div><font size="2"  >&nbsp; &nbsp;v_terminalIp &nbsp; &nbsp; VARCHAR2 (15); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--终端IP</font></div><div><font size="2"  >&nbsp; &nbsp;v_requestIp &nbsp; &nbsp; &nbsp;VARCHAR2 (15); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--请求IP</font></div><div><font size="2"  >&nbsp; &nbsp;v_serverId &nbsp; &nbsp; &nbsp; VARCHAR2 (6); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --服务编号</font></div><div><font size="2"  >&nbsp; &nbsp;v_areaId &nbsp; &nbsp; &nbsp; &nbsp; VARCHAR2 (6); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --区域编号</font></div><div><font size="2"  >&nbsp; &nbsp;v_b_digoal &nbsp; &nbsp; &nbsp; &nbsp;NUMBER (10);</font></div><div><font size="2"  >&nbsp; &nbsp;v_remindAmount &nbsp; NUMBER (10);</font></div><div><font size="2"  >&nbsp; &nbsp;v_dealerStatus &nbsp; VARCHAR2 (1);</font></div><div><font size="2"  >BEGIN</font></div><div><font size="2"  >&nbsp; &nbsp;v_result := 200;</font></div><div><font size="2"  >&nbsp; &nbsp;v_b_digoal := 0;</font></div><div><font size="2"  >&nbsp; &nbsp;v_dealerId := dealerId;</font></div><div><font size="2"  >&nbsp; &nbsp;v_skyId := skyId;</font></div><div><font size="2"  >&nbsp; &nbsp;v_digoal_oid := digoal_oid;</font></div><div><font size="2"  >&nbsp; &nbsp;v_paydigoal_oid := paydigoal_oid;</font></div><div><font size="2"  >&nbsp; &nbsp;v_orderMoney := orderMoney;</font></div><div><font size="2"  >&nbsp; &nbsp;v_digoal := digoal;</font></div><div><font size="2"  >&nbsp; &nbsp;v_status := status;</font></div><div><font size="2"  >&nbsp; &nbsp;v_failureCause := failureCause;</font></div><div><font size="2"  >&nbsp; &nbsp;v_terminalIp := terminalIp;</font></div><div><font size="2"  >&nbsp; &nbsp;v_requestIp := requestIp;</font></div><div><font size="2"  >&nbsp; &nbsp;v_serverId := serverId;</font></div><div><font size="2"  >&nbsp; &nbsp;v_areaId := areaId;</font></div><div><font size="2"  >&nbsp; &nbsp;--获取经销商记录</font></div><div><font size="2"  >&nbsp; &nbsp;SELECT b_digoal, remindamount, status</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;INTO v_b_digoal, v_remindAmount, v_dealerStatus</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;FROM TBL_DIRECT_DEALER_INFO</font></div><div><font size="2"  >&nbsp; &nbsp; WHERE dealerId = v_dealerId</font></div><div><font size="2"  >&nbsp; &nbsp;FOR UPDATE;</font></div><div><font size="2"  >&nbsp; &nbsp;IF (v_status = '0')</font></div><div><font size="2"  >&nbsp; &nbsp;THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; --充值成功</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; --更新余额</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; v_b_digoal := v_b_digoal - v_digoal;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; IF (v_b_digoal &lt;= v_remindAmount)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--如果余额小于提醒金额,更改经销商状态</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_dealerStatus := '2';</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; END IF;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; UPDATE TBL_DIRECT_DEALER_INFO</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SET b_digoal = b_digoal - v_digoal, status = v_dealerStatus</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;WHERE dealerId = v_dealerId;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; --插入直充记录</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; INSERT INTO tbl_direct_pay_info (ID,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;DEALERID,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SKYID,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;digoal_oid,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PAYdigoal_oid,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ORDERMONEY,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;digoal,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;STATUS,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;FAILURECAUSE,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;digoal_time,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;TERMINALIP,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;b_digoal,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;REQUESTIP,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SERVERID,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;AREAID)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;VALUES (SEQ_DIRECT_PAY_INFO.NEXTVAL,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_dealerId,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_skyId,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_digoal_oid,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_paydigoal_oid,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_orderMoney,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_digoal,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_status,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_failureCause,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SYSDATE,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_terminalIp,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_b_digoal,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_requestIp,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_serverId,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_areaId);</font></div><div><font size="2"  >&nbsp; &nbsp;ELSIF (v_status = '1')</font></div><div><font size="2"  >&nbsp; &nbsp;THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; --充值失败</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; INSERT INTO tbl_direct_pay_info (ID,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;DEALERID,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SKYID,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;digoal_oid,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PAYdigoal_oid,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ORDERMONEY,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;digoal,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;STATUS,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;FAILURECAUSE,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;digoal_time,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;TERMINALIP,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;b_digoal,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;REQUESTIP,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SERVERID,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;AREAID)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;VALUES (SEQ_DIRECT_PAY_INFO.NEXTVAL,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_dealerId,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_skyId,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_digoal_oid,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_paydigoal_oid,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_orderMoney,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_status,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_failureCause,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SYSDATE,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_terminalIp,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_b_digoal,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_requestIp,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_serverId,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_areaId);</font></div><div><font size="2"  >&nbsp; &nbsp;END IF;</font></div><div><font size="2"  >&nbsp; &nbsp;COMMIT;</font></div><div><font size="2"  >&nbsp; &nbsp;OPEN result FOR</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SELECT v_result AS result,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v_b_digoal AS b_digoal</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;FROM DUAL;</font></div><div><font size="2"  >&nbsp; &nbsp;RETURN result;</font></div><div><font size="2"  >EXCEPTION</font></div><div><font size="2"  >&nbsp; &nbsp;WHEN NO_DATA_FOUND</font></div><div><font size="2"  >&nbsp; &nbsp;THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; v_result := 150007;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; OPEN result FOR</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SELECT v_result AS result,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v_b_digoal AS b_digoal</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;FROM DUAL;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; RETURN result;</font></div><div><font size="2"  >&nbsp; &nbsp;WHEN OTHERS</font></div><div><font size="2"  >&nbsp; &nbsp;THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; ROLLBACK;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; v_result := 150012;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; OPEN result FOR</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SELECT v_result AS result,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; v_b_digoal AS b_digoal</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;FROM DUAL;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; RETURN result;</font></div><div><font size="2"  >END func_2;</font></div><p></p></pre></div><div><br></div><div>2. PostgreSQL :&nbsp;</div><div>1. 序列如果不在优先路径的话, 可以使用'schema.seq_name'::regclass .&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >CREATE OR REPLACE FUNCTION func_2&nbsp;</font></div><div><font size="2"  >(</font></div><div><font size="2"  >&nbsp; &nbsp;i_dealerId &nbsp; &nbsp; &nbsp; IN numeric, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--商户编号</font></div><div><font size="2"  >&nbsp; &nbsp;i_skyId &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;IN numeric, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --密码</font></div><div><font size="2"  >&nbsp; &nbsp;i_digoal_oid &nbsp; &nbsp; &nbsp; &nbsp;IN text, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --订单号</font></div><div><font size="2"  >&nbsp; &nbsp;i_paydigoal_oid &nbsp; &nbsp; IN text, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --支付订单号</font></div><div><font size="2"  >&nbsp; &nbsp;i_orderMoney &nbsp; &nbsp; IN numeric, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--订单金额，单位：分</font></div><div><font size="2"  >&nbsp; &nbsp;i_digoal &nbsp; &nbsp; &nbsp; IN numeric, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--支付金额，单位：分</font></div><div><font size="2"  >&nbsp; &nbsp;i_status &nbsp; &nbsp; &nbsp; &nbsp; IN text, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--状态</font></div><div><font size="2"  >&nbsp; &nbsp;i_failureCause &nbsp; IN text, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--失败原因</font></div><div><font size="2"  >&nbsp; &nbsp;i_terminalIp &nbsp; &nbsp; IN text, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--终端IP</font></div><div><font size="2"  >&nbsp; &nbsp;i_requestIp &nbsp; &nbsp; &nbsp;IN text, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--请求IP</font></div><div><font size="2"  >&nbsp; &nbsp;i_serverId &nbsp; &nbsp; &nbsp; IN text, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--服务编号</font></div><div><font size="2"  >&nbsp; &nbsp;i_areaId &nbsp; &nbsp; &nbsp; &nbsp; IN text, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --区域编号</font></div><div><font size="2"  >&nbsp; &nbsp;v_result &nbsp; &nbsp; &nbsp; OUT &nbsp; &nbsp;INT, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --输出的值</font></div><div><font size="2"  >&nbsp; &nbsp;v_b_digoal &nbsp; &nbsp; &nbsp;OUT &nbsp;numeric (10)</font></div><div><font size="2"  >)</font></div><div><font size="2"  >AS $_$</font></div><div><font size="2"  >DECLARE</font></div><div><font size="2"  >&nbsp; &nbsp;v_dealerId &nbsp; &nbsp; &nbsp; numeric (8); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --商户编号</font></div><div><font size="2"  >&nbsp; &nbsp;v_skyId &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;numeric (10); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--密码</font></div><div><font size="2"  >&nbsp; &nbsp;v_digoal_oid &nbsp; &nbsp; &nbsp; &nbsp;text; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --订单号</font></div><div><font size="2"  >&nbsp; &nbsp;v_paydigoal_oid &nbsp; &nbsp; text; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --支付订单号</font></div><div><font size="2"  >&nbsp; &nbsp;v_orderMoney &nbsp; &nbsp; numeric (8); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--订单金额，单位：分</font></div><div><font size="2"  >&nbsp; &nbsp;v_digoal &nbsp; &nbsp; &nbsp; numeric (8); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--支付金额，单位：分</font></div><div><font size="2"  >&nbsp; &nbsp;v_status &nbsp; &nbsp; &nbsp; &nbsp; text; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --状态</font></div><div><font size="2"  >&nbsp; &nbsp;v_failureCause &nbsp; text; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --失败原因</font></div><div><font size="2"  >&nbsp; &nbsp;v_terminalIp &nbsp; &nbsp; text; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--终端IP</font></div><div><font size="2"  >&nbsp; &nbsp;v_requestIp &nbsp; &nbsp; &nbsp;text; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--请求IP</font></div><div><font size="2"  >&nbsp; &nbsp;v_serverId &nbsp; &nbsp; &nbsp; text; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --服务编号</font></div><div><font size="2"  >&nbsp; &nbsp;v_areaId &nbsp; &nbsp; &nbsp; &nbsp; text; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; --区域编号</font></div><div><font size="2"  >&nbsp; &nbsp;v_remindAmount &nbsp; numeric (10);</font></div><div><font size="2"  >&nbsp; &nbsp;v_dealerStatus &nbsp; text;</font></div><div><font size="2"  >BEGIN</font></div><div><font size="2"  >&nbsp; &nbsp;v_result := 200;</font></div><div><font size="2"  >&nbsp; &nbsp;v_b_digoal := 0;</font></div><div><font size="2"  >&nbsp; &nbsp;v_dealerId := i_dealerId;</font></div><div><font size="2"  >&nbsp; &nbsp;v_skyId := i_skyId;</font></div><div><font size="2"  >&nbsp; &nbsp;v_digoal_oid := i_digoal_oid;</font></div><div><font size="2"  >&nbsp; &nbsp;v_paydigoal_oid := i_paydigoal_oid;</font></div><div><font size="2"  >&nbsp; &nbsp;v_orderMoney := i_orderMoney;</font></div><div><font size="2"  >&nbsp; &nbsp;v_digoal := i_digoal;</font></div><div><font size="2"  >&nbsp; &nbsp;v_status := i_status;</font></div><div><font size="2"  >&nbsp; &nbsp;v_failureCause := i_failureCause;</font></div><div><font size="2"  >&nbsp; &nbsp;v_terminalIp := i_terminalIp;</font></div><div><font size="2"  >&nbsp; &nbsp;v_requestIp := i_requestIp;</font></div><div><font size="2"  >&nbsp; &nbsp;v_serverId := i_serverId;</font></div><div><font size="2"  >&nbsp; &nbsp;v_areaId := i_areaId;</font></div><div><font size="2"  >&nbsp; &nbsp;--获取经销商记录</font></div><div><font size="2"  >&nbsp; &nbsp;SELECT b_digoal, remindamount, status</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;INTO v_b_digoal, v_remindAmount, v_dealerStatus</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;FROM TBL_DIRECT_DEALER_INFO</font></div><div><font size="2"  >&nbsp; &nbsp; WHERE dealerId = v_dealerId</font></div><div><font size="2"  >&nbsp; &nbsp;FOR UPDATE;</font></div><div><font size="2"  ><span style="line-height: 19px;"  >   IF NOT FOUND THEN<br>     v_result := 150007;<br>     RETURN;<br>   END IF;</span></font></div><div><font size="2"  >   IF (v_status = '0')</font></div><div><font size="2"  >&nbsp; &nbsp;THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; --充值成功</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; --更新余额</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; v_b_digoal := v_b_digoal - v_digoal;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; IF (v_b_digoal &lt;= v_remindAmount) THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--如果余额小于提醒金额,更改经销商状态</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_dealerStatus := '2';</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; END IF;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; UPDATE TBL_DIRECT_DEALER_INFO</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SET b_digoal = b_digoal - v_digoal, status = v_dealerStatus</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;WHERE dealerId = v_dealerId;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; --插入直充记录</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; INSERT INTO tbl_direct_pay_info (ID,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;DEALERID,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SKYID,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;digoal_oid,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PAYdigoal_oid,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ORDERMONEY,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;digoal,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;STATUS,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;FAILURECAUSE,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;digoal_time,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;TERMINALIP,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;b_digoal,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;REQUESTIP,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SERVERID,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;AREAID)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;VALUES (nextval('seq_direct_pay_info'::regclass),</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_dealerId,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_skyId,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_digoal_oid,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_paydigoal_oid,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_orderMoney,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_digoal,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_status,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_failureCause,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;now(),</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_terminalIp,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_b_digoal,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_requestIp,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_serverId,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_areaId);</font></div><div><font size="2"  >&nbsp; &nbsp;ELSIF (v_status = '1') THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; --充值失败</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; INSERT INTO tbl_direct_pay_info (ID,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;DEALERID,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SKYID,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;digoal_oid,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PAYdigoal_oid,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ORDERMONEY,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;digoal,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;STATUS,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;FAILURECAUSE,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;digoal_time,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;TERMINALIP,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;b_digoal,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;REQUESTIP,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SERVERID,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;AREAID)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;VALUES (nextval('seq_direct_pay_info'::regclass),</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_dealerId,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_skyId,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_digoal_oid,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_paydigoal_oid,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_orderMoney,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_status,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_failureCause,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;now(),</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_terminalIp,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_b_digoal,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_requestIp,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_serverId,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;v_areaId);</font></div><div><font size="2"  >&nbsp; &nbsp;END IF;</font></div><div><font size="2"  >&nbsp; &nbsp;RETURN;</font></div><div><font size="2"  >EXCEPTION</font></div><div><font size="2"  >&nbsp; &nbsp;WHEN OTHERS THEN</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; v_result := 150012;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; RAISE notice 'SQLSTATE:%, SQLERRM:%.', SQLSTATE, SQLERRM;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; RETURN;</font></div><div><font size="2"  >END;</font></div><div><font size="2"  >$_$ language plpgsql;</font></div><p></p></pre></div><div><br></div><div>【参考】</div><div>1.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/plpgsql.html"  >http://www.postgresql.org/docs/9.2/static/plpgsql.html</a></div><div>2.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/plpgsql-statements.html"  >http://www.postgresql.org/docs/9.2/static/plpgsql-statements.html</a></div><div>3. src/pl/plpgsql/src/plerrcodes.h</div><div>4. src/backend/utils/errcodes.txt</div><div>5.</div><div>The second method to determine the effects of a command is to check the special variable named FOUND, which is of type boolean. FOUND starts out false within each PL/pgSQL function call. It is set by each of the following types of statements:</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >1. A SELECT INTO statement sets FOUND true if a row is assigned, false if no row is returned.</font></div><div><font size="2"  >2. A PERFORM statement sets FOUND true if it produces (and discards) one or more rows, false if no row is produced.</font></div><div><font size="2"  >3. UPDATE, INSERT, and DELETE statements set FOUND true if at least one row is affected, false if no row is affected.</font></div><div><font size="2"  >4. A FETCH statement sets FOUND true if it returns a row, false if no row is returned.</font></div><div><font size="2"  >5. A MOVE statement sets FOUND true if it successfully repositions the cursor, false otherwise.</font></div><div><font size="2"  >6. A FOR or FOREACH statement sets FOUND true if it iterates one or more times, else false. FOUND is set this way when the loop exits; inside the execution of the loop, FOUND is not modified by the loop statement, although it might be changed by the execution of other statements within the loop body.</font></div><div><font size="2"  >7. RETURN QUERY and RETURN QUERY EXECUTE statements set FOUND true if the query returns at least one row, false if no row is returned.</font></div><div><font size="2"  >8. Other PL/pgSQL statements do not change the state of FOUND. Note in particular that EXECUTE changes the output of GET DIAGNOSTICS, but does not change FOUND.</font></div><div><font size="2"  >9. FOUND is a local variable within each PL/pgSQL function; any changes to it affect only the current function.</font></div><p></p></pre></div></div></div>
	</div>
</div>
</body>
</html>