<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL tuning case: multi materialized table to single source table</h2>
	<h5 id="">2012-11-01 16:08:35&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020121013294231/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>最近在搞某项目从Oracle迁移到PostgreSQL的事情, 其中有个数据监控系统, 原来的做法是把生产Oracle里的单个表同步出来到监控数据库的2个表里面, 然后在监控数据库里面这两个表和其他的表进行关联统计. 其实就是用户的订单信息和订单确认信息进行关联, 统计实际确认的订单信息.</div><div>切换到PostgreSQL后, 不打算再专门设立监控数据库, 而是让监控系统直接连生产数据库进行统计, 并且不打算把原来的单个表拆成2个表, 也就是说用户的订单记录和确认记录还是往同一个表插入.&nbsp;</div><div>所以切换后的监控SQL需要变一变, 其实也挺简单的, 只是用到了WITH, 窗口函数, 函数索引来进行优化.&nbsp;</div><div>总体来说和前面一篇《<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012651054869/"  >SQL tuning example(max speedup 2400 times) : use function index and use window function prevent subquery</a>》比较类似.</div><div>下面简单的讲解一下 :&nbsp;</div><div>1. 原来Oracle的数据同步过程如下 :&nbsp;</div><div>1.1&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >PROCEDURE &nbsp; &nbsp; p_sync_digoal_new as</font></div><div><font size="2"  >&nbsp; v_sql &nbsp;varchar2(2000);</font></div><div><font size="2"  >&nbsp; v_max_id number;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >&nbsp; &nbsp; --ump</font></div><div><font size="2"  >&nbsp; &nbsp; select max(id) into v_max_id from tbl_app_digoal_ump;</font></div><div><font size="2"  >&nbsp; &nbsp; insert into tbl_app_digoal_ump nologging select id,mobile,'32','500',price/100 as price,createtime,status,orderid</font></div><div><font size="2"  >&nbsp; &nbsp; from chss.TBL_digoal_ORDER_INFO@ump</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; where id&gt;v_max_id;</font></div><div><font size="2"  >&nbsp; &nbsp; commit;</font></div><div><font size="2"  >&nbsp; &nbsp; insert into tbl_app_digoal nologging</font></div><div><font size="2"  >&nbsp; &nbsp; select seq_app_digoal.nextval,phonenum,type,spcode,cost,motime,reserve,transactionid from tbl_app_digoal_ump</font></div><div><font size="2"  >&nbsp; &nbsp; where id&gt;v_max_id and motime is not null;</font></div><div><font size="2"  >&nbsp; &nbsp; commit;</font></div><div><font size="2"  >END p_sync_digoal_new;</font></div><p></p></pre></div><div>1.2&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >PROCEDURE &nbsp; &nbsp; p_sync_digoal_mr_new as</font></div><div><font size="2"  >&nbsp; v_sql &nbsp;varchar2(2000);</font></div><div><font size="2"  >&nbsp; v_max_id number;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >&nbsp; &nbsp; --ump</font></div><div><font size="2"  >&nbsp; &nbsp; select max(id) into v_max_id from tbl_app_digoal_mr_ump;</font></div><div><font size="2"  >&nbsp; &nbsp; insert into tbl_app_digoal_mr_ump nologging select id,'500',mobile,'DELIVRD',LASTNOTIFYTIME,orderid</font></div><div><font size="2"  >&nbsp; &nbsp; from chss.TBL_digoal_ORDER_INFO@ump</font></div><div><font size="2"  >&nbsp; &nbsp; where id&gt;v_max_id;</font></div><div><font size="2"  >&nbsp; &nbsp; commit;</font></div><div><font size="2"  >&nbsp; &nbsp; insert into tbl_app_digoal_mr nologging</font></div><div><font size="2"  >&nbsp; &nbsp; select seq_app_digoal_mr.nextval,spcode,phonenum,status,mrtime,transactionid from tbl_app_digoal_mr_ump</font></div><div><font size="2"  >&nbsp; &nbsp; where id&gt;v_max_id and mrtime is not null;</font></div><div><font size="2"  >&nbsp; &nbsp; commit;</font></div><div><font size="2"  >END p_sync_digoal_mr_new;</font></div><p></p></pre></div><div>其中涉及的表如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >CREATE TABLE TBL_APP_digoal</font></div><div><font size="2"  >(</font></div><div><font size="2"  >&nbsp; ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NUMBER(20) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NOT NULL,</font></div><div><font size="2"  >&nbsp; PHONENUM &nbsp; &nbsp; &nbsp; VARCHAR2(45 BYTE) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;NOT NULL,</font></div><div><font size="2"  >&nbsp; TYPE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; VARCHAR2(9 BYTE),</font></div><div><font size="2"  >&nbsp; SPCODE &nbsp; &nbsp; &nbsp; &nbsp; VARCHAR2(9 BYTE) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NOT NULL,</font></div><div><font size="2"  >&nbsp; COST &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; VARCHAR2(15 BYTE),</font></div><div><font size="2"  >&nbsp; MOTIME &nbsp; &nbsp; &nbsp; &nbsp; DATE,</font></div><div><font size="2"  >&nbsp; RESERVE &nbsp; &nbsp; &nbsp; &nbsp;VARCHAR2(6 BYTE),</font></div><div><font size="2"  >&nbsp; TRANSACTIONID &nbsp;VARCHAR2(96 BYTE)</font></div><div><font size="2"  >);</font></div><div><font size="2"  >CREATE TABLE TBL_APP_digoal_MR</font></div><div><font size="2"  >(</font></div><div><font size="2"  >&nbsp; ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NUMBER &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NOT NULL,</font></div><div><font size="2"  >&nbsp; SPCODE &nbsp; &nbsp; &nbsp; &nbsp; VARCHAR2(9 BYTE),</font></div><div><font size="2"  >&nbsp; PHONENUM &nbsp; &nbsp; &nbsp; VARCHAR2(45 BYTE),</font></div><div><font size="2"  >&nbsp; STATUS &nbsp; &nbsp; &nbsp; &nbsp; VARCHAR2(75 BYTE),</font></div><div><font size="2"  >&nbsp; MRTIME &nbsp; &nbsp; &nbsp; &nbsp; DATE,</font></div><div><font size="2"  >&nbsp; TRANSACTIONID &nbsp;VARCHAR2(96 BYTE)</font></div><div><font size="2"  >);</font></div><div><font size="2"  >CREATE TABLE TBL_APP_digoal_UMP</font></div><div><font size="2"  >(</font></div><div><font size="2"  >&nbsp; ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NUMBER(20) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NOT NULL,</font></div><div><font size="2"  >&nbsp; PHONENUM &nbsp; &nbsp; &nbsp; VARCHAR2(45 BYTE) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;NOT NULL,</font></div><div><font size="2"  >&nbsp; TYPE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; VARCHAR2(9 BYTE),</font></div><div><font size="2"  >&nbsp; SPCODE &nbsp; &nbsp; &nbsp; &nbsp; VARCHAR2(9 BYTE) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NOT NULL,</font></div><div><font size="2"  >&nbsp; COST &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; VARCHAR2(15 BYTE),</font></div><div><font size="2"  >&nbsp; MOTIME &nbsp; &nbsp; &nbsp; &nbsp; DATE,</font></div><div><font size="2"  >&nbsp; RESERVE &nbsp; &nbsp; &nbsp; &nbsp;VARCHAR2(6 BYTE),</font></div><div><font size="2"  >&nbsp; TRANSACTIONID &nbsp;VARCHAR2(96 BYTE)</font></div><div><font size="2"  >);</font></div><div><font size="2"  >CREATE TABLE TBL_APP_digoal_MR_UMP</font></div><div><font size="2"  >(</font></div><div><font size="2"  >&nbsp; ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NUMBER &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NOT NULL,</font></div><div><font size="2"  >&nbsp; SPCODE &nbsp; &nbsp; &nbsp; &nbsp; VARCHAR2(9 BYTE),</font></div><div><font size="2"  >&nbsp; PHONENUM &nbsp; &nbsp; &nbsp; VARCHAR2(45 BYTE),</font></div><div><font size="2"  >&nbsp; STATUS &nbsp; &nbsp; &nbsp; &nbsp; VARCHAR2(75 BYTE),</font></div><div><font size="2"  >&nbsp; MRTIME &nbsp; &nbsp; &nbsp; &nbsp; DATE,</font></div><div><font size="2"  >&nbsp; TRANSACTIONID &nbsp;VARCHAR2(96 BYTE)</font></div><div><font size="2"  >);</font></div><p></p></pre></div><div>监控系统的数据均来自chss.TBL_digoal_ORDER_INFO@ump这个表.&nbsp;</div><div>其中 LASTNOTIFYTIME is not null 的数据插入到了tbl_app_digoal_mr .</div><div>其中 createtime is not null 的数据插入到了tbl_app_digoal .</div><div><br></div><div>2. 监控程序用到了tbl_app_digoal和tbl_app_digoal_mr这两个表, 4个SQL如下 :&nbsp;</div><div>2.1 //SpMrStatisticsService</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >static final String SQL_SELECT_DATA_FROM_ORACLE = " select a1.spcode,sum(a1.cost) as income,count(0) as itemcount,a2.provincecode,a2.city,a2.provider "+</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; " from "+</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; " (select t1.spcode,t1.phonenum,t2.cost from tbl_app_digoal_mr t1,"+</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; " (select distinct phonenum,cost,transactionid,spcode from tbl_app_digoal) &nbsp;t2 "+</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; " where t1.status='DELIVRD' and "+</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; " substr(to_char(t1.mrtime,'yyyymmddhh24mi'),1,11)=? "+</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; " and t1.transactionid=t2.transactionid and t1.spcode=t2.spcode "+</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; " and t1.phonenum=t2.phonenum) a1,tbl_mobile a2 "+</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; " where substr(a1.phonenum,1,7)=a2.phonenum(+) "+</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; " group by a1.spcode,a2.provincecode,a2.city,a2.provider";</font></div><p></p></pre></div><div><br></div><div>2.2 //SpMoStatisticsService</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >static final String SQL_SELECT_DATA_FROM_ORACLE = "select t1.spcode,sum(to_number(t1.cost)) as mosum,t2.provider,t2.provincecode,t2.city,max(substr(to_char(t1.motime,'yyyymmddhh24mi'),1,11)) as stattime "</font></div><div><font size="2"  ><span>   </span>+ " from tbl_app_digoal t1,tbl_mobile t2 "</font></div><div><font size="2"  ><span>   </span>+ " where substr(t1.phonenum,1,7)=t2.phonenum(+) "</font></div><div><font size="2"  ><span>   </span>+ " and substr(to_char(t1.motime,'yyyymmddhh24mi'),1,11)=? "</font></div><div><font size="2"  ><span>   </span>+ " group by t2.provider,t1.spcode,t2.provincecode,t2.city";</font></div><p></p></pre></div><div><br></div><div>2.3 //MrStatisticService</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >static final String SQL_SELECT_DATA_FROM_ORACLE2</font></div><div><font size="2"  >&nbsp; &nbsp; ="select t1.newstatus as status,"</font></div><div><font size="2"  >&nbsp; &nbsp; +" t1.spcode,count(t1.id) as mrsum,t2.provider,t2.provincecode,t2.city, "</font></div><div><font size="2"  >&nbsp; &nbsp; +" max(substr(to_char(t1.mrtime,'yyyymmddhh24mi'),1,11)) as stattime "</font></div><div><font size="2"  >&nbsp; &nbsp; +" from "</font></div><div><font size="2"  >&nbsp; &nbsp; +" (select (case when status='DELIVRD' then 'DELIVRD' else '-1' &nbsp;end) &nbsp;newstatus,"</font></div><div><font size="2"  >&nbsp; &nbsp; +" spcode,phonenum,id,mrtime from tbl_app_digoal_mr "</font></div><div><font size="2"  >&nbsp; &nbsp; +" where &nbsp;substr(to_char(mrtime,'yyyymmddhh24mi'),1,11)=?) t1,tbl_mobile t2 "</font></div><div><font size="2"  >&nbsp; &nbsp; +" where substr(t1.phonenum,1,7)=t2.phonenum(+) "</font></div><div><font size="2"  >&nbsp; &nbsp; +" group by t2.provider,t2.provincecode,t1.spcode,newstatus,t2.city";</font></div><p></p></pre></div><div><br></div><div>2.4 //MoStatisticService</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >static final String SQL_SELECT_DATA_FROM_ORACLE2="select t1.newreserve as reserve,"</font></div><div><font size="2"  ><span> </span> &nbsp; +" t1.newtype as type,"<span> </span></font></div><div><font size="2"  ><span> </span> &nbsp; +" t1.spcode,count(t1.id) as mosum,t2.provider,t2.provincecode,t2.city, "</font></div><div><font size="2"  ><span> </span> &nbsp; +" max(substr(to_char(t1.motime,'yyyymmddhh24mi'),1,11)) as stattime "</font></div><div><font size="2"  ><span> </span> &nbsp; +" from "</font></div><div><font size="2"  ><span> </span> &nbsp; +" (select (case when reserve='0' then '0' else '-1' &nbsp;end) &nbsp;newreserve,"</font></div><div><font size="2"  ><span> </span> &nbsp; +" (case when type in('30','31') then 'wap' else 'sms' end) newtype,"</font></div><div><font size="2"  ><span> </span> &nbsp; +" spcode,phonenum,id,motime from tbl_app_digoal "</font></div><div><font size="2"  ><span> </span> &nbsp; +" where &nbsp;substr(to_char(motime,'yyyymmddhh24mi'),1,11)=?) t1,tbl_mobile t2 "</font></div><div><font size="2"  ><span> </span> &nbsp; +" where substr(t1.phonenum,1,7)=t2.phonenum(+) "</font></div><div><font size="2"  ><span> </span> &nbsp; +" group by t2.provider,t2.provincecode,t1.spcode,newreserve,t2.city,newtype";</font></div><p></p></pre></div><div><br></div><div>3. 切换到PostgreSQL后, tbl_digoal_order_info的表结构如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >CREATE TABLE tbl_digoal_order_info</font></div><div><font size="2"  >(</font></div><div><font size="2"  >&nbsp; id bigserial NOT NULL,</font></div><div><font size="2"  >&nbsp; orderid character varying(20),</font></div><div><font size="2"  >&nbsp; payid character varying(30) NOT NULL,</font></div><div><font size="2"  >&nbsp; userid character varying(32) NOT NULL,</font></div><div><font size="2"  >&nbsp; goodsid character varying(30) NOT NULL,</font></div><div><font size="2"  >&nbsp; price numeric NOT NULL,</font></div><div><font size="2"  >&nbsp; mobile character varying(30) NOT NULL,</font></div><div><font size="2"  >&nbsp; status character(1) NOT NULL,</font></div><div><font size="2"  >&nbsp; failurecause character varying(30),</font></div><div><font size="2"  >&nbsp; createtime timestamp without time zone DEFAULT now(),</font></div><div><font size="2"  >&nbsp; lastnotifytime timestamp with time zone,</font></div><div><font size="2"  >&nbsp; paytime timestamp with time zone,</font></div><div><font size="2"  >&nbsp; settletime timestamp with time zone</font></div><div><font size="2"  >)</font></div><div><font size="2"  >WITH (</font></div><div><font size="2"  >&nbsp; OIDS=FALSE</font></div><div><font size="2"  >);</font></div><p></p></pre></div><div><br></div><div>4. 所以现在要做的是把监控系统涉及的4个SQL转换成PostgreSQL里面的SQL, 并且不再使用中间表tbl_app_digoal和tbl_app_digoal_mr.</div><div>4.1 首先要理顺中间表和原始表的对应关系 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >4.1.1 materialized表 tbl_app_digoal :&nbsp;</font></div><div><font size="2"  >(id,phonenum,type,spcode,cost,motime,reserve,transactionid)</font></div><div><font size="2"  >对应 TBL_digoal_ORDER_INFO :&nbsp;</font></div><div><font size="2"  >id,mobile,'32','500',price/100 as price,createtime,status,orderid</font></div><div><font size="2"  >where createtime is not null;</font></div><p></p></pre></div><div><pre class="prettyprint"  ><div><font size="2"  >4.1.2 materialized表 tbl_app_digoal_mr :&nbsp;</font></div><div><font size="2"  >(id,spcode,phonenum,status,mrtime,transactionid)</font></div><div><font size="2"  >对应 TBL_digoal_ORDER_INFO :&nbsp;</font></div><div><font size="2"  >id,'500',mobile,'DELIVRD',LASTNOTIFYTIME,orderid</font></div><div><font size="2"  >where LASTNOTIFYTIME is not null</font></div><p></p></pre></div><div><br></div><div>4.2&nbsp;</div><div>使用最简单的方法WITH, 物化出2个中间表, 所以第一个SQL语句转换成 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >with&nbsp;</font></div><div><font size="2"  >tbl_app_digoal_mr as</font></div><div><font size="2"  >(</font></div><div><font size="2"  >select id,</font></div><div><font size="2"  >&nbsp; '500'::text as spcode,</font></div><div><font size="2"  >&nbsp; mobile as phonenum,</font></div><div><font size="2"  >&nbsp; 'DELIVRD' as status,</font></div><div><font size="2"  >&nbsp; LASTNOTIFYTIME as mrtime,</font></div><div><font size="2"  >&nbsp; orderid as transactionid</font></div><div><font size="2"  >&nbsp; from TBL_digoal_ORDER_INFO_201210</font></div><div><font size="2"  >&nbsp; where LASTNOTIFYTIME is not null</font></div><div><font size="2"  >&nbsp; and substr(to_char(LASTNOTIFYTIME,'yyyymmddhh24mi'),1,11)='20121031121'</font></div><div><font size="2"  >),</font></div><div><font size="2"  >tbl_app_digoal as&nbsp;</font></div><div><font size="2"  >(</font></div><div><font size="2"  >select id,</font></div><div><font size="2"  >&nbsp; mobile as phonenum,</font></div><div><font size="2"  >&nbsp; '32'::text as type,</font></div><div><font size="2"  >&nbsp; '500'::text as spcode,</font></div><div><font size="2"  >&nbsp; price/100 as cost,</font></div><div><font size="2"  >&nbsp; createtime as motime,</font></div><div><font size="2"  >&nbsp; status as reserve,</font></div><div><font size="2"  >&nbsp; orderid as transactionid&nbsp;</font></div><div><font size="2"  >&nbsp; from TBL_digoal_ORDER_INFO_201210</font></div><div><font size="2"  >&nbsp; where createtime is not null</font></div><div><font size="2"  >)</font></div><div><font size="2"  >select a1.spcode, sum(a1.cost) as income, count(0) as itemcount, a2.provincecode, a2.city, a2.provider&nbsp;</font></div><div><font size="2"  >&nbsp; from&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; (select t1.spcode,t1.phonenum,t2.cost from&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;tbl_app_digoal_mr t1,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;(select phonenum,cost,transactionid,spcode from tbl_app_digoal group by phonenum,cost,transactionid,spcode)&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;AS t2</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;where (t1.transactionid, t1.phonenum) = (t2.transactionid, t2.phonenum)</font></div><div><font size="2"  >&nbsp; &nbsp; ) AS a1</font></div><div><font size="2"  >&nbsp; &nbsp; left outer join</font></div><div><font size="2"  >&nbsp; &nbsp; tbl_mobile a2</font></div><div><font size="2"  >&nbsp; &nbsp; on ( substr(a1.phonenum,1,7) = a2.phonenum )</font></div><div><font size="2"  >&nbsp; &nbsp; group by a1.spcode,a2.provincecode,a2.city,a2.provider;</font></div><p></p></pre></div><div>但是这样效率就比较低了, 执行计划如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp;GroupAggregate &nbsp;(cost=673837.64..674321.18 rows=17583 width=75)</font></div><div><font size="2"  >&nbsp; &nbsp;CTE tbl_app_digoal_mr</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on tbl_digoal_order_info_201210 &nbsp;(cost=0.00..61475.64 rows=4396 width=49)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: ((lastnotifytime IS NOT NULL) AND (substr(to_char(lastnotifytime, 'yyyymmddhh24mi'::text), 1, 11) = '20121031121'</font></div><div><font size="2"  >::text))</font></div><div><font size="2"  >&nbsp; &nbsp;CTE tbl_app_digoal</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on tbl_digoal_order_info_201210 &nbsp;(cost=0.00..53476.03 rows=1599922 width=56)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (createtime IS NOT NULL)</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=558885.98..558929.94 rows=17583 width=75)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: t1.spcode, a2.provincecode, a2.city, a2.provider</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Merge Right Join &nbsp;(cost=548383.02..557142.21 rows=17583 width=75)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Merge Cond: ((a2.phonenum)::text = (substr((t1.phonenum)::text, 1, 7)))</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan using tbl_mobile_pkey on tbl_mobile a2 &nbsp;(cost=0.00..7214.90 rows=238526 width=19)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Materialize &nbsp;(cost=548383.02..548470.94 rows=17583 width=142)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=548383.02..548426.98 rows=17583 width=142)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: (substr((t1.phonenum)::text, 1, 7))</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Merge Join &nbsp;(cost=544823.35..546331.00 rows=17583 width=142)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Merge Cond: (((t2.transactionid)::text = (t1.transactionid)::text) AND ((t2.phonenum)::text = (t1.p</font></div><div><font size="2"  >honenum)::text))</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=544469.43..544869.42 rows=159993 width=168)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: t2.transactionid, t2.phonenum</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Subquery Scan on t2 &nbsp;(cost=492165.96..513764.92 rows=159993 width=168)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Group &nbsp;(cost=492165.96..512164.99 rows=159993 width=200)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=492165.96..496165.77 rows=1599922 width=200)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: tbl_app_digoal.phonenum, tbl_app_digoal.cost, tbl_app_digoal.tran</font></div><div><font size="2"  >sactionid, tbl_app_digoal.spcode</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;CTE Scan on tbl_app_digoal &nbsp;(cost=0.00..31998.44 rows=1599922 width=200</font></div><div><font size="2"  >)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=353.92..364.91 rows=4396 width=168)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: t1.transactionid, t1.phonenum</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;CTE Scan on tbl_app_digoal_mr t1 &nbsp;(cost=0.00..87.92 rows=4396 width=168)</font></div><p></p></pre></div><div>执行耗时 : 25469.754 ms</div><div>原因如下 :&nbsp;</div><div>4.2.1 to_char函数不是immutable的, 所以没法建立函数索引进行加速.</div><div>4.2.2 tbl_app_digoal这个中间表的数据量太大, 关联时将消耗大量的CPU.</div><div>优化如下 :&nbsp;</div><div>4.2.3 创建immutable的to_char函数, 并建立函数索引.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >CREATE OR REPLACE FUNCTION ts_to_char_immutable(i_time timestamp without time zone, i_format text)</font></div><div><font size="2"  >&nbsp;RETURNS text</font></div><div><font size="2"  >&nbsp;LANGUAGE sql</font></div><div><font size="2"  >&nbsp;IMMUTABLE</font></div><div><font size="2"  >AS $function$</font></div><div><font size="2"  >&nbsp; &nbsp; select to_char($1, $2);</font></div><div><font size="2"  >$function$;</font></div><p></p></pre></div><div>索引如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ><span style="line-height: 19px;"  >索引虽然很多, 但是都是有序增长的插入, 所以影响偏小.</span></font></div><div><font size="2"  >ump=&gt; \d &nbsp;TBL_digoal_ORDER_INFO_201210</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Table "ump.tbl_digoal_order_info_201210"</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;Column &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Modifiers &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >----------------+-----------------------------+----------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null default nextval('tbl_digoal_order_info_id_seq'::regclass)</font></div><div><font size="2"  >&nbsp;orderid &nbsp; &nbsp; &nbsp; &nbsp;| character varying(20) &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >&nbsp;payid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| character varying(30) &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"  >&nbsp;userid &nbsp; &nbsp; &nbsp; &nbsp; | character varying(32) &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"  >&nbsp;goodsid &nbsp; &nbsp; &nbsp; &nbsp;| character varying(30) &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"  >&nbsp;price &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| numeric(10,0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"  >&nbsp;mobile &nbsp; &nbsp; &nbsp; &nbsp; | character varying(30) &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"  >&nbsp;status &nbsp; &nbsp; &nbsp; &nbsp; | character(1) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"  >&nbsp;failurecause &nbsp; | character varying(30) &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >&nbsp;createtime &nbsp; &nbsp; | timestamp without time zone | not null default now()</font></div><div><font size="2"  >&nbsp;lastnotifytime | timestamp without time zone |&nbsp;</font></div><div><font size="2"  >&nbsp;paytime &nbsp; &nbsp; &nbsp; &nbsp;| timestamp without time zone |&nbsp;</font></div><div><font size="2"  >&nbsp;settletime &nbsp; &nbsp; | timestamp without time zone |&nbsp;</font></div><div><font size="2"  >Indexes:</font></div><div><font size="2"  >&nbsp; &nbsp; "tbl_digoal_order_info_201210_pkey" PRIMARY KEY, btree (id)</font></div><div><font size="2"  >&nbsp; &nbsp; "tbl_digoal_order_info_201210_orderid_idx" UNIQUE, btree (orderid)</font></div><div><font size="2"  >&nbsp; &nbsp; "tbl_digoal_order_info_201210_createtime_idx" btree (createtime)</font></div><div><font size="2"  >&nbsp; &nbsp; "tbl_digoal_order_info_201210_mobile_idx" btree (mobile)</font></div><div><font size="2"  >&nbsp; &nbsp; "tbl_digoal_order_info_201210_substr_idx" btree (substr(ts_to_char_immutable(createtime, 'yyyymmddhh24mi'::text), 1, 11))</font></div><div><font size="2"  >&nbsp; &nbsp; "tbl_digoal_order_info_201210_substr_idx1" btree (substr(ts_to_char_immutable(lastnotifytime, 'yyyymmddhh24mi'::text), 1, 11))</font></div><div><font size="2"  >Inherits: tbl_digoal_order_info</font></div><p></p></pre></div><div>4.2.4 将tbl_app_digoal从中间表中拿出, 直接使用原表. 优化后的SQL如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >with&nbsp;</font></div><div><font size="2"  >tbl_app_digoal_mr as</font></div><div><font size="2"  >(</font></div><div><font size="2"  >select id,</font></div><div><font size="2"  >&nbsp; '500'::text as spcode,</font></div><div><font size="2"  >&nbsp; mobile as phonenum,</font></div><div><font size="2"  >&nbsp; 'DELIVRD' as status,</font></div><div><font size="2"  >&nbsp; LASTNOTIFYTIME as mrtime,</font></div><div><font size="2"  >&nbsp; orderid as transactionid</font></div><div><font size="2"  >&nbsp; from TBL_digoal_ORDER_INFO_201210</font></div><div><font size="2"  >&nbsp; where LASTNOTIFYTIME is not null</font></div><div><font size="2"  >&nbsp; and substr(ts_to_char_immutable(LASTNOTIFYTIME,'yyyymmddhh24mi'),1,11)='20121031121'</font></div><div><font size="2"  >)</font></div><div><font size="2"  >select a1.spcode, sum(a1.cost) as income, count(0) as itemcount, a2.provincecode, a2.city, a2.provider&nbsp;</font></div><div><font size="2"  >&nbsp; from&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; (select row_number() over (partition by t2.mobile,t2.price/100,t2.orderid) as rn, t1.spcode,t1.phonenum,t2.price/100 as cost from&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;tbl_app_digoal_mr t1 join&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;TBL_digoal_ORDER_INFO_201210 t2</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;on ((t1.transactionid, t1.phonenum) = (t2.orderid, t2.mobile) and t2.createtime is not null)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;where t2.createtime is not null ) AS a1</font></div><div><font size="2"  >&nbsp; left outer join</font></div><div><font size="2"  >&nbsp; &nbsp; tbl_mobile a2</font></div><div><font size="2"  >&nbsp; &nbsp; on ( substr(a1.phonenum,1,7) = a2.phonenum )</font></div><div><font size="2"  >&nbsp; &nbsp; where a1.rn=1</font></div><div><font size="2"  >&nbsp; &nbsp; group by a1.spcode,a2.provincecode,a2.city,a2.provider</font></div><div><font size="2"  >&nbsp; &nbsp; order by a1.spcode,a2.provincecode,a2.city,a2.provider;</font></div><p></p></pre></div><div>执行计划如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp;GroupAggregate &nbsp;(cost=32506.22..32506.25 rows=1 width=75)</font></div><div><font size="2"  >&nbsp; &nbsp;CTE tbl_app_digoal_mr</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan using idx_order_info_ts_ntime_201210 on tbl_digoal_order_info_201210 &nbsp;(cost=0.25..10902.31 rows=4396 width=49)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (substr(ts_to_char_immutable(lastnotifytime, 'yyyymmddhh24mi'::text), 1, 11) = '20121031121'::text)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (lastnotifytime IS NOT NULL)</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=21603.92..21603.92 rows=1 width=75)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: a1.spcode, a2.provincecode, a2.city, a2.provider</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Nested Loop Left Join &nbsp;(cost=21600.49..21603.91 rows=1 width=75)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Subquery Scan on a1 &nbsp;(cost=21600.49..21600.53 rows=1 width=142)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (a1.rn = 1)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;WindowAgg &nbsp;(cost=21600.49..21600.52 rows=1 width=148)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=21600.49..21600.49 rows=1 width=148)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: t2.mobile, ((t2.price / 100::numeric)), t2.orderid</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Nested Loop &nbsp;(cost=0.00..21600.48 rows=1 width=148)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;CTE Scan on tbl_app_digoal_mr t1 &nbsp;(cost=0.00..87.92 rows=4396 width=168)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan using tbl_digoal_order_info_201210_orderid_idx on tbl_digoal_order_info_20</font></div><div><font size="2"  >1210 t2 &nbsp;(cost=0.00..4.88 rows=1 width=38)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: ((orderid)::text = (t1.transactionid)::text)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: ((createtime IS NOT NULL) AND (createtime IS NOT NULL) AND ((t1.phonenum)::text</font></div><div><font size="2"  >&nbsp;= (mobile)::text))</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan using tbl_mobile_pkey on tbl_mobile a2 &nbsp;(cost=0.00..3.37 rows=1 width=19)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (substr((a1.phonenum)::text, 1, 7) = (phonenum)::text)</font></div><p></p></pre></div><div>执行耗时 : 6.407 ms</div><div>优化后性能提升3975倍.</div><div><br></div><div>5. 转换其他SQL如下 :&nbsp;</div><div>5.1 //SpMoStatisticsService</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >select '500'::text as spcode,sum(t1.price/100) as mosum,t2.provider,t2.provincecode,t2.city,max(substr(ts_to_char_immutable(t1.createtime,'yyyymmddhh24mi'),1,11)) as stattime</font></div><div><font size="2"  >&nbsp; from TBL_digoal_ORDER_INFO_201210 t1 left outer join tbl_mobile t2</font></div><div><font size="2"  >&nbsp; on (substr(t1.mobile,1,7) = t2.phonenum)</font></div><div><font size="2"  >&nbsp; where t1.createtime is not null</font></div><div><font size="2"  >&nbsp; and substr(ts_to_char_immutable(t1.createtime,'yyyymmddhh24mi'),1,11)='20121031121'</font></div><div><font size="2"  >&nbsp; group by t2.provider,spcode,t2.provincecode,t2.city</font></div><div><font size="2"  >&nbsp; order by t2.provider,spcode,t2.provincecode,t2.city;</font></div><p></p></pre></div><div>5.2 //MrStatisticService</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >select 'DELIVRD'::text AS status,</font></div><div><font size="2"  >&nbsp; '500'::text AS spcode,&nbsp;</font></div><div><font size="2"  >&nbsp; count(t1.id) as mrsum,</font></div><div><font size="2"  >&nbsp; t2.provider,</font></div><div><font size="2"  >&nbsp; t2.provincecode,</font></div><div><font size="2"  >&nbsp; t2.city,</font></div><div><font size="2"  >&nbsp; max(substr(ts_to_char_immutable(t1.LASTNOTIFYTIME,'yyyymmddhh24mi'),1,11)) as stattime&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; from&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; tbl_digoal_order_info_201210 AS t1</font></div><div><font size="2"  >&nbsp; &nbsp; left outer join tbl_mobile t2</font></div><div><font size="2"  >&nbsp; &nbsp; on ( substr(t1.mobile,1,7)=t2.phonenum &nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;and t1.LASTNOTIFYTIME is not null </font><span style="font-size: small;"  >)</span></div><div><font size="2"  >&nbsp; &nbsp; where substr(ts_to_char_immutable(t1.LASTNOTIFYTIME,'yyyymmddhh24mi'),1,11)='20121031121'</font></div><div><font size="2"  >&nbsp; &nbsp; group by t2.provider,t2.provincecode,spcode,status,t2.city</font></div><div><font size="2"  >&nbsp; &nbsp; order by t2.provider,t2.provincecode,spcode,status,t2.city;</font></div><p></p></pre></div><div>5.3 //MoStatisticService</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >select (case when t1.status='0' then '0' else '-1' end) as newreserve,</font></div><div><font size="2"  >&nbsp; 'sms' as newtype,</font></div><div><font size="2"  >&nbsp; '500'::text AS spcode,&nbsp;</font></div><div><font size="2"  >&nbsp; count(t1.id) as mosum,</font></div><div><font size="2"  >&nbsp; t2.provider, t2.provincecode, t2.city,&nbsp;</font></div><div><font size="2"  >&nbsp; max(substr(ts_to_char_immutable(t1.createtime,'yyyymmddhh24mi'),1,11)) as stattime</font></div><div><font size="2"  >&nbsp; from</font></div><div><font size="2"  >&nbsp; tbl_digoal_order_info_201210 AS t1</font></div><div><font size="2"  >&nbsp; left outer join tbl_mobile t2</font></div><div><font size="2"  >&nbsp; on (substr(t1.mobile,1,7)=t2.phonenum&nbsp;</font></div><div><font size="2"  >&nbsp; and t1.createtime is not null </font><span style="font-size: small;"  >)</span></div><div><font size="2"  >&nbsp; where substr(ts_to_char_immutable(t1.createtime,'yyyymmddhh24mi'),1,11)='20121031121'</font></div><div><font size="2"  >&nbsp; group by t2.provider,t2.provincecode,spcode,newreserve,t2.city,newtype</font></div><div><font size="2"  >&nbsp; order by t2.provider,t2.provincecode,spcode,newreserve,t2.city,newtype;</font></div><p></p></pre></div><div><br></div><div>【参考】</div><div>1. SQL tuning example(max speedup 2400 times) : use function index and use window function prevent subquery</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012651054869/"  >http://blog.163.com/digoal@126/blog/static/1638770402012651054869/</a></div></div><div><br></div><wbr></div>
	</div>
</div>
</body>
</html>