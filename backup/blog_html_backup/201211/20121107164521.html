<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">use window function avoid table's self compare contain or not contain</h2>
	<h5 id="">2012-11-07 16:45:21&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201210742557178/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">今天群里的兄弟问到的问题如下 :&nbsp;<div><div>该表为历史数据表</div><div>两个ID字段的关系是，ID1内包含ID2（ID1等于1或者2或者其他，ID2是1或者2或者其他）</div><div>VAR的值表示ID2的值是否有效.</div><div>表如下</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ID1 &nbsp; &nbsp;ID2 &nbsp; &nbsp;VAR</font></div><div><font size="2"   >1 &nbsp; &nbsp; &nbsp; 1 &nbsp; &nbsp; &nbsp;a</font></div><div><font size="2"   >1 &nbsp; &nbsp; &nbsp; 2 &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >1 &nbsp; &nbsp; &nbsp; 3 &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >2 &nbsp; &nbsp; &nbsp; 1 &nbsp; &nbsp; &nbsp;a</font></div><div><font size="2"   >2 &nbsp; &nbsp; &nbsp; 2 &nbsp; &nbsp; &nbsp;a</font></div><div><font size="2"   >1 &nbsp; &nbsp; &nbsp; 1 &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >1 &nbsp; &nbsp; &nbsp; 2 &nbsp; &nbsp; &nbsp;a</font></div><div><font size="2"   >1 &nbsp; &nbsp; &nbsp; 3 &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >3 &nbsp; &nbsp; &nbsp; 1 &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >4 &nbsp; &nbsp; &nbsp; 1 &nbsp; &nbsp; &nbsp;a</font></div><p></p></pre></div><div>VAR的值只要出现过一次a值，表示ID1,ID2的组合正确</div><div>现要查询错误的ID2,ID1组合。</div><div>以上数据结果为</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ID1 &nbsp; ID2 &nbsp;</font></div><div><font size="2"   >1 &nbsp; &nbsp; &nbsp; 3</font></div><div><font size="2"   >3 &nbsp; &nbsp; &nbsp; 1</font></div><p></p></pre></div><div><br></div><div>这种需求要用到排他, 子查询.</div><div>在PostgreSQL中有几种写法 :&nbsp;</div><div>创建测试表和测试数据 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create table tbl (id1 int, id2 int, var text);</font></div><div><font size="2"   >insert into tbl values (1, &nbsp; &nbsp; &nbsp; 1, &nbsp; &nbsp; &nbsp;'a'),</font></div><div><font size="2"   >&nbsp;(1, &nbsp; &nbsp; &nbsp; 2, &nbsp; &nbsp; &nbsp;'0'),</font></div><div><font size="2"   >&nbsp;(1, &nbsp; &nbsp; &nbsp; 3, &nbsp; &nbsp; &nbsp;'0'),</font></div><div><font size="2"   >&nbsp;(2, &nbsp; &nbsp; &nbsp; 1, &nbsp; &nbsp; &nbsp;'a'),</font></div><div><font size="2"   >&nbsp;(2, &nbsp; &nbsp; &nbsp; 2, &nbsp; &nbsp; &nbsp;'a'),</font></div><div><font size="2"   >&nbsp;(1, &nbsp; &nbsp; &nbsp; 1, &nbsp; &nbsp; &nbsp;'0'),</font></div><div><font size="2"   >&nbsp;(1, &nbsp; &nbsp; &nbsp; 2, &nbsp; &nbsp; &nbsp;'a'),</font></div><div><font size="2"   >&nbsp;(1, &nbsp; &nbsp; &nbsp; 3, &nbsp; &nbsp; &nbsp;'0'),</font></div><div><font size="2"   >&nbsp;(3, &nbsp; &nbsp; &nbsp; 1, &nbsp; &nbsp; &nbsp;'0'),</font></div><div><font size="2"   >&nbsp;(4, &nbsp; &nbsp; &nbsp;1, &nbsp; &nbsp; &nbsp;'a');</font></div><div><font size="2"   >INSERT 0 10</font></div><p></p></pre></div><div><br></div><div>1. 用子查询 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select id1,id2 from tbl where (id1,id2) not in (select id1,id2 from tbl where var='a') group by id1,id2;</font></div><div><font size="2"   >&nbsp;id1 | id2&nbsp;</font></div><div><font size="2"   >-----+-----</font></div><div><font size="2"   >&nbsp; &nbsp;1 | &nbsp; 3</font></div><div><font size="2"   >&nbsp; &nbsp;3 | &nbsp; 1</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div><br></div><div>2. 用WITH语法 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><span style="font-size: small; line-height: 19px;"   >digoal</span><font size="2"   >=# with t1 as&nbsp;</font></div><div><span style="font-size: small; line-height: 19px;"   >digoal</span><font size="2"   >-# (</font></div><div><span style="font-size: small; line-height: 19px;"   >digoal</span><font size="2"   >(# select id1,id2 from tbl where var='a'</font></div><div><span style="font-size: small; line-height: 19px;"   >digoal</span><font size="2"   >(# )</font></div><div><span style="font-size: small; line-height: 19px;"   >digoal</span><font size="2"   >-# select id1,id2 from tbl where (id1,id2) not in (select id1,id2 from t1) group by id1,id2;</font></div><div><font size="2"   >&nbsp;id1 | id2&nbsp;</font></div><div><font size="2"   >-----+-----</font></div><div><font size="2"   >&nbsp; &nbsp;1 | &nbsp; 3</font></div><div><font size="2"   >&nbsp; &nbsp;3 | &nbsp; 1</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><br><wbr></div><div>3. 用窗口函数, 这个用法比较灵活, 首先进行分组, 然后进行排序, 把'a'排到最前面, 这样的话只要排除row_number=1 并且 var&lt;&gt;'a'的.</div><div>但是怎么让'a'排到第一行呢, 这里要借助NULL值的排序, NULLS FIRST.</div><div>所以最终的SQL如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >select id1,id2 from&nbsp;</font></div><div><font size="2"   >&nbsp; (select row_number() over (partition by id1,id2 order by (case var when 'a' then NULL when NULL then 'x' else var end) nulls first) as rn,id1,id2,var from tbl) as t&nbsp;</font></div><div><font size="2"   >&nbsp; where rn=1 and var&lt;&gt;'a';</font></div><p></p></pre></div><div>这里的&nbsp;<span style="line-height: 22px;"   >case var when 'a' then NULL when NULL then 'x' else var end 便是把var的'a'值转成了NULL, NULL转成其他值. 这var='a'的值就可以通过nulls first 上升到第一行了.</span></div><div><span style="line-height: 22px;"   >&nbsp; 所以rn=1 并且 var&lt;&gt;'a' 的行就是最终所需要的行。</span></div><div><span style="line-height: 22px;"   ><div><pre class="prettyprint"   ><p></p><div><span style="font-size: small; line-height: 19px;"   >digoal</span><font size="2"   >=# select id1,id2 from (select row_number() over (partition by id1,id2 order by (case var when 'a' then NULL when NULL then 'x' else var end) nulls first) as rn,id1,id2,var from tbl) as t where rn=1 and var&lt;&gt;'a';</font></div><div><font size="2"   >&nbsp;id1 | id2&nbsp;</font></div><div><font size="2"   >-----+-----</font></div><div><font size="2"   >&nbsp; &nbsp;1 | &nbsp; 3</font></div><div><font size="2"   >&nbsp; &nbsp;3 | &nbsp; 1</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div>这就是写SQL有意思的地方, 实现一个场景有各种玩法.</div></span></div></div>
	</div>
</div>
</body>
</html>