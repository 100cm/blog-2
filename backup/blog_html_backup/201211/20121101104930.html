<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL rotate table like mongoDB's capped collection</h2>
	<h5 id="">2012-11-01 10:49:30&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201293051423810/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>前面一个篇BLOG介绍了闪电狗的业务从mongoDB转到PostgreSQL, javascript用PostgreSQL的plpgsql来替代的方案.</div><div>也遗留了一个问题, mongoDB支持capped collection, 可以限制表的容量或者记录数. 但是PostgreSQL没有这样的表.</div><div>所以需要自己来解决这个问题.</div><div>在PostgreSQL中要解决这个问题需要用到数据库的统计信息, 来了解记录数以及占用空间的情况.</div><div>同时PostgreSQL的MVCC机制, 表在经过UPDATE和DELETE后里面实际上是有部分剩余空间的, 所以通过删除记录来限制空间的增长需要考虑到这一点. 需要计算出表中实际存在的ROWs实际占用的空间而不仅仅是表占用的空间.&nbsp;</div><div><br></div><div>requirement :&nbsp;</div><div>1. 需要pageinspect来分析抽取的数据块中平均每条记录占用的空间, 这里需要用到超级用户的权限.</div><div>2. 使用pg_class的reltuples来评估表的记录数, 注意reltuples是real类型的, 不是非常精确, 但是比count(*) 评估出来的开销小 . 如果你很计较精确性的话可提高采样值(<span style="line-height: 22px;"   >default_statistics_target</span>) 或者干脆就count(*)来替代这个. 我这里用到的是reltuples+500的采样值.</div><div>3. 使用pg_class的relpages以及pg_settings的block_size来评估表的大小 .&nbsp;</div><div>4. 表上需要有个时间字段, 按照记录的新旧程度来删除老的记录. 你可以根据你自己的规则来制定删除计划.</div><div>5. 使用Plpgsql函数来处理rotate, 需要用到游标和delete where current of 游标来删除记录.</div><div>6. 用到pg_<span style="line-height: 22px;"   >is_in_recovery()判断是否standby数据库, 如果是standby则不往下执行. 这个适应于cluster环境中.</span></div><div><br></div><div>测试 :&nbsp;</div><div>1. 创建测试表 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; create table test (id int primary key, info text, create_time timestamp without time zone);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><div><font size="2"   >digoal=&gt; create index idx_test_1 on test (create_time);</font></div><div><font size="2"   >CREATE INDEX</font></div></div><p></p></pre></div><div><br></div></div><div>2. 插入测试数据 :&nbsp;</div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >digoal=&gt; insert into test select generate_series(1,50000), 'digoal test capped table in postgresql', clock_timestamp();</font></div><div style="line-height: 22px;"   ><font size="2"   >INSERT 0 50000</font></div><p></p></pre></div></div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   >3. 创建pageinspect extension.</div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >\c digoal postgres</font></div><div style="line-height: 22px;"   ><font size="2"   >create extension&nbsp;<span style="line-height: 22px;"   >pageinspect</span><span style="line-height: 22px;"   >&nbsp;;</span></font></div><p></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><br></span></div><div>4. 创建测试脚本 :&nbsp;</div><div>下面使用DO测试脚本, 现在SIZE为<span style="line-height: 22px;"   >1024000, 如下 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >DO LANGUAGE plpgsql $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; v_block_size int8;</font></div><div><font size="2"   >&nbsp; v_size_bytes int8;</font></div><div><font size="2"   >&nbsp; v_tuples real;</font></div><div><font size="2"   >&nbsp; v_nspname name;</font></div><div><font size="2"   >&nbsp; v_relname name;</font></div><div><font size="2"   >&nbsp; v_size_bytes_limit int8;</font></div><div><font size="2"   >&nbsp; v_tuples_limit int8;</font></div><div><font size="2"   >&nbsp; v_limit_content text;</font></div><div><font size="2"   >&nbsp; v_ref refcursor;</font></div><div><font size="2"   >&nbsp; v_delete_tuples int8;</font></div><div><font size="2"   >&nbsp; v_orderby_column name;</font></div><div><font size="2"   >&nbsp; v_result record;</font></div><div><font size="2"   >&nbsp; v_tuples_avg_size numeric;</font></div><div><font size="2"   >&nbsp; v_blockid int;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; v_nspname := 'digoal';</font></div><div><font size="2"   >&nbsp; v_relname := 'test';</font></div><div><font size="2"   >&nbsp; v_size_bytes_limit := 1024000;</font></div><div><font size="2"   >&nbsp; v_tuples_limit := 10000;</font></div><div><font size="2"   >&nbsp; v_limit_content := 'size';</font></div><div><font size="2"   >&nbsp; v_orderby_column := 'create_time';</font></div><div><font size="2"   >if (pg_is_in_recovery()) then&nbsp;</font></div><div><font size="2"   >&nbsp; raise notice 'This db is in recovery.';</font></div><div><font size="2"   >&nbsp; return;</font></div><div><font size="2"   >else</font></div><div><font size="2"   >&nbsp; set local default_statistics_target to 500;</font></div><div><font size="2"   >&nbsp; execute 'analyze '||v_nspname||'.'||v_relname;</font></div><div><font size="2"   >&nbsp; select setting::int into v_block_size from pg_settings where name='block_size';</font></div><div><font size="2"   >&nbsp; select relpages * v_block_size, reltuples into v_size_bytes, v_tuples from pg_class&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; where relnamespace=(select oid from pg_namespace where nspname=v_nspname)&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; and relname=v_relname;</font></div><div><font size="2"   >&nbsp; raise notice 'START: v_nspname:%, v_relname:%, v_size_bytes:%, v_tuples:% .', v_nspname, v_relname, v_size_bytes, v_tuples;</font></div><div><font size="2"   >&nbsp; if (v_limit_content = 'size') then</font></div><div><font size="2"   >&nbsp; &nbsp; raise notice 'rotate with %:% .', v_limit_content, v_size_bytes_limit;</font></div><div><font size="2"   >&nbsp; &nbsp; if (v_size_bytes &gt; v_size_bytes_limit) then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; execute $_$select substring(ctid::text, '([[:digit:]]+)') from $_$||v_nspname||'.'||v_relname||' order by '||v_orderby_column||' desc limit 1' into v_blockid ;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;&nbsp;-- 这里少计算了PAGE HEAD的大小, 所以不是非常精确, 需要精确的朋友可以把page head也算进去.</font></div><div><font size="2"   >      select avg(lp_len) into v_tuples_avg_size from heap_page_items(get_raw_page(v_nspname||'.'||v_relname,v_blockid));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; if ( (v_tuples_avg_size*v_tuples) &gt; v_size_bytes_limit ) then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; v_delete_tuples := (((v_tuples_avg_size*v_tuples)-v_size_bytes_limit)/(v_tuples_avg_size::numeric))::int8;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; raise notice 'rotate with %:%, v_delete_tuples:%', v_limit_content, v_size_bytes_limit, v_delete_tuples;</font></div><div><font size="2"   ><span> </span>raise notice 'v_tuples:%, v_delete_tuples:%, v_size_bytes:%, v_size_bytes_limit:%', v_tuples, v_delete_tuples, v_size_bytes, v_size_bytes_limit;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; open v_ref for execute 'select * from '||v_nspname||'.'||v_relname||' order by '||v_orderby_column ;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; loop</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fetch v_ref into v_result;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (found and (v_delete_tuples &gt; 0) ) then</font></div><div><font size="2"   ><span> </span> &nbsp; &nbsp;v_delete_tuples := v_delete_tuples - 1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; execute 'delete from '||v_nspname||'.'||v_relname||' where current of '||quote_ident(v_ref::text);</font></div><div><font size="2"   ><span> </span> &nbsp;else&nbsp;</font></div><div><font size="2"   ><span> </span> &nbsp; &nbsp;exit;</font></div><div><font size="2"   ><span> </span> &nbsp;end if;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; end loop;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   ><span> </span>raise notice 'Do not need rotate with %:%, beacuse v_tuples_avg_size*v_tuples=%&lt;=%.', v_limit_content, v_size_bytes_limit, v_tuples_avg_size*v_tuples, v_size_bytes_limit;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; end if;</font></div><div><font size="2"   >&nbsp; &nbsp; end if;</font></div><div><font size="2"   >&nbsp; &nbsp; execute 'analyze '||v_nspname||'.'||v_relname;</font></div><div><font size="2"   >&nbsp; elsif (v_limit_content = 'tuples') then</font></div><div><font size="2"   >&nbsp; &nbsp; if (v_tuples &gt; v_tuples_limit) then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; v_delete_tuples := (v_tuples - v_tuples_limit);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; raise notice 'rotate with %:%, v_delete_tuples:%', v_limit_content, v_tuples_limit, v_delete_tuples;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; raise notice 'v_tuples:%, v_delete_tuples:%, v_size_bytes:%, v_size_bytes_limit:%', v_tuples, v_delete_tuples, v_size_bytes, v_size_bytes_limit;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; open v_ref for execute 'select * from '||v_nspname||'.'||v_relname||' order by '||v_orderby_column ;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; loop</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fetch v_ref into v_result;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (found and (v_delete_tuples &gt; 0) ) then</font></div><div><font size="2"   ><span> </span> &nbsp;v_delete_tuples := v_delete_tuples - 1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; execute 'delete from '||v_nspname||'.'||v_relname||' where current of '||quote_ident(v_ref::text);</font></div><div><font size="2"   ><span> </span>else</font></div><div><font size="2"   ><span> </span> &nbsp;exit;</font></div><div><font size="2"   ><span> </span>end if;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; end loop;</font></div><div><font size="2"   >&nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; raise notice 'Do not need rotate with %:% .', v_limit_content, v_tuples_limit;</font></div><div><font size="2"   >&nbsp; &nbsp; end if;</font></div><div><font size="2"   >&nbsp; &nbsp; execute 'analyze '||v_nspname||'.'||v_relname;</font></div><div><font size="2"   >&nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; raise notice 'please enter "size" or "tuples" in i_limit_content parameter.';</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; select setting::int into v_block_size from pg_settings where name='block_size';</font></div><div><font size="2"   >&nbsp; select relpages * v_block_size, reltuples into v_size_bytes, v_tuples from pg_class&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; where relnamespace=(select oid from pg_namespace where nspname=v_nspname)&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; and relname=v_relname;</font></div><div><font size="2"   >&nbsp; raise notice 'END: v_nspname:%, v_relname:%, v_size_bytes:%, v_tuples:% .', v_nspname, v_relname, v_size_bytes, v_tuples;</font></div><div><font size="2"   >end if;</font></div><div><font size="2"   >return;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$;</font></div><p></p></pre></div></div><div>结果 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >NOTICE: &nbsp;START: v_nspname:digoal, v_relname:test, v_size_bytes:4227072, v_tuples:50000 .</font></div><div><font size="2"   >NOTICE: &nbsp;rotate with size:1024000 .</font></div><div><font size="2"   >NOTICE: &nbsp;rotate with size:1024000, v_delete_tuples:37200</font></div><div><font size="2"   >NOTICE: &nbsp;v_tuples:50000, v_delete_tuples:37200, v_size_bytes:4227072, v_size_bytes_limit:1024000</font></div><div><font size="2"   >NOTICE: &nbsp;END: v_nspname:digoal, v_relname:test, v_size_bytes:4227072, v_tuples:12800 .</font></div><div><font size="2"   >DO</font></div><p></p></pre></div><div>执行前后表的大小都是<span style="line-height: 22px;"   >4227072字节, 根据每条记录的平均大小, 计算出需要删除</span><span style="line-height: 22px;"   >37200条记录. 删除前记录数=50000. 删除后记录数=</span><span style="line-height: 22px;"   >12800.</span></div><div><span style="line-height: 22px;"   >删除的规则是按照create_time字段排序, 从时间最早的记录开始删.&nbsp;</span></div><div>再次执行以上DO脚本的话, 虽然表的大小<span style="line-height: 22px;"   >4227072超过了限制大小</span><span style="line-height: 22px;"   >1024000, 但是</span>不会做出删除动作. 因为tuples实际占用的空间小于<span style="line-height: 22px;"   >1024000. 多余的空间是可以被新插入的记录复用的, 所以不需要DELETE.</span></div><div><span style="line-height: 22px;"   >再次执行的结果如下 :&nbsp;</span></div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >NOTICE: &nbsp;START: v_nspname:digoal, v_relname:test, v_size_bytes:4227072, v_tuples:12800 .</font></div><div style="line-height: 22px;"   ><font size="2"   >NOTICE: &nbsp;rotate with size:1024000 .</font></div><div style="line-height: 22px;"   ><font size="2"   >NOTICE: &nbsp;Do not need rotate with size:1024000, beacuse v_tuples_avg_size*v_tuples=1024000&lt;=1024000.</font></div><div style="line-height: 22px;"   ><font size="2"   >NOTICE: &nbsp;END: v_nspname:digoal, v_relname:test, v_size_bytes:4227072, v_tuples:12800 .</font></div><div style="line-height: 22px;"   ><font size="2"   >DO</font></div><p></p></pre></div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   >5. 下面测试一下tuples为限制条件的rotate, 测试10000条为限制条件 :&nbsp;</div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><font size="2"   >DO LANGUAGE plpgsql $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; v_block_size int8;</font></div><div><font size="2"   >&nbsp; v_size_bytes int8;</font></div><div><font size="2"   >&nbsp; v_tuples real;</font></div><div><font size="2"   >&nbsp; v_nspname name;</font></div><div><font size="2"   >&nbsp; v_relname name;</font></div><div><font size="2"   >&nbsp; v_size_bytes_limit int8;</font></div><div><font size="2"   >&nbsp; v_tuples_limit int8;</font></div><div><font size="2"   >&nbsp; v_limit_content text;</font></div><div><font size="2"   >&nbsp; v_ref refcursor;</font></div><div><font size="2"   >&nbsp; v_delete_tuples int8;</font></div><div><font size="2"   >&nbsp; v_orderby_column name;</font></div><div><font size="2"   >&nbsp; v_result record;</font></div><div><font size="2"   >&nbsp; v_tuples_avg_size numeric;</font></div><div><font size="2"   >&nbsp; v_blockid int;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; v_nspname := 'digoal';</font></div><div><font size="2"   >&nbsp; v_relname := 'test';</font></div><div><font size="2"   >&nbsp; v_size_bytes_limit := 1024000;</font></div><div><font size="2"   >&nbsp; v_tuples_limit := 10000;</font></div><div><font size="2"   >&nbsp; v_limit_content := 'tuples';</font></div><div><font size="2"   >&nbsp; v_orderby_column := 'create_time';</font></div><div><font size="2"   >if (pg_is_in_recovery()) then&nbsp;</font></div><div><font size="2"   >&nbsp; raise notice 'This db is in recovery.';</font></div><div><font size="2"   >&nbsp; return;</font></div><div><font size="2"   >else</font></div><div><font size="2"   >&nbsp; set local default_statistics_target to 500;</font></div><div><font size="2"   >&nbsp; execute 'analyze '||v_nspname||'.'||v_relname;</font></div><div><font size="2"   >&nbsp; select setting::int into v_block_size from pg_settings where name='block_size';</font></div><div><font size="2"   >&nbsp; select relpages * v_block_size, reltuples into v_size_bytes, v_tuples from pg_class&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; where relnamespace=(select oid from pg_namespace where nspname=v_nspname)&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; and relname=v_relname;</font></div><div><font size="2"   >&nbsp; raise notice 'START: v_nspname:%, v_relname:%, v_size_bytes:%, v_tuples:% .', v_nspname, v_relname, v_size_bytes, v_tuples;</font></div><div><font size="2"   >&nbsp; if (v_limit_content = 'size') then</font></div><div><font size="2"   >&nbsp; &nbsp; raise notice 'rotate with %:% .', v_limit_content, v_size_bytes_limit;</font></div><div><font size="2"   >&nbsp; &nbsp; if (v_size_bytes &gt; v_size_bytes_limit) then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; execute $_$select substring(ctid::text, '([[:digit:]]+)') from $_$||v_nspname||'.'||v_relname||' order by '||v_orderby_column||' desc limit 1' into v_blockid ;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; select avg(lp_len) into v_tuples_avg_size from heap_page_items(get_raw_page(v_nspname||'.'||v_relname,v_blockid));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; if ( (v_tuples_avg_size*v_tuples) &gt; v_size_bytes_limit ) then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; v_delete_tuples := (((v_tuples_avg_size*v_tuples)-v_size_bytes_limit)/(v_tuples_avg_size::numeric))::int8;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; raise notice 'rotate with %:%, v_delete_tuples:%', v_limit_content, v_size_bytes_limit, v_delete_tuples;</font></div><div><font size="2"   ><span> </span>raise notice 'v_tuples:%, v_delete_tuples:%, v_size_bytes:%, v_size_bytes_limit:%', v_tuples, v_delete_tuples, v_size_bytes, v_size_bytes_limit;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; open v_ref for execute 'select * from '||v_nspname||'.'||v_relname||' order by '||v_orderby_column ;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; loop</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fetch v_ref into v_result;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (found and (v_delete_tuples &gt; 0) ) then</font></div><div><font size="2"   ><span> </span> &nbsp; &nbsp;v_delete_tuples := v_delete_tuples - 1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; execute 'delete from '||v_nspname||'.'||v_relname||' where current of '||quote_ident(v_ref::text);</font></div><div><font size="2"   ><span> </span> &nbsp;else&nbsp;</font></div><div><font size="2"   ><span> </span> &nbsp; &nbsp;exit;</font></div><div><font size="2"   ><span> </span> &nbsp;end if;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; end loop;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   ><span> </span>raise notice 'Do not need rotate with %:%, beacuse v_tuples_avg_size*v_tuples=%&lt;=%.', v_limit_content, v_size_bytes_limit, v_tuples_avg_size*v_tuples, v_size_bytes_limit;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; end if;</font></div><div><font size="2"   >&nbsp; &nbsp; end if;</font></div><div><font size="2"   >&nbsp; &nbsp; execute 'analyze '||v_nspname||'.'||v_relname;</font></div><div><font size="2"   >&nbsp; elsif (v_limit_content = 'tuples') then</font></div><div><font size="2"   >&nbsp; &nbsp; if (v_tuples &gt; v_tuples_limit) then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; v_delete_tuples := (v_tuples - v_tuples_limit);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; raise notice 'rotate with %:%, v_delete_tuples:%', v_limit_content, v_tuples_limit, v_delete_tuples;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; raise notice 'v_tuples:%, v_delete_tuples:%, v_size_bytes:%, v_size_bytes_limit:%', v_tuples, v_delete_tuples, v_size_bytes, v_size_bytes_limit;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; open v_ref for execute 'select * from '||v_nspname||'.'||v_relname||' order by '||v_orderby_column ;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; loop</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fetch v_ref into v_result;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (found and (v_delete_tuples &gt; 0) ) then</font></div><div><font size="2"   ><span> </span> &nbsp;v_delete_tuples := v_delete_tuples - 1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; execute 'delete from '||v_nspname||'.'||v_relname||' where current of '||quote_ident(v_ref::text);</font></div><div><font size="2"   ><span> </span>else</font></div><div><font size="2"   ><span> </span> &nbsp;exit;</font></div><div><font size="2"   ><span> </span>end if;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; end loop;</font></div><div><font size="2"   >&nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; raise notice 'Do not need rotate with %:% .', v_limit_content, v_tuples_limit;</font></div><div><font size="2"   >&nbsp; &nbsp; end if;</font></div><div><font size="2"   >&nbsp; &nbsp; execute 'analyze '||v_nspname||'.'||v_relname;</font></div><div><font size="2"   >&nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; raise notice 'please enter "size" or "tuples" in i_limit_content parameter.';</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; select setting::int into v_block_size from pg_settings where name='block_size';</font></div><div><font size="2"   >&nbsp; select relpages * v_block_size, reltuples into v_size_bytes, v_tuples from pg_class&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; where relnamespace=(select oid from pg_namespace where nspname=v_nspname)&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; and relname=v_relname;</font></div><div><font size="2"   >&nbsp; raise notice 'END: v_nspname:%, v_relname:%, v_size_bytes:%, v_tuples:% .', v_nspname, v_relname, v_size_bytes, v_tuples;</font></div><div><font size="2"   >end if;</font></div><div><font size="2"   >return;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$;</font></div><p></p></pre></div><div style="line-height: 22px;"   >执行结果如下 :&nbsp;</div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><font size="2"   >NOTICE: &nbsp;START: v_nspname:digoal, v_relname:test, v_size_bytes:4227072, v_tuples:12800 .</font></div><div><font size="2"   >NOTICE: &nbsp;rotate with tuples:10000, v_delete_tuples:2800</font></div><div><font size="2"   >NOTICE: &nbsp;v_tuples:12800, v_delete_tuples:2800, v_size_bytes:4227072, v_size_bytes_limit:1024000</font></div><div><font size="2"   >NOTICE: &nbsp;END: v_nspname:digoal, v_relname:test, v_size_bytes:4227072, v_tuples:10000 .</font></div><div><font size="2"   >DO</font></div><p></p></pre></div><div style="line-height: 22px;"   >当前记录数是12800超过了限制2800条, 所以将被删除. 删除后剩余10000条.</div><div style="line-height: 22px;"   >再次执行, 因为已经剩余10000条记录了, 所以不会有删除的动作 :&nbsp;</div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><font size="2"   >NOTICE: &nbsp;START: v_nspname:digoal, v_relname:test, v_size_bytes:4227072, v_tuples:10000 .</font></div><div><font size="2"   >NOTICE: &nbsp;Do not need rotate with tuples:10000 .</font></div><div><font size="2"   >NOTICE: &nbsp;END: v_nspname:digoal, v_relname:test, v_size_bytes:4227072, v_tuples:10000 .</font></div><div><font size="2"   >DO</font></div><p></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >6. 测试完毕, 接下来把DO转换成函数, 方便以后执行 :&nbsp;</span></div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create or replace function rotate_table&nbsp;</font></div><div><font size="2"   >( i_nspname name,&nbsp;</font></div><div><font size="2"   >&nbsp; i_relname name,&nbsp;</font></div><div><font size="2"   >&nbsp; i_size_bytes_limit int8,&nbsp;</font></div><div><font size="2"   >&nbsp; i_tuples_limit int8,&nbsp;</font></div><div><font size="2"   >&nbsp; i_limit_content text,&nbsp;</font></div><div><font size="2"   >&nbsp; i_orderby_column name</font></div><div><font size="2"   >)&nbsp;</font></div><div><font size="2"   >returns void LANGUAGE plpgsql as</font></div><div><font size="2"   >$$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; v_block_size int8;</font></div><div><font size="2"   >&nbsp; v_size_bytes int8;</font></div><div><font size="2"   >&nbsp; v_tuples real;</font></div><div><font size="2"   >&nbsp; v_nspname name;</font></div><div><font size="2"   >&nbsp; v_relname name;</font></div><div><font size="2"   >&nbsp; v_size_bytes_limit int8;</font></div><div><font size="2"   >&nbsp; v_tuples_limit int8;</font></div><div><font size="2"   >&nbsp; v_limit_content text;</font></div><div><font size="2"   >&nbsp; v_ref refcursor;</font></div><div><font size="2"   >&nbsp; v_delete_tuples int8;</font></div><div><font size="2"   >&nbsp; v_orderby_column name;</font></div><div><font size="2"   >&nbsp; v_result record;</font></div><div><font size="2"   >&nbsp; v_tuples_avg_size numeric;</font></div><div><font size="2"   >&nbsp; v_blockid int;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; v_nspname := i_nspname;</font></div><div><font size="2"   >&nbsp; v_relname := i_relname;</font></div><div><font size="2"   >&nbsp; v_size_bytes_limit := i_size_bytes_limit;</font></div><div><font size="2"   >&nbsp; v_tuples_limit := i_tuples_limit;</font></div><div><font size="2"   >&nbsp; v_limit_content := i_limit_content;</font></div><div><font size="2"   >&nbsp; v_orderby_column := i_orderby_column;</font></div><div><font size="2"   >if (pg_is_in_recovery()) then&nbsp;</font></div><div><font size="2"   >&nbsp; raise notice 'This db is in recovery.';</font></div><div><font size="2"   >&nbsp; return;</font></div><div><font size="2"   >else</font></div><div><font size="2"   >&nbsp; set local default_statistics_target to 500;</font></div><div><font size="2"   >&nbsp; execute 'analyze '||v_nspname||'.'||v_relname;</font></div><div><font size="2"   >&nbsp; select setting::int into v_block_size from pg_settings where name='block_size';</font></div><div><font size="2"   >&nbsp; select relpages * v_block_size, reltuples into v_size_bytes, v_tuples from pg_class&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; where relnamespace=(select oid from pg_namespace where nspname=v_nspname)&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; and relname=v_relname;</font></div><div><font size="2"   >&nbsp; raise notice 'START: v_nspname:%, v_relname:%, v_size_bytes:%, v_tuples:% .', v_nspname, v_relname, v_size_bytes, v_tuples;</font></div><div><font size="2"   >&nbsp; if (v_limit_content = 'size') then</font></div><div><font size="2"   >&nbsp; &nbsp; raise notice 'rotate with %:% .', v_limit_content, v_size_bytes_limit;</font></div><div><font size="2"   >&nbsp; &nbsp; if (v_size_bytes &gt; v_size_bytes_limit) then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; execute $_$select substring(ctid::text, '([[:digit:]]+)') from $_$||v_nspname||'.'||v_relname||' order by '||v_orderby_column||' desc limit 1' into v_blockid ;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; select avg(lp_len) into v_tuples_avg_size from heap_page_items(get_raw_page(v_nspname||'.'||v_relname,v_blockid));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; if ( (v_tuples_avg_size*v_tuples) &gt; v_size_bytes_limit ) then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; v_delete_tuples := (((v_tuples_avg_size*v_tuples)-v_size_bytes_limit)/(v_tuples_avg_size::numeric))::int8;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; raise notice 'rotate with %:%, v_delete_tuples:%', v_limit_content, v_size_bytes_limit, v_delete_tuples;</font></div><div><font size="2"   ><span> </span>raise notice 'v_tuples:%, v_delete_tuples:%, v_size_bytes:%, v_size_bytes_limit:%', v_tuples, v_delete_tuples, v_size_bytes, v_size_bytes_limit;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; open v_ref for execute 'select * from '||v_nspname||'.'||v_relname||' order by '||v_orderby_column ;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; loop</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fetch v_ref into v_result;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (found and (v_delete_tuples &gt; 0) ) then</font></div><div><font size="2"   ><span> </span> &nbsp; &nbsp;v_delete_tuples := v_delete_tuples - 1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; execute 'delete from '||v_nspname||'.'||v_relname||' where current of '||quote_ident(v_ref::text);</font></div><div><font size="2"   ><span> </span> &nbsp;else&nbsp;</font></div><div><font size="2"   ><span> </span> &nbsp; &nbsp;exit;</font></div><div><font size="2"   ><span> </span> &nbsp;end if;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; end loop;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   ><span> </span>raise notice 'Do not need rotate with %:%, beacuse v_tuples_avg_size*v_tuples=%&lt;=%.', v_limit_content, v_size_bytes_limit, v_tuples_avg_size*v_tuples, v_size_bytes_limit;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; end if;</font></div><div><font size="2"   >&nbsp; &nbsp; end if;</font></div><div><font size="2"   >&nbsp; &nbsp; execute 'analyze '||v_nspname||'.'||v_relname;</font></div><div><font size="2"   >&nbsp; elsif (v_limit_content = 'tuples') then</font></div><div><font size="2"   >&nbsp; &nbsp; if (v_tuples &gt; v_tuples_limit) then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; v_delete_tuples := (v_tuples - v_tuples_limit);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; raise notice 'rotate with %:%, v_delete_tuples:%', v_limit_content, v_tuples_limit, v_delete_tuples;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; raise notice 'v_tuples:%, v_delete_tuples:%, v_size_bytes:%, v_size_bytes_limit:%', v_tuples, v_delete_tuples, v_size_bytes, v_size_bytes_limit;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; open v_ref for execute 'select * from '||v_nspname||'.'||v_relname||' order by '||v_orderby_column ;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; loop</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fetch v_ref into v_result;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (found and (v_delete_tuples &gt; 0) ) then</font></div><div><font size="2"   ><span> </span> &nbsp;v_delete_tuples := v_delete_tuples - 1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; execute 'delete from '||v_nspname||'.'||v_relname||' where current of '||quote_ident(v_ref::text);</font></div><div><font size="2"   ><span> </span>else</font></div><div><font size="2"   ><span> </span> &nbsp;exit;</font></div><div><font size="2"   ><span> </span>end if;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; end loop;</font></div><div><font size="2"   >&nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; raise notice 'Do not need rotate with %:% .', v_limit_content, v_tuples_limit;</font></div><div><font size="2"   >&nbsp; &nbsp; end if;</font></div><div><font size="2"   >&nbsp; &nbsp; execute 'analyze '||v_nspname||'.'||v_relname;</font></div><div><font size="2"   >&nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; raise notice 'please enter "size" or "tuples" in i_limit_content parameter.';</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; select setting::int into v_block_size from pg_settings where name='block_size';</font></div><div><font size="2"   >&nbsp; select relpages * v_block_size, reltuples into v_size_bytes, v_tuples from pg_class&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; where relnamespace=(select oid from pg_namespace where nspname=v_nspname)&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; and relname=v_relname;</font></div><div><font size="2"   >&nbsp; raise notice 'END: v_nspname:%, v_relname:%, v_size_bytes:%, v_tuples:% .', v_nspname, v_relname, v_size_bytes, v_tuples;</font></div><div><font size="2"   >end if;</font></div><div><font size="2"   >return;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$;</font></div><p></p></pre></div><div>7. 接下来就可以方便的使用函数进行rotate :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from rotate_table('digoal', 'test', 1024000, 8000, 'tuples', 'create_time');</font></div><div><font size="2"   >NOTICE: &nbsp;START: v_nspname:digoal, v_relname:test, v_size_bytes:4227072, v_tuples:10000 .</font></div><div><font size="2"   >NOTICE: &nbsp;rotate with tuples:8000, v_delete_tuples:2000</font></div><div><font size="2"   >NOTICE: &nbsp;v_tuples:10000, v_delete_tuples:2000, v_size_bytes:4227072, v_size_bytes_limit:1024000</font></div><div><font size="2"   >NOTICE: &nbsp;END: v_nspname:digoal, v_relname:test, v_size_bytes:4227072, v_tuples:8000 .</font></div><div><font size="2"   >&nbsp;rotate_table&nbsp;</font></div><div><font size="2"   >--------------</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div></div><div>8. 最后, 把这个弄成一个shell脚本, 在Linux crontab中添加一个条目, 让它定期自动执行.</div><div>vi rotate_table.sh</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#!/bin/bash</font></div><div><font size="2"   >export PGPORT=9300</font></div><div><font size="2"   >export PGUSER=postgres</font></div><div><font size="2"   >export PGDATA=/data04/pgdev/pg_root</font></div><div><font size="2"   >export LANG=en_US.utf8</font></div><div><font size="2"   >export PGHOME=/home/pgdev/pgsql9.3</font></div><div><font size="2"   >export PGHOST=$PGDATA</font></div><div><font size="2"   >export LD_LIBRARY_PATH=/opt/uuid-1.6.2/lib:$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib</font></div><div><font size="2"   >export PATH=$PGHOME/bin:$PATH:.</font></div><div><font size="2"   >date +%F%T</font></div><div><font size="2"   ># 限制digoal.test表的记录数为8000条.</font></div><div><font size="2"   >psql -h 127.0.0.1 -p 9300 -U postgres digoal -c "select * from rotate_table('digoal', 'test', 1024000, 8000, 'tuples', 'create_time');"</font></div><div><span style="font-size: small; line-height: 19px;"   ># 限制digoal.test表的容量为1024000字节.</span></div><div><font size="2"   >psql -h 127.0.0.1 -p 9300 -U postgres digoal -c "select * from rotate_table('digoal', 'test', 1024000, 8000, 'size', 'create_time');"</font></div><div><font size="2"   >date +%F%T</font></div><p></p></pre></div><div>修改脚本权限 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >chmod 500 rotate_table.sh</font></p></pre></div><div>编辑执行计划(例如<span style="line-height: 22px;"   >每分钟执行一次.</span>) :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >crontab -e</font></div><div><font size="2"   >* * * * * /home/pgdev/rotate_table.sh &gt;&gt;/home/pgdev/rotate_table.log 2&gt;&amp;1</font></div><p></p></pre></div><div>过一会就能看到日志输出了, 如下 :&nbsp;</div><div>cat&nbsp;<span style="line-height: 22px;"   >/home/pgdev/rotate_table.log</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >2012-11-0110:48:01</font></div><div><font size="2"   >NOTICE: &nbsp;START: v_nspname:digoal, v_relname:test, v_size_bytes:4227072, v_tuples:8000 .</font></div><div><font size="2"   >NOTICE: &nbsp;Do not need rotate with tuples:8000 .</font></div><div><font size="2"   >NOTICE: &nbsp;END: v_nspname:digoal, v_relname:test, v_size_bytes:4227072, v_tuples:8000 .</font></div><div><font size="2"   >&nbsp;rotate_table&nbsp;</font></div><div><font size="2"   >--------------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >NOTICE: &nbsp;START: v_nspname:digoal, v_relname:test, v_size_bytes:4227072, v_tuples:8000 .</font></div><div><font size="2"   >NOTICE: &nbsp;rotate with size:1024000 .</font></div><div><font size="2"   >NOTICE: &nbsp;Do not need rotate with size:1024000, beacuse v_tuples_avg_size*v_tuples=640000&lt;=1024000.</font></div><div><font size="2"   >NOTICE: &nbsp;END: v_nspname:digoal, v_relname:test, v_size_bytes:4227072, v_tuples:8000 .</font></div><div><font size="2"   >&nbsp;rotate_table&nbsp;</font></div><div><font size="2"   >--------------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >2012-11-0110:48:01</font></div><p></p></pre></div><div><br></div><div>【参考】</div><div><div>1.《Use pageinspect EXTENSION view PostgreSQL Page's raw infomation》</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020114273265960/"   >http://blog.163.com/digoal@126/blog/static/16387704020114273265960/</a></div><div>2.《pageinspect analyze index item migrated within btree pages》</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020129248105943/"   >http://blog.163.com/digoal@126/blog/static/16387704020129248105943/</a></div><div>3.《use pg_filedump dump block contents》</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201142610215685/"   >http://blog.163.com/digoal@126/blog/static/163877040201142610215685/</a></div><div>4.《mongoDB javascript TO PostgreSQL DO language》</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201293082737559/"   >http://blog.163.com/digoal@126/blog/static/163877040201293082737559/</a></div></div><div>5. sky_pg_cluster</div><div><a rel="nofollow" href="https://github.com/digoal/sky_postgresql_cluster"   >https://github.com/digoal/sky_postgresql_cluster</a></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL rotate table like mongoDBs capped collection - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>