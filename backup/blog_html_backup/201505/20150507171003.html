<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Roaring Bitmap - A better compressed bitset</h2>
	<h5 id="">2015-05-07 17:10:03&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020154732129112/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><h2 style="font-family: Simsun; line-height: normal;"   >A better compressed bitset</h2><p style="font-family: Simsun; font-size: medium; line-height: normal;"   >Bitsets, also called bitmaps, are commonly used as fast data structures. Unfortunately, they can use too much memory. To compensate, we often use compressed bitmaps.</p><p style="font-family: Simsun; font-size: medium; line-height: normal;"   >Roaring bitmaps are compressed bitmaps which tend to outperform conventional compressed bitmaps such as WAH, EWAH or Concise. In some instances, they can be hundreds of times faster and they often offer significantly better compression.</p><p style="font-family: Simsun; font-size: medium; line-height: normal;"   >Roaring bitmaps are used in&nbsp;<a rel="nofollow" href="http://lucene.apache.org/core/"   >Apache Lucene</a>&nbsp;(<a rel="nofollow" href="https://issues.apache.org/jira/browse/LUCENE-5983"   >as of version 5.0</a>&nbsp;using an<a rel="nofollow" href="https://svn.apache.org/viewvc/lucene/dev/branches/branch_5x/lucene/core/src/java/org/apache/lucene/util/RoaringDocIdSet.java?view=markup&amp;pathrev=1629606"   >independent implementation</a>),&nbsp;<a rel="nofollow" href="http://druid.io/"   >Druid.io</a>&nbsp;(as of version 0.7) and&nbsp;<a rel="nofollow" href="https://spark.apache.org/"   >Apache Spark</a>&nbsp;(as of version 1.2).</p></div><div><span style="line-height: 28px;"   >一种高效的bitmap压缩算法，应用广泛。</span></div><div>Bitmap indexes are commonly used in databases and search engines. By exploiting bit-level parallelism, they can significantly accelerate queries. However, they can use much memory, and thus we might prefer compressed bitmap indexes. Following Oracle's lead, bitmaps are often compressed using run-length encoding (RLE). Building on prior work, we introduce the Roaring compressed bitmap format: it uses packed arrays for compression instead of RLE. We compare it to two high-performance RLE-based bitmap encoding techniques: WAH (Word Aligned Hybrid compression scheme) and Concise (Compressed `n' Composable Integer Set). On synthetic and real data, we find that Roaring bitmaps</div><div>&nbsp;(1) often compress significantly better (e.g., 2 times)&nbsp;</div><div>&nbsp;(2) are faster than the compressed alternatives (up to 900 times faster for intersections).&nbsp;</div><div>Our results challenge the view that RLE-based bitmap compression is best.</div><div>看样子roaring bitmap相比Oracle使用的bitmap压缩技术有两点好处。压缩比高，速度快。</div><div>下面摘录一篇论文中的两幅图，说明了历年来出的一些BITMAP压缩算法以及他们之间的关系。</div><div><a target="_blank" rel="nofollow" href="http://ieeexplore.ieee.org/stamp/stamp.jsp?arnumber=7040519"   >http://ieeexplore.ieee.org/stamp/stamp.jsp?arnumber=7040519</a></div><div><a target="_blank" rel="nofollow" href="http://www.academia.edu/7140159/Bitmap_index_in_search_of_Internet_traffic_big_data"   >http://www.academia.edu/7140159/Bitmap_index_in_search_of_Internet_traffic_big_data</a></div><div><br></div><div><div><img title="Roaring Bitmap - A better compressed bitset - 德哥@Digoal - PostgreSQL research"   alt="Roaring Bitmap - A better compressed bitset - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img2.ph.126.net/QSYvqNV-hVSCnvZrQz_62Q==/2530460040646892165.png"   ></div>&nbsp;<div><img title="Roaring Bitmap - A better compressed bitset - 德哥@Digoal - PostgreSQL research"   alt="Roaring Bitmap - A better compressed bitset - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/Qe-BKFs5FdF-5yL49WizhQ==/6608578354864953702.png"   ></div>&nbsp;</div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >PostgreSQL用到的一种bitmap压缩方法是基于</span>hybrid run-length compression algorithm的<span style="line-height: 28px;"   >，参考：</span></div><div><a target="_blank" rel="nofollow" href="https://wiki.postgresql.org/wiki/Bitmap_Indexes"   >https://wiki.postgresql.org/wiki/Bitmap_Indexes</a></div><div><span style="line-height: 28px;"   >算法：</span></div><div>将bitmap拆成两个部分，第一个部分是header,第二个部分是content,</div><div>第一个部分每一个比特位对应第二个部分的一个word.</div><div>第一个部分比特0表示对应的第二个部分的word是未压缩的。</div><div>第一个部分比特1表示对应的第二个部分的word是压缩的。</div><div>如果第二个部分的word是压缩的，第一个比特位表示压缩存储的值是1还是0，剩余的比特位表示压缩存储了多少个word。</div><div>所以1个word是没有压缩意义的，至少要2个word压缩才有意义.</div><div><h4 style="color: rgb(230, 86, 0); margin: 0px 0px 0.3em; padding-top: 0.5em; padding-bottom: 0.17em; border-bottom-style: none; font-size: 14.7319993972778px; font-family: sans-serif; line-height: 19.0499992370605px; background-image: none; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"   ><span id="Header_Section_.28Header_Words.29"   >Header Section (Header Words)</span></h4><p style="margin-top: 0.4em; margin-bottom: 0.5em; line-height: 19.0499992370605px; font-family: sans-serif; font-size: 12.6999998092651px;"   >The header section contains bits, each of which corresponds to a word in the content section. If a bit in the header section is 1, then the corresponding word in the content section is a compressed word; if the bit is 0, then the corresponding word is not a compressed word.</p><h4 style="color: rgb(230, 86, 0); margin: 0px 0px 0.3em; padding-top: 0.5em; padding-bottom: 0.17em; border-bottom-style: none; font-size: 14.7319993972778px; font-family: sans-serif; line-height: 19.0499992370605px; background-image: none; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"   ><span style="float: right; margin-left: 5px; font-size: 12.6695194244385px; font-weight: normal;"   >[<a title="Edit section: Content Section (Content Words)" style="text-decoration: none; color: rgb(90, 54, 150); background: none;" rel="nofollow" href="https://wiki.postgresql.org/index.php?title=Bitmap_Indexes&amp;action=edit&amp;section=10"   >edit</a>]</span><span id="Content_Section_.28Content_Words.29"   >Content Section (Content Words)</span></h4><p style="margin-top: 0.4em; margin-bottom: 0.5em; line-height: 19.0499992370605px; font-family: sans-serif; font-size: 12.6999998092651px;"   >For a compressed word in the content section, the first bit in this word indicates whether 1s or 0s are compressed. The rest of the bits represent the value of "&lt;the number of bits&gt;/&lt;word size&gt;".</p><h4 style="color: rgb(230, 86, 0); margin: 0px 0px 0.3em; padding-top: 0.5em; padding-bottom: 0.17em; border-bottom-style: none; font-size: 14.7319993972778px; font-family: sans-serif; line-height: 19.0499992370605px; background-image: none; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"   ><span style="float: right; margin-left: 5px; font-size: 12.6695194244385px; font-weight: normal;"   >[<a title="Edit section: Example" style="text-decoration: none; color: rgb(90, 54, 150); background: none;" rel="nofollow" href="https://wiki.postgresql.org/index.php?title=Bitmap_Indexes&amp;action=edit&amp;section=11"   >edit</a>]</span><span id="Example"   >Example</span></h4><p style="margin-top: 0.4em; margin-bottom: 0.5em; line-height: 19.0499992370605px; font-family: sans-serif; font-size: 12.6999998092651px;"   >Consider the uncompressed bitmap vector for LOV item M:</p><pre style="padding: 1em; border: 1px dashed rgb(47, 111, 171); line-height: 1.1em; background-color: rgb(249, 249, 249);"   >11111111 10001000 11110001 11100010 11111111 11111111
</pre><p style="margin-top: 0.4em; margin-bottom: 0.5em; line-height: 19.0499992370605px; font-family: sans-serif; font-size: 12.6999998092651px;"   >If the size of a word is set to 8, then an HRL compressed form for this bitmap vector is as follows:</p><pre style="padding: 1em; border: 1px dashed rgb(47, 111, 171); line-height: 1.1em; background-color: rgb(249, 249, 249);"   >header section:   00001
content section:  11111111 10001000 11110001 11100010 10000010
</pre><p style="margin-top: 0.4em; margin-bottom: 0.5em; line-height: 19.0499992370605px; font-family: sans-serif; font-size: 12.6999998092651px;"   >The first word is uncompressed.</p><p style="margin-top: 0.4em; margin-bottom: 0.5em; line-height: 19.0499992370605px; font-family: sans-serif; font-size: 12.6999998092651px;"   >The second word is uncompressed.</p><p style="margin-top: 0.4em; margin-bottom: 0.5em; line-height: 19.0499992370605px; font-family: sans-serif; font-size: 12.6999998092651px;"   >The fifth word is compressed and it's first bit is set to one. As such it compresses ones. As 10 evaluates to 2, this compressed word represents 16 bits of ones (2 * 8 = 16).</p></div><div><br></div><div>可以做排序优化来提高压缩比。</div><div>排序后，更好的发挥压缩算法。</div><div><h3 style="color: rgb(230, 86, 0); margin: 0px 0px 0.3em; padding-top: 0.5em; padding-bottom: 0.17em; border-bottom-style: none; font-size: 16.7639999389648px; font-family: sans-serif; line-height: 19.0499992370605px; background-image: none; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"   ><span id="Sort-based_Optimization"   >Sort-based Optimization</span></h3><p style="margin-top: 0.4em; margin-bottom: 0.5em; line-height: 19.0499992370605px; font-family: sans-serif; font-size: 12.6999998092651px;"   >As bitmap indexes are often used in data warehousing systems, pre-sorting the values during the ETL stage can offer much better compression.</p><h4 style="color: rgb(230, 86, 0); margin: 0px 0px 0.3em; padding-top: 0.5em; padding-bottom: 0.17em; border-bottom-style: none; font-size: 14.7319993972778px; font-family: sans-serif; line-height: 19.0499992370605px; background-image: none; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"   ><span style="float: right; margin-left: 5px; font-size: 12.6695194244385px; font-weight: normal;"   >[<a title="Edit section: Example" style="text-decoration: none; color: rgb(90, 54, 150); background: none;" rel="nofollow" href="https://wiki.postgresql.org/index.php?title=Bitmap_Indexes&amp;action=edit&amp;section=13"   >edit</a>]</span><span id="Example_2"   >Example</span></h4><p style="margin-top: 0.4em; margin-bottom: 0.5em; line-height: 19.0499992370605px; font-family: sans-serif; font-size: 12.6999998092651px;"   >Consider the uncompressed bitmap vector for LOV item M:</p><pre style="padding: 1em; border: 1px dashed rgb(47, 111, 171); line-height: 1.1em; background-color: rgb(249, 249, 249);"   >00000000 00000111 11111111 11111111 11111111 11111111
</pre><p style="margin-top: 0.4em; margin-bottom: 0.5em; line-height: 19.0499992370605px; font-family: sans-serif; font-size: 12.6999998092651px;"   >If the size of a word is set to 8, then an HRL compressed form for this bitmap vector is as follows:</p><pre style="padding: 1em; border: 1px dashed rgb(47, 111, 171); line-height: 1.1em; background-color: rgb(249, 249, 249);"   >header section:   001
content section:  00000000 00000111 10000100
</pre><p style="margin-top: 0.4em; margin-bottom: 0.5em; line-height: 19.0499992370605px; font-family: sans-serif; font-size: 12.6999998092651px;"   >The first word is uncompressed.</p><p style="margin-top: 0.4em; margin-bottom: 0.5em; line-height: 19.0499992370605px; font-family: sans-serif; font-size: 12.6999998092651px;"   >The second word is uncompressed.</p><p style="margin-top: 0.4em; margin-bottom: 0.5em; line-height: 19.0499992370605px; font-family: sans-serif; font-size: 12.6999998092651px;"   >The third word is compressed and it's first bit is set to one. As such it compresses ones. As 100 evaluates to 4, this compressed word represents 32 bits of ones (4 * 8 = 32).</p></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >[参考]</span></div><div>1.&nbsp;<a target="_blank" rel="nofollow" href="http://roaringbitmap.org/"   >http://roaringbitmap.org/</a></div><wbr><div>2.&nbsp;<a target="_blank" rel="nofollow" href="https://github.com/andreasvc/roaringbitmap"   >https://github.com/andreasvc/roaringbitmap</a></div><div>3.&nbsp;<a target="_blank" rel="nofollow" href="https://pypi.python.org/pypi/roaringbitmap/0.1"   >https://pypi.python.org/pypi/roaringbitmap/0.1</a></div><div>4.&nbsp;<a target="_blank" rel="nofollow" href="http://arxiv.org/abs/1402.6407"   >http://arxiv.org/abs/1402.6407</a></div><div>5.&nbsp;<a target="_blank" rel="nofollow" href="http://arxiv.org/pdf/1402.6407.pdf"   >http://arxiv.org/pdf/1402.6407.pdf</a></div><div>6.&nbsp;<a target="_blank" rel="nofollow" href="http://lemire.me/data/realroaring2014.html"   >http://lemire.me/data/realroaring2014.html</a></div><div>7.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/message-id/flat/12553.1135634231@sss.pgh.pa.us#12553.1135634231@sss.pgh.pa.us"   >http://www.postgresql.org/message-id/flat/12553.1135634231@sss.pgh.pa.us#12553.1135634231@sss.pgh.pa.us</a></div><div>8.&nbsp;<a target="_blank" rel="nofollow" href="https://wiki.postgresql.org/wiki/Bitmap_Indexes"   >https://wiki.postgresql.org/wiki/Bitmap_Indexes</a></div><div>9.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://ieeexplore.ieee.org/stamp/stamp.jsp?arnumber=7040519"   >http://ieeexplore.ieee.org/stamp/stamp.jsp?arnumber=7040519</a></div><div>10.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://en.wikipedia.org/wiki/Run-length_encoding"   >http://en.wikipedia.org/wiki/Run-length_encoding</a></div><div>11.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.academia.edu/7140159/Bitmap_index_in_search_of_Internet_traffic_big_data"   >http://www.academia.edu/7140159/Bitmap_index_in_search_of_Internet_traffic_big_data</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="Roaring Bitmap - A better compressed bitset - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>