<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.5 new feature - Add support for INSERT ... ON CONFLICT DO NOTHING/UPDATE</h2>
	<h5 id="">2015-05-10 21:48:20&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201541094137923/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL 9.5 将新增大多数MySQL用户喜欢的一个功能，存在则更新，不存在则插入的SQL原子操作。</div><div>实际上PostgreSQL对这个功能进行了增强，可以做得更强。</div><div>具体用法可以去参考文档：</div><div><a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/sql-insert.html"   >http://www.postgresql.org/docs/devel/static/sql-insert.html</a></div><div>EXCLUDED.xxx 表示将要插入的冲突列，. xxx表示已经存在的冲突列。</div><div>例子：</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >&nbsp; INSERT INTO distributors (did, dname)</font></div><div><font size="2"   >&nbsp; VALUES (5, 'Gizmo transglobal'), (6, 'Associated Computing, inc')</font></div><div><font size="2"   >&nbsp; ON CONFLICT (did) DO UPDATE SET dname = EXCLUDED.dname;</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >&nbsp; INSERT INTO distributors (did, dname) VALUES (7, 'Redline GmbH')</font></div><div><font size="2"   >&nbsp; ON CONFLICT (did) DO NOTHING;</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >&nbsp; -- Don't update existing distributors based in a certain ZIP code</font></div><div><font size="2"   >&nbsp; INSERT INTO distributors AS d (did, dname) VALUES (8, 'Anvil Distribution')</font></div><div><font size="2"   >&nbsp; ON CONFLICT (did) DO UPDATE</font></div><div><font size="2"   >&nbsp; SET dname = EXCLUDED.dname || ' (formerly ' || d.dname || ')'</font></div><div><font size="2"   >&nbsp; WHERE d.zipcode != '21201';</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; -- Name a constraint directly in the statement (uses associated</font></div><div><font size="2"   >&nbsp; -- index to arbitrate taking the DO NOTHING action)</font></div><div><font size="2"   >&nbsp; INSERT INTO distributors (did, dname) VALUES (9, 'Antwerp Design')</font></div><div><font size="2"   >&nbsp; ON CONFLICT ON CONSTRAINT distributors_pkey DO NOTHING;</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >&nbsp; -- This statement could infer a partial unique index on "did"</font></div><div><font size="2"   >&nbsp; -- with a predicate of "WHERE is_active", but it could also</font></div><div><font size="2"   >&nbsp; -- just use a regular unique constraint on "did"</font></div><div><font size="2"   >&nbsp; INSERT INTO distributors (did, dname) VALUES (10, 'Conrad International')</font></div><div><font size="2"   >&nbsp; ON CONFLICT (did) WHERE is_active DO NOTHING;</font></div></div><p></p></pre></div><div><br></div><div><div style="font-family: sans-serif; font-size: small; line-height: normal;"   ><a style="color: rgb(0, 0, 0); display: block; padding: 6px 8px; font-weight: bold; text-decoration: none; background-color: rgb(237, 236, 230);" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commitdiff;h=168d5805e4c08bed7b95d351bf097cff7c07dd65"   >Add support for INSERT ... ON CONFLICT DO NOTHING/UPDATE.</a></div><div style="padding: 6px 0px; border-style: solid; border-color: rgb(217, 216, 209); border-width: 0px 0px 1px; font-family: monospace; line-height: normal;"   ><table style="padding: 8px 4px; border-spacing: 0px;"   ><tbody><tr><td style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   >author</td><td style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   ><a title="Search for commits authored by Andres Freund" style="color: rgb(0, 0, 0); text-decoration: none;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=search;h=168d5805e4c08bed7b95d351bf097cff7c07dd65;s=Andres+Freund;st=author"   >Andres Freund</a>&nbsp;<a title="Search for commits authored by andres@anarazel.de" style="color: rgb(0, 0, 0); text-decoration: none;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=search;h=168d5805e4c08bed7b95d351bf097cff7c07dd65;s=andres@anarazel.de;st=author"   >&lt;andres@anarazel.de&gt;</a></td><td rowspan="2"   style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   ></td></tr><tr><td style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   ></td><td style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   >Fri, 8 May 2015 03:31:36 +0000 (<span style="color: rgb(204, 0, 0);"   >05:31</span>&nbsp;+0200)</td></tr><tr><td style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   >committer</td><td style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   ><a title="Search for commits committed by Andres Freund" style="color: rgb(0, 0, 0); text-decoration: none;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=search;h=168d5805e4c08bed7b95d351bf097cff7c07dd65;s=Andres+Freund;st=committer"   >Andres Freund</a>&nbsp;<a title="Search for commits committed by andres@anarazel.de" style="color: rgb(0, 0, 0); text-decoration: none;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=search;h=168d5805e4c08bed7b95d351bf097cff7c07dd65;s=andres@anarazel.de;st=committer"   >&lt;andres@anarazel.de&gt;</a></td><td rowspan="2"   style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   ></td></tr><tr><td style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   ></td><td style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   >Fri, 8 May 2015 03:43:10 +0000 (<span style="color: rgb(204, 0, 0);"   >05:43</span>&nbsp;+0200)</td></tr><tr><td style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   >commit</td><td style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   >168d5805e4c08bed7b95d351bf097cff7c07dd65</td></tr><tr><td style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   >tree</td><td style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   ><a style="color: rgb(0, 0, 0); text-decoration: none;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=tree;h=cd55bff71bf05324f388d3404c1b3697f3a96e7e;hb=168d5805e4c08bed7b95d351bf097cff7c07dd65"   >cd55bff71bf05324f388d3404c1b3697f3a96e7e</a></td><td style="padding: 2px 5px; font-size: 12px; vertical-align: top; font-family: sans-serif;"   ><a style="color: rgb(136, 0, 0);" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=tree;h=cd55bff71bf05324f388d3404c1b3697f3a96e7e;hb=168d5805e4c08bed7b95d351bf097cff7c07dd65"   >tree</a>&nbsp;|&nbsp;<a title="in format: tar.gz" style="color: rgb(136, 0, 0);" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=snapshot;h=168d5805e4c08bed7b95d351bf097cff7c07dd65;sf=tgz"   >snapshot</a></td></tr><tr><td style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   >parent</td><td style="padding: 2px 5px; font-size: 12px; vertical-align: top;"   ><a style="color: rgb(0, 0, 0); text-decoration: none;" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=2c8f4836db058d0715bc30a30655d646287ba509"   >2c8f4836db058d0715bc30a30655d646287ba509</a></td><td style="padding: 2px 5px; font-size: 12px; vertical-align: top; font-family: sans-serif;"   ><a style="color: rgb(136, 0, 0);" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=2c8f4836db058d0715bc30a30655d646287ba509"   >commit</a>&nbsp;|&nbsp;<a style="color: rgb(136, 0, 0);" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commitdiff;h=168d5805e4c08bed7b95d351bf097cff7c07dd65;hp=2c8f4836db058d0715bc30a30655d646287ba509"   >diff</a></td></tr></table></div><div style="padding: 8px; font-family: monospace; line-height: normal;"   >Add&nbsp;support&nbsp;for&nbsp;INSERT&nbsp;...&nbsp;ON&nbsp;CONFLICT&nbsp;DO&nbsp;NOTHING/UPDATE.<br><br>The&nbsp;newly&nbsp;added&nbsp;ON&nbsp;CONFLICT&nbsp;clause&nbsp;allows&nbsp;to&nbsp;specify&nbsp;an&nbsp;alternative&nbsp;to<br>raising&nbsp;a&nbsp;unique&nbsp;or&nbsp;exclusion&nbsp;constraint&nbsp;violation&nbsp;error&nbsp;when&nbsp;inserting.<br>ON&nbsp;CONFLICT&nbsp;refers&nbsp;to&nbsp;constraints&nbsp;that&nbsp;can&nbsp;either&nbsp;be&nbsp;specified&nbsp;using&nbsp;a<br>inference&nbsp;clause&nbsp;(by&nbsp;specifying&nbsp;the&nbsp;columns&nbsp;of&nbsp;a&nbsp;unique&nbsp;constraint)&nbsp;or<br>by&nbsp;naming&nbsp;a&nbsp;unique&nbsp;or&nbsp;exclusion&nbsp;constraint.&nbsp;&nbsp;DO&nbsp;NOTHING&nbsp;avoids&nbsp;the<br>constraint&nbsp;violation,&nbsp;without&nbsp;touching&nbsp;the&nbsp;pre-existing&nbsp;row.&nbsp;&nbsp;DO&nbsp;UPDATE<br>SET&nbsp;...&nbsp;[WHERE&nbsp;...]&nbsp;updates&nbsp;the&nbsp;pre-existing&nbsp;tuple,&nbsp;and&nbsp;has&nbsp;access&nbsp;to<br>both&nbsp;the&nbsp;tuple&nbsp;proposed&nbsp;for&nbsp;insertion&nbsp;and&nbsp;the&nbsp;existing&nbsp;tuple;&nbsp;the<br>optional&nbsp;WHERE&nbsp;clause&nbsp;can&nbsp;be&nbsp;used&nbsp;to&nbsp;prevent&nbsp;an&nbsp;update&nbsp;from&nbsp;being<br>executed.&nbsp;&nbsp;The&nbsp;UPDATE&nbsp;SET&nbsp;and&nbsp;WHERE&nbsp;clauses&nbsp;have&nbsp;access&nbsp;to&nbsp;the&nbsp;tuple<br>proposed&nbsp;for&nbsp;insertion&nbsp;using&nbsp;the&nbsp;"magic"&nbsp;EXCLUDED&nbsp;alias,&nbsp;and&nbsp;to&nbsp;the<br>pre-existing&nbsp;tuple&nbsp;using&nbsp;the&nbsp;table&nbsp;name&nbsp;or&nbsp;its&nbsp;alias.<br><br>This&nbsp;feature&nbsp;is&nbsp;often&nbsp;referred&nbsp;to&nbsp;as&nbsp;upsert.<br><br>This&nbsp;is&nbsp;implemented&nbsp;using&nbsp;a&nbsp;new&nbsp;infrastructure&nbsp;called&nbsp;"speculative<br>insertion".&nbsp;It&nbsp;is&nbsp;an&nbsp;optimistic&nbsp;variant&nbsp;of&nbsp;regular&nbsp;insertion&nbsp;that&nbsp;first<br>does&nbsp;a&nbsp;pre-check&nbsp;for&nbsp;existing&nbsp;tuples&nbsp;and&nbsp;then&nbsp;attempts&nbsp;an&nbsp;insert.&nbsp;&nbsp;If&nbsp;a<br>violating&nbsp;tuple&nbsp;was&nbsp;inserted&nbsp;concurrently,&nbsp;the&nbsp;speculatively&nbsp;inserted<br>tuple&nbsp;is&nbsp;deleted&nbsp;and&nbsp;a&nbsp;new&nbsp;attempt&nbsp;is&nbsp;made.&nbsp;&nbsp;If&nbsp;the&nbsp;pre-check&nbsp;finds&nbsp;a<br>matching&nbsp;tuple&nbsp;the&nbsp;alternative&nbsp;DO&nbsp;NOTHING&nbsp;or&nbsp;DO&nbsp;UPDATE&nbsp;action&nbsp;is&nbsp;taken.<br>If&nbsp;the&nbsp;insertion&nbsp;succeeds&nbsp;without&nbsp;detecting&nbsp;a&nbsp;conflict,&nbsp;the&nbsp;tuple&nbsp;is<br>deemed&nbsp;inserted.<br><br>To&nbsp;handle&nbsp;the&nbsp;possible&nbsp;ambiguity&nbsp;between&nbsp;the&nbsp;excluded&nbsp;alias&nbsp;and&nbsp;a&nbsp;table<br>named&nbsp;excluded,&nbsp;and&nbsp;for&nbsp;convenience&nbsp;with&nbsp;long&nbsp;relation&nbsp;names,&nbsp;INSERT<br>INTO&nbsp;now&nbsp;can&nbsp;alias&nbsp;its&nbsp;target&nbsp;table.<br><br>Bumps&nbsp;catversion&nbsp;as&nbsp;stored&nbsp;rules&nbsp;change.<br><br>Author:&nbsp;Peter&nbsp;Geoghegan,&nbsp;with&nbsp;significant&nbsp;contributions&nbsp;from&nbsp;Heikki<br>&nbsp;&nbsp;&nbsp;&nbsp;Linnakangas&nbsp;and&nbsp;Andres&nbsp;Freund.&nbsp;Testing&nbsp;infrastructure&nbsp;by&nbsp;Jeff&nbsp;Janes.<br>Reviewed-By:&nbsp;Heikki&nbsp;Linnakangas,&nbsp;Andres&nbsp;Freund,&nbsp;Robert&nbsp;Haas,&nbsp;Simon&nbsp;Riggs,<br>&nbsp;&nbsp;&nbsp;&nbsp;Dean&nbsp;Rasheed,&nbsp;Stephen&nbsp;Frost&nbsp;and&nbsp;many&nbsp;others.</div></div><div><br></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=168d5805e4c08bed7b95d351bf097cff7c07dd65"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=168d5805e4c08bed7b95d351bf097cff7c07dd65</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/sql-insert.html"   >http://www.postgresql.org/docs/devel/static/sql-insert.html</a></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL 9.5 new feature - Add support for INSERT ... ON CONFLICT DO NOTHING/UPDATE - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>