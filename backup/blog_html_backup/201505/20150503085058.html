<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL & Oracle -1 OLTP "update/select based primary key" & insert</h2>
	<h5 id="">2015-05-03 8:50:58&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201541104656600/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>基于同一台主机和存储，分别测试PostgreSQL 9.4.1, Oracle 12c 的小事务处理能力。</div><div>测试结果仅供参考，有兴趣的同学可以自行测试或者更改测试用例来玩。</div><div><span style="line-height: 28px;"   >(因测试使用工具不一样，工具本身的损耗不一样，结果可能没有可比性。)</span></div><div><span style="line-height: 28px;"   >(即使用同样的工具，驱动的性能可能也不一样，很难做到完全没有偏颇。)</span></div><div><span style="line-height: 28px;"   >(所以，本文</span><span style="line-height: 28px;"   >目的旨在挑战产品自身的极限或者发现自身的问题和缺陷，而非两种产品的VS，纯属娱乐。</span><span style="line-height: 28px;"   >)</span></div><div><span style="line-height: 28px;"   ><br></span></div><div>压力测试结果汇总：</div><div>PostgreSQL 9.4.1：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >UPDATE</font></div><div><div><font size="2"   >平均TPS：95021</font></div><div><font size="2"   >最小TPS：90017</font></div><div><font size="2"   >最大TPS：113981</font></div></div><div><font size="2"   >SELECT</font></div><div><div><font size="2"   >平均TPS：328895</font></div><div><font size="2"   >最小TPS：327336</font></div><div><font size="2"   >最大TPS：330360</font></div></div><div><font size="2"   >INSERT</font></div><div><div><font color="#444444"   face="Tahoma, Microsoft Yahei, Simsun"   ><span style="font-size: 12px; line-height: 18px; white-space: normal;"   >平均TPS：70433</span></font></div><div><font color="#444444"   face="Tahoma, Microsoft Yahei, Simsun"   ><span style="font-size: 12px; line-height: 18px; white-space: normal;"   >最小TPS：57417.4</span></font></div><div><font color="#444444"   face="Tahoma, Microsoft Yahei, Simsun"   ><span style="font-size: 12px; line-height: 18px; white-space: normal;"   >最大TPS：75758.9</span></font></div></div><p></p></pre></div><div><br></div><div>Oracle 12c：</div><div>详见：</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020154431045764/"   >http://blog.163.com/digoal@126/blog/static/16387704020154431045764/</a></div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >UPDATE</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >平均TPS：32xxx</font></div><div style="line-height: 28px;"   ><font size="2"   >最小TPS：29000</font></div><div style="line-height: 28px;"   ><font size="2"   >最大TPS：33900</font></div></div><div style="line-height: 28px;"   ><font size="2"   >SELECT</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >平均TPS：36xxx</font></div><div style="line-height: 28px;"   ><font size="2"   >最小TPS：36300</font></div><div style="line-height: 28px;"   ><font size="2"   >最大TPS：36620</font></div></div><div style="line-height: 28px;"   ><font size="2"   >INSERT</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >平均TPS：9xxx</font></div><div style="line-height: 28px;"   ><font size="2"   >最小TPS：8750</font></div><div style="line-height: 28px;"   ><font size="2"   >最大TPS：10500</font></div></div><p></p></pre></div></div><div><br></div><div>[ 测试详情 ]</div><div>压力测试内容：</div><div>基于主键的查询，更新。</div><div>带主键的表的插入。</div><div><br></div><div>测试环境：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 21px;"   >服务器 2009年购买的 IBM X3950, 和现在的CPU比起来性能已经比较差了.<br>CPU 4 * 6核 Intel(R) Xeon(R) CPU X7460 @ 2.66GHz<br>内存 32 * 4GB DDR2 533MHz<br>硬盘 上海宝存 1.2TB Direct-IO PCI-E SSD<br>数据库 PostgreSQL 9.4.1<br>操作系统 CentOS 6.6 x64<br>文件系统 EXT4, noatime,nodiratime,nobarrier</span></font></div><div><font size="2"   ><span style="line-height: 21px;"   >更新,查询数据量 5000万</span></font></div><div><font size="2"   ><span style="line-height: 21px;"   >插入数据量 100亿</span></font></div><p></p></pre></div><div>PostgreSQL 数据库参数：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >listen_addresses = '0.0.0.0' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# what IP address(es) to listen on;</font></div><div><font size="2"   >port = 1921 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >max_connections = 56 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   >superuser_reserved_connections = 13 &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >unix_socket_directories = '.' &nbsp; # comma-separated list of directories</font></div><div><font size="2"   >tcp_keepalives_idle = 60 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPIDLE, in seconds;</font></div><div><font size="2"   >tcp_keepalives_interval = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPINTVL, in seconds;</font></div><div><font size="2"   >tcp_keepalives_count = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # TCP_KEEPCNT;</font></div><div><font size="2"   >shared_buffers = 8GB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 128kB  内存足够大的情况下,配置为和数据库的活跃数据量相当即可获得最好的性能.</font></div><div><font size="2"   >huge_pages = try &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# on, off, or try</font></div><div><font size="2"   >maintenance_work_mem = 1GB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# min 1MB</font></div><div><font size="2"   >autovacuum_work_mem = 1GB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 1MB, or -1 to use maintenance_work_mem</font></div><div><font size="2"   >dynamic_shared_memory_type = posix &nbsp; &nbsp; &nbsp;# the default is the first option</font></div><div><font size="2"   >bgwriter_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # 10-10000ms between rounds</font></div><div><font size="2"   >synchronous_commit = off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# synchronization level;</font></div><div><font size="2"   >wal_sync_method = fdatasync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # the default is the first option</font></div><div><font size="2"   >wal_buffers = 16MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# min 32kB, -1 sets based on shared_buffers</font></div><div><font size="2"   >wal_writer_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 milliseconds</font></div><div><font size="2"   >checkpoint_timeout = 10min            # 对于产生XLOG非常频繁的数据库, 为了降低性能影响, 可以配置为大于产生checkpoint_segments需要的周期.</font></div><div><font size="2"   >                                   # 例如产生512个XLOG需要8分钟, 那么这里可以配置为超过8分钟.</font></div><div><font size="2"   >                                   # 这里配置的时间越长, 如果数据库DOWN机, 恢复需要的时间也越长.</font></div><div><font size="2"   >checkpoint_completion_target = 0.9</font></div><div><font size="2"   >checkpoint_segments = 512 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # in logfile segments, min 1, 16MB each  配置为大于等于shared_buffers</font></div><div><font size="2"   >random_page_cost = 2.0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# same scale as above</font></div><div><font size="2"   >effective_cache_size = 100GB</font></div><div><font size="2"   >log_destination = 'csvlog' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Valid values are combinations of</font></div><div><font size="2"   >logging_collector = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Enable capturing of stderr and csvlog</font></div><div><font size="2"   >log_truncate_on_rotation = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # If on, an existing log file with the</font></div><div><font size="2"   >log_checkpoints = on</font></div><div><font size="2"   >log_connections = on</font></div><div><font size="2"   >log_disconnections = on</font></div><div><font size="2"   >log_error_verbosity = verbose &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # terse, default, or verbose messages</font></div><div><font size="2"   >log_timezone = 'PRC'</font></div><div><font size="2"   >autovacuum = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Enable autovacuum subprocess? &nbsp;'on'</font></div><div><font size="2"   >log_autovacuum_min_duration = 0 # -1 disables, 0 logs all actions and</font></div><div><font size="2"   >autovacuum_vacuum_scale_factor = 0.002 &nbsp;# fraction of table size before vacuum   , 对于产生垃圾非常频繁的库, 越小越好</font></div><div><font size="2"   >autovacuum_analyze_scale_factor = 0.001 # fraction of table size before analyze</font></div><div><font size="2"   >autovacuum_vacuum_cost_delay = 0ms &nbsp; &nbsp; &nbsp;# default vacuum cost delay for , 对于IO能力非常好的库, 不要延迟</font></div><div><font size="2"   >datestyle = 'iso, mdy'</font></div><div><font size="2"   >timezone = 'PRC'</font></div><div><font size="2"   >lc_messages = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for system error message</font></div><div><font size="2"   >lc_monetary = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for monetary formatting</font></div><div><font size="2"   >lc_numeric = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for number formatting</font></div><div><font size="2"   >lc_time = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for time formatting</font></div><div><font size="2"   >default_text_search_config = 'pg_catalog.english'</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >生成查询，更新压力测试数据：</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; create table tbl(id int, info text, crt_time timestamptz default now()) tablespace tbs_digoal;</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=&gt; insert into tbl select generate_series(1,50000000),now(),now();</font></div><div><font size="2"   >INSERT 0 50000000</font></div><div><font size="2"   >digoal=&gt; set maintenance_work_mem='4GB';</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >digoal=&gt; alter table tbl add constraint tbl_pkey primary key(id) using index tablespace tbs_digoal_idx;</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >digoal=&gt; \dt+ tbl</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of relations</font></div><div><font size="2"   >&nbsp;Schema | Name | Type &nbsp;| Owner &nbsp;| &nbsp;Size &nbsp; | Description&nbsp;</font></div><div><font size="2"   >--------+------+-------+--------+---------+-------------</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp;| table | digoal | 3634 MB |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=&gt; \di+ tbl_pkey&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; Name &nbsp; | Type &nbsp;| Owner &nbsp;| Table | &nbsp;Size &nbsp; | Description&nbsp;</font></div><div><font size="2"   >--------+----------+-------+--------+-------+---------+-------------</font></div><div><font size="2"   >&nbsp;digoal | tbl_pkey | index | digoal | tbl &nbsp; | 1063 MB |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div><span style="line-height: 28px;"   >根据主键进行更新测试，测试时长超过8小时。</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >$ vi test.sql</font></span></div><div><div><font size="2"   >\setrandom id 1 50000000</font></div><div><font size="2"   >update tbl set crt_time=now() where id=:id;</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >nohup pgbench -M prepared -n -f test.sql -P 10 -c 26 -j 26 -T 30000000 &gt;./log 2&gt;&amp;1 &amp;</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >超过8小时的测试后，表大了100多MB，索引未变化。</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; \dt+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of relations</font></div><div><font size="2"   >&nbsp;Schema | Name | Type &nbsp;| Owner &nbsp;| &nbsp;Size &nbsp; | Description&nbsp;</font></div><div><font size="2"   >--------+------+-------+--------+---------+-------------</font></div><div><font size="2"   >&nbsp;digoal | tbl &nbsp;| table | digoal | 3842 MB |&nbsp;</font></div><div><font size="2"   >(1 rows)</font></div><div><font size="2"   >digoal=&gt; \di+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; Name &nbsp; | Type &nbsp;| Owner &nbsp;| Table | &nbsp;Size &nbsp; | Description&nbsp;</font></div><div><font size="2"   >--------+----------+-------+--------+-------+---------+-------------</font></div><div><font size="2"   >&nbsp;digoal | tbl_pkey | index | digoal | tbl &nbsp; | 1063 MB |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>统计到tbl已更新超过21亿次。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select * from pg_stat_all_tables where relname='tbl';</font></div><div><font size="2"   >-[ RECORD 1 ]-------+------------------------------</font></div><div><font size="2"   >relid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 16387</font></div><div><font size="2"   >schemaname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| digoal</font></div><div><font size="2"   >relname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | tbl</font></div><div><font size="2"   >seq_scan &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2</font></div><div><font size="2"   >seq_tup_read &nbsp; &nbsp; &nbsp; &nbsp;| 100000000</font></div><div><font size="2"   >idx_scan &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2136267592</font></div><div><font size="2"   >idx_tup_fetch &nbsp; &nbsp; &nbsp; | 2136267592</font></div><div><font size="2"   >n_tup_ins &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 100278348</font></div><div><font size="2"   >n_tup_upd &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2136267592</font></div><div><font size="2"   >n_tup_del &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 0</font></div><div><font size="2"   >n_tup_hot_upd &nbsp; &nbsp; &nbsp; | 2097129671</font></div><div><font size="2"   >n_live_tup &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 50081001</font></div><div><font size="2"   >n_dead_tup &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 135956</font></div><div><font size="2"   >n_mod_since_analyze | 3111673</font></div><div><font size="2"   >last_vacuum &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >last_autovacuum &nbsp; &nbsp; | 2015-05-02 08:27:02.690159+08</font></div><div><font size="2"   >last_analyze &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >last_autoanalyze &nbsp; &nbsp;| 2015-05-02 08:27:05.800603+08</font></div><div><font size="2"   >vacuum_count &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"   >autovacuum_count &nbsp; &nbsp;| 580</font></div><div><font size="2"   >analyze_count &nbsp; &nbsp; &nbsp; | 0</font></div><div><font size="2"   >autoanalyze_count &nbsp; | 579</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >可以导入测试结果，或者使用R进行分析。</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; create table az(tps numeric);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# \copy digoal.az from program 'awk ''NR&gt;2 {print $4}'' /home/postgres/log'</font></div><div><font size="2"   >COPY 3057</font></div></div><div><div><font size="2"   >digoal=&gt; select avg(tps),min(tps),max(tps),count(*) from az;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; avg &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; min &nbsp; | &nbsp; max &nbsp; | count&nbsp;</font></div><div><font size="2"   >--------------------+---------+---------+-------</font></div><div><font size="2"   >&nbsp;60217.684494602552 | 27666.0 | 65708.7 | &nbsp;3057</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><span style="line-height: 28px;"   >平均TPS：</span><span style="line-height: 28px;"   >60217</span></div><div>最小TPS：<span style="line-height: 28px;"   >27666</span></div><div>最大TPS：<span style="line-height: 28px;"   >65708</span></div><div>图：</div><div><div><img title="PostgreSQL VS Oracle OLTP update/select based primary key  insert - 德哥@Digoal - PostgreSQL research"   alt="PostgreSQL VS Oracle OLTP update/select based primary key  insert - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img2.ph.126.net/vlEoNtRAbh-KhmclUiumHQ==/2397040901686054688.png"   ></div></div><div>每一次tps下降都和checkpoint有关，因为检查点后第一次变脏的数据块需要写full page，所以会导致wal写buffer的压力(实际是连续写几个wal block size大小的能力，如果block_size=32K, wal_block_size=8K, 那么一个脏块需要写4个wal_block_size，假设wal fsync能力是每秒写10000个8K的块，那么检查点后的写操作如果都发生在不同的数据块上面，写WAL可能造成瓶颈，即tps可能降到2500以下。)，原因分析见：</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201542103933969/"   >http://blog.163.com/digoal@126/blog/static/163877040201542103933969/</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402015463252387/"   >http://blog.163.com/digoal@126/blog/static/1638770402015463252387/</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020154651655783/"   >http://blog.163.com/digoal@126/blog/static/16387704020154651655783/</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020154653422892/"   >http://blog.163.com/digoal@126/blog/static/16387704020154653422892/</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020154811421484/"   >http://blog.163.com/digoal@126/blog/static/16387704020154811421484/</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020154129958753/"   >http://blog.163.com/digoal@126/blog/static/16387704020154129958753/</a></div><div>关闭full page write的压力测试TPS散点图如下，检查点带来的影响消失了：</div><div><div><img title="PostgreSQL  Oracle -1 OLTP update/select based primary key  insert - 德哥@Digoal - PostgreSQL research"   alt="PostgreSQL  Oracle -1 OLTP update/select based primary key  insert - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img1.ph.126.net/7CGpsFufn-wGpSdW9sPXzg==/796855659168204760.png"   ></div></div><div><br></div><div>查询测试<span style="line-height: 28px;"   >，测试时长超过8小时</span><span style="line-height: 28px;"   >：</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >$ vi test.sql</font></div><div><font size="2"   >\setrandom id 1 50000000</font></div><div><font size="2"   >select * from tbl where id=:id;</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >nohup pgbench -M prepared -n -f test.sql -P 10 -c 38 -j 38 -T 30000000 &gt;./log 2&gt;&amp;1 &amp;</font></div><p></p></pre></div><div><div style="line-height: 28px;"   >导入测试结果：</div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >digoal=&gt; create table az(tps numeric);</font></div><div style="line-height: 28px;"   ><font size="2"   >CREATE TABLE</font></div><div style="line-height: 28px;"   ><font size="2"   >digoal=&gt; \c digoal postgres</font></div><div style="line-height: 28px;"   ><font size="2"   >You are now connected to database "digoal" as user "postgres".</font></div><div style="line-height: 28px;"   ><font size="2"   >digoal=# \copy digoal.az from program 'awk ''NR&gt;2 {print $4}'' /home/postgres/log'</font></div><div style="line-height: 28px;"   ><font size="2"   >COPY 3027</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >digoal=&gt; select avg(tps),min(tps),max(tps),count(*) from digoal.az;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;avg &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; min &nbsp; &nbsp;| &nbsp; max &nbsp; &nbsp;| count&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >---------------------+----------+----------+-------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;328895.445688800793 | 327336.0 | 330360.6 | &nbsp;3027</font></div><div style="line-height: 28px;"   ><font size="2"   >(1 row)</font></div></div><p></p></pre></div></div></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >平均TPS：</span><span style="line-height: 28px;"   >328895</span></div><div style="line-height: 28px;"   >最小TPS：<span style="line-height: 28px;"   >327336</span></div><div style="line-height: 28px;"   >最大TPS：<span style="line-height: 28px;"   >330360</span></div><div style="line-height: 28px;"   >图：</div></div><div><div><img title="PostgreSQL VS Oracle OLTP update/select based primary key  insert - 德哥@Digoal - PostgreSQL research"   alt="PostgreSQL VS Oracle OLTP update/select based primary key  insert - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img2.ph.126.net/Zn9okA_cfPI-xljUORYY3g==/2860911663305135321.png"   ></div>查询的TPS比较平稳，维持在32.7万tps以上。</div><div><br></div><div>插入测试<span style="line-height: 28px;"   >，测试时长超过8小时</span><span style="line-height: 28px;"   >：</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt;&nbsp;drop table tbl;</font></div><div><font size="2"   >digoal=&gt;&nbsp;<span style="line-height: 28px;"   >create table tbl(id serial primary key using index tablespace tbs_digoal_idx, info text, crt_time timestamptz default now()) tablespace tbs_digoal;</span></font></div><div><font size="2"   ><br></font></div><div><div style="line-height: 28px;"   ><font size="2"   >$ vi test.sql</font></div><div style="line-height: 28px;"   ><font size="2"   ><span style="line-height: 28px;"   >insert into tbl(</span><span style="line-height: 28px;"   >info) values ('hello world');</span></font></div></div><div style="line-height: 28px;"   ><font size="2"   ><br></font></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >nohup pgbench -M prepared -n -f test.sql -P 10 -c 20 -j 20 -T 30000000 &gt;./log 2&gt;&amp;1 &amp;</font></span></div><p></p></pre></div><div><div style="line-height: 28px;"   >导入测试结果：</div><div><pre class="prettyprint"   ><p style="line-height: 28px;"   ></p><div><font size="2"   >约4小时后插入数据量如下：</font></div><div><font size="2"   >digoal=&gt; \dt+<br>                   List of relations<br> Schema | Name | Type  | Owner  |  Size  | Description <br>--------+------+-------+--------+--------+-------------<br> digoal | tbl  | table | digoal | 69 GB  | <br>(1 rows)<br><br>digoal=&gt; \di+<br>                        List of relations<br> Schema |   Name   | Type  | Owner  | Table | Size  | Description <br>--------+----------+-------+--------+-------+-------+-------------<br> digoal | tbl_pkey | index | digoal | tbl   | 20 GB | <br>(1 row)</font></div><div style="line-height: 28px;"   ><font size="2"   ><br></font></div><div style="line-height: 28px;"   ><font size="2"   >digoal=&gt; create table az(tps numeric);</font></div><div style="line-height: 28px;"   ><font size="2"   >CREATE TABLE</font></div><div style="line-height: 28px;"   ><font size="2"   >digoal=&gt; \c digoal postgres</font></div><div style="line-height: 28px;"   ><font size="2"   >You are now connected to database "digoal" as user "postgres".</font></div><div style="line-height: 28px;"   ><font size="2"   >digoal=# \copy digoal.az from program 'awk ''NR&gt;2 {print $4}'' /home/postgres/log'</font></div><div style="line-height: 28px;"   ><font size="2"   >COPY 1385</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >digoal=# select avg(tps),min(tps),max(tps),count(*) from digoal.az;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; avg &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; min &nbsp; | &nbsp; max &nbsp; | count&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >--------------------+---------+---------+-------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;69839.050685920578 | 65283.7 | 72175.5 | &nbsp;1385</font></div><div style="line-height: 28px;"   ><font size="2"   >(1 row)</font></div></div><p style="line-height: 28px;"   ></p></pre></div><div style="line-height: 28px;"   ><span style="color: rgb(68, 68, 68); font-family: Tahoma, 'Microsoft Yahei', Simsun; font-size: 12px; line-height: 18px;"   >平均TPS：70433</span><br style="margin: 0px; padding: 0px; word-wrap: break-word; color: rgb(68, 68, 68); font-family: Tahoma, 'Microsoft Yahei', Simsun; font-size: 12px; line-height: 18px;"   ><span style="color: rgb(68, 68, 68); font-family: Tahoma, 'Microsoft Yahei', Simsun; font-size: 12px; line-height: 18px;"   >最小TPS：57417.4</span><br style="margin: 0px; padding: 0px; word-wrap: break-word; color: rgb(68, 68, 68); font-family: Tahoma, 'Microsoft Yahei', Simsun; font-size: 12px; line-height: 18px;"   ><span style="color: rgb(68, 68, 68); font-family: Tahoma, 'Microsoft Yahei', Simsun; font-size: 12px; line-height: 18px;"   >最大TPS：75758.9</span></div><span style="line-height: 28px;"   ><div style="line-height: 28px;"   >图：</div><div style="line-height: 28px;"   ><div><img title="PostgreSQL  Oracle -1 OLTP update/select based primary key  insert - 德哥@Digoal - PostgreSQL research"   alt="PostgreSQL  Oracle -1 OLTP update/select based primary key  insert - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img2.ph.126.net/oPFgjDKmwUYNClZj1SY1rQ==/6630439944560093402.png"   ></div></div><div style="line-height: 28px;"   >检查点同样会对插入有一定影响，不过比对更新的影响小很多，因为并发的xlog full page write更少了(写完一个再扩展一个新的)。</div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >[其他]</div><div style="line-height: 28px;"   >1. 使用PostgreSQL 9.5 重新测试更新，性能同样受到检查点的影响：</div></span></div><div><div><pre class="prettyprint"   ><p style="line-height: 28px;"   ></p><div><font size="2"   ><span style="line-height: 21px;"   >listen_addresses = '0.0.0.0'            # what IP address(es) to listen on;<br>port = 1922                             # (change requires restart)<br>max_connections = 100                   # (change requires restart)<br>superuser_reserved_connections = 13     # (change requires restart)<br>unix_socket_directories = '.'   # comma-separated list of directories<br>tcp_keepalives_idle = 60                # TCP_KEEPIDLE, in seconds;<br>tcp_keepalives_interval = 10            # TCP_KEEPINTVL, in seconds;<br>tcp_keepalives_count = 10               # TCP_KEEPCNT;<br>shared_buffers = 8GB                    # min 128kB<br>huge_pages = try                        # on, off, or try<br>maintenance_work_mem = 1GB              # min 1MB<br>autovacuum_work_mem = 1GB               # min 1MB, or -1 to use maintenance_work_mem<br>dynamic_shared_memory_type = posix      # the default is the first option<br>vacuum_cost_delay = 0                   # 0-100 milliseconds<br>vacuum_cost_limit = 10000               # 1-10000 credits<br>bgwriter_delay = 10ms                   # 10-10000ms between rounds<br>synchronous_commit = off                # synchronization level;<br>wal_sync_method = fdatasync             # the default is the first option<br>wal_buffers = 16MB                      # min 32kB, -1 sets based on shared_buffers<br>wal_writer_delay = 10ms         # 1-10000 milliseconds<br>checkpoint_timeout = 10min         # range 30s-1h<br>max_wal_size = 16GB                         # 配置为shared_buffers一倍, 对于DML频繁的数据库较好<br>min_wal_size = 512MB                         <br>random_page_cost = 2.0                  # same scale as above<br>effective_cache_size = 64GB<br>log_destination = 'csvlog'              # Valid values are combinations of<br>logging_collector = on          # Enable capturing of stderr and csvlog<br>log_truncate_on_rotation = on           # If on, an existing log file with the<br>log_checkpoints = on<br>log_connections = on<br>log_disconnections = on<br>log_error_verbosity = verbose           # terse, default, or verbose messages<br>log_timezone = 'PRC'<br>autovacuum = on                 # Enable autovacuum subprocess?  'on'<br>log_autovacuum_min_duration = 0 # -1 disables, 0 logs all actions and<br>autovacuum_vacuum_scale_factor = 0.002  # fraction of table size before vacuum<br>autovacuum_analyze_scale_factor = 0.001 # fraction of table size before analyze<br>autovacuum_vacuum_cost_delay = 0        # default vacuum cost delay for<br>datestyle = 'iso, mdy'<br>timezone = 'PRC'<br>lc_messages = 'C'                       # locale for system error message<br>lc_monetary = 'C'                       # locale for monetary formatting<br>lc_numeric = 'C'                        # locale for number formatting<br>lc_time = 'C'                           # locale for time formatting<br>default_text_search_config = 'pg_catalog.english'</span></font></div></pre></div></div>
<div>关于检查点为什么有如此大的影响，后面的文章再针对检查点源码分析一下原因。</div><div><br></div><div><br></div><div>[小结]</div><div>1. 测试结果反应了PostgreSQL checkpoint方面的不足之处，影响太大(实际上和checkpointer带来的IO关系不大，主要是这里的更新测试用例瞬间的FULL PAGE WRITE量太大，导致wal write buffer延迟变大而影响了TPS)。</div><div>有兴趣的朋友可查看我另外几篇文章的分析。</div><div><div style="line-height: 28px;"   ><a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201542103933969/"   >http://blog.163.com/digoal@126/blog/static/163877040201542103933969/</a></div><div style="line-height: 28px;"   ><a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402015463252387/"   >http://blog.163.com/digoal@126/blog/static/1638770402015463252387/</a></div><div style="line-height: 28px;"   ><a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020154651655783/"   >http://blog.163.com/digoal@126/blog/static/16387704020154651655783/</a></div><div style="line-height: 28px;"   ><a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020154653422892/"   >http://blog.163.com/digoal@126/blog/static/16387704020154653422892/</a></div><div style="line-height: 28px;"   ><a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020154811421484/"   >http://blog.163.com/digoal@126/blog/static/16387704020154811421484/</a></div><div style="line-height: 28px;"   ><a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020154129958753/"   >http://blog.163.com/digoal@126/blog/static/16387704020154129958753/</a></div></div><div>2.&nbsp;<span style="line-height: 28px;"   >如果你不想使用pgbench来测试PG, 也可以用python, 不过因为psycopg2目前不支持绑定变量, 所以效率会低很多.</span></div><div>原因见：</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402015151653642/"   >http://blog.163.com/digoal@126/blog/static/1638770402015151653642/</a></div><div><div><pre class="prettyprint"   ><p style="line-height: 28px;"   ></p><div style="line-height: 28px;"   ><font size="2"   >import threading</font></div><div style="line-height: 28px;"   ><font size="2"   >import time</font></div><div style="line-height: 28px;"   ><font size="2"   >import psycopg2</font></div><div style="line-height: 28px;"   ><font size="2"   >import random</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >xs=12000</font></div><div style="line-height: 28px;"   ><font size="2"   >tps=dict()</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >class n_t(threading.Thread): &nbsp; # The timer class is derived from the class threading.Thread</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; def __init__(self, num):</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; threading.Thread.__init__(self)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; self.thread_num = num</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; def run(self): #Overwrite run() method, put what you want the thread do here</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; conn = psycopg2.connect(database="digoal", user="digoal", password="digoal", host="/data01/pgdata/pg_root", port="1922")</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; curs = conn.cursor()</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; conn.autocommit=True</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; tps[self.thread_num] = dict()</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; f = open("/tmp/pg_test." + str(self.thread_num), "w")</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; for x in range(1,3001):</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; start_t = time.time()</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; for i in range(0,xs):</font></div><div><font size="2"   ><span style="line-height: 28px;"   >&nbsp; &nbsp; &nbsp; &nbsp; curs.execute("update tbl set info=now(),crt_time=now() where id=%(id)s", {"id": </span>random.randrange(1,50000000)<span style="line-height: 28px;"   >}) &nbsp; &nbsp; &nbsp;</span></font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; stop_t = time.time()</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; tps[self.thread_num][x] = round(xs/(stop_t-start_t),2)</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; res = "Round: " + str(x) + " TID: " + str(self.thread_num) + " Sec: " + str(round((stop_t-start_t),2)) + " tps: " + str(tps[self.thread_num][x])</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; print &gt;&gt; f, res</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; f.flush()</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; f.close()</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >def test():</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; t_names = []</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; for i in xrange(0,27):</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; t_names.append(n_t(i))</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; for t in t_names:</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; t.start()</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; return</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >if __name__ == '__main__':</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; test()</font></div><p style="line-height: 28px;"   ></p></pre></div></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.slideshare.net/petereisentraut/programming-with-python-and-postgresql"   >http://www.slideshare.net/petereisentraut/programming-with-python-and-postgresql<br></a><a style="line-height: 28px;" rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL VS Oracle OLTP update/select based primary key  insert - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div></div>
	</div>
</div>
</body>
</html>