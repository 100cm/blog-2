<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.5 new feature - Allow LOCK TABLE .. ROW EXCLUSIVE MODE with INSERT</h2>
	<h5 id="">2015-05-25 17:36:19&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201542552954275/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL 9.5 的一个小补丁，当用户拥有表的insert权限时，可以通过lock命令申请该表的ROW EXCLUSIVE MODE锁。</div><div>因为insert操作就需要获取row exclusive mode锁。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=# insert into test values(1);</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >postgres=# select *,relation::regclass from pg_locks;</font></div><div><font size="2"   >&nbsp; &nbsp;locktype &nbsp; &nbsp;| database | relation | page | tuple | virtualxid | transactionid | classid | objid | objsubid | virtualtransaction |</font></div><div><font size="2"   >&nbsp;pid &nbsp;| &nbsp; &nbsp; &nbsp; mode &nbsp; &nbsp; &nbsp; | granted | fastpath | relation&nbsp;</font></div><div><font size="2"   >---------------+----------+----------+------+-------+------------+---------------+---------+-------+----------+--------------------+</font></div><div><font size="2"   >------+------------------+---------+----------+----------</font></div><div><font size="2"   >&nbsp;relation &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;13181 | &nbsp; &nbsp;11666 | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3/221 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|</font></div><div><font size="2"   >&nbsp;6799 | AccessShareLock &nbsp;| t &nbsp; &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; &nbsp;| pg_locks</font></div><div><font size="2"   >&nbsp;relation &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp;13181 | &nbsp; &nbsp;16410 | &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3/221 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|</font></div><div><font size="2"   >&nbsp;6799 | RowExclusiveLock | t &nbsp; &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; &nbsp;| test</font></div><div><font size="2"   >&nbsp;virtualxid &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | 3/221 &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3/221 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|</font></div><div><font size="2"   >&nbsp;6799 | ExclusiveLock &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;transactionid | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1768 | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 3/221 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|</font></div><div><font size="2"   >&nbsp;6799 | ExclusiveLock &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >(4 rows)</font></div><p></p></pre></div><div><br></div><div>而在9.5以前，用户必须拥有表的update或truncate或delete权限时，才能申请该表的<span style="line-height: 28px;"   >ROW EXCLUSIVE MODE显锁。</span></div><div><span style="line-height: 28px;"   >9.5以前的例子：</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# revoke all on test from public;</font></div><div><font size="2"   >REVOKE</font></div></div><div><div><font size="2"   >postgres=# grant insert on test to test;</font></div><div><font size="2"   >GRANT</font></div><div><font size="2"   >postgres=# \c postgres test</font></div><div><font size="2"   >You are now connected to database "postgres" as user "test".</font></div></div><div><div><font size="2"   >postgres=&gt; begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=&gt; lock table test in row exclusive mode;</font></div><div><font size="2"   >ERROR: &nbsp;permission denied for relation test</font></div><div><font size="2"   >postgres=&gt; \c postgres postgres</font></div><div><font size="2"   >You are now connected to database "postgres" as user "postgres".</font></div><div><font size="2"   >postgres=# grant update on test to test;</font></div><div><font size="2"   >GRANT</font></div><div><font size="2"   >postgres=# \c postgres test</font></div><div><font size="2"   >You are now connected to database "postgres" as user "test".</font></div><div><font size="2"   >postgres=&gt; begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=&gt; lock table test in row exclusive mode;</font></div><div><font size="2"   >LOCK TABLE</font></div></div><p></p></pre></div><div><br></div><div>9.5的例子：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# revoke all on test from public;</font></div><div><font size="2"   >REVOKE</font></div><div><font size="2"   >postgres=# grant insert on test to digoal;</font></div><div><font size="2"   >GRANT</font></div><div><font size="2"   >postgres=# \c postgres digoal</font></div><div><font size="2"   >You are now connected to database "postgres" as user "digoal".</font></div><div><font size="2"   >postgres=&gt; begin;</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >postgres=&gt; lock table test in row exclusive mode;</font></div><div><font size="2"   >LOCK TABLE</font></div><p></p></pre></div><wbr><div><br></div><div>详见代码：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >--- a/src/backend/commands/lockcmds.c</font></div><div><font size="2"   >+++ b/src/backend/commands/lockcmds.c</font></div><div><font size="2"   >@@ -169,13 +169,17 @@ static AclResult</font></div><div><font size="2"   >&nbsp;LockTableAclCheck(Oid reloid, LOCKMODE lockmode)</font></div><div><font size="2"   >&nbsp;{</font></div><div><font size="2"   >&nbsp; &nbsp; AclResult &nbsp; aclresult;</font></div><div><font size="2"   >+ &nbsp; AclMode &nbsp; &nbsp; aclmask;</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; /* Verify adequate privilege */</font></div><div><font size="2"   >&nbsp; &nbsp; if (lockmode == AccessShareLock)</font></div><div><font size="2"   >- &nbsp; &nbsp; &nbsp; aclresult = pg_class_aclcheck(reloid, GetUserId(),</font></div><div><font size="2"   >- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ACL_SELECT);</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; aclmask = ACL_SELECT;</font></div><div><font size="2"   >+ &nbsp; else if (lockmode == RowExclusiveLock)</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; aclmask = ACL_INSERT | ACL_UPDATE | ACL_DELETE | ACL_TRUNCATE;</font></div><div><font size="2"   >&nbsp; &nbsp; else</font></div><div><font size="2"   >- &nbsp; &nbsp; &nbsp; aclresult = pg_class_aclcheck(reloid, GetUserId(),</font></div><div><font size="2"   >- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ACL_UPDATE | ACL_DELETE | ACL_TRUNCATE);</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; aclmask = ACL_UPDATE | ACL_DELETE | ACL_TRUNCATE;</font></div><div><font size="2"   >+</font></div><div><font size="2"   >+ &nbsp; aclresult = pg_class_aclcheck(reloid, GetUserId(), aclmask);</font></div><div><font size="2"   >+</font></div><div><font size="2"   >&nbsp; &nbsp; return aclresult;</font></div><div><font size="2"   >&nbsp;}</font></div><p></p></pre></div><div>这算是个小补丁，但是目前并没有加入到低版本中。</div><div><div>Not back-patching this as it's a behavior change which, strictly</div><div>speaking, loosens security restrictions.</div></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commitdiff;h=fa2642438f189c2b169ace3ac1df19533b9c7781"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commitdiff;h=fa2642438f189c2b169ace3ac1df19533b9c7781<br></a><span style="line-height: 28px;"   >
</span><a style="line-height: 28px;" rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL 9.5 new feature - Allow LOCK TABLE .. ROW EXCLUSIVE MODE with INSERT - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div></div>
	</div>
</div>
</body>
</html>