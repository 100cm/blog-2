<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Use File/External Table with PostgreSQL 9.1's new extension: file_fdw</h2>
	<h5 id="">2011-05-16 17:25:26&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201141641148311/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><a target="_blank" rel="nofollow" href="https://wiki.postgresql.org/wiki/Foreign_data_wrappers"   >https://wiki.postgresql.org/wiki/Foreign_data_wrappers</a></div><div>在讲外部表之前，先来说说PostgreSQL 9.1 的extension, 在 9.1 之前叫做module.</div>9.1 以后PostgreSQL对模块化插件做了相当巨大的改变，<div>如</div><div>9.1 以前加载一个dblink模块，需要在ROOT下gmake install这个模块,然后在postgres下面，psql -d ? -U superuser -f dblink.sql</div><div>9.1及以后,extension被认为是数据库感知 (database awareness) 的，因此在加载，升级，降级，备份extension都比较方便和强大，特别是对于有初始化数据和后期有数据更新的模块化配置表，如postgis,那么在导出时可以选择备份初始化以外插入的数据，而不要初始化数据。总之非常强大。</div><div><br></div><div>下面来说说PostgreSQL外部表。</div><div>注意编译PostgreSQL9.1的时候使用</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >gmake world</font></div><div><p><font size="2"   >gmake install-world</font></p></div><p></p></pre></div><div>编译完成后$PGHOME/share/extension里面会有所有的extension。</div><div>$PGHOME/lib里面会有所有自带的SO，例如我们一会要用到的file_fdw.so。因此后面在create extension之前就不需要再gmake install了.</div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >psql -h 127.0.0.1 digoal digoal</font></div><div><div><font size="2"   >digoal=&gt; \c digoal postgres</font></div><div><font size="2"   >You are now connected to database "digoal" as user "postgres".</font></div><div><font size="2"   >digoal=# create extension file_fdw;</font></div><div><font size="2"   >CREATE EXTENSION</font></div></div><p></p></pre></div><div>此时，新增了两个函数</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >file_fdw_handler</font></div><div><font size="2"   >file_fdw_validator</font></div><p></p></pre></div><div><br></div><div>然后创建一个foreign database wrapper</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; \c digoal postgres</font></div><div><font size="2"   >You are now connected to database "digoal" as user "postgres".</font></div><div><font size="2"   >digoal=# CREATE FOREIGN DATA WRAPPER fdw_file handler file_fdw_handler VALIDATOR file_fdw_validator ;</font></div><div><font size="2"   >CREATE FOREIGN DATA WRAPPER</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal=# select * from pg_foreign_data_wrapper; &nbsp;-- 必须使用超级用户创建fdw, 这个视图是cluster级别的结果,因此在别的库建的fdw在这里都可以看到。</font></div><div><font size="2"   >&nbsp;fdwname &nbsp;| fdwowner | fdwhandler | fdwvalidator | fdwacl | fdwoptions&nbsp;</font></div><div><font size="2"   >----------+----------+------------+--------------+--------+------------</font></div><div><font size="2"   >&nbsp;file_fdw | &nbsp; &nbsp; &nbsp; 10 | &nbsp; &nbsp; &nbsp;16432 | &nbsp; &nbsp; &nbsp; &nbsp;16433 | &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;fdw_file | &nbsp; &nbsp; &nbsp; 10 | &nbsp; &nbsp; &nbsp;16432 | &nbsp; &nbsp; &nbsp; &nbsp;16433 | &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >(2 rows)</font></div></div><p></p></pre></div><div><br></div><div>创建server</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# CREATE SERVER file_server FOREIGN DATA WRAPPER file_fdw;</font></div></div><div><div><font size="2"   >CREATE SERVER</font></div></div><p></p></pre></div><div><br></div><div><br></div><div># 找一个外部表的例子，如SAR的输出</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >sar -q|grep -v "^$"|grep -v "Average"|grep -v "^Linux" |sed -e 's/[[:space:]][[:space:]]*/ /g' &gt;./test.csv</font></div><div><div><font size="2"   >postgres@db5-&gt; cat test.csv&nbsp;</font></div><div><font size="2"   >12:00:01 AM runq-sz plist-sz ldavg-1 ldavg-5 ldavg-15</font></div><div><font size="2"   >12:05:01 AM 0 351 0.00 0.01 0.00</font></div><div><font size="2"   >12:10:01 AM 1 349 0.00 0.00 0.00</font></div></div><p></p></pre></div><div><br></div><div>创建foreign table</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# CREATE FOREIGN TABLE ext_sar (</font></div><div><font size="2"   >crt_time text,am_pm text,runq_sz int, plist_sz &nbsp;int, ldavg_1 numeric, &nbsp;ldavg_5 numeric, ldavg_15 numeric</font></div><div><font size="2"   >) SERVER file_server OPTIONS (format 'csv', filename '/home/postgres/test.csv', header 'true', delimiter ' ', null '');</font></div><div><font size="2"   >CREATE FOREIGN TABLE</font></div></div><div><div><font size="2"   >digoal=# select count(*) from ext_sar;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp;206</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >digoal=# \c digoal digoal</font></div><div><font size="2"   >You are now connected to database "digoal" as user "digoal".</font></div><div><font size="2"   >digoal=&gt; select count(*) from ext_sar;</font></div><div><font size="2"   >ERROR: &nbsp;permission denied for relation ext_sar</font></div></div><div><font size="2"   >\c digoal postgres</font></div><div><div><font size="2"   >digoal=# grant select on table ext_sar to digoal;</font></div><div><font size="2"   >GRANT</font></div><div><font size="2"   >digoal=# \c digoal digoal</font></div><div><font size="2"   >You are now connected to database "digoal" as user "digoal".</font></div><div><font size="2"   >digoal=&gt; select count(*) from ext_sar;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp;206</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >digoal=&gt; select * from pg_foreign_table ;</font></div><div><font size="2"   >&nbsp;ftrelid | ftserver | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ftoptions &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------+----------+-------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp; &nbsp;16462 | &nbsp; &nbsp;16458 | {format=csv,filename=/home/postgres/test.csv,header=true,"delimiter= ",null=}</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div><div><br></div><div>外部表不能更新，插入，删除。</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; select * from ext_sar ;</font></div><div><font size="2"   >&nbsp;crt_time | am_pm | runq_sz | plist_sz | ldavg_1 | ldavg_5 | ldavg_15&nbsp;</font></div><div><font size="2"   >----------+-------+---------+----------+---------+---------+----------</font></div><div><font size="2"   >&nbsp;12:05:01 | AM &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp;351 | &nbsp; &nbsp;0.00 | &nbsp; &nbsp;0.01 | &nbsp; &nbsp; 0.00</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal=# &nbsp; update ext_sar set runq_sz=2 where crt_time='12:05:01';</font></div><div><font size="2"   >ERROR: &nbsp;cannot change foreign table "ext_sar"</font></div></div><div><div><font size="2"   >digoal=# &nbsp;delete from ext_sar;</font></div><div><font size="2"   >ERROR: &nbsp;cannot change foreign table "ext_sar"</font></div><div><font size="2"   >digoal=# &nbsp;insert into ext_sar select * from ext_sar;</font></div><div><font size="2"   >ERROR: &nbsp;cannot change foreign table "ext_sar"</font></div></div><p></p></pre></div><div><br></div><div>参考 &nbsp;: &nbsp;</div><div>CREATE FOREIGN DATA WRAPPER &nbsp;</div><div>CREATE SERVER &nbsp;</div><div>CREATE USER MAPPING FOR &nbsp;</div><div>CREATE FOREIGN TABLE &nbsp;</div><div>file_fdw extension &nbsp;</div><div>【其他fdw】</div><div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >1. hive</div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136); " rel="nofollow" href="https://github.com/youngwookim/hive-fdw-for-postgresql"   >https://github.com/youngwookim/hive-fdw-for-postgresql</a></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><div style="line-height: 25px;"   >2. PostgreSQL Foreign Table - pgsql_fdw</div><div style="line-height: 25px;"   ><a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136); " target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201231514057303/"   >http://blog.163.com/digoal@126/blog/static/163877040201231514057303/</a></div><div style="line-height: 25px;"   >3. PostgreSQL Foreign Table - oracle_fdw 1</div><div style="line-height: 25px;"   ><a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136); " target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201181505331588/"   >http://blog.163.com/digoal@126/blog/static/163877040201181505331588/</a></div><div style="line-height: 25px;"   >4. PostgreSQL Foreign Table - oracle_fdw 2</div><div style="line-height: 25px;"   ><a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136); " target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020118151162340/"   >http://blog.163.com/digoal@126/blog/static/16387704020118151162340/</a></div><div style="line-height: 25px;"   >5. PostgreSQL Foreign Table - oracle_fdw 3</div><div style="line-height: 25px;"   ><a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136); " target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020118951953408/"   >http://blog.163.com/digoal@126/blog/static/16387704020118951953408/</a></div><div style="line-height: 25px;"   >6. PostgreSQL Foreign Table - file_fdw</div><div style="line-height: 25px;"   ><a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136); " target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201141641148311/"   >http://blog.163.com/digoal@126/blog/static/163877040201141641148311/</a></div><div style="line-height: 25px;"   >7. PostgreSQL Foreign Table - redis_fdw</div><div style="line-height: 25px;"   ><a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136); " target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020119181188247/"   >http://blog.163.com/digoal@126/blog/static/16387704020119181188247/</a></div><div style="line-height: 25px;"   >8. PostgreSQL Foreign Table - mysql_fdw 1</div><div style="line-height: 25px;"   ><a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136); " target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402011111233524987/"   >http://blog.163.com/digoal@126/blog/static/1638770402011111233524987/</a></div><div style="line-height: 25px;"   >9. PostgreSQL Foreign Table - mysql_fdw 2</div><div style="line-height: 25px;"   ><a style="line-height: 25px; text-decoration: none; color: rgb(85, 108, 136); " target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020121108551698/"   >http://blog.163.com/digoal@126/blog/static/16387704020121108551698/</a></div></div></div><div><br></div><div><br></div><div><wbr></div></div>
	</div>
</div>
</body>
</html>