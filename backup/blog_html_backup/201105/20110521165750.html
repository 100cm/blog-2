<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">A Case about cursor_sharing=FORCE can introduce a execute plan stale</h2>
	<h5 id="">2011-05-21 16:57:50&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201142145023450/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">今天一位同事带着非常忐忑的心情来找我，棋牌项目的ORACLE数据库负载过高。<br><div>我连上服务器一看，果然，LOAD 100多。IOWAIT非常低。</div><div>再TOP一下，发现ACTIVE进程非常多，单个消耗CPU在20%左右。</div><div>然后这位同事跟我描述了一下，今天上了一个推广的活动，可能导致业务量猛增，我开始怀疑是正常的业务请求。</div><div>--- 此处省略1000字。</div><div>于是开始抓STATSPACK报告，不过LOAD 100多抓起来非常呛。</div><div>最终发现以下SQL消耗CPU过多。</div><div>因为开启了cursor_sharing=FORCE，这条SQL执行计划被锁定了（后面会有处理办法）。</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp; Elapsed &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Elap per &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Old</font></div><div><font size="2"  >&nbsp; Time (s) &nbsp; Executions &nbsp;Exec (s) &nbsp;%Total &nbsp; Time (s) &nbsp;Physical Reads Hash Value</font></div><div><font size="2"  >---------- ------------ ---------- ------ ---------- --------------- ----------</font></div><div><font size="2"  >&nbsp;353348.79 &nbsp; &nbsp; &nbsp; 29,044 &nbsp; &nbsp; &nbsp;12.17 &nbsp; 87.6 &nbsp; 29731.62 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 1523025606</font></div><div><font size="2"  >select * &nbsp; &nbsp; from CAC_xxxxxx &nbsp; &nbsp; where &nbsp; &nbsp; &nbsp;:"SY</font></div><div><font size="2"  >S_B_0" = :"SYS_B_1" &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; and &nbsp; &nbsp; &nbsp; &nbsp;GAME_ID = :1</font></div><div><font size="2"  >&nbsp; &nbsp; and &nbsp; &nbsp; &nbsp; &nbsp;SKY_ID = :2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;and START_TIME &gt;(sysDate -</font></div><div><font size="2"  >&nbsp;:"SYS_B_2") &nbsp; &nbsp; &nbsp;and (TASK_STATUS = :"SYS_B_3" or TASK_STATUS =</font></div><div><font size="2"  >&nbsp;-:"SYS_B_4") &nbsp; &nbsp; &nbsp; &nbsp;order by START_TIME desc</font></div><p></p></pre></div><div><br></div><div>于是去看一看执行计划 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >Plan hash value: 4233498801&nbsp;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >----------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >| Id &nbsp;| Operation &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Rows &nbsp;| Bytes | Cost (%CPU)| Time &nbsp; &nbsp; | Pstart| Pstop |</font></div><div><font size="2"  >----------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >| &nbsp; 0 | SELECT STATEMENT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; 1 | &nbsp; &nbsp;95 | &nbsp; &nbsp;62 &nbsp; (2)| 00:00:01 | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"  >| &nbsp; 1 | &nbsp;PARTITION RANGE ITERATOR &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; 1 | &nbsp; &nbsp;95 | &nbsp; &nbsp;62 &nbsp; (2)| 00:00:01 | &nbsp; &nbsp;27 | &nbsp; KEY |</font></div><div><font size="2"  >| &nbsp; 2 | &nbsp; SORT ORDER BY &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; 1 | &nbsp; &nbsp;95 | &nbsp; &nbsp;62 &nbsp; (2)| 00:00:01 | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; |</font></div><div><font size="2"  >|* &nbsp;3 | &nbsp; &nbsp;TABLE ACCESS BY LOCAL INDEX ROWID| CAC_xxxxxx | &nbsp; &nbsp; 1 | &nbsp; &nbsp;95 | &nbsp; &nbsp;61 &nbsp; (0)| 00:00:01 | &nbsp; &nbsp;27 | &nbsp; KEY |</font></div><div><font size="2"  >|* &nbsp;4 | &nbsp; &nbsp; INDEX RANGE SCAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| IDX_ACH_SKY_ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; 6 | &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp;55 &nbsp; (0)| 00:00:01 | &nbsp; &nbsp;27 | &nbsp; KEY |</font></div><div><font size="2"  >----------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Predicate Information (identified by operation id):</font></div><div><font size="2"  >---------------------------------------------------</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp;3 - filter(("TASK_STATUS"=(-1) OR "TASK_STATUS"=1) AND "START_TIME"&gt;SYSDATE@!-1 AND "GAME_ID"=1)</font></div><div><font size="2"  >&nbsp; &nbsp;4 - access("SKY_ID"=1)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >17 rows selected.</font></div><p></p></pre></div><div><br></div><div>从现象上来看，执行计划是对的。</div><div>因为cursor_sharing=FORCE，执行计划固化。</div><div>为了保险起见，还是对这个表收集了一把统计信息</div><div><pre class="prettyprint"  ><p>EXEC DBMS_STATS.GATHER_table_STATS (OWNNAME =&gt; 'username',TABNAME =&gt;'CAC_XXXXXX',METHOD_OPT =&gt; 'FOR ALL',estimate_percent=&gt;5,cascade =&gt; true);</p></pre></div><div><br></div><div>收集完后，数据库负载当然还是那么高滴。</div><div>现在要做得是把执行计划解固。</div><div>SQL&gt; alter system flush shared_pool;</div><div>缓存的执行计划随着shared_pool清空而清空。</div><div><br></div><div>清空后立刻见效：</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >oracle@db-digoal-&gt; vmstat -n 1</font></div><div><font size="2"  >procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu------</font></div><div><font size="2"  >&nbsp;r &nbsp;b &nbsp; swpd &nbsp; free &nbsp; buff &nbsp;cache &nbsp; si &nbsp; so &nbsp; &nbsp;bi &nbsp; &nbsp;bo &nbsp; in &nbsp; cs us sy id wa st</font></div></div><div><div><font size="2"  >112 &nbsp;1 &nbsp; &nbsp; &nbsp;0 3957260 286444 18216008 &nbsp; &nbsp;0 &nbsp; &nbsp;0 &nbsp; &nbsp;51 &nbsp; &nbsp;58 1593 8418 100 &nbsp;0 &nbsp;0 &nbsp;0 &nbsp;0</font></div><div><font size="2"  >93 &nbsp;3 &nbsp; &nbsp; &nbsp;0 3955432 286444 18217096 &nbsp; &nbsp;0 &nbsp; &nbsp;0 &nbsp;1175 &nbsp; 993 1660 9244 99 &nbsp;0 &nbsp;0 &nbsp;0 &nbsp;0</font></div><div><font size="2"  >74 &nbsp;2 &nbsp; &nbsp; &nbsp;0 3951096 286444 18220176 &nbsp; &nbsp;0 &nbsp; &nbsp;0 &nbsp;3311 &nbsp;2090 1980 10706 99 &nbsp;0 &nbsp;0 &nbsp;0 &nbsp;0</font></div><div><font size="2"  >62 &nbsp;5 &nbsp; &nbsp; &nbsp;0 3904224 286444 18264240 &nbsp; &nbsp;0 &nbsp; &nbsp;0 44602 &nbsp; 193 2713 20304 97 &nbsp;1 &nbsp;1 &nbsp;1 &nbsp;0</font></div><div><font size="2"  >&nbsp;4 &nbsp;3 &nbsp; &nbsp; &nbsp;0 3830140 286444 18329288 &nbsp; &nbsp;0 &nbsp; &nbsp;0 66340 73856 11196 67220 54 &nbsp;5 34 &nbsp;6 &nbsp;0</font></div><div><font size="2"  >&nbsp;2 &nbsp;3 &nbsp; &nbsp; &nbsp;0 3660048 286448 18493348 &nbsp; &nbsp;0 &nbsp; &nbsp;0 164539 &nbsp;1067 11295 67007 19 &nbsp;6 69 &nbsp;7 &nbsp;0</font></div><div><font size="2"  >10 &nbsp;5 &nbsp; &nbsp; &nbsp;0 3494580 286448 18653152 &nbsp; &nbsp;0 &nbsp; &nbsp;0 159327 &nbsp;2159 9271 35820 10 &nbsp;4 77 &nbsp;9 &nbsp;0</font></div><div><font size="2"  >&nbsp;7 &nbsp;3 &nbsp; &nbsp; &nbsp;0 3375788 286448 18765216 &nbsp; &nbsp;0 &nbsp; &nbsp;0 112467 &nbsp;8500 12912 36616 14 &nbsp;5 70 12 &nbsp;0</font></div><div><font size="2"  >&nbsp;0 &nbsp;2 &nbsp; &nbsp; &nbsp;0 3223936 286448 18911064 &nbsp; &nbsp;0 &nbsp; &nbsp;0 146187 &nbsp;2815 12425 40537 10 &nbsp;4 76 10 &nbsp;0</font></div><div><font size="2"  >&nbsp;0 &nbsp;5 &nbsp; &nbsp; &nbsp;0 3057604 286448 19024216 &nbsp; &nbsp;0 &nbsp; &nbsp;0 112646 304645 9411 19671 &nbsp;5 &nbsp;4 81 10 &nbsp;0</font></div></div><p></p></pre></div><div><br></div><div>CPU过高在数据库里面其实是一个比较经典的案例，有硬解析造成的，有执行计划不优造成的等等。</div><div>这次也不例外,归根结底就是执行计划的问题。</div></div>
	</div>
</div>
</body>
</html>