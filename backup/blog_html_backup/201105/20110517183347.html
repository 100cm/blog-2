<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Use mongodb 1.8.1's replicaSet with auth,journal,keyFile feature</h2>
	<h5 id="">2011-05-17 18:33:47&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020114176334766/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><br></div><div>MongoDB replicSet 1.8.1 产品部署推荐:</div><div>1. 文件系统加载时使用参数noatime</div><div>2. no VM PAGEs</div><div>3. 推荐使用逻辑卷,文件系统推荐ext4或xfs</div><div>4. 3个full nodes 或 2个full nodes+1个arbiter node (最好是奇数个物理服务器,否则仲裁会有问题，例如两台物理机，两个mongod进程，相互网络不通的话，任何一台都无法达到majority，因此都无法成为primary。那就是只读了.因此本例的物理服务器只有2台是不合理的。)</div><div>5. 推荐使用auth,</div><div>6. keyFile建议权限400</div><div>7. 推荐关闭http访问</div><div>8. 建议开启journal , 注意，开启journal后一个逻辑写将产生最多4个物理写</div><div>(1main,1journal,1local,1journal)</div><div>但是由于IO是异步的，所以一般不会有4个物理写这么严重。</div><div><br></div><div>本例环境:</div><div>2个full nodes + 1个arbiter node</div><div>member1 : 192.168.175.67:5281</div><div>member2 : 192.168.175.70:5281</div><div>member3(arbiter Only) : 192.168.175.70:5282</div><div><br></div><div>详细配置:</div><div>1. 操作系统版本 Red Hat Enterprise Linux Server release 5.6 (Tikanga) 64位</div><div><br></div><div>2. sshd配置</div><div>vi /etc/ssh/sshd_config</div><div>PubkeyAuthentication no</div><div>UseDNS no</div><div><br></div><div>3. ssh配置</div><div>vi /etc/ssh/ssh_config</div><div>GSSAPIAuthentication no</div><div><br></div><div>4. root用户 crontab配置</div><div>8 * * * * /usr/sbin/ntpdate asia.pool.ntp.org &amp;&amp; /sbin/hwclock --systohc</div><div>1 * * * * /usr/local/bin/monitor_entry.sh disk</div><div><br></div><div>5. ntpd配置</div><div>vi /etc/sysconfig/ntpd</div><div>SYNC_HWCLOCK=yes</div><div><br></div><div>6. rc.local配置</div><div>vi /etc/rc.local</div><div>sysctl -w net.ipv4.ip_conntrack_max=655360</div><div>sysctl -w net.ipv4.tcp_timestamps=0</div><div><br></div><div>7. 服务配置</div><div>chkconfig --level 35 cmirror off</div><div>chkconfig --level 35 rhnsd off</div><div>chkconfig --level 35 ricci off</div><div><br></div><div>8. 更新网卡驱动(RHEL5.6不需要更新)</div><div><br></div><div>9. sysctl.conf配置</div><div>vi /etc/sysctl.conf</div><div>kernel.shmmni = 4096</div><div>kernel.sem = 50100 64128000 50100 1280</div><div>fs.file-max = 7672460</div><div>net.ipv4.ip_local_port_range = 9000 65000</div><div>net.core.rmem_default = 1048576</div><div>net.core.rmem_max = 4194304</div><div>net.core.wmem_default = 262144</div><div>net.core.wmem_max = 1048576</div><div>net.ipv4.tcp_tw_recycle = 1</div><div>net.ipv4.tcp_max_syn_backlog = 4096</div><div>net.core.netdev_max_backlog = 10000</div><div>net.ipv4.ip_conntrack_max = 655360</div><div>fs.aio-max-nr = 1048576</div><div>net.ipv4.tcp_timestamps = 0</div><div>vm.overcommit_memory = 0</div><div><br></div><div>10. vi /etc/pam.d/login</div><div>session required pam_limits.so</div><div><br></div><div>11. vi /etc/security/limits.conf</div><div>* soft &nbsp; &nbsp;nofile &nbsp;131072</div><div>* hard &nbsp; &nbsp;nofile &nbsp;131072</div><div>* soft &nbsp; &nbsp;nproc &nbsp; 131072</div><div>* hard &nbsp; &nbsp;nproc &nbsp; 131072</div><div>* soft &nbsp; &nbsp;core &nbsp; &nbsp;unlimited</div><div>* hard &nbsp; &nbsp;core &nbsp; &nbsp;unlimited</div><div>* soft &nbsp; &nbsp;memlock 50000000</div><div>* hard &nbsp; &nbsp;memlock 50000000</div><div><br></div><div>12. 主机名配置</div><div>hostname db-192-168-175-67.sky-mobi.com.hz.sandun</div><div>vi /etc/sysconfig/network</div><div>HOSTNAME=db-192-168-175-67.sky-mobi.com.hz.sandun</div><div><br></div><div>13. vi /etc/resolv.conf</div><div>search sky-mobi.com.hz.sandun</div><div>nameserver 211.140.188.188</div><div><br></div><div>14. 主机名配置</div><div>vi /etc/hosts</div><div>127.0.0.1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; localhost.localdomain localhost</div><div>192.168.175.67 db-192-168-175-67.sky-mobi.com.hz.sandun db-192-168-175-67</div><div>192.168.175.70 db-192-168-175-70.sky-mobi.com.hz.sandun db-192-168-175-70</div><div><br></div><div>15. 密码配置</div><div>passwd root</div><div>passwd mongo</div><div><br></div><div>16. mongo用户profile</div><div>vi .bash_profile</div><div>export PS1="$USER@`/bin/hostname -s`-&gt; "&nbsp;</div><div>export MONGO_HOME=/opt/mongo</div><div>export PATH=$MONGO_HOME/bin:$PATH:.</div><div>umask 022</div><div>alias rm='rm -i'</div><div>alias ll='ls -lh'</div><div><br></div><div>17. 下载解压最新的稳定版</div><div>wget mongodb-linux-x86_64-1.8.1.tar</div><div><br></div><div>tar -xvf mongodb-linux-x86_64-1.8.1.tar</div><div>mv mongodb-linux-x86_64-1.8.1 /opt/mongo</div><div><br></div><div>chown -R mongo:mongo /opt/mongo</div><div><br></div><div>18. 建立日志目录</div><div>mkdir /var/log/mongo</div><div>chown -R mongo:mongo /var/log/mongo</div><div><br></div><div>19. 建立数据文件目录和配置文件目录</div><div>mkdir -p /opt/mongodata/conf</div><div>chown -R mongo:mongo /opt/mongodata</div><div><br></div><div>19.1 192.168.175.70上需要多建立一个arbiter的数据目录和配置文件目录</div><div>mkdir -p /database/mongodb/data1/mongodata/conf</div><div>chown -R mongo:mongo /database/mongodb/data1/mongodata</div><div><br></div><div>20. 配置密钥文件:</div><div>1.8.1版本开始增加了replicaSet的auth支持,但是replicaSet的member之间通讯认证需要用到keyFile,确保所有的member服务器上都有一个同样的keyFile,确保权限是400的.类似一个密钥文件.</div><div>member1 :&nbsp;</div><div>echo "this is a key file created by digoal zhou at 20110518 used to auth by replica set members each OTHER" &gt; /opt/mongodata/conf/keyFile</div><div>chmod 400 /opt/mongodata/conf/keyFile</div><div>member2 :&nbsp;</div><div>echo "this is a key file created by digoal zhou at 20110518 used to auth by replica set members each OTHER" &gt; /opt/mongodata/conf/keyFile</div><div>chmod 400 /opt/mongodata/conf/keyFile</div><div>member3 :&nbsp;</div><div>echo "this is a key file created by digoal zhou at 20110518 used to auth by replica set members each OTHER" &gt; /database/mongodb/data1/mongodata/conf/keyFile</div><div>chmod 400 /database/mongodb/data1/mongodata/conf/keyFile</div><div><br></div><div>20.1 配置启动文件:</div><div>member1 &amp; member2 :&nbsp;</div><div>vi /opt/mongodata/conf/mongod.conf</div><div>member3 :&nbsp;</div><div>vi /database/mongodb/data1/mongodata/conf/mongod.conf</div><div><br></div><div>logpath=/var/log/mongo/mongod5281.log</div><div>logappend=true</div><div>fork = true</div><div>port = 5281</div><div>dbpath=/opt/mongodata</div><div>auth = true</div><div>nohttpinterface = true</div><div>nssize = 128</div><div>directoryperdb = true</div><div>maxConns = 1500</div><div>oplogSize = 10240</div><div>keyFile=/opt/mongodata/conf/keyFile</div><div>journal=true</div><div>profile=1</div><div>slowms=100</div><div>replSet=blss</div><div><br></div><div>logpath=/var/log/mongo/mongod5281.log</div><div>logappend=true</div><div>fork = true</div><div>port = 5281</div><div>dbpath=/opt/mongodata</div><div>auth = true</div><div>nohttpinterface = true</div><div>nssize = 128</div><div>directoryperdb = true</div><div>maxConns = 1500</div><div>oplogSize = 10240</div><div>keyFile=/opt/mongodata/conf/keyFile</div><div>journal=true</div><div>profile=1</div><div>slowms=100</div><div>replSet=blss</div><div><br></div><div>logpath=/var/log/mongo/mongod5282.log</div><div>logappend=true</div><div>fork = true</div><div>port = 5282</div><div>dbpath=/database/mongodb/data1/mongodata</div><div>auth = true</div><div>nohttpinterface = true</div><div>nssize = 128</div><div>directoryperdb = true</div><div>maxConns = 1500</div><div>oplogSize = 10240</div><div>keyFile=/database/mongodb/data1/mongodata/conf/keyFile</div><div>journal=true</div><div>profile=1</div><div>slowms=100</div><div>replSet=blss</div><div><br></div><div>21. 启动所有节点并初始化replicaSet</div><div>member1 &amp; member2</div><div>mongod -f /opt/mongodata/conf/mongod.conf</div><div>member3 :&nbsp;</div><div>mongod -f /database/mongodb/data1/mongodata/conf/mongod.conf</div><div><br></div><div># 初始化(只需要连到一个节点操作)</div><div>db.runCommand({replSetInitiate : {</div><div>&nbsp; _id : "blss",</div><div>&nbsp; members: [</div><div>&nbsp; &nbsp; {</div><div>&nbsp; &nbsp; &nbsp; _id : 0,</div><div>&nbsp; &nbsp; &nbsp; host : "192.168.175.67:5281" ,</div><div>&nbsp; &nbsp; &nbsp; arbiterOnly : &nbsp; false</div><div>&nbsp; &nbsp; }</div><div>&nbsp; &nbsp; ,&nbsp;</div><div>&nbsp; &nbsp; {</div><div>&nbsp; &nbsp; &nbsp; _id : 1,</div><div>&nbsp; &nbsp; &nbsp; host : "192.168.175.70:5281" ,</div><div>&nbsp; &nbsp; &nbsp; arbiterOnly : &nbsp; false</div><div>&nbsp; &nbsp; }</div><div>&nbsp; &nbsp; ,&nbsp;</div><div>&nbsp; &nbsp; {</div><div>&nbsp; &nbsp; &nbsp; _id : 2,</div><div>&nbsp; &nbsp; &nbsp; host : "192.168.175.70:5282" ,</div><div>&nbsp; &nbsp; &nbsp; arbiterOnly : &nbsp; true</div><div>&nbsp; &nbsp; }</div><div>&nbsp; ]</div><div>}})</div><div><br></div><div><br></div><div># 等待local初始完成(确保所有节点都正常),添加用户</div><div>blss:PRIMARY&gt; rs.status() &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>{</div><div>&nbsp; &nbsp; &nbsp; &nbsp; "set" : "blss",</div><div>&nbsp; &nbsp; &nbsp; &nbsp; "date" : ISODate("2011-05-17T10:22:47Z"),</div><div>&nbsp; &nbsp; &nbsp; &nbsp; "myState" : 1,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; "members" : [</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "_id" : 0,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "name" : "192.168.175.67:5281",</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "health" : 1,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "state" : 1,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "stateStr" : "PRIMARY",</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "optime" : {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "t" : 1305625603000,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "i" : 1</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "optimeDate" : ISODate("2011-05-17T09:46:43Z"),</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "self" : true</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "_id" : 1,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "name" : "192.168.175.70:5281",</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "health" : 1,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "state" : 2,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "stateStr" : "SECONDARY",</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "uptime" : 2990,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "optime" : {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "t" : 1305625603000,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "i" : 1</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "optimeDate" : ISODate("2011-05-17T09:46:43Z"),</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "lastHeartbeat" : ISODate("2011-05-17T10:22:46Z")</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "_id" : 2,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "name" : "192.168.175.70:5282",</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "health" : 1,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "state" : 7,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "stateStr" : "ARBITER",</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "uptime" : 2994,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "optime" : {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "t" : 0,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "i" : 0</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "optimeDate" : ISODate("1970-01-01T00:00:00Z"),</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "lastHeartbeat" : ISODate("2011-05-17T10:22:46Z")</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</div><div>&nbsp; &nbsp; &nbsp; &nbsp; ],</div><div>&nbsp; &nbsp; &nbsp; &nbsp; "ok" : 1</div><div>}</div><div><br></div><div># 状态正常,新建用户</div><div>mongo 127.0.0.1:5281/admin</div><div>db.addUser("xxx","xxxxx");</div><div>db.auth("xxx","xxxxx");</div><div># 新增业库blss务用户</div><div>use digoal</div><div>db.addUser("digoal","Fdigoal-")</div><div><br></div><div>22. 查看日志</div><div><br></div><div>23. 其他管理命令</div><div>rs.?</div><div><br></div><div>24. 切换,自动</div><div><br></div><div>25. 连接到Replica Sets环境的驱动配置</div><div>Connecting Drivers to Replica Sets :&nbsp;</div><div>Ideally a MongoDB driver can connect to a cluster of servers which represent a &nbsp;, and automatically find the right set member with which replica set to communicate. &nbsp;Failover should be automatic too. &nbsp;The general steps are:</div><div>1. The user, when opening the connection, specifies host[:port] for one or more members of the set. &nbsp;Not all members need be specified -- in fact the exact members of the set might change over time. &nbsp;This list for the connect call is the &nbsp;. seed list</div><div>2. The driver then connects to all servers on the seed list, perhaps in parallel to minimize connect time. &nbsp;Send an ismaster command to each server.</div><div>3. When the server is in replSet mode, it will return a &nbsp; field with all members of the set that are potentially eligible to serve data. &nbsp;The hosts client should cache this information. &nbsp;Ideally this refreshes too, as the set's config could change over time.</div><div>4. Choose a server with which to communicate.&nbsp;</div><div><span style="white-space:pre;"> </span>If ismaster == true, that server is primary for the set. &nbsp;This server can be used for writes and immediately consistent reads.&nbsp;</div><div><span style="white-space:pre;"> </span>If secondary == true, that server is not primary, but is available for eventually consistent reads. In this case, you can use the field to see which server the master should be. primary</div><div>4. If an error occurs with the current connection, find the new primary and resume use there.</div><div><br></div><div>26. 配置iptables</div><div><br></div><div>27. 配置监控</div><div><br></div><div>OTHERs:</div><div>关于JAVa连接MONGODB replica set的一个例子 :&nbsp;</div><div><div>Now that we have a replica set, it's time to use it with the Java driver. First, we can connect to the replica set. We can connect to any instance, the driver will fecth the list of other instances and other informations like who is the master. But, it's a good practice to have a list of several nodes to connect to, so if one node we connect to is down, we can fetch the nodes list from the other:</div><div><br></div><div>String url = "192.168.175.67:5281,192.168.175.70:5281";</div><div>ArrayList&lt;ServerAddress&gt; addr = new ArrayList&lt;ServerAddress&gt;();</div><div>for (String s: url.split(",")) {</div><div>&nbsp; &nbsp; addr.add(new ServerAddress(s));</div><div>}</div><div>Mongo mongo = new Mongo(addr);</div><div><br></div><div>控制是否要把READ请求发给slave</div><div>Then, you can use the driver normally. By default, it will send all the requests, reads and writes, to the master. Bit you can configure the driver to send only writes to the master, the reads will be dispatched on the slaves. And it's only one line of code to do this:</div><div><br></div><div>mongo.slaveOk();</div><div><br></div></div><div><div>28. 扩容和去除节点测试</div><div>去掉192.168.175.70:5282 member</div><div>增加192.168.175.71:5281 member</div><div><br></div><div>1. 首先把192.168.175.71:5281配置好,mongod起来</div><div>2. 去掉192.168.175.70:5282</div><div>&nbsp; &nbsp;连接到主节点</div><div>&nbsp; &nbsp;mongo 127.0.0.1:5281/admin</div><div>&nbsp; &nbsp;db.auth("digoal","pwd")</div><div><br></div><div>blss:PRIMARY&gt; rs.conf() &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>{</div><div>&nbsp; &nbsp; &nbsp; &nbsp; "_id" : "blss",</div><div>&nbsp; &nbsp; &nbsp; &nbsp; "version" : 1,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; "members" : [</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "_id" : 0,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "host" : "192.168.175.67:5281"</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "_id" : 1,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "host" : "192.168.175.70:5281"</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "_id" : 2,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "host" : "192.168.175.70:5282",</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "arbiterOnly" : true</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</div><div>&nbsp; &nbsp; &nbsp; &nbsp; ]</div><div>}</div><div><br></div><div>blss:PRIMARY&gt; rs.remove("192.168.175.70:5282")</div><div>完成后会断开重连</div><div>Fri May 20 09:29:06 trying reconnect to 127.0.0.1:5281</div><div>Fri May 20 09:29:06 reconnect 127.0.0.1:5281 ok</div><div>因此需要重新认证</div><div>blss:PRIMARY&gt; db.auth("digoal","pwd")</div><div>blss:PRIMARY&gt; rs.conf() &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>{</div><div>&nbsp; &nbsp; &nbsp; &nbsp; "_id" : "blss",</div><div>&nbsp; &nbsp; &nbsp; &nbsp; "version" : 2,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; "members" : [</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "_id" : 0,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "host" : "192.168.175.67:5281"</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "_id" : 1,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "host" : "192.168.175.70:5281"</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</div><div>&nbsp; &nbsp; &nbsp; &nbsp; ]</div><div>}</div><div>等待192.168.175.71:5281 member节点起来后</div><div>blss:PRIMARY&gt; rs.add({"_id" : 2,"host" : "192.168.175.71:5281"})</div><div>完成后会断开重连</div><div>Fri May 20 09:31:44 trying reconnect to 127.0.0.1:5281</div><div>Fri May 20 09:31:44 reconnect 127.0.0.1:5281 ok</div><div>因此需要重新认证</div><div>blss:PRIMARY&gt; db.auth("digoal","pwd")</div><div>blss:PRIMARY&gt; rs.conf()</div><div>{</div><div>&nbsp; &nbsp; &nbsp; &nbsp; "_id" : "blss",</div><div>&nbsp; &nbsp; &nbsp; &nbsp; "version" : 3,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; "members" : [</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "_id" : 0,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "host" : "192.168.175.67:5281"</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "_id" : 1,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "host" : "192.168.175.70:5281"</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "_id" : 2,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "host" : "192.168.175.71:5281"</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</div><div>&nbsp; &nbsp; &nbsp; &nbsp; ]</div><div>}</div><div>blss:PRIMARY&gt; rs.status()</div><div>{</div><div>&nbsp; &nbsp; &nbsp; &nbsp; "set" : "blss",</div><div>&nbsp; &nbsp; &nbsp; &nbsp; "date" : ISODate("2011-05-20T01:32:56Z"),</div><div>&nbsp; &nbsp; &nbsp; &nbsp; "myState" : 1,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; "members" : [</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "_id" : 0,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "name" : "192.168.175.67:5281",</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "health" : 1,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "state" : 1,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "stateStr" : "PRIMARY",</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "optime" : {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "t" : 1305855176000,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "i" : 507</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "optimeDate" : ISODate("2011-05-20T01:32:56Z"),</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "self" : true</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "_id" : 1,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "name" : "192.168.175.70:5281",</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "health" : 1,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "state" : 2,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "stateStr" : "SECONDARY",</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "uptime" : 70,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "optime" : {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "t" : 1305855174000,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "i" : 817</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "optimeDate" : ISODate("2011-05-20T01:32:54Z"),</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "lastHeartbeat" : ISODate("2011-05-20T01:32:54Z")</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "_id" : 2,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "name" : "192.168.175.71:5281",</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "health" : 1,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "state" : 3,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "stateStr" : "RECOVERING",</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "uptime" : 66,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "optime" : {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "t" : 0,</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "i" : 0</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; },</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "optimeDate" : ISODate("1970-01-01T00:00:00Z"),</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "lastHeartbeat" : ISODate("2011-05-20T01:32:54Z")</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</div><div>&nbsp; &nbsp; &nbsp; &nbsp; ],</div><div>&nbsp; &nbsp; &nbsp; &nbsp; "ok" : 1</div><div>}</div><div>由于数据量较大,RECOVERING可能需要很长时间.</div><div>1.8.1支持从SECONDARY同步,因此对主节点压力不大.</div></div><wbr></div>
	</div>
</div>
</body>
</html>