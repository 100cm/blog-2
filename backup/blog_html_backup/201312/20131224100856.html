<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.4 Support ordered-set (WITHIN GROUP) aggregates.</h2>
	<h5 id="">2013-12-24 10:08:56&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013112410856221/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL Support ordered-set (WITHIN GROUP) aggregates 这个补丁已经提交了,&nbsp;</div><div><pre class="prettyprint"   ><p><span style="font-size: small; line-height: normal;"   >Support&nbsp;ordered-set&nbsp;(WITHIN&nbsp;GROUP)&nbsp;aggregates.</span><br style="font-size: small; line-height: normal;"   ><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >This&nbsp;patch&nbsp;introduces&nbsp;generic&nbsp;support&nbsp;for&nbsp;ordered-set&nbsp;and&nbsp;hypothetical-set</span><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >aggregate&nbsp;functions,&nbsp;as&nbsp;well&nbsp;as&nbsp;implementations&nbsp;of&nbsp;the&nbsp;instances&nbsp;defined&nbsp;in</span><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >SQL:2008&nbsp;(percentile_cont(),&nbsp;percentile_disc(),&nbsp;rank(),&nbsp;dense_rank(),</span><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >percent_rank(),&nbsp;cume_dist()).&nbsp;&nbsp;We&nbsp;also&nbsp;added&nbsp;mode()&nbsp;though&nbsp;it&nbsp;is&nbsp;not&nbsp;in&nbsp;the</span><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >spec,&nbsp;as&nbsp;well&nbsp;as&nbsp;versions&nbsp;of&nbsp;percentile_cont()&nbsp;and&nbsp;percentile_disc()&nbsp;that</span><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >can&nbsp;compute&nbsp;multiple&nbsp;percentile&nbsp;values&nbsp;in&nbsp;one&nbsp;pass&nbsp;over&nbsp;the&nbsp;data.</span><br style="font-size: small; line-height: normal;"   ><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >Unlike&nbsp;the&nbsp;original&nbsp;submission,&nbsp;this&nbsp;patch&nbsp;puts&nbsp;full&nbsp;control&nbsp;of&nbsp;the&nbsp;sorting</span><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >process&nbsp;in&nbsp;the&nbsp;hands&nbsp;of&nbsp;the&nbsp;aggregate's&nbsp;support&nbsp;functions.&nbsp;&nbsp;To&nbsp;allow&nbsp;the</span><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >support&nbsp;functions&nbsp;to&nbsp;find&nbsp;out&nbsp;how&nbsp;they're&nbsp;supposed&nbsp;to&nbsp;sort,&nbsp;a&nbsp;new&nbsp;API</span><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >function&nbsp;AggGetAggref()&nbsp;is&nbsp;added&nbsp;to&nbsp;nodeAgg.c.&nbsp;&nbsp;This&nbsp;allows&nbsp;retrieval&nbsp;of</span><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >the&nbsp;aggregate&nbsp;call's&nbsp;Aggref&nbsp;node,&nbsp;which&nbsp;may&nbsp;have&nbsp;other&nbsp;uses&nbsp;beyond&nbsp;the</span><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >immediate&nbsp;need.&nbsp;&nbsp;There&nbsp;is&nbsp;also&nbsp;support&nbsp;for&nbsp;ordered-set&nbsp;aggregates&nbsp;to</span><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >install&nbsp;cleanup&nbsp;callback&nbsp;functions,&nbsp;so&nbsp;that&nbsp;they&nbsp;can&nbsp;be&nbsp;sure&nbsp;that</span><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >infrastructure&nbsp;such&nbsp;as&nbsp;tuplesort&nbsp;objects&nbsp;gets&nbsp;cleaned&nbsp;up.</span><br style="font-size: small; line-height: normal;"   ><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >In&nbsp;passing,&nbsp;make&nbsp;some&nbsp;fixes&nbsp;in&nbsp;the&nbsp;recently-added&nbsp;support&nbsp;for&nbsp;variadic</span><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >aggregates,&nbsp;and&nbsp;make&nbsp;some&nbsp;editorial&nbsp;adjustments&nbsp;in&nbsp;the&nbsp;recent&nbsp;FILTER</span><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >additions&nbsp;for&nbsp;aggregates.&nbsp;&nbsp;Also,&nbsp;simplify&nbsp;use&nbsp;of&nbsp;IsBinaryCoercible()&nbsp;by</span><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >allowing&nbsp;it&nbsp;to&nbsp;succeed&nbsp;whenever&nbsp;the&nbsp;target&nbsp;type&nbsp;is&nbsp;ANY&nbsp;or&nbsp;ANYELEMENT.</span><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >It&nbsp;was&nbsp;inconsistent&nbsp;that&nbsp;it&nbsp;dealt&nbsp;with&nbsp;other&nbsp;polymorphic&nbsp;target&nbsp;types</span><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >but&nbsp;not&nbsp;these.</span><br style="font-size: small; line-height: normal;"   ><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >Atri&nbsp;Sharma&nbsp;and&nbsp;Andrew&nbsp;Gierth;&nbsp;reviewed&nbsp;by&nbsp;Pavel&nbsp;Stehule&nbsp;and&nbsp;Vik&nbsp;Fearing,</span><br style="font-size: small; line-height: normal;"   ><span style="font-size: small; line-height: normal;"   >and&nbsp;rather&nbsp;heavily&nbsp;editorialized&nbsp;upon&nbsp;by&nbsp;Tom&nbsp;Lane</span></p></pre></div><div>新增了一些函数, 聚合的语法, 以及聚合系统表的修改.</div><div><span style="line-height: 28px;"   >在补丁未提交状态时, 我做过一些测试. 见下文.</span></div><div><a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020137124851944/"   >http://blog.163.com/digoal@126/blog/static/16387704020137124851944/</a></div><div>提交后的测试可以参考pg源码中的regresstest</div><div><a target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=blobdiff;f=src/test/regress/expected/aggregates.out;h=58df85470a67c9025bb6afb9f1c87d0fa7a802b4;hp=1a0ca5c5f3c109b92e5fb936efa42dafe982c81a;hb=8d65da1f01c6a4c84fe9c59aeb6b7e3adf870145;hpb=37484ad2aacef5ec794f4dd3d5cf814475180a78"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=blobdiff;f=src/test/regress/expected/aggregates.out;h=58df85470a67c9025bb6afb9f1c87d0fa7a802b4;hp=1a0ca5c5f3c109b92e5fb936efa42dafe982c81a;hb=8d65da1f01c6a4c84fe9c59aeb6b7e3adf870145;hpb=37484ad2aacef5ec794f4dd3d5cf814475180a78</a></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020137124851944/"   >http://blog.163.com/digoal@126/blog/static/16387704020137124851944/</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=8d65da1f01c6a4c84fe9c59aeb6b7e3adf870145"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=8d65da1f01c6a4c84fe9c59aeb6b7e3adf870145</a></div></div>
	</div>
</div>
</body>
</html>