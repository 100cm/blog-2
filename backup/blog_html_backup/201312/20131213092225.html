<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL FOR 快递公司快件跟踪表设计思考</h2>
	<h5 id="">2013-12-13 9:22:25&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013111375950959/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">快递随着电商的崛起逐渐火爆, 特别是电商搞大促销的阶段, 快递更是达到爆仓的状态.<div>如果全国电商1天生成100亿比交易的话, 快递公司的IT是怎么完成这些无纸化操作的呢, 比如数据录入, 快件的状态跟踪, 用户通过网站查询快递等等.</div><div>我没在快递公司的IT部门干过, 也没和快递公司的DBA或者架构师交流过, 以下纯属个人扯淡.</div><div>最近买了点东西, 早上查了一下快递单, 甚至一天查好几次, 我估计大多数人和我一样, 没电脑的人也可能通过打电话去查询.</div><div>突发奇想, 快递的数据库怎么支撑用户的查询和快递公司内部业务系统的更新和查询呢?</div><div>我假象的快递数据库的特点.</div><div>1. 一堆的字典表, 比如快递公司的组织结构字典表. 这种查询多, 更新少.&nbsp;</div><div>要体现层次结构的话, 可以参考pg的异构数据查询举例</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201132843255911/"   >http://blog.163.com/digoal@126/blog/static/163877040201132843255911/</a></div><div>还有一个PG的插件类型, ltree, 也可以体现组织结构.</div><div><a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/ltree.html"   >http://www.postgresql.org/docs/9.3/static/ltree.html</a></div><div>2. 应该会有类似的GIS系统, 计算最优路径.</div><div>3. 快递单的属性表, 包括重量, 起点终点, 保价否, 寄件人属性, 收件人属性, 价格等.</div><div>4. 快件跟踪表应该是最大的, 可以按时间分区, 老的快件跟踪记录基本上不会被查询到了. 只用作留档.</div><div>快件跟踪表记录快递的实时状态, 并且这些状态要串起来.</div><div>例如我查询的一个快递状态如下</div><div><br><wbr><div><div style="margin: 0px auto; padding: 0px; border: 0px; font-size: 12px; color: rgb(191, 191, 191); font-family: 宋体; line-height: 12px; background-color: rgb(242, 242, 242); width: 200px; text-align: center;"   ><div style="margin: 0px auto; padding: 0px; border: 0px; font-size: 30px; color: rgb(99, 50, 129); line-height: 35px; font-family: 'Microsoft YaHei', 'Microsoft JhengHei'; font-weight: bold; float: left; width: 200px;"   >快 件 跟 踪</div><div style="margin: 0px; padding: 0px; border: 0px; clear: both;"   ></div><div style="margin: 0px auto; padding: 0px; border: 0px; font-size: 18px; width: 200px; color: rgb(51, 51, 51); line-height: 30px;"   ><span id="lBDate"   style="margin: 0px; padding: 0px; border: 0px;"   >2013/12/13 7:50:38</span></div></div><div style="margin: 0px; padding: 0px; border: 0px; font-size: 12px; font-family: 宋体; line-height: 12px; background-color: rgb(242, 242, 242);"   ></div><div style="margin: 0px; padding: 0px; border: 0px; font-size: 12px; font-family: 宋体; line-height: 12px; background-color: rgb(242, 242, 242);"   ><div style="margin: 0px; padding: 0px; border: 0px; font-size: 14px; font-family: 微软雅黑;"   ><p style="margin-top: 0px; margin-left: 15px; border: 0px; color: rgb(103, 103, 103);"   >快件状态 &gt;&gt;</p><div style="margin: 0px; padding: 0px; border: 0px;"   ><table width="100%"   border="0"   cellpadding="0"   cellspacing="0"   style="margin: 0px; padding: 0px; border: 0px; font-size: 14px;"   ><tbody style="margin: 0px; padding: 0px; border: 0px;"   ><tr style="margin: 0px; padding: 0px; border: 0px; height: 33px; color: rgb(255, 255, 255); line-height: 30px; background-color: rgb(90, 43, 118);"   ><th style="margin: 0px; padding: 0px; border: 0px;"   ><strong style="margin: 0px; padding: 0px; border: 0px;"   >快递单号</strong></th><th style="margin: 0px; padding: 0px; border: 0px;"   ><strong style="margin: 0px; padding: 0px; border: 0px;"   >日期时间</strong></th><th style="margin: 0px; padding: 0px; border: 0px;"   ><strong style="margin: 0px; padding: 0px; border: 0px;"   >快件状态</strong></th></tr><tr height="28"   align="center"   style="margin: 0px; padding: 0px; border: 0px;"   ><td align="center"   width="20%"   style="margin: 0px; padding: 0px; border: 0px; font-size: 12px;"   ><span style="margin: 0px; padding: 0px; border-width: 0px 0px 1px; border-bottom-style: solid; border-bottom-color: rgb(225, 225, 225); width: 240px; height: 30px; display: block; float: left; line-height: 30px;"   >3393108415</span></td><td align="center"   width="20%"   style="margin: 0px; padding: 0px; border: 0px; font-size: 12px;"   ><span style="margin: 0px; padding: 0px; border-width: 0px 0px 1px; border-bottom-style: solid; border-bottom-color: rgb(225, 225, 225); width: 240px; height: 30px; display: block; float: left; line-height: 30px;"   >2013-12-12 17:37:27</span></td><td align="left"   width="60%"   style="margin: 0px; padding: 0px; border: 0px; font-size: 12px;"   ><span style="margin: 0px; padding: 0px; border-width: 0px 0px 1px; border-bottom-style: solid; border-bottom-color: rgb(225, 225, 225); width: 480px; height: 30px; display: block; float: left; line-height: 30px;"   >安徽省合肥市蜀山区包河三部公司 已收件</span></td></tr><tr height="28"   align="center"   style="margin: 0px; padding: 0px; border: 0px;"   ><td align="center"   width="20%"   style="margin: 0px; padding: 0px; border: 0px; font-size: 12px;"   ><span style="margin: 0px; padding: 0px; border-width: 0px 0px 1px; border-bottom-style: solid; border-bottom-color: rgb(225, 225, 225); width: 240px; height: 30px; display: block; float: left; line-height: 30px;"   >3393108415</span></td><td align="center"   width="20%"   style="margin: 0px; padding: 0px; border: 0px; font-size: 12px;"   ><span style="margin: 0px; padding: 0px; border-width: 0px 0px 1px; border-bottom-style: solid; border-bottom-color: rgb(225, 225, 225); width: 240px; height: 30px; display: block; float: left; line-height: 30px;"   >2013-12-12 19:30:59</span></td><td align="left"   width="60%"   style="margin: 0px; padding: 0px; border: 0px; font-size: 12px;"   ><span style="margin: 0px; padding: 0px; border-width: 0px 0px 1px; border-bottom-style: solid; border-bottom-color: rgb(225, 225, 225); width: 480px; height: 30px; display: block; float: left; line-height: 30px;"   ><span id="551026"   style="margin: 0px; padding: 0px; border: 0px; color: rgb(215, 4, 2); font-weight: bold; cursor: pointer;"   >安徽省合肥市蜀山区包河三部公司</span>&nbsp;已发出</span></td></tr><tr height="28"   align="center"   style="margin: 0px; padding: 0px; border: 0px;"   ><td align="center"   width="20%"   style="margin: 0px; padding: 0px; border: 0px; font-size: 12px;"   ><span style="margin: 0px; padding: 0px; border-width: 0px 0px 1px; border-bottom-style: solid; border-bottom-color: rgb(225, 225, 225); width: 240px; height: 30px; display: block; float: left; line-height: 30px;"   >3393108415</span></td><td align="center"   width="20%"   style="margin: 0px; padding: 0px; border: 0px; font-size: 12px;"   ><span style="margin: 0px; padding: 0px; border-width: 0px 0px 1px; border-bottom-style: solid; border-bottom-color: rgb(225, 225, 225); width: 240px; height: 30px; display: block; float: left; line-height: 30px;"   >2013-12-12 20:09:50</span></td><td align="left"   width="60%"   style="margin: 0px; padding: 0px; border: 0px; font-size: 12px;"   ><span style="margin: 0px; padding: 0px; border-width: 0px 0px 1px; border-bottom-style: solid; border-bottom-color: rgb(225, 225, 225); width: 480px; height: 30px; display: block; float: left; line-height: 30px;"   >安徽省合肥市公司 已收入</span></td></tr><tr height="28"   align="center"   style="margin: 0px; padding: 0px; border: 0px;"   ><td align="center"   width="20%"   style="margin: 0px; padding: 0px; border: 0px; font-size: 12px;"   ><span style="margin: 0px; padding: 0px; border-width: 0px 0px 1px; border-bottom-style: solid; border-bottom-color: rgb(225, 225, 225); width: 240px; height: 30px; display: block; float: left; line-height: 30px;"   >3393108415</span></td><td align="center"   width="20%"   style="margin: 0px; padding: 0px; border: 0px; font-size: 12px;"   ><span style="margin: 0px; padding: 0px; border-width: 0px 0px 1px; border-bottom-style: solid; border-bottom-color: rgb(225, 225, 225); width: 240px; height: 30px; display: block; float: left; line-height: 30px;"   >2013-12-12 21:47:46</span></td><td align="left"   width="60%"   style="margin: 0px; padding: 0px; border: 0px; font-size: 12px;"   ><span style="margin: 0px; padding: 0px; border-width: 0px 0px 1px; border-bottom-style: solid; border-bottom-color: rgb(225, 225, 225); width: 480px; height: 30px; display: block; float: left; line-height: 30px;"   >安徽省合肥市公司 已打包</span></td></tr><tr height="28"   align="center"   style="margin: 0px; padding: 0px; border: 0px;"   ><td align="center"   width="20%"   style="margin: 0px; padding: 0px; border: 0px; font-size: 12px;"   ><span style="margin: 0px; padding: 0px; border-width: 0px 0px 1px; border-bottom-style: solid; border-bottom-color: rgb(225, 225, 225); width: 240px; height: 30px; display: block; float: left; line-height: 30px;"   >3393108415</span></td><td align="center"   width="20%"   style="margin: 0px; padding: 0px; border: 0px; font-size: 12px;"   ><span style="margin: 0px; padding: 0px; border-width: 0px 0px 1px; border-bottom-style: solid; border-bottom-color: rgb(225, 225, 225); width: 240px; height: 30px; display: block; float: left; line-height: 30px;"   >2013-12-12 22:01:08</span></td><td align="left"   width="60%"   style="margin: 0px; padding: 0px; border: 0px; font-size: 12px;"   ><span style="margin: 0px; padding: 0px; border-width: 0px 0px 1px; border-bottom-style: solid; border-bottom-color: rgb(225, 225, 225); width: 480px; height: 30px; display: block; float: left; line-height: 30px;"   >合肥转运中心公司 已收入</span></td></tr><tr height="28"   align="center"   style="margin: 0px; padding: 0px; border: 0px;"   ><td align="center"   width="20%"   style="margin: 0px; padding: 0px; border: 0px; font-size: 12px;"   ><span style="margin: 0px; padding: 0px; border-width: 0px 0px 1px; border-bottom-style: solid; border-bottom-color: rgb(225, 225, 225); width: 240px; height: 30px; display: block; float: left; line-height: 30px;"   >3393108415</span></td><td align="center"   width="20%"   style="margin: 0px; padding: 0px; border: 0px; font-size: 12px;"   ><span style="margin: 0px; padding: 0px; border-width: 0px 0px 1px; border-bottom-style: solid; border-bottom-color: rgb(225, 225, 225); width: 240px; height: 30px; display: block; float: left; line-height: 30px;"   >2013-12-12 22:05:09</span></td><td align="left"   width="60%"   style="margin: 0px; padding: 0px; border: 0px; font-size: 12px;"   ><span style="margin: 0px; padding: 0px; border-width: 0px 0px 1px; border-bottom-style: solid; border-bottom-color: rgb(225, 225, 225); width: 480px; height: 30px; display: block; float: left; line-height: 30px;"   >合肥转运中心公司 已发出</span></td></tr><tr height="28"   align="center"   style="margin: 0px; padding: 0px; border: 0px;"   ><td align="center"   width="20%"   style="margin: 0px; padding: 0px; border: 0px; font-size: 12px;"   ><span style="margin: 0px; padding: 0px; border-width: 0px 0px 1px; border-bottom-style: solid; border-bottom-color: rgb(225, 225, 225); width: 240px; height: 30px; display: block; float: left; line-height: 30px;"   >3393108415</span></td><td align="center"   width="20%"   style="margin: 0px; padding: 0px; border: 0px; font-size: 12px;"   ><span style="margin: 0px; padding: 0px; border-width: 0px 0px 1px; border-bottom-style: solid; border-bottom-color: rgb(225, 225, 225); width: 240px; height: 30px; display: block; float: left; line-height: 30px;"   >2013-12-13 05:11:55</span></td><td align="left"   width="60%"   style="margin: 0px; padding: 0px; border: 0px; font-size: 12px;"   ><span style="margin: 0px; padding: 0px; border-width: 0px 0px 1px; border-bottom-style: solid; border-bottom-color: rgb(225, 225, 225); width: 480px; height: 30px; display: block; float: left; line-height: 30px;"   >杭州转运中心公司 已收入</span></td></tr><tr height="28"   align="center"   style="margin: 0px; padding: 0px; border: 0px;"   ><td align="center"   width="20%"   style="margin: 0px; padding: 0px; border: 0px; font-size: 12px;"   ><span style="margin: 0px; padding: 0px; border-width: 0px 0px 1px; border-bottom-style: solid; border-bottom-color: rgb(225, 225, 225); width: 240px; height: 30px; display: block; float: left; line-height: 30px;"   >3393108415</span></td><td align="center"   width="20%"   style="margin: 0px; padding: 0px; border: 0px; font-size: 12px;"   ><span style="margin: 0px; padding: 0px; border-width: 0px 0px 1px; border-bottom-style: solid; border-bottom-color: rgb(225, 225, 225); width: 240px; height: 30px; display: block; float: left; line-height: 30px;"   >2013-12-13 05:43:59</span></td><td align="left"   width="60%"   style="margin: 0px; padding: 0px; border: 0px; font-size: 12px;"   ><span style="margin: 0px; padding: 0px; border-width: 0px 0px 1px; border-bottom-style: solid; border-bottom-color: rgb(225, 225, 225); width: 480px; height: 30px; display: block; float: left; line-height: 30px;"   >杭州转运中心公司 已发出</span></td></tr></table></div></div></div></div><div><br></div><div>有些快递公司提供一次查询多个快递单号.</div><div>快递的状态表的特点, 我假象它是更新少, 查询多的一个特点.</div><div>并且更新不应该出现冲突, 即多个线程同时更新同一条记录.&nbsp;</div><div>那么查询多, 更新少的话, 我的建议是在跟踪表中, 一个快递单子一条记录.&nbsp;</div><div>这样做的好处是, 查询时很快, 只需要扫描2个块左右 , 1个索引块, 1个HEAP块.</div><div>但是如果一个快递单子多条记录, 即每个状态插入一条, 这样的带来的是大量的数据块的扫描, 基本上每条记录都会分布在不同的数据块上. 假设平均一个快递单的跟踪记录是15条, 数据块的扫描要多14个.</div><div>那么1条记录怎么存储呢?</div><div>快递单+复合类型数组(节点时间+节点ID+状态)+rec插入时间+rec更新时间</div><div>当然, 这里不用数组也行, 只要程序能根据存储的信息分隔每个节点状态即可, 这样做的好处是结构更加松散, 适合非结构话数据, 比方说在快递结束的地方会出现派件人, 派件人的电话等, 结构和前面不一样.</div><div>对应我这个例子是:&nbsp;</div><div>3393108415, [(2013-12-12 17:37:27,安徽合肥市蜀山区包河三部公司字典表里的ID,收件状态ID), (下一个状态的复合类型...), ()], 记录插入时间, 记录的更新时间</div><div>新的状态录入时, 用array_append往数组后面追加数据即可.</div><div><br></div><div>我们举一个实际的例子(本例省去字典表, 只为体现单行和多行的查询性能) :&nbsp;</div><div>为了使生成速度快点, 我们使用NOLOGGING表, 同时关闭 autovacuum.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create unlogged table kuaidi_log1(id int8, crt_time timestamp, nodeid text, stat text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# create unlogged table kuaidi_log2(id int8, comp text);</font></div><div><font size="2"   >CREATE TABLE</font></div><p></p></pre></div><div>假设每天有500W个订单, 平均每个订单20条数据的话, 需要1亿条测试数据.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; vi test.sql</font></div><div><font size="2"   >\setrandom id 1 5000000</font></div><div><font size="2"   >insert into kuaidi_log1 values (:id, now(), '浙江省圆通快递杭州分公司', '已收件');</font></div><p></p></pre></div><div>开启16个连接使用pgbench进行插入.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg93@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 16 -j 4 -t 6250000</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >number of transactions per client: 6250000</font></div><div><font size="2"   >number of transactions actually processed: 100000000/100000000</font></div><div><font size="2"   >tps = 79215.655001 (including connections establishing)</font></div><div><font size="2"   >tps = 79216.552965 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.001938 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 5000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.194045 &nbsp; &nbsp; &nbsp; &nbsp;insert into kuaidi_log1 values (:id, now(), '浙江省圆通快递杭州分公司', '已收件');</font></div></div><div><font size="2"   >刚好1亿记录.</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >插入完后创建快递单的索引.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create index idx_kuaidi_log1_1 on kuaidi_log1 (id);</font></div><div></div><p></p></pre></div><div>kuaidi_log1表和索引的大小</div><div><pre class="prettyprint"   style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >digoal=# \dt+ kuaidi_log1</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of relations</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp; Schema &nbsp;| &nbsp; &nbsp;Name &nbsp; &nbsp; | Type &nbsp;| &nbsp;Owner &nbsp; | &nbsp;Size &nbsp; | Description&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >----------+-------------+-------+----------+---------+-------------</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp;postgres | kuaidi_log1 | table | postgres | 8880 MB |&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >(1 row)</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   ><br style="line-height: 21px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >digoal=# \di+ idx_kuaidi_log1_1&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of relations</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp; Schema &nbsp;| &nbsp; &nbsp; &nbsp; Name &nbsp; &nbsp; &nbsp; &nbsp;| Type &nbsp;| &nbsp;Owner &nbsp; | &nbsp; &nbsp;Table &nbsp; &nbsp;| &nbsp;Size &nbsp; | Description&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >----------+-------------------+-------+----------+-------------+---------+-------------</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >&nbsp;postgres | idx_kuaidi_log1_1 | index | postgres | kuaidi_log1 | 2142 MB |&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   >(1 row)</font></div></pre></div><div>把这些记录合并到kuaidi_log2表, 每个快递单1条.</div><pre class="prettyprint"   ><p></p><div><font size="2"   >insert into kuaidi_log2 select id, string_agg(crt_time::text||','||nodeid||','||stat, ';' order by crt_time) from kuaidi_log1 group by id;</font></div><div><font size="2"   >INSERT 0 5000000</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >创建</span><span style="line-height: 28px;"   >kuaidi_log2表的</span><span style="line-height: 28px;"   >快递单号索引.</span></div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create index idx_kuaidi_log2_1 on kuaidi_log2 (id);</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >kuaidi_log2表和索引大小, 索引变小了20倍, 因为只有500万条记录.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 21px;"   >digoal=# \dt+ kuaidi_log2<br>                         List of relations<br>  Schema  |    Name     | Type  |  Owner   |  Size   | Description <br>----------+-------------+-------+----------+---------+-------------<br> postgres | kuaidi_log2 | table | postgres | 7172 MB | <br>(1 row)</span></font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><span style="line-height: 21px;"   >digoal=# \di+ idx_kuaidi_log2_1 <br>                                  List of relations<br>  Schema  |       Name        | Type  |  Owner   |    Table    |  Size  | Description <br>----------+-------------------+-------+----------+-------------+--------+-------------<br> postgres | idx_kuaidi_log2_1 | index | postgres | kuaidi_log2 | 107 MB | <br>(1 row)</span></font></div><p></p></pre></div><div><span style="line-height: 28px;"   >数据对比 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from kuaidi_log1 where id=1;</font></div><div><font size="2"   >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nodeid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;stat &nbsp;</font></div><div><font size="2"   >----+----------------------------+--------------------------+--------</font></div><div><font size="2"   >&nbsp; 1 | 2013-12-13 08:40:21.116411 | 浙江省圆通快递杭州分公司 | 已收件</font></div><div><font size="2"   >&nbsp; 1 | 2013-12-13 08:41:22.298613 | 浙江省圆通快递杭州分公司 | 已收件</font></div><div><font size="2"   >&nbsp; 1 | 2013-12-13 08:42:38.141089 | 浙江省圆通快递杭州分公司 | 已收件</font></div><div><font size="2"   >&nbsp; 1 | 2013-12-13 08:43:10.396533 | 浙江省圆通快递杭州分公司 | 已收件</font></div><div><font size="2"   >&nbsp; 1 | 2013-12-13 08:43:14.961726 | 浙江省圆通快递杭州分公司 | 已收件</font></div><div><font size="2"   >&nbsp; 1 | 2013-12-13 08:44:22.036227 | 浙江省圆通快递杭州分公司 | 已收件</font></div><div><font size="2"   >&nbsp; 1 | 2013-12-13 08:46:24.767686 | 浙江省圆通快递杭州分公司 | 已收件</font></div><div><font size="2"   >&nbsp; 1 | 2013-12-13 08:46:41.418713 | 浙江省圆通快递杭州分公司 | 已收件</font></div><div><font size="2"   >&nbsp; 1 | 2013-12-13 08:46:48.03819 &nbsp;| 浙江省圆通快递杭州分公司 | 已收件</font></div><div><font size="2"   >&nbsp; 1 | 2013-12-13 08:47:32.8119 &nbsp; | 浙江省圆通快递杭州分公司 | 已收件</font></div><div><font size="2"   >&nbsp; 1 | 2013-12-13 08:47:48.996097 | 浙江省圆通快递杭州分公司 | 已收件</font></div><div><font size="2"   >&nbsp; 1 | 2013-12-13 08:50:54.001399 | 浙江省圆通快递杭州分公司 | 已收件</font></div><div><font size="2"   >&nbsp; 1 | 2013-12-13 08:52:00.678307 | 浙江省圆通快递杭州分公司 | 已收件</font></div><div><font size="2"   >&nbsp; 1 | 2013-12-13 08:52:14.56005 &nbsp;| 浙江省圆通快递杭州分公司 | 已收件</font></div><div><font size="2"   >&nbsp; 1 | 2013-12-13 08:56:45.806082 | 浙江省圆通快递杭州分公司 | 已收件</font></div><div><font size="2"   >(15 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select * from kuaidi_log2 where id=1;</font></div><div><font size="2"   >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; comp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+-------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >-----------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp; 1 | 2013-12-13 08:40:21.116411,浙江省圆通快递杭州分公司,已收件;2013-12-13 08:41:22.298613,浙江省圆通快递杭州分公司,已收件;2013-12-</font></div><div><font size="2"   >13 08:42:38.141089,浙江省圆通快递杭州分公司,已收件;2013-12-13 08:43:10.396533,浙江省圆通快递杭州分公司,已收件;2013-12-13 08:43:14.96</font></div><div><font size="2"   >1726,浙江省圆通快递杭州分公司,已收件;2013-12-13 08:44:22.036227,浙江省圆通快递杭州分公司,已收件;2013-12-13 08:46:24.767686,浙江省圆</font></div><div><font size="2"   >快递杭州分公司,已收件;2013-12-13 08:46:41.418713,浙江省圆通快递杭州分公司,已收件;2013-12-13 08:46:48.03819,浙江省圆通快递杭州分公司,</font></div><div><font size="2"   >已收件;2013-12-13 08:47:32.8119,浙江省圆通快递杭州分公司,已收件;2013-12-13 08:47:48.996097,浙江省圆通快递杭州分公司,已收件;2013-12-1</font></div><div><font size="2"   >3 08:50:54.001399,浙江省圆通快递杭州分公司,已收件;2013-12-13 08:52:00.678307,浙江省圆通快递杭州分公司,已收件;2013-12-13 08:52:14.560</font></div><div><font size="2"   >05,浙江省圆通快递杭州分公司,已收件;2013-12-13 08:56:45.806082,浙江省圆通快递杭州分公司,已收件</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >测试</span><span style="line-height: 28px;"   >kuaidi_log1的查询性能</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >vi test.sql</font></span></div><div><div style="line-height: 28px;"   ><font size="2"   >\setrandom id 1 5000000</font></div><div style="line-height: 28px;"   ><font size="2"   >select * from&nbsp;<span style="line-height: 28px;"   >kuaidi_log1 where id=:id order by crt_time;</span></font></div></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >pgbench -M prepared -n -r -f ./test.sql -c 16 -j 4 -T 30</font></span></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 16 -j 4 -T 30<br>transaction type: Custom query<br>scaling factor: 1<br>query mode: prepared<br>number of clients: 16<br>number of threads: 4<br>duration: 30 s<br>number of transactions actually processed: 349163<br>tps = 11635.992258 (including connections establishing)<br>tps = 11641.693582 (excluding connections establishing)<br>statement latencies in milliseconds:<br>        0.003351        \setrandom id 1 5000000<br>        1.368531        select * from kuaidi_log1 where id=:id order by crt_time;</font></div><p></p></pre></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >测试</span><span style="line-height: 28px;"   >kuaidi_log2的查询性能, 流水已按时间排序, 所以不需要再次排序.</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >vi test.sql</font></span></div><div><div style="line-height: 28px;"   ><font size="2"   >\setrandom id 1 5000000</font></div><div style="line-height: 28px;"   ><font size="2"   >select * from&nbsp;<span style="line-height: 28px;"   >kuaidi_log2</span><span style="line-height: 28px;"   >&nbsp;</span><span style="line-height: 28px;"   >where id=:id</span><span style="line-height: 28px;"   >;</span></font></div></div><div><span style="line-height: 28px;"   ><font size="2"   >pgbench -M prepared -n -r -f ./test.sql -c 16 -j 4 -T 30</font></span></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; pgbench -M prepared -n -r -f ./test.sql -c 16 -j 4 -T 30<br>transaction type: Custom query<br>scaling factor: 1<br>query mode: prepared<br>number of clients: 16<br>number of threads: 4<br>duration: 30 s<br>number of transactions actually processed: 1880690<br>tps = 62681.334228 (including connections establishing)<br>tps = 62711.904831 (excluding connections establishing)<br>statement latencies in milliseconds:<br>        0.002509        \setrandom id 1 5000000<br>        0.251047        select * from kuaidi_log2 where id=:id;</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >查询性能相差5倍.</span></div><div><span style="line-height: 28px;"   >这种设计方式适合写少读多的场景, 并且写的场景不会产生锁冲突. 否则不要使用这种设计.</span></div></div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">ray - 2013-12-13 10:26:08</h5>
				<div>德哥。你文章中说“
<span style=""  >那么查询多, 更新少的话, 我的建议是在跟踪表中, 一个快递单子一条记录.&nbsp;</span>&nbsp;”<div>那么，我就设想，如果使用PostgreSQL的hstore数据类型来存储快递表，效率会不会更高呢？这样的话，一个单子为一行数据，状态用hstore</div><div><br><br></div></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 ray - 2013-12-13 10:26:08</h5>
				<div style="width:600px;">恩HSTORE也可以, 都可以解决合并行的问题.</div>
			</div>
	</div>
</div>
</body>
</html>