<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL Logical Backup's TOC File</h2>
	<h5 id="">2012-04-12 9:58:18&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020123129649342/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>一位网友问到的几个逻辑备份和还原的问题, 本文对这几个问题进行简单的讲解和测试。</div><div>1. &nbsp;调整逻辑备份的还原顺序.</div><div>2. &nbsp;逻辑备份的TOC文件的格式是什么意思.</div><div>3. &nbsp;是否可以通过修改TOC文件中schema的内容达到把表导入不同schema的目的?</div><div>&nbsp; &nbsp; &nbsp; 这个想法可能来自oracle imp的fromuser , touser参数.</div><div>下面来测试一下 :&nbsp;</div><div>1. &nbsp;调整逻辑备份的还原顺序</div><div>pg_restore 的man中有示例</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;To reorder database items, it is first necessary to dump the table of contents of the archive:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;$ pg_restore -l db.dump &gt; db.list</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;The listing file consists of a header and one line for each item, e.g.:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; Archive created at Mon Sep 14 13:55:39 2009</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; &nbsp; &nbsp; dbname: DBDEMOS</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; &nbsp; &nbsp; TOC Entries: 81</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; &nbsp; &nbsp; Compression: 9</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; &nbsp; &nbsp; Dump Version: 1.10-0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; &nbsp; &nbsp; Format: CUSTOM</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; &nbsp; &nbsp; Integer: 4 bytes</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; &nbsp; &nbsp; Offset: 8 bytes</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; &nbsp; &nbsp; Dumped from database version: 8.3.5</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; &nbsp; &nbsp; Dumped by pg_dump version: 8.3.8</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;; Selected TOC Entries:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3; 2615 2200 SCHEMA - public pasha</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1861; 0 0 COMMENT - SCHEMA public pasha</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1862; 0 0 ACL - public pasha</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;317; 1247 17715 TYPE public composite pasha</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;319; 1247 25899 DOMAIN public domain0 pasha</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;Semicolons start a comment, and the numbers at the start of lines refer to the internal archive ID assigned to</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;each item.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;Lines in the file can be commented out, deleted, and reordered. For example:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;10; 145433 TABLE map_resolutions postgres</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;2; 145344 TABLE species postgres</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;4; 145359 TABLE nt_header postgres</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;6; 145402 TABLE species_records postgres</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;8; 145416 TABLE ss_old postgres</font></div></div><div><div><font size="2"   >&nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;could be used as input to pg_restore and would only restore items 10 and 6, in that order:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;$ pg_restore -L db.list db.dump</font></div></div><p></p></pre></div><div>首先dmp一个库出来</div><div><pre class="prettyprint"   ><p><font size="2"   >pg_dump -f ./digoal.dmp -F c -C -h 127.0.0.1 -U postgres digoal</font></p></pre></div><div>然后创建TOC文件</div><div><pre class="prettyprint"   ><p><font size="2"   >pg_restore -f ./digoal.list -F c -l ./digoal.dmp</font></p></pre></div><div>TOC文件内容如下</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >;</font></div><div><font size="2"   >; Archive created at Thu Apr 12 09:32:27 2012</font></div><div><font size="2"   >; &nbsp; &nbsp; dbname: digoal</font></div><div><font size="2"   >; &nbsp; &nbsp; TOC Entries: 126</font></div><div><font size="2"   >; &nbsp; &nbsp; Compression: -1</font></div><div><font size="2"   >; &nbsp; &nbsp; Dump Version: 1.12-0</font></div><div><font size="2"   >; &nbsp; &nbsp; Format: CUSTOM</font></div><div><font size="2"   >; &nbsp; &nbsp; Integer: 4 bytes</font></div><div><font size="2"   >; &nbsp; &nbsp; Offset: 8 bytes</font></div><div><font size="2"   >; &nbsp; &nbsp; Dumped from database version: 9.1.3</font></div><div><font size="2"   >; &nbsp; &nbsp; Dumped by pg_dump version: 9.1.3</font></div><div><font size="2"   >;</font></div><div><font size="2"   >;</font></div><div><font size="2"   >; Selected TOC Entries:</font></div><div><font size="2"   >;</font></div><div><font size="2"   >2878; 1262 16386 DATABASE - digoal postgres</font></div><div><font size="2"   >7; 2615 25070 SCHEMA - digoal digoal</font></div><div><font size="2"   >5; 2615 2200 SCHEMA - public postgres</font></div><div><font size="2"   >2879; 0 0 COMMENT - SCHEMA public postgres</font></div><div><font size="2"   >2880; 0 0 ACL - public postgres</font></div><div><font size="2"   >191; 3079 12425 EXTENSION - plpgsql&nbsp;</font></div><div><font size="2"   >2881; 0 0 COMMENT - EXTENSION plpgsql&nbsp;</font></div><div><font size="2"   >192; 3079 16442 EXTENSION - pgfincore&nbsp;</font></div><div><font size="2"   >2882; 0 0 COMMENT - EXTENSION pgfincore&nbsp;</font></div><div><font size="2"   >606; 1247 25073 TYPE digoal breakpoint digoal</font></div><div><font size="2"   >609; 1247 25076 TYPE digoal frame digoal</font></div><div><font size="2"   >612; 1247 25079 TYPE digoal proxyinfo digoal</font></div><div><font size="2"   >615; 1247 25082 TYPE digoal targetinfo digoal</font></div><div><font size="2"   >618; 1247 25085 TYPE digoal var digoal</font></div><div><font size="2"   >589; 1247 24696 TYPE public breakpoint postgres</font></div><div><font size="2"   >592; 1247 24699 TYPE public frame postgres</font></div><div><font size="2"   >601; 1247 24708 TYPE public proxyinfo postgres</font></div><div><font size="2"   >595; 1247 24702 TYPE public targetinfo postgres</font></div><div><font size="2"   >598; 1247 24705 TYPE public var postgres</font></div><div><font size="2"   >245; 1255 25086 FUNCTION digoal debugger_test(integer) digoal</font></div><div><font size="2"   >255; 1255 25276 FUNCTION digoal dy(text, text) digoal</font></div><div><font size="2"   >254; 1255 25277 FUNCTION digoal dy(text, text, integer) digoal</font></div><div><font size="2"   >246; 1255 25087 FUNCTION digoal exchange_rows(integer, integer) digoal</font></div><div><font size="2"   >247; 1255 25088 FUNCTION digoal exchange_rows(integer, numeric, integer, numeric) digoal</font></div><div><font size="2"   >248; 1255 25089 FUNCTION digoal exchange_rows(text, numeric, integer, numeric) digoal</font></div><div><font size="2"   >249; 1255 25090 FUNCTION digoal f_user_login(integer) digoal</font></div><div><font size="2"   >250; 1255 25091 FUNCTION digoal f_user_login_0(integer) digoal</font></div><div><font size="2"   >251; 1255 25092 FUNCTION digoal f_user_login_1(integer) digoal</font></div><div><font size="2"   >252; 1255 25093 FUNCTION digoal f_user_login_2(integer) digoal</font></div><div><font size="2"   >253; 1255 25094 FUNCTION digoal f_user_login_3(integer) digoal</font></div><div><font size="2"   >256; 1255 25095 FUNCTION digoal f_user_login_4(integer) digoal</font></div><div><font size="2"   >257; 1255 25096 FUNCTION digoal f_user_login_insupd_0(integer) digoal</font></div><div><font size="2"   >258; 1255 25097 FUNCTION digoal f_user_login_insupd_1(integer) digoal</font></div><div><font size="2"   >259; 1255 25098 FUNCTION digoal f_user_login_insupd_2(integer) digoal</font></div><div><font size="2"   >260; 1255 25099 FUNCTION digoal f_user_login_insupd_3(integer) digoal</font></div><div><font size="2"   >261; 1255 25100 FUNCTION digoal f_user_login_insupd_4(integer) digoal</font></div><div><font size="2"   >262; 1255 25101 FUNCTION digoal f_user_login_sel_0(integer) digoal</font></div><div><font size="2"   >263; 1255 25102 FUNCTION digoal f_user_login_sel_1(integer) digoal</font></div><div><font size="2"   >264; 1255 25103 FUNCTION digoal f_user_login_sel_2(integer) digoal</font></div><div><font size="2"   >265; 1255 25104 FUNCTION digoal f_user_login_sel_3(integer) digoal</font></div><div><font size="2"   >266; 1255 25105 FUNCTION digoal f_user_login_sel_4(integer) digoal</font></div><div><font size="2"   >267; 1255 25106 FUNCTION digoal f_user_login_upd_0(integer) digoal</font></div><div><font size="2"   >268; 1255 25107 FUNCTION digoal f_user_login_upd_1(integer) digoal</font></div><div><font size="2"   >269; 1255 25108 FUNCTION digoal f_user_login_upd_2(integer) digoal</font></div><div><font size="2"   >270; 1255 25109 FUNCTION digoal f_user_login_upd_3(integer) digoal</font></div><div><font size="2"   >217; 1255 25110 FUNCTION digoal f_user_login_upd_4(integer) digoal</font></div><div><font size="2"   >238; 1255 25111 FUNCTION digoal f_user_logout(integer) digoal</font></div><div><font size="2"   >239; 1255 25112 FUNCTION digoal f_user_logout_0(integer) digoal</font></div><div><font size="2"   >240; 1255 25113 FUNCTION digoal f_user_logout_1(integer) digoal</font></div><div><font size="2"   >241; 1255 25114 FUNCTION digoal f_user_logout_2(integer) digoal</font></div><div><font size="2"   >242; 1255 25115 FUNCTION digoal f_user_logout_3(integer) digoal</font></div><div><font size="2"   >243; 1255 25116 FUNCTION digoal f_user_logout_4(integer) digoal</font></div><div><font size="2"   >244; 1255 25117 FUNCTION digoal test_update() digoal</font></div><div><font size="2"   >222; 1255 24710 FUNCTION public pldbg_abort_target(integer) postgres</font></div><div><font size="2"   >223; 1255 24711 FUNCTION public pldbg_attach_to_port(integer) postgres</font></div><div><font size="2"   >224; 1255 24712 FUNCTION public pldbg_continue(integer) postgres</font></div><div><font size="2"   >225; 1255 24713 FUNCTION public pldbg_create_listener() postgres</font></div><div><font size="2"   >226; 1255 24714 FUNCTION public pldbg_deposit_value(integer, text, integer, text) postgres</font></div><div><font size="2"   >227; 1255 24715 FUNCTION public pldbg_drop_breakpoint(integer, oid, integer) postgres</font></div><div><font size="2"   >218; 1255 24716 FUNCTION public pldbg_get_breakpoints(integer) postgres</font></div><div><font size="2"   >228; 1255 24719 FUNCTION public pldbg_get_proxy_info() postgres</font></div><div><font size="2"   >219; 1255 24717 FUNCTION public pldbg_get_source(integer, oid) postgres</font></div><div><font size="2"   >220; 1255 24718 FUNCTION public pldbg_get_stack(integer) postgres</font></div><div><font size="2"   >237; 1255 24728 FUNCTION public pldbg_get_target_info(text, "char") postgres</font></div><div><font size="2"   >229; 1255 24720 FUNCTION public pldbg_get_variables(integer) postgres</font></div><div><font size="2"   >230; 1255 24721 FUNCTION public pldbg_select_frame(integer, integer) postgres</font></div><div><font size="2"   >231; 1255 24722 FUNCTION public pldbg_set_breakpoint(integer, oid, integer) postgres</font></div><div><font size="2"   >232; 1255 24723 FUNCTION public pldbg_set_global_breakpoint(integer, oid, integer, integer) postgres</font></div><div><font size="2"   >233; 1255 24724 FUNCTION public pldbg_step_into(integer) postgres</font></div><div><font size="2"   >234; 1255 24725 FUNCTION public pldbg_step_over(integer) postgres</font></div><div><font size="2"   >235; 1255 24726 FUNCTION public pldbg_wait_for_breakpoint(integer) postgres</font></div><div><font size="2"   >236; 1255 24727 FUNCTION public pldbg_wait_for_target(integer) postgres</font></div><div><font size="2"   >221; 1255 24709 FUNCTION public plpgsql_oid_debug(oid) postgres</font></div><div><font size="2"   >187; 1259 25324 TABLE digoal a_parent digoal</font></div><div><font size="2"   >189; 1259 25340 TABLE digoal a_deleted digoal</font></div><div><font size="2"   >188; 1259 25332 TABLE digoal a_undeleted digoal</font></div><div><font size="2"   >190; 1259 25348 TABLE digoal test digoal</font></div><div><font size="2"   >175; 1259 25139 TABLE digoal user_info_0 digoal</font></div><div><font size="2"   >176; 1259 25145 TABLE digoal user_info_1 digoal</font></div><div><font size="2"   >177; 1259 25151 TABLE digoal user_info_2 digoal</font></div><div><font size="2"   >178; 1259 25157 TABLE digoal user_info_3 digoal</font></div><div><font size="2"   >179; 1259 25163 TABLE digoal user_info_4 digoal</font></div><div><font size="2"   >180; 1259 25169 TABLE digoal user_login_rec digoal</font></div><div><font size="2"   >181; 1259 25175 TABLE digoal user_logout_rec digoal</font></div><div><font size="2"   >182; 1259 25181 TABLE digoal user_session_0 digoal</font></div><div><font size="2"   >183; 1259 25186 TABLE digoal user_session_1 digoal</font></div><div><font size="2"   >184; 1259 25191 TABLE digoal user_session_2 digoal</font></div><div><font size="2"   >185; 1259 25196 TABLE digoal user_session_3 digoal</font></div><div><font size="2"   >186; 1259 25201 TABLE digoal user_session_4 digoal</font></div><div><font size="2"   >164; 1259 24600 VIEW public all_tables postgres</font></div><div><font size="2"   >2883; 0 0 ACL public all_tables postgres</font></div><div><font size="2"   >163; 1259 24596 VIEW public dba_tables postgres</font></div><div><font size="2"   >2884; 0 0 ACL public dba_tables postgres</font></div><div><font size="2"   >162; 1259 24588 VIEW public user_tables postgres</font></div><div><font size="2"   >2885; 0 0 ACL public user_tables postgres</font></div><div><font size="2"   >2874; 0 25340 TABLE DATA digoal a_deleted digoal</font></div><div><font size="2"   >2872; 0 25324 TABLE DATA digoal a_parent digoal</font></div><div><font size="2"   >2873; 0 25332 TABLE DATA digoal a_undeleted digoal</font></div><div><font size="2"   >2875; 0 25348 TABLE DATA digoal test digoal</font></div><div><font size="2"   >2860; 0 25139 TABLE DATA digoal user_info_0 digoal</font></div><div><font size="2"   >2861; 0 25145 TABLE DATA digoal user_info_1 digoal</font></div><div><font size="2"   >2862; 0 25151 TABLE DATA digoal user_info_2 digoal</font></div><div><font size="2"   >2863; 0 25157 TABLE DATA digoal user_info_3 digoal</font></div><div><font size="2"   >2864; 0 25163 TABLE DATA digoal user_info_4 digoal</font></div><div><font size="2"   >2865; 0 25169 TABLE DATA digoal user_login_rec digoal</font></div><div><font size="2"   >2866; 0 25175 TABLE DATA digoal user_logout_rec digoal</font></div><div><font size="2"   >2867; 0 25181 TABLE DATA digoal user_session_0 digoal</font></div><div><font size="2"   >2868; 0 25186 TABLE DATA digoal user_session_1 digoal</font></div><div><font size="2"   >2869; 0 25191 TABLE DATA digoal user_session_2 digoal</font></div><div><font size="2"   >2870; 0 25196 TABLE DATA digoal user_session_3 digoal</font></div><div><font size="2"   >2871; 0 25201 TABLE DATA digoal user_session_4 digoal</font></div><div><font size="2"   >2856; 2606 25331 CONSTRAINT digoal a_parent_name_key digoal</font></div><div><font size="2"   >2858; 2606 25339 CONSTRAINT digoal a_undeleted_name_key digoal</font></div><div><font size="2"   >2836; 2606 25274 CONSTRAINT digoal user_info_0_pkey digoal</font></div><div><font size="2"   >2838; 2606 25270 CONSTRAINT digoal user_info_1_pkey digoal</font></div><div><font size="2"   >2840; 2606 25272 CONSTRAINT digoal user_info_2_pkey digoal</font></div><div><font size="2"   >2842; 2606 25268 CONSTRAINT digoal user_info_3_pkey digoal</font></div><div><font size="2"   >2844; 2606 25266 CONSTRAINT digoal user_info_4_pkey digoal</font></div><div><font size="2"   >2846; 2606 25264 CONSTRAINT digoal user_session_0_pkey digoal</font></div><div><font size="2"   >2848; 2606 25256 CONSTRAINT digoal user_session_1_pkey digoal</font></div><div><font size="2"   >2850; 2606 25262 CONSTRAINT digoal user_session_2_pkey digoal</font></div><div><font size="2"   >2852; 2606 25260 CONSTRAINT digoal user_session_3_pkey digoal</font></div><div><font size="2"   >2854; 2606 25258 CONSTRAINT digoal user_session_4_pkey digoal</font></div><div><font size="2"   >2859; 1259 25354 INDEX digoal idx_test_info digoal</font></div><p></p></pre></div><div><br></div><div>简单的解释一下TOC文件中entry的意思 :&nbsp;</div><div>截取自 &nbsp;</div><div><span style="line-height: 22px;"   >src/bin/pg_dump/pg_backup_archiver.c</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >void</font></div><div><font size="2"   >PrintTOCSummary(Archive *AHX, RestoreOptions *ropt)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ArchiveHandle *AH = (ArchiveHandle *) AHX;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TocEntry &nbsp; *te;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; OutputContext sav;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *fmtName;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; sav = SaveOutput(AH);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (ropt-&gt;filename)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SetOutput(AH, ropt-&gt;filename, 0 /* no compression */ );</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ahprintf(AH, ";\n; Archive created at %s", ctime(&amp;AH-&gt;createDate));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ahprintf(AH, "; &nbsp; &nbsp; dbname: %s\n; &nbsp; &nbsp; TOC Entries: %d\n; &nbsp; &nbsp; Compression: %d\n",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;AH-&gt;archdbname, AH-&gt;tocCount, AH-&gt;compression);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; switch (AH-&gt;format)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case archFiles:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fmtName = "FILES";</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case archCustom:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fmtName = "CUSTOM";</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case archTar:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fmtName = "TAR";</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fmtName = "UNKNOWN";</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ahprintf(AH, "; &nbsp; &nbsp; Dump Version: %d.%d-%d\n", AH-&gt;vmaj, AH-&gt;vmin, AH-&gt;vrev);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ahprintf(AH, "; &nbsp; &nbsp; Format: %s\n", fmtName);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ahprintf(AH, "; &nbsp; &nbsp; Integer: %d bytes\n", (int) AH-&gt;intSize);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ahprintf(AH, "; &nbsp; &nbsp; Offset: %d bytes\n", (int) AH-&gt;offSize);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (AH-&gt;archiveRemoteVersion)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ahprintf(AH, "; &nbsp; &nbsp; Dumped from database version: %s\n",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;AH-&gt;archiveRemoteVersion);</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (AH-&gt;archiveDumpVersion)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ahprintf(AH, "; &nbsp; &nbsp; Dumped by pg_dump version: %s\n",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;AH-&gt;archiveDumpVersion);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ahprintf(AH, ";\n;\n; Selected TOC Entries:\n;\n");</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* We should print DATABASE entries whether or not -C was specified */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ropt-&gt;createDB = 1;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; for (te = AH-&gt;toc-&gt;next; te != AH-&gt;toc; te = te-&gt;next)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (ropt-&gt;verbose || _tocEntryRequired(te, ropt, true) != 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ahprintf(AH, "%d; %u %u %s %s %s %s\n", te-&gt;dumpId,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;te-&gt;catalogId.tableoid, te-&gt;catalogId.oid,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;te-&gt;desc, te-&gt;namespace ? te-&gt;namespace : "-",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;te-&gt;tag, te-&gt;owner);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (ropt-&gt;verbose &amp;&amp; te-&gt;nDeps &gt; 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ahprintf(AH, ";\tdepends on:");</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for (i = 0; i &lt; te-&gt;nDeps; i++)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ahprintf(AH, " %d", te-&gt;dependencies[i]);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ahprintf(AH, "\n");</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (ropt-&gt;filename)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RestoreOutput(AH, sav);</font></div><div><font size="2"   >}</font></div></div><p></p></pre></div><div><br></div><div>1. 分号开头表示这行被注释掉了.</div><div>2.&nbsp;<span style="line-height: 22px;"   >2878; 1262 16386 DATABASE - digoal postgres 这行的意思</span></div><div><span style="line-height: 22px;"   >2878 对应&nbsp;</span>dumpId</div><div>1262 对应 catalogId.tableoid</div><div><span style="line-height: 22px;"   >16386 对应&nbsp;</span>catalogId.oid</div><div><span style="line-height: 22px;"   >DATABASE 对应&nbsp;</span>desc</div><div>- 对应&nbsp;te-&gt;namespace ? te-&gt;namespace : "-"</div><div>digoal 对应 tag</div><div>postgres 对应 owner</div><div><br></div><div>通过调整顺序和添加注释可以达到定制化还原的目的, 调整顺序时需要注意依赖关系, 如创建plpgsql的子句必须在创建函数前面. 创建表必须在创建这个表的约束和索引, 触发器等前面.&nbsp;</div><div><br></div><div>下面我们调整一下顺序, 把<span style="line-height: 22px;"   >user_info_4</span><span style="line-height: 22px;"   >&nbsp;表创建提前到</span><span style="line-height: 22px;"   >user_info_0</span><span style="line-height: 22px;"   >&nbsp;前面.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >179; 1259 25163 TABLE digoal user_info_4 digoal</font></div><div><font size="2"   >175; 1259 25139 TABLE digoal user_info_0 digoal</font></div><div><font size="2"   >176; 1259 25145 TABLE digoal user_info_1 digoal</font></div><div><font size="2"   >177; 1259 25151 TABLE digoal user_info_2 digoal</font></div><div><font size="2"   >178; 1259 25157 TABLE digoal user_info_3 digoal</font></div><p></p></pre></div><div><br></div><div>利用这个TOC文件还原看看顺序是否变更.</div><div>pg_restore -F c -L ./digoal.list -c -s -h 127.0.0.1 -U postgres ./digoal.dmp</div><div>截取一段还原日志如下, 反映出来这个顺序调整已经OK了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >--</font></div><div><font size="2"   >-- Name: user_info_4; Type: TABLE; Schema: digoal; Owner: digoal; Tablespace: digoal_03</font></div><div><font size="2"   >--</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE TABLE user_info_4 (</font></div><div><font size="2"   >&nbsp; &nbsp; userid integer NOT NULL,</font></div><div><font size="2"   >&nbsp; &nbsp; engname text,</font></div><div><font size="2"   >&nbsp; &nbsp; cnname text,</font></div><div><font size="2"   >&nbsp; &nbsp; occupation text,</font></div><div><font size="2"   >&nbsp; &nbsp; birthday date,</font></div><div><font size="2"   >&nbsp; &nbsp; signname text,</font></div><div><font size="2"   >&nbsp; &nbsp; email text,</font></div><div><font size="2"   >&nbsp; &nbsp; qq numeric,</font></div><div><font size="2"   >&nbsp; &nbsp; crt_time timestamp without time zone,</font></div><div><font size="2"   >&nbsp; &nbsp; mod_time timestamp without time zone</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >ALTER TABLE digoal.user_info_4 OWNER TO digoal;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >SET default_tablespace = digoal_04;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >--</font></div><div><font size="2"   >-- Name: user_info_0; Type: TABLE; Schema: digoal; Owner: digoal; Tablespace: digoal_04</font></div><div><font size="2"   >--</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE TABLE user_info_0 (</font></div><div><font size="2"   >&nbsp; &nbsp; userid integer NOT NULL,</font></div><div><font size="2"   >&nbsp; &nbsp; engname text,</font></div><div><font size="2"   >&nbsp; &nbsp; cnname text,</font></div><div><font size="2"   >&nbsp; &nbsp; occupation text,</font></div><div><font size="2"   >&nbsp; &nbsp; birthday date,</font></div><div><font size="2"   >&nbsp; &nbsp; signname text,</font></div><div><font size="2"   >&nbsp; &nbsp; email text,</font></div><div><font size="2"   >&nbsp; &nbsp; qq numeric,</font></div><div><font size="2"   >&nbsp; &nbsp; crt_time timestamp without time zone,</font></div><div><font size="2"   >&nbsp; &nbsp; mod_time timestamp without time zone</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >ALTER TABLE digoal.user_info_0 OWNER TO digoal;</font></div><p></p></pre></div><div><br></div><div>最后,&nbsp;<span style="line-height: 22px;"   >是否可以通过修改TOC文件中schema的内容达到把表导入不同schema的目的?</span></div><div>从测试结果来看是不可以的, 修改后TOC文件的内容如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >;</font></div><div><font size="2"   >; Archive created at Thu Apr 12 09:32:27 2012</font></div><div><font size="2"   >; &nbsp; &nbsp; dbname: digoal</font></div><div><font size="2"   >; &nbsp; &nbsp; TOC Entries: 126</font></div><div><font size="2"   >; &nbsp; &nbsp; Compression: -1</font></div><div><font size="2"   >; &nbsp; &nbsp; Dump Version: 1.12-0</font></div><div><font size="2"   >; &nbsp; &nbsp; Format: CUSTOM</font></div><div><font size="2"   >; &nbsp; &nbsp; Integer: 4 bytes</font></div><div><font size="2"   >; &nbsp; &nbsp; Offset: 8 bytes</font></div><div><font size="2"   >; &nbsp; &nbsp; Dumped from database version: 9.1.3</font></div><div><font size="2"   >; &nbsp; &nbsp; Dumped by pg_dump version: 9.1.3</font></div><div><font size="2"   >;</font></div><div><font size="2"   >;</font></div><div><font size="2"   >; Selected TOC Entries:</font></div><div><font size="2"   >;</font></div><div><font size="2"   >2878; 1262 16386 DATABASE - digoal postgres</font></div><div><font size="2"   >7; 2615 25070 SCHEMA - digoal digoal</font></div><div><font size="2"   >5; 2615 2200 SCHEMA - public postgres</font></div><div><font size="2"   >2879; 0 0 COMMENT - SCHEMA public postgres</font></div><div><font size="2"   >2880; 0 0 ACL - public postgres</font></div><div><font size="2"   >191; 3079 12425 EXTENSION - plpgsql</font></div><div><font size="2"   >2881; 0 0 COMMENT - EXTENSION plpgsql</font></div><div><font size="2"   >192; 3079 16442 EXTENSION - pgfincore</font></div><div><font size="2"   >2882; 0 0 COMMENT - EXTENSION pgfincore</font></div><div><font size="2"   >187; 1259 25324 TABLE public a_parent digoal</font></div><div><font size="2"   >2872; 0 25324 TABLE DATA public a_parent digoal</font></div><div><font size="2"   >2856; 2606 25331 CONSTRAINT public a_parent_name_key digoal</font></div><p></p></pre></div><div>目的是要把 <span style="line-height: 22px;"   >a_parent</span>&nbsp;表还原到public SCHEMA下面.</div><div>还原</div><div><pre class="prettyprint"   ><p><font size="2"   >pg_restore -F c -L ./digoal.list -c -s -h 127.0.0.1 -U postgres ./digoal.dmp</font></p></pre></div><div><br></div><div>日志输出如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >--</font></div><div><font size="2"   >-- PostgreSQL database dump</font></div><div><font size="2"   >--</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >SET statement_timeout = 0;</font></div><div><font size="2"   >SET client_encoding = 'UTF8';</font></div><div><font size="2"   >SET standard_conforming_strings = on;</font></div><div><font size="2"   >SET check_function_bodies = false;</font></div><div><font size="2"   >SET client_min_messages = warning;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >SET search_path = digoal, pg_catalog;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >ALTER TABLE ONLY digoal.a_parent DROP CONSTRAINT a_parent_name_key;</font></div><div><font size="2"   >DROP TABLE digoal.a_parent;</font></div><div><font size="2"   >DROP EXTENSION pgfincore;</font></div><div><font size="2"   >DROP EXTENSION plpgsql;</font></div><div><font size="2"   >DROP SCHEMA public;</font></div><div><font size="2"   >DROP SCHEMA digoal;</font></div><div><font size="2"   >--</font></div><div><font size="2"   >-- Name: digoal; Type: SCHEMA; Schema: -; Owner: digoal</font></div><div><font size="2"   >--</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE SCHEMA digoal;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >ALTER SCHEMA digoal OWNER TO digoal;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >--</font></div><div><font size="2"   >-- Name: public; Type: SCHEMA; Schema: -; Owner: postgres</font></div><div><font size="2"   >--</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE SCHEMA public;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >ALTER SCHEMA public OWNER TO postgres;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >--</font></div><div><font size="2"   >-- Name: SCHEMA public; Type: COMMENT; Schema: -; Owner: postgres</font></div><div><font size="2"   >--</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >COMMENT ON SCHEMA public IS 'standard public schema';</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >--</font></div><div><font size="2"   >-- Name: plpgsql; Type: EXTENSION; Schema: -; Owner:&nbsp;</font></div><div><font size="2"   >--</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE EXTENSION IF NOT EXISTS plpgsql WITH SCHEMA pg_catalog;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >--</font></div><div><font size="2"   >-- Name: EXTENSION plpgsql; Type: COMMENT; Schema: -; Owner:&nbsp;</font></div><div><font size="2"   >--</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >COMMENT ON EXTENSION plpgsql IS 'PL/pgSQL procedural language';</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >--</font></div><div><font size="2"   >-- Name: pgfincore; Type: EXTENSION; Schema: -; Owner:&nbsp;</font></div><div><font size="2"   >--</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE EXTENSION IF NOT EXISTS pgfincore WITH SCHEMA public;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >--</font></div><div><font size="2"   >-- Name: EXTENSION pgfincore; Type: COMMENT; Schema: -; Owner:&nbsp;</font></div><div><font size="2"   >--</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >COMMENT ON EXTENSION pgfincore IS 'examine and manage the os buffer cache';</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >SET search_path = digoal, pg_catalog;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >SET default_tablespace = '';</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >SET default_with_oids = false;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >--</font></div><div><font size="2"   >-- Name: a_parent; Type: TABLE; Schema: digoal; Owner: digoal; Tablespace:&nbsp;</font></div><div><font size="2"   >--</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE TABLE a_parent (</font></div><div><font size="2"   >&nbsp; &nbsp; name text NOT NULL,</font></div><div><font size="2"   >&nbsp; &nbsp; other_cols text</font></div><div><font size="2"   >);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >ALTER TABLE digoal.a_parent OWNER TO digoal;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >--</font></div><div><font size="2"   >-- Name: a_parent_name_key; Type: CONSTRAINT; Schema: digoal; Owner: digoal; Tablespace:&nbsp;</font></div><div><font size="2"   >--</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >ALTER TABLE ONLY a_parent</font></div><div><font size="2"   >&nbsp; &nbsp; ADD CONSTRAINT a_parent_name_key UNIQUE (name);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >--</font></div><div><font size="2"   >-- Name: public; Type: ACL; Schema: -; Owner: postgres</font></div><div><font size="2"   >--</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >REVOKE ALL ON SCHEMA public FROM PUBLIC;</font></div><div><font size="2"   >REVOKE ALL ON SCHEMA public FROM postgres;</font></div><div><font size="2"   >GRANT ALL ON SCHEMA public TO postgres;</font></div><div><font size="2"   >GRANT ALL ON SCHEMA public TO PUBLIC;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >--</font></div><div><font size="2"   >-- PostgreSQL database dump complete</font></div><div><font size="2"   >--</font></div><p></p></pre></div><div><div><br></div><div>显然修改TOC entry中的namespace列并没有达到我们预期的目的, pg_restore还原时不会根据这个列的值来定义search_path.</div><div>这些内容都在dmp文件中定义好了.</div><div>我们把TOC改成如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >;</font></div><div><font size="2"   >; Archive created at Thu Apr 12 09:32:27 2012</font></div><div><font size="2"   >; &nbsp; &nbsp; dbname: digoal</font></div><div><font size="2"   >; &nbsp; &nbsp; TOC Entries: 126</font></div><div><font size="2"   >; &nbsp; &nbsp; Compression: -1</font></div><div><font size="2"   >; &nbsp; &nbsp; Dump Version: 1.12-0</font></div><div><font size="2"   >; &nbsp; &nbsp; Format: CUSTOM</font></div><div><font size="2"   >; &nbsp; &nbsp; Integer: 4 bytes</font></div><div><font size="2"   >; &nbsp; &nbsp; Offset: 8 bytes</font></div><div><font size="2"   >; &nbsp; &nbsp; Dumped from database version: 9.1.3</font></div><div><font size="2"   >; &nbsp; &nbsp; Dumped by pg_dump version: 9.1.3</font></div><div><font size="2"   >;</font></div><div><font size="2"   >;</font></div><div><font size="2"   >; Selected TOC Entries:</font></div><div><font size="2"   >;</font></div><div><font size="2"   >2878</font></div><div><font size="2"   >7</font></div><div><font size="2"   >5</font></div><div><font size="2"   >2879</font></div><div><font size="2"   >2880</font></div><div><font size="2"   >191</font></div><div><font size="2"   >2881</font></div><div><font size="2"   >192</font></div><div><font size="2"   >2882</font></div><div><font size="2"   >187</font></div><div><font size="2"   >2872</font></div><div><font size="2"   >2856</font></div><p></p></pre></div><div><br></div><div>使用pg_restore -F c -L ./digoal.list -c -s -h 127.0.0.1 -U postgres ./digoal.dmp也可以还原.</div><div>原因就在pg_restore只认TOC文件的dumpID. 分号后面都是注释. 所以我们前面改的都是注释里面的内容, 当然是无效的。</div><div>要实现向ORACLE那样的fromuser和touser功能, 只能在导入后用</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ALTER TABLE name</font></div><div><font size="2"   >&nbsp; &nbsp; SET SCHEMA new_schema</font></div><p></p></pre></div><div>语法实现了.</div><div>或者等PostgreSQL后续的版本增加这类功能. 理论上来说是可行的.</div><div><br><div><br></div><div>【参考】</div><div>man pg_dump</div><div>man pg_restore</div><div>src/bin/pg_dump/pg_backup_archiver.c</div></div></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL Logical Backups TOC File - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>