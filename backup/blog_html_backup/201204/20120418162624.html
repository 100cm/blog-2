<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Change PostgreSQL Planner Method emulate Oracle's Optimize HINT</h2>
	<h5 id="">2012-04-18 16:26:24&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020123183115240/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">Oracle dba对HINT一定非常熟悉, 但是转到PostgreSQL后可能会困惑, 为啥没有HINT.<div>如果执行计划不正确该怎么办?</div><div>其实PostgreSQL可以通过调整相应的参数达到同样的目的.</div><div>相关参数如下</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >#------------------------------------------------------------------------------</font></div><div><font size="2"  ># QUERY TUNING</font></div><div><font size="2"  >#------------------------------------------------------------------------------</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ># - Planner Method Configuration -</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >#enable_bitmapscan = on</font></div><div><font size="2"  >#enable_hashagg = on</font></div><div><font size="2"  >#enable_hashjoin = on</font></div><div><font size="2"  >#enable_indexscan = on</font></div><div><font size="2"  >#enable_material = on</font></div><div><font size="2"  >#enable_mergejoin = on</font></div><div><font size="2"  >#enable_nestloop = on</font></div><div><font size="2"  >#enable_seqscan = on</font></div><div><font size="2"  >#enable_sort = on</font></div><div><font size="2"  >#enable_tidscan = on</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ># - Planner Cost Constants -</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >#seq_page_cost = 1.0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# measured on an arbitrary scale</font></div><div><font size="2"  >random_page_cost = 1.0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# same scale as above</font></div><div><font size="2"  >#cpu_tuple_cost = 0.01 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# same scale as above</font></div><div><font size="2"  >#cpu_index_tuple_cost = 0.005 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # same scale as above</font></div><div><font size="2"  >#cpu_operator_cost = 0.0025 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # same scale as above</font></div><div><font size="2"  >effective_cache_size = 20480MB</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ># - Genetic Query Optimizer -</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >#geqo = on</font></div><div><font size="2"  >#geqo_threshold = 12</font></div><div><font size="2"  >#geqo_effort = 5 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# range 1-10</font></div><div><font size="2"  >#geqo_pool_size = 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # selects default based on effort</font></div><div><font size="2"  >#geqo_generations = 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # selects default based on effort</font></div><div><font size="2"  >#geqo_selection_bias = 2.0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# range 1.5-2.0</font></div><div><font size="2"  >#geqo_seed = 0.0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# range 0.0-1.0</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ># - Other Planner Options -</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >#default_statistics_target = 100 &nbsp; &nbsp; &nbsp; &nbsp;# range 1-10000</font></div><div><div><font size="2"  >#constraint_exclusion = partition &nbsp; &nbsp; &nbsp; # on, off, or partition</font></div><div><font size="2"  >#cursor_tuple_fraction = 0.1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# range 0.0-1.0</font></div><div><font size="2"  >#from_collapse_limit = 8</font></div><div><font size="2"  >#join_collapse_limit = 8 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# 1 disables collapsing of explicit</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # JOIN clauses</font></div></div><p></p></pre></div><div><br></div><div>接下来的例子通过在session中调整<span style="line-height: 22px;"  >Planner Method Configuration这一节的参数来达到调整执行计划的目的.</span></div><div><span style="line-height: 22px;"  >测试表和索引如下 :&nbsp;</span></div><div><span style="line-height: 22px;"  >t1.</span></div><div><div><img title="Change PostgreSQL Planner Method emulate Oracles Optimize HINT - 德哥@Digoal - The Heart,The World."  alt="Change PostgreSQL Planner Method emulate Oracles Optimize HINT - 德哥@Digoal - The Heart,The World."  style="margin:0 10px 0 0;"  src="http://img8.ph.126.net/6mY7WsGrvu42c1vLWzxfDQ==/3115927992204389408.jpg"  ></div><div>t2.</div><div><div><img title="Change PostgreSQL Planner Method emulate Oracles Optimize HINT - 德哥@Digoal - The Heart,The World."  alt="Change PostgreSQL Planner Method emulate Oracles Optimize HINT - 德哥@Digoal - The Heart,The World."  style="margin:0 10px 0 0;"  src="http://img9.ph.126.net/qf-t-fGxXzjgLD7aWxtvSQ==/3115927992204389409.jpg"  ></div>&nbsp;</div><div><p>首先是Oracle中原SQL的执行时间如下 :&nbsp;</p><p></p><div><img title="Change PostgreSQL Planner Method emulate Oracles Optimize HINT - 德哥@Digoal - The Heart,The World."  alt="Change PostgreSQL Planner Method emulate Oracles Optimize HINT - 德哥@Digoal - The Heart,The World."  style="margin:0 10px 0 0;"  src="http://img2.ph.126.net/nszd5LuLJlPA9s7a9j7TVg==/611082174456264962.jpg"  ></div>PostgreSQL, 通过调整session的enable_seqscan和enable_indexscan 后的执行计划如下 :&nbsp;<p></p><div><img title="Change PostgreSQL Planner Method emulate Oracles Optimize HINT - 德哥@Digoal - The Heart,The World."  alt="Change PostgreSQL Planner Method emulate Oracles Optimize HINT - 德哥@Digoal - The Heart,The World."  style="margin:0 10px 0 0;"  src="http://img5.ph.126.net/MmSpZC_1DP2cJXBUrlKY3Q==/3115927992204389405.jpg"  ></div>&nbsp;执行时间如下 :&nbsp;<p></p><div><img title="Change PostgreSQL Planner Method emulate Oracles Optimize HINT - 德哥@Digoal - The Heart,The World."  alt="Change PostgreSQL Planner Method emulate Oracles Optimize HINT - 德哥@Digoal - The Heart,The World."  style="margin:0 10px 0 0;"  src="http://img2.ph.126.net/yK6zXfGlR0izyY92JUx3Zg==/2540874614784513292.jpg"  ></div>&nbsp;<p>与原ORACLE的执行时间相约比快50倍.</p><p>Oracle使用强制index hint后,</p><p></p><div><div><div><img title="Change PostgreSQL Planner Method emulate Oracles Optimize HINT - 德哥@Digoal - The Heart,The World."  alt="Change PostgreSQL Planner Method emulate Oracles Optimize HINT - 德哥@Digoal - The Heart,The World."  style="margin:0 10px 0 0;"  src="http://img0.ph.126.net/AJOBzeVcqwf-lkE_EeOoSA==/2813623867217115300.jpg"  ></div>&nbsp;</div>&nbsp;<img title="Change PostgreSQL Planner Method emulate Oracles Optimize HINT - 德哥@Digoal - The Heart,The World."  alt="Change PostgreSQL Planner Method emulate Oracles Optimize HINT - 德哥@Digoal - The Heart,The World."  style="margin:0 10px 0 0;"  src="http://img3.ph.126.net/wJ37fXwgL7PmxBWvZjlGRw==/1003176817014199433.jpg"  ></div><div><br></div>执行时间, 超过1小时.</div><div><br></div></div></div></div>
	</div>
</div>
</body>
</html>