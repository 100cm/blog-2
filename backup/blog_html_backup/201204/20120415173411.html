<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL Patch: Collecting statistics on foreign tables</h2>
	<h5 id="">2012-04-15 17:34:11&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201231552427915/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL 一个比较兴奋的补丁, 终于可以收集foreign table的统计信息了, 以前没有统计信息, 执行计划无法达到最优.</div><div>收集foreign table的统计信息必须手动去执行analyze.&nbsp;</div><div><br></div><div>下面在一台同时安装了PostgreSQL 9.1.3和PostgreSQL9.2 devel版本的服务器上测试两者的差别, 使用file_fdw模块.</div><div><br></div><div>创建存放csv文件的目录.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >mkdir /file_fs</font></div><div><font size="2"  >chmod 777 /file_fs</font></div><p></p></pre></div><div>PostgreSQL 9.1.3版本测试 :&nbsp;</div><div>生成测试数据 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >COPY (SELECT s.a, repeat('a', 100) FROM generate_series(1,5000000) AS s(a)) TO '/file_fs/sample_csv_data1.csv' (FORMAT csv, DELIMITER ',');</font></div><div><font size="2"  >COPY (SELECT (random()*10000)::int, repeat('b', 100) FROM generate_series(1, 5000000)) TO '/file_fs/sample_csv_data2.csv' (FORMAT csv, DELIMITER ',');</font></div><p></p></pre></div><div>创建测试外部表.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >CREATE EXTENSION file_fdw;</font></div><div><font size="2"  >CREATE SERVER file_fs FOREIGN DATA WRAPPER file_fdw;</font></div><div><font size="2"  >CREATE FOREIGN TABLE tab1 (aid INTEGER, msg text) SERVER file_fs OPTIONS (filename '/file_fs/sample_csv_data1.csv', format 'csv', delimiter ',');</font></div><div><font size="2"  >CREATE FOREIGN TABLE tab2 (aid INTEGER, msg text) SERVER file_fs OPTIONS (filename '/file_fs/sample_csv_data2.csv', format 'csv', delimiter ',');</font></div><p></p></pre></div><div>查看外部表的pg_class.relpages和reltuples, 目前都是0 . 一会看看能不能通过analyze 外部表收集到relpages和reltuples的数据.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select * from pg_class where relname='tab1';</font></div><div><font size="2"  >-[ RECORD 1 ]--+------</font></div><div><font size="2"  >relname &nbsp; &nbsp; &nbsp; &nbsp;| tab1</font></div><div><font size="2"  >relnamespace &nbsp; | 2200</font></div><div><font size="2"  >reltype &nbsp; &nbsp; &nbsp; &nbsp;| 25438</font></div><div><font size="2"  >reloftype &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"  >relowner &nbsp; &nbsp; &nbsp; | 10</font></div><div><font size="2"  >relam &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"  >relfilenode &nbsp; &nbsp;| 25436</font></div><div><font size="2"  >reltablespace &nbsp;| 0</font></div><div><font size="2"  >relpages &nbsp; &nbsp; &nbsp; | 0</font></div><div><font size="2"  >reltuples &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"  >reltoastrelid &nbsp;| 0</font></div><div><font size="2"  >reltoastidxid &nbsp;| 0</font></div><div><font size="2"  >relhasindex &nbsp; &nbsp;| f</font></div><div><font size="2"  >relisshared &nbsp; &nbsp;| f</font></div><div><font size="2"  >relpersistence | p</font></div><div><font size="2"  >relkind &nbsp; &nbsp; &nbsp; &nbsp;| f</font></div><div><font size="2"  >relnatts &nbsp; &nbsp; &nbsp; | 2</font></div><div><font size="2"  >relchecks &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"  >relhasoids &nbsp; &nbsp; | f</font></div><div><font size="2"  >relhaspkey &nbsp; &nbsp; | f</font></div><div><font size="2"  >relhasrules &nbsp; &nbsp;| f</font></div><div><font size="2"  >relhastriggers | f</font></div><div><font size="2"  >relhassubclass | f</font></div><div><font size="2"  >relfrozenxid &nbsp; | 0</font></div><div><font size="2"  >relacl &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >reloptions &nbsp; &nbsp; |&nbsp;</font></div><p></p></pre></div><div>PostgreSQL 9.1.3 跳过对外部表进行的analyze操作.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# analyze verbose tab1;</font></div><div><font size="2"  >WARNING: &nbsp;skipping "tab1" --- cannot analyze non-tables or special system tables</font></div><div><font size="2"  >ANALYZE</font></div><div><font size="2"  >postgres=# analyze verbose tab2;</font></div><div><font size="2"  >WARNING: &nbsp;skipping "tab2" --- cannot analyze non-tables or special system tables</font></div><div><font size="2"  >ANALYZE</font></div><p></p></pre></div><div>pg_statistic的外部表亦无数据</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select * from pg_statistic where starelid=(select oid from pg_class where relname='tab1');</font></div><div><font size="2"  >(No rows)</font></div><div><font size="2"  >postgres=# \d+ tab1</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Foreign table "public.tab1"</font></div><div><font size="2"  >&nbsp;Column | &nbsp;Type &nbsp; | Modifiers | Storage &nbsp;| Description&nbsp;</font></div><div><font size="2"  >--------+---------+-----------+----------+-------------</font></div><div><font size="2"  >&nbsp;aid &nbsp; &nbsp;| integer | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >&nbsp;msg &nbsp; &nbsp;| text &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | extended |&nbsp;</font></div><div><font size="2"  >Server: file_fs</font></div><div><font size="2"  >Has OIDs: no</font></div><p></p></pre></div><div>查看<span style="line-height: 22px;"  >SELECT count(*) FROM tab1, tab2 WHERE tab1.aid &gt;= 0 AND tab1.aid &lt;= 10000 AND tab1.aid = tab2.aid;的</span>执行计划</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >EXPLAIN ANALYZE SELECT count(*) FROM tab1, tab2 WHERE tab1.aid &gt;= 0 AND tab1.aid &lt;= 10000 AND tab1.aid = tab2.aid;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >------------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Aggregate &nbsp;(cost=128591583.65..128591583.66 rows=1 width=0) (actual time=23609.686..23609.686 rows=1 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;Merge Join &nbsp;(cost=5560896.77..111015831.94 rows=7030300684 width=0) (actual time=20227.876..22984.161 rows=4999763 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Merge Cond: (tab1.aid = tab2.aid)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=1857986.37..1858198.83 rows=84983 width=4) (actual time=8436.255..8438.372 rows=10000 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: tab1.aid</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Method: quicksort &nbsp;Memory: 853kB</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Foreign Scan on tab1 &nbsp;(cost=0.00..1851028.44 rows=84983 width=4) (actual time=0.089..8433.209 rows=10000 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: ((aid &gt;= 0) AND (aid &lt;= 10000))</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Foreign File: /file_fs/sample_csv_data1.csv</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Foreign File Size: 543888896</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=3702910.39..3744273.38 rows=16545193 width=4) (actual time=11791.497..13090.106 rows=5000000 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: tab2.aid</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Method: quicksort &nbsp;Memory: 430984kB</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Foreign Scan on tab2 &nbsp;(cost=0.00..1719149.30 rows=16545193 width=4) (actual time=0.081..8134.567 rows=5000000 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Foreign File: /file_fs/sample_csv_data2.csv</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Foreign File Size: 529446176</font></div><div><font size="2"  >&nbsp;Total runtime: 23625.582 ms</font></div><div><font size="2"  >(17 rows)</font></div><p></p></pre></div><div><br></div><div>以下是postgresql 9.2 devel版本的测试</div><div>创建外部表 &nbsp;:&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >CREATE EXTENSION file_fdw;</font></div><div><font size="2"  >CREATE SERVER file_fs FOREIGN DATA WRAPPER file_fdw;</font></div><div><font size="2"  >CREATE FOREIGN TABLE tab1 (aid INTEGER, msg text) SERVER file_fs OPTIONS (filename '/file_fs/sample_csv_data1.csv', format 'csv', delimiter ',');</font></div><div><font size="2"  >CREATE FOREIGN TABLE tab2 (aid INTEGER, msg text) SERVER file_fs OPTIONS (filename '/file_fs/sample_csv_data2.csv', format 'csv', delimiter ',');</font></div><p></p></pre></div><div>查看在未收集统计信息之前, 外部表tab1的pg_class中的reltuples和relpages是否有内容, 目前是0 , 因为外部表的统计信息不是自动收集的, 需要手动执行analyze .</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select * from pg_class where relname='tab1';</font></div><div><font size="2"  >-[ RECORD 1 ]--+------</font></div><div><font size="2"  >relname &nbsp; &nbsp; &nbsp; &nbsp;| tab1</font></div><div><font size="2"  >relnamespace &nbsp; | 2200</font></div><div><font size="2"  >reltype &nbsp; &nbsp; &nbsp; &nbsp;| 49199</font></div><div><font size="2"  >reloftype &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"  >relowner &nbsp; &nbsp; &nbsp; | 10</font></div><div><font size="2"  >relam &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"  >relfilenode &nbsp; &nbsp;| 49197</font></div><div><font size="2"  >reltablespace &nbsp;| 0</font></div><div><font size="2"  >relpages &nbsp; &nbsp; &nbsp; | 0</font></div><div><font size="2"  >reltuples &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"  >relallvisible &nbsp;| 0</font></div><div><font size="2"  >reltoastrelid &nbsp;| 0</font></div><div><font size="2"  >reltoastidxid &nbsp;| 0</font></div><div><font size="2"  >relhasindex &nbsp; &nbsp;| f</font></div><div><font size="2"  >relisshared &nbsp; &nbsp;| f</font></div><div><font size="2"  >relpersistence | p</font></div><div><font size="2"  >relkind &nbsp; &nbsp; &nbsp; &nbsp;| f</font></div><div><font size="2"  >relnatts &nbsp; &nbsp; &nbsp; | 2</font></div><div><font size="2"  >relchecks &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"  >relhasoids &nbsp; &nbsp; | f</font></div><div><font size="2"  >relhaspkey &nbsp; &nbsp; | f</font></div><div><font size="2"  >relhasrules &nbsp; &nbsp;| f</font></div><div><font size="2"  >relhastriggers | f</font></div><div><font size="2"  >relhassubclass | f</font></div><div><font size="2"  >relfrozenxid &nbsp; | 0</font></div><div><font size="2"  >relacl &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >reloptions &nbsp; &nbsp; |&nbsp;</font></div><p></p></pre></div><div>PostgreSQL 9.2在打上该补丁后允许对外部表执行analyze操作收集统计信息.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# analyze verbose tab1;</font></div><div><font size="2"  >INFO: &nbsp;analyzing "public.tab1"</font></div><div><font size="2"  >INFO: &nbsp;"tab1": file contains 5000000 rows; 30000 rows in sample</font></div><div><font size="2"  >ANALYZE</font></div><div><font size="2"  >postgres=# analyze verbose tab2;</font></div><div><font size="2"  >INFO: &nbsp;analyzing "public.tab2"</font></div><div><font size="2"  >INFO: &nbsp;"tab2": file contains 5000000 rows; 30000 rows in sample</font></div><div><font size="2"  >ANALYZE</font></div><p></p></pre></div><div>查看analyze后的外部表pg_class已经有了relpages和reltuples数据.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select * from pg_class where relname='tab1';</font></div><div><font size="2"  >-[ RECORD 1 ]--+------</font></div><div><font size="2"  >relname &nbsp; &nbsp; &nbsp; &nbsp;| tab1</font></div><div><font size="2"  >relnamespace &nbsp; | 2200</font></div><div><font size="2"  >reltype &nbsp; &nbsp; &nbsp; &nbsp;| 49199</font></div><div><font size="2"  >reloftype &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"  >relowner &nbsp; &nbsp; &nbsp; | 10</font></div><div><font size="2"  >relam &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"  >relfilenode &nbsp; &nbsp;| 49197</font></div><div><font size="2"  >reltablespace &nbsp;| 0</font></div><div><font size="2"  >relpages &nbsp; &nbsp; &nbsp; | 66393</font></div><div><font size="2"  >reltuples &nbsp; &nbsp; &nbsp;| 5e+06</font></div><div><font size="2"  >relallvisible &nbsp;| 0</font></div><div><font size="2"  >reltoastrelid &nbsp;| 0</font></div><div><font size="2"  >reltoastidxid &nbsp;| 0</font></div><div><font size="2"  >relhasindex &nbsp; &nbsp;| f</font></div><div><font size="2"  >relisshared &nbsp; &nbsp;| f</font></div><div><font size="2"  >relpersistence | p</font></div><div><font size="2"  >relkind &nbsp; &nbsp; &nbsp; &nbsp;| f</font></div><div><font size="2"  >relnatts &nbsp; &nbsp; &nbsp; | 2</font></div><div><font size="2"  >relchecks &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"  >relhasoids &nbsp; &nbsp; | f</font></div><div><font size="2"  >relhaspkey &nbsp; &nbsp; | f</font></div><div><font size="2"  >relhasrules &nbsp; &nbsp;| f</font></div><div><font size="2"  >relhastriggers | f</font></div><div><font size="2"  >relhassubclass | f</font></div><div><font size="2"  >relfrozenxid &nbsp; | 0</font></div><div><font size="2"  >relacl &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >reloptions &nbsp; &nbsp; |&nbsp;</font></div><p></p></pre></div><div>查看pg_statistic也有了外部表的统计信息 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select * from pg_statistic where starelid=(select oid from pg_class where relname='tab1');</font></div><div><font size="2"  >-[ RECORD 1 ]-----------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >----</font></div><div><font size="2"  >starelid &nbsp; &nbsp;| 49197</font></div><div><font size="2"  >staattnum &nbsp; | 1</font></div><div><font size="2"  >stainherit &nbsp;| f</font></div><div><font size="2"  >stanullfrac | 0</font></div><div><font size="2"  >stawidth &nbsp; &nbsp;| 4</font></div><div><font size="2"  >stadistinct | -1</font></div><div><font size="2"  >stakind1 &nbsp; &nbsp;| 2</font></div><div><font size="2"  >stakind2 &nbsp; &nbsp;| 3</font></div><div><font size="2"  >stakind3 &nbsp; &nbsp;| 0</font></div><div><font size="2"  >stakind4 &nbsp; &nbsp;| 0</font></div><div><font size="2"  >stakind5 &nbsp; &nbsp;| 0</font></div><div><font size="2"  >staop1 &nbsp; &nbsp; &nbsp;| 97</font></div><div><font size="2"  >staop2 &nbsp; &nbsp; &nbsp;| 97</font></div><div><font size="2"  >staop3 &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"  >staop4 &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"  >staop5 &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"  >stanumbers1 |&nbsp;</font></div><div><font size="2"  >stanumbers2 | {-0.00145074}</font></div><div><font size="2"  >stanumbers3 |&nbsp;</font></div><div><font size="2"  >stanumbers4 |&nbsp;</font></div><div><font size="2"  >stanumbers5 |&nbsp;</font></div><div><font size="2"  >stavalues1 &nbsp;| {64,45138,96558,146107,195251,244890,296409,345362,399679,450229,500085,546948,594174,644942,695135,749016,796848,8433</font></div><div><font size="2"  >75,893093,940543,993741,1045987,1092762,1142360,1194823,1242866,1290344,1336056,1382886,1432152,1485551,1536115,1586818,1643513,1693</font></div><div><font size="2"  >833,1743447,1794890,1843058,1891758,1946281,1994360,2042113,2091052,2143976,2192358,2242362,2293625,2345667,2391590,2446378,2493545,</font></div><div><font size="2"  >2541756,2592268,2644583,2698045,2749034,2800525,2850449,2897967,2951279,3000001,3049707,3102024,3151457,3203828,3251561,3303093,3352</font></div><div><font size="2"  >534,3401694,3454456,3503757,3553817,3601108,3650945,3700275,3751244,3803914,3851209,3902904,3946282,3999067,4054233,4103943,4151056,</font></div><div><font size="2"  >4201156,4253090,4304326,4358183,4404782,4452839,4499508,4550811,4599711,4649441,4700715,4750748,4800096,4852553,4900656,4947608,4999</font></div><div><font size="2"  >663}</font></div><div><font size="2"  >stavalues2 &nbsp;|&nbsp;</font></div><div><font size="2"  >stavalues3 &nbsp;|&nbsp;</font></div><div><font size="2"  >stavalues4 &nbsp;|&nbsp;</font></div><div><font size="2"  >stavalues5 &nbsp;|&nbsp;</font></div><div><font size="2"  >-[ RECORD 2 ]-----------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >----</font></div><div><font size="2"  >starelid &nbsp; &nbsp;| 49197</font></div><div><font size="2"  >staattnum &nbsp; | 2</font></div><div><font size="2"  >stainherit &nbsp;| f</font></div><div><font size="2"  >stanullfrac | 0</font></div><div><font size="2"  >stawidth &nbsp; &nbsp;| 101</font></div><div><font size="2"  >stadistinct | 1</font></div><div><font size="2"  >stakind1 &nbsp; &nbsp;| 1</font></div><div><font size="2"  >stakind2 &nbsp; &nbsp;| 3</font></div><div><font size="2"  >stakind3 &nbsp; &nbsp;| 0</font></div><div><font size="2"  >stakind4 &nbsp; &nbsp;| 0</font></div><div><font size="2"  >stakind5 &nbsp; &nbsp;| 0</font></div><div><font size="2"  >staop1 &nbsp; &nbsp; &nbsp;| 98</font></div><div><font size="2"  >staop2 &nbsp; &nbsp; &nbsp;| 664</font></div><div><font size="2"  >staop3 &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"  >staop4 &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"  >staop5 &nbsp; &nbsp; &nbsp;| 0</font></div><div><font size="2"  >stanumbers1 | {1}</font></div><div><font size="2"  >stanumbers2 | {1}</font></div><div><font size="2"  >stanumbers3 |&nbsp;</font></div><div><font size="2"  >stanumbers4 |&nbsp;</font></div><div><font size="2"  >stanumbers5 |&nbsp;</font></div><div><font size="2"  >stavalues1 &nbsp;| {aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa}</font></div><div><font size="2"  >stavalues2 &nbsp;|&nbsp;</font></div><div><font size="2"  >stavalues3 &nbsp;|&nbsp;</font></div><div><font size="2"  >stavalues4 &nbsp;|&nbsp;</font></div><div><font size="2"  >stavalues5 &nbsp;|&nbsp;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=# \d+ tab1</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Foreign table "public.tab1"</font></div><div><font size="2"  >&nbsp;Column | &nbsp;Type &nbsp; | Modifiers | FDW Options | Storage &nbsp;| Stats target | Description&nbsp;</font></div><div><font size="2"  >--------+---------+-----------+-------------+----------+--------------+-------------</font></div><div><font size="2"  >&nbsp;aid &nbsp; &nbsp;| integer | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >&nbsp;msg &nbsp; &nbsp;| text &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | extended | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >Server: file_fs</font></div><div><font size="2"  >FDW Options: (filename '/file_fs/sample_csv_data1.csv', format 'csv', delimiter ',')</font></div><div><font size="2"  >Has OIDs: no</font></div><p></p></pre></div><div><span style="line-height: 22px;"  ><br></span></div><div><span style="line-height: 22px;"  >查看</span><span style="line-height: 22px;"  >SELECT count(*) FROM tab1, tab2 WHERE tab1.aid &gt;= 0 AND tab1.aid &lt;= 10000 AND tab1.aid = tab2.aid;的</span><span style="line-height: 22px;"  >执行计划</span> </div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >EXPLAIN ANALYZE SELECT count(*) FROM tab1, tab2 WHERE tab1.aid &gt;= 0 AND tab1.aid &lt;= 10000 AND tab1.aid = tab2.aid;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Aggregate &nbsp;(cost=1200036.05..1200036.06 rows=1 width=0) (actual time=19874.058..19874.058 rows=1 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;Hash Join &nbsp;(cost=591524.53..1200009.75 rows=10522 width=0) (actual time=8235.555..19189.282 rows=4999763 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Hash Cond: (tab2.aid = tab1.aid)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Foreign Scan on tab2 &nbsp;(cost=0.00..564630.00 rows=5000000 width=4) (actual time=0.057..8233.713 rows=5000000 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Foreign File: /file_fs/sample_csv_data2.csv</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Foreign File Size: 529446176</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Hash &nbsp;(cost=591393.00..591393.00 rows=10522 width=4) (actual time=8235.476..8235.476 rows=10000 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Buckets: 2048 &nbsp;Batches: 1 &nbsp;Memory Usage: 352kB</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Foreign Scan on tab1 &nbsp;(cost=0.00..591393.00 rows=10522 width=4) (actual time=0.046..8232.379 rows=10000 loops=1)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: ((aid &gt;= 0) AND (aid &lt;= 10000))</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Rows Removed by Filter: 4990000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Foreign File: /file_fs/sample_csv_data1.csv</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Foreign File Size: 543888896</font></div><div><font size="2"  >&nbsp;Total runtime: 19874.174 ms</font></div><div><font size="2"  >(14 rows)</font></div><p></p></pre></div><div><br></div><div>从以上例子可以看出, 对外部表收集统计信息后, 使得数据库选择了最优的执行计划, 因此执行效率有大幅提升.</div><div><br></div><div>【参考】</div><div>http://blog.163.com/digoal@126/blog/static/163877040201041111454178/</div><div>https://commitfest.postgresql.org/action/patch_view?id=661</div><wbr></div>
	</div>
</div>
</body>
</html>