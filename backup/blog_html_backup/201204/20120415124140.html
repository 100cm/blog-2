<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL patch, add timing of buffer I/O requests SWITCH, but it have overhead</h2>
	<h5 id="">2012-04-15 12:41:40&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402012315112954240/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">PostgreSQL patch, 添加了一个用于统计buffer I/O 读,写请求所消耗的时间的功能. 由track_iotiming参数控制开关. 默认是关闭的.<div>可以使用explain analyze buffer来查看io请求的时间, 或者查看pg_stat_*, pg_stat_database和pg_stat_statements来查看累计的IO请求消耗的时间.</div><div><br><div>同时还增加了一个extension, pg_test_timing, &nbsp;可用于测试系统获取时间的开销, 以及测试系统是否存在时钟倒走的情况.</div><div>我以前在一个IBM 3950的堆叠系统中发生过时钟倒走的情况, 有兴趣的朋友可以查看我的blog</div><div><a href="http://blog.163.com/digoal@126/blog/static/1638770402010112111635423/"   >http://blog.163.com/digoal@126/blog/static/1638770402010112111635423/</a> </div><div><br></div><div>track_iotiming打开后, 系统会记录下每次读或写IO请求的时间, 需要调用gettimeofday获取IO请求开始的时间和结束的时间.</div><div>因为多了一步gettimeofday, 所以开启后会有一定的性能影响.</div><div>具体有多少影响可以通过pg_test_timing来测试. 通过测试发现和系统使用的clock计数器关系很大, 默认RHEL 5.X X64用的是<span style="line-height: 22px;"   >jiffies .</span></div><div><font size="2"   ><span style="line-height: 22px;"   >Linux系统无法动态的修改</span><span style="font-family: monospace; line-height: 19px; white-space: pre;"   >clocksource, 需要重启系统.</span></font></div><div><span style="font-family: monospace; line-height: 19px; white-space: pre;"   ><font size="2"   >某些bsd系统可以动态修改.</font></span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@digoal postgresql-9.2devel]# cat /sys/devices/system/clocksource/clocksource0/available_clocksource&nbsp;</font></div><div><font size="2"   >jiffies&nbsp;</font></div><div><font size="2"   >[root@digoal postgresql-9.2devel]# cat /sys/devices/system/clocksource/clocksource0/current_clocksource&nbsp;</font></div><div><font size="2"   >jiffies&nbsp;</font></div><p></p></pre></div><div>我的一台AMD的机器的测试</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@digoal postgresql-9.2devel]# cat /proc/cpuinfo&nbsp;</font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 0</font></div><div><font size="2"   >vendor_id &nbsp; &nbsp; &nbsp; : AuthenticAMD</font></div><div><font size="2"   >cpu family &nbsp; &nbsp; &nbsp;: 15</font></div><div><font size="2"   >model &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 107</font></div><div><font size="2"   >model name &nbsp; &nbsp; &nbsp;: AMD Athlon(tm) 64 X2 Dual Core Processor 4000+</font></div><div><font size="2"   >stepping &nbsp; &nbsp; &nbsp; &nbsp;: 1</font></div><div><font size="2"   >cpu MHz &nbsp; &nbsp; &nbsp; &nbsp; : 2094.906</font></div><div><font size="2"   >cache size &nbsp; &nbsp; &nbsp;: 512 KB</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 0</font></div><div><font size="2"   >siblings &nbsp; &nbsp; &nbsp; &nbsp;: 2</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 0</font></div><div><font size="2"   >cpu cores &nbsp; &nbsp; &nbsp; : 2</font></div><div><font size="2"   >apicid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 0</font></div><div><font size="2"   >fpu &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : yes</font></div><div><font size="2"   >fpu_exception &nbsp; : yes</font></div><div><font size="2"   >cpuid level &nbsp; &nbsp; : 1</font></div><div><font size="2"   >wp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: yes</font></div><div><font size="2"   >flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ht syscall nx mmxext fxsr_opt rdtscp lm 3dnowext 3dnow pni cx16 lahf_lm cmp_legacy svm extapic cr8_legacy misalignsse</font></div><div><font size="2"   >bogomips &nbsp; &nbsp; &nbsp; &nbsp;: 4189.81</font></div><div><font size="2"   >TLB size &nbsp; &nbsp; &nbsp; &nbsp;: 1024 4K pages</font></div><div><font size="2"   >clflush size &nbsp; &nbsp;: 64</font></div><div><font size="2"   >cache_alignment : 64</font></div><div><font size="2"   >address sizes &nbsp; : 40 bits physical, 48 bits virtual</font></div><div><font size="2"   >power management: ts fid vid ttp tm stc 100mhzsteps</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 1</font></div><div><font size="2"   >vendor_id &nbsp; &nbsp; &nbsp; : AuthenticAMD</font></div><div><font size="2"   >cpu family &nbsp; &nbsp; &nbsp;: 15</font></div><div><font size="2"   >model &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 107</font></div><div><font size="2"   >model name &nbsp; &nbsp; &nbsp;: AMD Athlon(tm) 64 X2 Dual Core Processor 4000+</font></div><div><font size="2"   >stepping &nbsp; &nbsp; &nbsp; &nbsp;: 1</font></div><div><font size="2"   >cpu MHz &nbsp; &nbsp; &nbsp; &nbsp; : 2094.906</font></div><div><font size="2"   >cache size &nbsp; &nbsp; &nbsp;: 512 KB</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 0</font></div><div><font size="2"   >siblings &nbsp; &nbsp; &nbsp; &nbsp;: 2</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 1</font></div><div><font size="2"   >cpu cores &nbsp; &nbsp; &nbsp; : 2</font></div><div><font size="2"   >apicid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 1</font></div><div><font size="2"   >fpu &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : yes</font></div><div><font size="2"   >fpu_exception &nbsp; : yes</font></div><div><font size="2"   >cpuid level &nbsp; &nbsp; : 1</font></div><div><font size="2"   >wp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: yes</font></div><div><font size="2"   >flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ht syscall nx mmxext fxsr_opt rdtscp lm 3dnowext 3dnow pni cx16 lahf_lm cmp_legacy svm extapic cr8_legacy misalignsse</font></div><div><font size="2"   >bogomips &nbsp; &nbsp; &nbsp; &nbsp;: 4189.09</font></div><div><font size="2"   >TLB size &nbsp; &nbsp; &nbsp; &nbsp;: 1024 4K pages</font></div><div><font size="2"   >clflush size &nbsp; &nbsp;: 64</font></div><div><font size="2"   >cache_alignment : 64</font></div><div><font size="2"   >address sizes &nbsp; : 40 bits physical, 48 bits virtual</font></div><div><font size="2"   >power management: ts fid vid ttp tm stc 100mhzsteps</font></div><p></p></pre></div><div>测试结果如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@digoal-&gt; pg_test_timing&nbsp;</font></div><div><font size="2"   >Testing timing overhead for 3 seconds.</font></div><div><font size="2"   >Per loop time including overhead: 908.38 nsec</font></div><div><font size="2"   >Histogram of timing durations:</font></div><div><font size="2"   >&nbsp; &nbsp;&lt; usec: &nbsp; &nbsp; &nbsp;count &nbsp; percent</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 512: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 &nbsp;0.00003%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 256: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5 &nbsp;0.00015%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 128: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5 &nbsp;0.00015%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;64: &nbsp; &nbsp; &nbsp; &nbsp; 15 &nbsp;0.00045%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;32: &nbsp; &nbsp; &nbsp; &nbsp; 54 &nbsp;0.00164%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;16: &nbsp; &nbsp; &nbsp; &nbsp; 31 &nbsp;0.00094%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 8: &nbsp; &nbsp; &nbsp; 3003 &nbsp;0.09093%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 4: &nbsp; &nbsp; &nbsp; 3593 &nbsp;0.10879%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 2: &nbsp; &nbsp;2972328 89.99972%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1: &nbsp; &nbsp; 323562 &nbsp;9.79720%</font></div><p></p></pre></div><div>修改/boot/grub/grub.conf, 把clock修改为tsc,&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; kernel /boot/vmlinuz-2.6.18-274.7.1.el5 ro root=LABEL=/ rhgb quiet clock=tsc</font></p></pre></div><div>结果如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@digoal-&gt; pg_test_timing&nbsp;</font></div><div><font size="2"   >Testing timing overhead for 3 seconds.</font></div><div><font size="2"   >Per loop time including overhead: 115.07 nsec</font></div><div><font size="2"   >Histogram of timing durations:</font></div><div><font size="2"   >&nbsp; &nbsp;&lt; usec: &nbsp; &nbsp; &nbsp;count &nbsp; percent</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;4096: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 &nbsp;0.00000%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;2048: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3 &nbsp;0.00001%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;1024: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp;0.00000%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 512: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3 &nbsp;0.00001%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 256: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 &nbsp;0.00001%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 128: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8 &nbsp;0.00003%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;64: &nbsp; &nbsp; &nbsp; &nbsp; 22 &nbsp;0.00008%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;32: &nbsp; &nbsp; &nbsp; &nbsp; 84 &nbsp;0.00032%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;16: &nbsp; &nbsp; &nbsp; 3051 &nbsp;0.01170%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 8: &nbsp; &nbsp; &nbsp; &nbsp; 38 &nbsp;0.00015%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 4: &nbsp; &nbsp; &nbsp; &nbsp;538 &nbsp;0.00206%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 2: &nbsp; &nbsp;2956245 11.33914%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1: &nbsp; 23111154 88.64647%</font></div><p></p></pre></div><div>但是需要注意修改完clock=tsc并重启操作系统后, current_clocksource还是显示jiffies</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@digoal ~]# cat /sys/devices/system/clocksource/clocksource0/current_clocksource&nbsp;</font></div><div><font size="2"   >jiffies&nbsp;</font></div><div><font size="2"   >[root@digoal ~]# cat /sys/devices/system/clocksource/clocksource0/available_clocksource&nbsp;</font></div><div><font size="2"   >jiffies&nbsp;</font></div><p></p></pre></div><div>另一台CPU是至强的服务器</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># cat /proc/cpuinfo&nbsp;</font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 0</font></div><div><font size="2"   >vendor_id &nbsp; &nbsp; &nbsp; : GenuineIntel</font></div><div><font size="2"   >cpu family &nbsp; &nbsp; &nbsp;: 6</font></div><div><font size="2"   >model &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 26</font></div><div><font size="2"   >model name &nbsp; &nbsp; &nbsp;: Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"   >stepping &nbsp; &nbsp; &nbsp; &nbsp;: 5</font></div><div><font size="2"   >cpu MHz &nbsp; &nbsp; &nbsp; &nbsp; : 1596.000</font></div><div><font size="2"   >cache size &nbsp; &nbsp; &nbsp;: 4096 KB</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 1</font></div><div><font size="2"   >siblings &nbsp; &nbsp; &nbsp; &nbsp;: 4</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 0</font></div><div><font size="2"   >cpu cores &nbsp; &nbsp; &nbsp; : 4</font></div><div><font size="2"   >apicid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 16</font></div><div><font size="2"   >fpu &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : yes</font></div><div><font size="2"   >fpu_exception &nbsp; : yes</font></div><div><font size="2"   >cpuid level &nbsp; &nbsp; : 11</font></div><div><font size="2"   >wp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: yes</font></div><div><font size="2"   >flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm syscall nx rdtscp lm constant_tsc nonstop_tsc pni monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr sse4_1 sse4_2 popcnt lahf_lm</font></div><div><font size="2"   >bogomips &nbsp; &nbsp; &nbsp; &nbsp;: 3990.10</font></div><div><font size="2"   >clflush size &nbsp; &nbsp;: 64</font></div><div><font size="2"   >cache_alignment : 64</font></div><div><font size="2"   >address sizes &nbsp; : 40 bits physical, 48 bits virtual</font></div><div><font size="2"   >power management: [8]</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 1</font></div><div><font size="2"   >vendor_id &nbsp; &nbsp; &nbsp; : GenuineIntel</font></div><div><font size="2"   >cpu family &nbsp; &nbsp; &nbsp;: 6</font></div><div><font size="2"   >model &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 26</font></div><div><font size="2"   >model name &nbsp; &nbsp; &nbsp;: Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"   >stepping &nbsp; &nbsp; &nbsp; &nbsp;: 5</font></div><div><font size="2"   >cpu MHz &nbsp; &nbsp; &nbsp; &nbsp; : 1596.000</font></div><div><font size="2"   >cache size &nbsp; &nbsp; &nbsp;: 4096 KB</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 0</font></div><div><font size="2"   >siblings &nbsp; &nbsp; &nbsp; &nbsp;: 4</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 0</font></div><div><font size="2"   >cpu cores &nbsp; &nbsp; &nbsp; : 4</font></div><div><font size="2"   >apicid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 0</font></div><div><font size="2"   >fpu &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : yes</font></div><div><font size="2"   >fpu_exception &nbsp; : yes</font></div><div><font size="2"   >cpuid level &nbsp; &nbsp; : 11</font></div><div><font size="2"   >wp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: yes</font></div><div><font size="2"   >flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm syscall nx rdtscp lm constant_tsc nonstop_tsc pni monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr sse4_1 sse4_2 popcnt lahf_lm</font></div><div><font size="2"   >bogomips &nbsp; &nbsp; &nbsp; &nbsp;: 3989.48</font></div><div><font size="2"   >clflush size &nbsp; &nbsp;: 64</font></div><div><font size="2"   >cache_alignment : 64</font></div><div><font size="2"   >address sizes &nbsp; : 40 bits physical, 48 bits virtual</font></div><div><font size="2"   >power management: [8]</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 2</font></div><div><font size="2"   >vendor_id &nbsp; &nbsp; &nbsp; : GenuineIntel</font></div><div><font size="2"   >cpu family &nbsp; &nbsp; &nbsp;: 6</font></div><div><font size="2"   >model &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 26</font></div><div><font size="2"   >model name &nbsp; &nbsp; &nbsp;: Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"   >stepping &nbsp; &nbsp; &nbsp; &nbsp;: 5</font></div><div><font size="2"   >cpu MHz &nbsp; &nbsp; &nbsp; &nbsp; : 1596.000</font></div><div><font size="2"   >cache size &nbsp; &nbsp; &nbsp;: 4096 KB</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 1</font></div><div><font size="2"   >siblings &nbsp; &nbsp; &nbsp; &nbsp;: 4</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 1</font></div><div><font size="2"   >cpu cores &nbsp; &nbsp; &nbsp; : 4</font></div><div><font size="2"   >apicid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 18</font></div><div><font size="2"   >fpu &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : yes</font></div><div><font size="2"   >fpu_exception &nbsp; : yes</font></div><div><font size="2"   >cpuid level &nbsp; &nbsp; : 11</font></div><div><font size="2"   >wp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: yes</font></div><div><font size="2"   >flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm syscall nx rdtscp lm constant_tsc nonstop_tsc pni monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr sse4_1 sse4_2 popcnt lahf_lm</font></div><div><font size="2"   >bogomips &nbsp; &nbsp; &nbsp; &nbsp;: 3989.54</font></div><div><font size="2"   >clflush size &nbsp; &nbsp;: 64</font></div><div><font size="2"   >cache_alignment : 64</font></div><div><font size="2"   >address sizes &nbsp; : 40 bits physical, 48 bits virtual</font></div><div><font size="2"   >power management: [8]</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 3</font></div><div><font size="2"   >vendor_id &nbsp; &nbsp; &nbsp; : GenuineIntel</font></div><div><font size="2"   >cpu family &nbsp; &nbsp; &nbsp;: 6</font></div><div><font size="2"   >model &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 26</font></div><div><font size="2"   >model name &nbsp; &nbsp; &nbsp;: Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"   >stepping &nbsp; &nbsp; &nbsp; &nbsp;: 5</font></div><div><font size="2"   >cpu MHz &nbsp; &nbsp; &nbsp; &nbsp; : 1596.000</font></div><div><font size="2"   >cache size &nbsp; &nbsp; &nbsp;: 4096 KB</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 0</font></div><div><font size="2"   >siblings &nbsp; &nbsp; &nbsp; &nbsp;: 4</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 1</font></div><div><font size="2"   >cpu cores &nbsp; &nbsp; &nbsp; : 4</font></div><div><font size="2"   >apicid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 2</font></div><div><font size="2"   >fpu &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : yes</font></div><div><font size="2"   >fpu_exception &nbsp; : yes</font></div><div><font size="2"   >cpuid level &nbsp; &nbsp; : 11</font></div><div><font size="2"   >wp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: yes</font></div><div><font size="2"   >flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm syscall nx rdtscp lm constant_tsc nonstop_tsc pni monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr sse4_1 sse4_2 popcnt lahf_lm</font></div><div><font size="2"   >bogomips &nbsp; &nbsp; &nbsp; &nbsp;: 3989.47</font></div><div><font size="2"   >clflush size &nbsp; &nbsp;: 64</font></div><div><font size="2"   >cache_alignment : 64</font></div><div><font size="2"   >address sizes &nbsp; : 40 bits physical, 48 bits virtual</font></div><div><font size="2"   >power management: [8]</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 4</font></div><div><font size="2"   >vendor_id &nbsp; &nbsp; &nbsp; : GenuineIntel</font></div><div><font size="2"   >cpu family &nbsp; &nbsp; &nbsp;: 6</font></div><div><font size="2"   >model &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 26</font></div><div><font size="2"   >model name &nbsp; &nbsp; &nbsp;: Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"   >stepping &nbsp; &nbsp; &nbsp; &nbsp;: 5</font></div><div><font size="2"   >cpu MHz &nbsp; &nbsp; &nbsp; &nbsp; : 1596.000</font></div><div><font size="2"   >cache size &nbsp; &nbsp; &nbsp;: 4096 KB</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 1</font></div><div><font size="2"   >siblings &nbsp; &nbsp; &nbsp; &nbsp;: 4</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 2</font></div><div><font size="2"   >cpu cores &nbsp; &nbsp; &nbsp; : 4</font></div><div><font size="2"   >apicid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 20</font></div><div><font size="2"   >fpu &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : yes</font></div><div><font size="2"   >fpu_exception &nbsp; : yes</font></div><div><font size="2"   >cpuid level &nbsp; &nbsp; : 11</font></div><div><font size="2"   >wp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: yes</font></div><div><font size="2"   >flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm syscall nx rdtscp lm constant_tsc nonstop_tsc pni monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr sse4_1 sse4_2 popcnt lahf_lm</font></div><div><font size="2"   >bogomips &nbsp; &nbsp; &nbsp; &nbsp;: 3989.47</font></div><div><font size="2"   >clflush size &nbsp; &nbsp;: 64</font></div><div><font size="2"   >cache_alignment : 64</font></div><div><font size="2"   >address sizes &nbsp; : 40 bits physical, 48 bits virtual</font></div><div><font size="2"   >power management: [8]</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 5</font></div><div><font size="2"   >vendor_id &nbsp; &nbsp; &nbsp; : GenuineIntel</font></div><div><font size="2"   >cpu family &nbsp; &nbsp; &nbsp;: 6</font></div><div><font size="2"   >model &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 26</font></div><div><font size="2"   >model name &nbsp; &nbsp; &nbsp;: Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"   >stepping &nbsp; &nbsp; &nbsp; &nbsp;: 5</font></div><div><font size="2"   >cpu MHz &nbsp; &nbsp; &nbsp; &nbsp; : 1596.000</font></div><div><font size="2"   >cache size &nbsp; &nbsp; &nbsp;: 4096 KB</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 0</font></div><div><font size="2"   >siblings &nbsp; &nbsp; &nbsp; &nbsp;: 4</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 2</font></div><div><font size="2"   >cpu cores &nbsp; &nbsp; &nbsp; : 4</font></div><div><font size="2"   >apicid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 4</font></div><div><font size="2"   >fpu &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : yes</font></div><div><font size="2"   >fpu_exception &nbsp; : yes</font></div><div><font size="2"   >cpuid level &nbsp; &nbsp; : 11</font></div><div><font size="2"   >wp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: yes</font></div><div><font size="2"   >flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm syscall nx rdtscp lm constant_tsc nonstop_tsc pni monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr sse4_1 sse4_2 popcnt lahf_lm</font></div><div><font size="2"   >bogomips &nbsp; &nbsp; &nbsp; &nbsp;: 3989.48</font></div><div><font size="2"   >clflush size &nbsp; &nbsp;: 64</font></div><div><font size="2"   >cache_alignment : 64</font></div><div><font size="2"   >address sizes &nbsp; : 40 bits physical, 48 bits virtual</font></div><div><font size="2"   >power management: [8]</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 6</font></div><div><font size="2"   >vendor_id &nbsp; &nbsp; &nbsp; : GenuineIntel</font></div><div><font size="2"   >cpu family &nbsp; &nbsp; &nbsp;: 6</font></div><div><font size="2"   >model &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 26</font></div><div><font size="2"   >model name &nbsp; &nbsp; &nbsp;: Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"   >stepping &nbsp; &nbsp; &nbsp; &nbsp;: 5</font></div><div><font size="2"   >cpu MHz &nbsp; &nbsp; &nbsp; &nbsp; : 1596.000</font></div><div><font size="2"   >cache size &nbsp; &nbsp; &nbsp;: 4096 KB</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 1</font></div><div><font size="2"   >siblings &nbsp; &nbsp; &nbsp; &nbsp;: 4</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 3</font></div><div><font size="2"   >cpu cores &nbsp; &nbsp; &nbsp; : 4</font></div><div><font size="2"   >apicid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 22</font></div><div><font size="2"   >fpu &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : yes</font></div><div><font size="2"   >fpu_exception &nbsp; : yes</font></div><div><font size="2"   >cpuid level &nbsp; &nbsp; : 11</font></div><div><font size="2"   >wp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: yes</font></div><div><font size="2"   >flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm syscall nx rdtscp lm constant_tsc nonstop_tsc pni monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr sse4_1 sse4_2 popcnt lahf_lm</font></div><div><font size="2"   >bogomips &nbsp; &nbsp; &nbsp; &nbsp;: 3989.45</font></div><div><font size="2"   >clflush size &nbsp; &nbsp;: 64</font></div><div><font size="2"   >cache_alignment : 64</font></div><div><font size="2"   >address sizes &nbsp; : 40 bits physical, 48 bits virtual</font></div><div><font size="2"   >power management: [8]</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 7</font></div><div><font size="2"   >vendor_id &nbsp; &nbsp; &nbsp; : GenuineIntel</font></div><div><font size="2"   >cpu family &nbsp; &nbsp; &nbsp;: 6</font></div><div><font size="2"   >model &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 26</font></div><div><font size="2"   >model name &nbsp; &nbsp; &nbsp;: Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"   >stepping &nbsp; &nbsp; &nbsp; &nbsp;: 5</font></div><div><font size="2"   >cpu MHz &nbsp; &nbsp; &nbsp; &nbsp; : 1596.000</font></div><div><font size="2"   >cache size &nbsp; &nbsp; &nbsp;: 4096 KB</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 0</font></div><div><font size="2"   >siblings &nbsp; &nbsp; &nbsp; &nbsp;: 4</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 3</font></div><div><font size="2"   >cpu cores &nbsp; &nbsp; &nbsp; : 4</font></div><div><font size="2"   >apicid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 6</font></div><div><font size="2"   >fpu &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : yes</font></div><div><font size="2"   >fpu_exception &nbsp; : yes</font></div><div><font size="2"   >cpuid level &nbsp; &nbsp; : 11</font></div><div><font size="2"   >wp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: yes</font></div><div><font size="2"   >flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm syscall nx rdtscp lm constant_tsc nonstop_tsc pni monitor ds_cpl vmx est tm2 ssse3 cx16 xtpr sse4_1 sse4_2 popcnt lahf_lm</font></div><div><font size="2"   >bogomips &nbsp; &nbsp; &nbsp; &nbsp;: 3989.50</font></div><div><font size="2"   >clflush size &nbsp; &nbsp;: 64</font></div><div><font size="2"   >cache_alignment : 64</font></div><div><font size="2"   >address sizes &nbsp; : 40 bits physical, 48 bits virtual</font></div><div><font size="2"   >power management: [8]</font></div><p></p></pre></div><div>pg_test_timing的测试结果 :&nbsp;</div><div>修改clocksource前</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&gt; pg_test_timing&nbsp;</font></div><div><font size="2"   >Testing timing overhead for 3 seconds.</font></div><div><font size="2"   >Per loop time including overhead: 705.74 nsec</font></div><div><font size="2"   >Histogram of timing durations:</font></div><div><font size="2"   >&nbsp; &nbsp;&lt; usec: &nbsp; &nbsp; &nbsp;count &nbsp; percent</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 256: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 &nbsp;0.00002%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 128: &nbsp; &nbsp; &nbsp; &nbsp;124 &nbsp;0.00292%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;64: &nbsp; &nbsp; &nbsp; 2905 &nbsp;0.06834%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;32: &nbsp; &nbsp; &nbsp; &nbsp; 19 &nbsp;0.00045%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;16: &nbsp; &nbsp; &nbsp; &nbsp;110 &nbsp;0.00259%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 8: &nbsp; &nbsp; &nbsp; 2927 &nbsp;0.06886%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 4: &nbsp; &nbsp; &nbsp; 5947 &nbsp;0.13990%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 2: &nbsp; &nbsp;2829957 66.57338%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1: &nbsp; &nbsp;1408894 33.14355%</font></div><p></p></pre></div><div>修改clock=tsc后</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&gt; pg_test_timing&nbsp;</font></div><div><font size="2"   >Testing timing overhead for 3 seconds.</font></div><div><font size="2"   >Per loop time including overhead: 80.22 nsec</font></div><div><font size="2"   >Histogram of timing durations:</font></div><div><font size="2"   >&nbsp; &nbsp;&lt; usec: &nbsp; &nbsp; &nbsp;count &nbsp; percent</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 512: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 &nbsp;0.00000%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 256: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp;0.00000%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; 128: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp;0.00000%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;64: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 &nbsp;0.00001%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;32: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3 &nbsp;0.00001%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;16: &nbsp; &nbsp; &nbsp; 3000 &nbsp;0.00802%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 8: &nbsp; &nbsp; &nbsp; &nbsp; 13 &nbsp;0.00003%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 4: &nbsp; &nbsp; &nbsp; &nbsp;614 &nbsp;0.00164%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 2: &nbsp; &nbsp;2969087 &nbsp;7.93915%</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1: &nbsp; 34425324 92.05114%</font></div><p></p></pre></div><div>接下来在数据库中测试一下打开iotiming 后的效果, 用到的是至强的服务器.</div><div>由于track_iotiming默认是关闭的, 所以要打开它然后进行测试. 修改后reload一下.</div><div>在clocksource=jiffies的时候我测试的结果如下 &nbsp;:&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# explain ( analyze on, buffers on) select count(*) from test1;</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Aggregate &nbsp;(cost=15932.00..15932.01 rows=1 width=0) (actual time=1404.777..1404.778 rows=1 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Buffers: shared hit=192 read=3791</font></div><div><font size="2"   >&nbsp; &nbsp;I/O Timings: read=15.99</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Seq Scan on test1 &nbsp;(cost=0.00..13542.20 rows=955920 width=0) (actual time=0.045..715.611 rows=900000 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Buffers: shared hit=192 read=3791</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;I/O Timings: read=15.99</font></div><div><font size="2"   >&nbsp;Total runtime: 1404.819 ms</font></div><div><font size="2"   >(7 rows)</font></div></div><p></p></pre></div><div>在修改完clock=tsc后的测试结果 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# select count(*) from test1;</font></div><div><font size="2"   >&nbsp;count &nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp;900000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Time: 137.633 ms</font></div></div><div><div><font size="2"   >postgres=# explain ( analyze on, buffers on) select count(*) from test1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Aggregate &nbsp;(cost=15932.00..15932.01 rows=1 width=0) (actual time=329.160..329.160 rows=1 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Buffers: shared hit=416 read=3567</font></div><div><font size="2"   >&nbsp; &nbsp;I/O Timings: read=12.91</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Seq Scan on test1 &nbsp;(cost=0.00..13542.20 rows=955920 width=0) (actual time=0.051..175.660 rows=900000 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Buffers: shared hit=416 read=3567</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;I/O Timings: read=12.91</font></div><div><font size="2"   >&nbsp;Total runtime: 329.203 ms</font></div><div><font size="2"   >(7 rows)</font></div></div><p></p></pre></div><div>explain analyze 和直接执行select相差的时间是329.203-137.633毫秒.</div><div>可以计算出获取系统时间的overhead如下</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select 1000000*(329.203-137.633)/900000;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;?column? &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----------------------</font></div><div><font size="2"   >&nbsp;212.8555555555555556</font></div><p></p></pre></div><div>前面测试的iotiming overhead如下</div></div><div><pre class="prettyprint"   ><p><font size="2"   >Per loop time including overhead: 115.07 nsec</font></p></pre></div><div><span style="line-height: 22px;"   >212.8555555555555556</span><span style="line-height: 22px;"   >约为通过pg_test_timing测试出来的overhead 115.07nsec的一倍.</span></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >对于一个频繁的系统，如每天有数十亿次QUERY的系统，trace_iotiming打开后预计会带来多少overhead呢?</span></div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select 1000000000*((329.203-137.633)/900000) ;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ?column? &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----------------------------</font></div><div><font size="2"   >&nbsp;212855.55555555556000000000 &nbsp;毫秒.&nbsp;</font></div><p></p></pre></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   >看起来并不算太大.</span></div><div style="line-height: 22px;"   ><br></div></div><div>前面一直在说的都是trace_iotiming打开后会带来多少overhead.</div><div>接下来就说说统计的io时间在哪里看.</div><div><pre class="prettyprint"   ><p><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;I/O Timings: read=12.91</font></p></pre></div><div><span style="line-height: 22px;"   >表示io请求的读消耗了12.91毫秒</span></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >另外可以通过查看pg_stat_statements或pg_stat_database获得累计的开销统计时间.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \d pg_stat_statements</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; View "public.pg_stat_statements"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;Column &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; Type &nbsp; &nbsp; &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"   >---------------------+------------------+-----------</font></div><div><font size="2"   >&nbsp;userid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;dbid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;query &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;calls &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;total_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| double precision |&nbsp;</font></div><div><font size="2"   >&nbsp;rows &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;shared_blks_hit &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;shared_blks_read &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;shared_blks_dirtied | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;shared_blks_written | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;local_blks_hit &nbsp; &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;local_blks_read &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;local_blks_dirtied &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;local_blks_written &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;temp_blks_read &nbsp; &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;temp_blks_written &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;time_read &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | double precision |&nbsp;</font></div><div><font size="2"   >&nbsp;time_write &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| double precision |&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# \d pg_stat_database</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;View "pg_catalog.pg_stat_database"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; Column &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"   >------------------+--------------------------+-----------</font></div><div><font size="2"   >&nbsp;datid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;datname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;numbackends &nbsp; &nbsp; &nbsp;| integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;xact_commit &nbsp; &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;xact_rollback &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;blks_read &nbsp; &nbsp; &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;blks_hit &nbsp; &nbsp; &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;tup_returned &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;tup_fetched &nbsp; &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;tup_inserted &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;tup_updated &nbsp; &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;tup_deleted &nbsp; &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;conflicts &nbsp; &nbsp; &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;temp_files &nbsp; &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;temp_bytes &nbsp; &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;deadlocks &nbsp; &nbsp; &nbsp; &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;block_read_time &nbsp;| bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;block_write_time | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;stats_reset &nbsp; &nbsp; &nbsp;| timestamp with time zone |&nbsp;</font></div><p></p></pre></div><div><br><div>【参考】</div><div>src/backend/storage/buffer/bufmgr.c</div><div><a rel="nofollow" href="https://commitfest.postgresql.org/action/patch_view?id=788"   >https://commitfest.postgresql.org/action/patch_view?id=788</a> </div><div><a rel="nofollow" href="http://www.postgresql.org/docs/devel/static/pgstatstatements.html"   >http://www.postgresql.org/docs/devel/static/pgstatstatements.html</a> </div><div><a rel="nofollow" href="http://www.postgresql.org/docs/devel/static/runtime-config-statistics.html#GUC-TRACK-IOTIMING"   >http://www.postgresql.org/docs/devel/static/runtime-config-statistics.html#GUC-TRACK-IOTIMING</a> </div><div><a rel="nofollow" href="http://www.postgresql.org/docs/devel/static/pgtesttiming.html"   >http://www.postgresql.org/docs/devel/static/pgtesttiming.html</a> </div><div><a rel="nofollow" href="http://www.postgresql.org/docs/devel/static/monitoring-stats.html#PG-STAT-DATABASE-VIEW"   >http://www.postgresql.org/docs/devel/static/monitoring-stats.html#PG-STAT-DATABASE-VIEW</a> </div><div><div><a target="_blank" rel="nofollow" href="http://en.wikipedia.org/wiki/Jiffy_(time)"   >http://en.wikipedia.org/wiki/Jiffy_(time)</a></div><div><a target="_blank" rel="nofollow" href="http://en.wikipedia.org/wiki/Time_Stamp_Counter"   >http://en.wikipedia.org/wiki/Time_Stamp_Counter</a></div><div><a target="_blank" rel="nofollow" href="http://www.redhat.com/archives/rhl-list/2007-May/msg00937.html"   >http://www.redhat.com/archives/rhl-list/2007-May/msg00937.html</a></div></div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201062810748700/"   >http://blog.163.com/digoal@126/blog/static/163877040201062810748700/</a> </div><div><br></div><div><div>In computing, a jiffy is the duration of one tick of the system timer interrupt. It is not an absolute time interval unit, since its duration depends on the clock interrupt frequency of the particular hardware platform.</div><div>Early microcomputer systems such as the Commodore 64 and many game consoles (which use televisions as a display device) commonly synchronize the system interrupt timer with the vertical frequency of the local television standard, either 59.94 Hz with NTSC systems, or 50.0 Hz with most PAL systems. Within the Linux operating system kernel, since release 2.6.13, on the Intel i386 platform a jiffy is by default 4 ms, or 1/250 of a second.[4] The jiffy values for other Linux versions and platforms have typically varied between about 1 ms and 10 ms.</div></div></div></div></div>
	</div>
</div>
</body>
</html>