<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">pg_xlog_location_diff function is coming from PostgreSQL 9.2</h2>
	<h5 id="">2012-04-06 12:16:16&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201236112855929/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">pg_xlog_location_diff 这个函数在9.2里面添加的, 用来计算两个transaction log location之间产生了多少xlog, 单位bytes.<wbr><div>例如 :&nbsp;</div><div>创建测试表 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# create table test(id int);</font></div><div><font size="2"  >CREATE TABLE</font></div><p></p></pre></div><div>查看当前transaction log location.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select * from pg_current_xlog_insert_location();</font></div><div><font size="2"  >&nbsp;pg_current_xlog_insert_location&nbsp;</font></div><div><font size="2"  >---------------------------------</font></div><div><font size="2"  >&nbsp;0/C7136F0</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>插入测试数据</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# insert into test select generate_series(1,1000000);</font></div><div><font size="2"  >INSERT 0 1000000</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >查看当前transaction log location.</span> </div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select * from pg_current_xlog_insert_location();</font></div><div><font size="2"  >&nbsp;pg_current_xlog_insert_location&nbsp;</font></div><div><font size="2"  >---------------------------------</font></div><div><font size="2"  >&nbsp;0/1045B1C0</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>比较两个transaction log location之间产生了多少xlog.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select pg_xlog_location_diff('0/1045B1C0','0/C7136F0')/1024/1024;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; ?column? &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >---------------------</font></div><div><font size="2"  >&nbsp;61.2799835205078125</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>查看表的大小</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select pg_total_relation_size('test')/1024/1024;</font></div><div><font size="2"  >&nbsp;?column?&nbsp;</font></div><div><font size="2"  >----------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;34</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>更新测试:</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# update test set id=1;</font></div><div><font size="2"  >LOG: &nbsp;checkpoints are occurring too frequently (1 second apart)</font></div><div><font size="2"  >HINT: &nbsp;Consider increasing the configuration parameter "checkpoint_segments".</font></div><div><font size="2"  >UPDATE 1000000</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >查看当前transaction log location.</span> </div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select * from pg_current_xlog_insert_location();</font></div><div><font size="2"  >&nbsp;pg_current_xlog_insert_location&nbsp;</font></div><div><font size="2"  >---------------------------------</font></div><div><font size="2"  >&nbsp;0/1A94E728</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >比较两个transaction log location之间产生了多少xlog.</span> </div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select pg_xlog_location_diff('0/1A94E728','0/141B6680')/1024/1024;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;?column? &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >----------------------</font></div><div><font size="2"  >&nbsp;103.5939102172851563</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div></div><div>以上测试的wal_level=hot_standby.</div><div>修改为minimal后重启数据库再次测试如下 :</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# drop table test;</font></div><div><font size="2"  >DROP TABLE</font></div><div><font size="2"  >postgres=# create table test(id int);</font></div><div><font size="2"  >CREATE TABLE</font></div><div><font size="2"  >postgres=# select * from pg_current_xlog_insert_location();</font></div><div><font size="2"  >&nbsp;pg_current_xlog_insert_location&nbsp;</font></div><div><font size="2"  >---------------------------------</font></div><div><font size="2"  >&nbsp;0/1AF3AB48</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=# insert into test select generate_series(1,1000000);</font></div><div><font size="2"  >INSERT 0 1000000</font></div><div><font size="2"  >postgres=# select * from pg_current_xlog_insert_location();</font></div><div><font size="2"  >&nbsp;pg_current_xlog_insert_location&nbsp;</font></div><div><font size="2"  >---------------------------------</font></div><div><font size="2"  >&nbsp;0/1EC81CC0</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=# select pg_xlog_location_diff('0/1EC81CC0','0/1AF3AB48')/1024/1024;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; ?column? &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >---------------------</font></div><div><font size="2"  >&nbsp;61.2777023315429688</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=# update test set id=1;</font></div><div><font size="2"  >LOG: &nbsp;checkpoints are occurring too frequently (2 seconds apart)</font></div><div><font size="2"  >HINT: &nbsp;Consider increasing the configuration parameter "checkpoint_segments".</font></div><div><font size="2"  >UPDATE 1000000</font></div><div><font size="2"  >postgres=# select * from pg_current_xlog_insert_location();</font></div><div><font size="2"  >&nbsp;pg_current_xlog_insert_location&nbsp;</font></div><div><font size="2"  >---------------------------------</font></div><div><font size="2"  >&nbsp;0/25419450</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=# select pg_xlog_location_diff('0/25419450','0/1EC81CC0')/1024/1024;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;?column? &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >----------------------</font></div><div><font size="2"  >&nbsp;103.5916900634765625</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>以上测试checkpoint_segments = 3, 修改为32然后reload数据库重新测试</div><div><pre class="prettyprint"  ><div><font size="2"  >postgres=# drop table test;</font></div><div><font size="2"  >DROP TABLE</font></div><div><font size="2"  >postgres=# checkpoint;</font></div><div><font size="2"  >CHECKPOINT</font></div><div><font size="2"  >postgres=# create table test(id int);</font></div><div><font size="2"  >CREATE TABLE</font></div><div><font size="2"  >postgres=# select * from pg_current_xlog_insert_location();</font></div><div><font size="2"  >&nbsp;pg_current_xlog_insert_location&nbsp;</font></div><div><font size="2"  >---------------------------------</font></div><div><font size="2"  >&nbsp;0/2977C148</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=# insert into test select generate_series(1,1000000);</font></div><div><font size="2"  >INSERT 0 1000000</font></div><div><font size="2"  >postgres=# select * from pg_current_xlog_insert_location();</font></div><div><font size="2"  >&nbsp;pg_current_xlog_insert_location&nbsp;</font></div><div><font size="2"  >---------------------------------</font></div><div><font size="2"  >&nbsp;0/2D4C25C0</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=# select pg_xlog_location_diff('0/2D4C25C0','0/2977C148')/1024/1024;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; ?column? &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >---------------------</font></div><div><font size="2"  >&nbsp;61.2745285034179688</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=# update test set id = 1;</font></div><div><font size="2"  >UPDATE 1000000</font></div><div><font size="2"  >postgres=# select * from pg_current_xlog_insert_location();</font></div><div><font size="2"  >&nbsp;pg_current_xlog_insert_location&nbsp;</font></div><div><font size="2"  >---------------------------------</font></div><div><font size="2"  >&nbsp;0/319983F0</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=# select pg_xlog_location_diff('0/319983F0','0/2D4C25C0')/1024/1024;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; ?column? &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >---------------------</font></div><div><font size="2"  >&nbsp;68.8354949951171875</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>测试CREATE TABLE AS语句产生多少xlog</div><div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >postgres=# drop table test2;</font></div><div><font size="2"  >DROP TABLE</font></div><div><font size="2"  >postgres=# select * from pg_current_xlog_insert_location();</font></div><div><font size="2"  >&nbsp;pg_current_xlog_insert_location&nbsp;</font></div><div><font size="2"  >---------------------------------</font></div><div><font size="2"  >&nbsp;0/3AC5C9B0</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=# create table test2 as select * from test;</font></div><div><font size="2"  >SELECT 1000000</font></div><div><font size="2"  >postgres=# select * from pg_current_xlog_insert_location();</font></div><div><font size="2"  >&nbsp;pg_current_xlog_insert_location&nbsp;</font></div><div><font size="2"  >---------------------------------</font></div><div><font size="2"  >&nbsp;0/3AC6C948</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=# select pg_xlog_location_diff('0/3AC6C948','0/3AC5C9B0')/1024/1024;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; ?column? &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >------------------------</font></div><div><font size="2"  >&nbsp;0.06240081787109375000</font></div><div><font size="2"  >(1 row)</font></div></div><div><font size="2"  >postgres=# select pg_total_relation_size('test2')/1024/1024;<br> ?column? <br>----------<br>       34<br>(1 row)</font></div><div></div><p></p></pre></div></div><div><br></div><div>【小结】</div><div>1. wal_level = minimal对某些操作可以减少WAL的写入. 具体如下</div><div><p style="font-size: 12px; line-height: 1.5em; margin-top: 1.2em; margin-right: 0em; margin-bottom: 1.2em; margin-left: 0em; font-family: verdana, sans-serif;"  >In&nbsp;<tt>minimal</tt>&nbsp;level, WAL-logging of some bulk operations can be safely skipped, which can make those operations much faster (see&nbsp;<a style="color: rgb(0, 78, 102); " rel="nofollow" href="http://www.postgresql.org/docs/devel/static/populate.html#POPULATE-PITR"  >Section 14.4.7</a>). Operations in which this optimization can be applied include:</p><table border="0"  style="margin-left: 2ex; color: rgb(0, 0, 0); font-family: verdana, sans-serif; font-size: 12px; line-height: normal; text-align: left;"  ><tbody><tr><td><tt>CREATE TABLE AS</tt></td></tr><tr><td><tt>CREATE INDEX</tt></td></tr><tr><td><tt>CLUSTER</tt></td></tr><tr><td><tt>COPY</tt>&nbsp;into tables that were created or truncated in the same transaction</td></tr></table>2. 使用大的checkpoint_segments可以有效的减少WAL的写入量, 原因是full_page_writes, 每次checkpoint之后第一次改变的page都要写FULL PAGE以便可以从WAL获取完整的恢复页面.</div><div><br></div><div><br></div><div>【参考】</div><div><a rel="nofollow" href="https://commitfest.postgresql.org/action/patch_view?id=776"  >https://commitfest.postgresql.org/action/patch_view?id=776</a> </div><div><a rel="nofollow" href="http://www.postgresql.org/docs/devel/static/functions-admin.html"  >http://www.postgresql.org/docs/devel/static/functions-admin.html</a> </div></div>
	</div>
</div>
</body>
</html>