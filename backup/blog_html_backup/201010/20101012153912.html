<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Differ Between PostgreSQL's pg_cancel_backend pg_terminate_backend function</h2>
	<h5 id="">2010-10-12 15:39:12&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020109123046885/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><tt> <p>pg_cancel_backend 作用是退出事务（所有未提交的信息回滚），但是不退出SESSION；</p> <p><font face="新宋体"  >pg_terminate_backend 作用是退出session（所有未提交的信息回滚）。</font></p> <p><font face="新宋体"  >测试结果如下:</font></p> <p><font face="新宋体"  >Server1:</font></p> <p>mrp_url=&gt; create table tbl_test (id int);<br>CREATE TABLE<br>mrp_url=&gt; begin ;<br>BEGIN<br>mrp_url=&gt; insert into tbl_test values(1);<br>INSERT 0 1<br>mrp_url=&gt; select * from tbl_test;<br>&nbsp;id <br>----<br>&nbsp; 1<br>(1 row)</p> <p>mrp_url=&gt; insert into tbl_test select generate_series(2,10000000);</p> <p><font face="新宋体"  >Server2(Server1正在写入记录):</font></p> <p><font face="新宋体"  >mrp_url=# select * from pg_stat_activity;</font></p> <p>&nbsp;datid | datname | procpid | usesysid | usename&nbsp; | application_name |&nbsp;&nbsp; client_addr&nbsp;&nbsp; | client_port |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; backend_start&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; xact_start&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; query_start&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | waiting |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; current_query&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>-------+---------+---------+----------+----------+------------------+-----------------+-------------+-------------------------------<br>+-------------------------------+-------------------------------+---------+---------------------------------------------------------<br>-------------------------------------------------------------------------------------------------------------------------</p> <p>&nbsp;16389 | mrp_url |&nbsp;&nbsp;&nbsp; 3253 |&nbsp;&nbsp;&nbsp; 16384 | mrp_url&nbsp; | psql&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 127.0.0.1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 23633 | 2010-10-12 14:51:01.119572+08 <br>| 2010-10-12 14:53:21.350747+08 | 2010-10-12 14:53:30.179774+08 | f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | insert into tbl_test select generate_series(2,10000000);</p> <p>mrp_url=# select pg_cancel_backend(3253);<br>&nbsp;pg_cancel_backend <br>-------------------<br>&nbsp;t<br>(1 row)</p><font face="新宋体"  >Server1(接收到canceling statement due to user request消息,输入查询语句无效,commit提示回滚):</font> <p>ERROR:&nbsp; canceling statement due to user request<br>mrp_url=&gt; select * from tbl_test;<br>ERROR:&nbsp; current transaction is aborted, commands ignored until end of transaction block<br>mrp_url=&gt; commit;<br>ROLLBACK</p> <p>Server2(查看Server1的SESSION并没有退出):</p> <p>mrp_url=# select * from pg_stat_activity;<br>&nbsp;datid | datname | procpid | usesysid | usename&nbsp; | application_name |&nbsp;&nbsp; client_addr&nbsp;&nbsp; | client_port |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; backend_start&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; xact_start&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; query_start&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | waiting |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; current_query&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br>-------+---------+---------+----------+----------+------------------+-----------------+-------------+-------------------------------<br>+-------------------------------+-------------------------------+---------+---------------------------------------------------------<br>-------------------------------------------------------------------------------------------------------------------------</p> <p>16389 | mrp_url |&nbsp;&nbsp;&nbsp; 3253 |&nbsp;&nbsp;&nbsp; 16384 | mrp_url&nbsp; | psql&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 127.0.0.1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 23633 | 2010-10-12 14:51:01.119572+08 <br>| 2010-10-12 14:53:21.350747+08 | 2010-10-12 14:53:30.179774+08 | f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | &lt;IDLE&gt;</p> <p>pg_terminate_backend测试:</p> <p>Server1:</p> <p>mrp_url=&gt; begin;<br>BEGIN<br>mrp_url=&gt; insert into tbl_Test values(1);<br>INSERT 0 1<br>mrp_url=&gt; insert into tbl_test select generate_series(2,10000000);</p> <p>Server2:</p> <p>postgres=# select pg_terminate_backend(4044);<br>&nbsp;pg_terminate_backend <br>----------------------<br>&nbsp;t<br>(1 row)</p> <p>Server1():</p> <p>FATAL:&nbsp; terminating connection due to administrator command<br>server closed the connection unexpectedly<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; This probably means the server terminated abnormally<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; before or while processing the request.<br>The connection to the server was lost. Attempting reset: Succeeded.<br>mrp_url=&gt; select pg_total_relation_size('tbl_test')/1024/1024;<br>&nbsp;?column? <br>----------<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 249<br>(1 row)</p> <p>mrp_url=&gt; select * from tbl_Test;<br>&nbsp;id <br>----<br>(0 rows)</p> <p>mrp_url=&gt; vacuum full tbl_test;<br>VACUUM<br>mrp_url=&gt; select * from tbl_Test;<br>&nbsp;id <br>----<br>(0 rows)</p> <p>mrp_url=&gt; select pg_total_relation_size('tbl_test')/1024/1024;<br>&nbsp;?column? <br>----------<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<br>(1 row)</p> <p>Server2:</p> <p>&nbsp;16389 | mrp_url&nbsp; |&nbsp;&nbsp;&nbsp; 4092 |&nbsp;&nbsp;&nbsp; 16384 | mrp_url&nbsp; | psql&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 127.0.0.1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 18986 | 2010-10-12 15:36:32.240069+08<br>&nbsp;|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | 2010-10-12 15:36:57.470988+08 | f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | &lt;IDLE&gt;</p> <p>（server1被terminate后自动重连，PROCPID已经改变）</p> <p><font face="新宋体"  >官方文档解释:</font></p></tt> <p>PostgreSQL : </p> <p> <table border="1"  > <thead> <tr> <th>Name</th> <th>Return Type</th> <th>Description</th></tr></thead> <tbody> <tr> <td><tt><code><font face="NSimsun"  >pg_cancel_backend(<tt>pid</tt> <tt>int</tt>)</font></code></tt> </td> <td><tt><font face="NSimsun"  >boolean</font></tt></td> <td>Cancel a backend's current query</td></tr> <tr> <td><tt><code><font face="NSimsun"  >pg_terminate_backend(<tt>pid</tt> <tt>int</tt>)</font></code></tt> </td> <td><tt><font face="NSimsun"  >boolean</font></tt></td> <td>Terminate a backend</td></tr></table></p> <p><font face="NSimsun"  >pg_cancel_backend</font> and <code><font face="NSimsun"  >pg_terminate_backend</font></code> send signals (<span>SIGINT</span> or <span>SIGTERM</span> respectively) to backend processes identified by process ID. The process ID of an active backend can be found from the <tt><font face="NSimsun"  >procpid</font></tt> column of the <tt><font face="NSimsun"  >pg_stat_activity</font></tt> view, or by listing the <tt><font face="NSimsun"  >postgres</font></tt> processes on the server (using <span>ps</span> on Unix or the <span>Task Manager</span> on <span>Windows.</span></p> <p>Oracle : </p> <p>alter system 子句 :</p> <p>DISCONNECT SESSION Clause <a id="sthref3339" name="sthref3339" rel="nofollow"  ></a><a id="sthref3340" name="sthref3340" rel="nofollow"  ></a><a id="sthref3341" name="sthref3341" rel="nofollow"  ></a></p> <p>Use the <code><font face="NSimsun"  >DISCONNECT</font></code> <code><font face="NSimsun"  >SESSION</font></code> clause to disconnect the current session by destroying the dedicated server process (or virtual circuit if the connection was made by way of a Shared Sever). To use this clause, your instance must have the database open. You must identify the session with both of the following values from the <code><font face="NSimsun"  >V$SESSION</font></code> view:</p> <ul> <li> <p>For <code><span><font face="NSimsun"  >integer1</font></span></code>, specify the value of the <code><font face="NSimsun"  >SID</font></code> column.</p></li> <li> <p>For <code><span><font face="NSimsun"  >integer2</font></span></code>, specify the value of the <code><font face="NSimsun"  >SERIAL#</font></code> column.</p></li></ul> <p>If system parameters are appropriately configured, then application failover will take effect.</p> <ul> <li> <p>The <code><font face="NSimsun"  >POST_TRANSACTION</font></code> setting allows ongoing transactions to complete before the session is disconnected. If the session has no ongoing transactions, then this clause has the same effect described for as <code><font face="NSimsun"  >KILL</font></code> <code><font face="NSimsun"  >SESSION</font></code>.</p></li> <li> <p>The <code><font face="NSimsun"  >IMMEDIATE</font></code> setting disconnects the session and recovers the entire session state immediately, without waiting for ongoing transactions to complete.</p> <ul> <li> <p>If you also specify <code><font face="NSimsun"  >POST_TRANSACTION</font></code> and the session has ongoing transactions, then the <code><font face="NSimsun"  >IMMEDIATE</font></code> keyword is ignored.</p></li> <li> <p>If you do not specify <code><font face="NSimsun"  >POST_TRANSACTION</font></code>, or you specify <code><font face="NSimsun"  >POST_TRANSACTION</font></code> but the session has no ongoing transactions, then this clause has the same effect as described for <code><font face="NSimsun"  >KILL</font></code> <code><font face="NSimsun"  >SESSION</font></code> <code><font face="NSimsun"  >IMMEDIATE</font></code>.</p> <div> <p>See Also:</p><a rel="nofollow" href="file:///D:/%E6%96%B0%E5%BB%BA%E6%96%87%E4%BB%B6%E5%A4%B9/zzz_bak/soft_win/oracle%20online%20document/11gr2_doc_%20E11882_01/E11882_01/server.112/e17118/statements_2014.htm#i2198603"  >"Disconnecting a Session: Example"</a></div></li></ul></li></ul><a id="i2065117" name="i2065117" rel="nofollow"  ></a><a id="SQLRF53115" name="SQLRF53115" rel="nofollow"  ></a> <p>KILL SESSION Clause <a id="sthref3342" name="sthref3342" rel="nofollow"  ></a><a id="sthref3343" name="sthref3343" rel="nofollow"  ></a><a id="sthref3344" name="sthref3344" rel="nofollow"  ></a><a id="sthref3345" name="sthref3345" rel="nofollow"  ></a><a id="sthref3346" name="sthref3346" rel="nofollow"  ></a></p> <p>The <code><font face="NSimsun"  >KILL</font></code> <code><font face="NSimsun"  >SESSION</font></code> clause lets you mark a session as terminated, roll back ongoing transactions, release all session locks, and partially recover session resources. To use this clause, your instance must have the database open. Your session and the session to be terminated must be on the same instance unless you specify <code><span><font face="NSimsun"  >integer3</font></span></code>.You must identify the session with the following values from the <code><font face="NSimsun"  >V$SESSION</font></code> view:</p> <ul> <li> <p>For <code><span><font face="NSimsun"  >integer1</font></span></code>, specify the value of the <code><font face="NSimsun"  >SID</font></code> column.</p></li> <li> <p>For <code><span><font face="NSimsun"  >integer2</font></span></code>, specify the value of the <code><font face="NSimsun"  >SERIAL#</font></code> column.</p></li> <li> <p>For the optional <code><span><font face="NSimsun"  >integer3</font></span></code>, specify the ID of the instance where the target session to be killed exists. You can find the instance ID by querying the GV$ tables.</p></li></ul> <p>If the session is performing some activity that must be completed, such as waiting for a reply from a remote database or rolling back a transaction, then Oracle Database waits for this activity to complete, marks the session as terminated, and then returns control to you. If the waiting lasts a minute, then Oracle Database marks the session to be terminated and returns control to you with a message that the session is marked to be terminated. The <code><font face="NSimsun"  >PMON</font></code> background process then marks the session as terminated when the activity is complete.</p> <p>Whether or not the session has an ongoing transaction, Oracle Database does not recover the entire session state until the session user issues a request to the session and receives a message that the session has been terminated.</p> <div> <p>See Also:</p><a rel="nofollow" href="file:///D:/%E6%96%B0%E5%BB%BA%E6%96%87%E4%BB%B6%E5%A4%B9/zzz_bak/soft_win/oracle%20online%20document/11gr2_doc_%20E11882_01/E11882_01/server.112/e17118/statements_2014.htm#i2260288"  >"Terminating a Session: Example"</a></div><a id="SQLRF53116" name="SQLRF53116" rel="nofollow"  ></a> <p><span>IMMEDIATE&nbsp;</span>Specify <code><font face="NSimsun"  >IMMEDIATE</font></code> to instruct Oracle Database to roll back ongoing transactions, release all session locks, recover the entire session state, and return control to you immediately.</p></div>
	</div>
</div>
</body>
</html>