<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Londiste 3 replicate case - 1 上节</h2>
	<h5 id="">2012-05-30 17:13:38&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201243051338137/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>前面讲解过Londiste3的安装, 有不了解的朋友可以参考如下BLOG:</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201242945632912/"  >http://blog.163.com/digoal@126/blog/static/163877040201242945632912/</a> </div><div>今天将介绍一下使用londiste3, 从PostgreSQL 9.1.3 复制表以及序列到PostgreSQL 9.2beta1. (这种场景的复制使用PostgreSQL的流复制是办不到的.目前使用slony也是无法做到的,因为slony和PostgreSQL的版本相关, 目前还没有支持PostgreSQL9.2的版本. 正因为slony对版本要求较高, 相对没有londiste灵活, 所以我选择了londiste作为跨数据库版本的复制工具)</div><div>londiste3支持合并复制,级联复制等. 合并复制是只可以把多个数据库的表复制到同一个目标表中, 常用在plproxy分区的数据库集群环境中, 同时londiste还支持部分复制, 即复制的源可以带where条件. 支持源和目标的库名不一样, 表名不一样, schema_name不一样, 支持自定义handler等. 功能非常强大. 这一切都基于PostgreSQL queue技术.</div><div>以后再讲解londiste3的合并复制和级联复制等.</div><div>一、测试环境 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >源库 :&nbsp;</font></div><div><font size="2"  >PostgreSQL 9.1.3</font></div><div><font size="2"  >host=172.16.3.176 port=1921 user=digoal_01 dbname=digoal_01</font></div><div><font size="2"  >4个表,2个序列</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >目标库1 :&nbsp;</font></div><div><font size="2"  >PostgreSQL 9.2 beta1</font></div><div><font size="2"  ><span style="line-height: 22px;"  >host=172.16.3.33 port=1919 user=digoal_01 dbname=digoal_01</span> </font></div><div><font size="2"  ><span style="line-height: 22px;"  >复制4个表,2个序列</span> </font></div><div><font size="2"  ><br></font></div><div><font size="2"  >目标库2 :&nbsp;</font></div><div><div style="line-height: 22px;"  ><font size="2"  >PostgreSQL 9.2 beta1</font></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  ><font size="2"  >host=172.16.3.33 port=1919 user=digoal_02 dbname=digoal_02</font></span></div></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  ><font size="2"  >复制2个表,2个序列, 但是只复制userid&lt;1000的记录</font></span></div><p></p></pre></div><div><br></div><div>二、源库测试模型建立</div><div>源库的测试模型基于我前面写的《PostgreSQL性能优化综合案例讲解》, &nbsp;如下 :&nbsp;</div><div><div>PostgreSQL性能优化综合案例讲解 - 1</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201221382150858/"  >http://blog.163.com/digoal@126/blog/static/163877040201221382150858/</a></div><div>PostgreSQL性能优化综合案例讲解 - 2</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201221333411196/"  >http://blog.163.com/digoal@126/blog/static/163877040201221333411196/</a></div></div><div><br></div><div>-- 创建测试用户和测试库</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; psql</font></div><div><font size="2"  >psql (9.1.3)</font></div><div><font size="2"  >Type "help" for help.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=# create role digoal_01 nosuperuser nocreatedb nocreaterole noinherit login encrypted password 'digoal_01';</font></div><div><font size="2"  >CREATE ROLE</font></div><div><font size="2"  >postgres=# create database digoal_01 encoding 'UTF8' template template0 owner digoal_01;</font></div><div><font size="2"  >CREATE DATABASE</font></div><div><font size="2"  >postgres=# \c digoal_01 digoal_01</font></div><div><font size="2"  >You are now connected to database "digoal_01" as user "digoal_01".</font></div><div><font size="2"  >digoal_01=&gt; create schema digoal_01 authorization digoal_01;</font></div><div><font size="2"  >CREATE SCHEMA</font></div><p></p></pre></div><div><br></div><div>-- 创建测试表</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create table user_info</font></div><div><font size="2"  >(userid int,</font></div><div><font size="2"  >engname text,</font></div><div><font size="2"  >cnname text,</font></div><div><font size="2"  >occupation text,</font></div><div><font size="2"  >birthday date,</font></div><div><font size="2"  >signname text,</font></div><div><font size="2"  >email text,</font></div><div><font size="2"  >qq numeric,</font></div><div><font size="2"  >crt_time timestamp without time zone,</font></div><div><font size="2"  >mod_time timestamp without time zone</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table user_session</font></div><div><font size="2"  >(userid int,</font></div><div><font size="2"  >logintime timestamp(0) without time zone,</font></div><div><font size="2"  >login_count bigint default 0,</font></div><div><font size="2"  >logouttime timestamp(0) without time zone,</font></div><div><font size="2"  >online_interval interval default interval '0'</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table user_login_rec</font></div><div><font size="2"  >(userid int,</font></div><div><font size="2"  >login_time timestamp without time zone,</font></div><div><font size="2"  >ip inet</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table user_logout_rec</font></div><div><font size="2"  >(userid int,</font></div><div><font size="2"  >logout_time timestamp without time zone,</font></div><div><font size="2"  >ip inet</font></div><div><font size="2"  >);</font></div><p></p></pre></div><div><br></div><div>-- 初始化数据</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >insert into user_info (userid,engname,cnname,occupation,birthday,signname,email,qq,crt_time,mod_time)</font></div><div><font size="2"  >select generate_series(1,200000),</font></div><div><font size="2"  >'digoal.zhou',</font></div><div><font size="2"  >'德哥',</font></div><div><font size="2"  >'DBA',</font></div><div><font size="2"  >'1970-01-01'</font></div><div><font size="2"  >,E'公益是一辈子的事, I\'m Digoal.Zhou, Just do it!',</font></div><div><font size="2"  >'digoal@126.com',</font></div><div><font size="2"  >276732431,</font></div><div><font size="2"  >clock_timestamp(),</font></div><div><font size="2"  >NULL;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >insert into user_session (userid) select generate_series(1,200000);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >set work_mem='2048MB';</font></div><div><font size="2"  >set maintenance_work_mem='2048MB';</font></div><div><font size="2"  >alter table user_info add constraint pk_user_info primary key (userid);</font></div><div><font size="2"  >alter table user_session add constraint pk_user_session primary key (userid);</font></div><p></p></pre></div><div><br></div><div>-- 业务函数</div><div>-- 模拟用户登录的函数</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function f_user_login&nbsp;</font></div><div><font size="2"  >(i_userid int,</font></div><div><font size="2"  >OUT o_userid int,</font></div><div><font size="2"  >OUT o_engname text,</font></div><div><font size="2"  >OUT o_cnname text,</font></div><div><font size="2"  >OUT o_occupation text,</font></div><div><font size="2"  >OUT o_birthday date,</font></div><div><font size="2"  >OUT o_signname text,</font></div><div><font size="2"  >OUT o_email text,</font></div><div><font size="2"  >OUT o_qq numeric</font></div><div><font size="2"  >)</font></div><div><font size="2"  >as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >select userid,engname,cnname,occupation,birthday,signname,email,qq</font></div><div><font size="2"  >into o_userid,o_engname,o_cnname,o_occupation,o_birthday,o_signname,o_email,o_qq</font></div><div><font size="2"  >from user_info where userid=i_userid;</font></div><div><font size="2"  >insert into user_login_rec (userid,login_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div><font size="2"  >update user_session set logintime=now(),login_count=login_count+1 where userid=i_userid;</font></div><div><font size="2"  >return;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$BODY$</font></div><div><font size="2"  >language plpgsql;</font></div><p></p></pre></div><div>-- 模拟用户退出的函数</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function f_user_logout</font></div><div><font size="2"  >(i_userid int,</font></div><div><font size="2"  >OUT o_result int</font></div><div><font size="2"  >)</font></div><div><font size="2"  >as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >insert into user_logout_rec (userid,logout_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div><font size="2"  >update user_session set logouttime=now(),online_interval=online_interval+(now()-logintime) where userid=i_userid;</font></div><div><font size="2"  >o_result := 0;</font></div><div><font size="2"  >return;</font></div><div><font size="2"  >exception&nbsp;</font></div><div><font size="2"  >when others then</font></div><div><font size="2"  >o_result := 1;</font></div><div><font size="2"  >return;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$BODY$</font></div><div><font size="2"  >language plpgsql;</font></div><p></p></pre></div><div><br></div><div>三、准备目标库1, (注意londiste的复制需要表上有主键.所以两个日志表一会在添加的时候会报错, 因为没有主键)</div><div>-- 创建测试用户和测试库</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >PostgreSQL 9.2beta1</font></div><div><font size="2"  >host=172.16.3.33 port=1919 user=digoal_01 dbname=digoal_01</font></div><div><font size="2"  >pg92@db-172-16-3-33-&gt; psql postgres postgres</font></div><div><font size="2"  >psql (9.2beta1)</font></div><div><font size="2"  >Type "help" for help.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=# create role digoal_01 nosuperuser nocreatedb nocreaterole noinherit login encrypted password 'digoal_01';</font></div><div><font size="2"  >CREATE ROLE</font></div><div><font size="2"  >postgres=# create database digoal_01 encoding 'UTF8' template template0 owner digoal_01;</font></div><div><font size="2"  >CREATE DATABASE</font></div><div><font size="2"  >postgres=# \c digoal_01 digoal_01</font></div><div><font size="2"  >You are now connected to database "digoal_01" as user "digoal_01".</font></div><div><font size="2"  >digoal_01=&gt; create schema digoal_01 authorization digoal_01;</font></div><div><font size="2"  >CREATE SCHEMA</font></div><p></p></pre></div><div><br></div><div>-- 创建测试表</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create table user_info</font></div><div><font size="2"  >(userid int,</font></div><div><font size="2"  >engname text,</font></div><div><font size="2"  >cnname text,</font></div><div><font size="2"  >occupation text,</font></div><div><font size="2"  >birthday date,</font></div><div><font size="2"  >signname text,</font></div><div><font size="2"  >email text,</font></div><div><font size="2"  >qq numeric,</font></div><div><font size="2"  >crt_time timestamp without time zone,</font></div><div><font size="2"  >mod_time timestamp without time zone</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table user_session</font></div><div><font size="2"  >(userid int,</font></div><div><font size="2"  >logintime timestamp(0) without time zone,</font></div><div><font size="2"  >login_count bigint default 0,</font></div><div><font size="2"  >logouttime timestamp(0) without time zone,</font></div><div><font size="2"  >online_interval interval default interval '0'</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table user_login_rec</font></div><div><font size="2"  >(userid int,</font></div><div><font size="2"  >login_time timestamp without time zone,</font></div><div><font size="2"  >ip inet</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table user_logout_rec</font></div><div><font size="2"  >(userid int,</font></div><div><font size="2"  >logout_time timestamp without time zone,</font></div><div><font size="2"  >ip inet</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >alter table user_info add constraint pk_user_info primary key (userid);</font></div><div><font size="2"  >alter table user_session add constraint pk_user_session primary key (userid);</font></div><p></p></pre></div><div><br></div><div><br></div><div><div style="line-height: 22px;"  >四、准备目标库2, (目标库2里面只复制了两个用户相关的表, 都有主键.)</div><div style="line-height: 22px;"  >-- 创建测试用户和测试库</div><div><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >PostgreSQL 9.2beta1</font></div><div style="line-height: 22px;"  ><font size="2"  >host=172.16.3.33 port=1919 user=digoal_02 dbname=digoal_02</font></div><div style="line-height: 22px;"  ><font size="2"  >pg92@db-172-16-3-33-&gt; psql postgres postgres</font></div><div style="line-height: 22px;"  ><font size="2"  >psql (9.2beta1)</font></div><div style="line-height: 22px;"  ><font size="2"  >Type "help" for help.</font></div><div style="line-height: 22px;"  ><font size="2"  ><br style="line-height: 22px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  >postgres=# create role digoal_02 nosuperuser nocreatedb nocreaterole noinherit login encrypted password 'digoal_02';</font></div><div style="line-height: 22px;"  ><font size="2"  >CREATE ROLE</font></div><div style="line-height: 22px;"  ><font size="2"  >postgres=# create database digoal_02 encoding 'UTF8' template template0 owner digoal_02;</font></div><div style="line-height: 22px;"  ><font size="2"  >CREATE DATABASE</font></div><div style="line-height: 22px;"  ><font size="2"  >postgres=# \c digoal_02 digoal_02</font></div><div style="line-height: 22px;"  ><font size="2"  >You are now connected to database "digoal_02" as user "digoal_02".</font></div><div style="line-height: 22px;"  ><font size="2"  >digoal_01=&gt; create schema digoal_02 authorization digoal_02;</font></div><div style="line-height: 22px;"  ><font size="2"  >CREATE SCHEMA</font></div><p></p></pre></div><div style="line-height: 22px;"  ><br style="line-height: 22px;"  ></div><div style="line-height: 22px;"  >-- 创建测试表</div><div><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >create table user_info1</font></div><div style="line-height: 22px;"  ><font size="2"  >(userid int,</font></div><div style="line-height: 22px;"  ><font size="2"  >engname text,</font></div><div style="line-height: 22px;"  ><font size="2"  >cnname text,</font></div><div style="line-height: 22px;"  ><font size="2"  >occupation text,</font></div><div style="line-height: 22px;"  ><font size="2"  >birthday date,</font></div><div style="line-height: 22px;"  ><font size="2"  >signname text,</font></div><div style="line-height: 22px;"  ><font size="2"  >email text,</font></div><div style="line-height: 22px;"  ><font size="2"  >qq numeric,</font></div><div style="line-height: 22px;"  ><font size="2"  >crt_time timestamp without time zone,</font></div><div style="line-height: 22px;"  ><font size="2"  >mod_time timestamp without time zone</font></div><div style="line-height: 22px;"  ><font size="2"  >);</font></div><div style="line-height: 22px;"  ><font size="2"  ><br style="line-height: 22px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  >create table user_session1</font></div><div style="line-height: 22px;"  ><font size="2"  >(userid int,</font></div><div style="line-height: 22px;"  ><font size="2"  >logintime timestamp(0) without time zone,</font></div><div style="line-height: 22px;"  ><font size="2"  >login_count bigint default 0,</font></div><div style="line-height: 22px;"  ><font size="2"  >logouttime timestamp(0) without time zone,</font></div><div style="line-height: 22px;"  ><font size="2"  >online_interval interval default interval '0'</font></div><div style="line-height: 22px;"  ><font size="2"  >);</font></div><div style="line-height: 22px;"  ><font size="2"  ><br style="line-height: 22px;"  ></font></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  ><font size="2"  >alter table user_info1 add constraint pk_user_info primary key (userid);</font></span></div><div style="line-height: 22px;"  ><font size="2"  >alter table user_session1 add constraint pk_user_session primary key (userid);</font></div><p></p></pre></div><div style="line-height: 22px;"  ><br></div></div><div>五、从主库复制到目标库1</div><div>&nbsp; &nbsp; &nbsp;本次测试中我们把pgq, provider, consumer进程都放在主库, 当然这些都可以放在其他服务器上, 甚至不在主库和目标库的服务器上都行. 只要允许连接到数据库.</div><div><br></div><div>-- 主库服务器上配置如下</div><div>-- 配置放londiste配置文件的目录以及日志目录和pid文件目录.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >mkdir -p /home/postgres/londiste3/log</font></div><div><font size="2"  >mkdir -p /home/postgres/londiste3/pid</font></div><p></p></pre></div><div><br></div><div>-- 创建provider进程的配置文件, 配置文件模板可参考 londiste3 --ini的输出</div><div>-- 注意db里面我配置了password, 如果你使用的是trust认证或者使用了.pgpass文件, 这里就不需要配密码了.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >vi /home/postgres/londiste3/src_digoal_01.ini</font></div><div><font size="2"  >[londiste3]</font></div><div><font size="2"  >job_name = src_digoal_01</font></div><div><font size="2"  >db = host=172.16.3.176 port=1921 user=postgres dbname=digoal_01 password=postgres</font></div><div><font size="2"  >queue_name = replika</font></div><div><font size="2"  >logfile = /home/postgres/londiste3/log/src_digoal_01.log</font></div><div><font size="2"  >pidfile = /home/postgres/londiste3/pid/src_digoal_01.pid</font></div><p></p></pre></div><div><br></div><div>-- 配置好provider 后, 就可以创建根节点了.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; londiste3 -v /home/postgres/londiste3/src_digoal_01.ini create-root src_digoal_01 "host=172.16.3.176 port=1921 user=postgres dbname=digoal_01 password=postgres"</font></div><div><font size="2"  >2012-05-30 21:32:36,847 9378 DEBUG Connect 'new_node' to 'host=172.16.3.176 port=1921 user=postgres dbname=digoal_01 &nbsp;[...]'</font></div><div><font size="2"  >2012-05-30 21:32:36,853 9378 INFO plpgsql is installed</font></div><div><font size="2"  >2012-05-30 21:32:36,853 9378 INFO Installing pgq</font></div><div><font size="2"  >2012-05-30 21:32:36,853 9378 INFO &nbsp; Reading from /opt/skytools3.0.2/share/skytools3/pgq.sql</font></div><div><font size="2"  >2012-05-30 21:32:37,339 9378 INFO pgq.get_batch_cursor is installed</font></div><div><font size="2"  >2012-05-30 21:32:37,339 9378 INFO Installing pgq_ext</font></div><div><font size="2"  >2012-05-30 21:32:37,339 9378 INFO &nbsp; Reading from /opt/skytools3.0.2/share/skytools3/pgq_ext.sql</font></div><div><font size="2"  >2012-05-30 21:32:37,568 9378 INFO Installing pgq_node</font></div><div><font size="2"  >2012-05-30 21:32:37,569 9378 INFO &nbsp; Reading from /opt/skytools3.0.2/share/skytools3/pgq_node.sql</font></div><div><font size="2"  >2012-05-30 21:32:37,839 9378 INFO Installing londiste</font></div><div><font size="2"  >2012-05-30 21:32:37,839 9378 INFO &nbsp; Reading from /opt/skytools3.0.2/share/skytools3/londiste.sql</font></div><div><font size="2"  >2012-05-30 21:32:38,117 9378 INFO londiste.global_add_table is installed</font></div><div><font size="2"  >2012-05-30 21:32:38,118 9378 DEBUG exec_query: select * from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-05-30 21:32:38,121 9378 INFO Initializing node</font></div><div><font size="2"  >2012-05-30 21:32:38,121 9378 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'src_digoal_01', 'host=172.16.3.176 port=1921 user=postgres dbname=digoal_01 password=postgres', false)</font></div><div><font size="2"  >2012-05-30 21:32:38,122 9378 INFO Location registered</font></div><div><font size="2"  >2012-05-30 21:32:38,122 9378 DEBUG exec_cmd: select * from pgq_node.create_node('replika', 'root', 'src_digoal_01', 'src_digoal_01', null, null, null)</font></div><div><font size="2"  >2012-05-30 21:32:38,377 9378 INFO Node "src_digoal_01" initialized for queue "replika" with type "root"</font></div><div><font size="2"  >2012-05-30 21:32:38,378 9378 INFO Done</font></div><p></p></pre></div><div><br></div><div>-- 根节点创建完, 连接到主库的digoal_01库下面, 会看到多了几个schema: londiste, pgq, pgq_ext, pgq_node 这些都是londiste3套件新增的schema, 用于完成复制所必须的.&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# \c digoal_01 digoal_01</font></div><div><font size="2"  >You are now connected to database "digoal_01" as user "digoal_01".</font></div><div><font size="2"  >digoal_01=&gt; \dn</font></div><div><font size="2"  >&nbsp; &nbsp; List of schemas</font></div><div><font size="2"  >&nbsp; &nbsp;Name &nbsp; &nbsp;| &nbsp; Owner &nbsp;&nbsp;</font></div><div><font size="2"  >-----------+-----------</font></div><div><font size="2"  >&nbsp;digoal_01 | digoal_01</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| postgres</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | postgres</font></div><div><font size="2"  >&nbsp;pgq_ext &nbsp; | postgres</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| postgres</font></div><div><font size="2"  >&nbsp;public &nbsp; &nbsp;| postgres</font></div><div><font size="2"  >(6 rows)</font></div><p></p></pre></div><div>-- 以下则是新增的这些schema下面的对象,&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal_01=&gt; select nspname,relkind,relname from pg_class,pg_namespace where relnamespace=pg_namespace.oid and relnamespace in (select oid from pg_namespace where nspname in ('londiste','pgq','pgq_ext','pgq_node','public','digoal_01')) order by relnamespace,relkind,relname;</font></div><div><font size="2"  >&nbsp; nspname &nbsp;| relkind | &nbsp; &nbsp; &nbsp; &nbsp; relname &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >-----------+---------+-------------------------</font></div><div><font size="2"  >&nbsp;digoal_01 | i &nbsp; &nbsp; &nbsp; | pk_user_info</font></div><div><font size="2"  >&nbsp;digoal_01 | i &nbsp; &nbsp; &nbsp; | pk_user_session</font></div><div><font size="2"  >&nbsp;digoal_01 | r &nbsp; &nbsp; &nbsp; | user_info</font></div><div><font size="2"  >&nbsp;digoal_01 | r &nbsp; &nbsp; &nbsp; | user_login_rec</font></div><div><font size="2"  >&nbsp;digoal_01 | r &nbsp; &nbsp; &nbsp; | user_logout_rec</font></div><div><font size="2"  >&nbsp;digoal_01 | r &nbsp; &nbsp; &nbsp; | user_session</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | S &nbsp; &nbsp; &nbsp; | batch_id_seq</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | S &nbsp; &nbsp; &nbsp; | consumer_co_id_seq</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | S &nbsp; &nbsp; &nbsp; | event_1_id_seq</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | S &nbsp; &nbsp; &nbsp; | event_1_tick_seq</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | S &nbsp; &nbsp; &nbsp; | queue_queue_id_seq</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | S &nbsp; &nbsp; &nbsp; | subscription_sub_id_seq</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | i &nbsp; &nbsp; &nbsp; | consumer_name_uq</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | i &nbsp; &nbsp; &nbsp; | consumer_pkey</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | i &nbsp; &nbsp; &nbsp; | event_1_0_txid_idx</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | i &nbsp; &nbsp; &nbsp; | event_1_1_txid_idx</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | i &nbsp; &nbsp; &nbsp; | event_1_2_txid_idx</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | i &nbsp; &nbsp; &nbsp; | queue_name_uq</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | i &nbsp; &nbsp; &nbsp; | queue_pkey</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | i &nbsp; &nbsp; &nbsp; | rq_pkey</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | i &nbsp; &nbsp; &nbsp; | rq_retry_idx</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | i &nbsp; &nbsp; &nbsp; | subscription_batch_idx</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | i &nbsp; &nbsp; &nbsp; | subscription_pkey</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | i &nbsp; &nbsp; &nbsp; | tick_pkey</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | r &nbsp; &nbsp; &nbsp; | consumer</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | r &nbsp; &nbsp; &nbsp; | event_1</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | r &nbsp; &nbsp; &nbsp; | event_1_0</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | r &nbsp; &nbsp; &nbsp; | event_1_1</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | r &nbsp; &nbsp; &nbsp; | event_1_2</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | r &nbsp; &nbsp; &nbsp; | event_template</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | r &nbsp; &nbsp; &nbsp; | queue</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | r &nbsp; &nbsp; &nbsp; | retry_queue</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | r &nbsp; &nbsp; &nbsp; | subscription</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | r &nbsp; &nbsp; &nbsp; | tick</font></div><div><font size="2"  >&nbsp;pgq_ext &nbsp; | i &nbsp; &nbsp; &nbsp; | completed_batch_pkey</font></div><div><font size="2"  >&nbsp;pgq_ext &nbsp; | i &nbsp; &nbsp; &nbsp; | completed_event_pkey</font></div><div><font size="2"  >&nbsp;pgq_ext &nbsp; | i &nbsp; &nbsp; &nbsp; | completed_tick_pkey</font></div><div><font size="2"  >&nbsp;pgq_ext &nbsp; | i &nbsp; &nbsp; &nbsp; | partial_batch_pkey</font></div><div><font size="2"  >&nbsp;pgq_ext &nbsp; | r &nbsp; &nbsp; &nbsp; | completed_batch</font></div><div><font size="2"  >&nbsp;pgq_ext &nbsp; | r &nbsp; &nbsp; &nbsp; | completed_event</font></div><div><font size="2"  >&nbsp;pgq_ext &nbsp; | r &nbsp; &nbsp; &nbsp; | completed_tick</font></div><div><font size="2"  >&nbsp;pgq_ext &nbsp; | r &nbsp; &nbsp; &nbsp; | partial_batch</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| i &nbsp; &nbsp; &nbsp; | local_state_pkey</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| i &nbsp; &nbsp; &nbsp; | node_info_pkey</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| i &nbsp; &nbsp; &nbsp; | node_location_pkey</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| i &nbsp; &nbsp; &nbsp; | subscriber_info_pkey</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| r &nbsp; &nbsp; &nbsp; | local_state</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| r &nbsp; &nbsp; &nbsp; | node_info</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| r &nbsp; &nbsp; &nbsp; | node_location</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| r &nbsp; &nbsp; &nbsp; | subscriber_info</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| S &nbsp; &nbsp; &nbsp; | seq_info_nr_seq</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| S &nbsp; &nbsp; &nbsp; | table_info_nr_seq</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| i &nbsp; &nbsp; &nbsp; | applied_execute_pkey</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| i &nbsp; &nbsp; &nbsp; | pending_fkeys_pkey</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| i &nbsp; &nbsp; &nbsp; | seq_info_pkey</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| i &nbsp; &nbsp; &nbsp; | table_info_pkey</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| r &nbsp; &nbsp; &nbsp; | applied_execute</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| r &nbsp; &nbsp; &nbsp; | pending_fkeys</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| r &nbsp; &nbsp; &nbsp; | seq_info</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| r &nbsp; &nbsp; &nbsp; | table_info</font></div><p></p></pre></div><div>-- 以下是新增的函数, 复制, batch, 触发器handle, 注册, 注销, 映射关系等.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal_01=&gt; select nspname,lanname,proname from pg_proc,pg_namespace,pg_language where prolang=pg_language.oid and pronamespace=pg_namespace.oid and pronamespace in (select oid from pg_namespace where nspname in ('londiste','pgq','pgq_ext','pgq_node','public','digoal_01')) order by pronamespace,proname;</font></div><div><font size="2"  >&nbsp; nspname &nbsp;| lanname | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;proname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >-----------+---------+---------------------------</font></div><div><font size="2"  >&nbsp;digoal_01 | plpgsql | f_user_login</font></div><div><font size="2"  >&nbsp;digoal_01 | plpgsql | f_user_logout</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | _grant_perms_from</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | batch_event_sql</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | batch_event_tables</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | batch_retry</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | create_queue</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | current_event_table</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | drop_queue</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | drop_queue</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | event_retry</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | event_retry</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | event_retry_raw</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | find_tick_helper</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | finish_batch</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | force_tick</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | get_batch_cursor</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | get_batch_cursor</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | get_batch_events</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | get_batch_info</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | get_consumer_info</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | get_consumer_info</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | get_consumer_info</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | get_queue_info</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | get_queue_info</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | grant_perms</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | insert_event</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | insert_event</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | c &nbsp; &nbsp; &nbsp; | insert_event_raw</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | c &nbsp; &nbsp; &nbsp; | logutriga</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | maint_operations</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | maint_retry_events</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | maint_rotate_tables_step1</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | maint_rotate_tables_step2</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | maint_tables_to_vacuum</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | next_batch</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | next_batch_custom</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | next_batch_info</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | register_consumer</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | register_consumer_at</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | seq_getval</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | seq_setval</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | set_queue_config</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | c &nbsp; &nbsp; &nbsp; | sqltriga</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | ticker</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | ticker</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | ticker</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | tune_storage</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | unregister_consumer</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | upgrade_schema</font></div><div><font size="2"  >&nbsp;pgq &nbsp; &nbsp; &nbsp; | plpgsql | version</font></div><div><font size="2"  >&nbsp;pgq_ext &nbsp; | plpgsql | get_last_tick</font></div><div><font size="2"  >&nbsp;pgq_ext &nbsp; | plpgsql | get_last_tick</font></div><div><font size="2"  >&nbsp;pgq_ext &nbsp; | plpgsql | is_batch_done</font></div><div><font size="2"  >&nbsp;pgq_ext &nbsp; | plpgsql | is_batch_done</font></div><div><font size="2"  >&nbsp;pgq_ext &nbsp; | plpgsql | is_event_done</font></div><div><font size="2"  >&nbsp;pgq_ext &nbsp; | plpgsql | is_event_done</font></div><div><font size="2"  >&nbsp;pgq_ext &nbsp; | plpgsql | set_batch_done</font></div><div><font size="2"  >&nbsp;pgq_ext &nbsp; | plpgsql | set_batch_done</font></div><div><font size="2"  >&nbsp;pgq_ext &nbsp; | plpgsql | set_event_done</font></div><div><font size="2"  >&nbsp;pgq_ext &nbsp; | plpgsql | set_event_done</font></div><div><font size="2"  >&nbsp;pgq_ext &nbsp; | plpgsql | set_last_tick</font></div><div><font size="2"  >&nbsp;pgq_ext &nbsp; | plpgsql | set_last_tick</font></div><div><font size="2"  >&nbsp;pgq_ext &nbsp; | plpgsql | upgrade_schema</font></div><div><font size="2"  >&nbsp;pgq_ext &nbsp; | plpgsql | version</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| plpgsql | change_consumer_provider</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| plpgsql | create_node</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| plpgsql | demote_root</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| plpgsql | drop_node</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| plpgsql | get_consumer_info</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| plpgsql | get_consumer_state</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| plpgsql | get_node_info</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| plpgsql | get_queue_locations</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| plpgsql | get_subscriber_info</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| plpgsql | get_worker_state</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| plpgsql | is_leaf_node</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| plpgsql | is_root_node</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| plpgsql | maint_watermark</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| plpgsql | promote_branch</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| plpgsql | register_consumer</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| plpgsql | register_location</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| plpgsql | register_subscriber</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| plpgsql | set_consumer_completed</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| plpgsql | set_consumer_error</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| plpgsql | set_consumer_paused</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| plpgsql | set_consumer_uptodate</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| plpgsql | set_global_watermark</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| plpgsql | set_node_attrs</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| plpgsql | set_partition_watermark</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| plpgsql | set_subscriber_watermark</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| plpgsql | unregister_consumer</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| plpgsql | unregister_location</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| plpgsql | unregister_subscriber</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| plpgsql | upgrade_schema</font></div><div><font size="2"  >&nbsp;pgq_node &nbsp;| plpgsql | version</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | _coordinate_copy</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | drop_table_fkey</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | drop_table_triggers</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | execute_finish</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | execute_start</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | find_column_types</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | find_rel_oid</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | find_seq_oid</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | find_table_fkeys</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | find_table_oid</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | get_seq_list</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | get_table_list</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | get_table_pending_fkeys</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | get_valid_pending_fkeys</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | global_add_table</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | global_remove_seq</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | global_remove_table</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | global_update_seq</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| sql &nbsp; &nbsp; | is_replica_func</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | local_add_seq</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | local_add_table</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | local_add_table</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | local_add_table</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | local_add_table</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | local_remove_seq</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | local_remove_table</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | local_set_table_attrs</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | local_set_table_state</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | local_set_table_struct</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | local_show_missing</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | make_fqname</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | quote_fqname</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | restore_table_fkey</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | root_check_seqs</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | root_check_seqs</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | root_notify_change</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | split_fqname</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | table_info_trigger</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | upgrade_schema</font></div><div><font size="2"  >&nbsp;londiste &nbsp;| plpgsql | version</font></div><div><font size="2"  >(135 rows)</font></div><p></p></pre></div><div><br></div><div>-- 创建完根节点的这些对象, 函数等之后. 如果没有异常, 就可以启动provider的worker (Replay events to subscriber: it is needed to make the replication active as it will start to replay the events.) 进程了.</div><div><pre class="prettyprint"  ><p><font size="2"  >postgres@db5-&gt; londiste3 -d /home/postgres/londiste3/src_digoal_01.ini worker</font></p></pre></div><div>-- 其实是一个python进程, 如下</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; ps -ewf|grep python</font></div><div><font size="2"  >postgres 27316 &nbsp; &nbsp; 1 &nbsp;0 15:53 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 /opt/python2.7.3/bin/python /opt/skytools3.0.2/bin/londiste3 -d /home/postgres/londiste3/src_digoal_01.ini worker</font></div><p></p></pre></div><div><br></div><div>-- 根配置完了, 就可以辐射出去了, 接下来配置目标1的配置文件 :&nbsp;</div><div>-- 同样,&nbsp;<span style="line-height: 22px;"  >注意db里面我配置了password, 如果你使用的是trust认证或者使用了.pgpass文件, 这里就不需要配密码了.</span></div><div><span style="line-height: 22px;"  >-- queue的名字和provider的queue的名字必须一致. job_name和前面的不能一致.</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >vi /home/postgres/londiste3/dst1_digoal_01.ini</font></div><div><font size="2"  >[londiste3]</font></div><div><font size="2"  >job_name = dst1_digoal_01</font></div><div><font size="2"  >db = host=172.16.3.33 port=1919 user=postgres dbname=digoal_01 password=postgres</font></div><div><font size="2"  >queue_name = replika</font></div><div><font size="2"  >logfile = /home/postgres/londiste3/log/dst1_digoal_01.log</font></div><div><font size="2"  >pidfile = /home/postgres/londiste3/pid/dst1_digoal_01.pid</font></div><p></p></pre></div><div><br></div><div>-- 配置好后, 创建叶节点, 注意我这里创建的是页节点, 而不是树枝节点, 因为本次不讲级联复制. 如果是级联的话创建的是树枝节点.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; londiste3 -v /home/postgres/londiste3/dst1_digoal_01.ini create-leaf dst1_digoal_01 "host=172.16.3.33 port=1919 user=postgres dbname=digoal_01 password=postgres" --provider="host=172.16.3.176 port=1921 user=postgres dbname=digoal_01 password=postgres"</font></div><div><font size="2"  >2012-05-30 21:33:47,316 9412 DEBUG Connect 'new_node' to 'host=172.16.3.33 port=1919 user=postgres dbname=digoal_01 &nbsp;[...]'</font></div><div><font size="2"  >2012-05-30 21:33:47,324 9412 INFO plpgsql is installed</font></div><div><font size="2"  >2012-05-30 21:33:47,325 9412 INFO Installing pgq</font></div><div><font size="2"  >2012-05-30 21:33:47,325 9412 INFO &nbsp; Reading from /opt/skytools3.0.2/share/skytools3/pgq.sql</font></div><div><font size="2"  >2012-05-30 21:33:47,721 9412 INFO pgq.get_batch_cursor is installed</font></div><div><font size="2"  >2012-05-30 21:33:47,721 9412 INFO Installing pgq_ext</font></div><div><font size="2"  >2012-05-30 21:33:47,722 9412 INFO &nbsp; Reading from /opt/skytools3.0.2/share/skytools3/pgq_ext.sql</font></div><div><font size="2"  >2012-05-30 21:33:47,918 9412 INFO Installing pgq_node</font></div><div><font size="2"  >2012-05-30 21:33:47,919 9412 INFO &nbsp; Reading from /opt/skytools3.0.2/share/skytools3/pgq_node.sql</font></div><div><font size="2"  >2012-05-30 21:33:48,217 9412 INFO Installing londiste</font></div><div><font size="2"  >2012-05-30 21:33:48,217 9412 INFO &nbsp; Reading from /opt/skytools3.0.2/share/skytools3/londiste.sql</font></div><div><font size="2"  >2012-05-30 21:33:48,430 9412 INFO londiste.global_add_table is installed</font></div><div><font size="2"  >2012-05-30 21:33:48,431 9412 DEBUG exec_query: select * from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-05-30 21:33:48,434 9412 INFO Initializing node</font></div><div><font size="2"  >2012-05-30 21:33:48,434 9412 DEBUG Connect 'root_db' to 'host=172.16.3.176 port=1921 user=postgres dbname=digoal_01 &nbsp;[...]'</font></div><div><font size="2"  >2012-05-30 21:33:48,437 9412 DEBUG exec_query: select * from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-05-30 21:33:48,446 9412 DEBUG db='host=172.16.3.176 port=1921 user=postgres dbname=digoal_01 password=postgres' -- type='root' provider='host=172.16.3.176 port=1921 user=postgres dbname=digoal_01 password=postgres'</font></div><div><font size="2"  >2012-05-30 21:33:48,446 9412 DEBUG exec_query: select * from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-05-30 21:33:48,447 9412 DEBUG exec_query: select * from pgq_node.get_queue_locations('replika')</font></div><div><font size="2"  >2012-05-30 21:33:48,448 9412 DEBUG Connect 'provider_db' to 'host=172.16.3.176 port=1921 user=postgres dbname=digoal_01 &nbsp;[...]'</font></div><div><font size="2"  >2012-05-30 21:33:48,451 9412 DEBUG exec_query: select node_type, node_name from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-05-30 21:33:48,460 9412 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'dst1_digoal_01', 'host=172.16.3.33 port=1919 user=postgres dbname=digoal_01 password=postgres', false)</font></div><div><font size="2"  >2012-05-30 21:33:48,463 9412 INFO Location registered</font></div><div><font size="2"  >2012-05-30 21:33:48,463 9412 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'dst1_digoal_01', 'host=172.16.3.33 port=1919 user=postgres dbname=digoal_01 password=postgres', false)</font></div><div><font size="2"  >2012-05-30 21:33:48,466 9412 INFO Location registered</font></div><div><font size="2"  >2012-05-30 21:33:48,466 9412 DEBUG exec_cmd: select * from pgq_node.register_subscriber('replika', 'dst1_digoal_01', 'dst1_digoal_01', null)</font></div><div><font size="2"  >2012-05-30 21:33:48,470 9412 INFO Subscriber registered: dst1_digoal_01</font></div><div><font size="2"  >2012-05-30 21:33:48,471 9412 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'dst1_digoal_01', 'host=172.16.3.33 port=1919 user=postgres dbname=digoal_01 password=postgres', false)</font></div><div><font size="2"  >2012-05-30 21:33:48,472 9412 INFO Location registered</font></div><div><font size="2"  >2012-05-30 21:33:48,472 9412 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'src_digoal_01', 'host=172.16.3.176 port=1921 user=postgres dbname=digoal_01 password=postgres', 'False')</font></div><div><font size="2"  >2012-05-30 21:33:48,473 9412 INFO Location registered</font></div><div><font size="2"  >2012-05-30 21:33:48,473 9412 DEBUG exec_cmd: select * from pgq_node.create_node('replika', 'leaf', 'dst1_digoal_01', 'dst1_digoal_01', 'src_digoal_01', '1', null)</font></div><div><font size="2"  >2012-05-30 21:33:48,475 9412 INFO Node "dst1_digoal_01" initialized for queue "replika" with type "leaf"</font></div><div><font size="2"  >2012-05-30 21:33:48,477 9412 INFO Done</font></div><p></p></pre></div><div><br></div><div>-- 创建完叶节点, 启动subscriber的worker进程 :&nbsp;</div><div><pre class="prettyprint"  ><p><font size="2"  >postgres@db5-&gt; londiste3 -d /home/postgres/londiste3/dst1_digoal_01.ini worker</font></p></pre></div><div>-- 可以看到现在系统中有两个python进程, 分别是provider和subscriber的worker进程.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; ps -ewf|grep python</font></div><div><font size="2"  >postgres 27316 &nbsp; &nbsp; 1 &nbsp;0 15:53 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 /opt/python2.7.3/bin/python /opt/skytools3.0.2/bin/londiste3 -d /home/postgres/londiste3/src_digoal_01.ini worker</font></div><div><font size="2"  >postgres 27439 &nbsp; &nbsp; 1 &nbsp;0 15:57 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 /opt/python2.7.3/bin/python /opt/skytools3.0.2/bin/londiste3 -d /home/postgres/londiste3/dst1_digoal_01.ini worker</font></div><p></p></pre></div><div><br></div><div>-- 接下来配置pgq的ticker进程需要的配置文件, ticker是用来做batch的.</div><div>(Londiste needs a ticker which has to target the P(rovider) database, and can be run from another machine. The common usage is to run the ticker directly on the Provider database host.</div><div>Any ticker can host as many queues as you want. Each queue has a unique name and can be used by as many subscribers as needed.</div><div>If you have several copies of the same database, you can subscribe to the same queue from several subscribers. If you want to have different subsets of the same source database on several subscribers, you either can have those use the same queue but only a part of the tables in it, or have a queue per set of tables.)</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >vi /home/postgres/londiste3/pgqd.ini</font></div><div><font size="2"  >[pgqd]</font></div><div><font size="2"  >base_connstr = host=172.16.3.176 port=1921 user=postgres password=postgres</font></div><div><font size="2"  >initial_database = template1</font></div><div><font size="2"  >logfile = /home/postgres/londiste3/log/pgqd.log</font></div><div><font size="2"  >pidfile = /home/postgres/londiste3/pid/pgqd.pid</font></div><p></p></pre></div><div><br></div><div>-- 启动pgqd进程.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; pgqd -d /home/postgres/londiste3/pgqd.ini</font></div><div><font size="2"  >2012-05-30 21:35:07.497 9446 LOG Starting pgqd 3.0.2</font></div><p></p></pre></div><div>-- pgqd是一个c程序.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; ps -ewf|grep pgqd</font></div><div><font size="2"  >postgres 27637 &nbsp; &nbsp; 1 &nbsp;0 16:01 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 pgqd -d /home/postgres/londiste3/pgqd.ini</font></div><p></p></pre></div><div><br></div><div>【异常注意】</div><div>-- 使用普通用户连接的话看到src和dst的数据库日志都有报错,&nbsp;<span style="line-height: 22px;"  >set session_replication_role = 'replica'这个必须超级用户执行,</span></div><div><span style="line-height: 22px;"  >-- 我以前写过一篇关于这个参数的BLOG, 有兴趣的朋友参考如下 :&nbsp;</span></div><div><div style="line-height: 22px;"  >《Can session_replication_role used like MySQL's BlackHole Engine?》</div><div style="line-height: 22px;"  ><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201119111234570/"  >http://blog.163.com/digoal@126/blog/static/163877040201119111234570/</a></div><div><pre class="prettyprint"  ><div><span style="line-height: 22px;"  ><div><span style="line-height: 22px;"  ><font size="2"  >postgres@db5-&gt; less pgqd.log</font></span></div></span></div><div><font size="2"  >2012-05-30 15:59:17.110 CST,"digoal_01","digoal_01",18490,"172.16.3.176:33835",4fc5d355.483a,1,"SET",2012-05-30 15:59:17 CST,3/295,0,ERROR,42501,"permission denied to set parameter ""session_replication_role""",,,,,,"set session_replication_role = 'replica'",,,""</font></div><p></p></pre></div></div><div>-- londiste的日志也有报错</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; less src_digoal_01.log&nbsp;</font></div><div><font size="2"  >2012-05-30 16:03:29,221 27316 WARNING Failure to call pgq_node.set_consumer_error()</font></div><div><font size="2"  >2012-05-30 16:03:29,221 27316 ERROR Job src_digoal_01 got error on connection 'db': permission denied to set parameter "session_repl</font></div><div><font size="2"  >ication_role". &nbsp; Query: set session_replication_role = 'replica'</font></div><div><font size="2"  >Traceback (most recent call last):</font></div><div><font size="2"  >&nbsp; File "/opt/skytools3.0.2/lib/python2.7/site-packages/pgq/cascade/consumer.py", line 285, in exception_hook</font></div><div><font size="2"  >&nbsp; &nbsp; dst_db = self.get_database(self.target_db)</font></div><div><font size="2"  >&nbsp; File "/opt/skytools3.0.2/lib/python2.7/site-packages/skytools/scripting.py", line 733, in get_database</font></div><div><font size="2"  >&nbsp; &nbsp; return dbc.get_connection(params['isolation_level'], clist)</font></div><div><font size="2"  >&nbsp; File "/opt/skytools3.0.2/lib/python2.7/site-packages/skytools/scripting.py", line 954, in get_connection</font></div><div><font size="2"  >&nbsp; &nbsp; self.setup_func(self.name, self.conn)</font></div><div><font size="2"  >&nbsp; File "/opt/skytools3.0.2/lib/python2.7/site-packages/londiste/playback.py", line 322, in connection_hook</font></div><div><font size="2"  >&nbsp; &nbsp; curs.execute("set session_replication_role = 'replica'")</font></div><div><font size="2"  >&nbsp; File "/opt/python2.7.3/lib/python2.7/site-packages/psycopg2/extras.py", line 123, in execute</font></div><div><font size="2"  >&nbsp; &nbsp; return _cursor.execute(self, query, vars)</font></div><div><font size="2"  >ProgrammingError: permission denied to set parameter "session_replication_role"</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres@db5-&gt; less dst1_digoal_01.log&nbsp;</font></div><div><font size="2"  >2012-05-30 16:03:34,347 27439 WARNING Failure to call pgq_node.set_consumer_error()</font></div><div><font size="2"  >2012-05-30 16:03:34,347 27439 ERROR Job dst1_digoal_01 got error on connection 'db': permission denied to set parameter "session_rep</font></div><div><font size="2"  >lication_role". &nbsp; Query: set session_replication_role = 'replica'</font></div><div><font size="2"  >Traceback (most recent call last):</font></div><div><font size="2"  >&nbsp; File "/opt/skytools3.0.2/lib/python2.7/site-packages/pgq/cascade/consumer.py", line 285, in exception_hook</font></div><div><font size="2"  >&nbsp; &nbsp; dst_db = self.get_database(self.target_db)</font></div><div><font size="2"  >&nbsp; File "/opt/skytools3.0.2/lib/python2.7/site-packages/skytools/scripting.py", line 733, in get_database</font></div><div><font size="2"  >&nbsp; &nbsp; return dbc.get_connection(params['isolation_level'], clist)</font></div><div><font size="2"  >&nbsp; File "/opt/skytools3.0.2/lib/python2.7/site-packages/skytools/scripting.py", line 954, in get_connection</font></div><div><font size="2"  >&nbsp; &nbsp; self.setup_func(self.name, self.conn)</font></div><div><font size="2"  >&nbsp; File "/opt/skytools3.0.2/lib/python2.7/site-packages/londiste/playback.py", line 322, in connection_hook</font></div><div><font size="2"  >&nbsp; &nbsp; curs.execute("set session_replication_role = 'replica'")</font></div><div><font size="2"  >&nbsp; File "/opt/python2.7.3/lib/python2.7/site-packages/psycopg2/extras.py", line 123, in execute</font></div><div><font size="2"  >&nbsp; &nbsp; return _cursor.execute(self, query, vars)</font></div><div><font size="2"  >ProgrammingError: permission denied to set parameter "session_replication_role"</font></div><p></p></pre></div><div><br></div><div>-- 因此如果前面配置的是普通用户, 可以修改配置文件, 改成超级用户后reload</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; cat src_digoal_01.ini&nbsp;</font></div><div><font size="2"  >[londiste3]</font></div><div><font size="2"  >job_name = src_digoal_01</font></div><div><font size="2"  >db = host=172.16.3.176 port=1921 user=postgres dbname=digoal_01 password=postgres</font></div><div><font size="2"  >queue_name = replika</font></div><div><font size="2"  >logfile = /home/postgres/londiste3/log/src_digoal_01.log</font></div><div><font size="2"  >pidfile = /home/postgres/londiste3/pid/src_digoal_01.pid</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres@db5-&gt; cat dst1_digoal_01.ini&nbsp;</font></div><div><font size="2"  >[londiste3]</font></div><div><font size="2"  >job_name = dst1_digoal_01</font></div><div><font size="2"  >db = host=172.16.3.33 port=1919 user=postgres dbname=digoal_01 password=postgres</font></div><div><font size="2"  >queue_name = replika</font></div><div><font size="2"  >logfile = /home/postgres/londiste3/log/dst1_digoal_01.log</font></div><div><font size="2"  >pidfile = /home/postgres/londiste3/pid/dst1_digoal_01.pid</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres@db5-&gt; londiste3 -r /home/postgres/londiste3/src_digoal_01.ini</font></div><div><font size="2"  >postgres@db5-&gt; londiste3 -r /home/postgres/londiste3/dst1_digoal_01.ini</font></div><p></p></pre></div><div><br></div><div><br></div><div>-- 正常后, 可以查看当前的复制状态, status用于输出节点树.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; londiste3 /home/postgres/londiste3/src_digoal_01.ini status</font></div><div><font size="2"  >Queue: replika &nbsp; Local node: src_digoal_01</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >src_digoal_01 (root)</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Tables: 0/0/0</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Lag: 26s, Tick: 14</font></div><div><font size="2"  >&nbsp; +--dst1_digoal_01 (leaf)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Tables: 0/0/0</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Lag: 26s, Tick: 14</font></div><p></p></pre></div><div><br></div><div>-- members用于输出这个配置文件下的复制节点member信息.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; londiste3 /home/postgres/londiste3/src_digoal_01.ini members</font></div><div><font size="2"  >Member info on src_digoal_01@replika:</font></div><div><font size="2"  >node_name &nbsp; &nbsp; &nbsp; &nbsp;dead &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node_location</font></div><div><font size="2"  >--------------- &nbsp;--------------- &nbsp;----------------------------------------------------------------------------</font></div><div><font size="2"  >dst1_digoal_01 &nbsp; False &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;host=172.16.3.33 port=1919 user=postgres dbname=digoal_01 password=postgres</font></div><div><font size="2"  >src_digoal_01 &nbsp; &nbsp;False &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;host=172.16.3.176 port=1921 user=postgres dbname=digoal_01 password=postgres</font></div><p></p></pre></div><div><br></div><div>-- 开始添加需要复制的表, 首先是用provider的配置文件添加, 先添加两个带主键的表.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; londiste3 -v /home/postgres/londiste3/src_digoal_01.ini add-table digoal_01.user_info digoal_01.user_session</font></div><div><font size="2"  >2012-05-30 21:37:57,024 9537 DEBUG Connect 'db' to 'host=172.16.3.176 port=1921 user=postgres dbname=digoal_01 &nbsp;[...]'</font></div><div><font size="2"  >2012-05-30 21:37:57,028 9537 DEBUG exec_query: select * from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-05-30 21:37:57,036 9537 DEBUG exec_query: select * from pgq_node.get_queue_locations('replika')</font></div><div><font size="2"  >2012-05-30 21:37:57,037 9537 DEBUG exec_cmd: select * from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-05-30 21:37:57,038 9537 DEBUG 100 Ok</font></div><div><font size="2"  >2012-05-30 21:37:57,039 9537 DEBUG Connect 'provider_db' to 'host=172.16.3.176 port=1921 user=postgres dbname=digoal_01 &nbsp;[...]'</font></div><div><font size="2"  >2012-05-30 21:37:57,047 9537 DEBUG exec_cmd: select * from londiste.local_add_table('replika', 'digoal_01.user_info', '[]', null, null)</font></div><div><font size="2"  >2012-05-30 21:37:57,064 9537 INFO Table added: digoal_01.user_info</font></div><div><font size="2"  >2012-05-30 21:37:57,065 9537 DEBUG exec_cmd: select * from londiste.local_add_table('replika', 'digoal_01.user_session', '[]', null, null)</font></div><div><font size="2"  >2012-05-30 21:37:57,067 9537 INFO Table added: digoal_01.user_session</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"  >-- 开始添加需要复制的表, 然后是用subscriber的配置文件添加</span><span style="line-height: 22px;"  >, 先添加两个带主键的表.</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; londiste3 -v /home/postgres/londiste3/dst1_digoal_01.ini add-table digoal_01.user_info digoal_01.user_session</font></div><div><font size="2"  >2012-05-30 21:38:08,369 9548 DEBUG Connect 'db' to 'host=172.16.3.33 port=1919 user=postgres dbname=digoal_01 &nbsp;[...]'</font></div><div><font size="2"  >2012-05-30 21:38:08,373 9548 DEBUG exec_query: select * from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-05-30 21:38:08,377 9548 DEBUG exec_query: select * from pgq_node.get_queue_locations('replika')</font></div><div><font size="2"  >2012-05-30 21:38:08,378 9548 DEBUG exec_cmd: select * from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-05-30 21:38:08,379 9548 DEBUG 100 Ok</font></div><div><font size="2"  >2012-05-30 21:38:08,380 9548 DEBUG Connect 'provider_db' to 'host=172.16.3.176 port=1921 user=postgres dbname=digoal_01 &nbsp;[...]'</font></div><div><font size="2"  >2012-05-30 21:38:08,392 9548 DEBUG exec_cmd: select * from londiste.local_add_table('replika', 'digoal_01.user_info', '[]', null, null)</font></div><div><font size="2"  >2012-05-30 21:38:08,405 9548 INFO Table added: digoal_01.user_info</font></div><div><font size="2"  >2012-05-30 21:38:08,406 9548 DEBUG exec_cmd: select * from londiste.local_add_table('replika', 'digoal_01.user_session', '[]', null, null)</font></div><div><font size="2"  >2012-05-30 21:38:08,410 9548 INFO Table added: digoal_01.user_session</font></div><p></p></pre></div><div><br></div><div>-- 添加完后, 查看provider下面的加入复制的表</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; londiste3 -v /home/postgres/londiste3/src_digoal_01.ini tables</font></div><div><font size="2"  >2012-05-30 21:38:36,499 9563 DEBUG Connect 'db' to 'host=172.16.3.176 port=1921 user=postgres dbname=digoal_01 &nbsp;[...]'</font></div><div><font size="2"  >2012-05-30 21:38:36,503 9563 DEBUG display_table: select table_name, merge_state, table_attrs</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; from londiste.get_table_list('replika') where local</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; order by table_name</font></div><div><font size="2"  >Tables on node</font></div><div><font size="2"  >table_name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;merge_state &nbsp; &nbsp; &nbsp;table_attrs</font></div><div><font size="2"  >---------------------- &nbsp;--------------- &nbsp;---------------</font></div><div><font size="2"  >digoal_01.user_info &nbsp; &nbsp; ok &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >digoal_01.user_session &nbsp;ok &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"  >-- 添加完后, 查看subscriber 1下面的加入复制的表, 看到这里的状态是in-copy的, 表示正在初始化拷贝.</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; londiste3 -v /home/postgres/londiste3/dst1_digoal_01.ini tables</font></div><div><font size="2"  >2012-05-30 21:38:41,135 9567 DEBUG Connect 'db' to 'host=172.16.3.33 port=1919 user=postgres dbname=digoal_01 &nbsp;[...]'</font></div><div><font size="2"  >2012-05-30 21:38:41,139 9567 DEBUG display_table: select table_name, merge_state, table_attrs</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; from londiste.get_table_list('replika') where local</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; order by table_name</font></div><div><font size="2"  >Tables on node</font></div><div><font size="2"  >table_name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;merge_state &nbsp; &nbsp; &nbsp;table_attrs</font></div><div><font size="2"  >---------------------- &nbsp;--------------- &nbsp;---------------</font></div><div><font size="2"  >digoal_01.user_info &nbsp; &nbsp; in-copy &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >digoal_01.user_session &nbsp;None &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><p></p></pre></div><div><br></div><div>-- 注意londiste3的add table选项, 表示允许的并行拷贝的表的数量, 默认是1个1个的串行拷贝.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >--max-parallel-copy=MAX_PARALLEL_COPY</font></div><div><font size="2"  >max number of parallel copy processes</font></div><p></p></pre></div><div>-- 另外需要注意的是, 初始化拷贝过程不是一个snapshot的过程, 比如添加的2个表, 即使并行拷贝也不是snapshot的.&nbsp;</div><div><br></div><div>-- 还有两个选项是seqs, missing分别用于查看复制的序列和未加入复制的表.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; londiste3 /home/postgres/londiste3/src_digoal_01.ini seqs</font></div><div><font size="2"  >postgres@db5-&gt; londiste3 /home/postgres/londiste3/src_digoal_01.ini missing</font></div><div><font size="2"  >Missing objects on node</font></div><div><font size="2"  >obj_kind &nbsp; &nbsp; &nbsp; &nbsp; obj_name</font></div><div><font size="2"  >--------------- &nbsp;-------------------------</font></div><div><font size="2"  >r &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;digoal_01.user_login_rec</font></div><div><font size="2"  >r &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;digoal_01.user_logout_rec</font></div><p></p></pre></div><div><br></div><div>-- 接下来添加两个日志表, 因为日志表上没有PK, 所以添加不成功.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; londiste3 /home/postgres/londiste3/src_digoal_01.ini add-table digoal_01.user_login_rec digoal_01.user_logout_rec</font></div><div><font size="2"  >2012-05-30 16:12:25,239 28118 ERROR Primary key missing on table: digoal_01.user_login_rec</font></div><div><font size="2"  >postgres@db5-&gt; londiste3 /home/postgres/londiste3/src_digoal_01.ini missing</font></div><div><font size="2"  >Missing objects on node</font></div><div><font size="2"  >obj_kind &nbsp; &nbsp; &nbsp; &nbsp; obj_name</font></div><div><font size="2"  >--------------- &nbsp;-------------------------</font></div><div><font size="2"  >r &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;digoal_01.user_login_rec</font></div><div><font size="2"  >r &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;digoal_01.user_logout_rec</font></div><p></p></pre></div><div><br></div><div>-- 因此需要在主节点和目标节点上把PK加上去.&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; psql digoal_01 digoal_01</font></div><div><font size="2"  >psql (9.1.3)</font></div><div><font size="2"  >Type "help" for help.</font></div><div><font size="2"  >digoal_01=&gt; alter table digoal_01.user_login_rec add column id serial8 primary key;</font></div><div><font size="2"  >NOTICE: &nbsp;ALTER TABLE will create implicit sequence "user_login_rec_id_seq" for serial column "user_login_rec.id"</font></div><div><font size="2"  >NOTICE: &nbsp;ALTER TABLE / ADD PRIMARY KEY will create implicit index "user_login_rec_pkey" for table "user_login_rec"</font></div><div><font size="2"  >ALTER TABLE</font></div><div><font size="2"  >digoal_01=&gt; alter table digoal_01.user_logout_rec add column id serial8 primary key;</font></div><div><font size="2"  >NOTICE: &nbsp;ALTER TABLE will create implicit sequence "user_logout_rec_id_seq" for serial column "user_logout_rec.id"</font></div><div><font size="2"  >NOTICE: &nbsp;ALTER TABLE / ADD PRIMARY KEY will create implicit index "user_logout_rec_pkey" for table "user_logout_rec"</font></div><div><font size="2"  >ALTER TABLE</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >pg92@db-172-16-3-33-&gt; psql digoal_01 digoal_01</font></div><div><font size="2"  >psql (9.2beta1)</font></div><div><font size="2"  >Type "help" for help.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal_01=&gt; alter table digoal_01.user_login_rec add column id serial8 primary key;</font></div><div><font size="2"  >NOTICE: &nbsp;ALTER TABLE will create implicit sequence "user_login_rec_id_seq" for serial column "user_login_rec.id"</font></div><div><font size="2"  >NOTICE: &nbsp;ALTER TABLE / ADD PRIMARY KEY will create implicit index "user_login_rec_pkey" for table "user_login_rec"</font></div><div><font size="2"  >ALTER TABLE</font></div><div><font size="2"  >digoal_01=&gt; alter table digoal_01.user_logout_rec add column id serial8 primary key;</font></div><div><font size="2"  >NOTICE: &nbsp;ALTER TABLE will create implicit sequence "user_logout_rec_id_seq" for serial column "user_logout_rec.id"</font></div><div><font size="2"  >NOTICE: &nbsp;ALTER TABLE / ADD PRIMARY KEY will create implicit index "user_logout_rec_pkey" for table "user_logout_rec"</font></div><div><font size="2"  >ALTER TABLE</font></div><p></p></pre></div><div><br></div><div>-- 加好PK后, 再添加两个日志表就OK了. &nbsp;记得加完provider还要加subscriber.&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; londiste3 /home/postgres/londiste3/src_digoal_01.ini add-table digoal_01.user_login_rec digoal_01.user_logout_rec</font></div><div><font size="2"  >2012-05-31 08:50:47,715 30213 INFO Table added: digoal_01.user_login_rec</font></div><div><font size="2"  >2012-05-31 08:50:47,719 30213 INFO Table added: digoal_01.user_logout_rec</font></div><div><font size="2"  >postgres@db5-&gt; londiste3 /home/postgres/londiste3/dst1_digoal_01.ini add-table digoal_01.user_login_rec digoal_01.user_logout_rec</font></div><div><font size="2"  >2012-05-31 08:50:53,307 30219 INFO Table added: digoal_01.user_login_rec</font></div><div><font size="2"  >2012-05-31 08:50:53,313 30219 INFO Table added: digoal_01.user_logout_rec</font></div><p></p></pre></div><div>-- 新增了两个序列, 需要使用add-seq添加</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >postgres@db5-&gt; londiste3 /home/postgres/londiste3/src_digoal_01.ini missing</font></div><div><font size="2"  >Missing objects on node</font></div><div><font size="2"  >obj_kind &nbsp; &nbsp; &nbsp; &nbsp; obj_name</font></div><div><font size="2"  >--------------- &nbsp;--------------------------------</font></div><div><font size="2"  >S &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;digoal_01.user_login_rec_id_seq</font></div><div><font size="2"  >S &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;digoal_01.user_logout_rec_id_seq</font></div></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres@db5-&gt; londiste3 /home/postgres/londiste3/src_digoal_01.ini tables</font></div><div><font size="2"  >Tables on node</font></div><div><font size="2"  >table_name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; merge_state &nbsp; &nbsp; &nbsp;table_attrs</font></div><div><font size="2"  >------------------------- &nbsp;--------------- &nbsp;---------------</font></div><div><font size="2"  >digoal_01.user_info &nbsp; &nbsp; &nbsp; &nbsp;ok &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >digoal_01.user_login_rec &nbsp; ok &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >digoal_01.user_logout_rec &nbsp;ok &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >digoal_01.user_session &nbsp; &nbsp; ok&nbsp;</font></div><p></p></pre></div><div><br></div><div>-- 添加序列</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; londiste3 /home/postgres/londiste3/src_digoal_01.ini add-seq digoal_01.user_login_rec_id_seq digoal_01.user_logout_rec_id_seq</font></div><div><font size="2"  >2012-05-31 08:53:34,666 30314 INFO Sequence added: digoal_01.user_login_rec_id_seq</font></div><div><font size="2"  >2012-05-31 08:53:34,668 30314 INFO Sequence added: digoal_01.user_logout_rec_id_seq</font></div><div><font size="2"  >postgres@db5-&gt; londiste3 /home/postgres/londiste3/dst1_digoal_01.ini add-seq digoal_01.user_login_rec_id_seq digoal_01.user_logout_rec_id_seq</font></div><div><font size="2"  >2012-05-31 08:53:39,322 30318 INFO Sequence added: digoal_01.user_login_rec_id_seq</font></div><div><font size="2"  >2012-05-31 08:53:39,324 30318 INFO Sequence added: digoal_01.user_logout_rec_id_seq</font></div><p></p></pre></div><div><br></div><div>-- 查看添加的序列</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; londiste3 /home/postgres/londiste3/dst1_digoal_01.ini seqs</font></div><div><font size="2"  >Sequences on node</font></div><div><font size="2"  >seq_name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;local &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;last_value</font></div><div><font size="2"  >-------------------------------- &nbsp;--------------- &nbsp;---------------</font></div><div><font size="2"  >digoal_01.user_login_rec_id_seq &nbsp; True &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4396741</font></div><div><font size="2"  >digoal_01.user_logout_rec_id_seq &nbsp;True &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 30001</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres@db5-&gt; londiste3 /home/postgres/londiste3/src_digoal_01.ini seqs</font></div><div><font size="2"  >Sequences on node</font></div><div><font size="2"  >seq_name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;local &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;last_value</font></div><div><font size="2"  >-------------------------------- &nbsp;--------------- &nbsp;---------------</font></div><div><font size="2"  >digoal_01.user_login_rec_id_seq &nbsp; True &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4396741</font></div><div><font size="2"  >digoal_01.user_logout_rec_id_seq &nbsp;True &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 30001</font></div><p></p></pre></div><div><br></div><div>-- 其中provider的worker进程只连一个数据库(主库)</div><div>-- consumer的worker进程则连两个数据库(主库和目标库1).</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; netstat -anp|grep python</font></div><div><font size="2"  >(Not all processes could be identified, non-owned process info</font></div><div><font size="2"  >&nbsp;will not be shown, you would have to be root to see it all.)</font></div><div><font size="2"  >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 172.16.3.176:42865 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;172.16.3.176:1921 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ESTABLISHED 27316/python &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 172.16.3.176:42869 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;172.16.3.176:1921 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ESTABLISHED 27439/python &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >tcp &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp;0 172.16.3.176:3172 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 172.16.3.33:1919 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ESTABLISHED 27439/python &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >postgres@db5-&gt; ps -ewf|grep python</font></div><div><font size="2"  >postgres 27316 &nbsp; &nbsp; 1 &nbsp;0 15:53 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 /opt/python2.7.3/bin/python /opt/skytools3.0.2/bin/londiste3 -d /home/postgres/londiste3/src_digoal_01.ini worker</font></div><div><font size="2"  >postgres 27439 &nbsp; &nbsp; 1 &nbsp;0 15:57 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 /opt/python2.7.3/bin/python /opt/skytools3.0.2/bin/londiste3 -d /home/postgres/londiste3/dst1_digoal_01.ini worker</font></div><p></p></pre></div><div><br></div></div><div><p></p></div>【下节URL】<div><a href="http://blog.163.com/digoal@126/blog/static/1638770402012431102448951/"  >http://blog.163.com/digoal@126/blog/static/1638770402012431102448951/</a> </div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">byfei163 - 2013-06-14 20:07:26</h5>
				<div>
<DIV>-- 注意londiste3的add table选项, 表示允许的并行拷贝的表的数量, 默认是1个1个的串行拷贝.</DIV>
<DIV><P></P><DIV><SPAN class="pun" >--</SPAN><SPAN class="pln" >max</SPAN><SPAN class="pun" >-</SPAN><SPAN class="pln" >parallel</SPAN><SPAN class="pun" >-</SPAN><SPAN class="pln" >copy</SPAN><SPAN class="pun" >=</SPAN><SPAN class="pln" >MAX_PARALLEL_COPY</SPAN></DIV><DIV><SPAN class="pln" >max number of parallel copy processes</SPAN></DIV><DIV><SPAN class="pln" >是针对单个表的嘛，我现在想针对所有的表并行执行，在sky.ini中设置了parallel_copies，然后重新加载参数后仍然是串行copy的，怎么样并行copy多个不同的表呢？</SPAN></DIV></DIV></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 byfei163 - 2013-06-14 20:07:26</h5>
				<div style="width:600px;">HI,是指并行表的个数,不是单个表并行.</div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">byfei163 回复 德哥@Digoal - 2013-06-14 20:07:26</h5>
				<div style="width:600px;"><P>谢谢您的回复，是我没表达清楚！比如我有20个表，其中一个表数据更新量较大，更新完后其他表也做了更新，但我从实验看到只能在大表同步完后，才开始同步其他表，这就有问题了，因为更新量大的表同步时间较长，其他表的同步需要等更新量大的表的同步，这样其他表的同步就延时了，我的目的是在同步更新量大的表的同时，其他表也可以同步，而不用等待更新量大的表同步完才同步.</P></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">byfei163 回复 byfei163 - 2013-06-14 20:07:26</h5>
				<div style="width:600px;"><P>如：<BR>session1<BR>08:30:01<BR>update table01 set modtime=now() ;--15w条数据<BR>08:31:01完成</P>
<P>session2<BR>08:31:02<BR>update table02 set modtime=now();--1000条数据</P>
<P>session3:<BR>08:31:03<BR>update table03 set modtime=now();--1000条数据</P>
<P>session4:<BR>08:31:04<BR>update table04 set modtime=now();--1000条数据</P>
<P>session5:<BR>08:31:05<BR>update table05 set modtime=now();--1000条数据<BR>....</P>
<P>同步的时候必须先同步table01才能同步table02、table03、table04、table05等表，table01同步时间较长，这样后面的表同步延时就比较严重了。<BR>相对理想的同步方式应该是，在同步table01的时候（还没同步完），发现table02（后续会table03、table04、table05等表）也需要同步，再开一个进程<BR>同步table02等表。</P></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 byfei163 - 2013-06-14 20:07:26</h5>
				<div style="width:600px;">HI, 并行是初始化的时候比较有效的。<div>在开始同步后都是以触发器的形式生成操作片段，全库有序执行的。</div><div>你的需求不能通过单个londiste来实现 . 它要保证数据一致性。</div></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">byfei163 回复 德哥@Digoal - 2013-06-14 20:07:26</h5>
				<div style="width:600px;">非常感谢您的回复，您说的有道理，我当时也这样想过，不过，其实针对不同的表可以开并行的，就像Oracle里的高级复制，对对象进行分组，每个组之间是可以并行执行的。</div>
			</div>
	</div>
</div>
</body>
</html>