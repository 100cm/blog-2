<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">redis list operator tested with ruby</h2>
	<h5 id="">2012-05-25 15:30:30&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201242514558128/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">redis是一个性能比较出色的内存数据库或者说NOSQL.<div>下面使用ruby测试一下lpush和lpop的性能.</div><div>测试机 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >HP DL360G5</font></div><div><font size="2"  >16G内存</font></div><div><font size="2"  >2颗 4核心Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5405 &nbsp;@ 2.00GHz</font></div><div><font size="2"  >ruby版本1.9.3-p194</font></div><div><font size="2"  >redis版本2.4.14</font></div><div><font size="2"  >操作系统 : CentOS 5.2 x64</font></div><p></p></pre></div><div><br></div><div>1. 安装redis-rb (rubygems里面叫redis, github里面叫redis-rb注意)</div><div>ruby和git安装可以参考前面几篇BLOG ：&nbsp;</div><div>&nbsp; use rvm install and manage ruby version</div><div><a href="http://blog.163.com/digoal@126/blog/static/1638770402012425111617904/"  >http://blog.163.com/digoal@126/blog/static/1638770402012425111617904/</a> </div><div>&nbsp; git install</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201242512825860/"  >http://blog.163.com/digoal@126/blog/static/163877040201242512825860/</a> </div><div><br></div><div>安装redis-rb模块.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db-172-16-3-33 ~]# gem install redis</font></div><div><font size="2"  >Fetching: redis-3.0.0.gem (100%)</font></div><div><font size="2"  >Successfully installed redis-3.0.0</font></div><div><font size="2"  >1 gem installed</font></div><div><font size="2"  >Installing ri documentation for redis-3.0.0...</font></div><div><font size="2"  >Installing RDoc documentation for redis-3.0.0...</font></div><div><font size="2"  >[root@db-172-16-3-33 ~]# gem list</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >*** LOCAL GEMS ***</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >redis (3.0.0)</font></div><p></p></pre></div><div><br></div><div>2. 安装redis</div><div>-- 下载redis源码</div><div><div><pre class="prettyprint"  ><p><font size="2"  >[root@db5 soft_bak]# wget http://redis.googlecode.com/files/redis-2.4.14.tar.gz</font></p></pre></div><div><br></div><div>解压并安装到指定目录</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >tar -zxvf redis-2.4.14.tar.gz</font></div><div><font size="2"  >cd redis-2.4.14</font></div><div><font size="2"  >make all</font></div><div><font size="2"  >make PREFIX=/opt/redis2.4.14 install</font></div><p></p></pre></div><div><br></div><div>修改环境变量</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >vi ~/.bash_profile</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >export PATH=/opt/redis2.4.14/bin:$PATH</font></div><p></p></pre></div><div><br></div><div>应用环境变量</div><div><pre class="prettyprint"  ><p><font size="2"  >. ~/.bash_profile</font></p></pre></div><div><br></div><div>创建配置文件目录, 拷贝配置文件模板到此目录</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db5 redis-2.4.14]# mkdir /opt/redis2.4.14/etc</font></div><div><font size="2"  >[root@db5 redis-2.4.14]# cp $redis-2.4.14/redis.conf /opt/redis2.4.14/etc/</font></div><p></p></pre></div><div><br></div><div>创建数据文件备份目录</div><div><pre class="prettyprint"  ><p><font size="2"  >mkdir /opt/redis2.4.14/rdb</font></p></pre></div><div><br></div><div>修改内核参数</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db5 etc]# sysctl -w vm.overcommit_memory=1</font></div><div><font size="2"  >vi /etc/sysctl.conf</font></div><div><font size="2"  >vm.overcommit_memory = 1</font></div><p></p></pre></div><div><br></div><div>修改过的配置文件内容 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >daemonize yes</font></div><div><font size="2"  >pidfile /opt/redis2.4.14/redis.pid</font></div><div><font size="2"  >bind 127.0.0.1</font></div><div><font size="2"  >unixsocket /opt/redis2.4.14/redis.sock</font></div><div><font size="2"  >unixsocketperm 755</font></div><div><font size="2"  >logfile /var/log/redis.log</font></div><div><font size="2"  >dir /opt/redis2.4.14/rdb/</font></div><p></p></pre></div></div><div><br></div><div>所有内容 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >daemonize yes</font></div><div><font size="2"  >pidfile /opt/redis2.4.14/redis.pid</font></div><div><font size="2"  >port 6379</font></div><div><font size="2"  >bind 127.0.0.1</font></div><div><font size="2"  >unixsocket /opt/redis2.4.14/redis.sock</font></div><div><font size="2"  >unixsocketperm 755</font></div><div><font size="2"  >timeout 0</font></div><div><font size="2"  >loglevel verbose</font></div><div><font size="2"  >logfile /var/log/redis.log</font></div><div><font size="2"  >databases 16</font></div><div><font size="2"  >save 900 1</font></div><div><font size="2"  >save 300 10</font></div><div><font size="2"  >save 60 10000</font></div><div><font size="2"  >rdbcompression yes</font></div><div><font size="2"  >dbfilename dump.rdb</font></div><div><font size="2"  >dir /opt/redis2.4.14/rdb/</font></div><div><font size="2"  >slave-serve-stale-data yes</font></div><div><font size="2"  >appendonly no</font></div><div><font size="2"  >appendfsync everysec</font></div><div><font size="2"  >no-appendfsync-on-rewrite no</font></div><div><font size="2"  >auto-aof-rewrite-percentage 100</font></div><div><font size="2"  >auto-aof-rewrite-min-size 64mb</font></div><div><font size="2"  >slowlog-log-slower-than 10000</font></div><div><font size="2"  >slowlog-max-len 128</font></div><div><font size="2"  >vm-enabled no</font></div><div><font size="2"  >vm-swap-file /tmp/redis.swap</font></div><div><font size="2"  >vm-max-memory 0</font></div><div><font size="2"  >vm-page-size 32</font></div><div><font size="2"  >vm-pages 134217728</font></div><div><font size="2"  >vm-max-threads 4</font></div><div><font size="2"  >hash-max-zipmap-entries 512</font></div><div><font size="2"  >hash-max-zipmap-value 64</font></div><div><font size="2"  >list-max-ziplist-entries 512</font></div><div><font size="2"  >list-max-ziplist-value 64</font></div><div><font size="2"  >set-max-intset-entries 512</font></div><div><font size="2"  >zset-max-ziplist-entries 128</font></div><div><font size="2"  >zset-max-ziplist-value 64</font></div><div><font size="2"  >activerehashing yes</font></div><p></p></pre></div><div><br></div><div>启动redis</div><div><pre class="prettyprint"  ><p><font size="2"  >redis-server /opt/redis2.4.14/etc/redis.conf</font></p></pre></div><div><br></div><div>3. 测试lpush和rpop</div><div>测试8个客户端同时push 总共1亿个value到一个list, 使用pipeline.</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db5 ruby]# cat lpush.rb&nbsp;</font></div><div><font size="2"  >#!/usr/local/rvm/bin/ruby</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >require "rubygems"</font></div><div><font size="2"  >require "redis"</font></div><div><font size="2"  >require "date"</font></div><div><font size="2"  >rb = Redis.new</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >mylist = Array.new</font></div><div><font size="2"  >name = "l1"</font></div><div><font size="2"  >rb.del(name)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >(1..100).each do</font></div><div><font size="2"  >&nbsp; mylist.push("abcdefghijklmnopqrstuvwxyz0123456789")</font></div><div><font size="2"  >end</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >p DateTime.now</font></div><div><font size="2"  >(1..125000).each do</font></div><div><font size="2"  >&nbsp; rb.lpush(name,x)</font></div><div><font size="2"  >end</font></div><div><font size="2"  >p DateTime.now</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"  >测试8个客户端同时从1个list 取1亿个value</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db5 ruby]# cat rpop.rb</font></div><div><font size="2"  >#!/usr/local/rvm/bin/ruby</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >require "rubygems"</font></div><div><font size="2"  >require "redis"</font></div><div><font size="2"  >require "date"</font></div><div><font size="2"  >rb = Redis.new</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >name = "l1"</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >p DateTime.now</font></div><div><font size="2"  >(0..12500000).each do</font></div><div><font size="2"  >&nbsp; rb.rpop(name)</font></div><div><font size="2"  >end</font></div><div><font size="2"  >p DateTime.now</font></div><p></p></pre></div></div><div><br></div><div>测试用的shell脚本</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db5 ruby]# cat test.sh&nbsp;</font></div><div><font size="2"  >#!/bin/bash</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >lpush() {</font></div><div><font size="2"  >for((i=1;i&lt;=8;i++))&nbsp;</font></div><div><font size="2"  >do</font></div><div><font size="2"  >&nbsp; ruby ./lpush.rb &gt;./lpush_$i.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"  >done</font></div><div><font size="2"  >}</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >rpop() {</font></div><div><font size="2"  >for((i=1;i&lt;=8;i++))&nbsp;</font></div><div><font size="2"  >do</font></div><div><font size="2"  >&nbsp; ruby ./rpop.rb &gt;./rpop_$i.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"  >done</font></div><div><font size="2"  >}</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >case "$1" in</font></div><div><font size="2"  >&nbsp; lpush)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; lpush</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; ;;</font></div><div><font size="2"  >&nbsp; rpop)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; rpop</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; ;;</font></div><div><font size="2"  >&nbsp; *)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; echo $"Usage: $prog {lpush|rpop}"</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; exit 0</font></div><div><font size="2"  >esac</font></div><p></p></pre></div><div><br></div><div>4. lpush和rpop测试结果</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db5 ruby]# . ./test.sh lpush</font></div><div><font size="2"  >完成时间95秒.</font></div><div><font size="2"  >占用8.94GB内存</font></div><div><font size="2"  >每秒插入105万个value, 处理13万次lpush请求.</font></div><div><font size="2"  ><br></font></div><div><div style="line-height: 22px;"  ><font size="2"  >[root@db5 ruby]# . ./test.sh rpop</font></div><div style="line-height: 22px;"  ><font size="2"  >完成时间2300秒.</font></div></div><div style="line-height: 22px;"  ><font size="2"  >每秒处理43478次rpop请求.</font></div><p></p></pre></div><div><br></div><div>5. rpush和lpop的测试结果</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >脚本与前面类似, 不再重复.</font></div><div><font size="2"  ><span style="line-height: 22px;"  >[root@db5 ruby]# . ./test.sh rpush</span> </font></div><div><div style="line-height: 22px;"  ><font size="2"  >完成时间93秒.</font></div><div style="line-height: 22px;"  ><font size="2"  >占用8.94GB内存</font></div></div><div style="line-height: 22px;"  ><font size="2"  ><br></font></div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><font size="2"  >[root@db5 ruby]# . ./test.sh lpop</font></div><div style="line-height: 22px;"  ><font size="2"  >完成时间3300秒.</font></div></div><p></p></pre></div><div><br></div><div>6. 测试8个key的情况, pop的时候从8个key同时取出.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >redis 127.0.0.1:6379&gt; keys *</font></div><div><font size="2"  >1) "l7"</font></div><div><font size="2"  >2) "l8"</font></div><div><font size="2"  >3) "l1"</font></div><div><font size="2"  >4) "l2"</font></div><div><font size="2"  >5) "l3"</font></div><div><font size="2"  >6) "l4"</font></div><div><font size="2"  >7) "l5"</font></div><div><font size="2"  >8) "l6"</font></div><p></p></pre></div><div><br></div><div><div style="line-height: 22px;"  >脚本</div><div><p></p><div><span style="line-height: 22px;"  >lpop.rb :&nbsp;</span></div></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db5 ruby]# cat lpop1.rb&nbsp;</font></div><div><font size="2"  >#!/usr/local/rvm/bin/ruby</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >require "rubygems"</font></div><div><font size="2"  >require "redis"</font></div><div><font size="2"  >require "date"</font></div><div><font size="2"  >rb = Redis.new</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >name = "l"+ARGV[0]</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >p DateTime.now</font></div><div><font size="2"  >(0..12500000).each do</font></div><div><font size="2"  >&nbsp; rb.lpop(name)</font></div><div><font size="2"  >end</font></div><div><font size="2"  >p DateTime.now</font></div><p></p></pre></div><div style="line-height: 22px;"  ><br></div><div style="line-height: 22px;"  >rpush.rb :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db5 ruby]# cat rpush1.rb&nbsp;</font></div><div><font size="2"  >#!/usr/local/rvm/bin/ruby</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >require "rubygems"</font></div><div><font size="2"  >require "redis"</font></div><div><font size="2"  >require "date"</font></div><div><font size="2"  >rb = Redis.new</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >mylist = Array.new</font></div><div><font size="2"  >name = "l"</font><span style="font-size: small; line-height: 19px;"  >+ARGV[0]</span></div><div><font size="2"  >rb.del(name)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >(1..100).each do</font></div><div><font size="2"  >&nbsp; mylist.push("abcdefghijklmnopqrstuvwxyz0123456789")</font></div><div><font size="2"  >end</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >p DateTime.now</font></div><div><font size="2"  >(1..125000).each do</font></div><div><font size="2"  >&nbsp; rb.rpush(name,mylist)</font></div><div><font size="2"  >end</font></div><div><font size="2"  >p DateTime.now</font></div><p></p></pre></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >test.sh :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db5 ruby]# cat test.sh&nbsp;</font></div><div><font size="2"  >#!/bin/bash</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >rpush() {</font></div><div><font size="2"  >for((i=1;i&lt;=8;i++))&nbsp;</font></div><div><font size="2"  >do</font></div><div><font size="2"  >&nbsp; ruby ./rpush.rb $i &gt;./rpush_$i.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"  >done</font></div><div><font size="2"  >}</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >lpop() {</font></div><div><font size="2"  >for((i=1;i&lt;=8;i++))&nbsp;</font></div><div><font size="2"  >do</font></div><div><font size="2"  >&nbsp; ruby ./lpop.rb $i &gt;./lpop_$i.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"  >done</font></div><div><font size="2"  >}</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >case "$1" in</font></div><div><font size="2"  >&nbsp; rpush)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; rpush</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; ;;</font></div><div><font size="2"  >&nbsp; lpop)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; lpop</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; ;;</font></div><div><font size="2"  >&nbsp; *)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; echo $"Usage: $prog {rpush|lpop}"</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; exit 0</font></div><div><font size="2"  >esac</font></div><p></p></pre></div><div style="line-height: 22px;"  ><br></div><div style="line-height: 22px;"  >测试结果 :&nbsp;</div><div><pre class="prettyprint"  ><div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  ><font size="2"  >[root@db5 ruby]# . ./test.sh rpush</font></span></div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><font size="2"  >完成时间93秒.</font></div><div style="line-height: 22px;"  ><font size="2"  >占用8.94GB内存</font></div></div></div><div><font size="2"  ><br></font></div><div><div style="line-height: 22px;"  ><font size="2"  >[root@db5 ruby]# . ./test.sh lpop</font></div><div style="line-height: 22px;"  ><font size="2"  >完成时间3000秒.</font></div></div><p></p></pre></div></div><div style="line-height: 22px;"  ><br></div><div style="line-height: 22px;"  >【小结】</div><div style="line-height: 22px;"  >1. 使用1个key和多个key操作push和pop性能基本一致. 多key的情况下pop略快.</div><div><br></div><div>【参考】</div><div><div>1.&nbsp;<a target="_blank" rel="nofollow" href="http://redis.io"  >redis.io</a></div></div><div>2. redis-rb的源码 :&nbsp;</div><div><a rel="nofollow" href="https://github.com/redis/redis-rb/blob/master/lib/redis.rb"  >https://github.com/redis/redis-rb/blob/master/lib/redis.rb</a> </div><div>3. 使用pipeline</div><div><a rel="nofollow" href="http://redis.io/topics/pipelining"  >http://redis.io/topics/pipelining</a> </div><div>参考代码</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >name = "toto"</font></div><div><font size="2"  >mylist = [ 1,2,3,4,5 ]</font></div><div><font size="2"  >$redis.pipelined{ mylist.each{ |x| $redis.lpush(name,x) } }</font></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>