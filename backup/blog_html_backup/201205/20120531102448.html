<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Londiste 3 replicate case - 1 下节</h2>
	<h5 id="">2012-05-31 10:24:48&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402012431102448951/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>【上节URL】</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201243051338137/"  >http://blog.163.com/digoal@126/blog/static/163877040201243051338137/</a> </div><div><br></div><div><div><div style="line-height: 22px;"  >-- 接下来测试一下复制是否正确, 在主节点上开启pgbench做数据更改的压力测试.</div><div style="line-height: 22px;"  ><br style="line-height: 22px;"  ></div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; cat login.sql&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >\setrandom userid 1 200000</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >select userid,engname,cnname,occupation,birthday,signname,email,qq from user_info where userid=:userid;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >insert into user_login_rec (userid,login_time,ip) values (:userid,now(),inet_client_addr());</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >update user_session set logintime=now(),login_count=login_count+1 where userid=:userid;</font></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></span></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><span style="line-height: 22px;"  >postgres@db5-&gt; cat logout.sql</span> </font></div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >\setrandom userid 1 200000</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >insert into user_logout_rec (userid,logout_time,ip) values (:userid,now(),inet_client_addr());</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >update user_session set logouttime=now(),online_interval=online_interval+(now()-logintime) where userid=:userid;</font></div></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; pgbench -M prepared -f ./login.sql -j 2 -c 2 -n -r -h 127.0.0.1 -p 1921 -U digoal_01 -T 120 digoal_01 &amp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><span style="line-height: 22px;"  >postgres@db5-&gt; pgbench -M prepared -f ./logout.sql -j 2 -c 2 -n -r -h 127.0.0.1 -p 1921 -U digoal_01 -T 120 digoal_01 &amp;</span> </font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >transaction type: Custom query</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >scaling factor: 1</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >query mode: prepared</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >number of clients: 2</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >number of threads: 2</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >duration: 120 s</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >number of transactions actually processed: 318962</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >tps = 2616.506274 (including connections establishing)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >tps = 2616.586583 (excluding connections establishing)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.002284 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 200000</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.112055 &nbsp; &nbsp; &nbsp; &nbsp;select userid,engname,cnname,occupation,birthday,signname,email,qq from user_info where userid=:userid;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.260081 &nbsp; &nbsp; &nbsp; &nbsp;insert into user_login_rec (userid,login_time,ip) values (:userid,now(),inet_client_addr());</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.378190 &nbsp; &nbsp; &nbsp; &nbsp;update user_session set logintime=now(),login_count=login_count+1 where userid=:userid;</font></div></div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >transaction type: Custom query</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >scaling factor: 1</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >query mode: prepared</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >number of clients: 2</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >number of threads: 2</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >duration: 120 s</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >number of transactions actually processed: 620568</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >tps = 5143.160023 (including connections establishing)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >tps = 5143.328868 (excluding connections establishing)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >statement latencies in milliseconds:</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.002408 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom userid 1 20000000</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.258112 &nbsp; &nbsp; &nbsp; &nbsp;insert into user_logout_rec (userid,logout_time,ip) values (:userid,now(),inet_client_addr());</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.122814 &nbsp; &nbsp; &nbsp; &nbsp;update user_session set logouttime=now(),online_interval=online_interval+(now()-logintime) where userid=:userid;</font></div></div><p style="line-height: 22px;"  ></p></pre></div><div style="line-height: 22px;"  ><br style="line-height: 22px;"  ></div><div style="line-height: 22px;"  >-- 并行度是1的情况下, 同一时间只有一个表在同步</div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; londiste3 /home/postgres/londiste3/dst1_digoal_01.ini tables</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >Tables on node</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >table_name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; merge_state &nbsp; &nbsp; &nbsp;table_attrs</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >------------------------- &nbsp;--------------- &nbsp;---------------</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >digoal_01.user_info &nbsp; &nbsp; &nbsp; &nbsp;wanna-sync:1558 &nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >digoal_01.user_login_rec &nbsp; ok &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >digoal_01.user_logout_rec &nbsp;ok &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >digoal_01.user_session &nbsp; &nbsp; None</font></div><p style="line-height: 22px;"  ></p></pre></div><div style="line-height: 22px;"  ><br style="line-height: 22px;"  ></div><div style="line-height: 22px;"  >-- 接下来修改一下并行度</div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >parallel_copies = 16 添加到dst1_digoal_01.ini和src_digoal_01.ini然后reload</font></div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; londiste3 -r /home/postgres/londiste3/src_digoal_01.ini&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; londiste3 -r /home/postgres/londiste3/dst1_digoal_01.ini&nbsp;</font></div></div><p style="line-height: 22px;"  ></p></pre></div><div style="line-height: 22px;"  ><br style="line-height: 22px;"  ></div><div style="line-height: 22px;"  >-- 现在复制就很快了</div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >londiste3 /home/postgres/londiste3/dst1_digoal_01.ini tables</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >Tables on node</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >table_name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; merge_state &nbsp; &nbsp; &nbsp;table_attrs</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >------------------------- &nbsp;--------------- &nbsp;---------------</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >digoal_01.user_info &nbsp; &nbsp; &nbsp; &nbsp;ok &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >digoal_01.user_login_rec &nbsp; ok &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >digoal_01.user_logout_rec &nbsp;ok &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >digoal_01.user_session &nbsp; &nbsp; ok&nbsp;</font></div><p style="line-height: 22px;"  ></p></pre></div><div style="line-height: 22px;"  ><br style="line-height: 22px;"  ></div><div style="line-height: 22px;"  >-- pgbench执行完后马上去执行compare, 由于目标库1 还在执行queue里面的SQL, 所以显示如下.</div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; londiste3 /home/postgres/londiste3/dst1_digoal_01.ini compare</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:11:03,224 30974 ERROR Consumer lagging too much, cannot proceed</font></div><p style="line-height: 22px;"  ></p></pre></div><div style="line-height: 22px;"  ><br style="line-height: 22px;"  ></div><div style="line-height: 22px;"  >-- 大概过150秒后再次执行compare, 已经同步完成. checksum一致.</div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; londiste3 /home/postgres/londiste3/dst1_digoal_01.ini compare</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:13:41,442 31116 INFO Locking digoal_01.user_info</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:13:41,442 31116 INFO Syncing digoal_01.user_info</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:13:44,950 31116 INFO Counting digoal_01.user_info</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:13:46,085 31116 INFO srcdb: 200000 rows, checksum=545503592610</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:13:46,861 31116 INFO dstdb: 200000 rows, checksum=545503592610</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:13:46,863 31116 INFO Locking digoal_01.user_session</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:13:46,863 31116 INFO Syncing digoal_01.user_session</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:13:49,868 31116 INFO Counting digoal_01.user_session</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:13:50,642 31116 INFO srcdb: 200000 rows, checksum=-132792841596</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:13:51,229 31116 INFO dstdb: 200000 rows, checksum=-132792841596</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:13:51,231 31116 INFO Locking digoal_01.user_login_rec</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:13:51,231 31116 INFO Syncing digoal_01.user_login_rec</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:13:54,739 31116 INFO Counting digoal_01.user_login_rec</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:14:13,845 31116 INFO srcdb: 5007284 rows, checksum=-2059054881703</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:14:26,583 31116 INFO dstdb: 5007284 rows, checksum=-2059054881703</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:14:26,585 31116 INFO Locking digoal_01.user_logout_rec</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:14:26,586 31116 INFO Syncing digoal_01.user_logout_rec</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:14:30,094 31116 INFO Counting digoal_01.user_logout_rec</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:14:34,920 31116 INFO srcdb: 1250644 rows, checksum=1378863938106</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:14:38,163 31116 INFO dstdb: 1250644 rows, checksum=1378863938106</font></div><p style="line-height: 22px;"  ></p></pre></div><div style="line-height: 22px;"  ><br style="line-height: 22px;"  ></div><div style="line-height: 22px;"  >-- 默认compare的配置以及用到的SQL如下 :&nbsp;</div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >## compare/repair</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># max amount of time table can be locked</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >#lock_timeout = 10</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># compare: sql to use</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >#compare_sql = select count(1) as cnt, sum(hashtext(t.*::text)) as chksum from only _TABLE_ t</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >#compare_fmt = %(cnt)d rows, checksum=%(chksum)s</font></div><p style="line-height: 22px;"  ></p></pre></div><div style="line-height: 22px;"  ><br style="line-height: 22px;"  ></div><div style="line-height: 22px;"  >-- 接下来要考验一下londiste3的处理网络故障的能力. 即把目标库断开, 再连上. 我这里关闭目标库1来模拟.</div><div style="line-height: 22px;"  >-- 关闭目标库1</div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >pg92@db-172-16-3-33-&gt; pg_ctl stop -m fast</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >waiting for server to shut down.... done</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >server stopped</font></div><p style="line-height: 22px;"  ></p></pre></div><div style="line-height: 22px;"  >-- 在主库开启pgbench</div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; pgbench -M prepared -f ./login.sql -j 2 -c 2 -n -r -h 127.0.0.1 -p 1921 -U digoal_01 -T 120 digoal_01 &amp;</font></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; pgbench -M prepared -f ./logout.sql -j 2 -c 2 -n -r -h 127.0.0.1 -p 1921 -U digoal_01 -T 120 digoal_01 &amp;</font></span></div><p style="line-height: 22px;"  ></p></pre></div></div><div style="line-height: 22px;"  ><br style="line-height: 22px;"  ></div><div style="line-height: 22px;"  >-- 查看dst1_digoal_01.log, 表示已经连不上目标库1了.</div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:19:18,509 10706 WARNING Failure to call pgq_node.set_consumer_error()</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:19:18,509 10706 ERROR Job dst1_digoal_01 crashed: could not connect to server: Connection refused</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; &nbsp; &nbsp; Is the server running on host "172.16.3.33" and accepting</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; &nbsp; &nbsp; TCP/IP connections on port 1919?</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >Traceback (most recent call last):</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; File "/opt/skytools3.0.2/lib/python2.7/site-packages/pgq/cascade/consumer.py", line 285, in exception_hook</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; dst_db = self.get_database(self.target_db)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; File "/opt/skytools3.0.2/lib/python2.7/site-packages/skytools/scripting.py", line 733, in get_database</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; return dbc.get_connection(params['isolation_level'], clist)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; File "/opt/skytools3.0.2/lib/python2.7/site-packages/skytools/scripting.py", line 948, in get_connection</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; self.conn = skytools.connect_database(self.loc)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; File "/opt/skytools3.0.2/lib/python2.7/site-packages/skytools/psycopgwrapper.py", line 135, in connect_database</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; db = _CompatConnection(connstr)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >OperationalError: could not connect to server: Connection refused</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; &nbsp; &nbsp; Is the server running on host "172.16.3.33" and accepting</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; &nbsp; &nbsp; TCP/IP connections on port 1919?</font></div><p style="line-height: 22px;"  ></p></pre></div><div style="line-height: 22px;"  ><br style="line-height: 22px;"  ></div><div style="line-height: 22px;"  >-- 查看一下QUQUE的内容 :&nbsp;</div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >digoal_01=# select * from pgq.event_1_2 limit 10;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; ev_id &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ev_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| ev_txid &nbsp;| ev_owner | ev_retry | ev_type &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; ev_data &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;ev_extra1 &nbsp; &nbsp; &nbsp; &nbsp; | ev_extra2 | ev_extra3 | ev_extra4&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >---------+-------------------------------+----------+----------+----------+----------+----------------------------------------------</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >--------------------------------------------------------------+--------------------------+-----------+-----------+-----------</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp;3188535 | 2012-05-31 08:59:47.064327+08 | 20777539 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| U:userid | userid=29499&amp;logintime=2012%2d05%2d31+08%3a59</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >%3a47&amp;login_count=17&amp;logouttime&amp;online_interval=00%3a00%3a00 &nbsp;| digoal_01.user_session &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp;3188541 | 2012-05-31 08:59:47.064719+08 | 20777545 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| I:id &nbsp; &nbsp; | userid=101464&amp;login_time=2012%2d05%2d31+08%3a</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >59%3a47.064719&amp;ip=127.0.0.1&amp;id=4424162 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| digoal_01.user_login_rec | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp;3188543 | 2012-05-31 08:59:47.064955+08 | 20777547 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| U:userid | userid=101464&amp;logintime=2012%2d05%2d31+08%3a5</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >9%3a47&amp;login_count=13&amp;logouttime&amp;online_interval=00%3a00%3a00 | digoal_01.user_session &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp;3188548 | 2012-05-31 08:59:47.065316+08 | 20777551 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| I:id &nbsp; &nbsp; | userid=56992&amp;login_time=2012%2d05%2d31+08%3a5</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >9%3a47.065316&amp;ip=127.0.0.1&amp;id=4424164 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | digoal_01.user_login_rec | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp;3188551 | 2012-05-31 08:59:47.065573+08 | 20777555 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| U:userid | userid=56992&amp;logintime=2012%2d05%2d31+08%3a59</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >%3a47&amp;login_count=25&amp;logouttime&amp;online_interval=00%3a00%3a00 &nbsp;| digoal_01.user_session &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp;3188556 | 2012-05-31 08:59:47.065952+08 | 20777560 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| I:id &nbsp; &nbsp; | userid=190783&amp;login_time=2012%2d05%2d31+08%3a</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >59%3a47.065952&amp;ip=127.0.0.1&amp;id=4424166 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| digoal_01.user_login_rec | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp;3188558 | 2012-05-31 08:59:47.066187+08 | 20777562 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| U:userid | userid=190783&amp;logintime=2012%2d05%2d31+08%3a5</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >9%3a47&amp;login_count=16&amp;logouttime&amp;online_interval=00%3a00%3a00 | digoal_01.user_session &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp;3188563 | 2012-05-31 08:59:47.066566+08 | 20777567 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| I:id &nbsp; &nbsp; | userid=42506&amp;login_time=2012%2d05%2d31+08%3a5</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >9%3a47.066566&amp;ip=127.0.0.1&amp;id=4424168 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | digoal_01.user_login_rec | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp;3188566 | 2012-05-31 08:59:47.066788+08 | 20777570 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| U:userid | userid=42506&amp;logintime=2012%2d05%2d31+08%3a59</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >%3a47&amp;login_count=21&amp;logouttime&amp;online_interval=00%3a00%3a00 &nbsp;| digoal_01.user_session &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp;3188571 | 2012-05-31 08:59:47.067132+08 | 20777575 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| I:id &nbsp; &nbsp; | userid=23589&amp;login_time=2012%2d05%2d31+08%3a5</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >9%3a47.067132&amp;ip=127.0.0.1&amp;id=4424170 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | digoal_01.user_login_rec | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >(10 rows)</font></div><p style="line-height: 22px;"  ></p></pre></div><div style="line-height: 22px;"  ><br style="line-height: 22px;"  ></div><div style="line-height: 22px;"  >-- 执行完pgbench后, 开启目标库1, 看看数据能否正常复制过去.</div><div style="line-height: 22px;"  >-- 启动目标库1</div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >pg92@db-172-16-3-33-&gt; pg_ctl start</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >server starting</font></div><p style="line-height: 22px;"  ></p></pre></div><div style="line-height: 22px;"  >-- 查看目标库1的subscriber的状态</div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; londiste3 /home/postgres/londiste3/dst1_digoal_01.ini tables</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >Tables on node</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >table_name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; merge_state &nbsp; &nbsp; &nbsp;table_attrs</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >------------------------- &nbsp;--------------- &nbsp;---------------</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >digoal_01.user_info &nbsp; &nbsp; &nbsp; &nbsp;ok &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >digoal_01.user_login_rec &nbsp; ok &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >digoal_01.user_logout_rec &nbsp;ok &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >digoal_01.user_session &nbsp; &nbsp; ok &nbsp;</font></div><p style="line-height: 22px;"  ></p></pre></div><div style="line-height: 22px;"  >-- 查看目标库1上是否有复制SQL在执行, 注意看, 一次包含了多条SQL, 是batch的模式, 因为我的目标库1配置的track_activity_query_size = 1024, 所以通过pg_stat_activity.query无法查到全面的SQL, 时间上一个batch比这里看到的SQL远远要多.</div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >pg92@db-172-16-3-33-&gt; psql digoal_01 postgres</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >psql (9.2beta1)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >Type "help" for help.</font></div></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >digoal_01=# select client_addr,query from pg_stat_activity where client_addr='172.16.3.176';</font></div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp;client_addr &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; query &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >--------------+---------------------------------------------------------------------------------------------------------------------</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >--------------------------------------------------</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp;172.16.3.176 | update only digoal_01.user_session set online_interval = '00:00:00', login_count = '18', logintime = '2012-05-31 09:</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >20:17', logouttime = null where userid = '65376';+</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | insert into digoal_01.user_logout_rec (ip, userid, logout_time, id) values ('127.0.0.1', '940907', '2012-05-31 09:20</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >:16.75214', '1575012'); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | insert into digoal_01.user_login_rec (ip, userid, id, login_time) values ('127.0.0.1', '160682', '5202739', '2012-05</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >-31 09:20:16.752364'); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | insert into digoal_01.user_logout_rec (ip, userid, logout_time, id) values ('127.0.0.1', '19330841', '2012-05-31 09:</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >20:16.752426', '1575013'); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | insert into digoal_01.user_login_rec (ip, userid, id, login_time) values ('127.0.0.1', '62766', '5202740', '2012-05-</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >31 09:20:16.752488'); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | insert into digoal_01.user_logout_rec (ip, userid, logout_time, id) values ('127.0.0.1', '2407021', '2012-05-31 09:2</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >0:16.752483', '1575014'); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | update only digoal_01.user_session set online_interval = '00:00:00', login_count = '17', logintime = '2012-05-31 09:</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >20:17', logouttime = null where userid&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >(1 row)</font></div></div><p style="line-height: 22px;"  ></p></pre></div><div style="line-height: 22px;"  ><br style="line-height: 22px;"  ></div><div style="line-height: 22px;"  >-- 过2分钟后compare一下, 看看数据是否正常.</div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; londiste3 /home/postgres/londiste3/dst1_digoal_01.ini compare</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:27:28,895 31555 INFO Locking digoal_01.user_info</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:27:28,896 31555 INFO Syncing digoal_01.user_info</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:27:32,407 31555 INFO Counting digoal_01.user_info</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:27:33,543 31555 INFO srcdb: 200000 rows, checksum=545503592610</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:27:34,375 31555 INFO dstdb: 200000 rows, checksum=545503592610</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:27:34,377 31555 INFO Locking digoal_01.user_session</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:27:34,378 31555 INFO Syncing digoal_01.user_session</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:27:37,381 31555 INFO Counting digoal_01.user_session</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:27:38,160 31555 INFO srcdb: 200000 rows, checksum=661833980628</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:27:38,727 31555 INFO dstdb: 200000 rows, checksum=661833980628</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:27:38,728 31555 INFO Locking digoal_01.user_login_rec</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:27:38,729 31555 INFO Syncing digoal_01.user_login_rec</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:27:41,731 31555 INFO Counting digoal_01.user_login_rec</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:28:02,303 31555 INFO srcdb: 5342247 rows, checksum=-1165249103392</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:28:16,048 31555 INFO dstdb: 5342247 rows, checksum=-1165249103392</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:28:16,049 31555 INFO Locking digoal_01.user_logout_rec</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:28:16,050 31555 INFO Syncing digoal_01.user_logout_rec</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:28:19,556 31555 INFO Counting digoal_01.user_logout_rec</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:28:27,022 31555 INFO srcdb: 1922981 rows, checksum=1998341487944</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:28:32,027 31555 INFO dstdb: 1922981 rows, checksum=1998341487944</font></div><p style="line-height: 22px;"  ></p></pre></div><div style="line-height: 22px;"  ><br style="line-height: 22px;"  ></div><div style="line-height: 22px;"  >-- 看看truncate能不能复制</div><div style="line-height: 22px;"  >-- 主库执行</div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; psql digoal_01 digoal_01</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >psql (9.1.3)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >Type "help" for help.</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >digoal_01=&gt; TRUNCATE user_login_rec ;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >TRUNCATE TABLE</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >digoal_01=&gt; TRUNCATE user_logout_rec ;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >TRUNCATE TABLE</font></div><p style="line-height: 22px;"  ></p></pre></div><div style="line-height: 22px;"  >-- compare比较结果如下, 说明truncate可以正常复制.</div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; londiste3 /home/postgres/londiste3/dst1_digoal_01.ini compare</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:29:12,317 31598 INFO Locking digoal_01.user_info</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:29:12,318 31598 INFO Syncing digoal_01.user_info</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:29:15,327 31598 INFO Counting digoal_01.user_info</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:29:16,458 31598 INFO srcdb: 200000 rows, checksum=545503592610</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:29:17,244 31598 INFO dstdb: 200000 rows, checksum=545503592610</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:29:17,246 31598 INFO Locking digoal_01.user_session</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:29:17,246 31598 INFO Syncing digoal_01.user_session</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:29:20,756 31598 INFO Counting digoal_01.user_session</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:29:21,531 31598 INFO srcdb: 200000 rows, checksum=661833980628</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:29:22,040 31598 INFO dstdb: 200000 rows, checksum=661833980628</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:29:22,042 31598 INFO Locking digoal_01.user_login_rec</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:29:22,042 31598 INFO Syncing digoal_01.user_login_rec</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:29:25,549 31598 INFO Counting digoal_01.user_login_rec</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:29:25,550 31598 INFO srcdb: 0 rows, checksum=None</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:29:25,551 31598 INFO dstdb: 0 rows, checksum=None</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:29:25,552 31598 INFO Locking digoal_01.user_logout_rec</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:29:25,552 31598 INFO Syncing digoal_01.user_logout_rec</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:29:28,555 31598 INFO Counting digoal_01.user_logout_rec</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:29:28,556 31598 INFO srcdb: 0 rows, checksum=None</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:29:28,557 31598 INFO dstdb: 0 rows, checksum=None</font></div><p style="line-height: 22px;"  ></p></pre></div><div style="line-height: 22px;"  ><br style="line-height: 22px;"  ></div><div style="line-height: 22px;"  >-- 接下来模拟provider和consumer, pgqd的进程异常的情况, 看看能不能正常复制.</div><div style="line-height: 22px;"  >-- 关闭provider,consumer,pgqd进程</div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; pgqd -s /home/postgres/londiste3/pgqd.ini&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >SIGINT sent</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; londiste3 -s /home/postgres/londiste3/src_digoal_01.ini&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; londiste3 -s /home/postgres/londiste3/dst1_digoal_01.ini</font></div><p style="line-height: 22px;"  ></p></pre></div><div style="line-height: 22px;"  >-- 开启pgbench压力测试</div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; pgbench -M prepared -f ./login.sql -j 2 -c 2 -n -r -h 127.0.0.1 -p 1921 -U digoal_01 -T 120 digoal_01 &amp;</font></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; pgbench -M prepared -f ./logout.sql -j 2 -c 2 -n -r -h 127.0.0.1 -p 1921 -U digoal_01 -T 120 digoal_01 &amp;</font></span></div><p style="line-height: 22px;"  ></p></pre></div></div><div style="line-height: 22px;"  >-- 压力测试完后, 开启<span style="line-height: 22px;"  >provider,consumer,pgqd进程</span></div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; londiste3 -d /home/postgres/londiste3/src_digoal_01.ini worker</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; londiste3 -d /home/postgres/londiste3/dst1_digoal_01.ini worker</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; pgqd -d /home/postgres/londiste3/pgqd.ini&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:39:22.321 31878 LOG Starting pgqd 3.0.2</font></div><p style="line-height: 22px;"  ></p></pre></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >-- 过2分钟左右compare主库和目标库1, 结果如下, 表示复制正常</span></div></div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; londiste3 /home/postgres/londiste3/dst1_digoal_01.ini compare</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:43:45,693 32038 INFO Locking digoal_01.user_info</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:43:45,694 32038 INFO Syncing digoal_01.user_info</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:43:49,204 32038 INFO Counting digoal_01.user_info</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:43:50,334 32038 INFO srcdb: 200000 rows, checksum=545503592610</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:43:51,123 32038 INFO dstdb: 200000 rows, checksum=545503592610</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:43:51,124 32038 INFO Locking digoal_01.user_session</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:43:51,125 32038 INFO Syncing digoal_01.user_session</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:43:54,133 32038 INFO Counting digoal_01.user_session</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:43:54,938 32038 INFO srcdb: 200000 rows, checksum=455874670113</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:43:55,549 32038 INFO dstdb: 200000 rows, checksum=455874670113</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:43:55,551 32038 INFO Locking digoal_01.user_login_rec</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:43:55,552 32038 INFO Syncing digoal_01.user_login_rec</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:43:58,554 32038 INFO Counting digoal_01.user_login_rec</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:43:59,707 32038 INFO srcdb: 299331 rows, checksum=-307537943288</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:44:00,474 32038 INFO dstdb: 299331 rows, checksum=-307537943288</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:44:00,476 32038 INFO Locking digoal_01.user_logout_rec</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:44:00,476 32038 INFO Syncing digoal_01.user_logout_rec</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:44:03,480 32038 INFO Counting digoal_01.user_logout_rec</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:44:05,790 32038 INFO srcdb: 595666 rows, checksum=314887387132</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:44:07,340 32038 INFO dstdb: 595666 rows, checksum=314887387132</font></div><p style="line-height: 22px;"  ></p></pre></div><div style="line-height: 22px;"  ><br style="line-height: 22px;"  ></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >六、从主库复制到目标库2</span></div><div style="line-height: 22px;"  >-- 这个测试中, 目标库2的库名和主库不一样, 目标库2的表名和主库不一样, 目标库2的schema名和主库不一样.&nbsp;</div><div style="line-height: 22px;"  >-- 同时只复制满足条件的记录. where userid&lt;1000</div><div style="line-height: 22px;"  >-- 创建配置文件</div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >vi&nbsp;/home/postgres/londiste3/dst2_digoal_02.ini</font></div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >[londiste3]</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >job_name = dst2_digoal_02</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >db = host=172.16.3.33 port=1919 user=postgres dbname=digoal_02 password=postgres</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >queue_name = replika</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >logfile = /home/postgres/londiste3/log/dst2_digoal_02.log</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >pidfile = /home/postgres/londiste3/pid/dst2_digoal_02.pid</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >parallel_copies = 16</font></div></div><p style="line-height: 22px;"  ></p></pre></div><div style="line-height: 22px;"  ><br style="line-height: 22px;"  ></div><div style="line-height: 22px;"  >-- 创建页节点</div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; londiste3 -v /home/postgres/londiste3/dst2_digoal_02.ini create-leaf dst2_digoal_02 "host=172.16.3.33 port=1919 user=postgres dbname=digoal_02 password=postgres" --provider="host=172.16.3.176 port=1921 user=postgres dbname=digoal_01 password=postgres"</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:04,882 32287 DEBUG Connect 'new_node' to 'host=172.16.3.33 port=1919 user=postgres dbname=digoal_02 &nbsp;[...]'</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:04,889 32287 INFO plpgsql is installed</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:04,889 32287 INFO Installing pgq</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:04,890 32287 INFO &nbsp; Reading from /opt/skytools3.0.2/share/skytools3/pgq.sql</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:05,268 32287 INFO pgq.get_batch_cursor is installed</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:05,268 32287 INFO Installing pgq_ext</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:05,268 32287 INFO &nbsp; Reading from /opt/skytools3.0.2/share/skytools3/pgq_ext.sql</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:05,419 32287 INFO Installing pgq_node</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:05,419 32287 INFO &nbsp; Reading from /opt/skytools3.0.2/share/skytools3/pgq_node.sql</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:05,615 32287 INFO Installing londiste</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:05,615 32287 INFO &nbsp; Reading from /opt/skytools3.0.2/share/skytools3/londiste.sql</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:05,852 32287 INFO londiste.global_add_table is installed</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:05,853 32287 DEBUG exec_query: select * from pgq_node.get_node_info('replika')</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:05,856 32287 INFO Initializing node</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:05,856 32287 DEBUG Connect 'root_db' to 'host=172.16.3.176 port=1921 user=postgres dbname=digoal_01 &nbsp;[...]'</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:05,859 32287 DEBUG exec_query: select * from pgq_node.get_node_info('replika')</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:05,868 32287 DEBUG db='host=172.16.3.176 port=1921 user=postgres dbname=digoal_01 password=postgres' -- type='root' provider='host=172.16.3.176 port=1921 user=postgres dbname=digoal_01 password=postgres'</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:05,868 32287 DEBUG exec_query: select * from pgq_node.get_node_info('replika')</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:05,870 32287 DEBUG exec_query: select * from pgq_node.get_queue_locations('replika')</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:05,871 32287 DEBUG Connect 'provider_db' to 'host=172.16.3.176 port=1921 user=postgres dbname=digoal_01 &nbsp;[...]'</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:05,874 32287 DEBUG exec_query: select node_type, node_name from pgq_node.get_node_info('replika')</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:05,883 32287 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'dst2_digoal_02', 'host=172.16.3.33 port=1919 user=postgres dbname=digoal_02 password=postgres', false)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:05,886 32287 INFO Location registered</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:05,886 32287 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'dst2_digoal_02', 'host=172.16.3.33 port=1919 user=postgres dbname=digoal_02 password=postgres', false)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:05,889 32287 INFO Location registered</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:05,889 32287 DEBUG exec_cmd: select * from pgq_node.register_subscriber('replika', 'dst2_digoal_02', 'dst2_digoal_02', null)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:05,893 32287 INFO Subscriber registered: dst2_digoal_02</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:05,894 32287 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'dst2_digoal_02', 'host=172.16.3.33 port=1919 user=postgres dbname=digoal_02 password=postgres', false)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:05,895 32287 INFO Location registered</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:05,895 32287 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'src_digoal_01', 'host=172.16.3.176 port=1921 user=postgres dbname=digoal_01 password=postgres', 'False')</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:05,896 32287 INFO Location registered</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:05,896 32287 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'dst1_digoal_01', 'host=172.16.3.33 port=1919 user=postgres dbname=digoal_01 password=postgres', 'False')</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:05,897 32287 INFO Location registered</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:05,897 32287 DEBUG exec_cmd: select * from pgq_node.create_node('replika', 'leaf', 'dst2_digoal_02', 'dst2_digoal_02', 'src_digoal_01', '1944', null)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:05,900 32287 INFO Node "dst2_digoal_02" initialized for queue "replika" with type "leaf"</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:51:05,906 32287 INFO Done</font></div><p style="line-height: 22px;"  ></p></pre></div><div style="line-height: 22px;"  ><br style="line-height: 22px;"  ></div><div style="line-height: 22px;"  >-- 启动worker进程</div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; londiste3 -d /home/postgres/londiste3/dst2_digoal_02.ini worker</font></p></pre></div><div style="line-height: 22px;"  ><br style="line-height: 22px;"  ></div><div style="line-height: 22px;"  >-- 添加表</div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; londiste3 /home/postgres/londiste3/dst2_digoal_02.ini add-table --dest-table=digoal_02.user_info1 --copy-condition="userid&lt;1000" digoal_01.user_info</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:53:56,235 32362 INFO Table added: digoal_01.user_info(digoal_02.user_info1)</font></div></div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; londiste3 /home/postgres/londiste3/dst2_digoal_02.ini add-table --dest-table=digoal_02.user_session1 --copy-condition="userid&lt;1000" digoal_01.user_session</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:54:26,298 32377 INFO Table added: digoal_01.user_session(digoal_02.user_session1)</font></div></div><p style="line-height: 22px;"  ></p></pre></div><div style="line-height: 22px;"  ><br style="line-height: 22px;"  ></div><div style="line-height: 22px;"  >-- 查看复制状态</div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; londiste3 /home/postgres/londiste3/dst2_digoal_02.ini tables</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >Tables on node</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >table_name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;merge_state &nbsp; &nbsp; &nbsp;table_attrs</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >---------------------- &nbsp;--------------- &nbsp;----------------------------</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >digoal_01.user_info &nbsp; &nbsp; in-copy &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{'copy_condition': 'userid&lt;1000'}</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >digoal_01.user_session &nbsp;in-copy &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{'copy_condition': 'userid&lt;1000'}</font></div><p style="line-height: 22px;"  ></p></pre></div><div style="line-height: 22px;"  ><br style="line-height: 22px;"  ></div><div style="line-height: 22px;"  >-- compare比较, 由于目标库2只复制了部分记录, 所以checksum和记录数不一致</div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; londiste3 /home/postgres/londiste3/dst2_digoal_02.ini compare</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:55:43,611 32418 INFO Locking digoal_01.user_info</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:55:43,612 32418 INFO Syncing digoal_02.user_info1</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:55:47,121 32418 INFO Counting digoal_02.user_info1</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:55:48,259 32418 INFO srcdb: 200000 rows, checksum=545503592610</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:55:48,264 32418 INFO dstdb: 999 rows, checksum=19444530475</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:55:48,265 32418 WARNING digoal_02.user_info1: Results do not match!</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:55:48,266 32418 INFO Locking digoal_01.user_session</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:55:48,267 32418 INFO Syncing digoal_02.user_session1</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:55:50,773 32418 INFO Counting digoal_02.user_session1</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:55:51,556 32418 INFO srcdb: 200000 rows, checksum=455874670113</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:55:51,559 32418 INFO dstdb: 999 rows, checksum=-69913661777</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:55:51,559 32418 WARNING digoal_02.user_session1: Results do not match!</font></div><p style="line-height: 22px;"  ></p></pre></div><div style="line-height: 22px;"  ><br style="line-height: 22px;"  ></div><div style="line-height: 22px;"  >-- 为了得到正确的compare,目前没有好的解决办法, 通过修改配置文件暂时使用, 不适用, 因为其他表可能没有或不是这个条件.</div><div style="line-height: 22px;"  >-- 以下是测试, 注意生产中不要这样使用. 非要这么用的话就写多个配置文件.</div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; vi dst2_digoal_02.ini&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >[londiste3]</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >job_name = dst2_digoal_02</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >db = host=172.16.3.33 port=1919 user=postgres dbname=digoal_02 password=postgres</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >queue_name = replika</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >logfile = /home/postgres/londiste3/log/dst2_digoal_02.log</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >pidfile = /home/postgres/londiste3/pid/dst2_digoal_02.pid</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >parallel_copies = 16</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >compare_sql = select count(1) as cnt, sum(hashtext(t.*::text)) as chksum from only _TABLE_ t where userid&lt;1000</font></div></div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; londiste3 -r /home/postgres/londiste3/dst2_digoal_02.ini&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; londiste3 /home/postgres/londiste3/dst2_digoal_02.ini compare</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:59:09,559 32498 INFO Locking digoal_01.user_info</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:59:09,560 32498 INFO Syncing digoal_02.user_info1</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:59:13,568 32498 INFO Counting digoal_02.user_info1</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:59:13,576 32498 INFO srcdb: 999 rows, checksum=19444530475</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:59:13,581 32498 INFO dstdb: 999 rows, checksum=19444530475</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:59:13,582 32498 INFO Locking digoal_01.user_session</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:59:13,583 32498 INFO Syncing digoal_02.user_session1</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:59:17,589 32498 INFO Counting digoal_02.user_session1</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:59:17,597 32498 INFO srcdb: 999 rows, checksum=-69913661777</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 09:59:17,601 32498 INFO dstdb: 999 rows, checksum=-69913661777</font></div></div><p style="line-height: 22px;"  ></p></pre></div><div style="line-height: 22px;"  ><br style="line-height: 22px;"  ></div><div style="line-height: 22px;"  >-- 写多个配置文件的用法, compare用专用的配置文件.</div><div style="line-height: 22px;"  >-- 把dst2_digoal_02.ini恢复, 并reload.</div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; cat dst2_digoal_02.ini&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >[londiste3]</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >job_name = dst2_digoal_02</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >db = host=172.16.3.33 port=1919 user=postgres dbname=digoal_02 password=postgres</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >queue_name = replika</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >logfile = /home/postgres/londiste3/log/dst2_digoal_02.log</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >pidfile = /home/postgres/londiste3/pid/dst2_digoal_02.pid</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >parallel_copies = 16</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; londiste3 -r /home/postgres/londiste3/dst2_digoal_02.ini&nbsp;</font></div><p style="line-height: 22px;"  ></p></pre></div><div style="line-height: 22px;"  >-- 新建一个配置文件, 专用于比较</div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; cat dst2_digoal_02_compare.ini&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >[londiste3]</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >job_name = dst2_digoal_02</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >db = host=172.16.3.33 port=1919 user=postgres dbname=digoal_02 password=postgres</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >queue_name = replika</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >logfile = /home/postgres/londiste3/log/dst2_digoal_02.log</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >pidfile = /home/postgres/londiste3/pid/dst2_digoal_02.pid</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >parallel_copies = 16</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >compare_sql = select count(1) as cnt, sum(hashtext(t.*::text)) as chksum from only _TABLE_ t where userid&lt;1000</font></div><p style="line-height: 22px;"  ></p></pre></div><div style="line-height: 22px;"  >-- 使用这个配置文件进行比较, 这样比较复杂, 但是很安全.</div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; londiste3 /home/postgres/londiste3/dst2_digoal_02_compare.ini compare</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 10:03:55,834 32689 INFO Locking digoal_01.user_info</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 10:03:55,835 32689 INFO Syncing digoal_02.user_info1</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 10:03:58,339 32689 INFO Counting digoal_02.user_info1</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 10:03:58,346 32689 INFO srcdb: 999 rows, checksum=19444530475</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 10:03:58,351 32689 INFO dstdb: 999 rows, checksum=19444530475</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 10:03:58,353 32689 INFO Locking digoal_01.user_session</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 10:03:58,353 32689 INFO Syncing digoal_02.user_session1</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 10:04:01,355 32689 INFO Counting digoal_02.user_session1</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 10:04:01,363 32689 INFO srcdb: 999 rows, checksum=-69913661777</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 10:04:01,367 32689 INFO dstdb: 999 rows, checksum=-69913661777</font></div><p style="line-height: 22px;"  ></p></pre></div><div style="line-height: 22px;"  ><br style="line-height: 22px;"  ></div><div style="line-height: 22px;"  >七、<span style="line-height: 22px;"  >测试添加字段</span></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >-- 把添加字段的SQL放到一个文件中执行. 目标库和主库的表名schema名一致的情况下, 可以正常的复制过去, 而不一致的情况下需要手工修复, 所以建议复制尽量一致.</span></div><div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; vi add_column.sql</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >begin;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >alter table digoal_01.user_info add column c1 int;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >alter table digoal_01.user_session add column c1 int;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >end;</font></div><p style="line-height: 22px;"  ></p></pre></div></div><div style="line-height: 22px;"  ><br style="line-height: 22px;"  ></div><div style="line-height: 22px;"  >-- 使用provider的配置文件执行,&nbsp;</div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; londiste3 /home/postgres/londiste3/src_digoal_01.ini execute ./add_column.sql&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 10:11:09,230 482 INFO Executing: add_column.sql</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 10:11:09,253 482 INFO Execute finished: add_column.sql</font></div><p style="line-height: 22px;"  ></p></pre></div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  >-- 使用consumer执行会报错如下</div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; londiste3 /home/postgres/londiste3/dst2_digoal_02.ini execute ./add_column.sql&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 10:14:52,014 584 ERROR Node is not root node: replika</font></div><p style="line-height: 22px;"  ></p></pre></div><div style="line-height: 22px;"  ><br style="line-height: 22px;"  ></div><div style="line-height: 22px;"  >-- 主库src_digoal_01.log日志</div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 10:11:09,230 482 INFO Executing: add_column.sql</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 10:11:09,253 482 INFO Execute finished: add_column.sql</font></div><p style="line-height: 22px;"  ></p></pre></div></div></div></div><div style="line-height: 22px;"  ><br style="line-height: 22px;"  ></div><div style="line-height: 22px;"  >-- 查看目标库1是否正常的添加了c1字段, 因为目标库1的schema和表名都和主库一致.</div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >dst1_digoal_01.log</font></div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 10:11:11,203 31872 INFO Executing: add_column.sql</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 10:11:11,224 31872 INFO Execute finished: add_column.sql</font></div></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >pg92@db-172-16-3-33-&gt; psql digoal_01 digoal_01</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >psql (9.2beta1)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >Type "help" for help.</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 22px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >digoal_01=&gt; \d user_info&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Table "digoal_01.user_info"</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp;Column &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Modifiers&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >------------+-----------------------------+-----------</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp;userid &nbsp; &nbsp; | integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | not null</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp;engname &nbsp; &nbsp;| text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp;cnname &nbsp; &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp;occupation | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp;birthday &nbsp; | date &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp;signname &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp;email &nbsp; &nbsp; &nbsp;| text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp;qq &nbsp; &nbsp; &nbsp; &nbsp; | numeric &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp;crt_time &nbsp; | timestamp without time zone |&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp;mod_time &nbsp; | timestamp without time zone |&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp;c1 &nbsp; &nbsp; &nbsp; &nbsp; | integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >Indexes:</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; "pk_user_info" PRIMARY KEY, btree (userid)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >Triggers:</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; _londiste_replika AFTER INSERT OR DELETE OR UPDATE ON user_info FOR EACH ROW EXECUTE PROCEDURE pgq.logutriga('replika', 'deny')</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; _londiste_replika_truncate AFTER TRUNCATE ON user_info FOR EACH STATEMENT EXECUTE PROCEDURE pgq.sqltriga('replika', 'deny')</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 22px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >digoal_01=&gt; \d user_session&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Table "digoal_01.user_session"</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; &nbsp;Column &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Modifiers &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >-----------------+--------------------------------+------------------------------</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp;userid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp;logintime &nbsp; &nbsp; &nbsp; | timestamp(0) without time zone |&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp;login_count &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | default 0</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp;logouttime &nbsp; &nbsp; &nbsp;| timestamp(0) without time zone |&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp;online_interval | interval &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | default '00:00:00'::interval</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp;c1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >Indexes:</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; "pk_user_session" PRIMARY KEY, btree (userid)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >Triggers:</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; _londiste_replika AFTER INSERT OR DELETE OR UPDATE ON user_session FOR EACH ROW EXECUTE PROCEDURE pgq.logutriga('replika', 'deny')</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; _londiste_replika_truncate AFTER TRUNCATE ON user_session FOR EACH STATEMENT EXECUTE PROCEDURE pgq.sqltriga('replika', 'deny')</font></div></div><p style="line-height: 22px;"  ></p></pre></div><div><div style="line-height: 22px;"  ><br style="line-height: 22px;"  ></div><div style="line-height: 22px;"  >-- 目标库2没有添加c1和c2字段, 所以需要手工执行. 因为目标库2的schema名和表名不一致, 报错如下.</div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 10:16:50,921 32303 INFO Executing: add_column.sql</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >2012-05-31 10:16:50,928 32303 ERROR Job dst2_digoal_02 got error on connection 'db': schema "digoal_01" does not exist. &nbsp; Query: alt</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >er table digoal_01.user_info add column c1 int;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >Traceback (most recent call last):</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; File "/opt/skytools3.0.2/lib/python2.7/site-packages/skytools/scripting.py", line 565, in run_func_safely</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; return func()</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; File "/opt/skytools3.0.2/lib/python2.7/site-packages/pgq/cascade/consumer.py", line 199, in work</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; return Consumer.work(self)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; File "/opt/skytools3.0.2/lib/python2.7/site-packages/pgq/consumer.py", line 257, in work</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; self._launch_process_batch(db, batch_id, ev_list)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; File "/opt/skytools3.0.2/lib/python2.7/site-packages/pgq/consumer.py", line 286, in _launch_process_batch</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; self.process_batch(db, batch_id, list)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; File "/opt/skytools3.0.2/lib/python2.7/site-packages/pgq/cascade/consumer.py", line 172, in process_batch</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; self.process_remote_batch(src_db, tick_id, event_list, dst_db)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; File "/opt/skytools3.0.2/lib/python2.7/site-packages/londiste/playback.py", line 368, in process_remote_batch</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; CascadedWorker.process_remote_batch(self, src_db, tick_id, ev_list, dst_db)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; File "/opt/skytools3.0.2/lib/python2.7/site-packages/pgq/cascade/worker.py", line 155, in process_remote_batch</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; self.process_remote_event(src_curs, dst_curs, ev)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; File "/opt/skytools3.0.2/lib/python2.7/site-packages/londiste/playback.py", line 597, in process_remote_event</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; self.handle_execute_event(ev, dst_curs)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; File "/opt/skytools3.0.2/lib/python2.7/site-packages/londiste/playback.py", line 669, in handle_execute_event</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; dst_curs.execute(stmt)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; File "/opt/python2.7.3/lib/python2.7/site-packages/psycopg2/extras.py", line 123, in execute</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >&nbsp; &nbsp; return _cursor.execute(self, query, vars)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >ProgrammingError: schema "digoal_01" does not exist</font></div><p style="line-height: 22px;"  ></p></pre></div><div style="line-height: 22px;"  >-- 手工执行</div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >pg92@db-172-16-3-33-&gt; psql digoal_02 digoal_02</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >psql (9.2beta1)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >Type "help" for help.</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >digoal_02=&gt; begin;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >BEGIN</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >digoal_02=&gt; alter table digoal_02.user_info1 add column c1 int;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >ALTER TABLE</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >digoal_02=&gt; alter table digoal_02.user_session1 add column c1 int;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >ALTER TABLE</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >digoal_02=&gt; end;</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >COMMIT</font></div><p style="line-height: 22px;"  ></p></pre></div><div style="line-height: 22px;"  >-- 这里还要注意, 手工执行完后, 目标库2的consumer上, 还会不停的去执行刚才队列里面的SQL, 通过状态我们可以看出.</div><div><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >postgres@db5-&gt; londiste3 /home/postgres/londiste3/dst2_digoal_02.ini status</font></div><div><div><font size="2"  >Queue: replika &nbsp; Local node: dst2_digoal_02</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >src_digoal_01 (root)</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Tables: 4/0/0</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Lag: 18s, Tick: 2238</font></div><div><font size="2"  >&nbsp; +--dst1_digoal_01 (leaf)</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Tables: 4/0/0</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Lag: 18s, Tick: 2238</font></div><div><font size="2"  >&nbsp; +--dst2_digoal_02 (leaf)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Tables: 2/0/2</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Lag: 2h10m42s, Tick: 2021</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ERR: dst2_digoal_02: schema "digoal_01" does not exist</font></div></div><p></p></pre></div><div><span style="line-height: 22px;"  >-- 日志的错误也一直会有, 而且后面发生的更改, 目标库2在解决这些异常前都不能执行下去.</span> </div><div><div><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >2012-05-31 12:28:44,500 32303 INFO Executing: add_column.sql</font></div><div style="line-height: 22px;"  ><font size="2"  >2012-05-31 12:28:44,507 32303 ERROR Job dst2_digoal_02 got error on connection 'db': schema "digoal_01" does not exist. &nbsp; Query: alt</font></div><div style="line-height: 22px;"  ><font size="2"  >er table digoal_01.user_info add column c1 int;</font></div><div style="line-height: 22px;"  ><font size="2"  >Traceback (most recent call last):</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; File "/opt/skytools3.0.2/lib/python2.7/site-packages/skytools/scripting.py", line 565, in run_func_safely</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; return func()</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; File "/opt/skytools3.0.2/lib/python2.7/site-packages/pgq/cascade/consumer.py", line 199, in work</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; return Consumer.work(self)</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; File "/opt/skytools3.0.2/lib/python2.7/site-packages/pgq/consumer.py", line 257, in work</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; self._launch_process_batch(db, batch_id, ev_list)</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; File "/opt/skytools3.0.2/lib/python2.7/site-packages/pgq/consumer.py", line 286, in _launch_process_batch</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; self.process_batch(db, batch_id, list)</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; File "/opt/skytools3.0.2/lib/python2.7/site-packages/pgq/cascade/consumer.py", line 172, in process_batch</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; self.process_remote_batch(src_db, tick_id, event_list, dst_db)</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; File "/opt/skytools3.0.2/lib/python2.7/site-packages/londiste/playback.py", line 368, in process_remote_batch</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; CascadedWorker.process_remote_batch(self, src_db, tick_id, ev_list, dst_db)</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; File "/opt/skytools3.0.2/lib/python2.7/site-packages/pgq/cascade/worker.py", line 155, in process_remote_batch</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; self.process_remote_event(src_curs, dst_curs, ev)</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; File "/opt/skytools3.0.2/lib/python2.7/site-packages/londiste/playback.py", line 597, in process_remote_event</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; self.handle_execute_event(ev, dst_curs)</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; File "/opt/skytools3.0.2/lib/python2.7/site-packages/londiste/playback.py", line 669, in handle_execute_event</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; dst_curs.execute(stmt)</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; File "/opt/python2.7.3/lib/python2.7/site-packages/psycopg2/extras.py", line 123, in execute</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; return _cursor.execute(self, query, vars)</font></div><div style="line-height: 22px;"  ><font size="2"  >ProgrammingError: schema "digoal_01" does not exist</font></div><p></p></pre></div><div style="line-height: 22px;"  >-- 那么怎么解决呢, 一种办法是跳过这个ticker_id, 让目标库2跳过这些SQL.</div><div style="line-height: 22px;"  >-- 另一种办法是在目标库2上新建digoal_01 schema以及user_info和user_session表, 让这个ticker可以在目标库2上执行下去. 通过之后再删掉这个临时用的schema.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pg92@db-172-16-3-33-&gt; psql digoal_02 digoal_02</font></div><div><font size="2"  >psql (9.2beta1)</font></div><div><font size="2"  >Type "help" for help.</font></div><div><font size="2"  >digoal_02=&gt; create schema digoal_01;</font></div><div><font size="2"  >CREATE SCHEMA</font></div><div><font size="2"  >digoal_02=&gt; create table digoal_01.user_info(id int);</font></div><div><font size="2"  >CREATE TABLE</font></div><div><font size="2"  >digoal_02=&gt; create table digoal_01.user_session(id int);</font></div><div><font size="2"  >CREATE TABLE</font></div><p></p></pre></div></div><div>-- 等会在看看状态, 正常后删除这个schema .</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; londiste3 /home/postgres/londiste3/dst2_digoal_02.ini status</font></div><div><font size="2"  >Queue: replika &nbsp; Local node: dst2_digoal_02</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >src_digoal_01 (root)</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Tables: 4/0/0</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Lag: 19s, Tick: 2266</font></div><div><font size="2"  >&nbsp; +--dst1_digoal_01 (leaf)</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Tables: 4/0/0</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Lag: 19s, Tick: 2266</font></div><div><font size="2"  >&nbsp; +--dst2_digoal_02 (leaf)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Tables: 2/0/2</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Lag: 19s, Tick: 2266</font></div><p></p></pre></div><div>-- 删除临时schema</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal_02=&gt; select * from digoal_01.user_info ;</font></div><div><font size="2"  >&nbsp;id | c1&nbsp;</font></div><div><font size="2"  >----+----</font></div><div><font size="2"  >(0 rows)</font></div><div><font size="2"  >digoal_02=&gt; select * from digoal_01.user_session ;</font></div><div><font size="2"  >&nbsp;id | c1&nbsp;</font></div><div><font size="2"  >----+----</font></div><div><font size="2"  >(0 rows)</font></div></div><div><div><font size="2"  >digoal_02=&gt; drop schema digoal_01 cascade;</font></div><div><font size="2"  >NOTICE: &nbsp;drop cascades to 2 other objects</font></div><div><font size="2"  >DETAIL: &nbsp;drop cascades to table digoal_01.user_info</font></div><div><font size="2"  >drop cascades to table digoal_01.user_session</font></div><div><font size="2"  >DROP SCHEMA</font></div></div><p></p></pre></div><div>-- 一定要注意londiste的健康, 有异常要火速解决, 否则queue会越来越大, 没有处理的tick也会堆积.</div><div style="line-height: 22px;"  ><br></div></div></div><div style="line-height: 22px;"  >【参考】</div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  >《Can session_replication_role used like MySQL's BlackHole Engine?》</div><div style="line-height: 22px;"  ><a style="line-height: 22px; " target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201119111234570/"  >http://blog.163.com/digoal@126/blog/static/163877040201119111234570/</a></div><div style="line-height: 22px;"  >《Londiste3 Install》</div><div style="line-height: 22px;"  ><a style="line-height: 22px; " target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201242945632912/"  >http://blog.163.com/digoal@126/blog/static/163877040201242945632912/</a></div><div style="line-height: 22px;"  >《PostgreSQL性能优化综合案例讲解 - 1》</div><div style="line-height: 22px;"  ><a style="line-height: 22px; " target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201221382150858/"  >http://blog.163.com/digoal@126/blog/static/163877040201221382150858/</a></div><div style="line-height: 22px;"  >《PostgreSQL性能优化综合案例讲解 - 2》</div><div style="line-height: 22px;"  ><a style="line-height: 22px; " target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201221333411196/"  >http://blog.163.com/digoal@126/blog/static/163877040201221333411196/</a></div><div style="line-height: 22px;"  ><a style="line-height: 22px; " target="_blank" rel="nofollow" href="http://skytools.projects.postgresql.org/skytools-3.0/"  >http://skytools.projects.postgresql.org/skytools-3.0/</a></div></div><div style="line-height: 22px;"  ><br style="line-height: 22px;"  ></div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; londiste3 --ini</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >[londiste3]</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >## Parameters for Londiste ##</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># target database</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >db = dbname=somedb host=127.0.0.1</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># how many tables can be copied in parallel</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >#parallel_copies = 1</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># accept only events for locally present tables</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >#local_only = true</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >## compare/repair</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># max amount of time table can be locked</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >#lock_timeout = 10</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># compare: sql to use</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >#compare_sql = select count(1) as cnt, sum(hashtext(t.*::text)) as chksum from only _TABLE_ t</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >#compare_fmt = %(cnt)d rows, checksum=%(chksum)s</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >## Parameters for pgq.CascadedWorker ##</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># how often the root node should push wm downstream (seconds)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >#global_wm_publish_period = 300</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># how often the nodes should report their wm upstream (seconds)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >#local_wm_publish_period = 300</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >## Parameters for pgq.Consumer ##</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># queue name to read from</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >queue_name =</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># override consumer name</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >#consumer_name = %(job_name)s</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># whether to use cursor to fetch events (0 disables)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >#pgq_lazy_fetch = 300</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># whether to read from source size in autocommmit mode</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># not compatible with pgq_lazy_fetch</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># the actual user script on top of pgq.Consumer must also support it</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >#pgq_autocommit = 0</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># whether to wait for specified number of events, before</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># assigning a batch (0 disables)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >#pgq_batch_collect_events = 0</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># whether to wait specified amount of time,</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># before assigning a batch (postgres interval)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >#pgq_batch_collect_interval =</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># whether to stay behind queue top (postgres interval)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >#pgq_keep_lag =</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >## Parameters for skytools.DBScript ##</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># default lifetime for database connections (in seconds)</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >#connection_lifetime = 1200</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >## Parameters for skytools.DBScript ##</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># how many seconds to sleep between work loops</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># if missing or 0, then instead sleeping, the script will exit</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >loop_delay = 1.0</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># where to log</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >logfile = ~/log/%(job_name)s.log</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># where to write pidfile</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >pidfile = ~/pid/%(job_name)s.pid</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># per-process name to use in logging</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >#job_name = %(config_name)s</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># whether centralized logging should be used</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># search-path [ ./skylog.ini, ~/.skylog.ini, /etc/skylog.ini ]</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># &nbsp; 0 - disabled</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># &nbsp; 1 - enabled, unless non-daemon on console (os.isatty())</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># &nbsp; 2 - always enabled</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >#use_skylog = 0</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># how many seconds to sleep after catching a exception</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >#exception_sleep = 20</font></div><p style="line-height: 22px;"  ></p></pre></div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >postgres@db5-&gt; pgqd --ini</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >[pgqd]</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># where to log</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >logfile = ~/log/pgqd.log</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># pidfile</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >pidfile = ~/pid/pgqd.pid</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >## optional parameters ##</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># libpq connect string without dbname=</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >#base_connstr =</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># startup db to query other databases</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >#initial_database = template1</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># limit ticker to specific databases</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >#database_list =</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># log into syslog</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >#syslog = 1</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >#syslog_ident = pgqd</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >## optional timeouts ##</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># how often to check for new databases</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >#check_period = 60</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># how often to flush retry queue</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >#retry_period = 30</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># how often to do maintentance</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >#maint_period = 120</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ><br style="line-height: 19px;"  ></font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  ># how often to run ticker</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >#ticker_period = 1</font></div><p style="line-height: 22px;"  ></p></pre></div></div><div style="line-height: 22px;"  >londiste3调用的其实都是skytools lib里面的py脚本, 例如compare调用的是compare.py</div></div><div style="line-height: 22px;"  ><pre class="prettyprint"  style="line-height: 22px;"  ><p style="line-height: 22px;"  ></p><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >pg92@db-172-16-3-33-&gt; pwd</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >/opt/skytools3.0.2/lib/python2.7/site-packages/londiste</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >pg92@db-172-16-3-33-&gt; ll</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >total 220K</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >-rw-r--r-- 1 root root 2.8K May 11 02:40 bublin.py</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >-rw-r--r-- 1 root root 3.5K May 30 14:47 bublin.pyc</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >-rw-r--r-- 1 root root 1.6K May 11 02:40 compare.py</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >-rw-r--r-- 1 root root 2.0K May 30 14:47 compare.pyc</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >-rw-r--r-- 1 root root 6.6K May 11 02:40 handler.py</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >-rw-r--r-- 1 root root 8.6K May 30 14:47 handler.pyc</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >drwxr-xr-x 2 root root 4.0K May 30 14:47 handlers</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >-rw-r--r-- 1 root root &nbsp;601 May 11 02:40 __init__.py</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >-rw-r--r-- 1 root root &nbsp;708 May 30 14:47 __init__.pyc</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >-rw-r--r-- 1 root root &nbsp;32K May 11 02:40 playback.py</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >-rw-r--r-- 1 root root &nbsp;28K May 30 14:47 playback.pyc</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >-rw-r--r-- 1 root root 9.8K May 11 02:40 repair.py</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >-rw-r--r-- 1 root root &nbsp;11K May 30 14:47 repair.pyc</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >-rw-r--r-- 1 root root &nbsp;21K May 11 02:40 setup.py</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >-rw-r--r-- 1 root root &nbsp;20K May 30 14:47 setup.pyc</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >-rw-r--r-- 1 root root 8.5K May 11 02:40 syncer.py</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >-rw-r--r-- 1 root root 8.4K May 30 14:47 syncer.pyc</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >-rw-r--r-- 1 root root 8.6K May 11 02:40 table_copy.py</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >-rw-r--r-- 1 root root 7.1K May 30 14:47 table_copy.pyc</font></div></pre></div></div>-- 添加删除列, 添加触发器的过程实际上是这样的.<div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >-- Adding a column to a replicated table</font></div><div><font size="2"  >This case is handled in a simple process:</font></div><div><font size="2"  >add the column on all the subscribers</font></div><div><font size="2"  >BEGIN; -- on the provider</font></div><div><font size="2"  >add the column on the provider</font></div><div><font size="2"  >SELECT londiste.provider_refresh_trigger('queue_name', 'tablename');</font></div><div><font size="2"  >COMMIT;</font></div><div><font size="2"  >-- Removing a column to a replicated table</font></div><div><font size="2"  >drop column from provider and change trigger in same transaction</font></div><div><font size="2"  >look at the lag when londiste has passed the moment of the drop</font></div><div><font size="2"  >drop column on subscribers</font></div><div><font size="2"  >The trick here is to drop the column on the subscribers only when there's no more event in the queue referencing it.</font></div><div><font size="2"  >-- Adding custom triggers on subscriber side</font></div><div><font size="2"  >By default, londiste will consider that the triggers which exist on the subscriber tables are there because you just restore the provider schema there, being as lazy as possible. If you intend to run custom triggers on the subscriber, you have to tell londiste about them as follows:</font></div><div><font size="2"  >create the custom trigger on the subscriber</font></div><div><font size="2"  >londiste.py p-to-s.ini subscriber add public.T1</font></div><div><font size="2"  >londiste.py p-to-s.ini subscriber restore-triggers public.T1</font></div><div><font size="2"  >CAUTION: When londiste stops, it will remove the trigger again.</font></div><div><font size="2"  >You can even give the restore trigger a specific trigger name, and only this one will get reinstalled.</font></div><p></p></pre></div><div><br></div></div></div>
	</div>
</div>
</body>
</html>