<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Compare Keys and multi Hash Stored in Redis</h2>
	<h5 id="">2012-05-29 22:24:55&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402012429101523356/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">测试一下直接使用key-value和使用Hash的field-value 对来存储同样的数据消耗的内存和性能的对比.<div>测试环境 :&nbsp;</div><div>CentOS 5.x 64位</div><div>Redis version 2.4.14</div><div>测试数据 :&nbsp;</div><div><div>key=32Byte &nbsp;Value=36Byte</div><div>直接存储1亿对key-value的情况下需要多少空间及性能情况；</div><div>在1个Hash类型中存储1亿对field-value的情况下需要多少空间及性能情况；</div><div>使用hash的情况下，key=key去掉后三个字节，field=这个三个字节，value保持不变.</div><div>也就是Hash 存储 29Byte 3Byte 36Byte.</div><div>但是3个字节只能存储2^24=16777216个数字. 不能出现重复的field, 同一个HASH中如果出现同名的field重复赋值时新的value将覆盖老的value.</div><div>显然如果field只用3个字节存储1亿对filed-value是不可能的.</div><div>但是这里测试的不是单个HASH存储多对field-value, 而是多个HASH存储单对field-value.</div><div>其实这样使用HASH确实没啥用, 幸好有好心的网友指出, 大家请不要这么使用HASH. 这里只是测试而已.</div><div>hash 一般是单个KEY存储多对field-value 这么来用, 例如学生名字是1个HASHKEY的话, 学生的多项属性可以写多对field-value.</div><div>用法参见 :&nbsp;</div><div><a target="_blank" rel="nofollow" href="http://redis.io/topics/data-types"   >http://redis.io/topics/data-types</a></div><div><br></div><div><br></div><div>本文测试脚本 :&nbsp;</div><div><br></div><div>1.key-value存储 :&nbsp;</div><div><div>[root@db5 ruby]# cat set.rb</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#!/usr/local/rvm/bin/ruby</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >require "rubygems"</font></div><div><font size="2"   >require "redis"</font></div><div><font size="2"   >require "date"</font></div><div><font size="2"   >rb = Redis.new</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >p DateTime.now</font></div><div><font size="2"   >(ARGV[0]..ARGV[1]).each do</font></div><div><font size="2"   >&nbsp; |x|</font></div><div><font size="2"   >&nbsp; rb.set(("%032d" % x),("%036d" % x))</font></div><div><font size="2"   >end</font></div><div><font size="2"   >p DateTime.now</font></div><p></p></pre></div><div><br></div><div>2.使用Hash存储</div><div>[root@db5 ruby]# cat hset.rb</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#!/usr/local/rvm/bin/ruby</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >require "rubygems"</font></div><div><font size="2"   >require "redis"</font></div><div><font size="2"   >require "date"</font></div><div><font size="2"   >rb = Redis.new</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >p DateTime.now</font></div><div><font size="2"   >(ARGV[0]..ARGV[1]).each do</font></div><div><font size="2"   >&nbsp; |x|</font></div><div><font size="2"   >&nbsp; rb.hset(("%029d" % x),</font><span style="font-size: small; line-height: 19px;"   >("%003d" % x)</span><span style="font-size: small;"   >,("%036d" % x))</span></div><div><font size="2"   >end</font></div><div><font size="2"   >p DateTime.now</font></div><p></p></pre></div><div><br></div><div>测试脚本.</div><div>[root@db5 ruby]# cat test.sh&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#!/bin/bash</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >set() {</font></div><div><font size="2"   >for((i=1;i&lt;=8;i++))&nbsp;</font></div><div><font size="2"   >do</font></div><div><font size="2"   >&nbsp; ruby ./set.rb $((($i-1)*125000+1)) $(($i*120000)) &gt;./set_$i.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"   >done</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >hset() {</font></div><div><font size="2"   >for((i=1;i&lt;=8;i++))&nbsp;</font></div><div><font size="2"   >do</font></div><div><font size="2"   >&nbsp; ruby ./hset.rb $((($i-1)*125000+1)) $(($i*125000)) &gt;./hset_$i.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"   >done</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >case "$1" in</font></div><div><font size="2"   >&nbsp; set)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; set</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ;;</font></div><div><font size="2"   >&nbsp; hset)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; hset</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ;;</font></div><div><font size="2"   >&nbsp; *)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; echo $"Usage: $0 {set|hset}"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; exit 0</font></div><div><font size="2"   >esac</font></div><p></p></pre></div></div>测试 :&nbsp;<wbr></div><div>1. 清空数据库</div><div>flushall</div><div><br></div><div>测试结果 :&nbsp;</div><div>1. 使用key-value存储 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >test.sh set</font></p></pre></div><div>100W条插入耗时20秒, 消耗内存146MB.</div><div>详细信息 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >info</font></div><div><div><font size="2"   >used_memory:153115032</font></div><div><font size="2"   >used_memory_human:146.02M</font></div></div><div><font size="2"   >db0:keys=1000000,expires=0</font></div><p></p></pre></div><div>日志 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-150 ~]# cat set*.log</font></div><div><font size="2"   >#&lt;DateTime: 2013-02-22T21:29:19+08:00 ((2456346j,48559s,721551000n),+28800s,2299161j)&gt;</font></div><div><font size="2"   >#&lt;DateTime: 2013-02-22T21:29:39+08:00 ((2456346j,48579s,38908000n),+28800s,2299161j)&gt;</font></div><div><font size="2"   >#&lt;DateTime: 2013-02-22T21:29:19+08:00 ((2456346j,48559s,721531000n),+28800s,2299161j)&gt;</font></div><div><font size="2"   >#&lt;DateTime: 2013-02-22T21:29:37+08:00 ((2456346j,48577s,856512000n),+28800s,2299161j)&gt;</font></div><div><font size="2"   >#&lt;DateTime: 2013-02-22T21:29:19+08:00 ((2456346j,48559s,721544000n),+28800s,2299161j)&gt;</font></div><div><font size="2"   >#&lt;DateTime: 2013-02-22T21:29:38+08:00 ((2456346j,48578s,525444000n),+28800s,2299161j)&gt;</font></div><div><font size="2"   >#&lt;DateTime: 2013-02-22T21:29:19+08:00 ((2456346j,48559s,721538000n),+28800s,2299161j)&gt;</font></div><div><font size="2"   >#&lt;DateTime: 2013-02-22T21:29:38+08:00 ((2456346j,48578s,381601000n),+28800s,2299161j)&gt;</font></div><div><font size="2"   >#&lt;DateTime: 2013-02-22T21:29:19+08:00 ((2456346j,48559s,721531000n),+28800s,2299161j)&gt;</font></div><div><font size="2"   >#&lt;DateTime: 2013-02-22T21:29:40+08:00 ((2456346j,48580s,330511000n),+28800s,2299161j)&gt;</font></div><div><font size="2"   >#&lt;DateTime: 2013-02-22T21:29:19+08:00 ((2456346j,48559s,721540000n),+28800s,2299161j)&gt;</font></div><div><font size="2"   >#&lt;DateTime: 2013-02-22T21:29:39+08:00 ((2456346j,48579s,377204000n),+28800s,2299161j)&gt;</font></div><div><font size="2"   >#&lt;DateTime: 2013-02-22T21:29:19+08:00 ((2456346j,48559s,722379000n),+28800s,2299161j)&gt;</font></div><div><font size="2"   >#&lt;DateTime: 2013-02-22T21:29:41+08:00 ((2456346j,48581s,595150000n),+28800s,2299161j)&gt;</font></div><div><font size="2"   >#&lt;DateTime: 2013-02-22T21:29:19+08:00 ((2456346j,48559s,721724000n),+28800s,2299161j)&gt;</font></div><div><font size="2"   >#&lt;DateTime: 2013-02-22T21:29:39+08:00 ((2456346j,48579s,96449000n),+28800s,2299161j)&gt;</font></div></div><div><font size="2"   >数据取样 :&nbsp;</font></div><div><div><font size="2"   >redis 127.0.0.1:6379&gt; mget 00000000000000000000000000000001</font></div><div><font size="2"   >1) "000000000000000000000000000000000001"</font></div></div><p></p></pre></div><div><br></div><div>2. 使用Hash存储</div><div><pre class="prettyprint"   ><p><font size="2"   >test.sh hset</font></p></pre></div><div><span style="line-height: 22px;"   >100W条插入耗时20秒, 消耗内存146MB.&nbsp;</span></div><div><span style="line-height: 22px;"   >详细信息 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >info</font></div><div><div><font size="2"   >used_memory:153115152</font></div><div><font size="2"   >used_memory_human:146.02M</font></div></div><div><font size="2"   >db0:keys=1000000,expires=0</font></div><div><font size="2"   ><br></font></div><div><span style="line-height: 22px;"   ><font size="2"   >日志 :&nbsp;</font></span></div><div><span style="line-height: 22px;"   ><font size="2"   ><div>#&lt;DateTime: 2013-02-22T21:31:09+08:00 ((2456346j,48669s,949762000n),+28800s,2299161j)&gt;</div><div>#&lt;DateTime: 2013-02-22T21:31:34+08:00 ((2456346j,48694s,136926000n),+28800s,2299161j)&gt;</div><div>#&lt;DateTime: 2013-02-22T21:31:09+08:00 ((2456346j,48669s,949507000n),+28800s,2299161j)&gt;</div><div>#&lt;DateTime: 2013-02-22T21:31:30+08:00 ((2456346j,48690s,234948000n),+28800s,2299161j)&gt;</div><div>#&lt;DateTime: 2013-02-22T21:31:09+08:00 ((2456346j,48669s,949754000n),+28800s,2299161j)&gt;</div><div>#&lt;DateTime: 2013-02-22T21:31:30+08:00 ((2456346j,48690s,549032000n),+28800s,2299161j)&gt;</div><div>#&lt;DateTime: 2013-02-22T21:31:09+08:00 ((2456346j,48669s,949755000n),+28800s,2299161j)&gt;</div><div>#&lt;DateTime: 2013-02-22T21:31:32+08:00 ((2456346j,48692s,41759000n),+28800s,2299161j)&gt;</div><div>#&lt;DateTime: 2013-02-22T21:31:09+08:00 ((2456346j,48669s,950409000n),+28800s,2299161j)&gt;</div><div>#&lt;DateTime: 2013-02-22T21:31:30+08:00 ((2456346j,48690s,539557000n),+28800s,2299161j)&gt;</div><div>#&lt;DateTime: 2013-02-22T21:31:09+08:00 ((2456346j,48669s,950731000n),+28800s,2299161j)&gt;</div><div>#&lt;DateTime: 2013-02-22T21:31:30+08:00 ((2456346j,48690s,32225000n),+28800s,2299161j)&gt;</div><div>#&lt;DateTime: 2013-02-22T21:31:09+08:00 ((2456346j,48669s,950718000n),+28800s,2299161j)&gt;</div><div>#&lt;DateTime: 2013-02-22T21:31:29+08:00 ((2456346j,48689s,244081000n),+28800s,2299161j)&gt;</div><div>#&lt;DateTime: 2013-02-22T21:31:09+08:00 ((2456346j,48669s,951798000n),+28800s,2299161j)&gt;</div><div>#&lt;DateTime: 2013-02-22T21:31:30+08:00 ((2456346j,48690s,550450000n),+28800s,2299161j)&gt;</div></font></span></div><div><span style="line-height: 22px;"   ><font size="2"   ><br></font></span></div><div><span style="line-height: 22px;"   ><font size="2"   >数据取样 :&nbsp;</font></span></div><div><span style="line-height: 22px;"   ><font size="2"   ><div>redis 127.0.0.1:6379&gt; hkeys 00000000000000000000000000001</div><div>1) "001"</div></font></span></div><p></p></pre></div><div><span style="line-height: 22px;"   ><br></span></div><div><span style="line-height: 22px;"   >【其他】</span></div><div><span style="line-height: 22px;"   >1. 使用key value存储和使用hashkey field value存储耗费的内存基本一致.</span></div><div>为什么会耗费差不多的内存呢? 和数据结构息息相关.</div><div>数据结构参考redis.h ,&nbsp;</div><div>例如listNode的数据结构 :</div><div>adlist.h</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/* Node, List, and Iterator are the only data structures used currently. */</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >typedef struct listNode {</font></div><div><font size="2"   >&nbsp; &nbsp; struct listNode *prev;</font></div><div><font size="2"   >&nbsp; &nbsp; struct listNode *next;</font></div><div><font size="2"   >&nbsp; &nbsp; void *value;</font></div><div><font size="2"   >} listNode;</font></div><p></p></pre></div><div><br></div><div>如果改成list存储, 空间可就不一样了.</div><div>list测试如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# cat test.sh</font></div><div><font size="2"   >#!/bin/bash</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >set() {</font></div><div><font size="2"   >for((i=1;i&lt;=8;i++))&nbsp;</font></div><div><font size="2"   >do</font></div><div><font size="2"   >&nbsp; ruby ./set.rb $((($i-1)*125000+1)) $(($i*125000)) &gt;./set_$i.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"   >done</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >hset() {</font></div><div><font size="2"   >for((i=1;i&lt;=8;i++))&nbsp;</font></div><div><font size="2"   >do</font></div><div><font size="2"   >&nbsp; ruby ./hset.rb $((($i-1)*125000+1)) $(($i*125000)) &gt;./hset_$i.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"   >done</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >list() {</font></div><div><font size="2"   >for((i=1;i&lt;=8;i++))&nbsp;</font></div><div><font size="2"   >do</font></div><div><font size="2"   >&nbsp; ruby ./list.rb $((($i-1)*125000+1)) $(($i*125000)) &gt;./list_$i.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"   >done</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >case "$1" in</font></div><div><font size="2"   >&nbsp; set)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; set</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ;;</font></div><div><font size="2"   >&nbsp; hset)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; hset</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ;;</font></div><div><font size="2"   >&nbsp; list)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; list</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ;;</font></div><div><font size="2"   >&nbsp; *)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; echo $"Usage: $0 {set|hset|list}"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; exit 0</font></div><div><font size="2"   >esac</font></div><div><font size="2"   >[root@db-172-16-3-150 ~]# cat list.rb</font></div><div><font size="2"   >#!/opt/bin/ruby</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >require "rubygems"</font></div><div><font size="2"   >require "redis"</font></div><div><font size="2"   >require "date"</font></div><div><font size="2"   >rb = Redis.new</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >p DateTime.now</font></div><div><font size="2"   >(ARGV[0]..ARGV[1]).each do</font></div><div><font size="2"   >&nbsp; |x|</font></div><div><font size="2"   >&nbsp; rb.lpush(("%032d" % x),("%036d" % x))</font></div><div><font size="2"   >end</font></div><div><font size="2"   >p DateTime.now</font></div><p></p></pre></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-150 ~]# cat list*.log</font></div><div><font size="2"   >#&lt;DateTime: 2013-02-22T22:04:18+08:00 ((2456346j,50658s,381501000n),+28800s,2299161j)&gt;</font></div><div><font size="2"   >#&lt;DateTime: 2013-02-22T22:05:06+08:00 ((2456346j,50706s,933510000n),+28800s,2299161j)&gt;</font></div><div><font size="2"   >#&lt;DateTime: 2013-02-22T22:04:18+08:00 ((2456346j,50658s,380903000n),+28800s,2299161j)&gt;</font></div><div><font size="2"   >#&lt;DateTime: 2013-02-22T22:05:06+08:00 ((2456346j,50706s,455043000n),+28800s,2299161j)&gt;</font></div><div><font size="2"   >#&lt;DateTime: 2013-02-22T22:04:18+08:00 ((2456346j,50658s,380904000n),+28800s,2299161j)&gt;</font></div><div><font size="2"   >#&lt;DateTime: 2013-02-22T22:05:05+08:00 ((2456346j,50705s,924739000n),+28800s,2299161j)&gt;</font></div><div><font size="2"   >#&lt;DateTime: 2013-02-22T22:04:18+08:00 ((2456346j,50658s,380901000n),+28800s,2299161j)&gt;</font></div><div><font size="2"   >#&lt;DateTime: 2013-02-22T22:05:05+08:00 ((2456346j,50705s,499455000n),+28800s,2299161j)&gt;</font></div><div><font size="2"   >#&lt;DateTime: 2013-02-22T22:04:18+08:00 ((2456346j,50658s,380901000n),+28800s,2299161j)&gt;</font></div><div><font size="2"   >#&lt;DateTime: 2013-02-22T22:05:05+08:00 ((2456346j,50705s,706013000n),+28800s,2299161j)&gt;</font></div><div><font size="2"   >#&lt;DateTime: 2013-02-22T22:04:18+08:00 ((2456346j,50658s,381887000n),+28800s,2299161j)&gt;</font></div><div><font size="2"   >#&lt;DateTime: 2013-02-22T22:05:07+08:00 ((2456346j,50707s,770955000n),+28800s,2299161j)&gt;</font></div><div><font size="2"   >#&lt;DateTime: 2013-02-22T22:04:18+08:00 ((2456346j,50658s,380905000n),+28800s,2299161j)&gt;</font></div><div><font size="2"   >#&lt;DateTime: 2013-02-22T22:05:06+08:00 ((2456346j,50706s,104680000n),+28800s,2299161j)&gt;</font></div><div><font size="2"   >#&lt;DateTime: 2013-02-22T22:04:18+08:00 ((2456346j,50658s,382742000n),+28800s,2299161j)&gt;</font></div><div><font size="2"   >#&lt;DateTime: 2013-02-22T22:05:07+08:00 ((2456346j,50707s,149242000n),+28800s,2299161j)&gt;</font></div></div><div><font size="2"   >info</font></div><div><div><font size="2"   >used_memory:169117248</font></div><div><font size="2"   >used_memory_human:161.28M</font></div></div><div><font size="2"   >db0:keys=1000000,expires=0</font></div><div><div><font size="2"   >redis 127.0.0.1:6379&gt; lrange 00000000000000000000000000000001 0 0</font></div><div><font size="2"   >1) "000000000000000000000000000000000001"</font></div></div><p></p></pre></div><div><br></div><div>【参考】</div><div>1.&nbsp;<a rel="nofollow" href="http://www.oschina.net/question/12_31910"   >http://www.oschina.net/question/12_31910</a> </div><div>Redis内存容量的预估和优化</div><div>2. Redis DOC</div><div><a target="_blank" rel="nofollow" href="http://redis.io/commands"   >http://redis.io/commands</a></div>3. HASH<div><a target="_blank" rel="nofollow" href="http://en.wikipedia.org/wiki/Hash_table"   >http://en.wikipedia.org/wiki/Hash_table</a></div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">lyx20048703 - 2013-02-22 18:37:29</h5>
				<div>让我怎么说你，根本没明白hash的意义。</div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 lyx20048703 - 2013-02-22 18:37:29</h5>
				<div style="width:600px;">确实没有细读REDIS,感谢指出,一定好好学习.<br><br></div>
			</div>
	</div>
</div>
</body>
</html>