<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.2 can share snapshot between multi transactions</h2>
	<h5 id="">2012-05-16 12:39:46&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402012416105232835/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>从PostgreSQL 9.2看核心开发人员"玩花招".</div><div>我感觉PostgreSQL在核心开发人员的手里就像足球在巴西球员的脚下一样, 玩得一溜一溜的.</div><div><br></div></div><wbr>PostgreSQL 9.2 新增的一个功能，允许事务共享它当时的snapshot给其他的事务使用。<div>PostgreSQL的核心开发人员实在可爱，不过也多亏了PG的MVCC机制，才能方便的实现这个功能。<br><wbr><div>这项功能其实是基于PostgreSQL MVCC机制而生的，为什么需要一个这样的功能呢。</div><div>我们来想象一个场景，</div><div>1. 11:00:00, 会话1启动了一个repeatable read事务.</div><div>2. 11:00:00到11:00:01时间段内, 其他会话对数据库进行了一些新增修改和删除数据的操作并提交了.</div><div>3. 11:00:02, 会话2启动了一个<span style="line-height: 22px;"  >repeatable read</span>事务.</div><div>显然这种情况下，会话1的这个事务看不到在11:00:00 到 11:00:01 时间段内提交的数据.</div><div>但是会话2可以看到<span style="line-height: 22px;"  >在11:00:00 到 11:00:01 时间段内提交的数据.</span></div><div><span style="line-height: 22px;"  >如果要让会话2的这个事务看到和会话1的事务一样的snapshot怎么办呢? 在PostgreSQL 9.2 以前没有办法办到.</span></div><div>PostgreSQL 9.2 新增了一个函数,&nbsp;pg_export_snapshot(). 这个函数用在会话1启动事务后, 输出一个字符串.</div><div>这个字符串可以被其他的多个事务用于"导入". 注意, 其他事务必须在事务发出第一条SQL前"导入"其他事务的状态. 并且只能"导入"一次.</div><div>注意, 这些共享事务snapshot的事务直接，自己内部的改变其他事务是看不到的。</div><div>注意执行SET TRANSACTION SNAPSHOT '$snapshot ID';的事务, 也就是import snapshot的事务必须是repeatable read或serializable的事务.&nbsp;</div><div>还有其他的一些限制，看图 :&nbsp;</div><div><div><img title="PostgreSQL 9.2 can share snapshot between multi transactions - 德哥@Digoal - The Heart,The World."  alt="PostgreSQL 9.2 can share snapshot between multi transactions - 德哥@Digoal - The Heart,The World."  style="margin:0 10px 0 0;"  src="http://img3.ph.126.net/QqjKk70uppoxhYoTg6Gtzw==/42784196477353943.jpg"  ></div>&nbsp;</div><div>我们来通过测试详细的讲解一些它是怎么实现的 ：</div><div>测试一(export的事务是repeatable read的)、</div><div>先创建一些测试数据,</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# create table test (id int);</font></div><div><font size="2"  >CREATE TABLE</font></div><div><font size="2"  >digoal=# insert into test values (1),(2);</font></div><div><font size="2"  >INSERT 0 2</font></div><p></p></pre></div><div>会话1 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal=# begin TRANSACTION ISOLATION LEVEL repeatable read;</font></div><div><font size="2"  >BEGIN</font></div><div><font size="2"  >digoal=# SELECT pg_export_snapshot();</font></div><div><font size="2"  >&nbsp;pg_export_snapshot&nbsp;</font></div><div><font size="2"  >--------------------</font></div><div><font size="2"  >&nbsp;000006A3-1</font></div><div><font size="2"  >(1 row)</font></div></div><div><div><font size="2"  >digoal=# insert into test values (3);</font></div><div><font size="2"  >INSERT 0 1</font></div></div><div><div><font size="2"  >digoal=# SELECT pg_export_snapshot();</font></div><div><font size="2"  >&nbsp;pg_export_snapshot&nbsp;</font></div><div><font size="2"  >--------------------</font></div><div><font size="2"  >&nbsp;000006A3-2</font></div><div><font size="2"  >(1 row)</font></div></div><div><div><font size="2"  >digoal=# select * from txid_current();</font></div><div><font size="2"  >&nbsp;txid_current&nbsp;</font></div><div><font size="2"  >--------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1699</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=# select * from txid_current_snapshot();</font></div><div><font size="2"  >&nbsp;txid_current_snapshot&nbsp;</font></div><div><font size="2"  >-----------------------</font></div><div><font size="2"  >&nbsp;1699:1699:</font></div><div><font size="2"  >(1 row)</font></div></div><p></p></pre></div><div>会话2（插入一条新数据并自动提交） :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# insert into test values (4);</font></div><div><font size="2"  >INSERT 0 1</font></div><p></p></pre></div><div>会话3 (能查看到会话2插入的数据) :&nbsp;</div><div><div><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >digoal=# select * from test;</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp;id&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  >----</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; 1</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; 2</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; 4</font></div><div style="line-height: 22px;"  ><font size="2"  >(3 rows)</font></div><p></p></pre></div></div><div>会话4 (导入会话1的第一个snapshot, 因此看不到会话2提交的数据) :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal=# begin TRANSACTION ISOLATION LEVEL repeatable read;</font></div><div><font size="2"  >BEGIN</font></div><div><font size="2"  >digoal=# SET TRANSACTION SNAPSHOT '000006A3-1';</font></div><div><font size="2"  >SET</font></div><div><font size="2"  >digoal=# select * from test;</font></div><div><font size="2"  >&nbsp;id&nbsp;</font></div><div><font size="2"  >----</font></div><div><font size="2"  >&nbsp; 1</font></div><div><font size="2"  >&nbsp; 2</font></div><div><font size="2"  >(2 rows)</font></div></div><div><div><font size="2"  >digoal=# select * from txid_current();</font></div><div><font size="2"  >&nbsp;txid_current&nbsp;</font></div><div><font size="2"  >--------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1701</font></div><div><font size="2"  >(1 row)</font></div><div><span style="line-height: 19px; font-size: small;"  >-- snapshot输出和会话1一样.</span><br></div><div><font size="2"  >digoal=# select * from txid_current_snapshot();</font></div><div><font size="2"  >&nbsp;txid_current_snapshot&nbsp;</font></div><div><font size="2"  >-----------------------</font></div><div><font size="2"  >&nbsp;1699:1699:</font></div><div><font size="2"  >(1 row)</font></div></div><p></p></pre></div><div>会话5 (<span style="line-height: 22px;"  >导入会话1的第二个snapshot, 因此看不到会话2提交的数据, 同时验证了看不到会话1修改过的数据, 前面已经讲过了.)</span>&nbsp;:&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# begin TRANSACTION ISOLATION LEVEL REPEATABLE READ;</font></div><div><font size="2"  >BEGIN</font></div><div><font size="2"  >digoal=# SET TRANSACTION SNAPSHOT '000006A3-2';</font></div><div><font size="2"  >SET</font></div><div><font size="2"  >digoal=# select * from test;</font></div><div><font size="2"  >&nbsp;id&nbsp;</font></div><div><font size="2"  >----</font></div><div><font size="2"  >&nbsp; 1</font></div><div><font size="2"  >&nbsp; 2</font></div><div><font size="2"  >(2 rows)</font></div><div><font size="2"  >-- 当前事务ID</font></div><div><font size="2"  >digoal=# select * from txid_current();</font></div><div><font size="2"  >&nbsp;txid_current&nbsp;</font></div><div><font size="2"  >--------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1702</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >-- snapshot输出和会话1一样.</font></div><div><font size="2"  >digoal=# select * from txid_current_snapshot();</font></div><div><font size="2"  >&nbsp;txid_current_snapshot&nbsp;</font></div><div><font size="2"  >-----------------------</font></div><div><font size="2"  >&nbsp;1699:1699:</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>会话1 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# commit;</font></div><div><font size="2"  >COMMIT</font></div><p></p></pre></div><div>会话4 (会话1提交后, 这个snapshot还存在, 只要还有导入了这个snapshot的事务存在着) :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# select * from test;</font></div><div><font size="2"  >&nbsp;id&nbsp;</font></div><div><font size="2"  >----</font></div><div><font size="2"  >&nbsp; 1</font></div><div><font size="2"  >&nbsp; 2</font></div><div><font size="2"  >(2 rows)</font></div><p></p></pre></div><div>会话5 (<span style="line-height: 22px;"  >会话1提交后, 这个snapshot还存在, 只要还有导入了这个snapshot的事务存在着</span>) :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# select * from test;</font></div><div><font size="2"  >&nbsp;id&nbsp;</font></div><div><font size="2"  >----</font></div><div><font size="2"  >&nbsp; 1</font></div><div><font size="2"  >&nbsp; 2</font></div><div><font size="2"  >(2 rows)</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"  >测试二(export的事务是read committed的, 与repeatable read不同的是, 这里在事务中多次执行pg_export_snapshot()将能明显的体现不同, repeatable read和serializable是看不到事务中其他事务提交的数据的, read committed则可以看到, 多次调用</span><span style="line-height: 22px;"  >pg_export_snapshot()只需要在read committed 场景使用</span><span style="line-height: 22px;"  >)、</span></div><div><span style="line-height: 22px;"  >测试前清除数据 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# truncate test;</font></div><div><font size="2"  >TRUNCATE TABLE</font></div><div><font size="2"  >digoal=# insert into test values (1),(2);<br>INSERT 0 2</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >会话1 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# &nbsp;begin TRANSACTION ISOLATION LEVEL read committed;</font></div><div><font size="2"  >BEGIN</font></div><div><font size="2"  >digoal=# SELECT pg_export_snapshot();</font></div><div><font size="2"  >&nbsp;pg_export_snapshot&nbsp;</font></div><div><font size="2"  >--------------------</font></div><div><font size="2"  >&nbsp;000006B7-1</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=# &nbsp;insert into test values (3);</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=# SELECT pg_export_snapshot();</font></div><div><font size="2"  >&nbsp;pg_export_snapshot&nbsp;</font></div><div><font size="2"  >--------------------</font></div><div><font size="2"  >&nbsp;000006B7-2</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=# select * from test;</font></div><div><font size="2"  >&nbsp;id&nbsp;</font></div><div><font size="2"  >----</font></div><div><font size="2"  >&nbsp; 1</font></div><div><font size="2"  >&nbsp; 2</font></div><div><font size="2"  >&nbsp; 3</font></div><div><font size="2"  >(3 rows)</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >会话2 :&nbsp;</span></div><div><div><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >digoal=# insert into test values (4);</font></div><div style="line-height: 22px;"  ><font size="2"  >INSERT 0 1</font></div><p></p></pre></div><div style="line-height: 22px;"  >会话1 :</div><div><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><div><font size="2"  >digoal=# select * from test;</font></div><div><font size="2"  >&nbsp;id&nbsp;</font></div><div><font size="2"  >----</font></div><div><font size="2"  >&nbsp; 1</font></div><div><font size="2"  >&nbsp; 2</font></div><div><font size="2"  >&nbsp; 3</font></div><div><font size="2"  >&nbsp; 4</font></div><div><font size="2"  >(4 rows)</font></div></div><div style="line-height: 22px;"  ><div><font size="2"  >digoal=# SELECT pg_export_snapshot();</font></div><div><font size="2"  >&nbsp;pg_export_snapshot&nbsp;</font></div><div><font size="2"  >--------------------</font></div><div><font size="2"  >&nbsp;000006B7-3</font></div><div><font size="2"  >(1 row)</font></div></div><p></p></pre></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >会话3 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# begin TRANSACTION ISOLATION LEVEL repeatable read;</font></div><div><font size="2"  >BEGIN</font></div><div><font size="2"  >digoal=# SET TRANSACTION SNAPSHOT '000006B7-1';</font></div><div><font size="2"  >SET</font></div><div><font size="2"  >digoal=# select * from test;</font></div><div><font size="2"  >&nbsp;id&nbsp;</font></div><div><font size="2"  >----</font></div><div><font size="2"  >&nbsp; 1</font></div><div><font size="2"  >&nbsp; 2</font></div><div><font size="2"  >(2 rows)</font></div><p></p></pre></div><div style="line-height: 22px;"  >会话4 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# begin TRANSACTION ISOLATION LEVEL REPEATABLE READ;</font></div><div><font size="2"  >BEGIN</font></div><div><font size="2"  >digoal=# SET TRANSACTION SNAPSHOT '000006B7-2';</font></div><div><font size="2"  >SET</font></div><div><font size="2"  >digoal=# select * from test;</font></div><div><font size="2"  >&nbsp;id&nbsp;</font></div><div><font size="2"  >----</font></div><div><font size="2"  >&nbsp; 1</font></div><div><font size="2"  >&nbsp; 2</font></div><div><font size="2"  >(2 rows)</font></div><p></p></pre></div><div style="line-height: 22px;"  >会话5 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# begin TRANSACTION ISOLATION LEVEL repeatable read;</font></div><div><font size="2"  >BEGIN</font></div><div><font size="2"  >digoal=# SET TRANSACTION SNAPSHOT '000006B7-3';</font></div><div><font size="2"  >SET</font></div><div><font size="2"  >digoal=# SELECT * FROM TEST;</font></div><div><font size="2"  >&nbsp;id&nbsp;</font></div><div><font size="2"  >----</font></div><div><font size="2"  >&nbsp; 1</font></div><div><font size="2"  >&nbsp; 2</font></div><div><font size="2"  >&nbsp; 4</font></div><div><font size="2"  >(3 rows)</font></div><p></p></pre></div><div><div style="line-height: 22px;"  >会话2 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# insert into test values (5);</font></div><div><font size="2"  >INSERT 0 1</font></div><p></p></pre></div><div style="line-height: 22px;"  >会话1 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# select * from test;</font></div><div><font size="2"  >&nbsp;id&nbsp;</font></div><div><font size="2"  >----</font></div><div><font size="2"  >&nbsp; 1</font></div><div><font size="2"  >&nbsp; 2</font></div><div><font size="2"  >&nbsp; 3</font></div><div><font size="2"  >&nbsp; 4</font></div><div><font size="2"  >&nbsp; 5</font></div><div><font size="2"  >(5 rows)</font></div><p></p></pre></div><div style="line-height: 22px;"  >会话3,4,5看到的结果与前面看到的结果一致 :&nbsp;</div><div><div><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><span style="line-height: 22px;"  ><font size="2"  >会话3 :&nbsp;</font></span></div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><font size="2"  >digoal=# begin TRANSACTION ISOLATION LEVEL repeatable read;</font></div><div style="line-height: 22px;"  ><font size="2"  >BEGIN</font></div><div style="line-height: 22px;"  ><font size="2"  >digoal=# SET TRANSACTION SNAPSHOT '000006B7-1';</font></div><div style="line-height: 22px;"  ><font size="2"  >SET</font></div><div style="line-height: 22px;"  ><font size="2"  >digoal=# select * from test;</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp;id&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  >----</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; 1</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; 2</font></div><div style="line-height: 22px;"  ><font size="2"  >(2 rows)</font></div></div><div style="line-height: 22px;"  ><font size="2"  >会话4 :&nbsp;</font></div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><font size="2"  >digoal=# begin TRANSACTION ISOLATION LEVEL REPEATABLE READ;</font></div><div style="line-height: 22px;"  ><font size="2"  >BEGIN</font></div><div style="line-height: 22px;"  ><font size="2"  >digoal=# SET TRANSACTION SNAPSHOT '000006B7-2';</font></div><div style="line-height: 22px;"  ><font size="2"  >SET</font></div><div style="line-height: 22px;"  ><font size="2"  >digoal=# select * from test;</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp;id&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  >----</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; 1</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; 2</font></div><div style="line-height: 22px;"  ><font size="2"  >(2 rows)</font></div></div><div style="line-height: 22px;"  ><font size="2"  >会话5 :&nbsp;</font></div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><font size="2"  >digoal=# begin TRANSACTION ISOLATION LEVEL repeatable read;</font></div><div style="line-height: 22px;"  ><font size="2"  >BEGIN</font></div><div style="line-height: 22px;"  ><font size="2"  >digoal=# SET TRANSACTION SNAPSHOT '000006B7-3';</font></div><div style="line-height: 22px;"  ><font size="2"  >SET</font></div><div style="line-height: 22px;"  ><font size="2"  >digoal=# SELECT * FROM TEST;</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp;id&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  >----</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; 1</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; 2</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; 4</font></div><div style="line-height: 22px;"  ><font size="2"  >(3 rows)</font></div></div></div><p></p></pre></div></div><div style="line-height: 22px;"  ><br></div><div style="line-height: 22px;"  >【小结】</div><div style="line-height: 22px;"  >import时，其实只是把执行export事务的当时的txid_current_snapshot传递过来. 不会传递事务的属性如(read committed或repeatable read或serializable).&nbsp;</div><div style="line-height: 22px;"  >因此, 我们从例子2看到共享事务snapshot的事务之间，除了存在自己修改的数据的差异之外，对于执行export的事务如果是read committed的，它看到的数据和执行import的事务看到的数据也是存在差异的。</div><div style="line-height: 22px;"  ><br></div></div></div></div>【参考】<div><a rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/sql-set-transaction.html"  >http://www.postgresql.org/docs/9.2/static/sql-set-transaction.html</a> </div><div><a rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/functions-admin.html#FUNCTIONS-SNAPSHOT-SYNCHRONIZATION"  >http://www.postgresql.org/docs/9.2/static/functions-admin.html#FUNCTIONS-SNAPSHOT-SYNCHRONIZATION</a> </div></div>
	</div>
</div>
</body>
</html>