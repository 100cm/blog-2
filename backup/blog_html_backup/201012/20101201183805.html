<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL nonremovable row versions message</h2>
	<h5 id="">2010-12-01 18:38:05&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201011162912604/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">测试环境:<br>存在两个事务,: 事务A，事务B<br>事务A先启动,<br>事务B后启动,<br><br>表结构<br><pre class="prettyprint"   ><p><font size="2"   >rmt_rescue=&gt; create table tbl_test(id int,name text);<br>CREATE TABLE<br>rmt_rescue=&gt; create table tbl_test1(id int,name text);<br>CREATE TABLE</font></p></pre><br>事务A：<br><pre class="prettyprint"   ><p><font size="2"   >rmt_rescue=&gt; begin ;<br>BEGIN<br>rmt_rescue=&gt; insert into tbl_test select generate_series(1,10000),'test' ;<br>INSERT 0 10000</font></p></pre><br>事务B：<br><pre class="prettyprint"   ><p><font size="2"   >rmt_rescue=&gt; insert into tbl_test1 select generate_series(1,10000),'digoal';<br>INSERT 0 10000<br>Time: 43.269 ms<br>rmt_rescue=&gt; analyze tbl_test1;<br>ANALYZE<br>Time: 3.198 ms<br>rmt_rescue=&gt; select pg_relation_size('tbl_test1');<br>&nbsp;pg_relation_size <br>------------------<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 450560<br>(1 row)<br>Time: 0.322 ms<br>rmt_rescue=&gt; delete from tbl_test1;<br>DELETE 10000<br>Time: 8.925 ms<br>rmt_rescue=&gt; vacuum analyze verbose tbl_test1;<br>INFO:&nbsp; vacuuming "rmt_rescue.tbl_test1"<br>INFO:&nbsp; index "idx_test1" now contains 10000 row versions in 30 pages<br>DETAIL:&nbsp; 0 index row versions were removed.<br>0 index pages have been deleted, 0 are currently reusable.<br>CPU 0.00s/0.00u sec elapsed 0.00 sec.<br>INFO:&nbsp; "tbl_test1": found 0 removable, 10000 nonremovable row versions in 55 out of 55 pages<br>DETAIL:&nbsp; 10000 dead row versions cannot be removed yet.<br>There were 0 unused item pointers.<br>0 pages are entirely empty.<br>CPU 0.00s/0.00u sec elapsed 0.00 sec.<br>INFO:&nbsp; vacuuming "pg_toast.pg_toast_2473792"<br>INFO:&nbsp; index "pg_toast_2473792_index" now contains 0 row versions in 1 pages<br>DETAIL:&nbsp; 0 index row versions were removed.<br>0 index pages have been deleted, 0 are currently reusable.<br>CPU 0.00s/0.00u sec elapsed 0.00 sec.<br>INFO:&nbsp; "pg_toast_2473792": found 0 removable, 0 nonremovable row versions in 0 out of 0 pages<br>DETAIL:&nbsp; 0 dead row versions cannot be removed yet.<br>There were 0 unused item pointers.<br>0 pages are entirely empty.<br>CPU 0.00s/0.00u sec elapsed 0.00 sec.<br>INFO:&nbsp; analyzing "rmt_rescue.tbl_test1"<br>INFO:&nbsp; "tbl_test1": scanned 55 of 55 pages, containing 0 live rows and 10000 dead rows; 0 rows in sample, 0 estimated total rows<br>VACUUM<br>Time: 13.408 ms</font></p></pre>事务B，出现了不可移除的行版本.<br><pre class="prettyprint"   ><p><font size="2"   >rmt_rescue=&gt; vacuum full analyze verbose tbl_test1;<br>INFO:&nbsp; vacuuming "rmt_rescue.tbl_test1"<br>INFO:&nbsp; analyzing "rmt_rescue.tbl_test1"<br>INFO:&nbsp; "tbl_test1": scanned 55 of 55 pages, containing 0 live rows and 10000 dead rows; 0 rows in sample, 0 estimated total rows<br>VACUUM<br>Time: 185.097 ms</font></p></pre>事务B，VACUUM FULL ANALYZE并没有回收这些PAGE。<br><pre class="prettyprint"   ><p><font size="2"   >rmt_rescue=&gt; select pg_relation_size('tbl_test1');<br>&nbsp;pg_relation_size <br>------------------<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 450560<br>(1 row)</font></p></pre>事务A，（经测试rollback和commit都一样,只要结束事务）<br><pre class="prettyprint"   ><p><font size="2"   >rmt_rescue=&gt; rollback;<br>ROLLBACK</font></p></pre><br>事务B，<br><pre class="prettyprint"   ><p><font size="2"   >rmt_rescue=&gt; vacuum analyze verbose tbl_test1;<br>INFO:&nbsp; vacuuming "rmt_rescue.tbl_test1"<br>INFO:&nbsp; scanned index "idx_test1" to remove 10000 row versions<br>DETAIL:&nbsp; CPU 0.00s/0.00u sec elapsed 0.00 sec.<br>INFO:&nbsp; "tbl_test1": removed 10000 row versions in 55 pages<br>DETAIL:&nbsp; CPU 0.00s/0.00u sec elapsed 0.00 sec.<br>INFO:&nbsp; index "idx_test1" now contains 0 row versions in 30 pages<br>DETAIL:&nbsp; 10000 index row versions were removed.<br>27 index pages have been deleted, 0 are currently reusable.<br>CPU 0.00s/0.00u sec elapsed 0.00 sec.<br>INFO:&nbsp; "tbl_test1": found 10000 removable, 0 nonremovable row versions in 55 out of 55 pages<br>DETAIL:&nbsp; 0 dead row versions cannot be removed yet.<br>There were 0 unused item pointers.<br>0 pages are entirely empty.<br>CPU 0.00s/0.00u sec elapsed 0.00 sec.<br>INFO:&nbsp; "tbl_test1": truncated 55 to 0 pages<br>DETAIL:&nbsp; CPU 0.00s/0.01u sec elapsed 0.01 sec.<br>INFO:&nbsp; vacuuming "pg_toast.pg_toast_2473792"<br>INFO:&nbsp; index "pg_toast_2473792_index" now contains 0 row versions in 1 pages<br>DETAIL:&nbsp; 0 index row versions were removed.<br>0 index pages have been deleted, 0 are currently reusable.<br>CPU 0.00s/0.00u sec elapsed 0.00 sec.<br>INFO:&nbsp; "pg_toast_2473792": found 0 removable, 0 nonremovable row versions in 0 out of 0 pages<br>DETAIL:&nbsp; 0 dead row versions cannot be removed yet.<br>There were 0 unused item pointers.<br>0 pages are entirely empty.<br>CPU 0.00s/0.00u sec elapsed 0.00 sec.<br>INFO:&nbsp; analyzing "rmt_rescue.tbl_test1"<br>INFO:&nbsp; "tbl_test1": scanned 0 of 0 pages, containing 0 live rows and 0 dead rows; 0 rows in sample, 0 estimated total rows<br>VACUUM<br>Time: 35.836 ms<br>rmt_rescue=&gt; select pg_relation_size('tbl_test1');<br>&nbsp;pg_relation_size <br>------------------<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0<br>(1 row)</font></p></pre>页面被回收。<br><br>因此:<br>当数据库的UPDATE,DELETE操作较为频繁时不要做长事务的操作，因为在此时间段内的其他表不能回收垃圾空间。将造成数据表的膨胀效应。<br>如果膨胀太离谱了，应在业务低谷时使用VACUUM FULL回收垃圾空间。<br><br>紧急处理:<br>如果DML事务实在是太长了, 并且还在继续, 同时其他的表已经膨胀到影响性能的情况下，可以建个临时表,truncate来回收垃圾空间.<br><pre class="prettyprint"   ><p><font size="2"   >repo=&gt; select pg_relation_size('tbl_test1');<br>&nbsp;pg_relation_size <br>------------------<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 892928<br>(1 row)<br><br>repo=&gt; begin;<br>BEGIN<br>repo=&gt; lock table tbl_test1 in exclusive mode;<br>LOCK TABLE<br>repo=&gt; create table tbl_test2 (like tbl_test1);<br>CREATE TABLE<br>repo=&gt; insert into tbl_test2 select * from tbl_Test1;<br>INSERT 0 10000<br>repo=&gt; truncate table tbl_test1;<br>TRUNCATE TABLE<br>repo=&gt; insert into tbl_test1 select * from tbl_test2;<br>INSERT 0 10000<br>repo=&gt; commit;<br>COMMIT<br>repo=&gt; select pg_relation_size('tbl_test1');<br>&nbsp;pg_relation_size <br>------------------<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 450560<br>(1 row)</font></p></pre><br>小结 ：<br>1. 当数据库中有活动的事务正在运行(通过txid_current_snapshot()函数查看, 末尾为未完成的事务),&nbsp;<span style="line-height: 22px;"   >当末尾有值时,&nbsp;</span>vacuum都无法回收FREE 空间.<br>2. 那么为什么会出现这样的情况呢, 原因还在于PostgreSQL使用的MVCC, 因为已分配了事务号的事务未结束时. 这个事务就可能要查询数据库中任何可以查询的数据, 因此这些数据即使被DELETE或者UPDATE了, 也无法回收其空间. 必须保留着.<div>3. 但实际上, PostgreSQL的vacuum做得有点粗糙, 理论上这个活动的事务如果是read committed的, 那么另一个已经提交的事务中被删除或者更新的记录, 老的版本tuples应该是不会被前一个事务所见了, 是可以被vacuum掉的. 但是PostgreSQL似乎没有对这个进行判断. 而仅仅是查看当前是否有已分配事务号并且未完成的事务存在. 如果有并且该事务号小于这条记录的xmin或xmax就不回收这条记录的空间.</div><div>因为这条记录对于这个活动事务来说是未来的记录.&nbsp;</div><div>简单来说, 当数据库集群中存在transactionid+ExclusiveLock,&nbsp;relation+RowExclusiveLock锁时, 在此事务之后开启的事务, 执行DML的话, 产生的垃圾数据无法回收, 即出现nonremovable 的情况.</div></div>
	</div>
</div>
</body>
</html>