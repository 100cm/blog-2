<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL HOT STANDBY using log shipping</h2>
	<h5 id="">2010-12-30 17:38:25&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402010113053825671/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">PostgreSQL HOT STANDBY by log shipping 测试:<br>一、准备硬件<br>1. 主节点硬件配置<br>DISK : 146GB*6<br>MEM : 14GB<br>CPU : 2.83GHz*8<br>2. standby节点硬件配置<br>DISK : 146GB*4<br>MEM : 8GB<br>CPU : 2.0GHz*8<br><br>二、准备环境<br>1. 系统<br>Red Hat Enterprise Linux Server release 5.5 (Tikanga) x64<br>2. 时钟同步<br>8 * * * * /usr/sbin/ntpdate asia.pool.ntp.org &amp;&amp; /sbin/hwclock --systohc<br>3. 配置目录<br>mkdir -p /database/pgdata/tbs1<br>mkdir -p /database/pgdata/tbs2<br>mkdir -p /database/pgdata/tbs3<br>mkdir -p /database/pgdata/tbs4<br>mkdir -p /database/pgdata/tbs5<br>fdisk<br>mkfs.ext3<br>mount /dev/cciss/c0d1p1 /database/pgdata/tbs1<br>mount /dev/cciss/c0d2p1 /database/pgdata/tbs2<br>mount /dev/cciss/c0d3p1 /database/pgdata/tbs3<br>mount /dev/cciss/c0d4p1 /database/pgdata/tbs4<br>mount /dev/cciss/c0d5p1 /database/pgdata/tbs5<br>master节点:<br>[root@db-172-16-3-33 ~]# df -h<br>Filesystem&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Size&nbsp; Used Avail Use% Mounted on<br>/dev/cciss/c0d0p1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 31G&nbsp; 8.1G&nbsp;&nbsp; 21G&nbsp; 29% /<br>/dev/cciss/c0d0p3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 88G&nbsp; 1.7G&nbsp;&nbsp; 81G&nbsp;&nbsp; 3% /opt<br>tmpfs&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 6.9G&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp; 6.9G&nbsp;&nbsp; 0% /dev/shm<br>/dev/cciss/c0d1p1&nbsp;&nbsp;&nbsp;&nbsp; 135G&nbsp;&nbsp; 76M&nbsp; 128G&nbsp;&nbsp; 1% /database/pgdata/tbs1<br>/dev/cciss/c0d2p1&nbsp;&nbsp;&nbsp;&nbsp; 135G&nbsp; 6.1G&nbsp; 122G&nbsp;&nbsp; 5% /database/pgdata/tbs2<br>/dev/cciss/c0d3p1&nbsp;&nbsp;&nbsp;&nbsp; 135G&nbsp; 3.3G&nbsp; 125G&nbsp;&nbsp; 3% /database/pgdata/tbs3<br>/dev/cciss/c0d4p1&nbsp;&nbsp;&nbsp;&nbsp; 135G&nbsp; 5.6G&nbsp; 123G&nbsp;&nbsp; 5% /database/pgdata/tbs4<br>/dev/cciss/c0d5p1&nbsp;&nbsp;&nbsp;&nbsp; 135G&nbsp;&nbsp; 16G&nbsp; 113G&nbsp; 13% /database/pgdata/tbs5<br><br>slave节点:<br>Filesystem&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Size&nbsp; Used Avail Use% Mounted on<br>/dev/sda1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 31G&nbsp; 3.5G&nbsp;&nbsp; 26G&nbsp; 13% /<br>/dev/sda3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 94G&nbsp; 386M&nbsp;&nbsp; 89G&nbsp;&nbsp; 1% /opt<br>tmpfs&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 3.9G&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp; 3.9G&nbsp;&nbsp; 0% /dev/shm<br>/dev/sdb1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 134G&nbsp;&nbsp; 76M&nbsp; 128G&nbsp;&nbsp; 1% /database/pgdata/tbs1<br>/dev/sdc1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 134G&nbsp; 188M&nbsp; 127G&nbsp;&nbsp; 1% /database/pgdata/tbs2<br>/dev/sdd1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 134G&nbsp; 2.9G&nbsp; 125G&nbsp;&nbsp; 3% /database/pgdata/tbs3<br>172.16.3.33:/database/pgdata/tbs4<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 135G&nbsp; 5.6G&nbsp; 123G&nbsp;&nbsp; 5% /database/pgdata/tbs4<br><br>vi /etc/fstab<br>4. 在主节点配置nfs,将wal归档目录export出去,<br>(这里没有使用中央日志服务器,有条件的话还是需要一个比较大的日志服务器为好,以便支持更多的slave节点)<br>/database/pgdata/tbs4 172.16.3.39/32(rw,no_root_squash,sync)<br>&nbsp; slave节点mount这个目录.<br>&nbsp; 确保master节点和slave节点的postgres用户gid uid相同,否则可能有权限的问题.<br>5. 配置内核参数等<br>kernel.shmmni = 4096<br>kernel.sem = 501000 6412800000 501000 12800<br>fs.file-max = 767246<br>net.ipv4.ip_local_port_range = 1024 65000<br>net.core.rmem_default = 1048576<br>net.core.rmem_max = 1048576<br>net.core.wmem_default = 262144<br>net.core.wmem_max = 262144<br>net.ipv4.tcp_tw_recycle=1 <br>net.ipv4.tcp_max_syn_backlog=4096 <br>net.core.netdev_max_backlog=10000<br>vm.overcommit_memory=0<br>net.ipv4.ip_conntrack_max=655360<br><br>*&nbsp; soft&nbsp;&nbsp;&nbsp; nofile&nbsp; 131072<br>*&nbsp; hard&nbsp;&nbsp;&nbsp; nofile&nbsp; 131072<br>*&nbsp; soft&nbsp;&nbsp;&nbsp; nproc&nbsp;&nbsp; 131072<br>*&nbsp; hard&nbsp;&nbsp;&nbsp; nproc&nbsp;&nbsp; 131072<br>*&nbsp; soft&nbsp;&nbsp;&nbsp; core&nbsp;&nbsp;&nbsp; unlimited<br>*&nbsp; hard&nbsp;&nbsp;&nbsp; core&nbsp;&nbsp;&nbsp; unlimited<br>*&nbsp; soft&nbsp;&nbsp;&nbsp; memlock 50000000<br>*&nbsp; hard&nbsp;&nbsp;&nbsp; memlock 50000000<br><br>6. 配置系统服务<br>chkconfig --level 35 nfs on<br>chkconfig --level 35 portmap pn<br><br>7. 配置防火墙<br>vi /etc/sysconfig/iptables<br><br>8. 升级操作系统补丁,驱动等<br><br>三、安装PostgreSQL 9.0.2<br>1. postgres user profile:<br>export PS1="$USER@`/bin/hostname -s`-&gt; "<br>export PGPORT=1921<br>export PGDATA=/database/pgdata/tbs1/pg_root<br>export PGARCHIVE=/database/pgdata/tbs4/pg_arch<br><br>export LANG=en_US.utf8<br><br>export PGHOME=/opt/pgsql<br>export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib<br>export DATE=`date +"%Y%m%d%H%M"`<br>export PATH=$PGHOME/bin:$PATH:.<br>export MANPATH=$PGHOME/share/man:$MANPATH<br>alias rm='rm -i'<br>alias ll='ls -lh'<br><br>2. 配置数据库相关目录<br>2.1 log<br>&nbsp; /var/applog/pg_log<br>2.2 pghome<br>&nbsp; /opt/pgsql<br>2.3 pgdata<br>&nbsp; /database/pgdata/tbs1/pg_root<br>2.4 pgarchive<br>&nbsp; /database/pgdata/tbs4/pg_arch<br><br>3. 初始化数据库<br>initdb -D /database/pgdata/tbs1/pg_root -E UTF8 --locale=C -U postgres -X /database/pgdata/tbs2/pg_xlog -W <br><br>四、配置master节点<br>1. pg_hba.conf<br># "local" is for Unix domain socket connections only<br>local&nbsp;&nbsp; all&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; all&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; trust<br># IPv4 local connections:<br>host&nbsp;&nbsp;&nbsp; all&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; all&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 127.0.0.1/32&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; trust<br># IPv6 local connections:<br># host&nbsp;&nbsp;&nbsp; all&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; all&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ::1/128&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; trust<br>host all all 0.0.0.0/0&nbsp; md5<br><br>2. postgresql.conf<br><pre class="prettyprint"  ><p><font size="2"  >listen_addresses = '*'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # what IP address(es) to listen on;<br>port = 1921&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # (change requires restart)<br>max_connections = 2000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # (change requires restart)<br>unix_socket_directory = '/database/pgdata/tbs1/pg_root'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # (change requires restart)<br>unix_socket_permissions = 0700&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # begin with 0 to use octal notation<br>password_encryption = on<br>shared_buffers = 2048MB&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # min 128kB<br>maintenance_work_mem = 2048MB&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # min 1MB<br>max_stack_depth = 8MB&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # min 100kB<br>wal_level = hot_standby&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # minimal, archive, or hot_standby<br>synchronous_commit = off&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # immediate fsync at commit<br>wal_sync_method = fdatasync&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # the default is the first option <br>wal_buffers = 128000kB&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # min 32kB<br>wal_writer_delay = 20ms&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # 1-10000 milliseconds<br>checkpoint_segments = 64&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # in logfile segments, min 1, 16MB each<br>checkpoint_timeout = 30min&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # range 30s-1h<br>archive_mode = on&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # allows archiving to be done<br>archive_command = 'cp %p $PGARCHIVE/%f'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # command to use to archive a logfile segment<br>max_wal_senders = 30&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # max number of walsender processes<br>random_page_cost = 2.0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # same scale as above<br>effective_cache_size = 12800MB<br>constraint_exclusion = partition&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # on, off, or partition<br>log_destination = 'csvlog'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Valid values are combinations of<br>logging_collector = on&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Enable capturing of stderr and csvlog<br>log_directory = '/var/applog/pg_log'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # directory where log files are written,<br>log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log' # log file name pattern,<br>log_truncate_on_rotation = on&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # If on, an existing log file of the<br>log_rotation_age = 1d&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Automatic rotation of logfiles will<br>log_rotation_size = 10MB&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Automatic rotation of logfiles will <br>log_min_duration_statement = 1000ms&nbsp;&nbsp;&nbsp;&nbsp; # -1 is disabled, 0 logs all statements<br>log_checkpoints = on<br>log_lock_waits = on&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # log lock waits &gt;= deadlock_timeout<br>log_statement = 'ddl'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # none, ddl, mod, all<br>track_activity_query_size = 2048&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # (change requires restart)<br>autovacuum = on&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Enable autovacuum subprocess?&nbsp; 'on' <br>log_autovacuum_min_duration = 0 # -1 disables, 0 logs all actions and<br>check_function_bodies = on<br>bytea_output = 'escape'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # hex, escape<br>datestyle = 'iso, mdy'<br>lc_messages = 'C'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # locale for system error message<br>lc_monetary = 'C'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # locale for monetary formatting<br>lc_numeric = 'C'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # locale for number formatting<br>lc_time = 'C'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # locale for time formatting<br>default_text_search_config = 'pg_catalog.english'<br>deadlock_timeout = 1s</font></p></pre><br>3. 启动主节点.<br><br>五、传输基础文件至slave节点,模拟一个正在运行的数据库生成复制库的操作.<br>1. on the master<br>select pg_start_backup('replication backup');<br>2. on the master<br>scp $PGDATA $SLAVE_IP:$PGDATA<br>3. on the master<br>select pg_stop_backup();<br><br>六、配置slave节点<br>1. on the slave<br>chown -R postgres:postgres $PGDATA<br>su - postgres<br>cd $PGDATA<br>rm postmaster.pid<br>rm -rf pg_xlog<br>ln -s /database/pgdata/tbs2/pg_xlog ./pg_xlog<br>2. 配置postgresql.conf<br><pre class="prettyprint"  ><p><font size="2"  >listen_addresses = '*'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # what IP address(es) to listen on;<br>port = 1921&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # (change requires restart)<br>max_connections = 2000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # (change requires restart)<br>unix_socket_directory = '/database/pgdata/tbs1/pg_root'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # (change requires restart)<br>unix_socket_permissions = 0700&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # begin with 0 to use octal notation<br>password_encryption = on<br>shared_buffers = 2048MB&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # min 128kB<br>maintenance_work_mem = 2048MB&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # min 1MB<br>max_stack_depth = 8MB&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # min 100kB<br>wal_level = hot_standby&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # minimal, archive, or hot_standby<br>synchronous_commit = off&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # immediate fsync at commit<br>wal_sync_method = fdatasync&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # the default is the first option <br>wal_buffers = 128000kB&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # min 32kB<br>wal_writer_delay = 20ms&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # 1-10000 milliseconds<br>checkpoint_segments = 64&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # in logfile segments, min 1, 16MB each<br>checkpoint_timeout = 30min&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # range 30s-1h<br>archive_mode = on&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # allows archiving to be done<br>archive_command = 'cp %p $PGARCHIVE/%f'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # command to use to archive a logfile segment<br>max_wal_senders = 30&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # max number of walsender processes<br>hot_standby = off&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # 这个参数在初始化slave的时候关闭是比较明智的选择,在初始同步完成后在开启<br>random_page_cost = 2.0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # same scale as above<br>effective_cache_size = 12800MB<br>constraint_exclusion = partition&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # on, off, or partition<br>log_destination = 'csvlog'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Valid values are combinations of<br>logging_collector = on&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Enable capturing of stderr and csvlog<br>log_directory = '/var/applog/pg_log'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # directory where log files are written,<br>log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log' # log file name pattern,<br>log_truncate_on_rotation = on&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # If on, an existing log file of the<br>log_rotation_age = 1d&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Automatic rotation of logfiles will<br>log_rotation_size = 10MB&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Automatic rotation of logfiles will <br>log_min_duration_statement = 1000ms&nbsp;&nbsp;&nbsp;&nbsp; # -1 is disabled, 0 logs all statements<br>log_checkpoints = on<br>log_lock_waits = on&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # log lock waits &gt;= deadlock_timeout<br>log_statement = 'ddl'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # none, ddl, mod, all<br>track_activity_query_size = 2048&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # (change requires restart)<br>autovacuum = on&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # Enable autovacuum subprocess?&nbsp; 'on' <br>log_autovacuum_min_duration = 0 # -1 disables, 0 logs all actions and<br>check_function_bodies = on<br>bytea_output = 'escape'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # hex, escape<br>datestyle = 'iso, mdy'<br>lc_messages = 'C'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # locale for system error message<br>lc_monetary = 'C'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # locale for monetary formatting<br>lc_numeric = 'C'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # locale for number formatting<br>lc_time = 'C'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # locale for time formatting<br>default_text_search_config = 'pg_catalog.english'<br>deadlock_timeout = 1s</font></p></pre><br>3. 配置recovery.conf<br>restore_command = 'cp $PGARCHIVE/%f %p'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # e.g. 'cp /mnt/server/archivedir/%f %p'<br>archive_cleanup_command = 'pg_archivecleanup $PGARCHIVE %r'<br>standby_mode = 'on'<br>trigger_file = '/database/pgdata/tbs1/pg_root/postgresql.trigger.1921'<br><br>4. 启动slave节点<br><br>启动完后,可以通过top看到slave节点在拼命的恢复pg_start_backup以来的所有wal.<br>恢复完后修改hot_standby = on,重启slave节点<br><br>七、测试<br>1. (on master)新建用户<br>create role digoal nosuperuser login encrypted password 'digoal';<br>2. 新建表空间<br>on master<br>su - postgres<br>mkdir /database/pgdata/tbs3/tbs_test<br>on slave<br>su - postgres<br>mkdir /database/pgdata/tbs3/tbs_test<br>on master<br>create tablespace tbs_digoal owner test location '/database/pgdata/tbs3/tbs_digoal';<br>3. (on master)新建数据库<br>create database digoal with owner digoal template template0 encoding 'UTF8' tablespace tbs_digoal;<br>4. (on master)新建schema<br>\c digoal digoal<br>create schema digoal authorization digoal;<br>5. (on master)新建表<br>\c digoal digoal<br>create table tbl_users (id int8 , nick varchar(32));<br>6. (on master)插入测试数据<br>insert into tbl_users select generate_series(1,10000000),'digoal';<br>由于插入数据量比较大,可以很明显的看到pg_arch目录中的WAL在增加,如<br>-rw------- 1 postgres postgres&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 254 Dec 30 15:17 000000010000000000000004.00000020.backup<br>-rw------- 1 postgres postgres 67108864 Dec 30 15:19 000000010000000100000024<br>-rw------- 1 postgres postgres 67108864 Dec 30 15:19 000000010000000100000025<br>生成WAL后,slave节点又开始recover事件,recover完成后等待下一个wal如:<br>25456 postgres&nbsp; 18&nbsp;&nbsp; 0 2389m 1364&nbsp; 736 S&nbsp; 0.0&nbsp; 0.0&nbsp;&nbsp; 0:00.00 postgres: startup process&nbsp;&nbsp; waiting for 00000001000000010000000E <br><br>7. (on master)使用DDL测试冲突<br>on master<br>alter table tbl_users add column first_name default 'zhou';<br>alter table tbl_users add column last_name default 'digoal';<br>在slave恢复期间,在slave节点执行 select count(*) from tbl_users;发生等待事件.<br><br>on slave /var/applog/pg_log中查看最近一个日志文件,<br>2010-12-30 15:04:01.462 CST,"digoal","digoal",25240,"127.0.0.1:43079",4d1c2edf.6298,1,"SELECT waiting",2010-12-30 15:03:59 CST,2/14,0,LOG,00000,"process 25240 still waiting for AccessShareLock on relation 16388 of database 16386 after 1000.564 ms",,,,,,"select count(*) from tbl_users;",22,,"psql"<br><br>如果数据库没有其他操作了,不再发生ARCHIVE操作时,你可能会发现主节点已经alter完了,slave节点还是在等待.<br>原因是alter完的log信息存在的XLOG还没有发生归档,slave节点会一直等待下去(这时可以手工执行pg_switch_xlog).<br><br>8. (on master)测试checkpoint<br>在PostgreSQL中发生checkpoint后,在此之前的WAL在做数据库恢复时就用不到了,因为确保数据都写入数据文件了.<br>pg_archivecleanup也是根据checkpoint来判断和删除不需要的WAL的.<br><br>9. (on slave)测试cleanarchive<br>在做checkpoint前,去看$PGARCHIVE目录,已经被apply的文件还存在,并没有被pg_archivecleanup命令清除掉,原因就是这些文件是最近一次checkpoint以来的WAL文件,在数据库恢复时是需要用到的.<br>如果你手工执行pg_archivecleanup $PGARCHIVE 000000010000000200000031 (假设000000010000000200000031这个是在$PGARCHIVE中的一个WAL的文件名)<br>这条命令将删除000000010000000200000031以前生成的所有WAL文件,一定要小心操作,万一不小心把最近一次CHECKPOINT以来的WAL删除了,<br>补救的方法是赶紧到master上做一次checkpoint,让slave知道这次checkpoint,否则的话下次slave启动还会读到000000010000000200000031这个文件以前的文件,那时候就只能找到这些文件或重建slave了.<br><br>10. (on slave)测试active slave<br>激活SLAVE很简单,了解到已经apply了最新的WAL后,执行以下<br>su - postgres<br>touch /database/pgdata/tbs1/pg_root/postgresql.trigger.1921<br>数据库会触发激活的动作,激活后/database/pgdata/tbs1/pg_root/postgresql.trigger.1921这个文件会自动删掉,并且recovery.conf被重命名为recovery.done.<br>激活后的slave不可逆转为slave了.需要重建.<br><br>11. 监控<br><pre class="prettyprint"  ><p><font size="2"  >pg_current_xlog_insert_location<br>pg_current_xlog_location<br>pg_last_xlog_receive_location<br>pg_last_xlog_replay_location<br>top<br>CREATE OR REPLACE VIEW pg_stat_replication AS<br>&nbsp;&nbsp;&nbsp; SELECT<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; S.procpid,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; S.usesysid,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; U.rolname AS usename,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; S.application_name,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; S.client_addr,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; S.client_port,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; S.backend_start<br>&nbsp;&nbsp;&nbsp; FROM pg_stat_get_activity(NULL) AS S, pg_authid U<br>&nbsp;&nbsp;&nbsp; WHERE S.usesysid = U.oid AND S.datid = 0;</font></p></pre><br>八、附pgctl.sh脚本<br><pre class="prettyprint"  ><p><font size="2"  >#!/bin/bash<br><br># environment.<br># Get the aliases and functions<br>if [ -f ~/.bashrc ]; then<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; . ~/.bashrc<br>fi<br><br># User specific environment and startup programs<br><br>export PGHOME=/opt/pgsql<br>export PATH=$PGHOME/bin:$PATH<br>export PGDATA=/database/pgdata/tbs1/pg_root<br>export PGPORT=1921<br>export LANG='en_US.utf8'<br>export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib<br><br>RETVAL=1<br><br>start() {<br>su - postgres -c "/usr/bin/nohup $PGHOME/bin/postgres -D $PGDATA -p $PGPORT &gt;/dev/null 2&gt;&gt;/var/applog/pg_log/start_err.log&nbsp; &lt;/dev/null &amp;"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RETVAL=$?<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return $RETVAL<br>}<br><br>stop() {<br>su - postgres -c "$PGHOME/bin/pg_ctl stop -D $PGDATA -m fast"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RETVAL=$?<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return $RETVAL<br>}<br><br>reload() {<br>su - postgres -c "$PGHOME/bin/pg_ctl reload -D $PGDATA"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; RETVAL=$?<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return $RETVAL<br>}<br><br># See how we were called.<br>case "$1" in<br>&nbsp; start)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; start<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;;<br>&nbsp; stop)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; stop<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;;<br>&nbsp; restart)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; stop<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; start<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;;<br>&nbsp; reload)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; reload<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ;;<br>&nbsp; *)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; echo $"Usage: $prog {start|stop|restart|reload}"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; exit 2<br>esac<br><br>exit $RETVAL<br># Auth Digoal.Zhou<br># Corp. Sky-Mobi</font></p></pre><br>久、其他<br>1. 自9.0以后,PostgreSQL引入了一个叫pg_archivecleanup的模块,简化了standby的配置.以前通过pg_standby来实现的.<br>2. 第二象限开发的基于PostgreSQL 内部复制的产品<br>http://projects.2ndquadrant.com/repmgr<br><div>3. other blog</div><div><div>PostgreSQL 9.1 Allow standby recovery to switch to a new timeline automatically</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201182395310376/"  >http://blog.163.com/digoal@126/blog/static/163877040201182395310376/</a></div><div><br></div><div>PostgreSQL 9.2 devel adding cascading replication support</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012012361519/"  >http://blog.163.com/digoal@126/blog/static/1638770402012012361519/</a></div><div><br></div><div>PostgreSQL HOT STANDBY using Stream</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020110442050808/"  >http://blog.163.com/digoal@126/blog/static/16387704020110442050808/</a></div><div><br></div><div>PostgreSQL cluster role switchover between primary and standby</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201141154024306/"  >http://blog.163.com/digoal@126/blog/static/163877040201141154024306/</a></div><div><br></div><div>We can ignore the performance influence when use sync replication in PostgreSQL 9.1 &nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201192203458765/"  >http://blog.163.com/digoal@126/blog/static/163877040201192203458765/</a></div><div><br></div><div>PostgreSQL 9.1 Replication role privilege change to REPLICATION from SUPERUSER</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020114112379185/"  >http://blog.163.com/digoal@126/blog/static/16387704020114112379185/</a></div><div><br></div><div>PostgreSQL 9.0.2 Replication Best Practices</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402010113034232645/"  >http://blog.163.com/digoal@126/blog/static/1638770402010113034232645/</a></div><div><br></div><div>PostgreSQL replication monitor</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201141134748660/"  >http://blog.163.com/digoal@126/blog/static/163877040201141134748660/</a></div><div><br></div><div>New replication mode: async, write, fsync, replay</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020121231117557/"  >http://blog.163.com/digoal@126/blog/static/16387704020121231117557/</a></div><div><br></div><div>PostgreSQL HOT STANDBY using log shipping</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402010113053825671/"  >http://blog.163.com/digoal@126/blog/static/1638770402010113053825671/</a></div></div></div>
	</div>
</div>
</body>
</html>