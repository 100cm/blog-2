<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">nagios monitor Oracle JOB script</h2>
	<h5 id="">2012-02-20 17:36:36&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020121205345407/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><br></div><div>主脚本 :&nbsp;</div><div><span style="line-height: 20px; font-size: small;"  >/home/oracle/job_nagios.sh</span> </div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >#!/bin/bash</font></div><div><font size="2"  >. /home/oracle/.bash_profile</font></div><div><font size="2"  >export LANG=en_US.utf8</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >export NLS_DATE_FORMAT='yyyy-mm-dd hh24:mi:ss'</font></div><div><font size="2"  >export NLS_LANG=AMERICAN_AMERICA.UTF8</font></div><div><font size="2"  >export LANG=en_US.utf8</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ># ENV</font></div><div><font size="2"  >. /home/oracle/env.sh</font></div><div><font size="2"  >LOG_FILE=/home/oracle/job_nagios_$1.log</font></div><div><font size="2"  >TEMP_FILE=/tmp/job_nagios_$1.tmp</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >ORA_USER="用户略"</font></div><div><font size="2"  >ORA_PWD=\"密码略\"</font></div><div><font size="2"  ># 用户需要有select sys.dba_jobs的权限</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >RETVAL=0</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >f_mon()</font></div><div><font size="2"  >{</font></div><div><font size="2"  >V_USER=$1</font></div><div><font size="2"  >V_PWD=$2</font></div><div><font size="2"  >V_TNS=$3</font></div><div><font size="2"  >V_ALIAS=$4</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >JOBS_FAILURE=`echo -e "set heading off;\n</font></div><div><font size="2"  >set pagesize 0;\n</font></div><div><font size="2"  >set verify off;\n</font></div><div><font size="2"  >set echo off;\n</font></div><div><font size="2"  >set feedback off;\n</font></div><div><font size="2"  >set linesize 120;\n</font></div><div><font size="2"  >set trimspool on;\n</font></div><div><font size="2"  >set termout off;\n</font></div><div><font size="2"  >column schema_user format a32;\n</font></div><div><font size="2"  >column broken format a6;\n</font></div><div><font size="2"  >column what format a30;\n</font></div><div><font size="2"  >select to_char(job) jobid,schema_user,broken,to_char(failures) failures,what from sys.dba_jobs where failures&gt;0 or broken='Y';\n</font></div><div><font size="2"  >quit;\n"|sqlplus -s $V_USER/$V_PWD@$V_TNS|col -x`</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >LINE_JOB=`echo -e $JOBS_FAILURE|grep -v "^$"|wc -l`</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >if [ $LINE_JOB -ge 1 ]; then</font></div><div><font size="2"  >&nbsp; RETVAL=1</font></div><div><font size="2"  >&nbsp; echo -e "`date +%F\ %T`\n$V_ALIAS\n$V_TNS\nJOBS_FAILURE : \njobid &nbsp; &nbsp;schema_user &nbsp; &nbsp;broken &nbsp; &nbsp;failures &nbsp; &nbsp;what &nbsp; &nbsp;\n$JOBS_FAILURE\n\n" &gt;&gt; $LOG_FILE</font></div><div><font size="2"  >&nbsp; echo -e "`date +%F\ %T`\n$V_ALIAS\n$V_TNS\nJOBS_FAILURE : \njobid &nbsp; &nbsp;schema_user &nbsp; &nbsp;broken &nbsp; &nbsp;failures &nbsp; &nbsp;what &nbsp; &nbsp;\n$JOBS_FAILURE\n\n" &gt; $TEMP_FILE</font></div><div><font size="2"  >&nbsp; grep -E "N\ +16|Y\ +16" $TEMP_FILE</font></div><div><font size="2"  >&nbsp; if [ $? -eq 0 ]; then</font></div><div><font size="2"  >&nbsp; RETVAL=2</font></div><div><font size="2"  >&nbsp; fi</font></div><div><font size="2"  >fi</font></div><div><font size="2"  >}</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >eval str="$"$1</font></div><div><font size="2"  >f_mon $ORA_USER $ORA_PWD $str $1</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >if [ $LINE_JOB -ge 1 ]; then</font></div><div><font size="2"  >cat $TEMP_FILE</font></div><div><font size="2"  >fi</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >exit $RETVAL</font></div><p></p></pre></div><div><font size="2"  >环境变量文件env.sh</font></div><div><pre class="prettyprint"  ><p><font size="2"  >TNS_DIGOAL="//10.1.1.10:1521/digoal"</font></p></pre></div><div><font size="2"  ><span style="line-height: 20px;"  >nagios 配置 :&nbsp;</span></font></div><div><font size="2"  ><span style="line-height: 20px;"  >假设oracle为监控用户, 默认是nagios</span></font></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >vi /etc/xinetd.d/nrpe 修改</font></div><div><font size="2"  ><div>&nbsp; &nbsp; &nbsp; &nbsp; user &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= oracle</div><div>&nbsp; &nbsp; &nbsp; &nbsp; group &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = oinstall</div></font></div><p></p></pre></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ><span style="line-height: 20px;"  >vi&nbsp;/usr/local/nagios/etc/nrpe.cfg&nbsp;</span></font></div><div><font size="2"  >command[check_db_job1]=/home/oracle/job_nagios.sh TNS_DIGOAL</font></div><p></p></pre></div><div><font size="2"  ><span style="line-height: 20px;"  >重启xinetd服务</span></font></div><div><font size="2"  ><span style="line-height: 20px;"  ><br></span></font></div><wbr></div>
	</div>
</div>
</body>
</html>