<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.1 unlogged table's UNLOGGED_RELATION_INIT & UNLOGGED_RELATION_CLEANUP</h2>
	<h5 id="">2012-02-02 10:05:23&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020121210128345/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>在PostgreSQL 9.1.2 中的unlogged表，数据库crash后所有的数据将被清除。</div><div>但是我以前在9.1 beta2版本测试时checkpoint前的数据是不会被清除的，所以应该是9.1release后修复了beta版的BUG。</div><div>beta版本的测试请参考我之前写的BLOG。</div><div>下面是9.1.2版本的测试 : 与手册上提到的情况一致。</div><div><dt style="font-family: verdana, sans-serif; font-size: 12px; line-height: normal;"  ><tt>UNLOGGED</tt></dt><dd style="font-family: verdana, sans-serif; font-size: 12px; line-height: normal;"  ><p style="font-size: 1em; line-height: 1.5em; margin-top: 1.2em; margin-right: 0em; margin-bottom: 1.2em; margin-left: 0em;"  >If specified, the table is created as an unlogged table. Data written to unlogged tables is not written to the write-ahead log (see&nbsp;<a style="color: rgb(0, 78, 102); " rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/wal.html"  >Chapter 29</a>), which makes them considerably faster than ordinary tables. However, they are not crash-safe: an unlogged table is automatically truncated after a crash or unclean shutdown. The contents of an unlogged table are also not replicated to standby servers. Any indexes created on an unlogged table are automatically unlogged as well; however, unlogged&nbsp;<a style="color: rgb(0, 78, 102); " rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/gist.html"  >GiST indexes</a>&nbsp;are currently not supported and cannot be created on an unlogged table.</p><p style="font-size: 1em; line-height: 1.5em; margin-top: 1.2em; margin-right: 0em; margin-bottom: 1.2em; margin-left: 0em;"  ><br></p></dd></div><div>在数据库crash后，数据被清除。</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; create UNLOGGED table unlogged_test (id int);</font></div><div><font size="2"  >CREATE TABLE</font></div><div><font size="2"  >digoal=&gt; insert into unlogged_test values (1);</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=&gt; \q</font></div><div><font size="2"  >postgres@db-172-16-3-33-&gt; pg_ctl stop -m immediate</font></div><div><font size="2"  >waiting for server to shut down.... done</font></div><div><font size="2"  >server stopped</font></div><div><font size="2"  >postgres@db-172-16-3-33-&gt; pg_ctl start</font></div><div><font size="2"  >server starting</font></div><div><font size="2"  >postgres@db-172-16-3-33-&gt; psql -h 127.0.0.1 digoal digoal</font></div><div><font size="2"  >psql (9.1.2)</font></div><div><font size="2"  >Type "help" for help.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=&gt; select * from unlogged_test ;</font></div><div><font size="2"  >&nbsp;id&nbsp;</font></div><div><font size="2"  >----</font></div><div><font size="2"  >(0 rows)</font></div><p></p></pre></div><div>不做checkpoint肯定是清除的, 结果和9.1beta版本测试一致。</div><div>下面是做checkpoint, 测试结果和9.1beta版本测试不一样。</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; insert into unlogged_test values (1);</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=&gt; \c digoal postgres</font></div><div><font size="2"  >You are now connected to database "digoal" as user "postgres".</font></div><div><font size="2"  >digoal=# checkpoint;</font></div><div><font size="2"  >CHECKPOINT</font></div><div><font size="2"  >digoal=# \q</font></div><div><font size="2"  >postgres@db-172-16-3-33-&gt; pg_ctl stop -m immediate</font></div><div><font size="2"  >waiting for server to shut down.... done</font></div><div><font size="2"  >server stopped</font></div><div><font size="2"  >postgres@db-172-16-3-33-&gt; pg_ctl start</font></div><div><font size="2"  >server starting</font></div><div><font size="2"  >postgres@db-172-16-3-33-&gt; psql -h 127.0.0.1 digoal digoal</font></div><div><font size="2"  >psql (9.1.2)</font></div><div><font size="2"  >Type "help" for help.</font></div><div><font size="2"  >digoal=&gt; select * from unlogged_test ;</font></div><div><font size="2"  >&nbsp;id&nbsp;</font></div><div><font size="2"  >----</font></div><div><font size="2"  >(0 rows)</font></div><p></p></pre></div><div><br></div><div>【小结】</div><div>清除操作解释如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >/*</font></div><div><font size="2"  >&nbsp;* Reset unlogged relations from before the last restart.</font></div><div><font size="2"  >&nbsp;*</font></div><div><font size="2"  >&nbsp;* If op includes UNLOGGED_RELATION_CLEANUP, we remove all forks of any</font></div><div><font size="2"  >&nbsp;* relation with an "init" fork, except for the "init" fork itself.</font></div><div><font size="2"  >&nbsp;*</font></div><div><font size="2"  >&nbsp;* If op includes UNLOGGED_RELATION_INIT, we copy the "init" fork to the main</font></div><div><font size="2"  >&nbsp;* fork.</font></div><div><font size="2"  >&nbsp;*/</font></div><p></p></pre></div><div><br></div>【参考】<wbr><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201151402832128/"  >http://blog.163.com/digoal@126/blog/static/163877040201151402832128/</a> </div><div>src/backend/storage/file/reinit.c</div><div>src/backend/access/transam/xlog.c</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* We're in recovery, so unlogged relations relations may be trashed</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* and must be reset. &nbsp;This should be done BEFORE allowing Hot Standby</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* connections, so that read-only backends don't try to read whatever</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* garbage is left over from before.</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ResetUnloggedRelations(UNLOGGED_RELATION_CLEANUP);</font></div></div><div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Reset initial contents of unlogged relations. &nbsp;This has to be done</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* AFTER recovery is complete so that any unlogged relations created</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* during recovery also get picked up.</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; if (InRecovery)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ResetUnloggedRelations(UNLOGGED_RELATION_INIT);</font></div></div><p></p></pre></div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">melaty - 2013-04-27 15:24:10</h5>
				<div>你好，是否可以将一个unlogged的table，通过alter语句修改为normal的表？</div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 melaty - 2013-04-27 15:24:10</h5>
				<div style="width:600px;">HI, 可以. 具体请参考如下文章.<div>http://blog.163.com/digoal@126/blog/static/16387704020133274380469/</div></div>
			</div>
	</div>
</div>
</body>
</html>