<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">mongoDB nagios plugin (check_mongodb.py) BUG resolve</h2>
	<h5 id="">2012-02-22 13:02:09&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020121220295489/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">昨天一位同事问我现在我们的mongoDB在用什么做监控, 实在是惭愧, 一直没有对mongoDB进行比较细节的监控.&nbsp;<div>仅仅是监控了服务器的一些性能指标.</div><div>今天赶紧看了一下mongoDB手册中关于监控的章节.&nbsp;</div><div>下面是根据mongoDB官方推荐的几种监控方式之一, 结合我们正在使用的nagios进行的配置.</div><div>前提条件,</div><div>1. 需要nagios服务端</div><div>2. 在mongoDB所在的服务器需要安装nagios agent</div><div>3.&nbsp;<span style="line-height: 22px;"  >在mongoDB所在的服务器</span>需要python &gt;=2.4的版本 , 我这里使用的是2.4</div><div>4.&nbsp;<span style="line-height: 22px;"  >在mongoDB所在的服务器</span>需要pymongo模块</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp; &nbsp; git clone git://github.com/mongodb/mongo-python-driver.git</font></div><div><font size="2"  >&nbsp; &nbsp; cd&nbsp;mongo-python-driver</font></div><div><font size="2"  >&nbsp; &nbsp; python setup.py install</font></div><p></p></pre></div><div><br></div><div>为了简化安装步骤, 可以先在mongoDB服务器上安装git.&nbsp;</div><div>有了以上前提就可以安装nagios-plugin-mongodb插件了.</div><div>转到nagios plugin目录例如/usr/local/nagios/libexec/</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >cd&nbsp;/usr/local/nagios/libexec/</font></div><div><font size="2"  >git clone&nbsp;git://github.com/mzupan/nagios-plugin-mongodb.git</font></div><p></p></pre></div><div>这就算安装好了.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >cd&nbsp;<span style="line-height: 19px;"  >nagios-plugin-mongodb</span></font></div><div><font size="2"  >chmod 755 check_mongodb.py</font></div><p></p></pre></div><div>使用语法如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >./check_mongodb.py -h</font></div><div><font size="2"  >usage: check_mongodb.py [options]</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >This Nagios plugin checks the health of mongodb.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >options:</font></div><div><font size="2"  >&nbsp; -h, --help &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;show this help message and exit</font></div><div><font size="2"  >&nbsp; -H HOST, --host=HOST &nbsp;The hostname you want to connect to</font></div><div><font size="2"  >&nbsp; -P PORT, --port=PORT &nbsp;The port mongodb is runnung on</font></div><div><font size="2"  >&nbsp; -u USER, --user=USER &nbsp;The username you want to login as</font></div><div><font size="2"  >&nbsp; -p PASSWD, --pass=PASSWD</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; The password you want to use for that user</font></div><div><font size="2"  >&nbsp; -W WARNING, --warning=WARNING</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; The warning threshold we want to set</font></div><div><font size="2"  >&nbsp; -C CRITICAL, --critical=CRITICAL</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; The critical threshold we want to set</font></div><div><font size="2"  >&nbsp; -A ACTION, --action=ACTION</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; The action you want to take</font></div><div><font size="2"  >&nbsp; -D, --perf-data &nbsp; &nbsp; &nbsp; Enable output of Nagios performance data</font></div><div><font size="2"  >&nbsp; -d DATABASE, --database=DATABASE</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Specify the database to check</font></div><div><font size="2"  >&nbsp; -s, --ssl &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Connect using SSL</font></div><p></p></pre></div><div>例如检查连接连接超时, 2秒警告, 4秒严重警告</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >check_mongodb.py -H 127.0.0.1 -P 2000 -A connect -W 2 -C 4</font></div><div><font size="2"  >返回 :&nbsp;OK - Connection took 0 seconds</font></div><p></p></pre></div><div>其他检测 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >连接池已使用, 70%警告, 80%严重警告</font></div><div><div><font size="2"  >check_mongodb.py -H 127.0.0.1 -P 2000 -A connections -W 70 -C 80</font></div><div><font size="2"  >复制延时, 15秒警告, 30秒严重警告</font></div><div><font size="2"  >check_mongodb.py -H 127.0.0.1 -P 2000 -A replication_lag -W 15 -C 30</font></div><div><font size="2"  >内存使用, 18G警告, 22G严重警告(假设本机内存是24G)</font></div><div><font size="2"  >check_mongodb.py -H 127.0.0.1 -P 2000 -A memory -W 18 -C 22</font></div><div><font size="2"  >锁的耗时比例, 5%警告, 10%严重警告(锁占用时间长说明数据库已经超载)</font></div><div><font size="2"  >check_mongodb.py -H 127.0.0.1 -P 2000 -A lock -W 5 -C 10</font></div><div><font size="2"  >平均flush耗时, 100ms警告, 200ms严重警告(FLUSH时间长说明遇到IO写瓶颈, 或考虑升级硬盘, 或考虑shard)</font></div><div><font size="2"  >check_mongodb.py -H 127.0.0.1 -P 2000 -A flushing -W 100 -C 200</font></div><div><font size="2"  >最后一次flush的耗时, 100ms警告, 200ms严重警告(FLUSH时间长说明遇到IO写瓶颈, 或考虑升级硬盘, 或考虑shard)</font></div><div><font size="2"  >check_mongodb.py -H 127.0.0.1 -P 2000 -A last_flush_time -W 100 -C 200</font></div><div><font size="2"  >检测replicaset中所有节点的状态, 0, 0 (Depending which status it is it sends a waring during status 0, 3 and 5, critical if the status is 4, 6 or 8 and a ok with status 1, 2 and 7)</font></div><div><font size="2"  >check_mongodb.py -H 127.0.0.1 -P 2000 -A replset_state -W 0 -C 0</font></div><div><font size="2"  >检查索引的未命中率, .005警告, .01严重警告(值大的话考虑添加索引)</font></div><div><font size="2"  >check_mongodb.py -H 127.0.0.1 -P 2000 -A index_miss_ratio -W .005 -C .01</font></div><div><font size="2"  >检查数据库个数, 300警告, 500严重警告</font></div><div><font size="2"  >check_mongodb.py -H 127.0.0.1 -P 2000 -A databases -W 300 -C 500</font></div><div><font size="2"  >检查collection个数, 300警告, 500严重警告</font></div><div><font size="2"  >check_mongodb.py -H 127.0.0.1 -P 2000 -A collections -W 300 -C 500</font></div><div><font size="2"  >检查数据库大小, 300警告, 500严重警告(每个库一条, 主要用于框定该服务器可以承受的数据库大小后, 跟踪数据库的增长)</font></div><div><font size="2"  >check_mongodb.py -H 127.0.0.1 -P 2000 -A database_size -W 4 -C 10 -d admin</font></div><div><font size="2"  >check_mongodb.py -H 127.0.0.1 -P 2000 -A database_size -W 40 -C 45 -d local</font></div><div><font size="2"  >check_mongodb.py -H 127.0.0.1 -P 2000 -A database_size -W 300 -C 400 -d digoal</font></div></div><div><font size="2"  >注意, 如果检查了一个不存在的数据库, 这个数据库将被初始化, 占据空间, 所以需要慎用database_size的检测.</font></div><p></p></pre></div><div>把这些条目加到/usr/local/nagios/etc/nrpe.cfg中</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >command[check_mongodb_connections]=/usr/local/nagios/libexec/nagios-plugin-mongodb/check_mongodb.py -H 127.0.0.1 -P 2000 -A connections -W 70 -C 80</font></div><div><font size="2"  >其他略.</font></div><p></p></pre></div><div>重启xinetd服务</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >service xinetd restart</font></div><div></div><p></p></pre></div><div>再到nagios服务端配置对应的条目.</div><div>略.</div><div><br></div><div>【BUG】</div><div>在使用过程中发现一些问题,&nbsp;</div><div><div style="line-height: 22px;"  >使用以下代码进行跟踪</div><div><div><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; import traceback</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; print "*******\n%s********" %traceback.format_exc()</font></div><p></p></pre></div></div></div><div>发现check_mongodb.py的第136行有点问题, 调用的pymongo.version不存在 :&nbsp;</div><div><pre class="prettyprint"  ><p>if pymongo.verison &gt;= "2.1":</p></pre></div><div>后来找到pymongo, 这个函数的名字应该是get_version_string, 所以需要修改以下check_mongodb.py</div><div>改成这样 :&nbsp;</div><div><pre class="prettyprint"  ><p>if pymongo.get_version_string &gt;= "2.1":</p></pre></div><div><br></div><div>【参考】</div><div><a rel="nofollow" href="http://www.mongodb.org/display/DOCS/Monitoring+and+Diagnostics"  >http://www.mongodb.org/display/DOCS/Monitoring+and+Diagnostics</a> </div><div><a rel="nofollow" href="https://github.com/mzupan/nagios-plugin-mongodb"  >https://github.com/mzupan/nagios-plugin-mongodb</a> </div><div><a rel="nofollow" href="https://github.com/mongodb/mongo-python-driver"  >https://github.com/mongodb/mongo-python-driver</a> </div><div><br></div><div><br><br><wbr></div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">wuguangke1 - 2012-02-22 17:51:15</h5>
				<div><P>博主，您好！我想请问一下执行：/usr/local/nagios/libexec/check_mongodb.py -H 192.168.5.40 -P 27017 -A connect -W 70 -C 80 显示ok了<BR>OK - Connection took 0 seconds</P>  <P>但是在nagios的监控页面上显示为null，这是哪有问题呢 谢谢！</P></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 wuguangke1 - 2012-02-22 17:51:15</h5>
				<div style="width:600px;">HI,<div>&nbsp; 可能是服务端的配置问题.</div><div>&nbsp; 客户端返回0,1,2代表OK,WARNING,critical.</div><div>&nbsp; 标准输出显示在服务端的INFO里面.</div></div>
			</div>
			<div id="">
				<h5 id="">德哥@Digoal - 2012-02-22 13:08:46</h5>
				<div>感谢肖大侠对check_mongodb.py trace bug的支持</div>
			</div>
	</div>
</div>
</body>
</html>