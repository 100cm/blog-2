<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">nagios monitor Oracle Tablespace Usage script</h2>
	<h5 id="">2012-02-28 11:45:24&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402012128114524240/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">前面写过一篇关于监控Oracle JOB的nagios脚本,<div><a href="http://blog.163.com/digoal@126/blog/static/16387704020121205345407/"  >http://blog.163.com/digoal@126/blog/static/16387704020121205345407/</a>&nbsp;</div><div>以下是监控表空间的 :&nbsp;</div><div>/home/oracle/tbs_dgs_nagios.sh</div><div><br></div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >#!/bin/bash</font></div><div><font size="2"  >. /home/oracle/.bash_profile</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >export NLS_DATE_FORMAT='yyyy-mm-dd hh24:mi:ss'</font></div><div><font size="2"  >export NLS_LANG=AMERICAN_AMERICA.UTF8</font></div><div><font size="2"  >export LANG=en_US.utf8</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ><br></font></div><div><font size="2"  ># ENV</font></div><div><font size="2"  >. /home/oracle/env.sh</font></div><div><font size="2"  >LOG_FILE=/home/oracle/log/tbs_dgs_$1.log</font></div><div><font size="2"  >TMP_FILE=/tmp/tbs_dgs_$1.log</font></div><div><font size="2"  >DATE=`date +%H`</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >ORA_USER="略"</font></div><div><font size="2"  >ORA_PWD=\"略\"</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >eval str="$"$1</font></div><div><font size="2"  >if [ $DATE == 09 ] || [ $DATE == 10 ] || [ $DATE == 11 ] || [ $DATE == 12 ] || [ $DATE == 13 ] || [ $DATE == 14 ] || [ $DATE == 15 ] || [ $DATE == 16 ] || [ $DATE == 17 ] || [ $DATE == 18 ] || [ $DATE == 19 ] || [ $DATE == 20 ] || [ $DATE == 21 ] || [ $DATE == 22 ] || [ $DATE == 23 ]; then</font></div><div><font size="2"  >TBS_USAGE=`echo -e "set heading off;\n</font></div><div><font size="2"  >set pagesize 0;\n</font></div><div><font size="2"  >set verify off;\n</font></div><div><font size="2"  >set echo off;\n</font></div><div><font size="2"  >set feedback off;\n</font></div><div><font size="2"  >set linesize 140;\n</font></div><div><font size="2"  >set trimspool on;\n</font></div><div><font size="2"  >set termout off;\n</font></div><div><font size="2"  >column free_mbs format a32;\n</font></div><div><font size="2"  >column total_mbs format a10;\n</font></div><div><font size="2"  >column tbs_name format a32;\n</font></div><div><font size="2"  >select t1.tbs tbs_name,to_char(t2.mbs)||'MB' total_mbs,to_char(t1.mbs)||case when t2.mbs &lt;= 100 then 'MB,Require 9MB free' when t2.mbs &gt; 100 and t2.mbs&lt;=2048 then 'MB,Require 512MB free' when t2.mbs&gt;2048 and t2.mbs&lt;=12000 then 'MB,Require 1280MB free' when t2.mbs&gt;12000 then 'MB,Require 5120MB free' else null end free_mbs,'\\\\\\\\n' ok from (select trunc(sum(bytes)/1024/1024) mbs,tablespace_name tbs from sys.dba_free_space group by tablespace_name) t1,(select trunc(sum(bytes)/1024/1024) mbs,tablespace_name tbs from sys.dba_data_files group by tablespace_name) t2 where t1.tbs=t2.tbs and ((t2.mbs &lt;= 100 and t1.mbs &lt; 9) or (t2.mbs&gt;100 and t2.mbs&lt;=2048 and t1.mbs&lt;512) or (t2.mbs&gt;2048 and t2.mbs&lt;=12000 and t1.mbs&lt;1280) or (t2.mbs&gt;12000 and t1.mbs&lt;5120));\n</font></div><div><font size="2"  >quit;\n"|sqlplus -s $ORA_USER/$ORA_PWD@$str|col -x`</font></div><div><font size="2"  >fi</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >if [ $DATE == 00 ] || [ $DATE == 01 ] || [ $DATE == 02 ] || [ $DATE == 03 ] || [ $DATE == 04 ] || [ $DATE == 05 ] || [ $DATE == 06 ] || [ $DATE == 07 ] || [ $DATE == 08 ]; then</font></div><div><font size="2"  >TBS_USAGE=`echo -e "set heading off;\n</font></div><div><font size="2"  >set pagesize 0;\n</font></div><div><font size="2"  >set verify off;\n</font></div><div><font size="2"  >set echo off;\n</font></div><div><font size="2"  >set feedback off;\n</font></div><div><font size="2"  >set linesize 140;\n</font></div><div><font size="2"  >set trimspool on;\n</font></div><div><font size="2"  >set termout off;\n</font></div><div><font size="2"  >column free_mbs format a32;\n</font></div><div><font size="2"  >column total_mbs format a10;\n</font></div><div><font size="2"  >column tbs_name format a32;\n</font></div><div><font size="2"  >select t1.tbs tbs_name,to_char(t2.mbs)||'MB' total_mbs,to_char(t1.mbs)||case when t2.mbs &lt;= 100 then 'MB,Require 9MB free' when t2.mbs &gt; 100 and t2.mbs&lt;=2048 then 'MB,Require 100MB free' when t2.mbs&gt;2048 and t2.mbs&lt;=12000 then 'MB,Require 512MB free' when t2.mbs&gt;12000 then 'MB,Require 4096MB free' else null end free_mbs,'\\\\\\\\n' ok from (select trunc(sum(bytes)/1024/1024) mbs,tablespace_name tbs from sys.dba_free_space group by tablespace_name) t1,(select trunc(sum(bytes)/1024/1024) mbs,tablespace_name tbs from sys.dba_data_files group by tablespace_name) t2 where t1.tbs=t2.tbs and ((t2.mbs &lt;= 100 and t1.mbs &lt; 9) or (t2.mbs&gt;100 and t2.mbs&lt;=2048 and t1.mbs&lt;100) or (t2.mbs&gt;2048 and t2.mbs&lt;=12000 and t1.mbs&lt;512) or (t2.mbs&gt;12000 and t1.mbs&lt;4096));\n</font></div><div><font size="2"  >quit;\n"|sqlplus -s $ORA_USER/$ORA_PWD@$str|col -x`</font></div><div><font size="2"  >fi</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >LINE=`echo -e $TBS_USAGE|grep -v "^$"|wc -l`</font></div><div><font size="2"  >if [ $LINE -ge 1 ]; then</font></div><div><font size="2"  >echo -e "`date +%F%T`\n$i\n$str\nTBS_NAME &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TOTAL_MB &nbsp; FREE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \n$TBS_USAGE\n\n\nAuthor : Digoal\n\n" &gt;&gt; $LOG_FILE 2&gt;&amp;1</font></div><div><font size="2"  >echo -e "`date +%F%T`\n$i\n$str\nTBS_NAME &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TOTAL_MB &nbsp; FREE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; \n$TBS_USAGE\n\n\nAuthor : Digoal\n\n" &gt; $TMP_FILE 2&gt;&amp;1</font></div><div><font size="2"  >grep "SP2-0306" $TMP_FILE<br>if [ $? -eq 0 ]; then<br>cat $TMP_FILE<br>exit 1<br>fi<br>cat $TMP_FILE<br>exit 2</font></div><div><font size="2"  >fi</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >exit 0</font></div><p></p></pre></div>环境变量文件env.sh<wbr></div><div><pre class="prettyprint"  ><p><font size="2"  ><span style="line-height: 21px;"  >TNS_DIGOAL</span><span style="line-height: 21px; color: rgb(102, 102, 0);"  >=</span><span style="line-height: 21px; color: rgb(0, 136, 0);"  >"//10.1.1.10:1521/digoal"</span></font></p></pre></div><div><div>nagios 配置 :&nbsp;</div><div>假设oracle为监控用户, 默认是nagios</div><div>vi /etc/xinetd.d/nrpe 修改</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; user &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= oracle</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; group &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = oinstall</font></div><p></p></pre></div><div>vi /usr/local/nagios/etc/nrpe.cfg&nbsp;</div><div><pre class="prettyprint"  ><p>command[check_db_tbs1]=/home/oracle/tbs_dgs_nagios.sh TNS_DIGOAL</p></pre></div><div>重启xinetd服务</div></div><br><div>微调 :&nbsp;</div><div>如果经常NRPE超时, 如NRPE默认是10秒超时, 可能是由于这台机器连数据库太慢造成的, 可以设置这台机上的sqlnet.ora</div><div>表示sqlplus连出去6秒超时.&nbsp;</div><div>SQLNET.OUTBOUND_CONNECT_TIMEOUT=6</div></div>
	</div>
</div>
</body>
</html>