<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.4 Logical decoding</h2>
	<h5 id="">2014-03-25 13:53:20&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402014225105758300/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL 9.4添加了逻辑SQL复制的基础模块, logical decoding , 未来可以在此基础之上增加逻辑复制的功能.</div><div>架构很清晰明了:</div><div>1. 在发送端的节点配置xlog级别, logical, 将在XLOG文件中记录下用于SQL复制的信息.</div><div>2. 在数据库中创建SLOT, slot记录下当时的xlog位置.</div><div>3. 接收端通过流复制协议连接到发送端节点对应的slot, 从对应的xlog位置开始接收XLOG, 可以从中取出需要的信息, 例如redo SQL.</div><div>一个数据库可以创建多个slot, 一个slot不能同时多个客户端接收.&nbsp;</div><div>slot的信息只包含了lsn位置信息, 实际的复制需要的信息存储在xlog中, 所以即使数据库重启, 也不会受到影响, 只要xlog还在.</div><div><br></div><div>测试 :&nbsp;</div><div>下载最新的镜像</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=snapshot;h=6c5ced1526b189ed98baa0d195a7078d1afd112e;sf=tgz</font></div><div><font size="2"   >tar -zxvf&nbsp;postgresql-6c5ced1.tar.gz</font></div><div><font size="2"   >cd&nbsp;postgresql-6c5ced1</font></div><div><font size="2"   >./configure --prefix=/home/pg94/pgsql9.4devel --with-pgport=1933 --with-perl --with-tcl --with-python --with-openssl --with-pam --without-ldap --with-libxml --with-libxslt --enable-thread-safety --with-wal-blocksize=64 --with-blocksize=32 --enable-dtrace --enable-debug &amp;&amp; gmake &amp;&amp; gmake install</font></div><div><font size="2"   >cd contrib/</font></div><div><font size="2"   >gmake &amp;&amp; gmake install</font></div><div><font size="2"   >initdb -D $PGDATA -E UTF8 --locale=C -U postgres -W</font></div><p></p></pre></div><div>配置postgresql.conf</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >max_connections = 100 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >unix_socket_directories = '.' &nbsp; # comma-separated list of directories</font></div><div><font size="2"   >shared_buffers = 128MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# min 128kB</font></div><div><font size="2"   >dynamic_shared_memory_type = posix # the default is the first option</font></div><div><font size="2"   >wal_level = logical &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # minimal, archive, hot_standby or logical</font></div><div><font size="2"   >max_wal_senders = 32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# max number of walsender processes</font></div><div><font size="2"   >max_replication_slots = 32 &nbsp; &nbsp; &nbsp;# max number of replication slots.</font></div><div><font size="2"   >log_destination = 'csvlog' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Valid values are combinations of</font></div><div><font size="2"   >logging_collector = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Enable capturing of stderr and csvlog</font></div><div><font size="2"   >log_timezone = 'PRC'</font></div><div><font size="2"   >datestyle = 'iso, mdy'</font></div><div><font size="2"   >timezone = 'PRC'</font></div><div><font size="2"   >lc_messages = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for system error message</font></div><div><font size="2"   >lc_monetary = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for monetary formatting</font></div><div><font size="2"   >lc_numeric = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for number formatting</font></div><div><font size="2"   >lc_time = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for time formatting</font></div><div><font size="2"   >default_text_search_config = 'pg_catalog.english'</font></div><p></p></pre></div><div>启动数据库, 在目标库创建slot.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# select pg_create_logical_replication_slot('test','test_decoding');</font></div><div><font size="2"   >&nbsp;pg_create_logical_replication_slot&nbsp;</font></div><div><font size="2"   >------------------------------------</font></div><div><font size="2"   >&nbsp;(test,0/199C738)</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >postgres=# select * from pg_replication_slots ;</font></div><div><font size="2"   >&nbsp;slot_name | &nbsp; &nbsp;plugin &nbsp; &nbsp; | slot_type | datoid | database | active | xmin | catalog_xmin | restart_lsn&nbsp;</font></div><div><font size="2"   >-----------+---------------+-----------+--------+----------+--------+------+--------------+-------------</font></div><div><font size="2"   >&nbsp;test &nbsp; &nbsp; &nbsp;| test_decoding | logical &nbsp; | &nbsp;16384 | digoal &nbsp; | f &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 1812 | 0/199C738</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>我们可以使用test_decoding插件来测试, 目前这个slot中没有消息.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# SELECT * FROM pg_logical_slot_get_changes('test', NULL, NULL, 'include-xids', '0');</font></div><div><font size="2"   >&nbsp;location | xid | data&nbsp;</font></div><div><font size="2"   >----------+-----+------</font></div><div><font size="2"   >(0 rows)</font></div></div><div><div><font size="2"   >digoal=# create table test(id int primary key, info text, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div></div><p></p></pre></div><div><div>DDL不包含在消息中</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# SELECT * FROM pg_logical_slot_get_changes('test', NULL, NULL, 'include-xids', '0');</font></div><div><font size="2"   >&nbsp;location &nbsp;| xid &nbsp;| &nbsp;data &nbsp;</font></div><div><font size="2"   >-----------+------+--------</font></div><div><font size="2"   >&nbsp;0/199C7C8 | 1812 | BEGIN</font></div><div><font size="2"   >&nbsp;0/19F0A80 | 1812 | COMMIT</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div></div><div>DML包含在消息中.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# insert into test select generate_series(1,10),md5(random()::text),clock_timestamp();</font></div><div><font size="2"   >INSERT 0 10</font></div><div><font size="2"   >digoal=# SELECT * FROM pg_logical_slot_get_changes('test', NULL, NULL, 'include-xids', '0');</font></div><div><font size="2"   >&nbsp;location &nbsp;| xid &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;data &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----------+------+-----------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >-------------------------------------------</font></div><div><font size="2"   >&nbsp;0/19F0B90 | 1813 | BEGIN</font></div><div><font size="2"   >&nbsp;0/19F0B90 | 1813 | table public.test: INSERT: id[integer]:1 info[text]:'e5b1bd6948292facf2592b65d0521e34' crt_time[timestamp withou</font></div><div><font size="2"   >t time zone]:'2014-03-25 11:50:22.891618'</font></div><div><font size="2"   >&nbsp;0/19F0CC0 | 1813 | table public.test: INSERT: id[integer]:2 info[text]:'3dcaf5e9267fa4962f877fa8dfcdffe3' crt_time[timestamp withou</font></div><div><font size="2"   >t time zone]:'2014-03-25 11:50:22.892116'</font></div><div><font size="2"   >&nbsp;0/19F0D78 | 1813 | table public.test: INSERT: id[integer]:3 info[text]:'0c67db0c8a6a41596b9aec67e1c7a3ab' crt_time[timestamp withou</font></div><div><font size="2"   >t time zone]:'2014-03-25 11:50:22.892134'</font></div><div><font size="2"   >&nbsp;0/19F0E30 | 1813 | table public.test: INSERT: id[integer]:4 info[text]:'d1b8b8517d247d938303e14a629e578b' crt_time[timestamp withou</font></div><div><font size="2"   >t time zone]:'2014-03-25 11:50:22.892145'</font></div><div><font size="2"   >&nbsp;0/19F0EE8 | 1813 | table public.test: INSERT: id[integer]:5 info[text]:'5395e8bfb04452e012ad459882e02b91' crt_time[timestamp withou</font></div><div><font size="2"   >t time zone]:'2014-03-25 11:50:22.892153'</font></div><div><font size="2"   >&nbsp;0/19F0FA0 | 1813 | table public.test: INSERT: id[integer]:6 info[text]:'ad534ae3e377b16abfda4ba697f6b338' crt_time[timestamp withou</font></div><div><font size="2"   >t time zone]:'2014-03-25 11:50:22.892162'</font></div><div><font size="2"   >&nbsp;0/19F1058 | 1813 | table public.test: INSERT: id[integer]:7 info[text]:'789d56b13e482d05f533c8d1e2272e42' crt_time[timestamp withou</font></div><div><font size="2"   >t time zone]:'2014-03-25 11:50:22.892171'</font></div><div><font size="2"   >&nbsp;0/19F1110 | 1813 | table public.test: INSERT: id[integer]:8 info[text]:'a5e99d5d566bb25df66be3bf500d8a2a' crt_time[timestamp withou</font></div><div><font size="2"   >t time zone]:'2014-03-25 11:50:22.89218'</font></div><div><font size="2"   >&nbsp;0/19F11C8 | 1813 | table public.test: INSERT: id[integer]:9 info[text]:'ff8b420286fa1543f66fdd2e968d1951' crt_time[timestamp withou</font></div><div><font size="2"   >t time zone]:'2014-03-25 11:50:22.892189'</font></div><div><font size="2"   >&nbsp;0/19F1280 | 1813 | table public.test: INSERT: id[integer]:10 info[text]:'20d17fbe89bc145dc2302bd1fe22bdfd' crt_time[timestamp witho</font></div><div><font size="2"   >ut time zone]:'2014-03-25 11:50:22.892213'</font></div><div><font size="2"   >&nbsp;0/19F1378 | 1813 | COMMIT</font></div><div><font size="2"   >(12 rows)</font></div><p></p></pre></div><div><br></div><div>使用pg_recvlogical程序, 流复制协议从wal sender进程接收逻辑消息.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi pg_hba.conf</font></div><div><font size="2"   >local replication postgres trust</font></div><div><font size="2"   >pg_ctl reload</font></div><div><font size="2"   >pg94@db-172-16-3-150-&gt; pg_recvlogical -f - -d digoal -h $PGDATA -U postgres -P test_decoding -s 1 -S test --start</font></div><p></p></pre></div><div>在psql中执行插入 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# insert into test select generate_series(11,20),md5(random()::text),clock_timestamp();</font></div><div><font size="2"   >INSERT 0 10</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >pg_recvlogical 输出如下 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >BEGIN 1814</font></div><div><font size="2"   >table public.test: INSERT: id[integer]:11 info[text]:'ae72f7f96ceeecaa29a735d703a3f242' crt_time[timestamp without time zone]:'2014-03-25 11:53:50.25136'</font></div><div><font size="2"   >table public.test: INSERT: id[integer]:12 info[text]:'f012366afd80d25ce9dde8bcd607ec2e' crt_time[timestamp without time zone]:'2014-03-25 11:53:50.251436'</font></div><div><font size="2"   >table public.test: INSERT: id[integer]:13 info[text]:'ffd8fef099c1d1d46ae15bc2028a832a' crt_time[timestamp without time zone]:'2014-03-25 11:53:50.251448'</font></div><div><font size="2"   >table public.test: INSERT: id[integer]:14 info[text]:'35d3f9555922c08b541351a6075f8715' crt_time[timestamp without time zone]:'2014-03-25 11:53:50.251458'</font></div><div><font size="2"   >table public.test: INSERT: id[integer]:15 info[text]:'49302bbc23356e5a06fb6ab9049bdd62' crt_time[timestamp without time zone]:'2014-03-25 11:53:50.251467'</font></div><div><font size="2"   >table public.test: INSERT: id[integer]:16 info[text]:'c8e62f6a980a716c6738623a53505153' crt_time[timestamp without time zone]:'2014-03-25 11:53:50.251476'</font></div><div><font size="2"   >table public.test: INSERT: id[integer]:17 info[text]:'972dc81c0a9dc8ba5a7c369c2961e020' crt_time[timestamp without time zone]:'2014-03-25 11:53:50.251485'</font></div><div><font size="2"   >table public.test: INSERT: id[integer]:18 info[text]:'88a371022809ce0a01b260f7da0bcb8f' crt_time[timestamp without time zone]:'2014-03-25 11:53:50.251494'</font></div><div><font size="2"   >table public.test: INSERT: id[integer]:19 info[text]:'1c968a48d87236a5f7da8cd7d7c3a61d' crt_time[timestamp without time zone]:'2014-03-25 11:53:50.251503'</font></div><div><font size="2"   >table public.test: INSERT: id[integer]:20 info[text]:'b12aaf18d96180a00b3d77324850ba91' crt_time[timestamp without time zone]:'2014-03-25 11:53:50.251512'</font></div><div><font size="2"   >COMMIT 1814</font></div><p></p></pre></div><div><br></div><div>一个数据库的同一个slot不能被同时消费. 例如, 在前面的pg_recvlogical未中断的情况下, 我再开一个pg_recvlogical 连接同一个库的同一个slot则报错.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg94@db-172-16-3-150-&gt; pg_recvlogical -f - -d digoal -h $PGDATA -U postgres -P test_decoding -s 1 -S test --start</font></div><div><font size="2"   >pg_recvlogical: could not send replication command "START_REPLICATION SLOT "test" LOGICAL 0/0": ERROR: &nbsp;replication slot "test" is already active</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg_recvlogical: disconnected. Waiting 5 seconds to try again.</font></div><div><font size="2"   >pg_recvlogical: could not send replication command "START_REPLICATION SLOT "test" LOGICAL 0/0": ERROR: &nbsp;replication slot "test" is already active</font></div><div><font size="2"   >pg_recvlogical: disconnected. Waiting 5 seconds to try again.</font></div><p></p></pre></div><div>因为当前这个slot是活动的</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from pg_replication_slots ;</font></div><div><font size="2"   >&nbsp;slot_name | &nbsp; &nbsp;plugin &nbsp; &nbsp; | slot_type | datoid | database | active | xmin | catalog_xmin | restart_lsn&nbsp;</font></div><div><font size="2"   >-----------+---------------+-----------+--------+----------+--------+------+--------------+-------------</font></div><div><font size="2"   >&nbsp;test &nbsp; &nbsp; &nbsp;| test_decoding | logical &nbsp; | &nbsp;16384 | digoal &nbsp; | t &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 1815 | 0/19F1BF8</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>但是一个库可以创建多个slot.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select pg_create_logical_replication_slot('test1','test_decoding');</font></div><div><font size="2"   >&nbsp;pg_create_logical_replication_slot&nbsp;</font></div><div><font size="2"   >------------------------------------</font></div><div><font size="2"   >&nbsp;(test1,0/19F1C68)</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>当存在多个slot时, 每个SLOT从对应的lsn开始接受消息.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >slot test :&nbsp;</font></div><div><div><font size="2"   >BEGIN 1815</font></div><div><font size="2"   >table public.test: INSERT: id[integer]:21 info[text]:'68be6296c89edf64864ada9a6397ef36' crt_time[timestamp without time zone]:'2014-03-25 11:57:02.622989'</font></div><div><font size="2"   >table public.test: INSERT: id[integer]:22 info[text]:'c434ec7f839d1031dc1cb1b75478569d' crt_time[timestamp without time zone]:'2014-03-25 11:57:02.623059'</font></div><div><font size="2"   >table public.test: INSERT: id[integer]:23 info[text]:'bfb079a6e998939db852a8e8bb0dff23' crt_time[timestamp without time zone]:'2014-03-25 11:57:02.62307'</font></div><div><font size="2"   >table public.test: INSERT: id[integer]:24 info[text]:'57e59156860f4644a44637f9103c6563' crt_time[timestamp without time zone]:'2014-03-25 11:57:02.623079'</font></div><div><font size="2"   >table public.test: INSERT: id[integer]:25 info[text]:'e0fdf1d897d828c0f782f93538090217' crt_time[timestamp without time zone]:'2014-03-25 11:57:02.623088'</font></div><div><font size="2"   >table public.test: INSERT: id[integer]:26 info[text]:'e04e24747cb6356a493f257b83769577' crt_time[timestamp without time zone]:'2014-03-25 11:57:02.623097'</font></div><div><font size="2"   >table public.test: INSERT: id[integer]:27 info[text]:'25f75f492daeb16a31e1001c90141c83' crt_time[timestamp without time zone]:'2014-03-25 11:57:02.623106'</font></div><div><font size="2"   >table public.test: INSERT: id[integer]:28 info[text]:'9d825e383331f2caf271980fe1123586' crt_time[timestamp without time zone]:'2014-03-25 11:57:02.623115'</font></div><div><font size="2"   >table public.test: INSERT: id[integer]:29 info[text]:'53472c00ffc4d1e4cfef73402daff0d9' crt_time[timestamp without time zone]:'2014-03-25 11:57:02.623124'</font></div><div><font size="2"   >table public.test: INSERT: id[integer]:30 info[text]:'df19f5b2b81f1430c08a43e053359c81' crt_time[timestamp without time zone]:'2014-03-25 11:57:02.623133'</font></div><div><font size="2"   >COMMIT 1815</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >slot test1 :&nbsp;</font></div><div><div><font size="2"   >pg94@db-172-16-3-150-&gt; pg_recvlogical -f - -d digoal -h $PGDATA -U postgres -P test_decoding -s 1 -S test1 --start</font></div><div><font size="2"   >BEGIN 1815</font></div><div><font size="2"   >table public.test: INSERT: id[integer]:21 info[text]:'68be6296c89edf64864ada9a6397ef36' crt_time[timestamp without time zone]:'2014-03-25 11:57:02.622989'</font></div><div><font size="2"   >table public.test: INSERT: id[integer]:22 info[text]:'c434ec7f839d1031dc1cb1b75478569d' crt_time[timestamp without time zone]:'2014-03-25 11:57:02.623059'</font></div><div><font size="2"   >table public.test: INSERT: id[integer]:23 info[text]:'bfb079a6e998939db852a8e8bb0dff23' crt_time[timestamp without time zone]:'2014-03-25 11:57:02.62307'</font></div><div><font size="2"   >table public.test: INSERT: id[integer]:24 info[text]:'57e59156860f4644a44637f9103c6563' crt_time[timestamp without time zone]:'2014-03-25 11:57:02.623079'</font></div><div><font size="2"   >table public.test: INSERT: id[integer]:25 info[text]:'e0fdf1d897d828c0f782f93538090217' crt_time[timestamp without time zone]:'2014-03-25 11:57:02.623088'</font></div><div><font size="2"   >table public.test: INSERT: id[integer]:26 info[text]:'e04e24747cb6356a493f257b83769577' crt_time[timestamp without time zone]:'2014-03-25 11:57:02.623097'</font></div><div><font size="2"   >table public.test: INSERT: id[integer]:27 info[text]:'25f75f492daeb16a31e1001c90141c83' crt_time[timestamp without time zone]:'2014-03-25 11:57:02.623106'</font></div><div><font size="2"   >table public.test: INSERT: id[integer]:28 info[text]:'9d825e383331f2caf271980fe1123586' crt_time[timestamp without time zone]:'2014-03-25 11:57:02.623115'</font></div><div><font size="2"   >table public.test: INSERT: id[integer]:29 info[text]:'53472c00ffc4d1e4cfef73402daff0d9' crt_time[timestamp without time zone]:'2014-03-25 11:57:02.623124'</font></div><div><font size="2"   >table public.test: INSERT: id[integer]:30 info[text]:'df19f5b2b81f1430c08a43e053359c81' crt_time[timestamp without time zone]:'2014-03-25 11:57:02.623133'</font></div><div><font size="2"   >COMMIT 1815</font></div></div><p></p></pre></div><div>其他消息举例, 包括更新PK.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# update test set info='new' where id&lt;10;</font></div><div><font size="2"   >UPDATE 9</font></div><div><font size="2"   >digoal=# update test set id=0 where id=1;</font></div><div><font size="2"   >UPDATE 1</font></div></div><div><div><font size="2"   >digoal=# delete from test where id&lt;5;</font></div><div><font size="2"   >DELETE 4</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >BEGIN 1821</font></div><div><font size="2"   >table public.test: UPDATE: id[integer]:1 info[text]:'new' crt_time[timestamp without time zone]:'2014-03-25 11:50:22.891618'</font></div><div><font size="2"   >table public.test: UPDATE: id[integer]:2 info[text]:'new' crt_time[timestamp without time zone]:'2014-03-25 11:50:22.892116'</font></div><div><font size="2"   >table public.test: UPDATE: id[integer]:3 info[text]:'new' crt_time[timestamp without time zone]:'2014-03-25 11:50:22.892134'</font></div><div><font size="2"   >table public.test: UPDATE: id[integer]:4 info[text]:'new' crt_time[timestamp without time zone]:'2014-03-25 11:50:22.892145'</font></div><div><font size="2"   >table public.test: UPDATE: id[integer]:5 info[text]:'new' crt_time[timestamp without time zone]:'2014-03-25 11:50:22.892153'</font></div><div><font size="2"   >table public.test: UPDATE: id[integer]:6 info[text]:'new' crt_time[timestamp without time zone]:'2014-03-25 11:50:22.892162'</font></div><div><font size="2"   >table public.test: UPDATE: id[integer]:7 info[text]:'new' crt_time[timestamp without time zone]:'2014-03-25 11:50:22.892171'</font></div><div><font size="2"   >table public.test: UPDATE: id[integer]:8 info[text]:'new' crt_time[timestamp without time zone]:'2014-03-25 11:50:22.89218'</font></div><div><font size="2"   >table public.test: UPDATE: id[integer]:9 info[text]:'new' crt_time[timestamp without time zone]:'2014-03-25 11:50:22.892189'</font></div><div><font size="2"   >COMMIT 1821</font></div><div><font size="2"   >BEGIN 1822</font></div><div><font size="2"   >table public.test: UPDATE: old-key: id[integer]:1 new-tuple: id[integer]:0 info[text]:'new' crt_time[timestamp without time zone]:'2014-03-25 11:50:22.891618'</font></div><div><font size="2"   >COMMIT 1822</font></div></div><div><div><font size="2"   >BEGIN 1823</font></div><div><font size="2"   >table public.test: DELETE: id[integer]:0</font></div><div><font size="2"   >table public.test: DELETE: id[integer]:2</font></div><div><font size="2"   >table public.test: DELETE: id[integer]:3</font></div><div><font size="2"   >table public.test: DELETE: id[integer]:4</font></div><div><font size="2"   >COMMIT 1823</font></div></div><p></p></pre></div><div><br></div><div><br></div><div>把两个接收消息的客户端断开后, 查看SLOT状态为inactive</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# select * from pg_replication_slots ;</font></div><div><font size="2"   >&nbsp;slot_name | &nbsp; &nbsp;plugin &nbsp; &nbsp; | slot_type | datoid | database | active | xmin | catalog_xmin | restart_lsn&nbsp;</font></div><div><font size="2"   >-----------+---------------+-----------+--------+----------+--------+------+--------------+-------------</font></div><div><font size="2"   >&nbsp;test &nbsp; &nbsp; &nbsp;| test_decoding | logical &nbsp; | &nbsp;16384 | digoal &nbsp; | f &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 1817 | 0/19F4FF0</font></div><div><font size="2"   >&nbsp;test1 &nbsp; &nbsp; | test_decoding | logical &nbsp; | &nbsp;16384 | digoal &nbsp; | f &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 1816 | 0/19F3C50</font></div><div><font size="2"   >(2 rows)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal=# insert into test select generate_series(41,400000),md5(random()::text),clock_timestamp();</font></div><div><font size="2"   >INSERT 0 399960</font></div><div><font size="2"   >digoal=# select * from pg_replication_slots ;</font></div><div><font size="2"   >&nbsp;slot_name | &nbsp; &nbsp;plugin &nbsp; &nbsp; | slot_type | datoid | database | active | xmin | catalog_xmin | restart_lsn&nbsp;</font></div><div><font size="2"   >-----------+---------------+-----------+--------+----------+--------+------+--------------+-------------</font></div><div><font size="2"   >&nbsp;test &nbsp; &nbsp; &nbsp;| test_decoding | logical &nbsp; | &nbsp;16384 | digoal &nbsp; | f &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 1817 | 0/19F4FF0</font></div><div><font size="2"   >&nbsp;test1 &nbsp; &nbsp; | test_decoding | logical &nbsp; | &nbsp;16384 | digoal &nbsp; | f &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 1816 | 0/19F3C50</font></div><div><font size="2"   >(2 rows)</font></div></div><p></p></pre></div><div><br></div><div>restart_lsn记录了消息被接收的XLOG的最后位置. 所以checkpoint不会自动删除这个XLOG, 也就是说, 如果这个slot一直没有被drop掉, 并且以后也不来消费的话, 问题会很严重.</div><div>例如刚才断开之后, 产生了70MB日志, 这些日志不能被重复利用, 所以如果不把这两个slot删除或者接受掉这些消息的话, 会导致pg_xlog膨胀 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select *,pg_xlog_location_diff(pg_current_xlog_insert_location(),restart_lsn)/1024/1024 from pg_replication_slots ;</font></div><div><font size="2"   >&nbsp;slot_name | &nbsp; &nbsp;plugin &nbsp; &nbsp; | slot_type | datoid | database | active | xmin | catalog_xmin | restart_lsn | &nbsp; &nbsp; &nbsp;?column? &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----------+---------------+-----------+--------+----------+--------+------+--------------+-------------+---------------------</font></div><div><font size="2"   >&nbsp;test &nbsp; &nbsp; &nbsp;| test_decoding | logical &nbsp; | &nbsp;16384 | digoal &nbsp; | f &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 1817 | 0/19F4FF0 &nbsp; | 70.9814147949218750</font></div><div><font size="2"   >&nbsp;test1 &nbsp; &nbsp; | test_decoding | logical &nbsp; | &nbsp;16384 | digoal &nbsp; | f &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 1816 | 0/19F3C50 &nbsp; | 70.9862060546875000</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div>一直膨胀</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# insert into test select generate_series(400001,1000000),md5(random()::text),clock_timestamp();</font></div><div><font size="2"   >INSERT 0 600000</font></div><div><font size="2"   >digoal=# select *,pg_xlog_location_diff(pg_current_xlog_insert_location(),restart_lsn)/1024/1024 from pg_replication_slots ;</font></div><div><font size="2"   >&nbsp;slot_name | &nbsp; &nbsp;plugin &nbsp; &nbsp; | slot_type | datoid | database | active | xmin | catalog_xmin | restart_lsn | &nbsp; &nbsp; &nbsp; ?column? &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----------+---------------+-----------+--------+----------+--------+------+--------------+-------------+----------------------</font></div><div><font size="2"   >&nbsp;test &nbsp; &nbsp; &nbsp;| test_decoding | logical &nbsp; | &nbsp;16384 | digoal &nbsp; | f &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 1817 | 0/19F4FF0 &nbsp; | 177.4674835205078125</font></div><div><font size="2"   >&nbsp;test1 &nbsp; &nbsp; | test_decoding | logical &nbsp; | &nbsp;16384 | digoal &nbsp; | f &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 1816 | 0/19F3C50 &nbsp; | 177.4722747802734375</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div>消息是按事务接收的, 如果事务产生的消息非常巨大, 在接收完这个事务的消息前, restart_lsn不会被更新.</div><div><br></div><div>删除slot</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select pg_drop_replication_slot('test');</font></div><div><font size="2"   >&nbsp;pg_drop_replication_slot&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select pg_drop_replication_slot('test1');</font></div><div><font size="2"   >&nbsp;pg_drop_replication_slot&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=b89e151054a05f0f6d356ca52e3b725dd0505e53"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=b89e151054a05f0f6d356ca52e3b725dd0505e53</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/logicaldecoding.html"   >http://www.postgresql.org/docs/devel/static/logicaldecoding.html</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/sql-altertable.html#SQL-CREATETABLE-REPLICA-IDENTITY"   >http://www.postgresql.org/docs/devel/static/sql-altertable.html#SQL-CREATETABLE-REPLICA-IDENTITY</a></div><div>4.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/protocol-replication.html"   >http://www.postgresql.org/docs/devel/static/protocol-replication.html</a></div><div>5.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/runtime-config-wal.html#GUC-WAL-LEVEL"   >http://www.postgresql.org/docs/devel/static/runtime-config-wal.html#GUC-WAL-LEVEL</a></div><div>6.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/runtime-config-replication.html#GUC-MAX-REPLICATION-SLOTS"   >http://www.postgresql.org/docs/devel/static/runtime-config-replication.html#GUC-MAX-REPLICATION-SLOTS</a></div><div>7.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/functions-admin.html#FUNCTIONS-REPLICATION"   >http://www.postgresql.org/docs/devel/static/functions-admin.html#FUNCTIONS-REPLICATION</a></div><div>8.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/app-pgrecvlogical.html"   >http://www.postgresql.org/docs/devel/static/app-pgrecvlogical.html</a></div><div>9.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/catalog-pg-replication-slots.html"   >http://www.postgresql.org/docs/devel/static/catalog-pg-replication-slots.html</a></div><div>10.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/monitoring-stats.html#MONITORING-STATS-VIEWS-TABLE"   >http://www.postgresql.org/docs/devel/static/monitoring-stats.html#MONITORING-STATS-VIEWS-TABLE</a></div><div>11.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/test-decoding.html"   >http://www.postgresql.org/docs/devel/static/test-decoding.html</a></div><div>12.&nbsp;src/backend/replication/logical/logicalfuncs.c</div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL 9.4 Logical decoding - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>