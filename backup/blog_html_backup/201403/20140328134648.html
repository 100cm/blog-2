<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL pg_bulkload speed test</h2>
	<h5 id="">2014-03-28 13:46:48&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201422883734398/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>我以前写过一篇BLOG关于如何提高PostgreSQL的导入速度, 如提高写入并行度, 加大block size. 关闭autovacuum, 使用unlogged table不写wal, 开启异步wal提交等手段.</div><div><a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201392641033482"   >http://blog.163.com/digoal@126/blog/static/163877040201392641033482</a></div><div><br></div><div>其实还有一种手段, 就是绕过shared buffer, 直接写文件, 这种模式同unlogged table一样, 不需要写wal, 所以也是比较危险的操作.&nbsp;</div><div>pg_bulkload的direct模式就是这种思路来实现的, 它还包含了数据恢复功能, 即导入失败的话, 需要恢复.</div><div><br></div><div>本文将对比一下传统的数据导入和使用pg_bulkload数据导入的速度差别.</div><div>1. 使用普通的copy模式导入<span style="line-height: 28px;"   >unlogged table</span><span style="line-height: 28px;"   >.</span></div><div><span style="line-height: 28px;"   >2.&nbsp;</span><span style="line-height: 28px;"   >使用普通的copy模式导入</span><span style="line-height: 28px;"   >logged table</span><span style="line-height: 28px;"   >.</span></div><div>3. 使用pg_bulkload导入unlogged table.</div><div>4.&nbsp;<span style="line-height: 28px;"   >使用pg_bulkload导入logged table.</span></div><div><span style="line-height: 28px;"   >测试环境如下 :&nbsp;</span></div><div>数据库编译参数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; pg_config |grep CONFIG</font></div><div><font size="2"   >CONFIGURE = '--prefix=/home/pg93/pgsql9.3.3' '--with-pgport=1922' '--with-perl' '--with-tcl' '--with-python' '--with-openssl' '--with-pam' '--without-ldap' '--with-libxml' '--with-libxslt' '--enable-thread-safety' '--with-wal-blocksize=64' '--with-blocksize=32' '--enable-dtrace' '--enable-debug' '--enable-cassert'</font></div><p></p></pre></div><div>数据库配置 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >listen_addresses = '0.0.0.0' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# what IP address(es) to listen on;</font></div><div><font size="2"   >port = 1921 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >max_connections = 100 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >superuser_reserved_connections = 3 &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   >unix_socket_directories = '.' &nbsp; # comma-separated list of directories</font></div><div><font size="2"   >unix_socket_permissions = 0700 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# begin with 0 to use octal notation</font></div><div><font size="2"   >tcp_keepalives_idle = 60 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPIDLE, in seconds;</font></div><div><font size="2"   >tcp_keepalives_interval = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# TCP_KEEPINTVL, in seconds;</font></div><div><font size="2"   >tcp_keepalives_count = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # TCP_KEEPCNT;</font></div><div><font size="2"   >shared_buffers = 4096MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 128kB</font></div><div><font size="2"   >maintenance_work_mem = 512MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# min 1MB</font></div><div><font size="2"   >shared_preload_libraries = 'pg_stat_statements' &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >vacuum_cost_delay = 10 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# 0-100 milliseconds</font></div><div><font size="2"   >vacuum_cost_limit = 10000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 credits</font></div><div><font size="2"   >bgwriter_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # 10-10000ms between rounds</font></div><div><font size="2"   >wal_level = hot_standby &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # minimal, archive, or hot_standby</font></div><div><font size="2"   >synchronous_commit = off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# synchronization level;</font></div><div><font size="2"   >wal_buffers = 16MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# min 32kB, -1 sets based on shared_buffers</font></div><div><font size="2"   >wal_writer_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 milliseconds</font></div><div><font size="2"   >checkpoint_segments = 512 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # in logfile segments, min 1, 16MB each</font></div><div><font size="2"   >archive_mode = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # allows archiving to be done</font></div><div><font size="2"   >archive_command = '/bin/date' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # command to use to archive a logfile segment</font></div><div><font size="2"   >max_wal_senders = 32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# max number of walsender processes</font></div><div><font size="2"   >hot_standby = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# "on" allows queries during recovery</font></div><div><font size="2"   >wal_receiver_status_interval = 1s &nbsp; &nbsp; &nbsp; # send replies at least this often</font></div><div><font size="2"   >hot_standby_feedback = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # send info from standby to prevent</font></div><div><font size="2"   >random_page_cost = 2.0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# same scale as above</font></div><div><font size="2"   >effective_cache_size = 96GB</font></div><div><font size="2"   >log_destination = 'csvlog' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Valid values are combinations of</font></div><div><font size="2"   >logging_collector = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Enable capturing of stderr and csvlog</font></div><div><font size="2"   >log_directory = 'pg_log' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# directory where log files are written,</font></div><div><font size="2"   >log_truncate_on_rotation = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # If on, an existing log file with the</font></div><div><font size="2"   >log_min_messages = log &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# values in order of decreasing detail:</font></div><div><font size="2"   >log_checkpoints = on</font></div><div><font size="2"   >log_connections = on</font></div><div><font size="2"   >log_disconnections = on</font></div><div><font size="2"   >log_error_verbosity = verbose &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # terse, default, or verbose messages</font></div><div><font size="2"   >log_lock_waits = on &nbsp; # log lock waits &gt;= deadlock_timeout</font></div><div><font size="2"   >log_statement = 'ddl' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # none, ddl, mod, all</font></div><div><font size="2"   >log_timezone = 'PRC'</font></div><div><font size="2"   >track_activities = on</font></div><div><font size="2"   >track_counts = on</font></div><div><font size="2"   >track_functions = all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # none, pl, all</font></div><div><font size="2"   >track_activity_query_size = 1024 &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   >autovacuum = off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Enable autovacuum subprocess? &nbsp;'on'</font></div><div><font size="2"   >log_autovacuum_min_duration = 0 # -1 disables, 0 logs all actions and</font></div><div><font size="2"   >autovacuum_naptime = 3s &nbsp; &nbsp; &nbsp; &nbsp; # time between autovacuum runs</font></div><div><font size="2"   >autovacuum_vacuum_scale_factor = 0.0002 # fraction of table size before vacuum</font></div><div><font size="2"   >autovacuum_analyze_scale_factor = 0.0001 &nbsp; &nbsp; &nbsp; &nbsp;# fraction of table size before analyze</font></div><div><font size="2"   >datestyle = 'iso, mdy'</font></div><div><font size="2"   >timezone = 'PRC'</font></div><div><font size="2"   >lc_messages = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for system error message</font></div><div><font size="2"   >lc_monetary = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for monetary formatting</font></div><div><font size="2"   >lc_numeric = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for number formatting</font></div><div><font size="2"   >lc_time = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for time formatting</font></div><div><font size="2"   >default_text_search_config = 'pg_catalog.english'</font></div><div><font size="2"   >pg_stat_statements.max = 1000</font></div><div><font size="2"   >pg_stat_statements.track = all</font></div><p></p></pre></div><div>数据库列表以及collection :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; psql</font></div><div><font size="2"   >psql (9.3.3)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# \l</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of databases</font></div><div><font size="2"   >&nbsp; &nbsp;Name &nbsp; &nbsp;| &nbsp;Owner &nbsp; | Encoding | Collate | Ctype | &nbsp; Access privileges &nbsp;&nbsp;</font></div><div><font size="2"   >-----------+----------+----------+---------+-------+-----------------------</font></div><div><font size="2"   >&nbsp;digoal &nbsp; &nbsp;| postgres | UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;postgres &nbsp;| postgres | UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;stats &nbsp; &nbsp; | postgres | UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; | =Tc/postgres &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | postgres=CTc/postgres+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | stats=CTc/postgres</font></div><div><font size="2"   >&nbsp;statsrepo | postgres | UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;template0 | postgres | UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; | =c/postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | postgres=CTc/postgres</font></div><div><font size="2"   >&nbsp;template1 | postgres | UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; | =c/postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | postgres=CTc/postgres</font></div><div><font size="2"   >(6 rows)</font></div><p></p></pre></div><div>生成<span style="line-height: 28px;"   >5000万条</span><span style="line-height: 28px;"   >测试数据.</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# create table test(id int primary key, info text, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# insert into test select generate_series(1,50000000),md5(random()::text),clock_timestamp();</font></div></div><div><font size="2"   >INSERT 0 50000000</font></div><div><div><font size="2"   >digoal=# \dt+ test</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of relations</font></div><div><font size="2"   >&nbsp;Schema | Name | Type &nbsp;| &nbsp;Owner &nbsp; | &nbsp;Size &nbsp; | Description&nbsp;</font></div><div><font size="2"   >--------+------+-------+----------+---------+-------------</font></div><div><font size="2"   >&nbsp;public | test | table | postgres | 3634 MB |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# \di+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of relations</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; Name &nbsp; &nbsp;| Type &nbsp;| &nbsp;Owner &nbsp; | Table | &nbsp;Size &nbsp; | Description&nbsp;</font></div><div><font size="2"   >--------+-----------+-------+----------+-------+---------+-------------</font></div><div><font size="2"   >&nbsp;public | test_pkey | index | postgres | test &nbsp;| 1063 MB |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>导出到csv文件</div><div><pre class="prettyprint"   ><p><font size="2"   >digoal=# copy test to '/ssd3/pg93/test.dmp' with (format csv, delimiter ',', null '\N', quote '"', force_quote *) ;</font></p></pre></div><div><div>使用copy导入数据的测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# truncate test;</font></div><div><font size="2"   >TRUNCATE TABLE</font></div></div><div><span style="line-height: 28px;"   ><font size="2"   >digoal=# \timing</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >使用copy导入数据</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   ><div>digoal=# copy test from '/ssd3/pg93/test.dmp' with (format csv, delimiter ',', null '\N', quote '"');</div><div>COPY 50000000</div></font></span></div><div><font size="2"   >Time: 411245.879 ms</font></div><p></p></pre></div></div><div>改为unlogged table重新测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# update pg_class set relpersistence='u' where relname='test';</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >digoal=# update pg_class set relpersistence='u' where relname='test_pkey';</font></div><div><font size="2"   >UPDATE 1</font></div></div><div><font size="2"   >使用copy导入数据</font></div><div><div><font size="2"   >digoal=# copy test from '/ssd3/pg93/test.dmp' with (format csv, delimiter ',', null '\N', quote '"');</font></div><div><font size="2"   >COPY 50000000</font></div><div><font size="2"   >Time: 363699.466 ms</font></div></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >接下来要试一下使用pg_bulkload绕过shared buffer导入数据.</span></div><div><span style="line-height: 28px;"   >首先要按照pg_bulkload.</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >wget&nbsp;http://pgfoundry.org/frs/download.php/3566/pg_bulkload-3.1.5.tar.gz</font></span></div><div><div style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-150 ~]# export PATH=/home/pg93/pgsql9.3.3/bin:$PATH</font></div><div style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-150 ~]# cd /opt/soft_bak/pg_bulkload-3.1.5</font></div><div style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-150 pg_bulkload-3.1.5]# which pg_config</font></div><div style="line-height: 28px;"   ><font size="2"   >/home/pg93/pgsql9.3.3/bin/pg_config</font></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-150 pg_bulkload-3.1.5]# make</font></span></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-150 pg_bulkload-3.1.5]# make install</font></span></div></div><p></p></pre></div><div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><br></span></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >清除test表的数据, 创建pg_bulkload extension.</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg93@db-172-16-3-150-&gt; psql</font></div><div><font size="2"   >psql (9.3.3)</font></div><div><font size="2"   >Type "help" for help.</font></div></div><div><div><font size="2"   >digoal=# truncate test;</font></div><div><font size="2"   >TRUNCATE TABLE</font></div></div><div><font size="2"   >digoal=# create extension pg_bulkload;</font></div><div><font size="2"   >digoal=# update pg_class set relpersistence ='p' where relname='test_pkey';<br>UPDATE 1<br>digoal=# update pg_class set relpersistence ='p' where relname='test';<br>UPDATE 1</font></div><p></p></pre></div></div><div>使用postgresql启动数据库 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; postgresql stop -m fast</font></div><div><font size="2"   >waiting for server to shut down..... done</font></div><div><font size="2"   >server stopped</font></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; postgresql start</font></div><div><font size="2"   >server starting</font></div><p></p></pre></div><div>注意, pg_bulkload默认连接/tmp socket, 如果配置了其他sock, 必须改为/tmp或者添加/tmp的unix sock 监听.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; pg_bulkload -i /ssd3/pg93/test.dmp -O test -l /ssd3/test.log -o "TYPE=CSV" -o "WRITER=PARALLEL" -h $PGDATA -p $PGPORT -d $PGDATABASE</font></div><div><font size="2"   >NOTICE: BULK LOAD START</font></div><div><font size="2"   >ERROR: query failed: ERROR: &nbsp;could not establish connection to parallel writer</font></div><div><font size="2"   >DETAIL: &nbsp;could not connect to server: No such file or directory</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Is the server running locally and accepting</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; connections on Unix domain socket "/tmp/.s.PGSQL.1921"?</font></div><div><font size="2"   >HINT: &nbsp;Refer to the following if it is an authentication error. &nbsp;Specifies the authentication method to without the need for a password in pg_hba.conf (ex. trust or ident), or specify the password to the password file of the operating system user who ran PostgreSQL server. &nbsp;If cannot use these solution, specify WRITER=DIRECT.</font></div><div><font size="2"   >DETAIL: query was: SELECT * FROM pg_bulkload($1)</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >修改unix socket目录 , 增加 /tmp. 使用pg_bulkload 提供的postgresql脚本重启数据库.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi $PGDATA/postgresql.conf</font></div><div><font size="2"   >unix_socket_directories = '.,/tmp'</font></div><div><div><font size="2"   >pg93@db-172-16-3-150-&gt; postgresql restart -m fast</font></div><div><font size="2"   >waiting for server to shut down.... done</font></div><div><font size="2"   >server stopped</font></div><div><font size="2"   >server starting</font></div></div><p></p></pre></div><div>重新执行pg_bulkload.</div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg_bulkload -i /ssd3/pg93/test.dmp -O test -l /ssd3/pg93/test.log -o "TYPE=CSV" -o "WRITER=PARALLEL" -h $PGDATA -p $PGPORT -d $PGDATABASE</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >在执行过程中我们看到$PGDATA多了一个目录pg_bulkload, 存储加载数据的状态信息, 如果导入过程中发生异常, 使用postgresql脚本重启数据库时将自动修复. 或者在使用pg_ctl启动数据库前先使用pg_bulkload修复.</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >pg93@db-172-16-3-150-&gt; cd $PGDATA</font></span></div><div><div><font size="2"   >pg93@db-172-16-3-150-&gt; ll pg_bulkload/</font></div><div><font size="2"   >total 4.0K</font></div><div><font size="2"   >-rw------- 1 pg93 pg93 512 Mar 28 09:36 16384.34315.loadstatus</font></div></div><p></p></pre></div><div>日志 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 pg93]# cat test.log</font></div><div><font size="2"   ><span style="line-height: 21px;"   >pg_bulkload 3.1.5 on 2014-03-28 13:32:31.32559+08<br><br>INPUT = /ssd3/pg93/test.dmp<br>PARSE_BADFILE = /ssd4/pg93/pg_root/pg_bulkload/20140328133231_digoal_public_test.prs.dmp<br>LOGFILE = /ssd3/pg93/test.log<br>LIMIT = INFINITE<br>PARSE_ERRORS = 0<br>CHECK_CONSTRAINTS = NO<br>TYPE = CSV<br>SKIP = 0<br>DELIMITER = ,<br>QUOTE = "\""<br>ESCAPE = "\""<br>NULL = <br>OUTPUT = public.test<br>MULTI_PROCESS = YES<br>VERBOSE = NO<br>WRITER = DIRECT<br>DUPLICATE_BADFILE = /ssd4/pg93/pg_root/pg_bulkload/20140328133231_digoal_public_test.dup.csv<br>DUPLICATE_ERRORS = 0<br>ON_DUPLICATE_KEEP = NEW<br>TRUNCATE = NO<br><br><br>  0 Rows skipped.<br>  50000000 Rows successfully loaded.<br>  0 Rows not loaded due to parse errors.<br>  0 Rows not loaded due to duplicate errors.<br>  0 Rows replaced with new rows.<br><br>Run began on 2014-03-28 13:32:31.32559+08<br>Run ended on 2014-03-28 13:35:13.019018+08<br><br>CPU 1.55s/128.55u sec elapsed 161.69 sec</span></font></div><p></p></pre></div><div>使用pg_bulkload的direct 和 multi process模式(即parallel)导入数据总耗时161秒. &nbsp;相比普通的copy logged table 411秒快了一倍多.</div><div><br></div><div>改为unlogged table, 使用pg_bulkload重新测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# update pg_class set relpersistence ='u' where relname='test';</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >digoal=# update pg_class set relpersistence ='u' where relname='test_pkey';</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >digoal=# truncate test;</font></div><div><font size="2"   >TRUNCATE TABLE</font></div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div></div><div><font size="2"   >$ pg_bulkload -i /ssd3/pg93/test.dmp -O test -l /ssd3/pg93/test.log -o "TYPE=CSV" -o "WRITER=PARALLEL" -h $PGDATA -p $PGPORT -d $PGDATABASE</font></div><div><div><font size="2"   >pg_bulkload 3.1.5 on 2014-03-28 13:36:15.602787+08</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >INPUT = /ssd3/pg93/test.dmp</font></div><div><font size="2"   >PARSE_BADFILE = /ssd4/pg93/pg_root/pg_bulkload/20140328133615_digoal_public_test.prs.dmp</font></div><div><font size="2"   >LOGFILE = /ssd3/pg93/test.log</font></div><div><font size="2"   >LIMIT = INFINITE</font></div><div><font size="2"   >PARSE_ERRORS = 0</font></div><div><font size="2"   >CHECK_CONSTRAINTS = NO</font></div><div><font size="2"   >TYPE = CSV</font></div><div><font size="2"   >SKIP = 0</font></div><div><font size="2"   >DELIMITER = ,</font></div><div><font size="2"   >QUOTE = "\""</font></div><div><font size="2"   >ESCAPE = "\""</font></div><div><font size="2"   >NULL =&nbsp;</font></div><div><font size="2"   >OUTPUT = public.test</font></div><div><font size="2"   >MULTI_PROCESS = YES</font></div><div><font size="2"   >VERBOSE = NO</font></div><div><font size="2"   >WRITER = DIRECT</font></div><div><font size="2"   >DUPLICATE_BADFILE = /ssd4/pg93/pg_root/pg_bulkload/20140328133615_digoal_public_test.dup.csv</font></div><div><font size="2"   >DUPLICATE_ERRORS = 0</font></div><div><font size="2"   >ON_DUPLICATE_KEEP = NEW</font></div><div><font size="2"   >TRUNCATE = NO</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; 0 Rows skipped.</font></div><div><font size="2"   >&nbsp; 50000000 Rows successfully loaded.</font></div><div><font size="2"   >&nbsp; 0 Rows not loaded due to parse errors.</font></div><div><font size="2"   >&nbsp; 0 Rows not loaded due to duplicate errors.</font></div><div><font size="2"   >&nbsp; 0 Rows replaced with new rows.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Run began on 2014-03-28 13:36:15.602787+08</font></div><div><font size="2"   >Run ended on 2014-03-28 13:38:57.506558+08</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CPU 2.26s/129.23u sec elapsed 161.90 sec</font></div></div><p></p></pre></div><div><span style="line-height: 28px;"   >导入数据总耗时161秒. &nbsp;相比普通的copy unlogged table 363秒快了一倍多.</span></div><div><span style="line-height: 28px;"   >因为已经绕过了shared buffer, 所以使用pg_bulkload导入目标unlogged和logged表的结果一样.</span></div><div><br></div><div>最后附direct模式的测试结果, (不开multi process). 256秒, 还是比363快.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-150-&gt; pg_bulkload -i /ssd3/pg93/test.dmp -O test -l /ssd3/pg93/test.log -o "TYPE=CSV" -o "WRITER=DIRECT" -h $PGDATA -p $PGPORT -d $PGDATABASE</font></div><div><div><font size="2"   >pg_bulkload 3.1.5 on 2014-03-28 13:41:10.934578+08</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >INPUT = /ssd3/pg93/test.dmp</font></div><div><font size="2"   >PARSE_BADFILE = /ssd4/pg93/pg_root/pg_bulkload/20140328134110_digoal_public_test.prs.dmp</font></div><div><font size="2"   >LOGFILE = /ssd3/pg93/test.log</font></div><div><font size="2"   >LIMIT = INFINITE</font></div><div><font size="2"   >PARSE_ERRORS = 0</font></div><div><font size="2"   >CHECK_CONSTRAINTS = NO</font></div><div><font size="2"   >TYPE = CSV</font></div><div><font size="2"   >SKIP = 0</font></div><div><font size="2"   >DELIMITER = ,</font></div><div><font size="2"   >QUOTE = "\""</font></div><div><font size="2"   >ESCAPE = "\""</font></div><div><font size="2"   >NULL =&nbsp;</font></div><div><font size="2"   >OUTPUT = public.test</font></div><div><font size="2"   >MULTI_PROCESS = NO</font></div><div><font size="2"   >VERBOSE = NO</font></div><div><font size="2"   >WRITER = DIRECT</font></div><div><font size="2"   >DUPLICATE_BADFILE = /ssd4/pg93/pg_root/pg_bulkload/20140328134110_digoal_public_test.dup.csv</font></div><div><font size="2"   >DUPLICATE_ERRORS = 0</font></div><div><font size="2"   >ON_DUPLICATE_KEEP = NEW</font></div><div><font size="2"   >TRUNCATE = NO</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; 0 Rows skipped.</font></div><div><font size="2"   >&nbsp; 49999998 Rows successfully loaded.</font></div><div><font size="2"   >&nbsp; 0 Rows not loaded due to parse errors.</font></div><div><font size="2"   >&nbsp; 0 Rows not loaded due to duplicate errors.</font></div><div><font size="2"   >&nbsp; 0 Rows replaced with new rows.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Run began on 2014-03-28 13:41:10.934578+08</font></div><div><font size="2"   >Run ended on 2014-03-28 13:45:27.007941+08</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CPU 10.68s/243.64u sec elapsed 256.07 sec</font></div></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >[参考]</span></div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201392641033482"   >http://blog.163.com/digoal@126/blog/static/163877040201392641033482</a></div><div>2.&nbsp;<a target="_blank" rel="nofollow" href="http://pgbulkload.projects.pgfoundry.org/pg_bulkload.html"   >http://pgbulkload.projects.pgfoundry.org/pg_bulkload.html</a><br><wbr><div><br></div></div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">Cutis_Dow - 2015-02-01 17:51:43</h5>
				<div><div style=""  ><span class="com"  style=""  >lc_messages = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for system error message</span></div><div style=""  ><span class="com"  style=""  >lc_monetary = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for monetary formatting</span></div><div style=""  ><span class="com"  style=""  >lc_numeric = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for number formatting</span></div><div style=""  ><span class="com"  style=""  >lc_time = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for time formatting</span></div><div style=""  ><span class="com"  style=""  >这几个设置很多人都是en_US.utf,你改成C是什么意思</span></div></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 Cutis_Dow - 2015-02-01 17:51:43</h5>
				<div style="width:600px;">这个看你初始化数据库时的选择initdb --locale=C<div>这里就会是C.</div></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 Cutis_Dow - 2015-02-01 17:51:43</h5>
				<div style="width:600px;">当然, 你可以在QUERY时指定locale, 包括字段也可以修改locale.<div>和排序, 是否使用索引等有关, 索引也可以有索引的locale.</div><div>看你的使用习惯和数据.</div></div>
			</div>
	</div>
</div>
</body>
</html>