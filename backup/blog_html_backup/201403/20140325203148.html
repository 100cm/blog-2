<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.4 use Linux hugepage reduce overhead when using large contiguous chunks of memory</h2>
	<h5 id="">2014-03-25 20:31:48&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201422552837964/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL 9.4支持使用Linux hugepage降低大内存管理的开销.&nbsp;</div><div>配置方法如下, 以CentOS 6.4 x64为例,&nbsp;<span style="line-height: 28px;"   >首先要确保操作系统内核打开了如下项目.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# cat /usr/src/kernels/`uname -r`/.config|grep HUG</font></div><div><font size="2"   >CONFIG_TRANSPARENT_HUGEPAGE=y</font></div><div><font size="2"   >CONFIG_HUGETLBFS=y</font></div><div><font size="2"   >CONFIG_HUGETLB_PAGE=y</font></div><p></p></pre></div><div>查看内存信息 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# cat /proc/meminfo&nbsp;</font></div><div><font size="2"   >MemTotal: &nbsp; &nbsp; &nbsp; 99055100 kB</font></div><div><div><font size="2"   >AnonHugePages: &nbsp; &nbsp; 38912 kB</font></div><div><font size="2"   >HugePages_Total: &nbsp; 10240</font></div><div><font size="2"   >HugePages_Free: &nbsp; &nbsp;10240</font></div><div><font size="2"   >HugePages_Rsvd: &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >HugePages_Surp: &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >Hugepagesize: &nbsp; &nbsp; &nbsp; 2048 kB</font></div></div><p></p></pre></div><div><span style="line-height: 28px;"   >配置数据库参数,&nbsp;</span><span style="line-height: 28px;"   >huge_pages</span><span style="line-height: 28px;"   >&nbsp;默认为 try, 表示尝试使用hugepage, 如果失败则使用原来的内存管理方式, 我们先使用off模式启动, 得到数据库启动后的内存大小 :&nbsp;</span></div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >pg94@db-172-16-3-150-&gt; grep "^[a-z]" postgresql.conf&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >listen_addresses = '0.0.0.0' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# what IP address(es) to listen on;</font></div><div style="line-height: 28px;"   ><font size="2"   >max_connections = 100 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div style="line-height: 28px;"   ><font size="2"   >unix_socket_directories = '.' &nbsp; # comma-separated list of directories</font></div><div style="line-height: 28px;"   ><font size="2"   >shared_buffers = 19200MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# min 128kB</font></div><div style="line-height: 28px;"   ><font size="2"   >huge_pages = off &nbsp; &nbsp;# on, off, or try</font></div><div style="line-height: 28px;"   ><font size="2"   >maintenance_work_mem = 512MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# min 1MB</font></div><div style="line-height: 28px;"   ><font size="2"   >dynamic_shared_memory_type = posix # the default is the first option</font></div><div style="line-height: 28px;"   ><font size="2"   >bgwriter_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # 10-10000ms between rounds</font></div><div style="line-height: 28px;"   ><font size="2"   >max_worker_processes = 8</font></div><div style="line-height: 28px;"   ><font size="2"   >wal_level = logical &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # minimal, archive, hot_standby or logical</font></div><div style="line-height: 28px;"   ><font size="2"   >synchronous_commit = off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# synchronization level;</font></div><div style="line-height: 28px;"   ><font size="2"   >wal_writer_delay = 10ms &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 milliseconds</font></div><div style="line-height: 28px;"   ><font size="2"   >checkpoint_segments = 512 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # in logfile segments, min 1, 16MB each</font></div><div style="line-height: 28px;"   ><font size="2"   >max_wal_senders = 32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# max number of walsender processes</font></div><div style="line-height: 28px;"   ><font size="2"   >max_replication_slots = 32 &nbsp; &nbsp; &nbsp;# max number of replication slots.</font></div><div style="line-height: 28px;"   ><font size="2"   >log_destination = 'csvlog' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Valid values are combinations of</font></div><div style="line-height: 28px;"   ><font size="2"   >logging_collector = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Enable capturing of stderr and csvlog</font></div><div style="line-height: 28px;"   ><font size="2"   >log_error_verbosity = verbose &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # terse, default, or verbose messages</font></div><div style="line-height: 28px;"   ><font size="2"   >log_timezone = 'PRC'</font></div><div style="line-height: 28px;"   ><font size="2"   >autovacuum = off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Enable autovacuum subprocess? &nbsp;'on'</font></div><div style="line-height: 28px;"   ><font size="2"   >datestyle = 'iso, mdy'</font></div><div style="line-height: 28px;"   ><font size="2"   >timezone = 'PRC'</font></div><div style="line-height: 28px;"   ><font size="2"   >lc_messages = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for system error message</font></div><div style="line-height: 28px;"   ><font size="2"   >lc_monetary = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for monetary formatting</font></div><div style="line-height: 28px;"   ><font size="2"   >lc_numeric = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for number formatting</font></div><div style="line-height: 28px;"   ><font size="2"   >lc_time = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for time formatting</font></div><div style="line-height: 28px;"   ><font size="2"   >default_text_search_config = 'pg_catalog.english'</font></div><p></p></pre></div><div style="line-height: 28px;"   >查看数据库主进程的状态信息.</div><div style="line-height: 28px;"   ><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg94@db-172-16-3-150-&gt; cat $PGDATA/postmaster.pid&nbsp;</font></div><div><font size="2"   >2811</font></div><div><font size="2"   >/ssd2/pg94/pg_root</font></div><div><font size="2"   >1395750231</font></div><div><font size="2"   >1933</font></div><div><font size="2"   >.</font></div><div><font size="2"   >0.0.0.0</font></div><div><font size="2"   >&nbsp; 1933001 &nbsp; &nbsp; 32769</font></div><p></p></pre></div><div>2811即数据库主进程ID, 查看它的VmPeak.</div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg94@db-172-16-3-150-&gt; cat /proc/2811/status&nbsp;</font></div><div><font size="2"   >VmPeak: 19965204 kB</font></div><p></p></pre></div><div>这个就是内存峰值, 我们只要确保可用的hugepage总数比这个多就可以了.</div><div>从/proc/meminfo得知<span style="line-height: 28px;"   >Hugepagesize=2MB, 所以</span><span style="line-height: 28px;"   >19965204/2/1024 =&nbsp;</span>9748, 只要<span style="line-height: 28px;"   >nr_hugepages</span><span style="line-height: 28px;"   >比这个大就可以了.</span></div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >sysctl -w&nbsp;<span style="line-height: 28px;"   >vm.nr_hugepages=10240</span></font></div><div style="line-height: 28px;"   ></div><p></p></pre></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >接下来我们把</span><span style="line-height: 28px;"   >huge_pages</span><span style="line-height: 28px;"   >&nbsp;</span><span style="line-height: 28px;"   >改成on, 那么将强制使用hugepage, 如果内存分配失败则无法启动数据库</span><span style="line-height: 28px;"   >&nbsp;:</span></div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >vi $PGDATA/postgresql.conf</font></span></div><div style="line-height: 28px;"   ><font size="2"   ><span style="line-height: 28px;"   >huge_pages</span><span style="line-height: 28px;"   >&nbsp;= on</span></font></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >pg_ctl restart -m fast</font></span></div><p></p></pre></div></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><br></span></div><div>查看hugepage参数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# sysctl -a|grep huge</font></div><div><font size="2"   >vm.nr_hugepages = 10240</font></div><div><font size="2"   >vm.nr_hugepages_mempolicy = 10240</font></div><div><font size="2"   >vm.hugetlb_shm_group = 0</font></div><div><font size="2"   >vm.hugepages_treat_as_movable = 0</font></div><div><font size="2"   >vm.nr_overcommit_hugepages = 0</font></div><p></p></pre></div><div><br></div><div>把hugepage的配额写到sysctl.conf, 下次启动系统后将使用这个配置.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi /etc/sysctl.conf</font></div><div><font size="2"   >vm.nr_hugepages=10240</font></div><p></p></pre></div><div><br></div><div>测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >psql</font></div><div><font size="2"   >create table test(id int, info text, crt_time timestamp);</font></div><div><font size="2"   >insert into test select generate_series(1,1000000000),'test',now();</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >数据库使用过程中, 要用到内存时, 从hugepage中分配, 现在已经使用了一些.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# cat /proc/meminfo |grep Huge</font></div><div><font size="2"   >AnonHugePages: &nbsp; &nbsp; 40960 kB</font></div><div><font size="2"   >HugePages_Total: &nbsp; 10240</font></div><div><font size="2"   >HugePages_Free: &nbsp; &nbsp; 7681</font></div><div><font size="2"   >HugePages_Rsvd: &nbsp; &nbsp; 7113</font></div><div><font size="2"   >HugePages_Surp: &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >Hugepagesize: &nbsp; &nbsp; &nbsp; 2048 kB</font></div><p></p></pre></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >[参考]</span></div><wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/runtime-config-resource.html#RUNTIME-CONFIG-RESOURCE-MEMORY"   >http://www.postgresql.org/docs/devel/static/runtime-config-resource.html#RUNTIME-CONFIG-RESOURCE-MEMORY</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/kernel-resources.html#LINUX-HUGE-PAGES"   >http://www.postgresql.org/docs/devel/static/kernel-resources.html#LINUX-HUGE-PAGES</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://www.kernel.org/doc/Documentation/vm/hugetlbpage.txt"   >https://www.kernel.org/doc/Documentation/vm/hugetlbpage.txt</a></div><div>4.&nbsp;/usr/src/kernels/`uname -r`/.config</div><div>5.&nbsp;/proc/$postmasterPID/status</div><div>6. /proc/meminfo</div></div>
	</div>
</div>
</body>
</html>