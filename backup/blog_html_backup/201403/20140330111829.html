<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 58P01 error after use "alter table alter column" extened varchar(n) to varchar</h2>
	<h5 id="">2014-03-30 11:18:29&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402014230102714214/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>前几天francs维护数据库的时候碰到的一个问题, 在对单表执行完一批将varchar(n)类型扩展为varchar类型后出现查询表报filenode不存在的错误.</div>PostgreSQL 9.2.4版本, 表大概有几十个类型, 头尾为定长INT类型, 中间大量的varchar(n), 没有not null约束.<div><wbr><div>已有几十万数据, 某些被修改数据类型的字段上有索引.</div><div>执行的操作, 将所有的varchar(n)字段改为varchar, alter table .. alter column .. type varchar;</div><div>执行完操作后, 和这个表相关的所有查询都会报58P01错误, 来自以下代码 :&nbsp;</div><div>src/backend/storage/smgr/md.c</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;mdopen() -- Open the specified relation.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Note we only open the first segment, when there are multiple segments.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* If first segment is not present, either ereport or return NULL according</font></div><div><font size="2"   >&nbsp;* to "behavior". &nbsp;We treat EXTENSION_CREATE the same as EXTENSION_FAIL;</font></div><div><font size="2"   >&nbsp;* EXTENSION_CREATE means it's OK to extend an existing relation, not to</font></div><div><font size="2"   >&nbsp;* invent one out of whole cloth.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >static MdfdVec *</font></div><div><font size="2"   >mdopen(SMgrRelation reln, ForkNumber forknum, ExtensionBehavior behavior)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; MdfdVec &nbsp; &nbsp;*mdfd;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *path;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; File &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fd;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* No work if already open */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (reln-&gt;md_fd[forknum])</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return reln-&gt;md_fd[forknum];</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; path = relpath(reln-&gt;smgr_rnode, forknum);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fd = PathNameOpenFile(path, O_RDWR | PG_BINARY, 0600);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (fd &lt; 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* During bootstrap, there are cases where a system relation will be</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* accessed (by internal backend processes) before the bootstrap</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* script nominally creates it. &nbsp;Therefore, accept mdopen() as a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* substitute for mdcreate() in bootstrap mode only. (See mdcreate)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (IsBootstrapProcessingMode())</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fd = PathNameOpenFile(path, O_RDWR | O_CREAT | O_EXCL | PG_BINARY, 0600);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (fd &lt; 0)</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (behavior == EXTENSION_RETURN_NULL &amp;&amp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FILE_POSSIBLY_DELETED(errno))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pfree(path);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return NULL;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode_for_file_access(),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("could not open file \"%s\": %m", path)));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; pfree(path);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; reln-&gt;md_fd[forknum] = mdfd = _fdvec_alloc();</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; mdfd-&gt;mdfd_vfd = fd;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; mdfd-&gt;mdfd_segno = 0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; mdfd-&gt;mdfd_chain = NULL;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Assert(_mdnblocks(reln, forknum, mdfd) &lt;= ((BlockNumber) RELSEG_SIZE));</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; return mdfd;</font></div><div><font size="2"   >}</font></div></div><p></p></pre></div><div>错误内容中包含了<span style="line-height: 28px;"   >path也就是</span><span style="line-height: 28px;"   >filenode. 使用以下SQL查询报错输出的filenode是对应的哪个对象.</span></div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 28px;"   >select relname from pg_class where&nbsp;</span>pg_relation_filepath(oid)='$filenode';</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >经过查询, 全部来自索引. 即使查询走的全表扫描, 也会报错误, 原因是执行计划需要检索对应的索引.</span></div><div>也就是说, 执行完扩展字段的SQL后, 索引对应的filenode丢失了.&nbsp;</div><div>模拟无法重现这个问题 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# create table tbl(id int, c1 varchar(100), c2 varchar(125), c3 int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# insert into tbl select id,md5(random()::text),md5(random()::text),id from generate_series(1,100000) g(id);</font></div><div><font size="2"   >INSERT 0 100000</font></div><div><font size="2"   >digoal=# create index idx_tbl_c1 on tbl(c1);</font></div><div><font size="2"   >CREATE INDEX</font></div><div><font size="2"   >digoal=# create index idx_tbl_c2 on tbl(c2);</font></div><div><font size="2"   >CREATE INDEX</font></div></div><div><div><div><font size="2"   >digoal=# select ctid,oid,relname,pg_relation_filepath(oid) from pg_class where relname ~ 'tbl';</font></div><div><font size="2"   >&nbsp; ctid &nbsp;| &nbsp;oid &nbsp;| &nbsp;relname &nbsp; | pg_relation_filepath&nbsp;</font></div><div><font size="2"   >--------+-------+------------+----------------------</font></div><div><font size="2"   >&nbsp;(7,19) | 16580 | tbl &nbsp; &nbsp; &nbsp; &nbsp;| base/16384/16580</font></div><div><font size="2"   >&nbsp;(7,21) | 16583 | idx_tbl_c1 | base/16384/16583</font></div><div><font size="2"   >&nbsp;(7,22) | 16584 | idx_tbl_c2 | base/16384/16584</font></div><div><font size="2"   >(3 rows)</font></div></div></div><p></p></pre></div><div><div>目前的文件状态和MD5值 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg92@db-172-16-3-150-&gt; stat base/16384/16580*</font></div><div><font size="2"   >&nbsp; File: `base/16384/16580'</font></div><div><font size="2"   >&nbsp; Size: 10928128 &nbsp; &nbsp; &nbsp; &nbsp;Blocks: 21344 &nbsp; &nbsp; &nbsp;IO Block: 4096 &nbsp; regular file</font></div><div><font size="2"   >Device: 801h/2049d &nbsp; &nbsp; &nbsp;Inode: 7602950 &nbsp; &nbsp; Links: 1</font></div><div><font size="2"   >Access: (0600/-rw-------) &nbsp;Uid: ( &nbsp;504/ &nbsp; &nbsp;pg92) &nbsp; Gid: ( &nbsp;506/ &nbsp; &nbsp;pg92)</font></div><div><font size="2"   >Access: 2014-03-30 10:38:06.933356375 +0800</font></div><div><font size="2"   >Modify: 2014-03-30 10:38:10.689356211 +0800</font></div><div><font size="2"   >Change: 2014-03-30 10:38:10.689356211 +0800</font></div><div><font size="2"   >&nbsp; File: `base/16384/16580_fsm'</font></div><div><font size="2"   >&nbsp; Size: 24576 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Blocks: 48 &nbsp; &nbsp; &nbsp; &nbsp; IO Block: 4096 &nbsp; regular file</font></div><div><font size="2"   >Device: 801h/2049d &nbsp; &nbsp; &nbsp;Inode: 7603424 &nbsp; &nbsp; Links: 1</font></div><div><font size="2"   >Access: (0600/-rw-------) &nbsp;Uid: ( &nbsp;504/ &nbsp; &nbsp;pg92) &nbsp; Gid: ( &nbsp;506/ &nbsp; &nbsp;pg92)</font></div><div><font size="2"   >Access: 2014-03-30 10:38:09.879356210 +0800</font></div><div><font size="2"   >Modify: 2014-03-30 10:38:09.879356210 +0800</font></div><div><font size="2"   >Change: 2014-03-30 10:38:09.879356210 +0800</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >pg92@db-172-16-3-150-&gt; stat base/16384/16583*</font></div><div><font size="2"   >&nbsp; File: `base/16384/16583'</font></div><div><font size="2"   >&nbsp; Size: 5931008 &nbsp; &nbsp; &nbsp; &nbsp; Blocks: 11584 &nbsp; &nbsp; &nbsp;IO Block: 4096 &nbsp; regular file</font></div><div><font size="2"   >Device: 801h/2049d &nbsp; &nbsp; &nbsp;Inode: 7603422 &nbsp; &nbsp; Links: 1</font></div><div><font size="2"   >Access: (0600/-rw-------) &nbsp;Uid: ( &nbsp;504/ &nbsp; &nbsp;pg92) &nbsp; Gid: ( &nbsp;506/ &nbsp; &nbsp;pg92)</font></div><div><font size="2"   >Access: 2014-03-30 10:38:12.801355874 +0800</font></div><div><font size="2"   >Modify: 2014-03-30 10:38:13.391356209 +0800</font></div><div><font size="2"   >Change: 2014-03-30 10:38:13.391356209 +0800</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg92@db-172-16-3-150-&gt; stat base/16384/16584*</font></div><div><font size="2"   >&nbsp; File: `base/16384/16584'</font></div><div><font size="2"   >&nbsp; Size: 5931008 &nbsp; &nbsp; &nbsp; &nbsp; Blocks: 11584 &nbsp; &nbsp; &nbsp;IO Block: 4096 &nbsp; regular file</font></div><div><font size="2"   >Device: 801h/2049d &nbsp; &nbsp; &nbsp;Inode: 7603425 &nbsp; &nbsp; Links: 1</font></div><div><font size="2"   >Access: (0600/-rw-------) &nbsp;Uid: ( &nbsp;504/ &nbsp; &nbsp;pg92) &nbsp; Gid: ( &nbsp;506/ &nbsp; &nbsp;pg92)</font></div><div><font size="2"   >Access: 2014-03-30 10:38:15.074356263 +0800</font></div><div><font size="2"   >Modify: 2014-03-30 10:38:15.660356207 +0800</font></div><div><font size="2"   >Change: 2014-03-30 10:38:15.660356207 +0800</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg92@db-172-16-3-150-&gt; md5sum base/16384/16580*</font></div><div><font size="2"   >99aeb973031392efeff705cd28548b26 &nbsp;base/16384/16580</font></div><div><font size="2"   >86a4cae1a14f8636c77119f9f2a0c14d &nbsp;base/16384/16580_fsm</font></div></div><div><div style="line-height: 28px;"   ><font size="2"   >pg92@db-172-16-3-150-&gt; md5sum base/16384/16583*</font></div><div style="line-height: 28px;"   ><font size="2"   >bdf3bf9070a1cac51ac103148e024877 &nbsp;base/16384/16583</font></div><div style="line-height: 28px;"   ><font size="2"   >pg92@db-172-16-3-150-&gt; md5sum base/16384/16584*</font></div><div style="line-height: 28px;"   ><font size="2"   >65de4b56e07f5b7f8df190d88be6ed57 &nbsp;base/16384/16584</font></div></div><p></p></pre></div><div>扩展数据类型 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# alter table tbl alter COLUMN c1 type varchar;</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >digoal=# alter table tbl alter COLUMN c2 type varchar;</font></div><div><font size="2"   >ALTER TABLE</font></div><div><div><font size="2"   >digoal=# select ctid,oid,relname,pg_relation_filepath(oid) from pg_class where relname ~ 'tbl';</font></div><div><font size="2"   >&nbsp; ctid &nbsp;| &nbsp;oid &nbsp;| &nbsp;relname &nbsp; | pg_relation_filepath&nbsp;</font></div><div><font size="2"   >--------+-------+------------+----------------------</font></div><div><font size="2"   >&nbsp;(7,23) | 16587 | idx_tbl_c1 | base/16384/16583</font></div><div><font size="2"   >&nbsp;(7,26) | 16580 | tbl &nbsp; &nbsp; &nbsp; &nbsp;| base/16384/16580</font></div><div><font size="2"   >&nbsp;(7,28) | 16591 | idx_tbl_c2 | base/16384/16584</font></div><div><font size="2"   >(3 rows)</font></div></div><p></p></pre></div></div><div>扩展后对应的文件状态和MD5值, 包括inode都没有发生变化.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg92@db-172-16-3-150-&gt; stat base/16384/16580*</font></div><div><font size="2"   >&nbsp; File: `base/16384/16580'</font></div><div><font size="2"   >&nbsp; Size: 10928128 &nbsp; &nbsp; &nbsp; &nbsp;Blocks: 21344 &nbsp; &nbsp; &nbsp;IO Block: 4096 &nbsp; regular file</font></div><div><font size="2"   >Device: 801h/2049d &nbsp; &nbsp; &nbsp;Inode: 7602950 &nbsp; &nbsp; Links: 1</font></div><div><font size="2"   >Access: (0600/-rw-------) &nbsp;Uid: ( &nbsp;504/ &nbsp; &nbsp;pg92) &nbsp; Gid: ( &nbsp;506/ &nbsp; &nbsp;pg92)</font></div><div><font size="2"   >Access: 2014-03-30 10:38:06.933356375 +0800</font></div><div><font size="2"   >Modify: 2014-03-30 10:38:10.689356211 +0800</font></div><div><font size="2"   >Change: 2014-03-30 10:38:10.689356211 +0800</font></div><div><font size="2"   >&nbsp; File: `base/16384/16580_fsm'</font></div><div><font size="2"   >&nbsp; Size: 24576 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Blocks: 48 &nbsp; &nbsp; &nbsp; &nbsp; IO Block: 4096 &nbsp; regular file</font></div><div><font size="2"   >Device: 801h/2049d &nbsp; &nbsp; &nbsp;Inode: 7603424 &nbsp; &nbsp; Links: 1</font></div><div><font size="2"   >Access: (0600/-rw-------) &nbsp;Uid: ( &nbsp;504/ &nbsp; &nbsp;pg92) &nbsp; Gid: ( &nbsp;506/ &nbsp; &nbsp;pg92)</font></div><div><font size="2"   >Access: 2014-03-30 10:38:09.879356210 +0800</font></div><div><font size="2"   >Modify: 2014-03-30 10:38:09.879356210 +0800</font></div><div><font size="2"   >Change: 2014-03-30 10:38:09.879356210 +0800</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg92@db-172-16-3-150-&gt; stat base/16384/16583*</font></div><div><font size="2"   >&nbsp; File: `base/16384/16583'</font></div><div><font size="2"   >&nbsp; Size: 5931008 &nbsp; &nbsp; &nbsp; &nbsp; Blocks: 11584 &nbsp; &nbsp; &nbsp;IO Block: 4096 &nbsp; regular file</font></div><div><font size="2"   >Device: 801h/2049d &nbsp; &nbsp; &nbsp;Inode: 7603422 &nbsp; &nbsp; Links: 1</font></div><div><font size="2"   >Access: (0600/-rw-------) &nbsp;Uid: ( &nbsp;504/ &nbsp; &nbsp;pg92) &nbsp; Gid: ( &nbsp;506/ &nbsp; &nbsp;pg92)</font></div><div><font size="2"   >Access: 2014-03-30 10:38:12.801355874 +0800</font></div><div><font size="2"   >Modify: 2014-03-30 10:38:13.391356209 +0800</font></div><div><font size="2"   >Change: 2014-03-30 10:38:13.391356209 +0800</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg92@db-172-16-3-150-&gt; stat base/16384/16584*</font></div><div><font size="2"   >&nbsp; File: `base/16384/16584'</font></div><div><font size="2"   >&nbsp; Size: 5931008 &nbsp; &nbsp; &nbsp; &nbsp; Blocks: 11584 &nbsp; &nbsp; &nbsp;IO Block: 4096 &nbsp; regular file</font></div><div><font size="2"   >Device: 801h/2049d &nbsp; &nbsp; &nbsp;Inode: 7603425 &nbsp; &nbsp; Links: 1</font></div><div><font size="2"   >Access: (0600/-rw-------) &nbsp;Uid: ( &nbsp;504/ &nbsp; &nbsp;pg92) &nbsp; Gid: ( &nbsp;506/ &nbsp; &nbsp;pg92)</font></div><div><font size="2"   >Access: 2014-03-30 10:38:15.074356263 +0800</font></div><div><font size="2"   >Modify: 2014-03-30 10:38:15.660356207 +0800</font></div><div><font size="2"   >Change: 2014-03-30 10:38:15.660356207 +0800</font></div></div><div><font size="2"   ><br></font></div><div><div style="line-height: 28px;"   ><font size="2"   >pg92@db-172-16-3-150-&gt; md5sum base/16384/16580*</font></div><div style="line-height: 28px;"   ><font size="2"   >99aeb973031392efeff705cd28548b26 &nbsp;base/16384/16580</font></div><div style="line-height: 28px;"   ><font size="2"   >86a4cae1a14f8636c77119f9f2a0c14d &nbsp;base/16384/16580_fsm</font></div><div style="line-height: 28px;"   ><font size="2"   >pg92@db-172-16-3-150-&gt; md5sum base/16384/16583*</font></div><div style="line-height: 28px;"   ><font size="2"   >bdf3bf9070a1cac51ac103148e024877 &nbsp;base/16384/16583</font></div><div style="line-height: 28px;"   ><font size="2"   >pg92@db-172-16-3-150-&gt; md5sum base/16384/16584*</font></div><div style="line-height: 28px;"   ><font size="2"   >65de4b56e07f5b7f8df190d88be6ed57 &nbsp;base/16384/16584</font></div></div><p></p></pre></div><div>因为9.2, 变长字符串扩展为不限长度字符串不需要rewrite table, 所以不会涉及到表和索引的重组.</div><div>模拟删除对应的索引文件 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-150-&gt; cd $PGDATA</font></div><div><div><font size="2"   >pg92@db-172-16-3-150-&gt; rm -f base/16384/16583*</font></div><div><font size="2"   >pg92@db-172-16-3-150-&gt; rm -f base/16384/16584*</font></div></div><div><div><font size="2"   >digoal=# \set VERBOSITY verbose</font></div><div><font size="2"   >digoal=# select * from tbl where c1='8b8d7a70bd8922c9ba91621b8f0835e4';</font></div><div><font size="2"   >ERROR: &nbsp;58P01: could not open file "base/16384/<span style="line-height: 28px;"   >16583</span>": No such file or directory</font></div><div><font size="2"   >LOCATION: &nbsp;mdopen, md.c:579</font></div><div><font size="2"   >digoal=# select * from tbl limit 1;</font></div><div><font size="2"   >ERROR: &nbsp;58P01: could not open file "base/16384/<span style="line-height: 28px;"   >16583</span>": No such file or directory</font></div><div><font size="2"   >LOCATION: &nbsp;mdopen, md.c:579</font></div><div><font size="2"   >digoal=# explain select * from tbl limit 1;</font></div><div><font size="2"   >ERROR: &nbsp;58P01: could not open file "base/16384/<span style="line-height: 28px;"   >16583</span>": No such file or directory</font></div><div><font size="2"   >LOCATION: &nbsp;mdopen, md.c:579</font></div></div><p></p></pre></div><div>这个问题重建索引解决 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# reindex table tbl;</font></div><div><font size="2"   >REINDEX</font></div><div><font size="2"   >digoal=# explain select * from tbl limit 1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Limit &nbsp;(cost=0.00..0.02 rows=1 width=444)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Seq Scan on tbl &nbsp;(cost=0.00..2334.00 rows=100000 width=444)</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >注意, 如果此时shared buffer中仍旧有缓存, 并且当前会话已经打开了对应的文件描述符的话, 可能不会报错.</span></div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# explain select * from tbl where c1='8b8d7a70bd8922c9ba91621b8f0835e4';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-----------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Bitmap Heap Scan on tbl &nbsp;(cost=20.15..1002.35 rows=500 width=444)</font></div><div><font size="2"   >&nbsp; &nbsp;Recheck Cond: ((c1)::text = '8b8d7a70bd8922c9ba91621b8f0835e4'::text)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on idx_tbl_c1 &nbsp;(cost=0.00..20.03 rows=500 width=0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: ((c1)::text = '8b8d7a70bd8922c9ba91621b8f0835e4'::text)</font></div><div><font size="2"   >(4 rows)</font></div><div><font size="2"   >digoal=# select * from tbl where c1='8b8d7a70bd8922c9ba91621b8f0835e4';</font></div><div><font size="2"   >&nbsp;id &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;c1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;c2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| c3 &nbsp;</font></div><div><font size="2"   >-----+----------------------------------+----------------------------------+-----</font></div><div><font size="2"   >&nbsp;116 | 8b8d7a70bd8922c9ba91621b8f0835e4 | bb65b13ece4cc14f599e987eec29f1b7 | 116</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select ctid,oid,relname,pg_relation_filepath(oid) from pg_class where relname ~ 'tbl';</font></div><div><font size="2"   >&nbsp; ctid &nbsp;| &nbsp;oid &nbsp;| &nbsp;relname &nbsp; | pg_relation_filepath&nbsp;</font></div><div><font size="2"   >--------+-------+------------+----------------------</font></div><div><font size="2"   >&nbsp;(7,35) | 16597 | idx_tbl_id | base/16384/16665</font></div><div><font size="2"   >&nbsp;(7,58) | 16648 | idx_tbl_c2 | base/16384/16666</font></div><div><font size="2"   >&nbsp;(7,59) | 16658 | idx_tbl_c1 | base/16384/16667</font></div><div><font size="2"   >&nbsp;(7,76) | 16580 | tbl &nbsp; &nbsp; &nbsp; &nbsp;| base/16384/16659</font></div><div><font size="2"   >(4 rows)</font></div><p></p></pre></div><div>删除c1列对应的索引文件 :&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg92@db-172-16-3-150-&gt; rm -f base/16384/16667*</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >在当前会话继续使用这个索引查询没有问题,&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# select * from tbl where c1='8b8d7a70bd8922c9ba91621b8f0835e4';</font></div><div><font size="2"   >&nbsp;id &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;c1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;c2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| c3 &nbsp;</font></div><div><font size="2"   >-----+----------------------------------+----------------------------------+-----</font></div><div><font size="2"   >&nbsp;116 | 8b8d7a70bd8922c9ba91621b8f0835e4 | bb65b13ece4cc14f599e987eec29f1b7 | 116</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >digoal=# select * from tbl limit 2;</font></div><div><font size="2"   >&nbsp;id &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;c1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;c2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| c3 &nbsp;</font></div><div><font size="2"   >-----+----------------------------------+----------------------------------+-----</font></div><div><font size="2"   >&nbsp;116 | 8b8d7a70bd8922c9ba91621b8f0835e4 | bb65b13ece4cc14f599e987eec29f1b7 | 116</font></div><div><font size="2"   >&nbsp; 14 | 026ff05e958bb893bfc022ce02d33541 | 7bf7b06ddbe8adfc0bf44fa249439a9a | &nbsp;14</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   >digoal=# explain analyze select * from tbl where c1='026ff05e958bb893bfc022ce02d33541';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Bitmap Heap Scan on tbl &nbsp;(cost=20.15..1002.35 rows=500 width=444) (actual time=0.085..0.086 rows=1 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Recheck Cond: ((c1)::text = '026ff05e958bb893bfc022ce02d33541'::text)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on idx_tbl_c1 &nbsp;(cost=0.00..20.03 rows=500 width=0) (actual time=0.078..0.078 rows=1 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: ((c1)::text = '026ff05e958bb893bfc022ce02d33541'::text)</font></div><div><font size="2"   >&nbsp;Total runtime: 0.125 ms</font></div><div><font size="2"   >(5 rows)</font></div><div><font size="2"   >digoal=# select * from tbl where c1='026ff05e958bb893bfc022ce02d33541';</font></div><div><font size="2"   >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;c1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;c2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| c3&nbsp;</font></div><div><font size="2"   >----+----------------------------------+----------------------------------+----</font></div><div><font size="2"   >&nbsp;14 | 026ff05e958bb893bfc022ce02d33541 | 7bf7b06ddbe8adfc0bf44fa249439a9a | 14</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >digoal=# select * from tbl where id=10000;</font></div><div><font size="2"   >&nbsp; id &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;c1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;c2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;c3 &nbsp;&nbsp;</font></div><div><font size="2"   >-------+----------------------------------+----------------------------------+-------</font></div><div><font size="2"   >&nbsp;10000 | c351b1744a2894eec33b37f349957bd8 | 912bd453ba95cc75e472433ae7666792 | 10000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select * from tbl where c1='c351b1744a2894eec33b37f349957bd8';</font></div><div><font size="2"   >&nbsp; id &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;c1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;c2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;c3 &nbsp;&nbsp;</font></div><div><font size="2"   >-------+----------------------------------+----------------------------------+-------</font></div><div><font size="2"   >&nbsp;10000 | c351b1744a2894eec33b37f349957bd8 | 912bd453ba95cc75e472433ae7666792 | 10000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# explain analyze select * from tbl where c1='c351b1744a2894eec33b37f349957bd8';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;Bitmap Heap Scan on tbl &nbsp;(cost=20.15..1002.35 rows=500 width=444) (actual time=0.032..0.032 rows=1 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp;Recheck Cond: ((c1)::text = 'c351b1744a2894eec33b37f349957bd8'::text)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Bitmap Index Scan on idx_tbl_c1 &nbsp;(cost=0.00..20.03 rows=500 width=0) (actual time=0.028..0.028 rows=1 loops=1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: ((c1)::text = 'c351b1744a2894eec33b37f349957bd8'::text)</font></div><div><font size="2"   >&nbsp;Total runtime: 0.062 ms</font></div><div><font size="2"   >(5 rows)</font></div></div><p></p></pre></div><div>但是, 退出会话, 重进就报错了, 因为退出会话时, 这个索引对应的文件描述符关闭了 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# \q</font></div><div><font size="2"   >pg92@db-172-16-3-150-&gt;&nbsp;</font></div><div><font size="2"   >pg92@db-172-16-3-150-&gt; psql</font></div><div><font size="2"   >psql (9.2.4)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# explain analyze select * from tbl where c1='c351b1744a2894eec33b37f349957bd8';</font></div><div><font size="2"   >ERROR: &nbsp;could not open file "base/16384/16667": No such file or directory</font></div><p></p></pre></div><div><br></div><div>为什么索引文件会丢失, 原因还不明.</div></div>
	</div>
</div>
</body>
</html>