<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">业务逻辑的锁隐患一例</h2>
	<h5 id="">2011-12-02 9:56:13&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201111154224100/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>业务逻辑报的一堆deadlock异常 :&nbsp;</div><div>2011-11-01 08:44:26.047 CST,"freecoin","freecoin",16796,"172.16.4.44:30722",4eaf3c7c.419c,1,"SELECT",2011-11-01 08:25:32 CST,26/72093,15289517,ERROR,40P01,"deadlock detected","Process 16796 waits for ShareLock on transaction 15289518; blocked by process 16747.</div><div>Process 16747 waits for ShareLock on transaction 15289517; blocked by process 16796.</div><div>Process 16796: SELECT transfer FROM transfer($1,$2,$3,$4,$5,$6,$7)</div><div>Process 16747: SELECT transfer FROM transfer($1,$2,$3,$4,$5,$6,$7)","See server log for query details.",,,"SQL statement ""update coin_accounts set income_amount=(income_amount-v_income_amount), recharge_amount=(recharge_amount-v_recharge_amount) ,total_amount=(total_amount-v_income_amount-v_recharge_amount) where current of v_cursor2""</div><div>PL/pgSQL function ""transfer"" line 108 at SQL statement","SELECT transfer FROM transfer($1,$2,$3,$4,$5,$6,$7)",,,""</div><div><br></div><div>2011-11-01 08:44:27.051 CST,"freecoin","freecoin",16953,"172.16.4.44:30800",4eaf3c8f.4239,1,"SELECT",2011-11-01 08:25:51 CST,106/30984,15289525,ERROR,40P01,"deadlock detected","Process 16953 waits for ExclusiveLock on tuple (454,16) of relation 19599 of database 16385; blocked by process 16870.</div><div>Process 16870 waits for ShareLock on transaction 15289518; blocked by process 16747.</div><div>Process 16747 waits for ShareLock on transaction 15289525; blocked by process 16953.</div><div>Process 16953: SELECT transfer FROM transfer($1,$2,$3,$4,$5,$6,$7)</div><div>Process 16870: SELECT transfer FROM transfer($1,$2,$3,$4,$5,$6,$7)</div><div>Process 16747: SELECT transfer FROM transfer($1,$2,$3,$4,$5,$6,$7)","See server log for query details.",,,"SQL statement ""update coin_accounts set income_amount=(income_amount-v_income_amount), recharge_amount=(recharge_amount-v_recharge_amount) ,total_amount=(total_amount-v_income_amount-v_recharge_amount) where current of v_cursor2""</div><div>PL/pgSQL function ""transfer"" line 108 at SQL statement","SELECT transfer FROM transfer($1,$2,$3,$4,$5,$6,$7)",,,""</div><div><br></div><div>transfer函数中有大量的游标，更关键的是可能存在交错持错。</div><div>下面是模拟场景 :&nbsp;</div><div><br></div><div><div>digoal=&gt; create table user_balance_daily (uid int,expired date,balance numeric check (balance&gt;=0),primary key (uid,expired));</div><div>digoal=&gt; create table user_balance_total (uid int primary key,balance numeric check (balance&gt;=0));</div><div><br></div><div>digoal=&gt; select * from charge(1,current_date+1,100);</div><div>digoal=&gt; select * from charge(1,current_date+2,100);</div><div>digoal=&gt; select * from charge(1,current_date+3,100);</div><div>digoal=&gt; select * from charge(1,current_date+4,100);</div><div>digoal=&gt; select * from charge(1,current_date+5,100);</div><div>digoal=&gt; select * from charge(1,current_date+6,100);</div><div>digoal=&gt; select * from charge(1,current_date+7,100);</div><div>digoal=&gt; select * from charge(1,current_date+8,100);</div><div>digoal=&gt; select * from charge(1,current_date+9,100);</div><div>digoal=&gt; select * from charge(1,current_date+10,100);</div><div><br></div><div>digoal=&gt; select * from user_balance_daily ;</div><div>&nbsp;uid | &nbsp;expired &nbsp; | balance&nbsp;</div><div>-----+------------+---------</div><div>&nbsp; &nbsp;1 | 2011-12-03 | &nbsp; &nbsp; 100</div><div>&nbsp; &nbsp;1 | 2011-12-04 | &nbsp; &nbsp; 100</div><div>&nbsp; &nbsp;1 | 2011-12-05 | &nbsp; &nbsp; 100</div><div>&nbsp; &nbsp;1 | 2011-12-06 | &nbsp; &nbsp; 100</div><div>&nbsp; &nbsp;1 | 2011-12-07 | &nbsp; &nbsp; 100</div><div>&nbsp; &nbsp;1 | 2011-12-08 | &nbsp; &nbsp; 100</div><div>&nbsp; &nbsp;1 | 2011-12-09 | &nbsp; &nbsp; 100</div><div>&nbsp; &nbsp;1 | 2011-12-10 | &nbsp; &nbsp; 100</div><div>&nbsp; &nbsp;1 | 2011-12-11 | &nbsp; &nbsp; 100</div><div>&nbsp; &nbsp;1 | 2011-12-12 | &nbsp; &nbsp; 100</div><div>(10 rows)</div><div><br></div><div>digoal=&gt; select * from user_balance_total ;</div><div>&nbsp;uid | balance&nbsp;</div><div>-----+---------</div><div>&nbsp; &nbsp;1 | &nbsp; &nbsp;1000</div><div>(1 row)</div></div><div><br></div><div><div>create or replace function consume (i_uid int,i_balance numeric) returns int as $BODY$</div><div>declare</div><div>v_balance1 numeric;</div><div>v_balance2 numeric;</div><div>v_cursor1 refcursor;</div><div>begin</div><div>perform balance from user_balance_total where uid=i_uid and balance&gt;=i_balance;</div><div>IF FOUND THEN</div><div>&nbsp; update user_balance_total set balance=balance-i_balance where uid=i_uid;</div><div>&nbsp; -- 模拟慢查询</div><div>&nbsp; perform 1 from (select pg_sleep(5)) as t;</div><div>&nbsp; v_balance1 = i_balance;</div><div>&nbsp; raise notice 'v_balance1: %',v_balance1;</div><div>&nbsp; open v_cursor1 for select balance from user_balance_daily where uid=i_uid and expired &gt;= current_date and balance&gt;0 order by expired for update;</div><div>&nbsp; while v_balance1&gt;0 LOOP</div><div>&nbsp; &nbsp; fetch from v_cursor1 into v_balance2;</div><div>&nbsp; &nbsp; update user_balance_daily set balance=(case when balance&lt;=v_balance1 then balance-v_balance2 else balance-v_balance1 end) where current of v_cursor1;</div><div>&nbsp; &nbsp; v_balance1=v_balance1-v_balance2;</div><div>&nbsp; &nbsp; raise notice 'v_balance1: %',v_balance1;</div><div>&nbsp; &nbsp; raise notice 'v_balance2: %',v_balance2;</div><div>&nbsp; END LOOP;</div><div>&nbsp; CLOSE v_cursor1;</div><div>else</div><div>&nbsp; return 1;</div><div>end if;</div><div>if v_balance1&gt;0 then</div><div>&nbsp; raise EXCEPTION 'USER: % consume failed.', i_uid;</div><div>&nbsp; return 3;</div><div>end if;</div><div>return 0;</div><div>exception</div><div>when others then</div><div>return 2;</div><div>end;</div><div>$BODY$ language plpgsql;</div><div><br></div><div><br></div><div>create or replace function charge (i_uid int,i_expired date,i_balance numeric) returns int as $BODY$</div><div>declare</div><div>begin</div><div>perform 1 from user_balance_daily where uid=i_uid and expired=i_expired;</div><div>if found then</div><div>update user_balance_daily set balance=balance+i_balance where uid=i_uid and expired=i_expired;</div><div>else</div><div>insert into user_balance_daily (uid,expired,balance) values (i_uid,i_expired,i_balance);</div><div>end if;</div><div>-- 模拟慢查询</div><div>perform 1 from (select pg_sleep(5)) as t;</div><div>perform 1 from user_balance_total where uid=i_uid;</div><div>if found then</div><div>update user_balance_total set balance=balance+i_balance where uid=i_uid;</div><div>else</div><div>insert into user_balance_total (uid,balance) values (i_uid,i_balance);</div><div>end if;</div><div>return 0;</div><div>exception</div><div>when others then</div><div>return 1;</div><div>end;</div><div>$BODY$ language plpgsql;</div></div><div><br></div><div>开启两个SESSION执行如下 :&nbsp;</div><div>SESSION A:</div><div>digoal=&gt; select * from charge(1,current_date+1,100);</div><div>SESSION B:</div><div>digoal=&gt; select * from consume(1,200);</div><div><br></div><div>将有一个SESSION被BLOCKED掉。</div><div>更加清晰的如下 :&nbsp;</div><div><div>function A:</div><div>digoal=&gt; begin;</div><div>BEGIN</div><div>digoal=&gt; update user_balance_total set balance =balance-200 where uid=1;</div><div>UPDATE 1</div><div>digoal=&gt; update user_balance_daily set balance =balance-200 where uid=1 and expired='2011-12-03';</div><div>ERROR: &nbsp;deadlock detected</div><div>DETAIL: &nbsp;Process 13041 waits for ShareLock on transaction 350770604; blocked by process 12364.</div><div>Process 12364 waits for ShareLock on transaction 350770605; blocked by process 13041.</div><div>HINT: &nbsp;See server log for query details.</div></div><div><br></div><div>function B:</div><div><div>digoal=&gt; begin;</div><div>BEGIN</div><div>digoal=&gt; update user_balance_daily set balance =balance+100 where uid=1 and expired='2011-12-03';</div><div>UPDATE 1</div><div>digoal=&gt; update user_balance_total set balance =balance+100 where uid=1;</div><div>UPDATE 1</div><div>digoal=&gt;&nbsp;</div></div><div><br></div><div>因此需要修改一下函数如下 :&nbsp;</div><div>使两个函数持锁的顺序一致,</div><div><div>create or replace function consume (i_uid int,i_balance numeric) returns int as $BODY$</div><div>declare</div><div>v_balance1 numeric;</div><div>v_balance2 numeric;</div><div>v_cursor1 refcursor;</div><div>begin</div><div>perform balance from user_balance_total where uid=i_uid and balance&gt;=i_balance;</div><div>IF FOUND THEN</div><div>&nbsp; v_balance1 = i_balance;</div><div>&nbsp; raise notice 'v_balance1: %',v_balance1;</div><div>&nbsp; open v_cursor1 for select balance from user_balance_daily where uid=i_uid and expired &gt;= current_date and balance&gt;0 order by expired for update;</div><div>&nbsp; while v_balance1&gt;0 LOOP</div><div>&nbsp; &nbsp; fetch from v_cursor1 into v_balance2;</div><div>&nbsp; &nbsp; update user_balance_daily set balance=(case when balance&lt;=v_balance1 then balance-v_balance2 else balance-v_balance1 end) where current of v_cursor1;</div><div>&nbsp; &nbsp; v_balance1=v_balance1-v_balance2;</div><div>&nbsp; &nbsp; raise notice 'v_balance1: %',v_balance1;</div><div>&nbsp; &nbsp; raise notice 'v_balance2: %',v_balance2;</div><div>&nbsp; END LOOP;</div><div>&nbsp;&nbsp;-- 模拟慢查询</div><div>&nbsp; perform 1 from (select pg_sleep(5)) as t;</div><div>&nbsp; CLOSE v_cursor1;</div><div>else</div><div>&nbsp; return 1;</div><div>end if;</div><div>if v_balance1&gt;0 then</div><div>&nbsp; raise EXCEPTION 'USER: % consume failed.', i_uid;</div><div>&nbsp; return 3;</div><div>end if;</div><div><div>update user_balance_total set balance=balance-i_balance where uid=i_uid;</div></div><div>return 0;</div><div>exception</div><div>when others then</div><div>return 2;</div><div>end;</div><div>$BODY$ language plpgsql;</div></div><div><br></div><div>这样就不会再有问题.</div><div><br></div><div>【参考】</div><div><a rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/view-pg-locks.html"  >http://www.postgresql.org/docs/9.1/static/view-pg-locks.html</a></div><div><br></div><wbr></div>
	</div>
</div>
</body>
</html>