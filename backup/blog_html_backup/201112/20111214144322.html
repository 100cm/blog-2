<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PGCloud beta</h2>
	<h5 id="">2011-12-14 14:43:22&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402011111422518103/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>最近在写一个PGCloud的方案, 目的是降低运维人员的工作负担, 提供高可用, 节约成本, 提供精细化的报告和监控平台.</div><div>设计思路如图 :&nbsp;</div><div><div><img title="PGCloud beta - 德哥@Digoal - The Heart,The World."  alt="PGCloud beta - 德哥@Digoal - The Heart,The World."  style="margin:0 10px 0 0;"  src="http://img3.ph.126.net/ae1TtfoCnI3Qv70JRtwDvg==/2480076019814726663.jpg"  ></div>&nbsp;</div><div>E-R图 :&nbsp;</div><div><div><img title="PGCloud beta - 德哥@Digoal - The Heart,The World."  alt="PGCloud beta - 德哥@Digoal - The Heart,The World."  style="margin:0 10px 0 0;"  src="http://img9.ph.126.net/DKYsk36yCDqN2zmvZYYI5g==/2495838618510543709.jpg"  ></div>&nbsp;</div><div><br></div><div>分为几类角色 :&nbsp;</div><div>如图 :&nbsp;</div><div><div><img title="PGCloud beta - 德哥@Digoal - The Heart,The World."  alt="PGCloud beta - 德哥@Digoal - The Heart,The World."  style="margin:0 10px 0 0;"  src="http://img3.ph.126.net/kXq9JD5cxCwgVUuwBnhuWw==/2393944676941266613.jpg"  ></div>&nbsp;</div><div><br></div><div>1. 连接池(也可以是端口代理)</div><div>&nbsp; &nbsp; 使用连接池可以灵活的根据当前的数据库状态判断是否需要切换连接。</div><div>&nbsp; &nbsp; 使用连接池或端口代理的原因是可以在激活standby之前有一个缓冲，使得主库和备库可以达到完全一致。</div><div>2. 数据库(主,备)(当然也可以是主,主)</div><div>&nbsp; &nbsp; 利用流复制来提供不依赖存储的高可用，这一点VMWARE的VFDD无法做到。</div><div>3. 仲裁</div><div>&nbsp; &nbsp; 仲裁负责监控，更新当前集群的状态以及promote备库等。</div><div>4. 配置库</div><div>&nbsp; &nbsp; 类似异步消息组件，在仲裁和连接池之间共享消息。</div><div><br></div><div>TO DO,</div><div>1. 现在只实现了自动failover, 接下来需要实现自动failback.</div><div>2. 实现平台化管理.</div><div>3. 实现根据负载情况动态切换主备.</div><div>4. promote的选择更加智能, 不光看priority.</div><div>5. 报表考虑用hadoop来做分析.</div><div><br></div><div>大部分逻辑全部使用plpgsql函数来实现.</div><div>具体实现的代码如下 :&nbsp;</div><div>-- 生产主库环境准备</div><div>新建 promote 超级用户</div><div><pre class="prettyprint"  ><p><font size="2"  >create role promote superuser nocreatedb nocreaterole noinherit login encrypted password 'md5c43b2a66ef200d4bf5072465a161fea';</font></p></pre></div><div>新建 promote 库, check表</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create database promote with owner postgres template template0 encoding 'UTF8';</font></div><div><font size="2"  >\c promote promote</font></div><div><font size="2"  >create table check_record (count int8,check_time timestamp(0));</font></div><div><font size="2"  >insert into check_record (count,check_time) values (0,now());</font></div><p></p></pre></div><div>pg_hba.conf 允许仲裁服务器连接</div><div><br></div><div><br></div><div>-- 仲裁数据库配置</div><div>-- pgcloud全局配置表序列</div><div><pre class="prettyprint"  ><p><font size="2"  >create sequence seq_pgcloud increment by 1 minvalue 1 no maxvalue start with &nbsp;1 no cycle;</font></p></pre></div><div><br></div><div>-- pgcloud全局日志序表列</div><div><pre class="prettyprint"  ><p><font size="2"  >create sequence seq_pgcloud_log increment by 1 minvalue 1 no maxvalue start with &nbsp;1 no cycle;</font></p></pre></div><div><br></div><div>-- 检测IP字段输入是否合法</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function check_ip_format(i_ip text) returns boolean as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >v_ip inet;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >v_ip := i_ip::inet;</font></div><div><font size="2"  >return true;</font></div><div><font size="2"  >exception</font></div><div><font size="2"  >when others then</font></div><div><font size="2"  >return false;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$BODY$ language plpgsql;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table soft_bit</font></div><div><font size="2"  >(</font></div><div><font size="2"  >id int primary key,</font></div><div><font size="2"  >value text not null,</font></div><div><font size="2"  >comment text,</font></div><div><font size="2"  >create_time timestamp(0) not null,</font></div><div><font size="2"  >modify_time timestamp(0) not null,</font></div><div><font size="2"  >unique (value)</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >insert into soft_bit (id,value,create_time,modify_time)&nbsp;</font></div><div><font size="2"  >&nbsp; values (nextval('seq_pgcloud'::regclass), 'x64', now(), now());</font></div><div><font size="2"  >insert into soft_bit (id,value,create_time,modify_time)&nbsp;</font></div><div><font size="2"  >&nbsp; values (nextval('seq_pgcloud'::regclass), 'i386', now(), now());</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table soft_name</font></div><div><font size="2"  >(</font></div><div><font size="2"  >id int primary key,</font></div><div><font size="2"  >value text not null,</font></div><div><font size="2"  >comment text,</font></div><div><font size="2"  >create_time timestamp(0) not null,&nbsp;</font></div><div><font size="2"  >modify_time timestamp(0) not null,</font></div><div><font size="2"  >unique (value)</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >insert into soft_name (id,value,create_time,modify_time)&nbsp;</font></div><div><font size="2"  >&nbsp; values (nextval('seq_pgcloud'::regclass), 'RHEL', now(), now());</font></div><div><font size="2"  >insert into soft_name (id,value,create_time,modify_time)&nbsp;</font></div><div><font size="2"  >&nbsp; values (nextval('seq_pgcloud'::regclass), 'CentOS', now(), now());</font></div><div><font size="2"  >insert into soft_name (id,value,create_time,modify_time)&nbsp;</font></div><div><font size="2"  >&nbsp; values (nextval('seq_pgcloud'::regclass), 'PostgreSQL', now(), now());</font></div><div><font size="2"  >insert into soft_name (id,value,create_time,modify_time)&nbsp;</font></div><div><font size="2"  >&nbsp; values (nextval('seq_pgcloud'::regclass), 'pgbouncer', now(), now());</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table soft_ver</font></div><div><font size="2"  >(</font></div><div><font size="2"  >id int primary key,</font></div><div><font size="2"  >value text not null,</font></div><div><font size="2"  >comment text,</font></div><div><font size="2"  >create_time timestamp(0) not null,&nbsp;</font></div><div><font size="2"  >modify_time timestamp(0) not null,</font></div><div><font size="2"  >unique (value)</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >insert into soft_ver (id,value,create_time,modify_time)&nbsp;</font></div><div><font size="2"  >&nbsp; values (nextval('seq_pgcloud'::regclass), '9.0.6', now(), now());</font></div><div><font size="2"  >insert into soft_ver (id,value,create_time,modify_time)&nbsp;</font></div><div><font size="2"  >&nbsp; values (nextval('seq_pgcloud'::regclass), '9.1.1', now(), now());</font></div><div><font size="2"  >insert into soft_ver (id,value,create_time,modify_time)&nbsp;</font></div><div><font size="2"  >&nbsp; values (nextval('seq_pgcloud'::regclass), '9.1.2', now(), now());</font></div><div><font size="2"  >insert into soft_ver (id,value,create_time,modify_time)&nbsp;</font></div><div><font size="2"  >&nbsp; values (nextval('seq_pgcloud'::regclass), '1.4.2', now(), now());</font></div><div><font size="2"  >insert into soft_ver (id,value,create_time,modify_time)&nbsp;</font></div><div><font size="2"  >&nbsp; values (nextval('seq_pgcloud'::regclass), '5.6', now(), now());</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table soft_role</font></div><div><font size="2"  >(</font></div><div><font size="2"  >id int primary key,</font></div><div><font size="2"  >value text not null,</font></div><div><font size="2"  >comment text,</font></div><div><font size="2"  >create_time timestamp(0) not null,&nbsp;</font></div><div><font size="2"  >modify_time timestamp(0) not null,</font></div><div><font size="2"  >unique (value)</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >insert into soft_role (id,value,create_time,modify_time)&nbsp;</font></div><div><font size="2"  >&nbsp; values (nextval('seq_pgcloud'::regclass), 'primary', now(), now());</font></div><div><font size="2"  >insert into soft_role (id,value,create_time,modify_time)&nbsp;</font></div><div><font size="2"  >&nbsp; values (nextval('seq_pgcloud'::regclass), 'warm-standby', now(), now());</font></div><div><font size="2"  >insert into soft_role (id,value,create_time,modify_time)&nbsp;</font></div><div><font size="2"  >&nbsp; values (nextval('seq_pgcloud'::regclass), 'hot-standby', now(), now());</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table pool_ha_name</font></div><div><font size="2"  >(</font></div><div><font size="2"  >id int primary key,</font></div><div><font size="2"  >value text not null,</font></div><div><font size="2"  >comment text,</font></div><div><font size="2"  >create_time timestamp(0) not null,&nbsp;</font></div><div><font size="2"  >modify_time timestamp(0) not null,</font></div><div><font size="2"  >unique (value)</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >insert into pool_ha_name (id,value,create_time,modify_time)&nbsp;</font></div><div><font size="2"  >&nbsp; values (nextval('seq_pgcloud'::regclass), '德哥的pgbouncer测试集群1', now(), now());</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table idc</font></div><div><font size="2"  >(</font></div><div><font size="2"  >id int primary key,</font></div><div><font size="2"  >value text not null,</font></div><div><font size="2"  >comment text,</font></div><div><font size="2"  >create_time timestamp(0) not null,&nbsp;</font></div><div><font size="2"  >modify_time timestamp(0) not null,</font></div><div><font size="2"  >unique (value)</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ><br></font></div><div><font size="2"  >insert into idc (id,value,create_time,modify_time)&nbsp;</font></div><div><font size="2"  >&nbsp; values (nextval('seq_pgcloud'::regclass), '德哥的机房', now(), now());</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table server_sort</font></div><div><font size="2"  >(</font></div><div><font size="2"  >id int primary key,</font></div><div><font size="2"  >value text not null,</font></div><div><font size="2"  >comment text,</font></div><div><font size="2"  >create_time timestamp(0) not null,&nbsp;</font></div><div><font size="2"  >modify_time timestamp(0) not null,</font></div><div><font size="2"  >unique (value)</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >insert into server_sort (id,value,create_time,modify_time)&nbsp;</font></div><div><font size="2"  >&nbsp; values (nextval('seq_pgcloud'::regclass), 'database', now(), now());</font></div><div><font size="2"  >insert into server_sort (id,value,create_time,modify_time)&nbsp;</font></div><div><font size="2"  >&nbsp; values (nextval('seq_pgcloud'::regclass), 'pool', now(), now());</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table user_sort</font></div><div><font size="2"  >(</font></div><div><font size="2"  >id int primary key,</font></div><div><font size="2"  >value text not null,</font></div><div><font size="2"  >comment text,</font></div><div><font size="2"  >create_time timestamp(0) not null,&nbsp;</font></div><div><font size="2"  >modify_time timestamp(0) not null,</font></div><div><font size="2"  >unique (value)</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >insert into user_sort (id,value,create_time,modify_time)&nbsp;</font></div><div><font size="2"  >&nbsp; values (nextval('seq_pgcloud'::regclass), 'pgbouncer', now(), now());</font></div><div><font size="2"  >insert into user_sort (id,value,create_time,modify_time)&nbsp;</font></div><div><font size="2"  >&nbsp; values (nextval('seq_pgcloud'::regclass), 'promote', now(), now());</font></div><div><font size="2"  >insert into user_sort (id,value,create_time,modify_time)&nbsp;</font></div><div><font size="2"  >&nbsp; values (nextval('seq_pgcloud'::regclass), 'monitor', now(), now());</font></div><p></p></pre></div><div><br></div><div><br></div><div>-- 服务器信息表</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create table server</font></div><div><font size="2"  >(</font></div><div><font size="2"  >id int primary key,</font></div><div><font size="2"  >virtual boolean not null, -- 是否虚拟IP</font></div><div><font size="2"  >idc text not null references idc (value),</font></div><div><font size="2"  >server_sort text not null references server_sort (value),</font></div><div><font size="2"  >soft_name text not null references soft_name (value),</font></div><div><font size="2"  >soft_ver text not null references soft_ver (value),</font></div><div><font size="2"  >soft_bit text not null references soft_bit (value),</font></div><div><font size="2"  >ip text not null check (check_ip_format(ip) is true),</font></div><div><font size="2"  >cpu_cores int not null,</font></div><div><font size="2"  >mem_gb int not null,</font></div><div><font size="2"  >comment text,</font></div><div><font size="2"  >create_time timestamp(0) not null,</font></div><div><font size="2"  >modify_time timestamp(0) not null,</font></div><div><font size="2"  >unique (idc,ip)</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >insert into server (id, virtual, idc, server_sort, soft_name, soft_ver, soft_bit, ip, cpu_cores, mem_gb, create_time, modify_time)</font></div><div><font size="2"  >&nbsp; values (nextval('seq_pgcloud'::regclass), false, '德哥的机房', 'database', 'RHEL', '5.6', 'x64', '172.16.3.33', 8, 8, now(), now());</font></div><div><font size="2"  >insert into server (id, virtual, idc, server_sort, soft_name, soft_ver, soft_bit, ip, cpu_cores, mem_gb, create_time, modify_time)</font></div><div><font size="2"  >&nbsp; values (nextval('seq_pgcloud'::regclass), false, '德哥的机房', 'database', 'RHEL', '5.6', 'x64', '172.16.3.39', 8, 8, now(), now());</font></div><div><font size="2"  >insert into server (id, virtual, idc, server_sort, soft_name, soft_ver, soft_bit, ip, cpu_cores, mem_gb, create_time, modify_time)</font></div><div><font size="2"  >&nbsp; values (nextval('seq_pgcloud'::regclass), false, '德哥的机房', 'pool', 'RHEL', '5.6', 'x64', '172.16.3.40', 8, 8, now(), now());</font></div><div><font size="2"  >insert into server (id, virtual, idc, server_sort, soft_name, soft_ver, soft_bit, ip, cpu_cores, mem_gb, create_time, modify_time)</font></div><div><font size="2"  >&nbsp; values (nextval('seq_pgcloud'::regclass), false, '德哥的机房', 'pool', 'RHEL', '5.6', 'x64', '172.16.3.150', 8, 8, now(), now());</font></div><div><font size="2"  >insert into server (id, virtual, idc, server_sort, soft_name, soft_ver, soft_bit, ip, cpu_cores, mem_gb, create_time, modify_time)</font></div><div><font size="2"  >&nbsp; values (nextval('seq_pgcloud'::regclass), true, '德哥的机房', 'pool', 'RHEL', '5.6', 'x64', '172.16.3.151', 8, 8, now(), now());</font></div><p></p></pre></div><div><br></div><div>-- 主库表</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create table db_primary</font></div><div><font size="2"  >(</font></div><div><font size="2"  >id int primary key,</font></div><div><font size="2"  >server_id int not null references server(id),</font></div><div><font size="2"  >soft_name text not null references soft_name (value),</font></div><div><font size="2"  >soft_ver text not null references soft_ver (value),</font></div><div><font size="2"  >soft_role text not null references soft_role (value), -- 角色,primary,hot-standby,warm-standby,standby激活后角色改变为primary.</font></div><div><font size="2"  >soft_port int not null,</font></div><div><font size="2"  >priority int not null default 0,</font></div><div><font size="2"  >active boolean default true not null, -- 是否活动,不作为standby激活的判别</font></div><div><font size="2"  >health boolean default true not null, -- 是否健康,primary被检测到不健康后变为false</font></div><div><font size="2"  >trigger_file text not null,</font></div><div><font size="2"  >failedcheck_count int not null default 0, &nbsp;-- 如连续检测到10次failed后,health=false</font></div><div><font size="2"  >comment text,</font></div><div><font size="2"  >create_time timestamp(0) not null,</font></div><div><font size="2"  >modify_time timestamp(0) not null, -- 记录soft_role,active,health的改变时间</font></div><div><font size="2"  >unique (server_id,soft_port)</font></div><div><font size="2"  >);</font></div><p></p></pre></div><div><br></div><div>-- 添加主库函数</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function add_db_primary</font></div><div><font size="2"  >(i_idc text,</font></div><div><font size="2"  >i_server_ip text,</font></div><div><font size="2"  >i_soft_port int,</font></div><div><font size="2"  >i_soft_name text,</font></div><div><font size="2"  >i_soft_ver text,</font></div><div><font size="2"  >i_soft_role text,</font></div><div><font size="2"  >i_active boolean,</font></div><div><font size="2"  >i_health boolean,</font></div><div><font size="2"  >i_trigger_file text,</font></div><div><font size="2"  >i_comment text)</font></div><div><font size="2"  >returns int as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >v_server_sort text;</font></div><div><font size="2"  >v_server_id int;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >v_server_sort := 'database';</font></div><div><font size="2"  >select id into v_server_id from server where idc=i_idc and ip=i_server_ip and server_sort=v_server_sort;</font></div><div><font size="2"  >if not found then</font></div><div><font size="2"  >&nbsp; raise notice 'Server: % with server sort ''%'' not found in idc: %.',i_server_ip,v_server_sort,i_idc;</font></div><div><font size="2"  >&nbsp; raise exception '';</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >insert into db_primary(id, server_id, soft_name, soft_ver, soft_role, soft_port, active, health, trigger_file, comment, create_time, modify_time)</font></div><div><font size="2"  >&nbsp; values(nextval('seq_pgcloud'::regclass), v_server_id, i_soft_name, i_soft_ver, i_soft_role, i_soft_port, i_active, i_health, i_trigger_file, i_comment, now(), now());</font></div><div><font size="2"  >return 0;</font></div><div><font size="2"  >exception</font></div><div><font size="2"  >when others then</font></div><div><font size="2"  >&nbsp; raise notice 'Add db primary in idc: %, server: %, port: % failed, Please check your input.', i_idc, i_server_ip, i_soft_port;</font></div><div><font size="2"  >&nbsp; return 1;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$BODY$ language plpgsql;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >select * from add_db_primary('德哥的机房','172.16.3.33',1921,'PostgreSQL','9.1.1','primary',true,true,'/pgdata/digoal/1921/data01/pg_root/promote.trigger.1921','测试db1');</font></div><div><font size="2"  >select * from add_db_primary('德哥的机房','172.16.3.39',1922,'PostgreSQL','9.1.1','primary',true,true,'/pgdata/digoal/1922/data01/pg_root/promote.trigger.1922','测试db2');</font></div><p></p></pre></div><div><br></div><div>-- 同一个primary的standby中只允许一台角色转换为primary.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function db_standby_role_validator (i_db_primary_id int,i_soft_role text) returns boolean as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >v_standby_role text;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >v_standby_role := 'primary';</font></div><div><font size="2"  >perform 1 from db_standby where db_primary_id=i_db_primary_id and soft_role=v_standby_role limit 1;</font></div><div><font size="2"  >if found then</font></div><div><font size="2"  >&nbsp; if ( i_soft_role = v_standby_role ) then</font></div><div><font size="2"  >&nbsp; &nbsp; return false;</font></div><div><font size="2"  >&nbsp; end if;</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >return true;</font></div><div><font size="2"  >exception</font></div><div><font size="2"  >when others then</font></div><div><font size="2"  >return false;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$BODY$ language plpgsql;</font></div><p></p></pre></div><div><br></div><div>-- 同一个primary的standby中只允许一台被激活.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function db_standby_promote_validator (i_db_primary_id int,i_promote boolean) returns boolean as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >perform 1 from db_standby where db_primary_id=i_db_primary_id and promote=true limit 1;</font></div><div><font size="2"  >if found then</font></div><div><font size="2"  >&nbsp; if ( i_promote = true ) then</font></div><div><font size="2"  >&nbsp; &nbsp; return false;</font></div><div><font size="2"  >&nbsp; end if;</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >return true;</font></div><div><font size="2"  >exception</font></div><div><font size="2"  >when others then</font></div><div><font size="2"  >return false;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$BODY$ language plpgsql;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table db_standby</font></div><div><font size="2"  >(</font></div><div><font size="2"  >id int primary key,</font></div><div><font size="2"  >db_primary_id int not null references db_primary(id),</font></div><div><font size="2"  >priority int not null default 1,</font></div><div><font size="2"  >server_id int not null references server(id),</font></div><div><font size="2"  >soft_name text not null references soft_name (value),</font></div><div><font size="2"  >soft_ver text not null references soft_ver (value),</font></div><div><font size="2"  >soft_role text not null references soft_role (value) check (db_standby_role_validator(db_primary_id,soft_role) is true),</font></div><div><font size="2"  >soft_port int not null,</font></div><div><font size="2"  >active boolean default true not null,</font></div><div><font size="2"  >health boolean default true not null,</font></div><div><font size="2"  >promote boolean default false not null check (db_standby_promote_validator(db_primary_id,promote) is true),</font></div><div><font size="2"  >trigger_file text not null,</font></div><div><font size="2"  >failedcheck_count int not null default 0, &nbsp;-- 如连续检测到10次failed后,health=false</font></div><div><font size="2"  >comment text,</font></div><div><font size="2"  >create_time timestamp(0) not null,</font></div><div><font size="2"  >modify_time timestamp(0) not null,</font></div><div><font size="2"  >unique (server_id,soft_port),</font></div><div><font size="2"  >unique (db_primary_id,priority)</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function add_db_standby</font></div><div><font size="2"  >(i_db_primary_idc text,</font></div><div><font size="2"  >i_db_primary_server_ip text,</font></div><div><font size="2"  >i_db_primary_soft_port int,</font></div><div><font size="2"  >i_priority int,</font></div><div><font size="2"  >i_idc text,</font></div><div><font size="2"  >i_server_ip text,</font></div><div><font size="2"  >i_soft_port int,</font></div><div><font size="2"  >i_soft_name text,</font></div><div><font size="2"  >i_soft_ver text,</font></div><div><font size="2"  >i_soft_role text,</font></div><div><font size="2"  >i_active boolean,</font></div><div><font size="2"  >i_health boolean,</font></div><div><font size="2"  >i_trigger_file text,</font></div><div><font size="2"  >i_comment text)</font></div><div><font size="2"  >returns int as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >v_db_primary_server_id int;</font></div><div><font size="2"  >v_db_primary_id int;</font></div><div><font size="2"  >v_server_sort text;</font></div><div><font size="2"  >v_server_id int;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >v_server_sort := 'database';</font></div><div><font size="2"  >raise notice '1';</font></div><div><font size="2"  >if (i_db_primary_soft_port=i_soft_port and i_db_primary_idc=i_idc and i_db_primary_server_ip=i_server_ip) then</font></div><div><font size="2"  >&nbsp; raise notice 'Primary''s info cann''t equal to standby''s info, Please check your input.';</font></div><div><font size="2"  >&nbsp; raise exception '';</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >raise notice '1';</font></div><div><font size="2"  >select id into v_db_primary_server_id from server where idc=i_db_primary_idc and ip=i_db_primary_server_ip;</font></div><div><font size="2"  >if not found then</font></div><div><font size="2"  >&nbsp; raise notice 'Server: % not found in idc: %.',i_db_primary_server_ip,i_db_primary_idc;</font></div><div><font size="2"  >&nbsp; raise exception '';</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >raise notice '1';</font></div><div><font size="2"  >select id into v_db_primary_id from db_primary where server_id=v_db_primary_server_id and soft_port=i_db_primary_soft_port;</font></div><div><font size="2"  >if not found then</font></div><div><font size="2"  >&nbsp; raise notice 'No db primary on idc: %, server: %, port: %.',i_db_primary_idc,i_db_primary_server_ip,i_db_primary_soft_port;</font></div><div><font size="2"  >&nbsp; raise exception '';</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >raise notice '1';</font></div><div><font size="2"  >select id into v_server_id from server where idc=i_idc and ip=i_server_ip and server_sort=v_server_sort;</font></div><div><font size="2"  >if not found then</font></div><div><font size="2"  >&nbsp; raise notice 'Server: % with server sort ''%'' not found in idc: %.',i_server_ip,v_server_sort,i_idc;</font></div><div><font size="2"  >&nbsp; raise exception '';</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >raise notice '1';</font></div><div><font size="2"  >insert into db_standby(id, db_primary_id, priority, server_id, soft_name, soft_ver, soft_role, soft_port, active, health, trigger_file, comment, create_time, modify_time)</font></div><div><font size="2"  >&nbsp; values(nextval('seq_pgcloud'::regclass), v_db_primary_id, i_priority, v_server_id, i_soft_name, i_soft_ver, i_soft_role, i_soft_port, i_active, i_health, i_trigger_file, i_comment, now(), now());</font></div><div><font size="2"  >return 0;</font></div><div><font size="2"  >exception</font></div><div><font size="2"  >when others then</font></div><div><font size="2"  >&nbsp; raise notice 'Add db standby in idc: %, server: %, port: % failed, Please check your input.', i_idc, i_server_ip, i_soft_port;</font></div><div><font size="2"  >&nbsp; return 1;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$BODY$ language plpgsql;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >select * from add_db_standby('德哥的机房','172.16.3.33',1921,1,'德哥的机房','172.16.3.39',1921,'PostgreSQL','9.1.1','hot-standby',true,true,'/pgdata/digoal/1921/data01/pg_root/promote.trigger.1921','测试db1-standby');</font></div><div><font size="2"  >select * from add_db_standby('德哥的机房','172.16.3.39',1922,1,'德哥的机房','172.16.3.33',1922,'PostgreSQL','9.1.1','hot-standby',true,true,'/pgdata/digoal/1922/data01/pg_root/promote.trigger.1922','测试db2-standby');</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function db_primary_poolcfg_validator(i_config text,i_db_primary_id int) returns boolean as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >v_ip_config text;</font></div><div><font size="2"  >v_ip_server text;</font></div><div><font size="2"  >v_port_config text;</font></div><div><font size="2"  >v_port_db_primary text;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >v_ip_config := substring(lower(i_config) from ' host *= *(\d+\.\d+\.\d+\.\d+) ');</font></div><div><font size="2"  >select ip into v_ip_server from server where id=(select server_id from db_primary where id=i_db_primary_id);</font></div><div><font size="2"  >v_port_config := substring(lower(i_config) from ' port=(\d+)');</font></div><div><font size="2"  >select soft_port into v_port_db_primary from db_primary where id=i_db_primary_id;</font></div><div><font size="2"  >if ( v_ip_config = v_ip_server and v_port_config = v_port_db_primary ) then</font></div><div><font size="2"  >return true;</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >return fasle;</font></div><div><font size="2"  >exception</font></div><div><font size="2"  >when others then</font></div><div><font size="2"  >return false;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$BODY$ language plpgsql;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table db_primary_poolcfg</font></div><div><font size="2"  >(</font></div><div><font size="2"  >id int primary key,</font></div><div><font size="2"  >db_primary_id int not null references db_primary(id),</font></div><div><font size="2"  >soft_name text not null references soft_name (value),</font></div><div><font size="2"  >soft_ver text not null references soft_ver (value),</font></div><div><font size="2"  >config_db_part text not null check(db_primary_poolcfg_validator(config_db_part,db_primary_id) is true),</font></div><div><font size="2"  >config_pool_part text not null,</font></div><div><font size="2"  >ver int not null check(ver&gt;0),</font></div><div><font size="2"  >comment text,</font></div><div><font size="2"  >create_time timestamp(0) not null,</font></div><div><font size="2"  >modify_time timestamp(0) not null,</font></div><div><font size="2"  >unique (db_primary_id)</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function add_db_primary_poolcfg</font></div><div><font size="2"  >(i_db_primary_idc text,</font></div><div><font size="2"  >i_db_primary_server_ip text,</font></div><div><font size="2"  >i_db_primary_soft_port int,</font></div><div><font size="2"  >i_soft_name text,</font></div><div><font size="2"  >i_soft_ver text,</font></div><div><font size="2"  >i_config_db_part text,</font></div><div><font size="2"  >i_config_pool_part text,</font></div><div><font size="2"  >i_ver int,</font></div><div><font size="2"  >i_comment text)</font></div><div><font size="2"  >returns int as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >v_db_primary_server_id int;</font></div><div><font size="2"  >v_db_primary_id int;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >select id into v_db_primary_server_id from server where idc=i_db_primary_idc and ip=i_db_primary_server_ip;</font></div><div><font size="2"  >if not found then</font></div><div><font size="2"  >&nbsp; raise notice 'Server: % not found in idc: %.',i_db_primary_server_ip,i_db_primary_idc;</font></div><div><font size="2"  >&nbsp; raise exception '';</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >select id into v_db_primary_id from db_primary where server_id=v_db_primary_server_id and soft_port=i_db_primary_soft_port;</font></div><div><font size="2"  >if not found then</font></div><div><font size="2"  >&nbsp; raise notice 'No db primary on idc: %, server: %, port: %.',i_db_primary_idc,i_db_primary_server_ip,i_db_primary_soft_port;</font></div><div><font size="2"  >&nbsp; raise exception '';</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >insert into db_primary_poolcfg(id, db_primary_id, soft_name, soft_ver, config_db_part, config_pool_part, ver, comment, create_time, modify_time)</font></div><div><font size="2"  >&nbsp; values(nextval('seq_pgcloud'::regclass), v_db_primary_id, i_soft_name, i_soft_ver, i_config_db_part, i_config_pool_part, i_ver, i_comment, now(), now());</font></div><div><font size="2"  >return 0;</font></div><div><font size="2"  >exception</font></div><div><font size="2"  >when others then</font></div><div><font size="2"  >&nbsp; raise notice 'Add poolcfg with db idc: %, server: %, port: % failed, Please check your input.', i_db_primary_idc, i_db_primary_server_ip, i_db_primary_soft_port;</font></div><div><font size="2"  >&nbsp; return 1;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$BODY$ language plpgsql;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >select * from add_db_primary_poolcfg('德哥的机房','172.16.3.33',1921,'pgbouncer','1.4.2','[databases]</font></div><div><font size="2"  >digoal = host=172.16.3.33 dbname=digoal port=1921 pool_size=8',</font></div><div><font size="2"  >'[pgbouncer]</font></div><div><font size="2"  >pool_mode = transaction</font></div><div><font size="2"  >listen_port = replace_by_port</font></div><div><font size="2"  >unix_socket_dir = /opt/pgbouncer/etc</font></div><div><font size="2"  >listen_addr = *</font></div><div><font size="2"  >auth_type = md5</font></div><div><font size="2"  >auth_file = /opt/pgbouncer/etc/users.txt.replace_by_port</font></div><div><font size="2"  >logfile = /dev/null</font></div><div><font size="2"  >pidfile = /opt/pgbouncer/etc/pgbouncer.pid.replace_by_port</font></div><div><font size="2"  >max_client_conn = 10000</font></div><div><font size="2"  >reserve_pool_timeout = 0</font></div><div><font size="2"  >server_reset_query =</font></div><div><font size="2"  >admin_users = pgbouncer_admin</font></div><div><font size="2"  >stats_users = pgbouncer_guest</font></div><div><font size="2"  >ignore_startup_parameters = extra_float_digits</font></div><div><font size="2"  >tcp_keepalive = 1</font></div><div><font size="2"  >tcp_keepidle = 30</font></div><div><font size="2"  >tcp_keepcnt = 3</font></div><div><font size="2"  >tcp_keepintvl = 5',1,'测试db1连接池配置');</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >select * from add_db_primary_poolcfg('德哥的机房','172.16.3.39',1922,'pgbouncer','1.4.2','[databases]</font></div><div><font size="2"  >digoal = host=172.16.3.39 dbname=digoal port=1922 pool_size=8',</font></div><div><font size="2"  >'[pgbouncer]</font></div><div><font size="2"  >pool_mode = transaction</font></div><div><font size="2"  >listen_port = replace_by_port</font></div><div><font size="2"  >unix_socket_dir = /opt/pgbouncer/etc</font></div><div><font size="2"  >listen_addr = *</font></div><div><font size="2"  >auth_type = md5</font></div><div><font size="2"  >auth_file = /opt/pgbouncer/etc/users.txt.replace_by_port</font></div><div><font size="2"  >logfile = /dev/null</font></div><div><font size="2"  >pidfile = /opt/pgbouncer/etc/pgbouncer.pid.replace_by_port</font></div><div><font size="2"  >max_client_conn = 10000</font></div><div><font size="2"  >reserve_pool_timeout = 0</font></div><div><font size="2"  >server_reset_query =</font></div><div><font size="2"  >admin_users = pgbouncer_admin</font></div><div><font size="2"  >stats_users = pgbouncer_guest</font></div><div><font size="2"  >ignore_startup_parameters = extra_float_digits</font></div><div><font size="2"  >tcp_keepalive = 1</font></div><div><font size="2"  >tcp_keepidle = 30</font></div><div><font size="2"  >tcp_keepcnt = 3</font></div><div><font size="2"  >tcp_keepintvl = 5',1,'测试db2连接池配置');</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function db_standby_poolcfg_validator(i_config text,i_db_standby_id int) returns boolean as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >v_ip_config text;</font></div><div><font size="2"  >v_ip_server text;</font></div><div><font size="2"  >v_port_config text;</font></div><div><font size="2"  >v_port_db_standby text;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >v_ip_config := substring(lower(i_config) from ' host *= *(\d+\.\d+\.\d+\.\d+) ');</font></div><div><font size="2"  >select ip into v_ip_server from server where id=(select server_id from db_standby where id=i_db_standby_id);</font></div><div><font size="2"  >v_port_config := substring(lower(i_config) from ' port=(\d+)');</font></div><div><font size="2"  >select soft_port into v_port_db_standby from db_standby where id=i_db_standby_id;</font></div><div><font size="2"  >if ( v_ip_config = v_ip_server and v_port_config = v_port_db_standby ) then</font></div><div><font size="2"  >return true;</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >return fasle;</font></div><div><font size="2"  >exception</font></div><div><font size="2"  >when others then</font></div><div><font size="2"  >return false;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$BODY$ language plpgsql;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table db_standby_poolcfg</font></div><div><font size="2"  >(</font></div><div><font size="2"  >id int primary key,</font></div><div><font size="2"  >db_standby_id int not null references db_standby(id),</font></div><div><font size="2"  >soft_name text not null references soft_name (value),</font></div><div><font size="2"  >soft_ver text not null references soft_ver (value),</font></div><div><font size="2"  >config_db_part text not null check(db_standby_poolcfg_validator(config_db_part,db_standby_id) is true),</font></div><div><font size="2"  >ver int not null check(ver&gt;0),</font></div><div><font size="2"  >comment text,</font></div><div><font size="2"  >create_time timestamp(0) not null,</font></div><div><font size="2"  >modify_time timestamp(0) not null,</font></div><div><font size="2"  >unique (db_standby_id)</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function add_db_standby_poolcfg</font></div><div><font size="2"  >(i_db_standby_idc text,</font></div><div><font size="2"  >i_db_standby_server_ip text,</font></div><div><font size="2"  >i_db_standby_soft_port int,</font></div><div><font size="2"  >i_soft_name text,</font></div><div><font size="2"  >i_soft_ver text,</font></div><div><font size="2"  >i_config_db_part text,</font></div><div><font size="2"  >i_ver int,</font></div><div><font size="2"  >i_comment text)</font></div><div><font size="2"  >returns int as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >v_db_standby_server_id int;</font></div><div><font size="2"  >v_db_standby_id int;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >select id into v_db_standby_server_id from server where idc=i_db_standby_idc and ip=i_db_standby_server_ip;</font></div><div><font size="2"  >if not found then</font></div><div><font size="2"  >&nbsp; raise notice 'Server: % not found in idc: %.',i_db_standby_server_ip,i_db_standby_idc;</font></div><div><font size="2"  >&nbsp; raise exception '';</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >select id into v_db_standby_id from db_standby where server_id=v_db_standby_server_id and soft_port=i_db_standby_soft_port;</font></div><div><font size="2"  >if not found then</font></div><div><font size="2"  >&nbsp; raise notice 'No db standby on idc: %, server: %, port: %.',i_db_standby_idc,i_db_standby_server_ip,i_db_standby_soft_port;</font></div><div><font size="2"  >&nbsp; raise exception '';</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >insert into db_standby_poolcfg(id, db_standby_id, soft_name, soft_ver, config_db_part, ver, comment, create_time, modify_time)</font></div><div><font size="2"  >&nbsp; values(nextval('seq_pgcloud'::regclass), v_db_standby_id, i_soft_name, i_soft_ver, i_config_db_part, i_ver, i_comment, now(), now());</font></div><div><font size="2"  >return 0;</font></div><div><font size="2"  >exception</font></div><div><font size="2"  >when others then</font></div><div><font size="2"  >&nbsp; raise notice 'Add poolcfg with db idc: %, server: %, port: % failed, Please check your input.', i_db_standby_idc, i_db_standby_server_ip, i_db_standby_soft_port;</font></div><div><font size="2"  >&nbsp; return 1;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$BODY$ language plpgsql;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >select * from add_db_standby_poolcfg('德哥的机房','172.16.3.33',1922,'pgbouncer','1.4.2','[databases]</font></div><div><font size="2"  >digoal = host=172.16.3.33 dbname=digoal port=1922 pool_size=8',1,'测试db2-standby连接池配置');</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >select * from add_db_standby_poolcfg('德哥的机房','172.16.3.39',1921,'pgbouncer','1.4.2','[databases]</font></div><div><font size="2"  >digoal = host=172.16.3.39 dbname=digoal port=1921 pool_size=8',1,'测试db1-standby连接池配置');</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function check_pool_ha_ip (i_ip text) returns boolean as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >v_server_sort text;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >v_server_sort := 'pool';</font></div><div><font size="2"  >perform 1 from server where ip=i_ip and server_sort=v_server_sort;</font></div><div><font size="2"  >if found then</font></div><div><font size="2"  >return true;</font></div><div><font size="2"  >else</font></div><div><font size="2"  >return false;</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >exception</font></div><div><font size="2"  >when others then</font></div><div><font size="2"  >return false;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$BODY$ language plpgsql;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table pool_ha_cfg</font></div><div><font size="2"  >(</font></div><div><font size="2"  >id int primary key,</font></div><div><font size="2"  >ha_name text not null references pool_ha_name (value),</font></div><div><font size="2"  >idc text not null references idc (value),</font></div><div><font size="2"  >ip text not null check (check_ip_format(ip) is true and check_pool_ha_ip(ip) is true), &nbsp;-- 必须包含VIP</font></div><div><font size="2"  >comment text,</font></div><div><font size="2"  >create_time timestamp(0) not null,</font></div><div><font size="2"  >modify_time timestamp(0) not null,</font></div><div><font size="2"  >unique (ip)</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >insert into pool_ha_cfg (id,ha_name,idc,ip,comment,create_time,modify_time)</font></div><div><font size="2"  >&nbsp; values (nextval('seq_pgcloud'::regclass), '德哥的pgbouncer测试集群1', '德哥的机房', '172.16.3.40', '德哥的pgbouncer测试集群1物理主机1', now(), now());</font></div><div><font size="2"  >insert into pool_ha_cfg (id,ha_name,idc,ip,comment,create_time,modify_time)</font></div><div><font size="2"  >&nbsp; values (nextval('seq_pgcloud'::regclass), '德哥的pgbouncer测试集群1', '德哥的机房', '172.16.3.150', '德哥的pgbouncer测试集群1物理主机2', now(), now());</font></div><div><font size="2"  >insert into pool_ha_cfg (id,ha_name,idc,ip,comment,create_time,modify_time)</font></div><div><font size="2"  >&nbsp; values (nextval('seq_pgcloud'::regclass), '德哥的pgbouncer测试集群1', '德哥的机房', '172.16.3.151', '德哥的pgbouncer测试集群1虚拟IP1', now(), now());</font></div><p></p></pre></div><div><br></div><div>-- 所有的连接池必须注册再使用</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create table registered_pool</font></div><div><font size="2"  >(</font></div><div><font size="2"  >id int primary key,</font></div><div><font size="2"  >server_id int not null references server(id), &nbsp;-- 连接池所在服务器</font></div><div><font size="2"  >db_primary_id int not null references db_primary(id), &nbsp;-- 连接池对应的主库,主库异常自动切到备库</font></div><div><font size="2"  >soft_name text not null references soft_name (value),</font></div><div><font size="2"  >soft_ver text not null references soft_ver (value),</font></div><div><font size="2"  >port int not null, &nbsp;-- 连接池监听端口</font></div><div><font size="2"  >comment text,</font></div><div><font size="2"  >create_time timestamp(0) not null,</font></div><div><font size="2"  >modify_time timestamp(0) not null,</font></div><div><font size="2"  >unique (server_id,db_primary_id),</font></div><div><font size="2"  >unique (server_id,port)</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function add_registered_pool</font></div><div><font size="2"  >(</font></div><div><font size="2"  >i_db_primary_idc text,</font></div><div><font size="2"  >i_db_primary_server_ip text,</font></div><div><font size="2"  >i_db_primary_soft_port int,</font></div><div><font size="2"  >i_idc text,</font></div><div><font size="2"  >i_server_ip text,</font></div><div><font size="2"  >i_port int,</font></div><div><font size="2"  >i_soft_name text,</font></div><div><font size="2"  >i_soft_ver text,</font></div><div><font size="2"  >i_comment text)</font></div><div><font size="2"  >returns int as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >v_db_primary_server_id int;</font></div><div><font size="2"  >v_db_primary_id int;</font></div><div><font size="2"  >v_server_sort text;</font></div><div><font size="2"  >v_server_id int;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >v_server_sort := 'pool';</font></div><p></p></pre></div><div>-- 检查要注册的池是否在已经加入到池的HA</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >perform 1 from pool_ha_cfg where ip=i_server_ip;</font></div><div><font size="2"  >if not found then</font></div><div><font size="2"  >&nbsp; raise notice 'Ip: % not found in pool_ha_cfg, please check.',i_server_ip;</font></div><div><font size="2"  >&nbsp; raise exception '';</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >select id into v_db_primary_server_id from server where idc=i_db_primary_idc and ip=i_db_primary_server_ip;</font></div><div><font size="2"  >if not found then</font></div><div><font size="2"  >&nbsp; raise notice 'Server: % not found in idc: %.',i_db_primary_server_ip,i_db_primary_idc;</font></div><div><font size="2"  >&nbsp; raise exception '';</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >select id into v_db_primary_id from db_primary where server_id=v_db_primary_server_id and soft_port=i_db_primary_soft_port;</font></div><div><font size="2"  >if not found then</font></div><div><font size="2"  >&nbsp; raise notice 'No db primary on idc: %, server: %, port: %.',i_db_primary_idc,i_db_primary_server_ip,i_db_primary_soft_port;</font></div><div><font size="2"  >&nbsp; raise exception '';</font></div><div><font size="2"  >end if;</font></div><p></p></pre></div><div>-- 连接同一主库的连接池监听端口必须一致</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >perform db_primary_id,count(distinct port) from (select db_primary_id,port from registered_pool union all select v_db_primary_id as db_primary_id,i_port as port) t group by db_primary_id having count(distinct port) &gt; 1;</font></div><div><font size="2"  >if found then</font></div><div><font size="2"  >&nbsp; raise notice '连接同一主库的连接池监听端口必须一致.';</font></div><div><font size="2"  >&nbsp; raise exception '';</font></div><div><font size="2"  >end if;</font></div><p></p></pre></div><div>-- 连接同一主库的连接池所在的服务器必须在同一POOL_HA</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >perform count(distinct ha_name) from pool_ha_cfg where&nbsp;</font></div><div><font size="2"  >(idc,ip) in (select i_idc as idc,i_server_ip as ip union all select idc,ip from server where id in (select server_id from registered_pool where db_primary_id=v_db_primary_id)) having count(distinct ha_name) &gt; 1;</font></div><div><font size="2"  >if found then</font></div><div><font size="2"  >&nbsp; raise notice '连接同一主库的连接池所在的服务器必须在同一POOL_HA.';</font></div><div><font size="2"  >&nbsp; raise exception '';</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >select id into v_server_id from server where idc=i_idc and ip=i_server_ip and server_sort=v_server_sort;</font></div><div><font size="2"  >if not found then</font></div><div><font size="2"  >&nbsp; raise notice 'Server: % with server sort ''pool'' not found in idc: %.',i_server_ip,i_idc;</font></div><div><font size="2"  >&nbsp; raise exception '';</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >insert into registered_pool(id, server_id, db_primary_id, soft_name, soft_ver, port, comment, create_time, modify_time)</font></div><div><font size="2"  >&nbsp; values(nextval('seq_pgcloud'::regclass), v_server_id, v_db_primary_id, i_soft_name, i_soft_ver, i_port, i_comment, now(), now());</font></div><div><font size="2"  >return 0;</font></div><div><font size="2"  >exception</font></div><div><font size="2"  >when others then</font></div><div><font size="2"  >&nbsp; raise notice 'Add registered pool to idc: %, server: % with db primary idc: %, server: %, port: % failed, Please check your input.', i_idc, i_server_ip, i_db_primary_idc, i_db_primary_server_ip, i_db_primary_soft_port;</font></div><div><font size="2"  >&nbsp; return 1;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$BODY$ language plpgsql;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >select * from add_registered_pool('德哥的机房','172.16.3.33',1921,'德哥的机房','172.16.3.40',1921,'pgbouncer','1.4.2','测试db1连接池');</font></div><div><font size="2"  >select * from add_registered_pool('德哥的机房','172.16.3.39',1922,'德哥的机房','172.16.3.40',1922,'pgbouncer','1.4.2','测试db1连接池');</font></div><div><font size="2"  >select * from add_registered_pool('德哥的机房','172.16.3.33',1921,'德哥的机房','172.16.3.150',1921,'pgbouncer','1.4.2','测试db2连接池');</font></div><div><font size="2"  >select * from add_registered_pool('德哥的机房','172.16.3.39',1922,'德哥的机房','172.16.3.150',1922,'pgbouncer','1.4.2','测试db2连接池');</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function check_password (i_user_sort text,i_password text) returns boolean as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >v_user_sort text;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >v_user_sort := 'pgbouncer';</font></div><div><font size="2"  >if ( i_user_sort = v_user_sort ) then</font></div><div><font size="2"  >if ( substring(i_password,1,3) &lt;&gt; 'md5' or char_length(i_password)&lt;&gt;35 ) then</font></div><div><font size="2"  >&nbsp; raise notice 'Password: % must from pg_shadow.passwd',i_password;</font></div><div><font size="2"  >&nbsp; raise exception '';</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >return true;</font></div><div><font size="2"  >exception</font></div><div><font size="2"  >when others then</font></div><div><font size="2"  >return false;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$BODY$ language plpgsql;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table db_primary_usercfg</font></div><div><font size="2"  >(</font></div><div><font size="2"  >id int primary key,</font></div><div><font size="2"  >db_primary_id int not null references db_primary(id),</font></div><div><font size="2"  >user_sort text not null references user_sort (value),</font></div><div><font size="2"  >username text not null,</font></div><div><font size="2"  >password text not null check(check_password(user_sort,password) is true),</font></div><div><font size="2"  >create_time timestamp(0) not null,</font></div><div><font size="2"  >modify_time timestamp(0) not null,</font></div><div><font size="2"  >unique (db_primary_id,user_sort,username)</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function add_db_primary_usercfg</font></div><div><font size="2"  >(i_db_primary_idc text,</font></div><div><font size="2"  >i_db_primary_server_ip text,</font></div><div><font size="2"  >i_db_primary_soft_port int,</font></div><div><font size="2"  >i_user_sort text,</font></div><div><font size="2"  >i_username text,</font></div><div><font size="2"  >i_password text)</font></div><div><font size="2"  >returns int as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >v_db_primary_server_id int;</font></div><div><font size="2"  >v_db_primary_id int;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >select id into v_db_primary_server_id from server where idc=i_db_primary_idc and ip=i_db_primary_server_ip;</font></div><div><font size="2"  >if not found then</font></div><div><font size="2"  >&nbsp; raise notice 'Server: % not found in idc: %.',i_db_primary_server_ip,i_db_primary_idc;</font></div><div><font size="2"  >&nbsp; raise exception '';</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >select id into v_db_primary_id from db_primary where server_id=v_db_primary_server_id and soft_port=i_db_primary_soft_port;</font></div><div><font size="2"  >if not found then</font></div><div><font size="2"  >&nbsp; raise notice 'No db primary on idc: %, server: %, port: %.',i_db_primary_idc,i_db_primary_server_ip,i_db_primary_soft_port;</font></div><div><font size="2"  >&nbsp; raise exception '';</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >update db_primary_poolcfg set ver=ver+1 where db_primary_id=v_db_primary_id;</font></div><div><font size="2"  >update db_standby_poolcfg set ver=ver+1 where db_standby_id in (select id from db_standby where db_primary_id=v_db_primary_id);</font></div><div><font size="2"  >insert into db_primary_usercfg(id, db_primary_id, user_sort, username, password, create_time, modify_time)</font></div><div><font size="2"  >&nbsp; values(nextval('seq_pgcloud'::regclass), v_db_primary_id, i_user_sort, i_username, i_password, now(), now());</font></div><div><font size="2"  >return 0;</font></div><div><font size="2"  >exception</font></div><div><font size="2"  >when others then</font></div><div><font size="2"  >&nbsp; raise notice 'Add usercfg with db primary idc: %, server: %, port: % failed, Please check your input.', i_db_primary_idc, i_db_primary_server_ip, i_db_primary_soft_port;</font></div><div><font size="2"  >&nbsp; return 1;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$BODY$ language plpgsql;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >select * from add_db_primary_usercfg('德哥的机房','172.16.3.33',1921,'pgbouncer','digoal','md5462f71c79368ccf422f8a773ef40074d');</font></div><div><font size="2"  >select * from add_db_primary_usercfg('德哥的机房','172.16.3.39',1922,'pgbouncer','digoal','md5462f71c79368ccf422f8a773ef40074d');</font></div><div><font size="2"  >select * from add_db_primary_usercfg('德哥的机房','172.16.3.33',1921,'promote','promote','md5c43b2a66ef200d4bf5072465a161fea');</font></div><div><font size="2"  >select * from add_db_primary_usercfg('德哥的机房','172.16.3.39',1922,'promote','promote','md5c43b2a66ef200d4bf5072465a161fea');</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table department</font></div><div><font size="2"  >(</font></div><div><font size="2"  >id int primary key,</font></div><div><font size="2"  >part_name text not null,</font></div><div><font size="2"  >up_id int references department(id),</font></div><div><font size="2"  >comment text,</font></div><div><font size="2"  >create_time timestamp(0) not null,</font></div><div><font size="2"  >modify_time timestamp(0) not null,</font></div><div><font size="2"  >unique (part_name)</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function add_department(i_part_name text, i_up_part_name text, i_comment text)</font></div><div><font size="2"  >returns int as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >v_up_id int;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >if i_up_part_name is not null then</font></div><div><font size="2"  >select id into v_up_id from department where part_name=i_up_part_name;</font></div><div><font size="2"  >if not found then</font></div><div><font size="2"  >&nbsp; raise notice 'The up_department: % of department: % not found, Please check, If the department: % no up_department, Please keep i_up_part_name''s value to null.',i_up_part_name,i_part_name,i_part_name;</font></div><div><font size="2"  >&nbsp; raise exception '';</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >insert into department(id, part_name, up_id, comment, create_time, modify_time)</font></div><div><font size="2"  >&nbsp; values(nextval('seq_pgcloud'::regclass), i_part_name, v_up_id, i_comment, now(), now());</font></div><div><font size="2"  >return 0;</font></div><div><font size="2"  >exception</font></div><div><font size="2"  >when others then</font></div><div><font size="2"  >&nbsp; raise notice 'Add department: % failed, Please check your input.',i_part_name;</font></div><div><font size="2"  >&nbsp; return 1;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$BODY$ language plpgsql;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >select * from add_department('研发中心',null,'研发,质量,运维,测试,客服,产品运营');</font></div><div><font size="2"  >select * from add_department('质量运维部','研发中心','质量,运维,测试,客服');</font></div><div><font size="2"  >select * from add_department('运维部','质量运维部','服务器,存储,网络,业务,数据库运维');</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table cluster</font></div><div><font size="2"  >(</font></div><div><font size="2"  >id int primary key,</font></div><div><font size="2"  >alias text not null,</font></div><div><font size="2"  >department_id int not null references department(id),</font></div><div><font size="2"  >db_primary_id int not null references db_primary(id),</font></div><div><font size="2"  >comment text not null,</font></div><div><font size="2"  >create_time timestamp(0) not null,</font></div><div><font size="2"  >modify_time timestamp(0) not null,</font></div><div><font size="2"  >unique (alias)</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function add_cluster</font></div><div><font size="2"  >(i_alias text, i_department_name text, i_db_primary_idc text, i_db_primary_ip text, i_db_primary_port int, i_comment text)</font></div><div><font size="2"  >returns int as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >v_department_id int;</font></div><div><font size="2"  >v_db_primary_server_id int;</font></div><div><font size="2"  >v_db_primary_id int;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >select id into v_department_id from department where part_name=i_department_name;</font></div><div><font size="2"  >if not found then</font></div><div><font size="2"  >&nbsp; raise notice 'Department: % not found.',i_department_name;</font></div><div><font size="2"  >&nbsp; raise exception '';</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >select id into v_db_primary_server_id from server where idc=i_db_primary_idc and ip=i_db_primary_ip;</font></div><div><font size="2"  >if not found then</font></div><div><font size="2"  >&nbsp; raise notice 'Server: % not in idc: %.',i_db_primary_ip,i_db_primary_idc;</font></div><div><font size="2"  >&nbsp; raise exception '';</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >select id into v_db_primary_id from db_primary where server_id=v_db_primary_server_id and soft_port=i_db_primary_port;</font></div><div><font size="2"  >if not found then</font></div><div><font size="2"  >&nbsp; raise notice 'No db primary on idc: %, server: %, port: %.',i_db_primary_idc,i_db_primary_ip,i_db_primary_port;</font></div><div><font size="2"  >&nbsp; raise exception '';</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >insert into cluster(id, alias, department_id, db_primary_id, comment, create_time, modify_time)</font></div><div><font size="2"  >&nbsp; values(nextval('seq_pgcloud'::regclass), i_alias, v_department_id, v_db_primary_id, i_comment, now(), now());</font></div><div><font size="2"  >return 0;</font></div><div><font size="2"  >exception</font></div><div><font size="2"  >when others then</font></div><div><font size="2"  >&nbsp; raise notice 'Add cluster: % failed, Please check your input.',i_alias;</font></div><div><font size="2"  >&nbsp; return 1;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$BODY$ language plpgsql;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >select * from add_cluster('digoal1','运维部','德哥的机房','172.16.3.33',1921,'pgcloud测试');</font></div><div><font size="2"  >select * from add_cluster('digoal2','运维部','德哥的机房','172.16.3.39',1922,'pgcloud测试');</font></div><p></p></pre></div><div><br></div><div>-- 黑名单,在黑名单中的ID不响应promote,check,failback等操作.</div><div>-- 例如需要手工维护一个数据库时,可能会用到.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create table db_primary_black</font></div><div><font size="2"  >(</font></div><div><font size="2"  >id int primary key,</font></div><div><font size="2"  >db_primary_id int not null references db_primary(id),</font></div><div><font size="2"  >comment text,</font></div><div><font size="2"  >create_time timestamp(0) not null,</font></div><div><font size="2"  >unique (db_primary_id)</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table db_standby_black</font></div><div><font size="2"  >(</font></div><div><font size="2"  >id int primary key,</font></div><div><font size="2"  >db_standby_id int not null references db_standby(id),</font></div><div><font size="2"  >comment text,</font></div><div><font size="2"  >create_time timestamp(0) not null,</font></div><div><font size="2"  >unique (db_standby_id)</font></div><div><font size="2"  >);</font></div><p></p></pre></div><div><br></div><div>-- pgcloud库添加dblink extension.</div><div><br></div><div>-- pgbouncer服务器上需要知道配置是否需要更新,从版本和ID来判断.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function get_poolcfg_ver</font></div><div><font size="2"  >(i_idc text, -- registered_pool中对应的server_id的idc</font></div><div><font size="2"  >i_ip text, -- registered_pool中对应的server_id的ip</font></div><div><font size="2"  >i_port int, -- registered_pool中的port</font></div><div><font size="2"  >out o_id int,&nbsp;</font></div><div><font size="2"  >out o_ver int)</font></div><div><font size="2"  >as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >v_soft_role text;</font></div><div><font size="2"  >v_db_primary_id int;</font></div><div><font size="2"  >v_server_id int;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >o_id := 999999;</font></div><div><font size="2"  >o_ver := 999999;</font></div><div><font size="2"  >v_soft_role := 'primary';</font></div><div><font size="2"  >select id into v_server_id from server where idc=i_idc and ip=i_ip;</font></div><div><font size="2"  >select db_primary_id into v_db_primary_id from registered_pool where server_id=v_server_id and port=i_port;</font></div><div><font size="2"  >perform 1 from db_primary where id=v_db_primary_id and active=true and health=true and soft_role=v_soft_role;</font></div><div><font size="2"  >if found then</font></div><div><font size="2"  >&nbsp; select id,ver into o_id,o_ver from db_primary_poolcfg where db_primary_id = v_db_primary_id;</font></div><div><font size="2"  >&nbsp; return;</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >perform 1 from db_standby where db_primary_id=v_db_primary_id and soft_role=v_soft_role and active=true and health=true limit 1;</font></div><div><font size="2"  >if found then</font></div><div><font size="2"  >&nbsp; select id,ver into o_id,o_ver from db_standby_poolcfg where db_standby_id = (select id from db_standby where db_primary_id=v_db_primary_id and soft_role=v_soft_role and active=true and health=true order by priority limit 1);</font></div><div><font size="2"  >&nbsp; return;</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >o_id := 999999;</font></div><div><font size="2"  >o_ver := 999999;</font></div><div><font size="2"  >return;</font></div><div><font size="2"  >exception</font></div><div><font size="2"  >when others then</font></div><div><font size="2"  >raise notice 'Get poolcfg ver error.';</font></div><div><font size="2"  >o_id := 999999;</font></div><div><font size="2"  >o_ver := 999999;</font></div><div><font size="2"  >return;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$BODY$ language plpgsql;</font></div><p></p></pre></div><div><br></div><div>-- psql -q -A -t -h 127.0.0.1 -p 1921 -U pgcloud pgcloud -c "select 'ID'||o_id||'VER'||o_ver from get_poolcfg_ver('德哥的机房','172.16.3.40',1923)"</div><div>-- 如果结果为ID999999VER999999或者与本地保存的信息一致,则不更新配置,</div><div><br></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function promote_standby&nbsp;</font></div><div><font size="2"  >(i_db_standby_id int, OUT o_result int) as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >v_ip text;</font></div><div><font size="2"  >v_port int;</font></div><div><font size="2"  >v_dbname text;</font></div><div><font size="2"  >v_user text;</font></div><div><font size="2"  >v_password text;</font></div><div><font size="2"  >v_trigger_file text;</font></div><div><font size="2"  >v_db_primary_id int;</font></div><div><font size="2"  >v_promote_sql text;</font></div><div><font size="2"  >v_sql text;</font></div><div><font size="2"  >v_user_sort text;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >o_result := 1;</font></div><div><font size="2"  >v_dbname := 'promote';</font></div><div><font size="2"  >v_user_sort := 'promote';</font></div><div><font size="2"  >perform 1 from db_standby_black where db_standby_id = i_db_standby_id;</font></div><div><font size="2"  >if found then</font></div><div><font size="2"  >&nbsp; raise notice 'The db standby: % in black.',i_db_standby_id;</font></div><div><font size="2"  >&nbsp; raise exception '';</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >select trigger_file,soft_port,db_primary_id into v_trigger_file,v_port,v_db_primary_id from db_standby where id=i_db_standby_id;</font></div><div><font size="2"  >if not found then</font></div><div><font size="2"  >&nbsp; raise notice 'The db standby: % not found.',i_db_standby_id;</font></div><div><font size="2"  >&nbsp; raise exception '';</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >select username,password into v_user,v_password from db_primary_usercfg where db_primary_id=v_db_primary_id and user_sort=v_user_sort limit 1;</font></div><div><font size="2"  >select ip into v_ip from server where id=(select server_id from db_standby where id=i_db_standby_id);</font></div><div><font size="2"  >v_promote_sql := 'copy (select now()) to '''''||v_trigger_file||'''''';</font></div><div><font size="2"  >v_sql := 'select dblink_exec(''hostaddr='||v_ip||' port='||v_port||' dbname='||v_dbname||' user='||v_user||' password='||v_password||''','''||v_promote_sql||''',true)';</font></div><div><font size="2"  >raise notice 'v_sql: %, v_promote_sql: % .', v_sql, v_promote_sql;</font></div><div><font size="2"  >execute v_sql;</font></div><div><font size="2"  >o_result := 0;</font></div><div><font size="2"  >return;</font></div><div><font size="2"  >exception</font></div><div><font size="2"  >when others then</font></div><div><font size="2"  >&nbsp; raise notice 'Promote db standby % failed.',i_db_standby_id;</font></div><div><font size="2"  >&nbsp; o_result := 1;</font></div><div><font size="2"  >&nbsp; return;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$BODY$ language plpgsql;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function check_db_primary</font></div><div><font size="2"  >(</font></div><div><font size="2"  >i_primary_id int,</font></div><div><font size="2"  >OUT o_result int</font></div><div><font size="2"  >) as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >v_failedcheck_count_health_max int;</font></div><div><font size="2"  >v_failedcheck_count_active_max int;</font></div><div><font size="2"  >v_failedcheck_count int;</font></div><div><font size="2"  >v_idc text;</font></div><div><font size="2"  >v_ip text;</font></div><div><font size="2"  >v_port int;</font></div><div><font size="2"  >v_username text;</font></div><div><font size="2"  >v_password text;</font></div><div><font size="2"  >v_dbname text;</font></div><div><font size="2"  >v_user_sort text;</font></div><div><font size="2"  >v_sql text;</font></div><div><font size="2"  >v_check_sql text;</font></div><div><font size="2"  >v_result text;</font></div><div><font size="2"  >v_promote_result int;</font></div><div><font size="2"  >v_db_standby_role text;</font></div><div><font size="2"  >v_db_standby_id int;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >-- 返回值0正常,1不正常,2health=false,3active=false,4异常.</font></div><div><font size="2"  >o_result := 1;</font></div><div><font size="2"  >v_failedcheck_count_health_max := 10;</font></div><div><font size="2"  >v_failedcheck_count_active_max := v_failedcheck_count_health_max + 20;</font></div><div><font size="2"  >v_dbname := 'promote';</font></div><div><font size="2"  >v_user_sort := 'promote';</font></div><div><font size="2"  >v_check_sql := 'update check_record set count=count+1,check_time=now();';</font></div><div><font size="2"  >v_db_standby_role := 'primary';</font></div><div><font size="2"  >perform 1 from db_primary_black where db_primary_id = i_primary_id;</font></div><div><font size="2"  >if found then</font></div><div><font size="2"  >&nbsp; raise notice 'The db primary: % in black.',i_primary_id;</font></div><div><font size="2"  >&nbsp; raise exception '';</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >select t1.idc,t1.ip,t2.soft_port,t3.username,t3.password into v_idc,v_ip,v_port,v_username,v_password from server t1,db_primary t2,db_primary_usercfg t3 where t1.id=t2.server_id and t2.id=t3.db_primary_id and t2.id=i_primary_id and t3.user_sort=v_user_sort limit 1;</font></div><div><font size="2"  >v_sql := 'select dblink_exec(''hostaddr='||v_ip||' port='||v_port||' dbname='||v_dbname||' user='||v_username||' password='||v_password||''','''||v_check_sql||''',false)';</font></div><div><font size="2"  >raise notice 'v_sql: %, v_check_sql:% .',v_sql,v_check_sql;</font></div><div><font size="2"  >execute v_sql into v_result;</font></div><div><font size="2"  >if ( v_result ~* 'ERROR' ) then</font></div><div><font size="2"  >&nbsp; select failedcheck_count into v_failedcheck_count from db_primary where id=i_primary_id;</font></div><div><font size="2"  >&nbsp; if ( v_failedcheck_count &gt;= v_failedcheck_count_health_max ) then</font></div><div><font size="2"  >&nbsp; &nbsp; if ( v_failedcheck_count &gt;= v_failedcheck_count_active_max ) then</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; update db_primary set failedcheck_count=failedcheck_count+1,health=false,active=false,modify_time=now() where id=i_primary_id;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; -- 查看是否有promote的standby,没有则调用 promote.</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; select id into v_db_standby_id from db_standby where db_primary_id=i_primary_id and soft_port=v_db_standby_role;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; select o_result into v_promote_result from promote_standby(v_db_standby_id);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; if ( v_promote_result = 0 ) then</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; update db_standby set promote=true where id=v_db_standby_id;</font></div><div><font size="2"  > o_result := 3;</font></div><div><font size="2"  > return;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; end if;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; o_result := 3;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; return;</font></div><div><font size="2"  >&nbsp; &nbsp; else</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; update db_primary set failedcheck_count=failedcheck_count+1,health=false,modify_time=now() where id=i_primary_id;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; -- 查看是否有role='primary'的standby,没有则修改role='primary'.</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; perform 1 from db_standby where db_primary_id=i_primary_id and soft_role=v_db_standby_role and active=true and health=true limit 1;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; if not found then</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; update db_standby set soft_role=v_db_standby_role where id = (select id from db_standby where db_primary_id=i_primary_id and active=true and health=true order by priority limit 1);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; end if;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; o_result := 2;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; return;</font></div><div><font size="2"  >&nbsp; &nbsp; end if;</font></div><div><font size="2"  >&nbsp; end if;</font></div><div><font size="2"  >&nbsp; update db_primary set failedcheck_count=failedcheck_count+1 where id=i_primary_id;</font></div><div><font size="2"  >&nbsp; o_result := 1;</font></div><div><font size="2"  >&nbsp; return;</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >update db_primary set failedcheck_count=0,health=true,modify_time=now() where id=i_primary_id and health=false;</font></div><div><font size="2"  >o_result := 0;</font></div><div><font size="2"  >return;</font></div><div><font size="2"  >exception</font></div><div><font size="2"  >when others then</font></div><div><font size="2"  >raise notice 'Check db primary idc:% ip:% port:% error.',v_idc,v_ip,v_port;</font></div><div><font size="2"  >o_result := 1;</font></div><div><font size="2"  >return;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$BODY$ language plpgsql;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function check_db_standby</font></div><div><font size="2"  >(</font></div><div><font size="2"  >i_standby_id int,</font></div><div><font size="2"  >OUT o_result int</font></div><div><font size="2"  >) as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >v_failedcheck_count_health_max int;</font></div><div><font size="2"  >v_failedcheck_count_active_max int;</font></div><div><font size="2"  >v_failedcheck_count int;</font></div><div><font size="2"  >v_idc text;</font></div><div><font size="2"  >v_ip text;</font></div><div><font size="2"  >v_port int;</font></div><div><font size="2"  >v_username text;</font></div><div><font size="2"  >v_password text;</font></div><div><font size="2"  >v_dbname text;</font></div><div><font size="2"  >v_user_sort text;</font></div><div><font size="2"  >v_sql text;</font></div><div><font size="2"  >v_check_sql text;</font></div><div><font size="2"  >v_result text;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >-- 返回值0正常,1不正常,2health=false,3active=false.</font></div><div><font size="2"  >o_result := 1;</font></div><div><font size="2"  >v_failedcheck_count_health_max := 10;</font></div><div><font size="2"  >v_failedcheck_count_active_max := v_failedcheck_count_health_max + 20;</font></div><div><font size="2"  >v_dbname := 'promote';</font></div><div><font size="2"  >v_user_sort := 'promote';</font></div><div><font size="2"  >v_check_sql := 'select check_time::text from check_record limit 1;';</font></div><div><font size="2"  >perform 1 from db_standby_black where db_standby_id = i_standby_id;</font></div><div><font size="2"  >if found then</font></div><div><font size="2"  >&nbsp; raise notice 'The db standby: % in black.',i_standby_id;</font></div><div><font size="2"  >&nbsp; raise exception '';</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >select t1.idc,t1.ip,t2.soft_port,t3.username,t3.password into v_idc,v_ip,v_port,v_username,v_password from server t1,db_standby t2,db_primary_usercfg t3 where t1.id=t2.server_id and t2.db_primary_id=t3.db_primary_id and t2.id=i_standby_id and t3.user_sort=v_user_sort limit 1;</font></div><div><font size="2"  >v_sql := 'select info from dblink(''hostaddr='||v_ip||' port='||v_port||' dbname='||v_dbname||' user='||v_username||' password='||v_password||''','''||v_check_sql||''',false) as t(info text)';</font></div><div><font size="2"  >raise notice 'v_sql: %, v_check_sql:% .',v_sql,v_check_sql;</font></div><div><font size="2"  >execute v_sql into v_result;</font></div><div><font size="2"  >update db_standby set failedcheck_count=0,health=true,modify_time=now() where id=i_standby_id and health=false;</font></div><div><font size="2"  >o_result := 0;</font></div><div><font size="2"  >return;</font></div><div><font size="2"  >exception</font></div><div><font size="2"  >when others then</font></div><div><font size="2"  >select failedcheck_count into v_failedcheck_count from db_standby where id=i_standby_id;</font></div><div><font size="2"  >if ( v_failedcheck_count &gt;= v_failedcheck_count_health_max ) then</font></div><div><font size="2"  >&nbsp; if ( v_failedcheck_count &gt;= v_failedcheck_count_active_max ) then</font></div><div><font size="2"  >&nbsp; &nbsp; update db_standby set failedcheck_count=failedcheck_count+1,health=false,active=false,modify_time=now() where id=i_standby_id;</font></div><div><font size="2"  >&nbsp; &nbsp; o_result := 3;</font></div><div><font size="2"  >&nbsp; &nbsp; return;</font></div><div><font size="2"  >&nbsp; end if;</font></div><div><font size="2"  >&nbsp; update db_standby set failedcheck_count=failedcheck_count+1,health=false,modify_time=now() where id=i_standby_id;</font></div><div><font size="2"  >&nbsp; o_result := 2;</font></div><div><font size="2"  >&nbsp; return;</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >update db_standby set failedcheck_count=failedcheck_count+1 where id=i_standby_id;</font></div><div><font size="2"  >o_result := 1;</font></div><div><font size="2"  >return;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$BODY$ language plpgsql;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create or replace function get_pool_cfg(i_registered_pool_idc text, i_registered_pool_ip text, i_registered_pool_port int,OUT o_result text) as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >v_db_cfg text;</font></div><div><font size="2"  >v_pool_cfg text;</font></div><div><font size="2"  >v_server_id int;</font></div><div><font size="2"  >v_db_primary_id int;</font></div><div><font size="2"  >v_soft_role text;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >-- 最新配置,先搜索db_primary是否激活并健康,符合要求则取primary的配置,否则取standby的配置</font></div><div><font size="2"  >v_soft_role := 'primary';</font></div><div><font size="2"  >select id into v_server_id from server where idc=i_registered_pool_idc and ip=i_registered_pool_ip;</font></div><div><font size="2"  >select db_primary_id into v_db_primary_id from registered_pool where server_id=v_server_id and port=i_registered_pool_port;</font></div><div><font size="2"  >perform 1 from db_primary where id=v_db_primary_id and active=true and health=true;</font></div><div><font size="2"  >if found then</font></div><div><font size="2"  >&nbsp; select config_db_part,config_pool_part into v_db_cfg,v_pool_cfg from db_primary_poolcfg where db_primary_id=v_db_primary_id;</font></div><div><font size="2"  >&nbsp; v_pool_cfg := regexp_replace(v_pool_cfg,'replace_by_port',i_registered_pool_port::text,'g');</font></div><div><font size="2"  >o_result := v_db_cfg||'</font></div><div><font size="2"  >'||v_pool_cfg;</font></div><div><font size="2"  >&nbsp; return;</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >perform 1 from db_standby where db_primary_id=v_db_primary_id and active=true and health=true and soft_role=v_soft_role limit 1;</font></div><div><font size="2"  >if found then</font></div><div><font size="2"  >&nbsp; select config_pool_part into v_pool_cfg from db_primary_poolcfg where db_primary_id=v_db_primary_id;</font></div><div><font size="2"  >&nbsp; select config_db_part into v_db_cfg from db_standby_poolcfg where db_standby_id=(select id from db_standby where db_primary_id=db_primary_id and active=true and health=true and soft_role=v_soft_role order by priority limit 1);</font></div><div><font size="2"  >&nbsp; v_pool_cfg := regexp_replace(v_pool_cfg,'replace_by_port',i_registered_pool_port::text,'g');</font></div><div><font size="2"  >o_result := v_db_cfg||'</font></div><div><font size="2"  >'||v_pool_cfg;</font></div><div><font size="2"  >&nbsp; return;</font></div><div><font size="2"  >end if;</font></div><div><font size="2"  >o_result := 'NO';</font></div><div><font size="2"  >return;</font></div><div><font size="2"  >exception</font></div><div><font size="2"  >when others then</font></div><div><font size="2"  >o_result := 'NO';</font></div><div><font size="2"  >return;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$BODY$ language plpgsql;</font></div><p></p></pre></div><div><br></div><div>-- 注意, 更新db_primary_poolcfg.config_db_part和db_standby_poolcfg.config_db_part 需同时更新ver</div><div><br></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function get_pool_users(i_registered_pool_idc text, i_registered_pool_ip text, i_registered_pool_port int)&nbsp;</font></div><div><font size="2"  >returns setof text as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >v_db_primary_id int;</font></div><div><font size="2"  >v_server_id int;</font></div><div><font size="2"  >v_user_sort text;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >v_user_sort := 'pgbouncer';</font></div><div><font size="2"  >select id into v_server_id from server where idc=i_registered_pool_idc and ip=i_registered_pool_ip;</font></div><div><font size="2"  >select db_primary_id into v_db_primary_id from registered_pool where server_id=v_server_id and port=i_registered_pool_port;</font></div><div><font size="2"  >return query select '"'||username||'" "'||password||'"' from db_primary_usercfg where db_primary_id=v_db_primary_id and user_sort=v_user_sort order by username;</font></div><div><font size="2"  >exception</font></div><div><font size="2"  >when others then</font></div><div><font size="2"  >return next 'NO';</font></div><div><font size="2"  >return;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$BODY$ language plpgsql;</font></div><p></p></pre></div><div><br></div><div><br></div><div>-- 主备failback操作,恢复配置版本和健康状态.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function failback (i_db_primary_id int) returns int as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >v_primary_role text;</font></div><div><font size="2"  >v_standby_role text;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >v_primary_role := 'primary';</font></div><div><font size="2"  >v_standby_role := 'hot-standby';</font></div><div><font size="2"  >update db_primary set soft_role=v_primary_role,active=true,health=true,failedcheck_count=0 where id=i_db_primary_id;</font></div><div><font size="2"  >update db_standby set soft_role=v_standby_role,active=true,health=true,failedcheck_count=0,promote=false where db_primary_id=i_db_primary_id;</font></div><div><font size="2"  >return 0;</font></div><div><font size="2"  >exception</font></div><div><font size="2"  >when others then</font></div><div><font size="2"  >return 1;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$BODY$ language plpgsql;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table monitor_server_log</font></div><div><font size="2"  >(</font></div><div><font size="2"  >server_id int not null references server(id),</font></div><div><font size="2"  >load_1 numeric not null,</font></div><div><font size="2"  >load_5 numeric not null,</font></div><div><font size="2"  >load_15 numeric not null,</font></div><div><font size="2"  >used_mem_gb numeric not null,</font></div><div><font size="2"  >cached_mem_gb numeric not null,</font></div><div><font size="2"  >cpu_user numeric not null,</font></div><div><font size="2"  >cpu_system numeric not null,</font></div><div><font size="2"  >cpu_iowait numeric not null,</font></div><div><font size="2"  >cpu_idle numeric not null,</font></div><div><font size="2"  >create_time timestamp(0) not null</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table pgcloud_redo_log</font></div><div><font size="2"  >(</font></div><div><font size="2"  >id int primary key,</font></div><div><font size="2"  >redo_sql text not null,</font></div><div><font size="2"  >create_time timestamp(0) not null</font></div><div><font size="2"  >);</font></div><p></p></pre></div><div><br></div><div><div><br></div><div>-- shell</div><div>仲裁服务器 :&nbsp;</div><div>检查 db_primary</div><div>检查 db_standby</div><div><br></div><div>pgbouncer服务器 :&nbsp;</div><div>检查 是否需要更新配置</div><div><br></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >#!/bin/bash</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >IDC="德哥的机房"</font></div><div><font size="2"  >IP="172.16.3.40"</font></div><div><font size="2"  >PORT="1921"</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >DELAY=1</font></div><div><font size="2"  >POOL_MONITOR_HOME=/opt/pool_monitor</font></div><div><font size="2"  >POOL_MONITOR_HOME_PID=$POOL_MONITOR_HOME/run.$PORT</font></div><div><font size="2"  >POOL_HOME=/opt/pgbouncer</font></div><div><font size="2"  >POOL_ETC=$POOL_HOME/etc</font></div><div><font size="2"  >VER_FILE=$POOL_ETC/ver.$PORT</font></div><div><font size="2"  >CONFIG_FILE=$POOL_ETC/config.$PORT</font></div><div><font size="2"  >USER_FILE=$POOL_ETC/users.txt.$PORT</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >if [ -f $POOL_MONITOR_HOME_PID ]; then</font></div><div><font size="2"  >&nbsp; PID=`cat $POOL_MONITOR_HOME_PID`</font></div><div><font size="2"  >&nbsp; ps -p $PID</font></div><div><font size="2"  >&nbsp; if [ $? -eq 0 ]; then</font></div><div><font size="2"  >&nbsp; &nbsp; echo "pool monitor is already running."</font></div><div><font size="2"  >&nbsp; &nbsp; exit 1</font></div><div><font size="2"  >&nbsp; fi</font></div><div><font size="2"  >fi</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >echo $$ &gt; $POOL_MONITOR_HOME_PID</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >while [ true ]</font></div><div><font size="2"  >do</font></div><div><font size="2"  >&nbsp; OLD_VER=`cat $VER_FILE`</font></div><div><font size="2"  >&nbsp; VER=`psql -A -t -q -h 127.0.0.1 pgcloud pgcloud -c "select * from get_poolcfg_ver('$IDC','$IP',$PORT);"`</font></div><div><font size="2"  >&nbsp; if [ ! -f $VER_FILE ] || [ $OLD_VER != $VER ]; then</font></div><div><font size="2"  >&nbsp; &nbsp; psql -A -t -q -h 127.0.0.1 pgcloud pgcloud -c "select * from get_pool_cfg('$IDC','$IP',$PORT);" &gt; $CONFIG_FILE</font></div><div><font size="2"  >&nbsp; &nbsp; psql -A -t -q -h 127.0.0.1 pgcloud pgcloud -c "select * from get_pool_users('$IDC','$IP',$PORT);" &gt; $USER_FILE</font></div><div><font size="2"  >&nbsp; &nbsp; $POOL_HOME/bin/pgbouncer -R -d $CONFIG_FILE</font></div><div><font size="2"  >&nbsp; fi</font></div><div><font size="2"  >&nbsp; echo $VER &gt; $VER_FILE</font></div><div><font size="2"  >&nbsp; sleep $DELAY</font></div><div><font size="2"  >done</font></div><p></p></pre></div></div><wbr></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">jjxliu306 - 2015-01-13 9:30:34</h5>
				<div>有点晕</div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 jjxliu306 - 2015-01-13 9:30:34</h5>
				<div style="width:600px;">是的, 不好用啊. 设计有点问题. 废弃了啊</div>
			</div>
	</div>
</div>
</body>
</html>