<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL length() and Oracle length() difference</h2>
	<h5 id="">2011-09-06 11:28:23&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201186111524697/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">今天群里一位兄弟纠结于oracle和postgresql 的length函数在char类型,同样的内容下面返回的值不一样。<wbr><div>现象:</div><div>Oracle:</div><div><div>SQL&gt; create table char_test (info char(20));</div><div>Table created.</div><div>SQL&gt; insert into char_test values ('abcdef');</div><div>1 row created.</div><div>SQL&gt; select info,length(info) from char_test;</div><div>INFO &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; LENGTH(INFO)</div><div>-------------------- ------------</div><div>abcdef &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 20</div></div><div><br></div><div>PostgreSQL:</div><div><div>digoal=&gt; create table char_test(info char(20));</div><div>CREATE TABLE</div><div>digoal=&gt; insert into char_test &nbsp;values ('abcdef');</div><div>INSERT 0 1</div><div>digoal=&gt; select info,length(info) from char_test ;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;info &nbsp; &nbsp; &nbsp; &nbsp; | length&nbsp;</div><div>----------------------+--------</div><div>&nbsp;abcdef &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;6</div><div>(1 row)</div></div><div><br></div><div>没错Oracle返回的是20，PostgreSQL返回的是6.</div><div>先不要惊讶，看看两个数据库的函数解释。</div><div>Oracle :</div><div><span style="font-family: Tahoma, sans-serif; line-height: normal; font-size: small;"   >The&nbsp;<code style="font-family: monospace; font-size: 12px;"   >LENGTH</code>&nbsp;functions return the length of&nbsp;<code style="font-family: monospace; font-size: 12px;"   ><span style="font-style: italic;"   >char</span></code>.&nbsp;<code style="font-family: monospace; font-size: 12px;"   >LENGTH</code>&nbsp;calculates length using characters as defined by the input character set.</span></div><div><span style="font-family: Tahoma, sans-serif; line-height: normal; font-size: small;"   >If&nbsp;<code style="font-family: monospace; font-size: 12px;"   ><span style="font-style: italic;"   >char</span></code>&nbsp;has datatype&nbsp;<code style="font-family: monospace; font-size: 12px;"   >CHAR</code>, then the length includes all trailing blanks. If&nbsp;<code style="font-family: monospace; font-size: 12px;"   ><span style="font-style: italic;"   >char</span></code>&nbsp;is null, then this function returns null.</span></div><div><span style="font-family: Tahoma, sans-serif; line-height: normal; font-size: small;"   ><br></span></div><div>PostgreSQL :&nbsp;</div><div>length :&nbsp;<span style="font-family: verdana, sans-serif; font-size: 12px; line-height: normal; background-color: rgb(239, 239, 239);"   >Number of characters in&nbsp;<tt>string</tt></span></div><div>显然PostgreSQL未计算blank字符的长度.</div><div>再看看PostgreSQL的HISTORY文件 : 确实有类似改动。</div><div><div>HISTORY: &nbsp; &nbsp; * Add array_length() to return the length of an array for a specified</div><div>HISTORY: &nbsp; &nbsp; * The length() function no longer counts trailing spaces in CHAR(n)</div><div>HISTORY: &nbsp; &nbsp; * Make length() disregard trailing spaces in CHAR(n) (Gavin)</div><div>HISTORY: &nbsp; &nbsp; &nbsp; counted by length().</div><div>HISTORY: &nbsp; &nbsp; * The function "octet_length()" now returns the uncompressed data</div><div>HISTORY: &nbsp; &nbsp; * New function bit_length() (Peter E)</div><div>HISTORY: &nbsp; &nbsp; * Add pg_database_encoding_max_length() (Tatsuo)</div><div>HISTORY:Make char_length()/octet_length including trailing blanks (Tom)</div></div><div><br></div><div>另外在PostgreSQL 的SQL遵循表里面也有解释 :&nbsp;</div><div><a rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/features-sql-standard.html"   >http://www.postgresql.org/docs/9.1/static/features-sql-standard.html</a></div><div><table border="1"   style="margin-left: 2ex; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; -webkit-border-horizontal-spacing: 0px; -webkit-border-vertical-spacing: 0px; border-collapse: collapse; margin-top: 2ex; margin-right: 0px; margin-bottom: 2ex; border-top-width: 2px; border-right-width: 2px; border-bottom-width: 2px; border-left-width: 2px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); color: rgb(0, 0, 0); font-family: verdana, sans-serif; font-size: 12px; line-height: normal; text-align: left;"   ><tbody><tr><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(239, 239, 239); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;"   >E021-04</td><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(239, 239, 239); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;"   >Core</td><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(239, 239, 239); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;"   >CHARACTER_LENGTH function</td><td style="border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; background-color: rgb(239, 239, 239); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-color: rgb(167, 198, 223); border-right-color: rgb(167, 198, 223); border-bottom-color: rgb(167, 198, 223); border-left-color: rgb(167, 198, 223); padding-top: 0.5ex; padding-right: 0.5ex; padding-bottom: 0.5ex; padding-left: 0.5ex;"   >trims trailing spaces from CHARACTER values before counting</td></tr></table></div><div><br></div><div>那就不难理解为什么结果会不一样了。实际占用的长度是一样的。</div><div>如下，PostgreSQL char(20)和varchar(20)用来存储相同的字符，看看是不是占用空间不一样.</div><div><div>digoal=&gt; create table char_test(info char(20));</div><div>CREATE TABLE</div><div>digoal=&gt; insert into char_test &nbsp;values ('abcdef');</div><div>INSERT 0 1</div><div>digoal=&gt; select info,length(info) from char_test ;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;info &nbsp; &nbsp; &nbsp; &nbsp; | length&nbsp;</div><div>----------------------+--------</div><div>&nbsp;abcdef &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;6</div><div>(1 row)</div></div><div><div>digoal=&gt; create table varchar_test (info varchar(20));</div><div>CREATE TABLE</div><div>digoal=&gt; insert into char_test select * from char_test ;</div><div>INSERT 0 1</div><div>digoal=&gt; insert into char_test select * from char_test ;</div><div>INSERT 0 2</div><div>digoal=&gt; insert into char_test select * from char_test ;</div><div>INSERT 0 4</div><div>digoal=&gt; insert into char_test select * from char_test ;</div><div>INSERT 0 8</div><div>digoal=&gt; insert into char_test select * from char_test ;</div><div>INSERT 0 16</div><div>digoal=&gt; insert into char_test select * from char_test ;</div><div>INSERT 0 32</div><div>digoal=&gt; insert into char_test select * from char_test ;</div><div>INSERT 0 64</div><div>digoal=&gt; insert into char_test select * from char_test ;</div><div>INSERT 0 128</div><div>digoal=&gt; insert into char_test select * from char_test ;</div><div>INSERT 0 256</div><div>digoal=&gt; insert into char_test select * from char_test ;</div><div>INSERT 0 512</div><div>digoal=&gt; insert into char_test select * from char_test ;</div><div>INSERT 0 1024</div><div>digoal=&gt; insert into char_test select * from char_test ;</div><div>INSERT 0 2048</div><div>digoal=&gt; insert into char_test select * from char_test ;</div><div>INSERT 0 4096</div><div>digoal=&gt; insert into varchar_test select * from char_test ;</div><div>INSERT 0 8192</div><div>digoal=&gt; select count(*) from char_test ;</div><div>&nbsp;count&nbsp;</div><div>-------</div><div>&nbsp; 8192</div><div>(1 row)</div><div><br></div><div>digoal=&gt; select count(*) from varchar_test ;</div><div>&nbsp;count&nbsp;</div><div>-------</div><div>&nbsp; 8192</div><div>(1 row)</div><div><br></div><div>digoal=&gt; select min(ctid),max(ctid) from char_test ;</div><div>&nbsp; min &nbsp;| &nbsp; max &nbsp;&nbsp;</div><div>-------+---------</div><div>&nbsp;(0,1) | (52,28)</div><div>(1 row)</div><div><br></div><div>digoal=&gt; select min(ctid),max(ctid) from varchar_test ;</div><div>&nbsp; min &nbsp;| &nbsp; max &nbsp;&nbsp;</div><div>-------+---------</div><div>&nbsp;(0,1) | (36,56)</div><div>(1 row)</div></div><div><br></div><div>显然char(20)消耗了53个block,而varchar(20)仅仅消耗了37个block.</div><div><br></div><div>补充几个例子:</div><div><div>digoal=&gt; truncate table char_test ;</div><div>TRUNCATE TABLE</div><div>digoal=&gt; insert into char_test values ('abcdef &nbsp; &nbsp; &nbsp;');</div><div>INSERT 0 1</div><div>digoal=&gt; insert into char_test values ('abcdef &nbsp; &nbsp; &nbsp;a');</div><div>INSERT 0 1</div><div>digoal=&gt; insert into char_test values ('abcdef &nbsp; &nbsp; &nbsp;a ');</div><div>INSERT 0 1</div><div>digoal=&gt; select *,length(info) from char_test l;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;info &nbsp; &nbsp; &nbsp; &nbsp; | length&nbsp;</div><div>----------------------+--------</div><div>&nbsp;abcdef &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;6</div><div>&nbsp;abcdef &nbsp; &nbsp; &nbsp;a &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; 13</div><div>&nbsp;abcdef &nbsp; &nbsp; &nbsp;a &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; 13</div><div>(3 rows)</div><div>注意这个结果是12, &nbsp; 但是在表中返回的是6</div><div>digoal=&gt; select length('abcdef &nbsp; &nbsp; &nbsp;'); &nbsp;</div><div>&nbsp;length&nbsp;</div><div>--------</div><div>&nbsp; &nbsp; &nbsp;12</div><div>(1 row)</div><div>转换成char(x)则返回6.</div><div><div>postgres=# select length('abcdef &nbsp; &nbsp; &nbsp;'::char(32));</div><div>&nbsp;length&nbsp;</div><div>--------</div><div>&nbsp; &nbsp; &nbsp; 6</div><div>(1 row)</div></div><div><br></div><div>digoal=&gt; select length('abcdef &nbsp; &nbsp; &nbsp;a');</div><div>&nbsp;length&nbsp;</div><div>--------</div><div>&nbsp; &nbsp; &nbsp;13</div><div>(1 row)</div><div><br></div><div>digoal=&gt; select length('abcdef &nbsp; &nbsp; &nbsp;a ');</div><div>&nbsp;length&nbsp;</div><div>--------</div><div>&nbsp; &nbsp; &nbsp;14</div><div>(1 row)</div></div><div>char(32)类型，使用length计算字符长度的时候末尾空格不计长度。</div><div><br></div><div><span>在varchar(32)，</span>使用length计算字符长度的时候末尾空格计长度<span>。</span></div><div><div>digoal=&gt; truncate table varchar_test ;</div><div>TRUNCATE TABLE</div><div>digoal=&gt; insert into varchar_test values ('abcdef &nbsp; &nbsp; &nbsp;');</div><div>INSERT 0 1</div><div>digoal=&gt; select *,length(info) from varchar_test;</div><div>&nbsp; &nbsp; &nbsp;info &nbsp; &nbsp; | length&nbsp;</div><div>--------------+--------</div><div>&nbsp;abcdef &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; 12</div><div>(1 row)</div></div></div>
	</div>
</div>
</body>
</html>