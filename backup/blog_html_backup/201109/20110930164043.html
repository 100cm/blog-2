<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Use pg_resetxlog simulate tuple disappear within PostgreSQL</h2>
	<h5 id="">2011-09-30 16:40:43&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201183043153622/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>刚才francs问我由于PostgreSQL的MVCC机制，是不是数据库维护会导致数据库的记录消失。</div><div>当然不会。</div><div>PostgreSQL是有保护机制的，有兴趣的朋友可以参考数据库的maintenance章节和相关的freeze参数。</div><div>不过有一种情况，可以模拟记录"消失"的情况，那就是使用pg_resetxlog去修改控制文件的NextXID的值。(警告，一般情况下请勿使用)</div><div><br></div><pre class="prettyprint"  ><p><font size="2"  >postgres@db5-&gt; psql -h 127.0.0.1 digoal digoal</font></p><div><font size="2"  ># 创建测试表<br><wbr></font><div><div><font size="2"  >digoal=&gt; create table resetxlog_test (id int);</font></div><div><font size="2"  >CREATE TABLE</font></div><div><font size="2"  >digoal=&gt; insert into resetxlog_test values (1);</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=&gt; insert into resetxlog_test values (2);</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=&gt; insert into resetxlog_test values (3);</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=&gt; insert into resetxlog_test values (4);</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=&gt; insert into resetxlog_test values (5);</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=&gt; insert into resetxlog_test values (6);</font></div><div><font size="2"  >INSERT 0 1</font></div></div></div><p></p></pre><div><div><div># 插入6条测试数据后查看记录的xmin和当前的txid.注意我们现在的PostgreSQL epoch是0 (可以从pg_controldata的输出结果看出来) ，所以现在txid和xid相等。</div><div># 注意PostgreSQL 的epoch和 UNIX的epoch (from 1970)不要混淆。</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select id,xmin,txid_current() from resetxlog_test ;</font></div><div><font size="2"  >&nbsp;id | xmin | txid_current&nbsp;</font></div><div><font size="2"  >----+------+--------------</font></div><div><font size="2"  >&nbsp; 1 | 1941 | &nbsp; &nbsp; &nbsp; &nbsp; 1947</font></div><div><font size="2"  >&nbsp; 2 | 1942 | &nbsp; &nbsp; &nbsp; &nbsp; 1947</font></div><div><font size="2"  >&nbsp; 3 | 1943 | &nbsp; &nbsp; &nbsp; &nbsp; 1947</font></div><div><font size="2"  >&nbsp; 4 | 1944 | &nbsp; &nbsp; &nbsp; &nbsp; 1947</font></div><div><font size="2"  >&nbsp; 5 | 1945 | &nbsp; &nbsp; &nbsp; &nbsp; 1947</font></div><div><font size="2"  >&nbsp; 6 | 1946 | &nbsp; &nbsp; &nbsp; &nbsp; 1947</font></div><div><font size="2"  >(6 rows)</font></div><p></p></pre></div><div># 再次插入几条测试数据，一会你会发现这些记录不存在了。</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; insert into resetxlog_test values (7);</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=&gt; insert into resetxlog_test values (8);</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=&gt; insert into resetxlog_test values (9);</font></div><div><font size="2"  >INSERT 0 1</font></div><div><font size="2"  >digoal=&gt; select id,xmin,txid_current() from resetxlog_test ;</font></div><div><font size="2"  >&nbsp;id | xmin | txid_current&nbsp;</font></div><div><font size="2"  >----+------+--------------</font></div><div><font size="2"  >&nbsp; 1 | 1941 | &nbsp; &nbsp; &nbsp; &nbsp; 1951</font></div><div><font size="2"  >&nbsp; 2 | 1942 | &nbsp; &nbsp; &nbsp; &nbsp; 1951</font></div><div><font size="2"  >&nbsp; 3 | 1943 | &nbsp; &nbsp; &nbsp; &nbsp; 1951</font></div><div><font size="2"  >&nbsp; 4 | 1944 | &nbsp; &nbsp; &nbsp; &nbsp; 1951</font></div><div><font size="2"  >&nbsp; 5 | 1945 | &nbsp; &nbsp; &nbsp; &nbsp; 1951</font></div><div><font size="2"  >&nbsp; 6 | 1946 | &nbsp; &nbsp; &nbsp; &nbsp; 1951</font></div><div><font size="2"  >&nbsp; 7 | 1948 | &nbsp; &nbsp; &nbsp; &nbsp; 1951</font></div><div><font size="2"  >&nbsp; 8 | 1949 | &nbsp; &nbsp; &nbsp; &nbsp; 1951</font></div><div><font size="2"  >&nbsp; 9 | 1950 | &nbsp; &nbsp; &nbsp; &nbsp; 1951</font></div><div><font size="2"  >(9 rows)</font></div><p></p></pre></div><div># 新插入的3条记录的xmin分别是 1948, 1949, 1950 .</div><div>digoal=&gt; \q</div><div># 停库，准备模拟记录"消失"。</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; pg_ctl stop</font></div><div><font size="2"  >waiting for server to shut down..... done</font></div><div><font size="2"  >server stopped</font></div><div><font size="2"  >postgres@db5-&gt; pg_controldata&nbsp;</font></div><div><font size="2"  >pg_control version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;903</font></div><div><font size="2"  >Catalog version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 201105231</font></div><div><font size="2"  >Database system identifier: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5652407581121182719</font></div><div><font size="2"  >Database cluster state: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; shut down</font></div><div><font size="2"  >pg_control last modified: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Fri 30 Sep 2011 04:25:26 PM CST</font></div><div><font size="2"  >Latest checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2/40000020</font></div><div><font size="2"  >Prior checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2/3C000020</font></div><div><font size="2"  >Latest checkpoint's REDO location: &nbsp; &nbsp;2/40000020</font></div><div><font size="2"  >Latest checkpoint's TimeLineID: &nbsp; &nbsp; &nbsp; 7</font></div><div><font size="2"  >Latest checkpoint's NextXID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/1952</font></div><div><font size="2"  >Latest checkpoint's NextOID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;24723</font></div><div><font size="2"  >Latest checkpoint's NextMultiXactId: &nbsp;1</font></div><div><font size="2"  >Latest checkpoint's NextMultiOffset: &nbsp;0</font></div><div><font size="2"  >Latest checkpoint's oldestXID: &nbsp; &nbsp; &nbsp; &nbsp;1672</font></div><div><font size="2"  >Latest checkpoint's oldestXID's DB: &nbsp; 24686</font></div><div><font size="2"  >Latest checkpoint's oldestActiveXID: &nbsp;0</font></div><div><font size="2"  >Time of latest checkpoint: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Fri 30 Sep 2011 04:25:25 PM CST</font></div><div><font size="2"  >Minimum recovery ending location: &nbsp; &nbsp; 0/0</font></div><div><font size="2"  >Backup start location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/0</font></div><div><font size="2"  >Current wal_level setting: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;hot_standby</font></div><div><font size="2"  >Current max_connections setting: &nbsp; &nbsp; &nbsp;1000</font></div><div><font size="2"  >Current max_prepared_xacts setting: &nbsp; 0</font></div><div><font size="2"  >Current max_locks_per_xact setting: &nbsp; 64</font></div><div><font size="2"  >Maximum data alignment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8</font></div><div><font size="2"  >Database block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8192</font></div><div><font size="2"  >Blocks per segment of large relation: 131072</font></div><div><font size="2"  >WAL block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8192</font></div><div><font size="2"  >Bytes per WAL segment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;67108864</font></div><div><font size="2"  >Maximum length of identifiers: &nbsp; &nbsp; &nbsp; &nbsp;64</font></div><div><font size="2"  >Maximum columns in an index: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;32</font></div><div><font size="2"  >Maximum size of a TOAST chunk: &nbsp; &nbsp; &nbsp; &nbsp;1996</font></div><div><font size="2"  >Date/time type storage: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 64-bit integers</font></div><div><font size="2"  >Float4 argument passing: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;by value</font></div><div><font size="2"  >Float8 argument passing: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;by value</font></div><p></p></pre></div><div># 从这里可以看到NextXID =&nbsp;1952</div><div># 下面我们把这个值改成1947。</div><div># 修改完后记录 id in ( 7,8,9 )应该会 "消失" .</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; pg_resetxlog -x 1947 $PGDATA</font></div><div><font size="2"  >Transaction log reset</font></div><div><font size="2"  >postgres@db5-&gt; pg_ctl start</font></div><div><font size="2"  >server starting</font></div><div><font size="2"  >postgres@db5-&gt; LOG: &nbsp;loaded library "pg_stat_statements"</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres@db5-&gt; psql -h 127.0.0.1 digoal digoal</font></div><div><font size="2"  >psql (9.1.0)</font></div><div><font size="2"  >Type "help" for help.</font></div><p></p></pre></div><div># 查询，当然是"消失"的。</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select id,xmin,txid_current() from resetxlog_test ;</font></div><div><font size="2"  >&nbsp;id | xmin | txid_current&nbsp;</font></div><div><font size="2"  >----+------+--------------</font></div><div><font size="2"  >&nbsp; 1 | 1941 | &nbsp; &nbsp; &nbsp; &nbsp; 1947</font></div><div><font size="2"  >&nbsp; 2 | 1942 | &nbsp; &nbsp; &nbsp; &nbsp; 1947</font></div><div><font size="2"  >&nbsp; 3 | 1943 | &nbsp; &nbsp; &nbsp; &nbsp; 1947</font></div><div><font size="2"  >&nbsp; 4 | 1944 | &nbsp; &nbsp; &nbsp; &nbsp; 1947</font></div><div><font size="2"  >&nbsp; 5 | 1945 | &nbsp; &nbsp; &nbsp; &nbsp; 1947</font></div><div><font size="2"  >&nbsp; 6 | 1946 | &nbsp; &nbsp; &nbsp; &nbsp; 1947</font></div><div><font size="2"  >(6 rows)</font></div><p></p></pre></div><div># 继续查询 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select id,xmin,txid_current() from resetxlog_test ;</font></div><div><font size="2"  >&nbsp;id | xmin | txid_current&nbsp;</font></div><div><font size="2"  >----+------+--------------</font></div><div><font size="2"  >&nbsp; 1 | 1941 | &nbsp; &nbsp; &nbsp; &nbsp; 1948</font></div><div><font size="2"  >&nbsp; 2 | 1942 | &nbsp; &nbsp; &nbsp; &nbsp; 1948</font></div><div><font size="2"  >&nbsp; 3 | 1943 | &nbsp; &nbsp; &nbsp; &nbsp; 1948</font></div><div><font size="2"  >&nbsp; 4 | 1944 | &nbsp; &nbsp; &nbsp; &nbsp; 1948</font></div><div><font size="2"  >&nbsp; 5 | 1945 | &nbsp; &nbsp; &nbsp; &nbsp; 1948</font></div><div><font size="2"  >&nbsp; 6 | 1946 | &nbsp; &nbsp; &nbsp; &nbsp; 1948</font></div><div><font size="2"  >(6 rows)</font></div><p></p></pre></div><div># 继续查询，当txid大于记录的xmin后，记录随之出现，这里的7,8就出现了 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select id,xmin,txid_current() from resetxlog_test ;</font></div><div><font size="2"  >&nbsp;id | xmin | txid_current&nbsp;</font></div><div><font size="2"  >----+------+--------------</font></div><div><font size="2"  >&nbsp; 1 | 1941 | &nbsp; &nbsp; &nbsp; &nbsp; 1950</font></div><div><font size="2"  >&nbsp; 2 | 1942 | &nbsp; &nbsp; &nbsp; &nbsp; 1950</font></div><div><font size="2"  >&nbsp; 3 | 1943 | &nbsp; &nbsp; &nbsp; &nbsp; 1950</font></div><div><font size="2"  >&nbsp; 4 | 1944 | &nbsp; &nbsp; &nbsp; &nbsp; 1950</font></div><div><font size="2"  >&nbsp; 5 | 1945 | &nbsp; &nbsp; &nbsp; &nbsp; 1950</font></div><div><font size="2"  >&nbsp; 6 | 1946 | &nbsp; &nbsp; &nbsp; &nbsp; 1950</font></div><div><font size="2"  >&nbsp; 7 | 1948 | &nbsp; &nbsp; &nbsp; &nbsp; 1950</font></div><div><font size="2"  >&nbsp; 8 | 1949 | &nbsp; &nbsp; &nbsp; &nbsp; 1950</font></div><div><font size="2"  >(8 rows)</font></div><p></p></pre></div><div># 继续查询，当txid大于记录的xmin后，记录随之出现，这里的9就出现了 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select id,xmin,txid_current() from resetxlog_test ;</font></div><div><font size="2"  >&nbsp;id | xmin | txid_current&nbsp;</font></div><div><font size="2"  >----+------+--------------</font></div><div><font size="2"  >&nbsp; 1 | 1941 | &nbsp; &nbsp; &nbsp; &nbsp; 1951</font></div><div><font size="2"  >&nbsp; 2 | 1942 | &nbsp; &nbsp; &nbsp; &nbsp; 1951</font></div><div><font size="2"  >&nbsp; 3 | 1943 | &nbsp; &nbsp; &nbsp; &nbsp; 1951</font></div><div><font size="2"  >&nbsp; 4 | 1944 | &nbsp; &nbsp; &nbsp; &nbsp; 1951</font></div><div><font size="2"  >&nbsp; 5 | 1945 | &nbsp; &nbsp; &nbsp; &nbsp; 1951</font></div><div><font size="2"  >&nbsp; 6 | 1946 | &nbsp; &nbsp; &nbsp; &nbsp; 1951</font></div><div><font size="2"  >&nbsp; 7 | 1948 | &nbsp; &nbsp; &nbsp; &nbsp; 1951</font></div><div><font size="2"  >&nbsp; 8 | 1949 | &nbsp; &nbsp; &nbsp; &nbsp; 1951</font></div><div><font size="2"  >&nbsp; 9 | 1950 | &nbsp; &nbsp; &nbsp; &nbsp; 1951</font></div><div><font size="2"  >(9 rows)</font></div><p></p></pre></div></div><div><br></div><div>另外一个pg_resetxlog的参数-e 是修改控制文件的epoch值。</div><div>Latest checkpoint's NextXID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/1952</div><div>比如这个是0，输入pg_resetxlog -e 1 后 , PostgreSQL epoch就改为1了。</div><div>然后在数据库执行txid_current()的时候会等于xid+2^32次方。</div><div>如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; pg_ctl stop</font></div><div><font size="2"  >waiting for server to shut down..... done</font></div><div><font size="2"  >server stopped</font></div><div><font size="2"  >postgres@db5-&gt; pg_resetxlog -e 1 $PGDATA</font></div><div><font size="2"  >pTransaction log reset</font></div><div><font size="2"  >postgres@db5-&gt; pg_ctl start</font></div><div><font size="2"  >server starting</font></div><div><font size="2"  >postgres@db5-&gt; LOG: &nbsp;loaded library "pg_stat_statements"</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres@db5-&gt; psql -h 127.0.0.1 digoal digoal</font></div><div><font size="2"  >psql (9.1.0)</font></div><div><font size="2"  >Type "help" for help.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=&gt; select txid_current();</font></div><div><font size="2"  >&nbsp;txid_current&nbsp;</font></div><div><font size="2"  >--------------</font></div><div><font size="2"  >&nbsp; &nbsp;4294969250</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div><div>【参考】</div><div>MVCC</div><div><br></div><div><br></div></div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">francs - 2011-09-30 17:24:36</h5>
				<div>非常给力啊，顶；</div>
			</div>
	</div>
</div>
</body>
</html>