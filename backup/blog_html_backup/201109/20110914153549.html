<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">dream feature coming from mongodb 2.0</h2>
	<h5 id="">2011-09-14 15:35:49&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020118142024788/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">mongoDB 2.0已经发布,带来了许多令人振奋的特性,越来越像企业级的数据库了.<div>下面简单的介绍一下,<br><div>1. &nbsp;compact command</div><div>compact 命令主要的功能是重组collection,重建索引，类似整理碎片。2.0以前需要通过repair database来达到同样的目的，因此会中断全库的操作。compact 只中断单个collection的操作。同时compact操作不会被复制，因此在replica set环境，SLAVE节点也需要做同样的操作才能达到整理碎片的目的。</div><div><br></div><div>3. default stack size</div><div>默认stack size值降低到1MB或者小于系统默认设置，当数据库被连接数量很大（如&gt;1000个连接）是可以减少mongod线程的内存开销。</div><div><br></div><div>4. index performance enhancements</div><div>mongoDB2.0的索引比以前来说，空间占用约减少25%，性能提升25%。在建立索引的时候需要加上{v:1}的标记位。如果不想使用新的索引格式，标记为{v:0}。因此如果加了{v:1}从2.0降级到1.8需要重建索引。</div><div><br></div><div>5. sharding authorizaiton</div><div>以前sharding是不支持auth的，会产生BUG。现在支持了。</div><div><br></div><div>6. replica set enhancements</div><div>6.1 priorities</div><div>以前replica set支持的优先级只有0和1，即0不提升为primary，1可以提升为primary。现在的优先级范围是0到1000的浮点型数值。</div><div>例如：</div><div>A的优先级是4 （primary）</div><div>B的优先级是2</div><div>C的优先级是3</div><div>当A挂掉了，或者不可用。选举发生的时候，如果B和C的up-to-date一致 (并且与primary的数据差异在10秒内)。那么C会被选举为primary。</div><div>如果C和A的差异超过了10秒，那么B将被选举为PRIMARY。如果B和C都进入了up-to-date状态，但是B比较接近A，那么还是C被选举为PRIMARY。而B将产生一个ROLLBACK文件，需要手工ROLLBACK超过C的部分数据。</div><div>这里算是高可用的一个折中方案吧。对于数据要求严谨的可能不太适用。</div><div><br></div><div>6.2 datacenter awareness</div><div>这是一个令人期待的特性，在做系统架构设计时，可以考虑到数据库节点的地域分布，机架分布。给replica set里的每个member都打上1个或者多个TAG。</div><div>利用这些TAG，和getLastError，可以控制这条DML操作需要在多少个打了某个你需要的TAG的MEMBER里面成功之后才返回。</div><div>例如，</div><div><span style="font-family: helvetica, arial, sans-serif; font-size: 13px; line-height: 17px; background-color: rgb(243, 244, 235);"  ><h4 style="margin-top: 14px; margin-right: 0px; margin-bottom: 0.5em; margin-left: 0px; line-height: normal; font-weight: bold; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; font-size: 12pt; color: rgb(0, 51, 102); text-decoration: none !important;"  >Make sure there are at least three copies of the data and it is present on at least two continents.</h4><p style="margin-top: 0px; font-size: 10pt; line-height: 13pt; color: rgb(76, 58, 44) !important; text-decoration: none !important; max-width: 800px;"  >All of the rules up until now have only had one condition, but you can include as many and-conditions as you want. Suppose we have the following:</p><div style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px;"  ><table style="margin-top: 5px; margin-right: 0px; margin-bottom: 1em; margin-left: 0px; font-size: 10pt; line-height: 13pt; color: rgb(0, 0, 0); clear: left; border-collapse: collapse; background-color: rgb(255, 255, 255); padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; width: 794px;"  ><tbody style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px;"  ><tr style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; font-size: 10pt; line-height: 13pt; color: rgb(0, 0, 0);"  ><th style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; font-size: 10pt; line-height: 13pt; border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: rgb(204, 204, 204); border-right-color: rgb(204, 204, 204); border-bottom-color: rgb(204, 204, 204); border-left-color: rgb(204, 204, 204); padding-top: 5px; padding-right: 5px; padding-bottom: 5px; padding-left: 5px; background-color: rgb(240, 240, 240); text-align: left; vertical-align: top; color: rgb(0, 51, 102);"  >Server</th><th style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; font-size: 10pt; line-height: 13pt; border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: rgb(204, 204, 204); border-right-color: rgb(204, 204, 204); border-bottom-color: rgb(204, 204, 204); border-left-color: rgb(204, 204, 204); padding-top: 5px; padding-right: 5px; padding-bottom: 5px; padding-left: 5px; background-color: rgb(240, 240, 240); text-align: left; vertical-align: top; color: rgb(0, 51, 102);"  >Tags</th></tr><tr style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; font-size: 10pt; line-height: 13pt; color: rgb(0, 0, 0);"  ><td style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; font-size: 10pt; line-height: 13pt; color: rgb(0, 0, 0); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: rgb(204, 204, 204); border-right-color: rgb(204, 204, 204); border-bottom-color: rgb(204, 204, 204); border-left-color: rgb(204, 204, 204); padding-top: 5px; padding-right: 5px; padding-bottom: 5px; padding-left: 5px; vertical-align: top;"  ><em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px;"  >S1</em></td><td style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; font-size: 10pt; line-height: 13pt; color: rgb(0, 0, 0); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: rgb(204, 204, 204); border-right-color: rgb(204, 204, 204); border-bottom-color: rgb(204, 204, 204); border-left-color: rgb(204, 204, 204); padding-top: 5px; padding-right: 5px; padding-bottom: 5px; padding-left: 5px; vertical-align: top;"  >{<tt style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px;"  >"continent" : "nAmerica", "copies" : "S1"</tt>}</td></tr><tr style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; font-size: 10pt; line-height: 13pt; color: rgb(0, 0, 0);"  ><td style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; font-size: 10pt; line-height: 13pt; color: rgb(0, 0, 0); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: rgb(204, 204, 204); border-right-color: rgb(204, 204, 204); border-bottom-color: rgb(204, 204, 204); border-left-color: rgb(204, 204, 204); padding-top: 5px; padding-right: 5px; padding-bottom: 5px; padding-left: 5px; vertical-align: top;"  ><em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px;"  >S2</em></td><td style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; font-size: 10pt; line-height: 13pt; color: rgb(0, 0, 0); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: rgb(204, 204, 204); border-right-color: rgb(204, 204, 204); border-bottom-color: rgb(204, 204, 204); border-left-color: rgb(204, 204, 204); padding-top: 5px; padding-right: 5px; padding-bottom: 5px; padding-left: 5px; vertical-align: top;"  >{<tt style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px;"  >"continent" : "nAmerica", "copies" : "S2"</tt>}</td></tr><tr style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; font-size: 10pt; line-height: 13pt; color: rgb(0, 0, 0);"  ><td style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; font-size: 10pt; line-height: 13pt; color: rgb(0, 0, 0); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: rgb(204, 204, 204); border-right-color: rgb(204, 204, 204); border-bottom-color: rgb(204, 204, 204); border-left-color: rgb(204, 204, 204); padding-top: 5px; padding-right: 5px; padding-bottom: 5px; padding-left: 5px; vertical-align: top;"  ><em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px;"  >S3</em></td><td style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; font-size: 10pt; line-height: 13pt; color: rgb(0, 0, 0); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: rgb(204, 204, 204); border-right-color: rgb(204, 204, 204); border-bottom-color: rgb(204, 204, 204); border-left-color: rgb(204, 204, 204); padding-top: 5px; padding-right: 5px; padding-bottom: 5px; padding-left: 5px; vertical-align: top;"  >{<tt style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px;"  >"continent" : "Europe", "copies" : "S3"</tt>}</td></tr><tr style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; font-size: 10pt; line-height: 13pt; color: rgb(0, 0, 0);"  ><td style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; font-size: 10pt; line-height: 13pt; color: rgb(0, 0, 0); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: rgb(204, 204, 204); border-right-color: rgb(204, 204, 204); border-bottom-color: rgb(204, 204, 204); border-left-color: rgb(204, 204, 204); padding-top: 5px; padding-right: 5px; padding-bottom: 5px; padding-left: 5px; vertical-align: top;"  ><em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px;"  >S4</em></td><td style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; font-size: 10pt; line-height: 13pt; color: rgb(0, 0, 0); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: rgb(204, 204, 204); border-right-color: rgb(204, 204, 204); border-bottom-color: rgb(204, 204, 204); border-left-color: rgb(204, 204, 204); padding-top: 5px; padding-right: 5px; padding-bottom: 5px; padding-left: 5px; vertical-align: top;"  >{<tt style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px;"  >"continent" : "Africa", "copies" : "S4"</tt>}</td></tr><tr style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; font-size: 10pt; line-height: 13pt; color: rgb(0, 0, 0);"  ><td style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; font-size: 10pt; line-height: 13pt; color: rgb(0, 0, 0); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: rgb(204, 204, 204); border-right-color: rgb(204, 204, 204); border-bottom-color: rgb(204, 204, 204); border-left-color: rgb(204, 204, 204); padding-top: 5px; padding-right: 5px; padding-bottom: 5px; padding-left: 5px; vertical-align: top;"  ><em style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px;"  >S5</em></td><td style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; font-size: 10pt; line-height: 13pt; color: rgb(0, 0, 0); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: rgb(204, 204, 204); border-right-color: rgb(204, 204, 204); border-bottom-color: rgb(204, 204, 204); border-left-color: rgb(204, 204, 204); padding-top: 5px; padding-right: 5px; padding-bottom: 5px; padding-left: 5px; vertical-align: top;"  >{<tt style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px;"  >"continent" : "Asia", "copies" : "S5"</tt>}</td></tr></table></div><p style="margin-top: 0px; font-size: 10pt; line-height: 13pt; color: rgb(76, 58, 44) !important; text-decoration: none !important; max-width: 800px;"  >Then create a mode like:</p><div style="margin-top: 10px; margin-right: 20px; margin-bottom: 10px; margin-left: 20px; color: black; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; background-image: initial; background-attachment: initial; background-origin: initial; background-clip: initial; background-color: rgb(255, 255, 255); border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: dashed; border-right-style: dashed; border-bottom-style: dashed; border-left-style: dashed; overflow-x: auto; overflow-y: auto; border-top-color: rgb(102, 153, 204); border-right-color: rgb(102, 153, 204); border-bottom-color: rgb(102, 153, 204); border-left-color: rgb(102, 153, 204); background-position: initial initial; background-repeat: initial initial;"  ><div style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; background-image: initial; background-attachment: initial; background-origin: initial; background-clip: initial; background-color: rgb(255, 255, 255); color: rgb(0, 0, 0); padding-top: 0px; padding-right: 12px; padding-bottom: 0px; padding-left: 12px; text-align: left; font-size: 0.95em; background-position: initial initial; background-repeat: initial initial;"  ><pre style="margin-top: 10px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-align: left; overflow-x: auto; overflow-y: auto; white-space: pre-wrap; font-family: 'Courier New', Courier, monospace; line-height: 1.3;"  >level : {copies : 3, continent : 2} </pre></div></div><p style="margin-top: 0px; font-size: 10pt; line-height: 13pt; color: rgb(76, 58, 44) !important; text-decoration: none !important; max-width: 800px;"  >Note that modes can contain as many clauses as you need.</p></span><span style="font-family: helvetica, arial, sans-serif; font-size: 13px;"  ><pre style="margin-top: 10px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-align: left; overflow-x: auto; overflow-y: auto; white-space: pre-wrap; font-family: 'Courier New', Courier, monospace;"  ><span style="line-height: 1.3;"  >{    _id : replSetName,    members : [        {            “_id” : 0,            “host” : S1,            “tags” : {</span><font color="#009100"  >"continent" : "nAmerica","copies" : "S1"</font><span style="line-height: 1.3;"  >}        },        ...    ],    settings : {        getLastErrorModes : {            level : {copies : 3,continent : 2}        }    } }</span></pre></span></div><div><span style="font-family: helvetica, arial, sans-serif; font-size: 13px; line-height: 17px;"  ><pre style="margin-top: 10px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-align: left; overflow-x: auto; overflow-y: auto; white-space: pre-wrap; font-family: 'Courier New', Courier, monospace; line-height: 1.3;"  >使用下面的命令插入数据时，确保数据至少有3个拷贝，并且在2个地域被写入。</pre><pre style="margin-top: 10px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-align: left; overflow-x: auto; overflow-y: auto; white-space: pre-wrap; font-family: 'Courier New', Courier, monospace; line-height: 1.3;"  >db.foo.insert(doc, {w : <span style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; color: rgb(0, 145, 0); background-color: inherit;"  >"level"</span>})</pre></span><span style="font-family: helvetica, arial, sans-serif; font-size: 13px; line-height: 17px;"  ><pre style="margin-top: 10px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-align: left; overflow-x: auto; overflow-y: auto; white-space: pre-wrap; font-family: 'Courier New', Courier, monospace; line-height: 1.3;"  ><br></pre></span></div><div>6.3 w:"majority"</div><div>majority可以认为是少数服从多少的意思，如5个节点的replica set。majority就是3。</div><div><span style="font-family: helvetica, arial, sans-serif; font-size: 13px; line-height: 17px;"  ><pre style="line-height: 1.3; margin-top: 10px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-align: left; overflow-x: auto; overflow-y: auto; white-space: pre-wrap; font-family: 'Courier New', Courier, monospace;"  >db.foo.insert(doc, {w : <span style="line-height: 20px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; color: rgb(0, 145, 0); background-color: inherit;"  >"majory"</span>})</pre><pre style="line-height: 1.3; margin-top: 10px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-align: left; overflow-x: auto; overflow-y: auto; white-space: pre-wrap; font-family: 'Courier New', Courier, monospace;"  >在5个节点的replica set环境。表示至少有3个节点被写入才返回正常。</pre><pre style="line-height: 1.3; margin-top: 10px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-align: left; overflow-x: auto; overflow-y: auto; white-space: pre-wrap; font-family: 'Courier New', Courier, monospace;"  ><br></pre></span></div><div>7. journal 增强</div><div>7.1 journal压缩后写入磁盘，缩短了写入时间，降低磁盘占用。</div><div>7.2</div><div>2.0开始，journalCommitInterval支持配置，默认是100MS。配置范围2到300毫秒。</div><div>其实这个journal有点类似PostgreSQL在配置了synchronous_commit = off 时的wal_writer_delay 参数。</div><div>间隔多少时间做一次FSYNC,把journal的缓存写入到磁盘。</div><div>7.3</div><div><span style="color: rgb(76, 58, 44); font-family: helvetica, arial, sans-serif; font-size: 13px; line-height: 17px; background-color: rgb(243, 244, 235);"  >&nbsp;{<tt style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px;"  >j: true</tt>}</span></div><div>DML操作时可以使用这个参数，使用之后journal会被立即写入到磁盘，不必等待journalCommitInterval的发生。使用这个参数那么这笔DML操作即达到了ACID的D的要求。</div><div><br></div><div>其他的可以参看release notes.</div><div><br></div><div><br><wbr><div>【参考】</div><div><a rel="nofollow" href="http://www.mongodb.org/display/DOCS/2.0+Release+Notes"  >http://www.mongodb.org/display/DOCS/2.0+Release+Notes</a></div></div></div></div>
	</div>
</div>
</body>
</html>