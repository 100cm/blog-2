<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Get txid from pg_controldata's output</h2>
	<h5 id="">2011-09-30 13:32:15&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020118301222520/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>前面一篇BLOG介绍了txid和xid的区别，地址是<a href="http://blog.163.com/digoal@126/blog/static/1638770402011830105342275/"  >http://blog.163.com/digoal@126/blog/static/1638770402011830105342275/</a></div><div>不过还漏了一点东西，txid是怎么计算的。</div><div>注意xid最大是2^32次方。然后rotate。循环使用。而txid是没有rotate的，最大是2^63。假设平均一秒产生1亿个事务来算，txid可以使用2924年。所以基本不会超出。</div><div>我们来看一个数据库的pg_controldata输出 :&nbsp;</div><div>先看看控制文件的状态 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ># stat $PGDATA/global/pg_control</font></div><div><font size="2"  >&nbsp; File: `$PGDATA/global/pg_control'</font></div><div><font size="2"  >&nbsp; Size: 8192 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Blocks: 24 &nbsp; &nbsp; &nbsp; &nbsp; IO Block: 4096 &nbsp; regular file</font></div><div><font size="2"  >Device: fd0bh/64779d &nbsp; &nbsp;Inode: 93 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Links: 1</font></div><div><font size="2"  >Access: (0600/-rw-------) &nbsp;Uid: ( &nbsp;500/postgres) &nbsp; Gid: ( &nbsp;500/postgres)</font></div><div><font size="2"  >Access: 2011-09-30 13:14:18.000000000 +0800</font></div><div><font size="2"  >Modify: 2011-09-30 13:13:29.000000000 +0800</font></div><div><font size="2"  >Change: 2011-09-30 13:13:29.000000000 +0800</font></div><p></p></pre></div><div><div>然后看看这个数据库的控制文件的输出 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >$ pg_controldata $PGDATA</font></div><div><font size="2"  >pg_control version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;903</font></div><div><font size="2"  >Catalog version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 201008051</font></div><div><font size="2"  >Database system identifier: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5521652928171532159</font></div><div><font size="2"  >Database cluster state: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; in production</font></div><div><font size="2"  >pg_control last modified: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Fri 30 Sep 2011 01:13:29 PM CST</font></div><div><font size="2"  >Latest checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; F28/930CE180</font></div><div><font size="2"  >Prior checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;F28/58B49340</font></div><div><font size="2"  >Latest checkpoint's REDO location: &nbsp; &nbsp;F28/6EAD81A8</font></div><div><font size="2"  >Latest checkpoint's TimeLineID: &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"  >Latest checkpoint's NextXID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2/3071633183</font></div><div><font size="2"  >Latest checkpoint's NextOID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;71959</font></div><div><font size="2"  >Latest checkpoint's NextMultiXactId: &nbsp;1</font></div><div><font size="2"  >Latest checkpoint's NextMultiOffset: &nbsp;0</font></div><div><font size="2"  >Latest checkpoint's oldestXID: &nbsp; &nbsp; &nbsp; &nbsp;2954136504</font></div><div><font size="2"  >Latest checkpoint's oldestXID's DB: &nbsp; 50691</font></div><div><font size="2"  >Latest checkpoint's oldestActiveXID: &nbsp;0</font></div><div><font size="2"  >Time of latest checkpoint: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Fri 30 Sep 2011 01:04:42 PM CST</font></div><div><font size="2"  >Minimum recovery ending location: &nbsp; &nbsp; 0/0</font></div><div><font size="2"  >Backup start location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/0</font></div><div><font size="2"  >Current wal_level setting: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;minimal</font></div><div><font size="2"  >Current max_connections setting: &nbsp; &nbsp; &nbsp;2000</font></div><div><font size="2"  >Current max_prepared_xacts setting: &nbsp; 0</font></div><div><font size="2"  >Current max_locks_per_xact setting: &nbsp; 64</font></div><div><font size="2"  >Maximum data alignment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8</font></div><div><font size="2"  >Database block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8192</font></div><div><font size="2"  >Blocks per segment of large relation: 1048576</font></div><div><font size="2"  >WAL block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8192</font></div><div><font size="2"  >Bytes per WAL segment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;67108864</font></div><div><font size="2"  >Maximum length of identifiers: &nbsp; &nbsp; &nbsp; &nbsp;64</font></div><div><font size="2"  >Maximum columns in an index: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;32</font></div><div><font size="2"  >Maximum size of a TOAST chunk: &nbsp; &nbsp; &nbsp; &nbsp;1996</font></div><div><font size="2"  >Date/time type storage: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 64-bit integers</font></div><div><font size="2"  >Float4 argument passing: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;by value</font></div><div><font size="2"  >Float8 argument passing: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;by value</font></div><p></p></pre></div></div><div><br></div><div>注意这行记录 :&nbsp;</div><div><pre class="prettyprint"  ><p><font size="2"  >Latest checkpoint's NextXID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2/3071633183</font></p></pre></div><div><br></div><div>然后到数据库看看现在的txid :&nbsp;</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db_digoal-&gt; psql -h 127.0.0.1 digoal postgres</font></div><div><font size="2"  >psql (9.0.5)</font></div><div><font size="2"  >Type "help" for help.</font></div><div><font size="2"  >digoal=# select txid_current();</font></div><div><font size="2"  >&nbsp;txid_current&nbsp;</font></div><div><font size="2"  >--------------</font></div><div><font size="2"  >&nbsp; 11662043793</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div></div><div>然后要做的是来一个计算 :&nbsp;</div><div><pre class="prettyprint"  ><p><font size="2"  >Latest checkpoint's NextXID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2/3071633183</font></p></pre></div><div>这里的2表示xid已经rotate两次了,你可以去看你刚刚建好的库，这个值肯定是0。</div><div>3071633183就是rotate两次后的值，而txid是不会被rotate的，所以下面的计算就能说明一切了。</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=# select 2^32*2+3071633183;</font></div><div><div><font size="2"  >&nbsp; ?column? &nbsp;&nbsp;</font></div><div><font size="2"  >-------------</font></div><div><font size="2"  >&nbsp;11661567775</font></div><div><font size="2"  >(1 row)</font></div></div><div><font size="2"  ><br></font></div><div><div><font size="2"  >digoal=# select 11662043793-11661567775;</font></div><div><font size="2"  >&nbsp;?column?&nbsp;</font></div><div><font size="2"  >----------</font></div><div><font size="2"  >&nbsp; &nbsp;476018</font></div><div><font size="2"  >(1 row)</font></div></div><p></p></pre></div><div><br></div><div><br></div><div>可能经过下面的操作之后，会更加清晰 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal=# checkpoint;select txid_current();</font></div><div><font size="2"  >CHECKPOINT</font></div><div><font size="2"  >&nbsp;txid_current&nbsp;</font></div><div><font size="2"  >--------------</font></div><div><font size="2"  >&nbsp; 11662195953</font></div><div><font size="2"  >(1 row)</font></div></div><div><font size="2"  ><br></font></div><div><div><font size="2"  >postgres@db_digoal-&gt; pg_controldata&nbsp;</font></div><div><font size="2"  >pg_control version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;903</font></div><div><font size="2"  >Catalog version number: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 201008051</font></div><div><font size="2"  >Database system identifier: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5521652928171532159</font></div><div><font size="2"  >Database cluster state: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; in production</font></div><div><font size="2"  >pg_control last modified: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Fri 30 Sep 2011 01:26:24 PM CST</font></div><div><font size="2"  >Latest checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; F28/C357FAA8</font></div><div><font size="2"  >Prior checkpoint location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;F28/C2B99060</font></div><div><font size="2"  >Latest checkpoint's REDO location: &nbsp; &nbsp;F28/C34E18E8</font></div><div><font size="2"  >Latest checkpoint's TimeLineID: &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"  >Latest checkpoint's NextXID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2/3072260499</font></div><div><font size="2"  >Latest checkpoint's NextOID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;71959</font></div><div><font size="2"  >Latest checkpoint's NextMultiXactId: &nbsp;1</font></div><div><font size="2"  >Latest checkpoint's NextMultiOffset: &nbsp;0</font></div><div><font size="2"  >Latest checkpoint's oldestXID: &nbsp; &nbsp; &nbsp; &nbsp;2954136504</font></div><div><font size="2"  >Latest checkpoint's oldestXID's DB: &nbsp; 50691</font></div><div><font size="2"  >Latest checkpoint's oldestActiveXID: &nbsp;0</font></div><div><font size="2"  >Time of latest checkpoint: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Fri 30 Sep 2011 01:26:23 PM CST</font></div><div><font size="2"  >Minimum recovery ending location: &nbsp; &nbsp; 0/0</font></div><div><font size="2"  >Backup start location: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0/0</font></div><div><font size="2"  >Current wal_level setting: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;minimal</font></div><div><font size="2"  >Current max_connections setting: &nbsp; &nbsp; &nbsp;2000</font></div><div><font size="2"  >Current max_prepared_xacts setting: &nbsp; 0</font></div><div><font size="2"  >Current max_locks_per_xact setting: &nbsp; 64</font></div><div><font size="2"  >Maximum data alignment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8</font></div><div><font size="2"  >Database block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8192</font></div><div><font size="2"  >Blocks per segment of large relation: 1048576</font></div><div><font size="2"  >WAL block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8192</font></div><div><font size="2"  >Bytes per WAL segment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;67108864</font></div><div><font size="2"  >Maximum length of identifiers: &nbsp; &nbsp; &nbsp; &nbsp;64</font></div><div><font size="2"  >Maximum columns in an index: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;32</font></div><div><font size="2"  >Maximum size of a TOAST chunk: &nbsp; &nbsp; &nbsp; &nbsp;1996</font></div><div><font size="2"  >Date/time type storage: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 64-bit integers</font></div><div><font size="2"  >Float4 argument passing: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;by value</font></div><div><font size="2"  >Float8 argument passing: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;by value</font></div></div><p></p></pre></div><div><br></div><div>再来计算 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >select 2^32*2+3072260499;</font></div><div><font size="2"  >&nbsp; ?column? &nbsp;&nbsp;</font></div><div><font size="2"  >-------------</font></div><div><font size="2"  >&nbsp;11662195091</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>和11662195953相差862，因为数据库比较繁忙。不过已经可以看出点啥来了。</div><div>大家体会吧。</div><div><br></div><div>【参考】</div><div>man pg_controldata</div><a href="http://blog.163.com/digoal@126/blog/static/1638770402011830105342275/"  >http://blog.163.com/digoal@126/blog/static/1638770402011830105342275/</a><wbr></div>
	</div>
</div>
</body>
</html>