<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">use snapshot logical volumn upgrade and downgrade software</h2>
	<h5 id="">2011-09-20 10:54:49&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201182010272780/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">ZFS是一个很好的文件系统，整合了RAID,逻辑卷,文件系统的功能。<wbr><div>在Linux下面，没有原生的ZFS文件系统，这三块功能需要独立进行，软RAID可以通过安装mdadm包来管理。LVM可以通过安装lvm包来管理。文件系统有多种选择，如ext3,ext4 .</div><div>例如有三个物理设备。/dev/sdb /dev/sdc /dev/sda4</div><div>1. 创建pv</div><div>pvcreate /dev/sdb</div><div>pvcreate /dev/sdc</div><div>pvcreate /dev/sda4</div><div>2. 创建vg</div><div>vgcreate vgdata01 /dev/sdb /dev/sdc /dev/sda4</div><div>3. 创建lv</div><div><div>pvdisplay &nbsp;查看当前PV信息</div><div>&nbsp;&nbsp;&nbsp; --- Physical volume ---</div><div>&nbsp; PV Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /dev/sdb</div><div>&nbsp; VG Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vgdata01</div><div>&nbsp; PV Size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 278.88 GB / not usable 4.00 MB</div><div>&nbsp; Allocatable &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; yes&nbsp;</div><div>&nbsp; PE Size (KByte) &nbsp; &nbsp; &nbsp; 4096</div><div>&nbsp; Total PE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;71391</div><div>&nbsp; Free PE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 71391</div><div>&nbsp; Allocated PE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</div><div>&nbsp; PV UUID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mxbh2e-3ruS-WOcj-tBx3-fTn7-Fhwy-G6Ussp</div><div>&nbsp; &nbsp;</div><div>&nbsp; --- Physical volume ---</div><div>&nbsp; PV Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /dev/sdc</div><div>&nbsp; VG Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vgdata01</div><div>&nbsp; PV Size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 278.88 GB / not usable 4.00 MB</div><div>&nbsp; Allocatable &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; yes&nbsp;</div><div>&nbsp; PE Size (KByte) &nbsp; &nbsp; &nbsp; 4096</div><div>&nbsp; Total PE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;71391</div><div>&nbsp; Free PE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 71391</div><div>&nbsp; Allocated PE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</div><div>&nbsp; PV UUID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; qi01X6-98ea-mJoy-wq1x-n23q-jBQ4-sZBCUh</div><div>&nbsp; &nbsp;</div><div>&nbsp; --- Physical volume ---</div><div>&nbsp; PV Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /dev/sda4</div><div>&nbsp; VG Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vgdata01</div><div>&nbsp; PV Size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 154.56 GB / not usable 1.20 MB</div><div>&nbsp; Allocatable &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; yes&nbsp;</div><div>&nbsp; PE Size (KByte) &nbsp; &nbsp; &nbsp; 4096</div><div>&nbsp; Total PE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;39568</div><div>&nbsp; Free PE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 39568</div><div>&nbsp; Allocated PE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</div><div>&nbsp; PV UUID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FIu17J-7L0K-ZA7a-6YHq-Yc1x-I4da-SvJe2X</div></div><div>创建lv</div><div>lvcreate -l 71391 -n lv01 vgdata01 /dev/sdb</div><div>lvcreate -l 71391 -n lv02 vgdata01 /dev/sdc</div><div><br></div><div>4. 建立文件系统</div><div>mkfs.ext4 /dev/mapper/vgdata01-lv01</div><div>mkfs.ext4 /dev/mapper/vgdata01-lv02</div><div><br></div><div>5. 使用文件系统</div><div>mount文件系统</div><div>cd lv01的目录</div><div>echo -e "firstname:zhou\nlastname:digoal\nnickname:德哥\n`date +%F%T`\n" &gt;./name.txt</div><div><div>cat name.txt&nbsp;</div><div>firstname:zhou</div><div>lastname:digoal</div><div>nickname:德哥</div><div>2011-09-2010:43:26</div></div><div><br></div><div>6. 创建lv的snapshot</div><div>创建刚才使用过的LV的snapshot , 使用/dev/sda4这个PV.</div><div>因为snapshot 是利用的cow原理，所以创建非常快，使用空间先给1024MB，不够可以通过lvextend扩展。</div><div>lvcreate --size 1024m --snapshot --name snap_201109201044 /dev/vgdata01/lv01 /dev/sda4</div><div><br></div><div><div>lvs</div><div>&nbsp; LV &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;VG &nbsp; &nbsp; &nbsp; Attr &nbsp; LSize &nbsp; Origin Snap% &nbsp;Move Log Copy% &nbsp;Convert</div><div>&nbsp; lv01 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;vgdata01 owi-ao 278.87G &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div><div>&nbsp; lv02 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;vgdata01 -wi-ao 278.87G &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div><div>&nbsp; snap_201109201044 vgdata01 swi-a- &nbsp; 1.00G lv01 &nbsp; &nbsp; 0.00</div></div><div>o表示orign volume</div><div>s表示snapshot volume</div><div><br></div><div>7. 使用文件系统</div><div>修改刚才创建了snapshot的lv文件系统.</div><div><div style="line-height: 22px;"  >cd lv01的目录</div><div style="line-height: 22px;"  >echo -e "firstname:zhou\nlastname:digoal\nnickname:德哥\n`date +%F%T`\n" &gt;./name_new.txt</div></div><div style="line-height: 22px;"  >rm ./name.txt</div><div><div>ll</div><div>total 20</div><div>drwx------ 2 root root 16384 Sep 20 10:40 lost+found</div><div>-rw-r--r-- 1 root root &nbsp; &nbsp;67 Sep 20 10:47 name_new.txt</div></div><div><div><br></div><div>查看lvs,可以看到snapshot使用了0.01%</div><div>&nbsp;lvs</div><div>&nbsp; LV &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;VG &nbsp; &nbsp; &nbsp; Attr &nbsp; LSize &nbsp; Origin Snap% &nbsp;Move Log Copy% &nbsp;Convert</div><div>&nbsp; lv01 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;vgdata01 owi-ao 278.87G &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div><div>&nbsp; lv02 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;vgdata01 -wi-ao 278.87G &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div><div>&nbsp; snap_201109201044 vgdata01 swi-ao &nbsp; 1.00G lv01 &nbsp; &nbsp; 0.01</div></div><div><br></div><div>8. 恢复.</div><div>mount /dev/mapper/vgdata01-snap_201109201044 /mnt</div><div>cd /mnt</div><div><div>ll</div><div>total 20</div><div>drwx------ 2 root root 16384 Sep 20 10:40 lost+found</div><div>-rw-r--r-- 1 root root &nbsp; &nbsp;67 Sep 20 10:43 name.txt</div></div><div>cp name.txt lv01的文件系统.</div><div><br></div><div>结合这个特性可以对一些软件的升级进行快照，如果升级成功则删除快照，升级失败的话，可以把差异恢复(差异恢复可以使用rsync)。</div><div><br></div><div>【参考】</div><div>http://www.kernel.org/pub/linux/utils/raid/mdadm/</div><div>http://linux-raid.osdl.org/</div></div>
	</div>
</div>
</body>
</html>