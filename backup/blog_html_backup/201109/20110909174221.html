<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">use oracle_fdw create oracle foreign table in PostgreSQL</h2>
	<h5 id="">2011-09-09 17:42:21&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020118951953408/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">虽然测试查询ORACLE表没有成功。不过还是很令人期待。下面是测试过程.<div><font color="#202020"  face="'Lucida Grande', verdana, arial, helvetica, sans-serif"  size="2"  ><span style="line-height: normal;"  >2011-9-3放出的一个BETA版本。</span></font></div><div><span style="color: rgb(32, 32, 32); font-family: 'Lucida Grande',verdana,arial,helvetica,sans-serif; line-height: normal; font-size: small;"  ><strong style="text-decoration: none; color: rgb(0, 0, 238);"  ><a style="text-decoration: none; color: rgb(0, 0, 238);" rel="nofollow" href="http://pgfoundry.org/forum/forum.php?forum_id=1853"  >Foreign Data Wrapper for Oracle: beta release</a></strong>&nbsp;</span><br><wbr><div>可以在pgfoundry去下载源码。</div><div>我这里的测试环境 :&nbsp;</div><div>PostgreSQL9.1rc1 (编译安装的)</div><div>RHEL5.6 64位</div><div><br></div><div>编译时文件oracle_utils.c爆出了一些错误:</div><div><div>代码里有几行:</div><div>(OCINumber *)value = number;</div><div>(OCIDateTime *)param-&gt;value = timest;</div><div>(OCIDateTime **)value = &amp;timest;</div><div>报错</div><div>error: invalid lvalue in assignment</div></div><div>后来注释这几行或者改成如下后，都可以编译通过。不过在实际的对foreign table 进行SQL查询出现了问题。查询SQL时，ERROR: &nbsp;invalid memory alloc request size 18446744073709551505</div><div><div style="line-height: 22px;"  >value =&nbsp;(OCINumber *)number;</div><div style="line-height: 22px;"  >param-&gt;value =&nbsp;(OCIDateTime *)timest;</div><div style="line-height: 22px;"  >value =&nbsp;(OCIDateTime **)&amp;timest;</div></div><div style="line-height: 22px;"  ><br></div><div style="line-height: 22px;"  >下面是整个编译过程:</div><div style="line-height: 22px;"  >1. 需要Oracle客户端,oracle sdk,oracle instant client.</div><div style="line-height: 22px;"  >我这里使用的是Oracle 11.2.0.2 64位版本.<br><a id="ic_basic_linux64_111070_zip" name="file20lin112020" rel="nofollow" href="http://download.oracle.com/otn/linux/instantclient/112020/instantclient-basic-linux-x86-64-11.2.0.2.0.zip"  >instantclient-basic-linux-x86-64-11.2.0.2.0.zip</a><br><span>解压缩后放到$ORACLE_HOME/oci/include</span><br><span><a id="oic_sdk_111070_zip" name="file30lin112020" rel="nofollow" href="http://download.oracle.com/otn/linux/instantclient/112020/instantclient-sdk-linux-x86-64-11.2.0.2.0.zip"  >instantclient-sdk-linux-x86-64-11.2.0.2.0.zip</a><br></span><span>解压缩后放到$ORACLE_HOME/sdk</span><br><span></span></div><br><div style="line-height: 22px;"  >2. 环境变量文件 .bash_profile</div><div><div>export PS1="$USER@`/bin/hostname -s`-&gt; "</div><div>export PGPORT= 5432</div><div>export PGDATA=/data1/pg_root</div><div>export PGARCHIVE=/opt/pgdata/pg_arch</div><div>export LANG=en_US.utf8</div><div>export PGHOME=/opt/pgsql</div><div>export ORACLE_HOME=/opt/oracle/product/11.2.0.2/db_1</div><div>export LD_LIBRARY_PATH=$ORACLE_HOME/lib:$ORACLE_HOME/lib32:$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib</div><div>export DATE=`date +"%Y%m%d%H%M"`</div><div>export PATH=$PGHOME/bin:$PATH:/opt/pgbouncer/bin:.</div><div>export MANPATH=$PGHOME/share/man:/opt/pgbouncer/share/man:$MANPATH</div><div><br></div></div><div>3. chown -R postgres:postgres /opt/oracle</div><div><br></div><div>4. 把下载到的源码文件放到 /opt/soft_bak/postgresql-9.1rc1/contrib/</div><div><br></div><div>5. su - root</div><div>生成环境:</div><div>. /home/postgres/.bash_profile</div><div>修改oracle_utils.c文件(第1521,1551,1553行)</div><div><div style="line-height: 22px;"  >value =&nbsp;(OCINumber *)number;</div><div style="line-height: 22px;"  >param-&gt;value =&nbsp;(OCIDateTime *)timest;</div><div style="line-height: 22px;"  >value =&nbsp;(OCIDateTime **)&amp;timest;</div></div><div style="line-height: 22px;"  >编译安装</div><div style="line-height: 22px;"  >cd&nbsp;/opt/soft_bak/postgresql-9.1rc1/contrib/oracle_fdw</div><div style="line-height: 22px;"  >make install</div><div style="line-height: 22px;"  ><br></div><div style="line-height: 22px;"  >6. 编译通过后，到数据库新建extension,</div><div style="line-height: 22px;"  >psql -h 127.0.0.1 digoal postgres</div><div style="line-height: 22px;"  >create extension oracle_fdw;</div><div style="line-height: 22px;"  >相当于执行:</div><div><div>CREATE FUNCTION oracle_fdw_handler() RETURNS fdw_handler</div><div>AS 'MODULE_PATHNAME'</div><div>LANGUAGE C STRICT;</div><div><br></div><div>COMMENT ON FUNCTION oracle_fdw_handler()</div><div>IS 'Oracle foreign data wrapper handler';</div><div><br></div><div>CREATE FUNCTION oracle_fdw_validator(text[], oid) RETURNS void</div><div>AS 'MODULE_PATHNAME'</div><div>LANGUAGE C STRICT;</div><div><br></div><div>COMMENT ON FUNCTION oracle_fdw_validator(text[], oid)</div><div>IS 'Oracle foreign data wrapper options validator';</div><div><br></div><div>CREATE FUNCTION oracle_close_connections() RETURNS void</div><div>AS 'MODULE_PATHNAME'</div><div>LANGUAGE C STRICT;</div><div><br></div><div>COMMENT ON FUNCTION oracle_close_connections()</div><div>IS 'closes all open Oracle connections';</div><div><br></div><div>CREATE FOREIGN DATA WRAPPER oracle_fdw</div><div>&nbsp; HANDLER oracle_fdw_handler</div><div>&nbsp; VALIDATOR oracle_fdw_validator;</div><div><br></div><div>COMMENT ON FOREIGN DATA WRAPPER oracle_fdw</div><div>IS 'Oracle foreign data wrapper';</div></div><div><br></div><div>7. 创建foreign server</div><div>digoal=# create server ora foreign data wrapper oracle_fdw options (dbserver '//xxx.xxx.xxx.xxx:1521/$sid');</div><div>create user mapping for digoal server ora options (user '$username',password '$password');</div><div>&nbsp; 创建foreign table (ORACLE用户需要有查询v$sql(当plan_costs='true')和目标表的权限)</div><div>create FOREIGN table tbl_fdw_test (id varchar,appid numeric,VIDEONAME varchar,CLASSID varchar,ORDERNUM numeric,CREATETIME timestamp without time zone ,groupid varchar) server ora options (table '$oracle_tablename',schema '$oracle_schemaname',plan_costs 'true/false');</div><div><br></div><div>8. 赋权</div><div><span>digoal=#&nbsp;grant all on&nbsp;</span>tbl_fdw_test&nbsp;<span>to digoal;</span></div><div><span><br></span></div><div><span>9. 查询测试</span></div><div><div><span>digoal=&gt; select id from&nbsp;</span>tbl_fdw_test&nbsp;<span>limit 1;</span></div><div>ERROR: &nbsp;invalid memory alloc request size 18446744073709551505</div></div><div style="line-height: 22px;"  ><br></div><div style="line-height: 22px;"  >还是值得期待的，PostgreSQL的融合能力越来越强大了.</div><div><br></div><div>【参考】</div><div><a rel="nofollow" href="http://pgfoundry.org/docman/view.php/1000600/13802/README.txt"  >http://pgfoundry.org/docman/view.php/1000600/13802/README.txt</a><br>http://www.oracle.com/technetwork/topics/linuxx86-64soft-092277.html<br><br></div></div></div>
	</div>
</div>
</body>
</html>