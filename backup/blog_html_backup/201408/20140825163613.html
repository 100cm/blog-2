<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">keepalived which time exec track script , notify script when vrrp transition</h2>
	<h5 id="">2014-08-25 16:36:13&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201472111426324/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>keepalived什么时候调用track script, track interface, notify_* script, notify; 搞清楚这些对设计HA很有必要.</div><div>以下这张图大概的画出了跟踪脚本, 跟踪接口, 状态转换, 以及notify脚本的先后关系 :&nbsp;</div><div>当然实际的程序设计和这个没有关系, keepalived是3个进程组成的, 主进程, vrrp进程和health_check进程. 这里不作体现.</div><div><br></div><div><br></div><div><div><div><img title="keepalived which time exec track script , notify script when vrrp transition - 德哥@Digoal - PostgreSQL research"   alt="keepalived which time exec track script , notify script when vrrp transition - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/Rr_Un2Yp_2-5jy07gX99Aw==/6608656420190012301.png"   ></div></div>&nbsp;</div><div>keepalived.conf配置项 :&nbsp;</div><div>跟踪脚本或跟踪接口配置 :&nbsp;</div><div><br></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >&nbsp; &nbsp; track_interface { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Interfaces state we monitor</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;STRING&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;STRING&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;STRING&gt; weight &lt;INTEGER:-254..254&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; ...</font></div><div><font size="2"   >&nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; track_script { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Scripts state we monitor</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;STRING&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;STRING&gt; weight &lt;INTEGER:-254..254&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; ...</font></div><div><font size="2"   >&nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; dont_track_primary &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (default unset) ignore VRRP interface faults.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp;useful for cross-connect VRRP config.</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >When a weight is specified in track_interface, instead of setting the vrrp</font></div><div><font size="2"   >instance to the FAULT state in case of failure, its priority will be</font></div><div><font size="2"   >increased by the weight when the interface is up (for positive weights),</font></div><div><font size="2"   >or decreased by the weight's absolute value when the interface is down</font></div><div><font size="2"   >(for negative weights). The weight must be comprised between -254 and +254</font></div><div><font size="2"   >inclusive. 0 is the default behaviour which means that a failure implies a</font></div><div><font size="2"   >FAULT state. The common practise is to use positive weights to count a</font></div><div><font size="2"   >limited number of good services so that the server with the highest count</font></div><div><font size="2"   >becomes master. Negative weights are better to count unexpected failures</font></div><div><font size="2"   >among a high number of interfaces, as it will not saturate even with high</font></div><div><font size="2"   >number of interfaces.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The same principle can be applied to track_script entries, except that an</font></div><div><font size="2"   >unspecified weight means that the default weight declared in the script</font></div><div><font size="2"   >will be used.</font></div></div><p></p></pre></div><div><br></div><div>进入状态后的notify脚本配置 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vrrp_sync_group &lt;STRING&gt; { &nbsp; &nbsp; &nbsp;# VRRP sync group declaration</font></div><div><font size="2"   >&nbsp; &nbsp; group { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # group of instance to sync together</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;STRING&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# &nbsp; a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &lt;STRING&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# &nbsp; &nbsp; &nbsp; set</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; ... &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; of VRRP_Instance string</font></div><div><font size="2"   >&nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; notify_master &lt;STRING&gt;|&lt;QUOTED-STRING&gt; # Script to run during MASTER transit</font></div><div><font size="2"   >&nbsp; &nbsp; notify_backup &lt;STRING&gt;|&lt;QUOTED-STRING&gt; # Script to run during BACKUP transit</font></div><div><font size="2"   >&nbsp; &nbsp; notify_fault &lt;STRING&gt;|&lt;QUOTED-STRING&gt; &nbsp;# Script to run during FAULT transit</font></div><div><font size="2"   >&nbsp; &nbsp; notify &lt;STRING&gt;|&lt;QUOTED-STRING&gt; &nbsp; &nbsp; &nbsp; &nbsp;# Script to run during ANY state transit (1)</font></div><div><font size="2"   >&nbsp; &nbsp; smtp_alert &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Send email notif during state transit</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >(1) The "notify" script is called AFTER the corresponding notify_* script has</font></div><div><font size="2"   >&nbsp; &nbsp; been called, and is given exactly 4 arguments (the whole string is interpreted</font></div><div><font size="2"   >&nbsp; &nbsp; as a litteral filename so don't add parameters!):</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; $1 = A string indicating whether it's a "GROUP" or an "INSTANCE"</font></div><div><font size="2"   >&nbsp; &nbsp; $2 = The name of said group or instance</font></div><div><font size="2"   >&nbsp; &nbsp; $3 = The state it's transitioning to ("MASTER", "BACKUP" or "FAULT")</font></div><div><font size="2"   >&nbsp; &nbsp; $4 = The priority value</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; $1 and $3 are ALWAYS sent in uppercase, and the possible strings sent are the</font></div><div><font size="2"   >&nbsp; &nbsp; same ones listed above ("GROUP"/"INSTANCE", "MASTER"/"BACKUP"/"FAULT").</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Important: for a SYNC group to run reliably, it is vital that all instances in</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;the group are MASTER or that they are all either BACKUP or FAULT. A</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;situation with half instances having higher priority on machine A</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;half others with higher priority on machine B will lead to constant</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;re-elections. For this reason, when instances are grouped, their</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tracking weights are automatically set to zero, in order to avoid</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;inconsistent priorities across instances.</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >notify也可以直接配置在instance下.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; notify_master &lt;STRING&gt;|&lt;QUOTED-STRING&gt; &nbsp; &nbsp; &nbsp;# Same as vrrp_sync_group</font></div><div><font size="2"   >&nbsp; &nbsp; notify_backup &lt;STRING&gt;|&lt;QUOTED-STRING&gt; &nbsp; &nbsp; &nbsp;# Same as vrrp_sync_group</font></div><div><font size="2"   >&nbsp; &nbsp; notify_fault &lt;STRING&gt;|&lt;QUOTED-STRING&gt; &nbsp; &nbsp; &nbsp; # Same as vrrp_sync_group</font></div><div><font size="2"   >&nbsp; &nbsp; notify_stop &lt;STRING&gt;|&lt;QUOTED-STRING&gt; &nbsp; &nbsp; &nbsp; &nbsp;# Script to launch when stopping vrrp</font></div><div><font size="2"   >&nbsp; &nbsp; notify &lt;STRING&gt;|&lt;QUOTED-STRING&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Same as vrrp_sync_group</font></div><p></p></pre></div><div><br></div><div>notify是在进入状态后调用的, 也就是Entering后. 截取几段代码 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vrrp_scheduler.c</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log_message(LOG_INFO, "VRRP_Instance(%s) Entering BACKUP STATE",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;vrrp-&gt;iname);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* Set BACKUP state */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vrrp_restore_interface(vrrp, 0);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vrrp-&gt;state = VRRP_STATE_BACK;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vrrp_smtp_notifier(vrrp);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; notify_instance_exec(vrrp, VRRP_STATE_BACK);</font></div></div><div><font size="2"   >............</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log_message(LOG_INFO, "VRRP_Instance(%s) Entering BACKUP STATE",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;vrrp-&gt;iname);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vrrp-&gt;state = VRRP_STATE_BACK;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vrrp_smtp_notifier(vrrp);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; notify_instance_exec(vrrp, VRRP_STATE_BACK);</font></div></div><div><font size="2"   >................</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!VRRP_ISUP(vrrp)) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vrrp_log_int_down(vrrp);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log_message(LOG_INFO, "VRRP_Instance(%s) Now in FAULT state",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;vrrp-&gt;iname);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (vrrp-&gt;state != VRRP_STATE_FAULT)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; notify_instance_exec(vrrp, VRRP_STATE_FAULT);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vrrp-&gt;state = VRRP_STATE_FAULT;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; vrrp-&gt;ms_down_timer = 3 * vrrp-&gt;adver_int + VRRP_TIMER_SKEW(vrrp);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; notify_instance_exec(vrrp, VRRP_STATE_FAULT);</font></div></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1. keepalived/vrrp/vrrp_scheduler.c</div><div>2.&nbsp;<span style="line-height: 28px;"   >keepalived/vrrp/</span><span style="line-height: 28px;"   >vrrp_notify.c</span></div><div><span style="line-height: 28px;"   >3.&nbsp;</span><a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201472531649584/"   >http://blog.163.com/digoal@126/blog/static/163877040201472531649584/</a></div><div>4.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201472511507986/"   >http://blog.163.com/digoal@126/blog/static/163877040201472511507986/</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="keepalived which time exec track script , notify script when vrrp transition - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>