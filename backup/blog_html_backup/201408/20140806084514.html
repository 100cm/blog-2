<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">make openvswitch compatible with oVirt (tight with brctl)</h2>
	<h5 id="">2014-08-06 8:45:14&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020147683530613/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>在openvswitch网站的首页, 指出openvswitch已经整合到了oVirt管理软件, 但是实际使用oVirt时, 发现并没有这样, (我用的是oVirt 3.4.3).</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >It has also been integrated into many virtual management systems including OpenStack, openQRM, OpenNebula and oVirt.&nbsp;</font></div><div></div><p></p></pre></div><div><span style="line-height: 28px;"   >额外在管理机和HOST节点安装openvswitch, 并且将ovirtmgmt网桥改成openvswitch管理后, oVirt管理平台里面, HOST节点的EVENT显示ovirtmgmt没有绑定到任何接口,&nbsp;</span></div><pre class="prettyprint"   ><p></p><div><font size="2"   >Network ovirtmgmt is not attached to any interface on host 150.</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >说明oVirt还在使用brctl来查看接口信息. 使用brctl查看, 确实如此.</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@150 openvswitch-1.9.3]# brctl show</font></div><div><font size="2"   >bridge name &nbsp; &nbsp; bridge id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; STP enabled &nbsp; &nbsp; interfaces</font></div></div><div><div><font size="2"   >ovirtmgmt &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><span style="line-height: 28px;"   ><font size="2"   >0000.00221960778f &nbsp; &nbsp; &nbsp; no</font></span></div></div><p></p></pre></div><div><br></div><div>openvswitch的<span style="line-height: 28px;"   >INSTALL.bridge 安装说明文件指出, 可以将openvswitch安装为替换brctl的模式, 但是不建议这么做, 仅仅当应用程序和brctl绑定使用时才需要这么做, 详细的内容如下 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><div><span style="line-height: 28px;"   ><font size="2"   >[root@150 openvswitch-1.9.3]# cat INSTALL.bridge&nbsp;</font></span></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Replacing a Linux Bridge with Open vSwitch</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ==========================================</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >This file documents how Open vSwitch may be used as a drop-in</font></div><div><font size="2"   >replacement for a Linux kernel bridge in an environment that includes</font></div><div><font size="2"   >elements that are tightly tied to the Linux bridge tools</font></div><div><font size="2"   >(e.g. "brctl") and architecture. &nbsp;We recommend directly using the</font></div><div><font size="2"   >management tools provided with Open vSwitch rather than these</font></div><div><font size="2"   >compatibility hooks for environments that are not tightly tied to the</font></div><div><font size="2"   >Linux bridging tools; they are more efficient and better reflect the</font></div><div><font size="2"   >actual operation and status.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Installation Procedure</font></div><div><font size="2"   >----------------------</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The procedure below explains how to use the Open vSwitch bridge</font></div><div><font size="2"   >compatibility support. &nbsp;This procedure is written from the perspective</font></div><div><font size="2"   >of a system administrator manually loading and starting Open vSwitch</font></div><div><font size="2"   >in bridge compatibility mode, but of course in practice one would want</font></div><div><font size="2"   >to update system scripts to follow these steps. &nbsp;If you do edit your</font></div><div><font size="2"   >system configuration files to start Open vSwitch at boot time, make</font></div><div><font size="2"   >sure that it starts up before any bridge configuration (e.g. before</font></div><div><font size="2"   >any calls to "brctl" or "ifup" of any bridge interfaces), to ensure</font></div><div><font size="2"   >that the Open vSwitch kernel modules are loaded before the Linux</font></div><div><font size="2"   >kernel bridge module.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >1. Build, install, and start up the Open vSwitch kernel modules and</font></div><div><font size="2"   >&nbsp; &nbsp;userspace programs as described in INSTALL.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp;It is important to run "make install", because some Open vSwitch</font></div><div><font size="2"   >&nbsp; &nbsp;programs expect to find files in locations selected at installation</font></div><div><font size="2"   >&nbsp; &nbsp;time. &nbsp;The instructions below assume that files are installed in</font></div><div><font size="2"   >&nbsp; &nbsp;their default locations, under /usr/local.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >2. Load the brcompat kernel module (which was built in step 1), e.g.:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; % insmod datapath/linux/brcompat.ko</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp;(openvswitch.ko should already have been loaded.)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >3. Start ovs-brcompatd:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; % ovs-brcompatd --pidfile --detach</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp;(ovsdb-server and ovs-vswitchd should already have been loaded.)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >4. Now you should be able to manage the Open vSwitch using brctl and</font></div><div><font size="2"   >&nbsp; &nbsp;related tools. &nbsp;For example, you can create an Open vSwitch bridge,</font></div><div><font size="2"   >&nbsp; &nbsp;add interfaces to it, then print information about bridges with the</font></div><div><font size="2"   >&nbsp; &nbsp;commands:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; % brctl addbr br0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; % brctl addif br0 eth0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; % brctl addif br0 eth1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; % brctl show</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp;Each of these commands actually uses or modifies the Open vSwitch</font></div><div><font size="2"   >&nbsp; &nbsp;configuration database, then notifies the ovs-vswitchd daemon of</font></div><div><font size="2"   >&nbsp; &nbsp;the change. &nbsp;For example, after executing the commands above</font></div><div><font size="2"   >&nbsp; &nbsp;starting from an empty configuration file, "ovs-vsctl list-ports</font></div><div><font size="2"   >&nbsp; &nbsp;br0" should show that bridge br0 contains two ports, eth0 and eth1.</font></div></div><p></p></pre></div></div><div><br></div><div>接下来按照openvswitch的提示, 加载brcompat模块, 并使用brctl来管理看看.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@150 openvswitch-1.9.3]# locate brcompat.ko</font></div><div><font size="2"   >/lib/modules/2.6.32-431.20.3.el6.x86_64/extra/openvswitch/brcompat.ko</font></div></div><div><div><font size="2"   >[root@150 openvswitch-1.9.3]# lsmod|grep brcom</font></div><div><font size="2"   >[root@150 openvswitch-1.9.3]# insmod /lib/modules/2.6.32-431.20.3.el6.x86_64/extra/openvswitch/brcompat.ko</font></div><div><font size="2"   >[root@150 openvswitch-1.9.3]# lsmod|grep brcom</font></div><div><font size="2"   >brcompat &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;5905 &nbsp;0&nbsp;</font></div><div><font size="2"   >openvswitch &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;96678 &nbsp;1 brcompat</font></div></div><p></p></pre></div><div>告警了, 这个兼容性将来要移除了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@150 openvswitch-1.9.3]# ovs-brcompatd --pidfile --detach</font></div><div><font size="2"   >2014-08-06T00:23:14Z|00001|brcompatd|WARN|Bridge compatibility is deprecated and may be removed no earlier than February 2013</font></div><div><font size="2"   >[root@150 openvswitch-1.9.3]# ps -ewf|grep ovs-b</font></div><div><font size="2"   >root &nbsp; &nbsp; 18676 &nbsp; &nbsp; 1 &nbsp;0 08:23 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 ovs-brcompatd --pidfile --detach</font></div><p></p></pre></div><div><br></div><div>现在使用brctl查看网桥信息, 还是有问题, 和一开始一样.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@150 openvswitch-1.9.3]# brctl show</font></div><div><font size="2"   >bridge name &nbsp; &nbsp; bridge id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; STP enabled &nbsp; &nbsp; interfaces</font></div><div><font size="2"   >;vdsmdummy; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8000.000000000000 &nbsp; &nbsp; &nbsp; no</font></div><div><font size="2"   >ovirtmgmt &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >0000.00221960778f &nbsp; &nbsp; &nbsp; no</font></div><p></p></pre></div><div>使用ovs-vsctl没有问题.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@150 openvswitch-1.9.3]# ovs-vsctl show</font></div><div><font size="2"   >fb8f1987-c908-4a8f-bc2c-1f8c19f034fc</font></div><div><font size="2"   >&nbsp; &nbsp; Bridge ovirtmgmt</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Port ovirtmgmt</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Interface ovirtmgmt</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; type: internal</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Port "em1"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Interface "em1"</font></div><div><font size="2"   >&nbsp; &nbsp; ovs_version: "1.9.3"</font></div><p></p></pre></div></div><div><br></div><div>使用brctl 添加一个网桥, 添加的网桥, 查看信息还是有问题.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@150 openvswitch-1.9.<span style="line-height: 28px;"   >3]# brctl addbr br1</span></font></div><div><font size="2"   >[root@150 openvswitch-1.9.3]# brctl show</font></div><div><font size="2"   >bridge name &nbsp; &nbsp; bridge id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; STP enabled &nbsp; &nbsp; interfaces</font></div><div><font size="2"   >;vdsmdummy; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8000.000000000000 &nbsp; &nbsp; &nbsp; no</font></div><div><font size="2"   >br1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /sys/class/net/br1/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/br1/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/br1/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/br1/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/br1/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/br1/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/br1/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/br1/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/br1/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/br1/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/br1/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/br1/bridge: No such file or directory</font></div><div><font size="2"   >0000.a28e5dc5ae47 &nbsp; &nbsp; &nbsp; no</font></div><div><font size="2"   >ovirtmgmt &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >/sys/class/net/ovirtmgmt/bridge: No such file or directory</font></div><div><font size="2"   >0000.00221960778f &nbsp; &nbsp; &nbsp; no</font></div><p></p></pre></div><div>看样子现在要用oVirt的话, 还是用bridge-utils带的brctl吧.</div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="make openvswitch compatible with oVirt (tight with brctl) - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>