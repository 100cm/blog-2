<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">backup and restore MonetDB</h2>
	<h5 id="">2014-08-14 15:31:11&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020147142538339/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>备份需要注意的是一致性问题. 前面我们测试了, monetdb从现象上来看是repeatable read隔离级别的, 所以备份如果在一个事务中进行的话不存在不一致的问题.</div><div>例如以下截取, 可以看出备份确实是一个事务中进行的.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres@150-&gt; msqldump test</font></div><div><font size="2"   >-- msqldump dump database Thu Aug 14 15:35:29 2014</font></div><div><font size="2"   >-- MonetDB v11.17.21 (Jan2014-SP3), 'mapi:monetdb://150.sky-mobi.com:50000/test'</font></div><div><font size="2"   >START TRANSACTION;</font></div><div><font size="2"   >CREATE SCHEMA "datacell" AUTHORIZATION "monetdb";</font></div><div><font size="2"   >CREATE SCHEMA "rdf" AUTHORIZATION "monetdb";</font></div><div><font size="2"   >CREATE SEQUENCE "sys"."seq_6544" AS INTEGER;</font></div><div><font size="2"   >SET SCHEMA "rdf";</font></div><div><font size="2"   >CREATE TABLE "rdf"."graph" (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "gname" CHARACTER LARGE OBJECT,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "gid" &nbsp; INTEGER</font></div><div><font size="2"   >);</font></div><div><font size="2"   >SET SCHEMA "sys";</font></div><div><font size="2"   >CREATE TABLE "sys"."a" (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "id" &nbsp; INTEGER &nbsp; &nbsp; &nbsp; NOT NULL DEFAULT next value for "sys"."seq_6544",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "info" VARCHAR(32),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; CONSTRAINT "a_id_pkey" PRIMARY KEY ("id")</font></div><div><font size="2"   >);</font></div><div><font size="2"   >COPY 536870912 RECORDS INTO "sys"."a" FROM stdin USING DELIMITERS '\t','\n','"';</font></div></div><div><font size="2"   >....</font></div><p></p></pre></div><div><br></div><div>但是, 如果要防止备份期间, 数据库被变更(例如迁移数据库, 需要一致性数据), 那么可以锁库, 然后备份再发布.</div><div>Since MonetDB does not provide global locking schemes, a time-consuming dump operation may become invalidated by a concurrent update query.</div><div>所以如果需要全库一致性备份, 需要将数据库转入维护模式. 备份完成再发布. 例如 :&nbsp;</div><div>锁: monetdb lock 库名</div><div>发布: monetdb release 库名</div><div><br></div><div>monetdb提供的备份命令行攻击msqldump.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@150 ~]# msqldump --help</font></div><div><font size="2"   >Usage: msqldump [ options ] [ dbname ]</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Options are:</font></div><div><font size="2"   >&nbsp;-h hostname | --host=hostname &nbsp; &nbsp;host to connect to</font></div><div><font size="2"   >&nbsp;-p portnr &nbsp; | --port=portnr &nbsp; &nbsp; &nbsp;port to connect to</font></div><div><font size="2"   >&nbsp;-u user &nbsp; &nbsp; | --user=user &nbsp; &nbsp; &nbsp; &nbsp;user id</font></div><div><font size="2"   >&nbsp;-d database | --database=database &nbsp;database to connect to</font></div><div><font size="2"   >&nbsp;-f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| --functions &nbsp; &nbsp; &nbsp; &nbsp;dump functions</font></div><div><font size="2"   >&nbsp;-t table &nbsp; &nbsp;| --table=table &nbsp; &nbsp; &nbsp;dump a database table</font></div><div><font size="2"   >&nbsp;-D &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| --describe &nbsp; &nbsp; &nbsp; &nbsp; describe database</font></div><div><font size="2"   >&nbsp;-N &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| --inserts &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;use INSERT INTO statements</font></div><div><font size="2"   >&nbsp;-q &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| --quiet &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;don't print welcome message</font></div><div><font size="2"   >&nbsp;-X &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| --Xdebug &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; trace mapi network interaction</font></div><div><font size="2"   >&nbsp;-? &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| --help &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; show this usage message</font></div><div><font size="2"   >--functions and --table are mutually exclusive</font></div><p></p></pre></div><div><br></div><div>一般可以把用户密码配置在~/.monetdb文件中, 然后使用msqldump就不需要输入用户密码了.</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >[root@150 ~]# vi ~/.monetdb&nbsp;</font></span></div><div><div><font size="2"   >user=monetdb</font></div><div><font size="2"   >password=monetdb</font></div></div><div><span style="line-height: 28px;"   ><font size="2"   >[root@150 ~]# chmod 400 ~/.monetdb&nbsp;</font></span></div><p></p></pre></div><div><br></div><div>例如</div><div><span style="line-height: 28px;"   >一般备份重定向到压缩命令或文件即可.</span></div><div><span style="line-height: 28px;"   ><br></span></div><div>备份整个数据库的DDL</div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@150 ~]# msqldump -D 库名</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >备份表的DDL</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@150 ~]# msqldump -t c -D 库名</font></div><div><font size="2"   >-- msqldump describe table c Thu Aug 14 14:55:41 2014</font></div><div><font size="2"   >-- MonetDB v11.17.21 (Jan2014-SP3), 'mapi:monetdb://150.sky-mobi.com:50000/test'</font></div><div><font size="2"   >CREATE TABLE "sys"."c" (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "id" &nbsp; INTEGER,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "info" VARCHAR(64),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "c1" &nbsp; VARCHAR(64)</font></div><div><font size="2"   >);</font></div><p></p></pre></div><div>备份整个数据库, 包括数据</div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >msqldump 库名</font></span></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >备份函数定义</span></div><pre class="prettyprint"   ><p></p><div><font size="2"   >msqldump -f 库名</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >备份数据, 默认使用COPY方式输出</span></div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@150 ~]# msqldump -f test</font></div><div><font size="2"   >-- msqldump dump functions Thu Aug 14 14:58:24 2014</font></div><div><font size="2"   >-- MonetDB v11.17.21 (Jan2014-SP3), 'mapi:monetdb://150.sky-mobi.com:50000/test'</font></div><div><font size="2"   >[root@150 ~]# msqldump -t c test</font></div><div><font size="2"   >-- msqldump dump table c Thu Aug 14 14:59:00 2014</font></div><div><font size="2"   >-- MonetDB v11.17.21 (Jan2014-SP3), 'mapi:monetdb://150.sky-mobi.com:50000/test'</font></div><div><font size="2"   >CREATE TABLE "sys"."c" (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "id" &nbsp; INTEGER,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "info" VARCHAR(64),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "c1" &nbsp; VARCHAR(64)</font></div><div><font size="2"   >);</font></div><div><font size="2"   >COPY 6 RECORDS INTO "sys"."c" FROM stdin USING DELIMITERS '\t','\n','"';</font></div><div><font size="2"   >1 &nbsp; &nbsp; &nbsp; "test" &nbsp;"test"</font></div><div><font size="2"   >1 &nbsp; &nbsp; &nbsp; "test" &nbsp;"test"</font></div><div><font size="2"   >1 &nbsp; &nbsp; &nbsp; "test" &nbsp;"test"</font></div><div><font size="2"   >1 &nbsp; &nbsp; &nbsp; "test" &nbsp;"test"</font></div><div><font size="2"   >1 &nbsp; &nbsp; &nbsp; "test" &nbsp;"test"</font></div><div><font size="2"   >100 &nbsp; &nbsp; "test" &nbsp;"test"</font></div><p></p></pre></div><div>使用INSERT方式输出</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@150 ~]# msqldump -t c -N test</font></div><div><font size="2"   >-- msqldump dump table c Thu Aug 14 14:59:07 2014</font></div><div><font size="2"   >-- MonetDB v11.17.21 (Jan2014-SP3), 'mapi:monetdb://150.sky-mobi.com:50000/test'</font></div><div><font size="2"   >CREATE TABLE "sys"."c" (</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "id" &nbsp; INTEGER,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "info" VARCHAR(64),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; "c1" &nbsp; VARCHAR(64)</font></div><div><font size="2"   >);</font></div><div><font size="2"   >INSERT INTO "sys"."c" VALUES (1, 'test', 'test');</font></div><div><font size="2"   >INSERT INTO "sys"."c" VALUES (1, 'test', 'test');</font></div><div><font size="2"   >INSERT INTO "sys"."c" VALUES (1, 'test', 'test');</font></div><div><font size="2"   >INSERT INTO "sys"."c" VALUES (1, 'test', 'test');</font></div><div><font size="2"   >INSERT INTO "sys"."c" VALUES (1, 'test', 'test');</font></div><div><font size="2"   >INSERT INTO "sys"."c" VALUES (100, 'test', 'test');</font></div><p></p></pre></div></div><div><br></div><div>还原则在mclient下直接运行备份文件即可.</div><div>例如</div><div>mclient 库名</div><div>\&lt; 文件名</div><div><br></div>[参考]<wbr><div>1. man msqldump</div><div>2. man mclient</div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://www.monetdb.org/Documentation/UserGuide/DumpRestore"   >https://www.monetdb.org/Documentation/UserGuide/DumpRestore</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="backup and restore MonetDB - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>