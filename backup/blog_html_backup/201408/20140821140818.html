<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">keepalived instance priority don't impact by track script|interface weight when 255</h2>
	<h5 id="">2014-08-21 14:08:18&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020147212529175/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>前面我在写keepalived优先级动态调整时, 写到关于初始优先级设置为255的instance不被动态调整的内容, 原因参考本文末尾部分. 因为</div><div><div style="line-height: 28px; color: rgb(51, 51, 51); font-family: monospace; white-space: pre-wrap;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >	</span></span><span style="line-height: 21px; color: rgb(0, 0, 136);"   >if</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > </span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >(</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >vrrp</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >-&gt;</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >base_priority </span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >==</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > VRRP_PRIO_OWNER</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >)</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > </span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >{</span></font></div><div style="line-height: 28px; color: rgb(51, 51, 51); font-family: monospace; white-space: pre-wrap;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >		</span></span><span style="line-height: 21px; color: rgb(136, 0, 0);"   >/* we will not run a PRIO_OWNER into a non-PRIO_OWNER */</span></font></div><div style="line-height: 28px; color: rgb(51, 51, 51); font-family: monospace; white-space: pre-wrap;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >		</span></span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >vrrp</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >-&gt;</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >effective_priority </span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >=</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > VRRP_PRIO_OWNER</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >;</span></font></div></div><div>本文主要就是实际验证一下.</div><div>用的例子参考</div><div><a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020147203020835/"   >http://blog.163.com/digoal@126/blog/static/16387704020147203020835/</a></div><div>把192.168.173.204的初始优先级调整为255.</div><div><span style="line-height: 28px;"   >把192.168.173.203的初始优先级调整为254.</span></div><div>keepalived启动后, 192.168.173.204是MASTER.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived[421]: Starting Keepalived v1.2.13 (08/19,2014)</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived[422]: Starting Healthcheck child process, pid=423</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived[422]: Starting VRRP child process, pid=424</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_vrrp[424]: Netlink reflector reports IP 192.168.173.203 added</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_vrrp[424]: Netlink reflector reports IP 192.168.173.156 added</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_vrrp[424]: Netlink reflector reports IP fe80::f6ce:46ff:fe86:4234 added</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_vrrp[424]: Registering Kernel netlink reflector</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_healthcheckers[423]: Netlink reflector reports IP 192.168.173.203 added</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_vrrp[424]: Registering Kernel netlink command channel</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_healthcheckers[423]: Netlink reflector reports IP 192.168.173.156 added</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_vrrp[424]: Registering gratuitous ARP shared channel</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_healthcheckers[423]: Netlink reflector reports IP fe80::f6ce:46ff:fe86:4234 added</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_healthcheckers[423]: Registering Kernel netlink reflector</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_healthcheckers[423]: Registering Kernel netlink command channel</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_vrrp[424]: Opening file '/opt/keepalived/etc/keepalived/keepalived.conf'.</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_healthcheckers[423]: Opening file '/opt/keepalived/etc/keepalived/keepalived.conf'.</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_healthcheckers[423]: Configuration is using : 7937 Bytes</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_vrrp[424]: Configuration is using : 69311 Bytes</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_vrrp[424]: Using LinkWatch kernel netlink reflector...</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_vrrp[424]: VRRP sockpool: [ifindex(2), proto(112), unicast(1), fd(10,11)]</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_healthcheckers[423]: Using LinkWatch kernel netlink reflector...</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_vrrp[424]: VRRP_Script(nag) succeeded</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_vrrp[424]: VRRP_Script(zero) succeeded</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_vrrp[424]: VRRP_Script(pos) succeeded</font></div><div><font size="2"   >Aug 21 13:59:04 192_168_173_203 Keepalived_vrrp[424]: VRRP_Instance(vi_1) Transition to MASTER STATE</font></div><div><font size="2"   >Aug 21 13:59:05 192_168_173_203 Keepalived_vrrp[424]: VRRP_Instance(vi_1) Entering MASTER STATE</font></div><div><font size="2"   >Aug 21 13:59:05 192_168_173_203 Keepalived_vrrp[424]: VRRP_Instance(vi_1) setting protocol VIPs.</font></div><div><font size="2"   >Aug 21 13:59:05 192_168_173_203 Keepalived_vrrp[424]: VRRP_Instance(vi_1) Sending gratuitous ARPs on eth0 for 172.16.173.100</font></div><div><font size="2"   >Aug 21 13:59:05 192_168_173_203 Keepalived_healthcheckers[423]: Netlink reflector reports IP 172.16.173.100 added</font></div><div><font size="2"   >Aug 21 13:59:06 192_168_173_203 rgmanager[652]: [script] Executing /usr/local/bin/pgctl.sh status</font></div><div><font size="2"   >Aug 21 13:59:10 192_168_173_203 Keepalived_vrrp[424]: VRRP_Instance(vi_1) Sending gratuitous ARPs on eth0 for 172.16.173.100</font></div><div><font size="2"   >Aug 21 13:59:26 192_168_173_203 rgmanager[1041]: [script] Executing /usr/local/bin/pgctl.sh status</font></div><div><font size="2"   >Aug 21 13:59:29 192_168_173_203 Keepalived_vrrp[424]: VRRP_Instance(vi_1) Received higher prio advert</font></div><div><font size="2"   >Aug 21 13:59:29 192_168_173_203 Keepalived_vrrp[424]: VRRP_Instance(vi_1) Entering BACKUP STATE</font></div><div><font size="2"   >Aug 21 13:59:29 192_168_173_203 Keepalived_vrrp[424]: VRRP_Instance(vi_1) removing protocol VIPs.</font></div><div><font size="2"   >Aug 21 13:59:29 192_168_173_203 Keepalived_healthcheckers[423]: Netlink reflector reports IP 172.16.173.100 removed</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived[421]: Starting Keepalived v1.2.13 (08/19,2014)</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived[422]: Starting Healthcheck child process, pid=423</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived[422]: Starting VRRP child process, pid=424</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_vrrp[424]: Netlink reflector reports IP 192.168.173.203 added</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_vrrp[424]: Netlink reflector reports IP 192.168.173.156 added</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_vrrp[424]: Netlink reflector reports IP fe80::f6ce:46ff:fe86:4234 added</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_vrrp[424]: Registering Kernel netlink reflector</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_healthcheckers[423]: Netlink reflector reports IP 192.168.173.203 added</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_vrrp[424]: Registering Kernel netlink command channel</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_healthcheckers[423]: Netlink reflector reports IP 192.168.173.156 added</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_vrrp[424]: Registering gratuitous ARP shared channel</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_healthcheckers[423]: Netlink reflector reports IP fe80::f6ce:46ff:fe86:4234 added</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_healthcheckers[423]: Registering Kernel netlink reflector</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_healthcheckers[423]: Registering Kernel netlink command channel</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_vrrp[424]: Opening file '/opt/keepalived/etc/keepalived/keepalived.conf'.</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_healthcheckers[423]: Opening file '/opt/keepalived/etc/keepalived/keepalived.conf'.</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_healthcheckers[423]: Configuration is using : 7937 Bytes</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_vrrp[424]: Configuration is using : 69311 Bytes</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_vrrp[424]: Using LinkWatch kernel netlink reflector...</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_vrrp[424]: VRRP sockpool: [ifindex(2), proto(112), unicast(1), fd(10,11)]</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_healthcheckers[423]: Using LinkWatch kernel netlink reflector...</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_vrrp[424]: VRRP_Script(nag) succeeded</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_vrrp[424]: VRRP_Script(zero) succeeded</font></div><div><font size="2"   >Aug 21 13:59:03 192_168_173_203 Keepalived_vrrp[424]: VRRP_Script(pos) succeeded</font></div><div><font size="2"   >Aug 21 13:59:04 192_168_173_203 Keepalived_vrrp[424]: VRRP_Instance(vi_1) Transition to MASTER STATE</font></div><div><font size="2"   >Aug 21 13:59:05 192_168_173_203 Keepalived_vrrp[424]: VRRP_Instance(vi_1) Entering MASTER STATE</font></div><div><font size="2"   >Aug 21 13:59:05 192_168_173_203 Keepalived_vrrp[424]: VRRP_Instance(vi_1) setting protocol VIPs.</font></div><div><font size="2"   >Aug 21 13:59:05 192_168_173_203 Keepalived_vrrp[424]: VRRP_Instance(vi_1) Sending gratuitous ARPs on eth0 for 172.16.173.100</font></div><div><font size="2"   >Aug 21 13:59:05 192_168_173_203 Keepalived_healthcheckers[423]: Netlink reflector reports IP 172.16.173.100 added</font></div><div><span style="line-height: 28px;"   ><font size="2"   >Aug 21 13:59:10 192_168_173_203 Keepalived_vrrp[424]: VRRP_Instance(vi_1) Sending gratuitous ARPs on eth0 for 172.16.173.100</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >Aug 21 13:59:29 192_168_173_203 Keepalived_vrrp[424]: VRRP_Instance(vi_1) Received higher prio advert</font></span></div><div><font size="2"   >Aug 21 13:59:29 192_168_173_203 Keepalived_vrrp[424]: VRRP_Instance(vi_1) Entering BACKUP STATE</font></div><div><font size="2"   >Aug 21 13:59:29 192_168_173_203 Keepalived_vrrp[424]: VRRP_Instance(vi_1) removing protocol VIPs.</font></div><div><font size="2"   >Aug 21 13:59:29 192_168_173_203 Keepalived_healthcheckers[423]: Netlink reflector reports IP 172.16.173.100 removed</font></div></div><p></p></pre></div><div>当我把192.168.173.204的nag.var调成1, nag.sh脚本检查失败, 日志如下</div><pre class="prettyprint"   ><p></p><div><font size="2"   >Aug 21 13:59:43 192_168_173_204 Keepalived_vrrp[13887]: VRRP_Script(nag) failed</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >但是不影响</span><span style="line-height: 28px;"   >192.168.173.204的优先级, 所以它还是master.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@192_168_173_204 ~]# ifconfig</font></div><div><font size="2"   >eth0 &nbsp; &nbsp; &nbsp;Link encap:Ethernet &nbsp;HWaddr F4:CE:46:85:15:FC &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet addr:192.168.173.204 &nbsp;Bcast:192.168.173.255 &nbsp;Mask:255.255.255.0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet6 addr: fe80::f6ce:46ff:fe85:15fc/64 Scope:Link</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP BROADCAST RUNNING MULTICAST &nbsp;MTU:1500 &nbsp;Metric:1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX packets:10360595 errors:0 dropped:0 overruns:0 frame:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TX packets:4714379 errors:0 dropped:0 overruns:0 carrier:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; collisions:0 txqueuelen:1000&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX bytes:1469576774 (1.3 GiB) &nbsp;TX bytes:661681617 (631.0 MiB)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >eth0:1 &nbsp; &nbsp;Link encap:Ethernet &nbsp;HWaddr F4:CE:46:85:15:FC &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet addr:172.16.173.100 &nbsp;Bcast:172.16.173.255 &nbsp;Mask:255.255.255.0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP BROADCAST RUNNING MULTICAST &nbsp;MTU:1500 &nbsp;Metric:1</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >lo &nbsp; &nbsp; &nbsp; &nbsp;Link encap:Local Loopback &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet addr:127.0.0.1 &nbsp;Mask:255.0.0.0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet6 addr: ::1/128 Scope:Host</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UP LOOPBACK RUNNING &nbsp;MTU:16436 &nbsp;Metric:1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX packets:163476 errors:0 dropped:0 overruns:0 frame:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TX packets:163476 errors:0 dropped:0 overruns:0 carrier:0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; collisions:0 txqueuelen:0&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RX bytes:8835522 (8.4 MiB) &nbsp;TX bytes:8835522 (8.4 MiB)</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020147203020835/"   >http://blog.163.com/digoal@126/blog/static/16387704020147203020835/</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201472010332545/"   >http://blog.163.com/digoal@126/blog/static/163877040201472010332545/</a></div><div><div style="line-height: 28px; color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53;"   ><span style="line-height: 28px;"   >动态调整优先级的范围 :&nbsp;</span></div><div style="line-height: 28px; color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53;"   >如果配置的instance的初始优先级是255的话, 则不受track weight的影响. 见vrrp_update_priority函数的内容.</div><div style="line-height: 28px; color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53;"   ><pre class="prettyprint"   style="line-height: 28px; white-space: pre-wrap;"   ><p style="line-height: 28px; margin-bottom: 10px;"   ></p><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >	</span></span><span style="line-height: 21px; color: rgb(0, 0, 136);"   >if</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > </span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >(</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >vrrp</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >-&gt;</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >base_priority </span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >==</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > VRRP_PRIO_OWNER</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >)</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > </span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >{</span></font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >		</span></span><span style="line-height: 21px; color: rgb(136, 0, 0);"   >/* we will not run a PRIO_OWNER into a non-PRIO_OWNER */</span></font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >		</span></span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >vrrp</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >-&gt;</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >effective_priority </span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >=</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > VRRP_PRIO_OWNER</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >;</span></font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >	</span></span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >}</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > </span><span style="line-height: 21px; color: rgb(0, 0, 136);"   >else</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > </span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >{</span></font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >		</span></span><span style="line-height: 21px; color: rgb(136, 0, 0);"   >/* WARNING! we must compute new_prio on a signed int in order</span></font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(136, 0, 0);"   >		</span></span><span style="line-height: 21px; color: rgb(136, 0, 0);"   > &nbsp; to detect overflows and avoid wrapping. */</span></font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >		</span></span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >new_prio </span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >=</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > vrrp</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >-&gt;</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >base_priority </span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >+</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > prio_offset</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >;</span></font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >		</span></span><span style="line-height: 21px; color: rgb(0, 0, 136);"   >if</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > </span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >(</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >new_prio </span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >&lt;</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > </span><span style="line-height: 21px; color: rgb(0, 102, 102);"   >1</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >)</span></font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >			</span></span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >new_prio </span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >=</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > </span><span style="line-height: 21px; color: rgb(0, 102, 102);"   >1</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >;</span></font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >		</span></span><span style="line-height: 21px; color: rgb(0, 0, 136);"   >else</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > </span><span style="line-height: 21px; color: rgb(0, 0, 136);"   >if</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > </span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >(</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >new_prio </span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >&gt;</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > </span><span style="line-height: 21px; color: rgb(0, 102, 102);"   >254</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >)</span></font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >			</span></span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >new_prio </span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >=</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > </span><span style="line-height: 21px; color: rgb(0, 102, 102);"   >254</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >;</span></font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >		</span></span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >vrrp</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >-&gt;</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >effective_priority </span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >=</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > new_prio</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >;</span></font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >	</span></span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >}</span></font></div></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   ><br style="line-height: 21px;"   ></font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >keepalived </span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >/</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > include </span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >/</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > vrrp</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >.</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >h</span></font></div><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(136, 0, 0);"   >#define</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   > VRRP_PRIO_OWNER</span><span style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >		</span></span><span style="line-height: 21px; color: rgb(0, 102, 102);"   >255</span><span style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >		</span></span><span style="line-height: 21px; color: rgb(136, 0, 0);"   >/* priority of the ip owner -- rfc2338.5.3.4 */</span></font></div></div><p style="line-height: 28px; margin-bottom: 10px;"   ></p></pre></div><div style="line-height: 28px; color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53;"   ><div style="line-height: 28px;"   >换句话说, 只有初始优先级配置&lt;255的instance, 才可以动态调整优先级. 并且动态调整后的优先级范围是1到254.</div><div style="line-height: 28px;"   ><pre class="prettyprint"   style="line-height: 28px; white-space: pre-wrap;"   ><p style="line-height: 28px; margin-bottom: 10px;"   ></p><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >&nbsp; &nbsp; priority </span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >&lt;</span><span style="line-height: 21px; color: rgb(0, 0, 0);"   >INTEGER</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >-</span><span style="line-height: 21px; color: rgb(0, 102, 102);"   >0.</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >.</span><span style="line-height: 21px; color: rgb(0, 102, 102);"   >255</span><span style="line-height: 21px; color: rgb(102, 102, 0);"   >&gt;</span><span style="line-height: 21px;"   ><span style="line-height: 21px; color: rgb(0, 0, 0);"   >		</span></span><span style="line-height: 21px; color: rgb(136, 0, 0);"   ># VRRP PRIO</span></font></div></div></pre></div></div></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="keepalived instance priority dont impact by track script|interface weight when 255 - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>