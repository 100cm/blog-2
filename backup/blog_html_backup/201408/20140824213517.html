<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL has same block update conflict problem? NO problem.</h2>
	<h5 id="">2014-08-24 21:35:17&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201472432125379/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>数据库中shared buffer是非常宝贵的资源, 所以能省则省, 例如假设PostgreSQL数据库的单个数据块是8KB, 一个表有100万记录, 分布在5万个数据块, 每个数据块包含约20条记录. 大概占用400MB. 假设活跃数据有10000条, 如果这1万条数据分布在完全不同的数据块里面的话, 那么需要占用1万个数据块也就是78MB, 但是如果这10000条记录在连续的数据块的话, 只需要20分之一的空间, 即4MB.&nbsp;</div><div>那么问题来了, 如果这些记录不仅仅读取, 还需要更新的话, 同一个数据块经常更新会不会带来问题呢?</div><div>例如同一个数据块的20条记录, 被频繁的更新.</div><div>这个就要考虑MVCC了, 对于PostgreSQL来说, 更新会生成新的版本, 所以一旦发生更新, 这条记录就很有可能不在这个数据块了, 如果是并发的更新同一个数据块, PostgreSQL FSM机制会分配不同的空闲数据块给不同的会话, 这样更新一次后基本上就会不存在还在一个数据块的情况了 .</div><div>但是对于Oracle的话, 因为记录是在存储旧的记录到UNDO后, 直接在本身记录直接修改的(除非空间不够发生了行迁移), 所以在同一个数据块的记录, 频繁被更新的话, 可能存在块竞争的问题.</div><div><br></div><div>下面是PostgreSQL分散数据块记录和集中数据块记录的并发更新性能, 从结果来看, 确实不存在竞争问题.</div><div>分散数据块测试结果 :&nbsp;</div><pre class="prettyprint"   ><p><font size="2"   >postgres=# create table t (id int primary key, info text);<wbr></font></p><div><font size="2"   >postgres=# insert into t select generate_series(1,1000000),md5(random()::text);</font></div><div><span style="line-height: 28px;"   ><font size="2"   >postgres=# select substring(ctid::text from '([0-9]+),.*'), min(id) from t group by 1 order by substring(ctid::text from '([0-9]+),.*')::int limit 16;</font></span></div><div><div><div><font size="2"   >&nbsp;substring | min &nbsp;</font></div><div><font size="2"   >-----------+------</font></div><div><font size="2"   >&nbsp;0 &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp;1</font></div><div><font size="2"   >&nbsp;1 &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp;121</font></div><div><font size="2"   >&nbsp;2 &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp;241</font></div><div><font size="2"   >&nbsp;3 &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp;361</font></div><div><font size="2"   >&nbsp;4 &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp;481</font></div><div><font size="2"   >&nbsp;5 &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp;601</font></div><div><font size="2"   >&nbsp;6 &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp;721</font></div><div><font size="2"   >&nbsp;7 &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp;841</font></div><div><font size="2"   >&nbsp;8 &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp;961</font></div><div><font size="2"   >&nbsp;9 &nbsp; &nbsp; &nbsp; &nbsp; | 1081</font></div><div><font size="2"   >&nbsp;10 &nbsp; &nbsp; &nbsp; &nbsp;| 1201</font></div><div><font size="2"   >&nbsp;11 &nbsp; &nbsp; &nbsp; &nbsp;| 1321</font></div><div><font size="2"   >&nbsp;12 &nbsp; &nbsp; &nbsp; &nbsp;| 1441</font></div><div><font size="2"   >&nbsp;13 &nbsp; &nbsp; &nbsp; &nbsp;| 1561</font></div><div><font size="2"   >&nbsp;14 &nbsp; &nbsp; &nbsp; &nbsp;| 1681</font></div><div><font size="2"   >&nbsp;15 &nbsp; &nbsp; &nbsp; &nbsp;| 1801</font></div><div><font size="2"   >(16 rows)</font></div></div></div><div><div><font size="2"   >postgres=# delete from t where id not in (1,121,241,361,481,601,721,841,961,1081,1201,1321,1441,1561,1681,1801,1000000);</font></div><div><font size="2"   >DELETE 999983</font></div><div><font size="2"   >postgres=# vacuum analyze t;</font></div><div><font size="2"   >VACUUM</font></div></div><div><div><font size="2"   >postgres=# select ctid,id from t;</font></div><div><font size="2"   >&nbsp; &nbsp;ctid &nbsp; &nbsp;| &nbsp; id &nbsp; &nbsp;</font></div><div><font size="2"   >-----------+---------</font></div><div><font size="2"   >&nbsp;(0,1) &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >&nbsp;(1,1) &nbsp; &nbsp; | &nbsp; &nbsp; 121</font></div><div><font size="2"   >&nbsp;(2,1) &nbsp; &nbsp; | &nbsp; &nbsp; 241</font></div><div><font size="2"   >&nbsp;(3,1) &nbsp; &nbsp; | &nbsp; &nbsp; 361</font></div><div><font size="2"   >&nbsp;(4,1) &nbsp; &nbsp; | &nbsp; &nbsp; 481</font></div><div><font size="2"   >&nbsp;(5,1) &nbsp; &nbsp; | &nbsp; &nbsp; 601</font></div><div><font size="2"   >&nbsp;(6,1) &nbsp; &nbsp; | &nbsp; &nbsp; 721</font></div><div><font size="2"   >&nbsp;(7,1) &nbsp; &nbsp; | &nbsp; &nbsp; 841</font></div><div><font size="2"   >&nbsp;(8,1) &nbsp; &nbsp; | &nbsp; &nbsp; 961</font></div><div><font size="2"   >&nbsp;(9,1) &nbsp; &nbsp; | &nbsp; &nbsp;1081</font></div><div><font size="2"   >&nbsp;(10,1) &nbsp; &nbsp;| &nbsp; &nbsp;1201</font></div><div><font size="2"   >&nbsp;(11,1) &nbsp; &nbsp;| &nbsp; &nbsp;1321</font></div><div><font size="2"   >&nbsp;(12,1) &nbsp; &nbsp;| &nbsp; &nbsp;1441</font></div><div><font size="2"   >&nbsp;(13,1) &nbsp; &nbsp;| &nbsp; &nbsp;1561</font></div><div><font size="2"   >&nbsp;(14,1) &nbsp; &nbsp;| &nbsp; &nbsp;1681</font></div><div><font size="2"   >&nbsp;(15,1) &nbsp; &nbsp;| &nbsp; &nbsp;1801</font></div><div><font size="2"   >&nbsp;(8333,40) | 1000000</font></div><div><font size="2"   >(17 rows)</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >0到15号数据块, 分别留1条记录, 最后一条记录也留着, 这样数据块不够的时候, 有8000多个可用, 不需要extend.</font></div><div><font size="2"   >extend会带来并发性能问题, 参考</font></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201392641033482/"   ><font size="2"   >http://blog.163.com/digoal@126/blog/static/163877040201392641033482/</font></a></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres@150-&gt; vi 1.sql</font></div><div><font size="2"   >update t set info=info where id=1;</font></div></div><div><div style="line-height: 28px;"   ><font size="2"   >postgres@150-&gt; vi 1.sql</font></div><div style="line-height: 28px;"   ><font size="2"   >update t set info=info where id=121;</font></div></div><div><font size="2"   >....</font></div><div><div style="line-height: 28px;"   ><font size="2"   >postgres@150-&gt; vi 16.sql</font></div><div style="line-height: 28px;"   ><font size="2"   >update t set info=info where id=1801;</font></div></div><div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres@150-&gt; cat *.sql</font></div><div><font size="2"   >update t set info=info where id=208;</font></div><div><font size="2"   >update t set info=info where id=231;</font></div><div><font size="2"   >update t set info=info where id=254;</font></div><div><font size="2"   >update t set info=info where id=277;</font></div><div><font size="2"   >update t set info=info where id=300;</font></div><div><font size="2"   >update t set info=info where id=323;</font></div><div><font size="2"   >update t set info=info where id=346;</font></div><div><font size="2"   >update t set info=info where id=1;</font></div><div><font size="2"   >update t set info=info where id=24;</font></div><div><font size="2"   >update t set info=info where id=47;</font></div><div><font size="2"   >update t set info=info where id=70;</font></div><div><font size="2"   >update t set info=info where id=93;</font></div><div><font size="2"   >update t set info=info where id=116;</font></div><div><font size="2"   >update t set info=info where id=139;</font></div><div><font size="2"   >update t set info=info where id=162;</font></div><div><font size="2"   >update t set info=info where id=185;</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres@150-&gt; vi pgbench.sh</font></div><div><font size="2"   >#!/bin/bash</font></div><div><div><font size="2"   >pgbench -M prepared -n -r -f ./1.sql -c 1 -j 1 -T 30 postgres &gt;&gt;./1.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -r -f ./2.sql -c 1 -j 1 -T 30 postgres &gt;&gt;./2.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -r -f ./3.sql -c 1 -j 1 -T 30 postgres &gt;&gt;./3.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -r -f ./4.sql -c 1 -j 1 -T 30 postgres &gt;&gt;./4.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -r -f ./5.sql -c 1 -j 1 -T 30 postgres &gt;&gt;./5.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -r -f ./6.sql -c 1 -j 1 -T 30 postgres &gt;&gt;./6.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -r -f ./7.sql -c 1 -j 1 -T 30 postgres &gt;&gt;./7.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -r -f ./8.sql -c 1 -j 1 -T 30 postgres &gt;&gt;./8.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -r -f ./9.sql -c 1 -j 1 -T 30 postgres &gt;&gt;./9.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -r -f ./10.sql -c 1 -j 1 -T 30 postgres &gt;&gt;./10.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -r -f ./11.sql -c 1 -j 1 -T 30 postgres &gt;&gt;./11.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -r -f ./12.sql -c 1 -j 1 -T 30 postgres &gt;&gt;./12.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -r -f ./13.sql -c 1 -j 1 -T 30 postgres &gt;&gt;./13.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -r -f ./14.sql -c 1 -j 1 -T 30 postgres &gt;&gt;./14.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -r -f ./15.sql -c 1 -j 1 -T 30 postgres &gt;&gt;./15.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"   >pgbench -M prepared -n -r -f ./16.sql -c 1 -j 1 -T 30 postgres &gt;&gt;./16.log 2&gt;&amp;1 &amp;</font></div></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres@150-&gt; chmod 500 pgbench.sh&nbsp;</font></div><div><font size="2"   >postgres@150-&gt; ./pgbench.sh</font></div><div><div><font size="2"   >postgres@150-&gt; cat *.log|grep tps</font></div><div><div><font size="2"   >tps = 3672.873229 (including connections establishing)</font></div><div><font size="2"   >tps = 3674.084633 (excluding connections establishing)</font></div><div><font size="2"   >tps = 3685.650319 (including connections establishing)</font></div><div><font size="2"   >tps = 3686.373174 (excluding connections establishing)</font></div><div><font size="2"   >tps = 3653.782264 (including connections establishing)</font></div><div><font size="2"   >tps = 3654.560790 (excluding connections establishing)</font></div><div><font size="2"   >tps = 3670.157736 (including connections establishing)</font></div><div><font size="2"   >tps = 3670.585236 (excluding connections establishing)</font></div><div><font size="2"   >tps = 3719.693785 (including connections establishing)</font></div><div><font size="2"   >tps = 3721.128932 (excluding connections establishing)</font></div><div><font size="2"   >tps = 3657.118339 (including connections establishing)</font></div><div><font size="2"   >tps = 3657.686863 (excluding connections establishing)</font></div><div><font size="2"   >tps = 3654.958991 (including connections establishing)</font></div><div><font size="2"   >tps = 3655.591042 (excluding connections establishing)</font></div><div><font size="2"   >tps = 3719.656030 (including connections establishing)</font></div><div><font size="2"   >tps = 3720.337811 (excluding connections establishing)</font></div><div><font size="2"   >tps = 3693.337183 (including connections establishing)</font></div><div><font size="2"   >tps = 3694.274766 (excluding connections establishing)</font></div><div><font size="2"   >tps = 3716.171161 (including connections establishing)</font></div><div><font size="2"   >tps = 3717.813401 (excluding connections establishing)</font></div><div><font size="2"   >tps = 3675.841437 (including connections establishing)</font></div><div><font size="2"   >tps = 3676.939467 (excluding connections establishing)</font></div><div><font size="2"   >tps = 3707.384923 (including connections establishing)</font></div><div><font size="2"   >tps = 3708.461362 (excluding connections establishing)</font></div><div><font size="2"   >tps = 3708.588009 (including connections establishing)</font></div><div><font size="2"   >tps = 3709.317135 (excluding connections establishing)</font></div><div><font size="2"   >tps = 3699.878541 (including connections establishing)</font></div><div><font size="2"   >tps = 3700.777084 (excluding connections establishing)</font></div><div><font size="2"   >tps = 3722.057237 (including connections establishing)</font></div><div><font size="2"   >tps = 3722.764437 (excluding connections establishing)</font></div><div><font size="2"   >tps = 3712.575425 (including connections establishing)</font></div><div><font size="2"   >tps = 3713.156881 (excluding connections establishing)</font></div></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres=# select ctid,id from t where id in (1,121,241,361,481,601,721,841,961,1081,1201,1321,1441,1561,1681,1801,1000000) order by 1;</font></div><div><font size="2"   >&nbsp; &nbsp;ctid &nbsp; &nbsp;| &nbsp; id &nbsp; &nbsp;</font></div><div><font size="2"   >-----------+---------</font></div><div><font size="2"   >&nbsp;(93,73) &nbsp; | &nbsp; &nbsp;1321</font></div><div><font size="2"   >&nbsp;(131,95) &nbsp;| &nbsp; &nbsp; 241</font></div><div><font size="2"   >&nbsp;(132,22) &nbsp;| &nbsp; &nbsp; 841</font></div><div><font size="2"   >&nbsp;(133,87) &nbsp;| &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >&nbsp;(134,74) &nbsp;| &nbsp; &nbsp;1561</font></div><div><font size="2"   >&nbsp;(135,68) &nbsp;| &nbsp; &nbsp; 121</font></div><div><font size="2"   >&nbsp;(136,40) &nbsp;| &nbsp; &nbsp; 601</font></div><div><font size="2"   >&nbsp;(137,57) &nbsp;| &nbsp; &nbsp;1081</font></div><div><font size="2"   >&nbsp;(138,100) | &nbsp; &nbsp;1801</font></div><div><font size="2"   >&nbsp;(139,91) &nbsp;| &nbsp; &nbsp; 961</font></div><div><font size="2"   >&nbsp;(140,72) &nbsp;| &nbsp; &nbsp;1201</font></div><div><font size="2"   >&nbsp;(141,22) &nbsp;| &nbsp; &nbsp; 481</font></div><div><font size="2"   >&nbsp;(142,103) | &nbsp; &nbsp;1441</font></div><div><font size="2"   >&nbsp;(143,63) &nbsp;| &nbsp; &nbsp; 721</font></div><div><font size="2"   >&nbsp;(144,35) &nbsp;| &nbsp; &nbsp; 361</font></div><div><font size="2"   >&nbsp;(145,76) &nbsp;| &nbsp; &nbsp;1681</font></div><div><font size="2"   >&nbsp;(8333,40) | 1000000</font></div><div><font size="2"   >(17 rows)</font></div></div><p></p></pre><div><br></div><div>集中数据块测试结果 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><div><font size="2"   >postgres=# truncate t;</font></div><div><font size="2"   >TRUNCATE TABLE</font></div><div><font size="2"   >postgres=# insert into t select generate_series(1,1000000),md5(random()::text);</font></div><div><font size="2"   >INSERT 0 1000000</font></div><div><font size="2"   >postgres=# delete from t where id&gt;16 and id&lt;&gt;1000000;</font></div><div><font size="2"   >DELETE 999983</font></div><div><font size="2"   >postgres=# vacuum analyze t;</font></div><div><font size="2"   >VACUUM</font></div><div><font size="2"   >postgres=# select ctid,id from t;</font></div><div><font size="2"   >&nbsp; &nbsp;ctid &nbsp; &nbsp;| &nbsp; id &nbsp; &nbsp;</font></div><div><font size="2"   >-----------+---------</font></div><div><font size="2"   >&nbsp;(0,1) &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >&nbsp;(0,2) &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 2</font></div><div><font size="2"   >&nbsp;(0,3) &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 3</font></div><div><font size="2"   >&nbsp;(0,4) &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 4</font></div><div><font size="2"   >&nbsp;(0,5) &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 5</font></div><div><font size="2"   >&nbsp;(0,6) &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 6</font></div><div><font size="2"   >&nbsp;(0,7) &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 7</font></div><div><font size="2"   >&nbsp;(0,8) &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 8</font></div><div><font size="2"   >&nbsp;(0,9) &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 9</font></div><div><font size="2"   >&nbsp;(0,10) &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;10</font></div><div><font size="2"   >&nbsp;(0,11) &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;11</font></div><div><font size="2"   >&nbsp;(0,12) &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;12</font></div><div><font size="2"   >&nbsp;(0,13) &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;13</font></div><div><font size="2"   >&nbsp;(0,14) &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;14</font></div><div><font size="2"   >&nbsp;(0,15) &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;15</font></div><div><font size="2"   >&nbsp;(0,16) &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp;16</font></div><div><font size="2"   >&nbsp;(8333,40) | 1000000</font></div><div><font size="2"   >(17 rows)</font></div></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres@150-&gt; rm -f *.log</font></div><div><div><font size="2"   >postgres@150-&gt; vi 1.sql</font></div><div><font size="2"   >update t set info=info where id=1;</font></div></div><div><div style="line-height: 28px;"   ><font size="2"   >postgres@150-&gt; vi 2.sql</font></div><div style="line-height: 28px;"   ><font size="2"   >update t set info=info where id=2;</font></div></div><div style="line-height: 28px;"   ><font size="2"   >......</font></div><div><div style="line-height: 28px;"   ><font size="2"   >postgres@150-&gt; vi 16.sql</font></div><div style="line-height: 28px;"   ><font size="2"   >update t set info=info where id=16;</font></div><div style="line-height: 28px;"   ><font size="2"   ><br></font></div><div><div style="line-height: 28px;"   ><font size="2"   >postgres@150-&gt; cat *.sql</font></div><div style="line-height: 28px;"   ><font size="2"   >update t set info=info where id=10;</font></div><div style="line-height: 28px;"   ><font size="2"   >update t set info=info where id=11;</font></div><div style="line-height: 28px;"   ><font size="2"   >update t set info=info where id=12;</font></div><div style="line-height: 28px;"   ><font size="2"   >update t set info=info where id=13;</font></div><div style="line-height: 28px;"   ><font size="2"   >update t set info=info where id=14;</font></div><div style="line-height: 28px;"   ><font size="2"   >update t set info=info where id=15;</font></div><div style="line-height: 28px;"   ><font size="2"   >update t set info=info where id=16;</font></div><div style="line-height: 28px;"   ><font size="2"   >update t set info=info where id=1;</font></div><div style="line-height: 28px;"   ><font size="2"   >update t set info=info where id=2;</font></div><div style="line-height: 28px;"   ><font size="2"   >update t set info=info where id=3;</font></div><div style="line-height: 28px;"   ><font size="2"   >update t set info=info where id=4;</font></div><div style="line-height: 28px;"   ><font size="2"   >update t set info=info where id=5;</font></div><div style="line-height: 28px;"   ><font size="2"   >update t set info=info where id=6;</font></div><div style="line-height: 28px;"   ><font size="2"   >update t set info=info where id=7;</font></div><div style="line-height: 28px;"   ><font size="2"   >update t set info=info where id=8;</font></div><div style="line-height: 28px;"   ><font size="2"   >update t set info=info where id=9;</font></div><div style="line-height: 28px;"   ><font size="2"   ><br></font></div><div><font size="2"   >postgres@150-&gt; ./pgbench.sh&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   ><br></font></div><div><div style="line-height: 28px;"   ><font size="2"   >postgres@150-&gt; cat *.log|grep tps</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >tps = 3888.022965 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3889.158726 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3923.116595 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3923.860425 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3872.785025 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3873.557022 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3896.719305 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3897.583396 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3899.784823 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3900.417804 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3888.087169 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3889.095219 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3837.783625 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3838.628632 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3913.921265 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3914.976339 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3919.896441 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3921.285015 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3901.743906 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3902.875213 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3913.348143 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3914.736302 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3900.593759 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3901.597639 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3909.233257 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3910.714989 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3914.511060 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3915.443282 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3898.280379 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3899.420043 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3905.201198 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3905.983808 (excluding connections establishing)</font></div></div><div style="line-height: 28px;"   ><font size="2"   ><br></font></div><div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >postgres=# select ctid,id from t order by 1;</font></span></div><div><div><font size="2"   >&nbsp; &nbsp;ctid &nbsp; &nbsp;| &nbsp; id &nbsp; &nbsp;</font></div><div><font size="2"   >-----------+---------</font></div><div><font size="2"   >&nbsp;(23,63) &nbsp; | &nbsp; &nbsp; &nbsp;10</font></div><div><font size="2"   >&nbsp;(32,105) &nbsp;| &nbsp; &nbsp; &nbsp; 4</font></div><div><font size="2"   >&nbsp;(33,85) &nbsp; | &nbsp; &nbsp; &nbsp; 6</font></div><div><font size="2"   >&nbsp;(34,19) &nbsp; | &nbsp; &nbsp; &nbsp;12</font></div><div><font size="2"   >&nbsp;(35,107) &nbsp;| &nbsp; &nbsp; &nbsp;11</font></div><div><font size="2"   >&nbsp;(36,30) &nbsp; | &nbsp; &nbsp; &nbsp;13</font></div><div><font size="2"   >&nbsp;(37,51) &nbsp; | &nbsp; &nbsp; &nbsp;16</font></div><div><font size="2"   >&nbsp;(38,8) &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 7</font></div><div><font size="2"   >&nbsp;(39,43) &nbsp; | &nbsp; &nbsp; &nbsp; 2</font></div><div><font size="2"   >&nbsp;(40,101) &nbsp;| &nbsp; &nbsp; &nbsp; 9</font></div><div><font size="2"   >&nbsp;(41,41) &nbsp; | &nbsp; &nbsp; &nbsp; 3</font></div><div><font size="2"   >&nbsp;(42,20) &nbsp; | &nbsp; &nbsp; &nbsp; 8</font></div><div><font size="2"   >&nbsp;(43,77) &nbsp; | &nbsp; &nbsp; &nbsp; 5</font></div><div><font size="2"   >&nbsp;(44,98) &nbsp; | &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >&nbsp;(45,12) &nbsp; | &nbsp; &nbsp; &nbsp;14</font></div><div><font size="2"   >&nbsp;(46,40) &nbsp; | &nbsp; &nbsp; &nbsp;15</font></div><div><font size="2"   >&nbsp;(8333,40) | 1000000</font></div><div><font size="2"   >(17 rows)</font></div></div></div></div></div></div><p></p></pre></div><div><div><div><div><div><br></div><div>分散数据块, reindex后的测试结果 :&nbsp;</div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div><div><div><div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >postgres=# reindex table t;</font></div><div style="line-height: 28px;"   ><font size="2"   >REINDEX</font></div><div style="line-height: 28px;"   ><font size="2"   >postgres=# vacuum analyze t;</font></div><div style="line-height: 28px;"   ><font size="2"   >VACUUM</font></div><div style="line-height: 28px;"   ><font size="2"   ><br></font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >postgres@150-&gt; cat *.log|grep tps</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3735.684435 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3736.550937 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3823.225305 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3823.810601 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3848.319864 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3849.356364 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3759.871676 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3761.049251 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3831.644315 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3833.049248 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3754.788360 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3755.528322 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3849.588836 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3850.083699 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3812.558787 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3813.416042 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3664.343948 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3665.407154 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3848.094869 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3849.160059 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3630.066603 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3631.600577 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3780.052566 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3780.731445 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3817.373533 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3818.071217 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3809.571428 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3810.561532 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3814.418711 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3815.272057 (excluding connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3807.109222 (including connections establishing)</font></div><div style="line-height: 28px;"   ><font size="2"   >tps = 3807.699411 (excluding connections establishing)</font></div></div></div></div></div><div style="line-height: 28px;"   ><font size="2"   ><br></font></div></div></div></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >postgres=# select ctid,id from t order by 1;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;ctid &nbsp; &nbsp;| &nbsp; id &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >-----------+---------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;(0,8) &nbsp; &nbsp; | &nbsp; &nbsp;1441</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;(1,50) &nbsp; &nbsp;| &nbsp; &nbsp; 481</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;(2,50) &nbsp; &nbsp;| &nbsp; &nbsp;1201</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;(3,58) &nbsp; &nbsp;| &nbsp; &nbsp; 721</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;(21,35) &nbsp; | &nbsp; &nbsp; 961</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;(27,83) &nbsp; | &nbsp; &nbsp; &nbsp; 1</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;(29,91) &nbsp; | &nbsp; &nbsp; 361</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;(30,63) &nbsp; | &nbsp; &nbsp;1681</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;(31,68) &nbsp; | &nbsp; &nbsp;1081</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;(32,62) &nbsp; | &nbsp; &nbsp; 121</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;(33,7) &nbsp; &nbsp;| &nbsp; &nbsp; 841</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;(34,103) &nbsp;| &nbsp; &nbsp;1321</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;(37,73) &nbsp; | &nbsp; &nbsp;1801</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;(39,79) &nbsp; | &nbsp; &nbsp; 601</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;(41,31) &nbsp; | &nbsp; &nbsp;1561</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;(42,42) &nbsp; | &nbsp; &nbsp; 241</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;(8333,40) | 1000000</font></div><div style="line-height: 28px;"   ><font size="2"   >(17 rows)</font></div></div><p></p></pre></div></div></div></div></div></div></div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201392641033482/"   >http://blog.163.com/digoal@126/blog/static/163877040201392641033482/</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL has same block update conflict problem? NO problem. - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>