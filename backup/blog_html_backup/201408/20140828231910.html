<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL flash back query emulate by trigger</h2>
	<h5 id="">2014-08-28 23:19:10&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402014728105442434/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div><div>今天群里又聊到了PostgreSQL的闪回这个东西, 我之前写过一篇关于利用PostgreSQL mvcc特性来模拟闪回, 找回数据的文章, 有兴趣的同学可以参考如下 :&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201251911813661/"   >http://blog.163.com/digoal@126/blog/static/163877040201251911813661/</a></div><div>使用以上方法需要担心的一个问题是数据可能被VACUUM掉了, 所以我们可以定制表的autovacuum threshold, 让重点保护的表的autovacuum 阈值较大, 减少VACUUM的间隔, 或者关闭重点保护的表的autovacuum, 改为人为调度VACUUM. 或者改<span style="line-height: 22px; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53;"   >vacuum_defer_cleanup_age参数, 延迟多少个事务之后再回收.</span></div><div>但是使用以上方法也不适合生产, 因为还要停库, 改控制文件, 都是非常危险的操作. (当然你如果为了找回重要数据, 那么拿备库来做也是值得考虑的.)</div><div>如果可以在会话层欺骗数据库当前未分配事务号, 最早已提交事务号的话, 其实就不需要修改这么麻烦了. 当然这个就需要改代码了, 因为这部分数据在共享内存区, 直接改的话危险系数太高, 想办法搞成会话层面的吧还好一点.&nbsp;</div><div><br></div><div>本文要介绍另一种闪回方法,&nbsp;<span style="line-height: 28px;"   >触发器.</span></div><div>步骤如下 :&nbsp;</div><div><br></div><div><div>1.&nbsp;<span style="line-height: 28px;"   >首先要记录所有的DML以及truncate. 也就是对于insert, update, delete, truncate操作, 我们可以回退.&nbsp;</span><span style="line-height: 28px;"   >通过触发器来记录old value, new value.</span></div><div>2. 需要闪回的表必须有PK, PK列可以被更新. 如果没有PK的话, 不能唯一的定位到一条记录. 因为PG的行号无法定位到一条记录, 一条记录一旦被更新, 是会生成一个新版本的.&nbsp;</div><div>3. INSERT的UNDO, delete where pk=NEW.pk</div><div>&nbsp; &nbsp; UPDATE的UNDO, UPDATE set cols=OLD.* where pk=NEW.pk</div><div>&nbsp; &nbsp; DELETE和TRUNCATE的UNDO, insert into values (OLD.*)</div><div>4. 表的SCHEMA可能会变, 表名可能会变, 列的类型可能会变, 可能会新增列, 可能会删除列.&nbsp;</div><div>这些都必须考虑, 因为DDL不被跟踪. &nbsp;所以我们不直接记录UNDO_SQL, 而是在UNDO时根据当前的数据定义来组装SQL. 并且本方法也不支持DDL的闪回.</div><div>需要DDL的闪回, 或者完美的闪回, 请使用PITR.</div><div>同时, 为了区分需要闪回的表, 我们不能把跟踪记录放在同一个表里面用schema和tablename来区分, 因为schema和tablename可能被DDL改掉, 那么就会造成取不到记录的情况. 例如TIME1, A表,执行了一些DML后, 改名为B表了, 有执行了一些DML, 然后我们要回退到TIME1的时间点, 根据当前表名B, 从统一的跟踪表undo_table里面取记录的话, 需要告诉跟踪表名字为B, XID为?然后取数据拼装UNDO SQL, 这样的话表名为A的记录时取不出来的, 因为过滤条件是tablename=B. 所以跟踪表要每个表各自一个.</div><div>tablea, undo_tablea, tableb, undo_tableb.....这样就不管表或者SCHEMA怎么变了.</div></div><div>注意我们不使用hstore来存储被跟踪表的记录, 原因是回退的时候很麻烦, hstore没有直接转换成record的接口. 我们直接使用表的复合类型来存储被跟踪表的记录.</div><div><br></div><div>例子 :&nbsp;</div><div>为了增加复杂度, 我们使用大写表名, 列名.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create table public."TBL" (</font></div><div><font size="2"   >&nbsp; c1 int,</font></div><div><font size="2"   >&nbsp; c2 int,</font></div><div><font size="2"   >&nbsp; "C3" text,</font></div><div><font size="2"   >&nbsp; c4 text,</font></div><div><font size="2"   >&nbsp; c5 text,</font></div><div><font size="2"   >&nbsp; c6 text,</font></div><div><font size="2"   >&nbsp; c7 int,</font></div><div><font size="2"   >&nbsp; crt_time timestamp,</font></div><div><font size="2"   >&nbsp; primary key (c1,"C3",c6,c4)</font></div><div><font size="2"   >);</font></div><p></p></pre></div><div>创建记录表, 跟踪表的DML和truncate. 可以增加一列txid_snapshot类型存储txid_current_snapshot(), 这样就能回退到一个一致的点了.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE TABLE public.undo_t (</font></div><div><font size="2"   >&nbsp; id serial8 primary key,</font></div><div><font size="2"   >&nbsp; xid int8,</font></div><div><font size="2"   >&nbsp; relid oid,</font></div><div><font size="2"   >&nbsp; table_schema text,</font></div><div><font size="2"   >&nbsp; table_name text,</font></div><div><font size="2"   >&nbsp; when_tg text,</font></div><div><font size="2"   >&nbsp; level text,</font></div><div><font size="2"   >&nbsp; op text,</font></div><div><font size="2"   >&nbsp; encoding name,</font></div><div><font size="2"   >&nbsp; old_rec public."TBL",</font></div><div><font size="2"   >&nbsp; new_rec public."TBL",</font></div><div><font size="2"   >&nbsp; crt_time timestamp without time zone DEFAULT now(),</font></div><div><font size="2"   >&nbsp; username text,</font></div><div><font size="2"   >&nbsp; client_addr inet,</font></div><div><font size="2"   >&nbsp; client_port int</font></div><div><font size="2"   >);</font></div><p></p></pre></div><div><br></div><div>创建触发器函数, 将DML, TRUNCATE的数据插入跟踪表</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE OR REPLACE FUNCTION public.undo_t_trace()</font></div><div><font size="2"   >RETURNS trigger</font></div><div><font size="2"   >LANGUAGE plpgsql</font></div><div><font size="2"   >AS $BODY$</font></div><div><font size="2"   >DECLARE</font></div><div><font size="2"   >&nbsp; v_username text := session_user;</font></div><div><font size="2"   >&nbsp; v_client_addr inet := inet_client_addr();</font></div><div><font size="2"   >&nbsp; v_client_port int := inet_client_port();</font></div><div><font size="2"   >&nbsp; v_xid bigint := txid_current();  -- 记录事务号, 回退时以事务号为界限.</font></div><div><font size="2"   >&nbsp; v_encoding name := pg_client_encoding();</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >&nbsp; case TG_OP</font></div><div><font size="2"   >&nbsp; when 'DELETE' then&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; insert into public.undo_t (xid, relid, table_schema, table_name, when_tg, level, op, encoding, old_rec, username, client_addr, client_port)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; values (v_xid, tg_relid, tg_table_schema, tg_table_name, tg_when, tg_level, tg_op, v_encoding, OLD, v_username, v_client_addr, v_client_port);</font></div><div><font size="2"   >&nbsp; when 'INSERT' then&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; insert into public.undo_t (xid, relid, table_schema, table_name, when_tg, level, op, encoding, new_rec, username, client_addr, client_port)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; values (v_xid, tg_relid, tg_table_schema, tg_table_name, tg_when, tg_level, tg_op, v_encoding, NEW, v_username, v_client_addr, v_client_port);</font></div><div><font size="2"   >&nbsp; when 'UPDATE' then&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; insert into public.undo_t (xid, relid, table_schema, table_name, when_tg, level, op, encoding, old_rec, new_rec, username, client_addr, client_port)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; values (v_xid, tg_relid, tg_table_schema, tg_table_name, tg_when, tg_level, tg_op, v_encoding, OLD, NEW, v_username, v_client_addr, v_client_port);</font></div><div><font size="2"   >&nbsp; when 'TRUNCATE' then&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; insert into public.undo_t (xid, relid, table_schema, table_name, when_tg, level, op, encoding, old_rec, username, client_addr, client_port)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; select v_xid, tg_relid, tg_table_schema, tg_table_name, tg_when, tg_level, tg_op, v_encoding, t, v_username, v_client_addr, v_client_port from public."TBL" AS t;</font></div><div><font size="2"   >&nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; return null;</font></div><div><font size="2"   >&nbsp; end case;</font></div><div><font size="2"   >&nbsp; RETURN null;</font></div><div><font size="2"   >END;</font></div><div><font size="2"   >$BODY$ strict volatile;</font></div><p></p></pre></div><div><br></div><div>添加触发器, 记录表的dml和truncate.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE TRIGGER tg1 AFTER DELETE or INSERT or UPDATE ON public."TBL" FOR EACH ROW EXECUTE PROCEDURE public.undo_t_trace();</font></div><div><font size="2"   >CREATE TRIGGER tg2 BEFORE TRUNCATE ON public."TBL" FOR EACH STATEMENT EXECUTE PROCEDURE public.undo_t_trace();</font></div><p></p></pre></div><div><br></div><div>插入测试数据, 为了增加难度, 我们使用了转义字符. 确保前后数据一致.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >insert into "TBL" values (1,1,'te\\s\t','c4','c5','c6',1,now());</font></div><div><span style="line-height: 28px;"   ><font size="2"   >insert into "TBL" values (2,1,'te\\s\t','c4','c5','c6',1,now());</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >insert into "TBL" values (3,1,'te\\s\t','c4','c5','c6',1,now());</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >insert into "TBL" values (4,1,'te\\s\t','c4','c5','c6',1,now());</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >insert into "TBL" values (5,1,'te\\s\t','c4','c5','c6',1,now());</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >insert into "TBL" values (6,1,'te\\s\t','c4','c5','c6',1,now());</font></span></div><p></p></pre></div><div>插入后, 可以看到 INSERT被跟踪了, 并且我们存储了插入数据时的客户端编码. 方便解决编码问题.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from undo_t;</font></div><div><font size="2"   >&nbsp;id | &nbsp; xid &nbsp; | &nbsp;relid &nbsp; | table_schema | table_name | when_tg | level | &nbsp; op &nbsp; | encoding | old_rec | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;new_</font></div><div><font size="2"   >rec &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| username | client_addr | client_port&nbsp;</font></div><div><font size="2"   >----+---------+----------+--------------+------------+---------+-------+--------+----------+---------+------------------------------</font></div><div><font size="2"   >------------------------------+----------------------------+----------+-------------+-------------</font></div><div><font size="2"   >&nbsp; 1 | 1301665 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | INSERT | UTF8 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | (1,1,"te\\\\s\\t",c4,c5,c6,1,</font></div><div><font size="2"   >"2014-08-28 23:06:09.790227") | 2014-08-28 23:06:09.790227 | postgres | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 2 | 1301666 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | INSERT | UTF8 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | (2,1,"te\\\\s\\t",c4,c5,c6,1,</font></div><div><font size="2"   >"2014-08-28 23:06:09.79597") &nbsp;| 2014-08-28 23:06:09.79597 &nbsp;| postgres | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 3 | 1301667 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | INSERT | UTF8 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | (3,1,"te\\\\s\\t",c4,c5,c6,1,</font></div><div><font size="2"   >"2014-08-28 23:06:09.80206") &nbsp;| 2014-08-28 23:06:09.80206 &nbsp;| postgres | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 4 | 1301668 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | INSERT | UTF8 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | (4,1,"te\\\\s\\t",c4,c5,c6,1,</font></div><div><font size="2"   >"2014-08-28 23:06:09.80903") &nbsp;| 2014-08-28 23:06:09.80903 &nbsp;| postgres | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 5 | 1301669 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | INSERT | UTF8 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | (5,1,"te\\\\s\\t",c4,c5,c6,1,</font></div><div><font size="2"   >"2014-08-28 23:06:09.819092") | 2014-08-28 23:06:09.819092 | postgres | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 6 | 1301670 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | INSERT | UTF8 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | (6,1,"te\\\\s\\t",c4,c5,c6,1,</font></div><div><font size="2"   >"2014-08-28 23:06:10.228624") | 2014-08-28 23:06:10.228624 | postgres | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >(6 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select * from "TBL";</font></div><div><font size="2"   >&nbsp;c1 | c2 | &nbsp; C3 &nbsp; &nbsp;| c4 | c5 | c6 | c7 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+----+---------+----+----+----+----+----------------------------</font></div><div><font size="2"   >&nbsp; 1 | &nbsp;1 | te\\s\t | c4 | c5 | c6 | &nbsp;1 | 2014-08-28 23:06:09.790227</font></div><div><font size="2"   >&nbsp; 2 | &nbsp;1 | te\\s\t | c4 | c5 | c6 | &nbsp;1 | 2014-08-28 23:06:09.79597</font></div><div><font size="2"   >&nbsp; 3 | &nbsp;1 | te\\s\t | c4 | c5 | c6 | &nbsp;1 | 2014-08-28 23:06:09.80206</font></div><div><font size="2"   >&nbsp; 4 | &nbsp;1 | te\\s\t | c4 | c5 | c6 | &nbsp;1 | 2014-08-28 23:06:09.80903</font></div><div><font size="2"   >&nbsp; 5 | &nbsp;1 | te\\s\t | c4 | c5 | c6 | &nbsp;1 | 2014-08-28 23:06:09.819092</font></div><div><font size="2"   >&nbsp; 6 | &nbsp;1 | te\\s\t | c4 | c5 | c6 | &nbsp;1 | 2014-08-28 23:06:10.228624</font></div><div><font size="2"   >(6 rows)</font></div><p></p></pre></div></div><div><br></div><div>回退操作我们这里用一个inline plpgsql 代码来处理, 如果你要写成函数也可以, 只需要传入一个XID即可.</div><div><br></div><div>回退最后一个事务, 即c1=6的那条记录. 以事务号1301670为界限.</div><div>注意变量使用标量, 因为在for 和 cursor fetch到一个变量时, 变量必须是标量.</div><div>参考代码 :&nbsp;</div><div>src/pl/plpgsql/src/pl_gram.y</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >do language plpgsql $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; v_op text;</font></div><div><font size="2"   >&nbsp; v_encoding_curr text := pg_client_encoding();&nbsp;</font></div><div><font size="2"   >&nbsp; v_encoding_tmp text;</font></div><div><font size="2"   >&nbsp; v_old text;  -- 本来这里打算用public."TBL"来作为变量类型, 不过for, cursor都不允许存储非标量类型, 所以还是选择了标量text, 使用时转换.</font></div><div><font size="2"   >&nbsp; v_new text;</font></div><div><font size="2"   >&nbsp; v_xid int8 := 1301670;&nbsp;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; for v_op, v_encoding_tmp, v_old, v_new in&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; select op,encoding,old_rec::text,new_rec::text from undo_t where xid&gt;=v_xid order by xid desc,id desc</font></div><div><font size="2"   >&nbsp; LOOP</font></div><div><font size="2"   >&nbsp; &nbsp; execute 'set client_encoding='''||v_encoding_tmp||'''';</font></div><div><font size="2"   >&nbsp; &nbsp; case v_op&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; when 'INSERT' then&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; delete from public."TBL" t where t=v_new::public."TBL";&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; when 'DELETE' then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; insert into public."TBL" values ((v_old::public."TBL").*);&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; when 'TRUNCATE' then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; insert into public."TBL" values ((v_old::public."TBL").*);&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; when 'UPDATE' then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; delete from public."TBL" t where t=v_new::public."TBL";&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; insert into public."TBL" values ((v_old::public."TBL").*);&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; end case;&nbsp;</font></div><div><font size="2"   >&nbsp; end loop;&nbsp;</font></div><div><font size="2"   >&nbsp; execute 'set client_encoding='''||v_encoding_curr||'''';&nbsp;</font></div><div><font size="2"   >end;&nbsp;</font></div><div><font size="2"   >$$;</font></div><p></p></pre></div><div>回退成功</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from "TBL";</font></div><div><font size="2"   >&nbsp;c1 | c2 | &nbsp; C3 &nbsp; &nbsp;| c4 | c5 | c6 | c7 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+----+---------+----+----+----+----+----------------------------</font></div><div><font size="2"   >&nbsp; 1 | &nbsp;1 | te\\s\t | c4 | c5 | c6 | &nbsp;1 | 2014-08-28 23:06:09.790227</font></div><div><font size="2"   >&nbsp; 2 | &nbsp;1 | te\\s\t | c4 | c5 | c6 | &nbsp;1 | 2014-08-28 23:06:09.79597</font></div><div><font size="2"   >&nbsp; 3 | &nbsp;1 | te\\s\t | c4 | c5 | c6 | &nbsp;1 | 2014-08-28 23:06:09.80206</font></div><div><font size="2"   >&nbsp; 4 | &nbsp;1 | te\\s\t | c4 | c5 | c6 | &nbsp;1 | 2014-08-28 23:06:09.80903</font></div><div><font size="2"   >&nbsp; 5 | &nbsp;1 | te\\s\t | c4 | c5 | c6 | &nbsp;1 | 2014-08-28 23:06:09.819092</font></div><div><font size="2"   >(5 rows)</font></div><p></p></pre></div><div>回退操作同样会产生undo记录.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from undo_t;</font></div><div><font size="2"   >&nbsp;id | &nbsp; xid &nbsp; | &nbsp;relid &nbsp; | table_schema | table_name | when_tg | level | &nbsp; op &nbsp; | encoding | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;old_rec &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;new_rec &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| username | client_ad</font></div><div><font size="2"   >dr | client_port&nbsp;</font></div><div><font size="2"   >----+---------+----------+--------------+------------+---------+-------+--------+----------+----------------------------------------</font></div><div><font size="2"   >--------------------+------------------------------------------------------------+----------------------------+----------+----------</font></div><div><font size="2"   >---+-------------</font></div><div><font size="2"   >&nbsp; 1 | 1301665 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | INSERT | UTF8 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | (1,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-28 23:06:09.790227") | 2014-08-28 23:06:09.790227 | postgres | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 2 | 1301666 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | INSERT | UTF8 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | (2,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-28 23:06:09.79597") &nbsp;| 2014-08-28 23:06:09.79597 &nbsp;| postgres | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 3 | 1301667 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | INSERT | UTF8 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | (3,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-28 23:06:09.80206") &nbsp;| 2014-08-28 23:06:09.80206 &nbsp;| postgres | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 4 | 1301668 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | INSERT | UTF8 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | (4,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-28 23:06:09.80903") &nbsp;| 2014-08-28 23:06:09.80903 &nbsp;| postgres | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 5 | 1301669 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | INSERT | UTF8 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | (5,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-28 23:06:09.819092") | 2014-08-28 23:06:09.819092 | postgres | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 6 | 1301670 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | INSERT | UTF8 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | (6,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-28 23:06:10.228624") | 2014-08-28 23:06:10.228624 | postgres | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 7 | 1301671 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | DELETE | UTF8 &nbsp; &nbsp; | (6,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-2</font></div><div><font size="2"   >8 23:06:10.228624") | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2014-08-28 23:07:07.750644 | postgres | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >(7 rows)</font></div><p></p></pre></div></div><div><br></div></div><div>现在执行一个UPDATE, 把所有的记录更新掉.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# update "TBL" set c7=100;</font></div><div><font size="2"   >UPDATE 5</font></div><div><font size="2"   >postgres=# select * from "TBL";</font></div><div><font size="2"   >&nbsp;c1 | c2 | &nbsp; C3 &nbsp; &nbsp;| c4 | c5 | c6 | c7 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+----+---------+----+----+----+-----+----------------------------</font></div><div><font size="2"   >&nbsp; 1 | &nbsp;1 | te\\s\t | c4 | c5 | c6 | 100 | 2014-08-28 23:06:09.790227</font></div><div><font size="2"   >&nbsp; 2 | &nbsp;1 | te\\s\t | c4 | c5 | c6 | 100 | 2014-08-28 23:06:09.79597</font></div><div><font size="2"   >&nbsp; 3 | &nbsp;1 | te\\s\t | c4 | c5 | c6 | 100 | 2014-08-28 23:06:09.80206</font></div><div><font size="2"   >&nbsp; 4 | &nbsp;1 | te\\s\t | c4 | c5 | c6 | 100 | 2014-08-28 23:06:09.80903</font></div><div><font size="2"   >&nbsp; 5 | &nbsp;1 | te\\s\t | c4 | c5 | c6 | 100 | 2014-08-28 23:06:09.819092</font></div><div><font size="2"   >(5 rows)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres=# select * from undo_t;</font></div><div><font size="2"   >&nbsp;id | &nbsp; xid &nbsp; | &nbsp;relid &nbsp; | table_schema | table_name | when_tg | level | &nbsp; op &nbsp; | encoding | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;old_rec &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_rec &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| username | client_</font></div><div><font size="2"   >addr | client_port&nbsp;</font></div><div><font size="2"   >----+---------+----------+--------------+------------+---------+-------+--------+----------+----------------------------------------</font></div><div><font size="2"   >--------------------+--------------------------------------------------------------+----------------------------+----------+--------</font></div><div><font size="2"   >-----+-------------</font></div><div><font size="2"   >&nbsp; 1 | 1301665 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | INSERT | UTF8 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | (1,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-28 23:06:09.790227") &nbsp; | 2014-08-28 23:06:09.790227 | postgres | &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 2 | 1301666 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | INSERT | UTF8 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | (2,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-28 23:06:09.79597") &nbsp; &nbsp;| 2014-08-28 23:06:09.79597 &nbsp;| postgres | &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 3 | 1301667 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | INSERT | UTF8 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | (3,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-28 23:06:09.80206") &nbsp; &nbsp;| 2014-08-28 23:06:09.80206 &nbsp;| postgres | &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 4 | 1301668 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | INSERT | UTF8 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | (4,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-28 23:06:09.80903") &nbsp; &nbsp;| 2014-08-28 23:06:09.80903 &nbsp;| postgres | &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 5 | 1301669 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | INSERT | UTF8 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | (5,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-28 23:06:09.819092") &nbsp; | 2014-08-28 23:06:09.819092 | postgres | &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 6 | 1301670 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | INSERT | UTF8 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | (6,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-28 23:06:10.228624") &nbsp; | 2014-08-28 23:06:10.228624 | postgres | &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 7 | 1301671 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | DELETE | UTF8 &nbsp; &nbsp; | (6,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-2</font></div><div><font size="2"   >8 23:06:10.228624") | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2014-08-28 23:07:07.750644 | postgres | &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 8 | 1301672 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | UPDATE | UTF8 &nbsp; &nbsp; | (1,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-2</font></div><div><font size="2"   >8 23:06:09.790227") | (1,1,"te\\\\s\\t",c4,c5,c6,100,"2014-08-28 23:06:09.790227") | 2014-08-28 23:08:52.887568 | postgres | &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; 9 | 1301672 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | UPDATE | UTF8 &nbsp; &nbsp; | (2,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-2</font></div><div><font size="2"   >8 23:06:09.79597") &nbsp;| (2,1,"te\\\\s\\t",c4,c5,c6,100,"2014-08-28 23:06:09.79597") &nbsp;| 2014-08-28 23:08:52.887568 | postgres | &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;10 | 1301672 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | UPDATE | UTF8 &nbsp; &nbsp; | (3,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-2</font></div><div><font size="2"   >8 23:06:09.80206") &nbsp;| (3,1,"te\\\\s\\t",c4,c5,c6,100,"2014-08-28 23:06:09.80206") &nbsp;| 2014-08-28 23:08:52.887568 | postgres | &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;11 | 1301672 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | UPDATE | UTF8 &nbsp; &nbsp; | (4,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-2</font></div><div><font size="2"   >8 23:06:09.80903") &nbsp;| (4,1,"te\\\\s\\t",c4,c5,c6,100,"2014-08-28 23:06:09.80903") &nbsp;| 2014-08-28 23:08:52.887568 | postgres | &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp;12 | 1301672 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | UPDATE | UTF8 &nbsp; &nbsp; | (5,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-2</font></div><div><font size="2"   >8 23:06:09.819092") | (5,1,"te\\\\s\\t",c4,c5,c6,100,"2014-08-28 23:06:09.819092") | 2014-08-28 23:08:52.887568 | postgres | &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >(12 rows)</font></div></div><p></p></pre></div><div><br></div><div>回退到更新前, 即<span style="line-height: 28px;"   >1301672</span><span style="line-height: 28px;"   >&nbsp;这个XID需要回退掉.</span></div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div><div style="line-height: 28px;"   ><font size="2"   >do language plpgsql $$</font></div><div style="line-height: 28px;"   ><font size="2"   >declare</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; v_op text;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; v_encoding_curr text := pg_client_encoding();</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; v_encoding_tmp text;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; v_old text;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; v_new text;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; v_xid int8 := 1301672;&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >begin</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; for v_op, v_encoding_tmp, v_old, v_new in&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; select op,encoding,old_rec::text,new_rec::text from undo_t where xid&gt;=v_xid order by xid desc,id desc</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; LOOP</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; execute 'set client_encoding='''||v_encoding_tmp||'''';&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; case v_op&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; when 'INSERT' then&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; delete from public."TBL" t where t=v_new::public."TBL";&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; when 'DELETE' then</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; insert into public."TBL" values ((v_old::public."TBL").*);&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; when 'TRUNCATE' then</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; insert into public."TBL" values ((v_old::public."TBL").*);&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; when 'UPDATE' then</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; delete from public."TBL" t where t=v_new::public."TBL";&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; insert into public."TBL" values ((v_old::public."TBL").*);&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; else</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; end case;&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; end loop;&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; execute 'set client_encoding='''||v_encoding_curr||'''';&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >end;&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >$$;</font></div></div><div style="line-height: 28px;"   ><font size="2"   ><br></font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >postgres=# select * from "TBL";</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;c1 | c2 | &nbsp; C3 &nbsp; &nbsp;| c4 | c5 | c6 | c7 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >----+----+---------+----+----+----+----+----------------------------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; 5 | &nbsp;1 | te\\s\t | c4 | c5 | c6 | &nbsp;1 | 2014-08-28 23:06:09.819092</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; 4 | &nbsp;1 | te\\s\t | c4 | c5 | c6 | &nbsp;1 | 2014-08-28 23:06:09.80903</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; 3 | &nbsp;1 | te\\s\t | c4 | c5 | c6 | &nbsp;1 | 2014-08-28 23:06:09.80206</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; 2 | &nbsp;1 | te\\s\t | c4 | c5 | c6 | &nbsp;1 | 2014-08-28 23:06:09.79597</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; 1 | &nbsp;1 | te\\s\t | c4 | c5 | c6 | &nbsp;1 | 2014-08-28 23:06:09.790227</font></div><div style="line-height: 28px;"   ><font size="2"   >(5 rows)</font></div></div><p></p></pre></div></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >现在把所有记录删除掉</div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >postgres=# delete from "TBL";</font></div><div style="line-height: 28px;"   ><font size="2"   >DELETE 5</font></div><div style="line-height: 28px;"   ><font size="2"   >postgres=# select * from undo_t;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;id | &nbsp; xid &nbsp; | &nbsp;relid &nbsp; | table_schema | table_name | when_tg | level | &nbsp; op &nbsp; | encoding | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; old_rec &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; new_rec &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| username | clien</font></div><div style="line-height: 28px;"   ><font size="2"   >t_addr | client_port&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >----+---------+----------+--------------+------------+---------+-------+--------+----------+----------------------------------------</font></div><div style="line-height: 28px;"   ><font size="2"   >----------------------+--------------------------------------------------------------+----------------------------+----------+------</font></div><div style="line-height: 28px;"   ><font size="2"   >-------+-------------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; 1 | 1301665 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | INSERT | UTF8 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | (1,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-28 23:06:09.790227") &nbsp; | 2014-08-28 23:06:09.790227 | postgres | &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; 2 | 1301666 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | INSERT | UTF8 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | (2,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-28 23:06:09.79597") &nbsp; &nbsp;| 2014-08-28 23:06:09.79597 &nbsp;| postgres | &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; 3 | 1301667 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | INSERT | UTF8 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | (3,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-28 23:06:09.80206") &nbsp; &nbsp;| 2014-08-28 23:06:09.80206 &nbsp;| postgres | &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; 4 | 1301668 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | INSERT | UTF8 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | (4,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-28 23:06:09.80903") &nbsp; &nbsp;| 2014-08-28 23:06:09.80903 &nbsp;| postgres | &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; 5 | 1301669 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | INSERT | UTF8 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | (5,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-28 23:06:09.819092") &nbsp; | 2014-08-28 23:06:09.819092 | postgres | &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; 6 | 1301670 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | INSERT | UTF8 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | (6,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-28 23:06:10.228624") &nbsp; | 2014-08-28 23:06:10.228624 | postgres | &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; 7 | 1301671 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | DELETE | UTF8 &nbsp; &nbsp; | (6,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-2</font></div><div style="line-height: 28px;"   ><font size="2"   >8 23:06:10.228624") &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2014-08-28 23:07:07.750644 | postgres | &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; 8 | 1301672 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | UPDATE | UTF8 &nbsp; &nbsp; | (1,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-2</font></div><div style="line-height: 28px;"   ><font size="2"   >8 23:06:09.790227") &nbsp; | (1,1,"te\\\\s\\t",c4,c5,c6,100,"2014-08-28 23:06:09.790227") | 2014-08-28 23:08:52.887568 | postgres | &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; 9 | 1301672 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | UPDATE | UTF8 &nbsp; &nbsp; | (2,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-2</font></div><div style="line-height: 28px;"   ><font size="2"   >8 23:06:09.79597") &nbsp; &nbsp;| (2,1,"te\\\\s\\t",c4,c5,c6,100,"2014-08-28 23:06:09.79597") &nbsp;| 2014-08-28 23:08:52.887568 | postgres | &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;10 | 1301672 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | UPDATE | UTF8 &nbsp; &nbsp; | (3,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-2</font></div><div style="line-height: 28px;"   ><font size="2"   >8 23:06:09.80206") &nbsp; &nbsp;| (3,1,"te\\\\s\\t",c4,c5,c6,100,"2014-08-28 23:06:09.80206") &nbsp;| 2014-08-28 23:08:52.887568 | postgres | &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;11 | 1301672 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | UPDATE | UTF8 &nbsp; &nbsp; | (4,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-2</font></div><div style="line-height: 28px;"   ><font size="2"   >8 23:06:09.80903") &nbsp; &nbsp;| (4,1,"te\\\\s\\t",c4,c5,c6,100,"2014-08-28 23:06:09.80903") &nbsp;| 2014-08-28 23:08:52.887568 | postgres | &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;12 | 1301672 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | UPDATE | UTF8 &nbsp; &nbsp; | (5,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-2</font></div><div style="line-height: 28px;"   ><font size="2"   >8 23:06:09.819092") &nbsp; | (5,1,"te\\\\s\\t",c4,c5,c6,100,"2014-08-28 23:06:09.819092") | 2014-08-28 23:08:52.887568 | postgres | &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;13 | 1301673 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | DELETE | UTF8 &nbsp; &nbsp; | (5,1,"te\\\\s\\t",c4,c5,c6,100,"2014-08</font></div><div style="line-height: 28px;"   ><font size="2"   >-28 23:06:09.819092") | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2014-08-28 23:09:50.590689 | postgres | &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;14 | 1301673 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | INSERT | UTF8 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | (5,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-28 23:06:09.819092") &nbsp; | 2014-08-28 23:09:50.590689 | postgres | &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;15 | 1301673 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | DELETE | UTF8 &nbsp; &nbsp; | (4,1,"te\\\\s\\t",c4,c5,c6,100,"2014-08</font></div><div style="line-height: 28px;"   ><font size="2"   >-28 23:06:09.80903") &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2014-08-28 23:09:50.590689 | postgres | &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;16 | 1301673 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | INSERT | UTF8 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | (4,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-28 23:06:09.80903") &nbsp; &nbsp;| 2014-08-28 23:09:50.590689 | postgres | &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;17 | 1301673 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | DELETE | UTF8 &nbsp; &nbsp; | (3,1,"te\\\\s\\t",c4,c5,c6,100,"2014-08</font></div><div style="line-height: 28px;"   ><font size="2"   >-28 23:06:09.80206") &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2014-08-28 23:09:50.590689 | postgres | &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;18 | 1301673 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | INSERT | UTF8 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | (3,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-28 23:06:09.80206") &nbsp; &nbsp;| 2014-08-28 23:09:50.590689 | postgres | &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;19 | 1301673 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | DELETE | UTF8 &nbsp; &nbsp; | (2,1,"te\\\\s\\t",c4,c5,c6,100,"2014-08</font></div><div style="line-height: 28px;"   ><font size="2"   >-28 23:06:09.79597") &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2014-08-28 23:09:50.590689 | postgres | &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;20 | 1301673 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | INSERT | UTF8 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | (2,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-28 23:06:09.79597") &nbsp; &nbsp;| 2014-08-28 23:09:50.590689 | postgres | &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;21 | 1301673 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | DELETE | UTF8 &nbsp; &nbsp; | (1,1,"te\\\\s\\t",c4,c5,c6,100,"2014-08</font></div><div style="line-height: 28px;"   ><font size="2"   >-28 23:06:09.790227") | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2014-08-28 23:09:50.590689 | postgres | &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;22 | 1301673 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | INSERT | UTF8 &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | (1,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-28 23:06:09.790227") &nbsp; | 2014-08-28 23:09:50.590689 | postgres | &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;23 | 1301674 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | DELETE | UTF8 &nbsp; &nbsp; | (5,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-2</font></div><div style="line-height: 28px;"   ><font size="2"   >8 23:06:09.819092") &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2014-08-28 23:10:17.32766 &nbsp;| postgres | &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;24 | 1301674 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | DELETE | UTF8 &nbsp; &nbsp; | (4,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-2</font></div><div style="line-height: 28px;"   ><font size="2"   >8 23:06:09.80903") &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2014-08-28 23:10:17.32766 &nbsp;| postgres | &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;25 | 1301674 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | DELETE | UTF8 &nbsp; &nbsp; | (3,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-2</font></div><div style="line-height: 28px;"   ><font size="2"   >8 23:06:09.80206") &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2014-08-28 23:10:17.32766 &nbsp;| postgres | &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;26 | 1301674 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | DELETE | UTF8 &nbsp; &nbsp; | (2,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-2</font></div><div style="line-height: 28px;"   ><font size="2"   >8 23:06:09.79597") &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2014-08-28 23:10:17.32766 &nbsp;| postgres | &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;27 | 1301674 | 50534894 | public &nbsp; &nbsp; &nbsp; | TBL &nbsp; &nbsp; &nbsp; &nbsp;| AFTER &nbsp; | ROW &nbsp; | DELETE | UTF8 &nbsp; &nbsp; | (1,1,"te\\\\s\\t",c4,c5,c6,1,"2014-08-2</font></div><div style="line-height: 28px;"   ><font size="2"   >8 23:06:09.790227") &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2014-08-28 23:10:17.32766 &nbsp;| postgres | &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >(27 rows)</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >回退到删除前, 即1301674回退掉.</div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >do language plpgsql $$</font></div><div style="line-height: 28px;"   ><font size="2"   >declare</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; v_op text;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; v_encoding_curr text := pg_client_encoding();</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; v_encoding_tmp text;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; v_old text;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; v_new text;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; v_xid int8 := 1301674;&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >begin</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; for v_op, v_encoding_tmp, v_old, v_new in&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; select op,encoding,old_rec::text,new_rec::text from undo_t where xid&gt;=v_xid order by xid desc,id desc</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; LOOP</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; execute 'set client_encoding='''||v_encoding_tmp||'''';&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; case v_op&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; when 'INSERT' then&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; delete from public."TBL" t where t=v_new::public."TBL";&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; when 'DELETE' then</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; insert into public."TBL" values ((v_old::public."TBL").*);&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; when 'TRUNCATE' then</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; insert into public."TBL" values ((v_old::public."TBL").*);&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; when 'UPDATE' then</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; delete from public."TBL" t where t=v_new::public."TBL";&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; insert into public."TBL" values ((v_old::public."TBL").*);&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; else</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; end case;&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; end loop;&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; execute 'set client_encoding='''||v_encoding_curr||'''';&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >end;&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >$$;</font></div></div><div style="line-height: 28px;"   ><font size="2"   ><br></font></div></div></div><div><div><font size="2"   >postgres=# select * from "TBL";</font></div><div><font size="2"   >&nbsp;c1 | c2 | &nbsp; C3 &nbsp; &nbsp;| c4 | c5 | c6 | c7 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+----+---------+----+----+----+----+----------------------------</font></div><div><font size="2"   >&nbsp; 1 | &nbsp;1 | te\\s\t | c4 | c5 | c6 | &nbsp;1 | 2014-08-28 23:06:09.790227</font></div><div><font size="2"   >&nbsp; 2 | &nbsp;1 | te\\s\t | c4 | c5 | c6 | &nbsp;1 | 2014-08-28 23:06:09.79597</font></div><div><font size="2"   >&nbsp; 3 | &nbsp;1 | te\\s\t | c4 | c5 | c6 | &nbsp;1 | 2014-08-28 23:06:09.80206</font></div><div><font size="2"   >&nbsp; 4 | &nbsp;1 | te\\s\t | c4 | c5 | c6 | &nbsp;1 | 2014-08-28 23:06:09.80903</font></div><div><font size="2"   >&nbsp; 5 | &nbsp;1 | te\\s\t | c4 | c5 | c6 | &nbsp;1 | 2014-08-28 23:06:09.819092</font></div><div><font size="2"   >(5 rows)</font></div></div><p></p></pre></div></div></div></div><div><br></div><div>现在回退到只有一条记录的时候. 即<span style="line-height: 28px;"   >1301666</span><span style="line-height: 28px;"   >&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# &nbsp;do language plpgsql $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; v_op text;</font></div><div><font size="2"   >&nbsp; v_encoding_curr text := pg_client_encoding();</font></div><div><font size="2"   >&nbsp; v_encoding_tmp text;</font></div><div><font size="2"   >&nbsp; v_old text;</font></div><div><font size="2"   >&nbsp; v_new text;</font></div><div><font size="2"   >&nbsp; v_xid int8 := 1301666;&nbsp;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; for v_op, v_encoding_tmp, v_old, v_new in&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; select op,encoding,old_rec::text,new_rec::text from undo_t where xid&gt;=v_xid order by xid desc,id desc</font></div><div><font size="2"   >&nbsp; LOOP</font></div><div><font size="2"   >&nbsp; &nbsp; execute 'set client_encoding='''||v_encoding_tmp||'''';&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; case v_op&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; when 'INSERT' then&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; delete from public."TBL" t where t=v_new::public."TBL";&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; when 'DELETE' then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; insert into public."TBL" values ((v_old::public."TBL").*);&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; when 'TRUNCATE' then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; insert into public."TBL" values ((v_old::public."TBL").*);&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; when 'UPDATE' then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; delete from public."TBL" t where t=v_new::public."TBL";&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; insert into public."TBL" values ((v_old::public."TBL").*);&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; end case;&nbsp;</font></div><div><font size="2"   >&nbsp; end loop;&nbsp;</font></div><div><font size="2"   >&nbsp; execute 'set client_encoding='''||v_encoding_curr||'''';&nbsp;</font></div><div><font size="2"   >end;&nbsp;</font></div><div><font size="2"   >$$;</font></div><div><font size="2"   >DO</font></div><div><font size="2"   >postgres=# select * from "TBL";</font></div><div><font size="2"   >&nbsp;c1 | c2 | &nbsp; C3 &nbsp; &nbsp;| c4 | c5 | c6 | c7 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+----+---------+----+----+----+----+----------------------------</font></div><div><font size="2"   >&nbsp; 1 | &nbsp;1 | te\\s\t | c4 | c5 | c6 | &nbsp;1 | 2014-08-28 23:06:09.790227</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>接下来测试一下添加字段后的回退.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# alter table "TBL" add column c8 text;</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >postgres=# insert into "TBL" values (2,1,'test','c4','c5','c6',1,now(),'c8');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><div><font size="2"   >postgres=# insert into "TBL" values (3,1,'test','c4','c5','c6',1,now(),'c8');</font></div><div><font size="2"   >INSERT 0 1</font></div></div><div><font size="2"   >postgres=# select * from "TBL";</font></div><div><font size="2"   >&nbsp;c1 | c2 | &nbsp; C3 &nbsp; &nbsp;| c4 | c5 | c6 | c7 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| c8&nbsp;</font></div><div><font size="2"   >----+----+---------+----+----+----+----+----------------------------+----</font></div><div><font size="2"   >&nbsp; 1 | &nbsp;1 | te\\s\t | c4 | c5 | c6 | &nbsp;1 | 2014-08-28 23:06:09.790227 |&nbsp;</font></div><div><font size="2"   >&nbsp; 2 | &nbsp;1 | test &nbsp; &nbsp;| c4 | c5 | c6 | &nbsp;1 | 2014-08-28 23:14:00.235677 | c8</font></div><div><font size="2"   >&nbsp; 3 | &nbsp;1 | test &nbsp; &nbsp;| c4 | c5 | c6 | &nbsp;1 | 2014-08-28 23:14:35.012675 | c8</font></div><p></p></pre></div><div><br></div><div>回退到添加字段前<span style="line-height: 28px;"   >1301666</span><span style="line-height: 28px;"   >.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# &nbsp;do language plpgsql $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; v_op text;</font></div><div><font size="2"   >&nbsp; v_encoding_curr text := pg_client_encoding();</font></div><div><font size="2"   >&nbsp; v_encoding_tmp text;</font></div><div><font size="2"   >&nbsp; v_old text;</font></div><div><font size="2"   >&nbsp; v_new text;</font></div><div><font size="2"   >&nbsp; v_xid int8 := 1301666;&nbsp;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; for v_op, v_encoding_tmp, v_old, v_new in&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; select op,encoding,old_rec::text,new_rec::text from undo_t where xid&gt;=v_xid order by xid desc,id desc</font></div><div><font size="2"   >&nbsp; LOOP</font></div><div><font size="2"   >&nbsp; &nbsp; execute 'set client_encoding='''||v_encoding_tmp||'''';&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; case v_op&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; when 'INSERT' then&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; delete from public."TBL" t where t=v_new::public."TBL";&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; when 'DELETE' then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; insert into public."TBL" values ((v_old::public."TBL").*);&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; when 'TRUNCATE' then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; insert into public."TBL" values ((v_old::public."TBL").*);&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; when 'UPDATE' then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; delete from public."TBL" t where t=v_new::public."TBL";&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; insert into public."TBL" values ((v_old::public."TBL").*);&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; end case;&nbsp;</font></div><div><font size="2"   >&nbsp; end loop;&nbsp;</font></div><div><font size="2"   >&nbsp; execute 'set client_encoding='''||v_encoding_curr||'''';&nbsp;</font></div><div><font size="2"   >end;&nbsp;</font></div><div><font size="2"   >$$;</font></div><div><font size="2"   >DO</font></div><div><font size="2"   >postgres=# select * from "TBL";</font></div><div><font size="2"   >&nbsp;c1 | c2 | &nbsp; C3 &nbsp; &nbsp;| c4 | c5 | c6 | c7 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| c8&nbsp;</font></div><div><font size="2"   >----+----+---------+----+----+----+----+----------------------------+----</font></div><div><font size="2"   >&nbsp; 1 | &nbsp;1 | te\\s\t | c4 | c5 | c6 | &nbsp;1 | 2014-08-28 23:06:09.790227 |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>接下来删除字段测试</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# alter table "TBL" drop column c5;</font></div><div><font size="2"   >ALTER TABLE</font></div><div><font size="2"   >postgres=# select * from "TBL";</font></div><div><font size="2"   >&nbsp;c1 | c2 | &nbsp; C3 &nbsp; &nbsp;| c4 | c6 | c7 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| c8&nbsp;</font></div><div><font size="2"   >----+----+---------+----+----+----+----------------------------+----</font></div><div><font size="2"   >&nbsp; 1 | &nbsp;1 | te\\s\t | c4 | c6 | &nbsp;1 | 2014-08-28 23:06:09.790227 |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres=# insert into "TBL" values (3,1,'test','c4','c6',1,now(),'c8');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >postgres=# select * from "TBL";</font></div><div><font size="2"   >&nbsp;c1 | c2 | &nbsp; C3 &nbsp; &nbsp;| c4 | c6 | c7 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| c8&nbsp;</font></div><div><font size="2"   >----+----+---------+----+----+----+----------------------------+----</font></div><div><font size="2"   >&nbsp; 1 | &nbsp;1 | te\\s\t | c4 | c6 | &nbsp;1 | 2014-08-28 23:06:09.790227 |&nbsp;</font></div><div><font size="2"   >&nbsp; 3 | &nbsp;1 | test &nbsp; &nbsp;| c4 | c6 | &nbsp;1 | 2014-08-28 23:17:24.722663 | c8</font></div><div><font size="2"   >(2 rows)</font></div></div><p></p></pre></div><div><br></div><div>回退到<span style="line-height: 28px;"   >1301666</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# &nbsp;do language plpgsql $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >&nbsp; v_op text;</font></div><div><font size="2"   >&nbsp; v_encoding_curr text := pg_client_encoding();</font></div><div><font size="2"   >&nbsp; v_encoding_tmp text;</font></div><div><font size="2"   >&nbsp; v_old text;</font></div><div><font size="2"   >&nbsp; v_new text;</font></div><div><font size="2"   >&nbsp; v_xid int8 := 1301666;&nbsp;</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; for v_op, v_encoding_tmp, v_old, v_new in&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; select op,encoding,old_rec::text,new_rec::text from undo_t where xid&gt;=v_xid order by xid desc,id desc</font></div><div><font size="2"   >&nbsp; LOOP</font></div><div><font size="2"   >&nbsp; &nbsp; execute 'set client_encoding='''||v_encoding_tmp||'''';&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; case v_op&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; when 'INSERT' then&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; delete from public."TBL" t where t=v_new::public."TBL";&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; when 'DELETE' then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; insert into public."TBL" values ((v_old::public."TBL").*);&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; when 'TRUNCATE' then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; insert into public."TBL" values ((v_old::public."TBL").*);&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; when 'UPDATE' then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; delete from public."TBL" t where t=v_new::public."TBL";&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; insert into public."TBL" values ((v_old::public."TBL").*);&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; end case;&nbsp;</font></div><div><font size="2"   >&nbsp; end loop;&nbsp;</font></div><div><font size="2"   >&nbsp; execute 'set client_encoding='''||v_encoding_curr||'''';&nbsp;</font></div><div><font size="2"   >end;&nbsp;</font></div><div><font size="2"   >$$;</font></div><div><font size="2"   >DO</font></div><div><font size="2"   >postgres=# select * from "TBL";</font></div><div><font size="2"   >&nbsp;c1 | c2 | &nbsp; C3 &nbsp; &nbsp;| c4 | c6 | c7 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| c8&nbsp;</font></div><div><font size="2"   >----+----+---------+----+----+----+----------------------------+----</font></div><div><font size="2"   >&nbsp; 1 | &nbsp;1 | te\\s\t | c4 | c6 | &nbsp;1 | 2014-08-28 23:06:09.790227 |&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>测试完全没有问题, 数据类型正常的转换, 字段和值的顺序匹配没有出现错乱.</div><div><br></div><div>[其他]</div><div>1. 使用标记为来标记delete在程序设计中用得比较多, 主要是防止程序的使用者误点删除操作, 可以把标记位改回来.</div><div>但是这种方法仅仅适用于不是直接执行SQL来删除的场景, 如果是直接使用delete from table 来删除的话, 有没有标记位都于事无补, 因为DELETE掉了.</div><div><br></div><div>[注意]</div><div>1. 如果事务中包含多个表的变更, 为了达到一致性的闪回, 那么多个表都要记录他们的UNDO, 所以需要在多个表上创建对应的触发器.</div><div>2. 我们记录的是事务号分配的顺序, 而不是提交顺序, 所以闪回到一个事务号时, 并不是闪回到这个事务提交的点, 而是这个事务分配的点上, 这与通过XLOG来还原是不一样的, 必须注意. 如果要达到提交点, 可以在跟踪表添加一列存储txid_current_snapshot(), 在恢复时跳过当时未提交的事务即可.</div><div>3. 还需要注意编码和逃逸的问题.&nbsp;</div><div>插入数据时的client_encoding和闪回数据时的client_encoding如果不一致可能会有问题. 所以我们在闪回时, 每次都指定跟踪时记录到的当时的client_encoding. 闪回操作结束后改回来.</div><div>触发器记录的是逃逸前的字符串, 在闪回时需要注意逃逸. &nbsp;可以使用quote_nullable来解决, 使用record时不会有问题.</div><div>4. 注意表名, 列名的大小写问题, 使用quote_ident 来解决.</div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020128772037884/"   >http://blog.163.com/digoal@126/blog/static/16387704020128772037884/</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201252575529358/"   >http://blog.163.com/digoal@126/blog/static/163877040201252575529358/</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.4/static/hstore.html"   >http://www.postgresql.org/docs/9.4/static/hstore.html</a></div><div>4.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201321125220134/"   >http://blog.163.com/digoal@126/blog/static/163877040201321125220134/</a></div><div>5.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012731944439/"   >http://blog.163.com/digoal@126/blog/static/1638770402012731944439/</a></div><div>6.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012731203716/"   >http://blog.163.com/digoal@126/blog/static/1638770402012731203716/</a></div><div>7.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013283547959/"   >http://blog.163.com/digoal@126/blog/static/1638770402013283547959/</a></div><div>8.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013211102130526/"   >http://blog.163.com/digoal@126/blog/static/1638770402013211102130526/</a></div><div>9. src/pl/plpgsql/src/pl_gram.y</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case T_DATUM:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; check_assignable(yylval.wdatum.datum, yylloc);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (yylval.wdatum.datum-&gt;dtype == PLPGSQL_DTYPE_ROW ||</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; yylval.wdatum.datum-&gt;dtype == PLPGSQL_DTYPE_REC)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode(ERRCODE_SYNTAX_ERROR),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("\"%s\" is not a scalar variable",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NameOfDatum(&amp;(yylval.wdatum))),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;parser_errposition(yylloc)));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fieldnames[nfields] = NameOfDatum(&amp;(yylval.wdatum));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; varnos[nfields++] &nbsp; &nbsp; &nbsp; = yylval.wdatum.datum-&gt;dno;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><p></p></pre></div><div><a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402013211102130526/"   ><br></a><span style="line-height: 28px;"   >
</span><a style="line-height: 28px;" rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL flash back query emulate by trigger - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div></div>
	</div>
</div>
</body>
</html>