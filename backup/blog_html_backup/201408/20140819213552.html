<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">keepalived track script | interface weight & instance priority & election</h2>
	<h5 id="">2014-08-19 21:35:52&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201471992259474/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>keepalived 使用vrrp来选举instance的master, 选举方法是以优先级最高的作为master. 一个keepalived可以配置多个instance, 一个节点上可能某些instance是master, 某些instance是fault或者backup的.&nbsp;</div><div>配置instance的优先级范围是0-255.</div><div>这里需要注意, instance里可以配置track interface和track script, 对应的track可以配置weight, 当weight&gt;0时, 表示这个跟踪返回正常的话, 优先级加weight. 如果配置的weight&lt;0, 表示跟踪返回失败的话, 优先级要减去这个weight.</div><div>配置track的weight有点类似动态调整instance的优先级. 从而导致角色转换, 例如master在多次track weight&lt;0的interface或script后, 可能优先级下降到比其他节点更低, 那么会重新选举master角色.</div><div>不过需要注意, 有一种情况, 如果配置的instance的初始优先级是255的话, 则不受track weight的影响. 见<span style="line-height: 28px;"   >vrrp_update_priority函数的内容.</span></div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div><div style="line-height: 28px;"   ><font size="2"   ><span style="line-height: 28px;"   >	</span>if (vrrp-&gt;base_priority == VRRP_PRIO_OWNER) {</font></div><div style="line-height: 28px;"   ><font size="2"   ><span style="line-height: 28px;"   >		</span>/* we will not run a PRIO_OWNER into a non-PRIO_OWNER */</font></div><div style="line-height: 28px;"   ><font size="2"   ><span style="line-height: 28px;"   >		</span>vrrp-&gt;effective_priority = VRRP_PRIO_OWNER;</font></div></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >	} else {</font></div><div style="line-height: 28px;"   ><font size="2"   >		/* WARNING! we must compute new_prio on a signed int in order</font></div><div style="line-height: 28px;"   ><font size="2"   >		 &nbsp; to detect overflows and avoid wrapping. */</font></div><div style="line-height: 28px;"   ><font size="2"   >		new_prio = vrrp-&gt;base_priority + prio_offset;</font></div><div style="line-height: 28px;"   ><font size="2"   >		if (new_prio &lt; 1)</font></div><div style="line-height: 28px;"   ><font size="2"   >			new_prio = 1;</font></div><div style="line-height: 28px;"   ><font size="2"   >		else if (new_prio &gt; 254)</font></div><div style="line-height: 28px;"   ><font size="2"   >			new_prio = 254;</font></div><div style="line-height: 28px;"   ><font size="2"   >		vrrp-&gt;effective_priority = new_prio;</font></div><div style="line-height: 28px;"   ><font size="2"   >	}</font></div></div><p></p></pre></div></div><div style="line-height: 28px;"   ><br></div><div>keepalived / include / vrrp.h</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#define VRRP_PRIO_OWNER		255		/* priority of the ip owner -- rfc2338.5.3.4 */</font></div><div></div><p></p></pre></div><div>换句话说, 只有初始优先级配置&lt;255的instance, 才可以动态调整优先级. 并且动态调整后的优先级范围是1到254.</div><div>&nbsp; &nbsp; priority &lt;INTEGER-0..255&gt;<span style="white-space: pre;"   >		</span># VRRP PRIO</div><div><br></div><div style="line-height: 28px;"   >详细的配置参考</div><div><a target="_blank" rel="nofollow" href="https://raw.githubusercontent.com/acassen/keepalived/master/doc/keepalived.conf.SYNOPSIS"   >https://raw.githubusercontent.com/acassen/keepalived/master/doc/keepalived.conf.SYNOPSIS</a></div><div><br></div><div>[参考]</div><div>1. keepalived/vrrp/vrrp_scheduler.c</div><div><pre class="prettyprint"   ><div><font size="2"   >/* Update VRRP effective priority based on multiple checkers.</font></div><div><font size="2"   >&nbsp;* This is a thread which is executed every adver_int.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >static int</font></div><div><font size="2"   >vrrp_update_priority(thread_t * thread)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >	vrrp_t *vrrp = THREAD_ARG(thread);</font></div><div><font size="2"   >	int prio_offset, new_prio;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >	/* compute prio_offset right here */</font></div><div><font size="2"   >	prio_offset = 0;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >	/* Now we will sum the weights of all interfaces which are tracked. */</font></div><div><font size="2"   >	if ((!vrrp-&gt;sync || vrrp-&gt;sync-&gt;global_tracking) &amp;&amp; !LIST_ISEMPTY(vrrp-&gt;track_ifp))</font></div><div><font size="2"   >		 prio_offset += vrrp_tracked_weight(vrrp-&gt;track_ifp);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >	/* Now we will sum the weights of all scripts which are tracked. */</font></div><div><font size="2"   >	if ((!vrrp-&gt;sync || vrrp-&gt;sync-&gt;global_tracking) &amp;&amp; !LIST_ISEMPTY(vrrp-&gt;track_script))</font></div><div><font size="2"   >		prio_offset += vrrp_script_weight(vrrp-&gt;track_script);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >	if (vrrp-&gt;base_priority == VRRP_PRIO_OWNER) {</font></div><div><font size="2"   >		/* we will not run a PRIO_OWNER into a non-PRIO_OWNER */</font></div><div><font size="2"   >		vrrp-&gt;effective_priority = VRRP_PRIO_OWNER;</font></div><div><font size="2"   >	} else {</font></div><div><font size="2"   >		/* WARNING! we must compute new_prio on a signed int in order</font></div><div><font size="2"   >		 &nbsp; to detect overflows and avoid wrapping. */</font></div><div><font size="2"   >		new_prio = vrrp-&gt;base_priority + prio_offset;</font></div><div><font size="2"   >		if (new_prio &lt; 1)</font></div><div><font size="2"   >			new_prio = 1;</font></div><div><font size="2"   >		else if (new_prio &gt; 254)</font></div><div><font size="2"   >			new_prio = 254;</font></div><div><font size="2"   >		vrrp-&gt;effective_priority = new_prio;</font></div><div><font size="2"   >	}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >	/* Register next priority update thread */</font></div><div><font size="2"   >	thread_add_timer(master, vrrp_update_priority, vrrp, vrrp-&gt;adver_int);</font></div><div><font size="2"   >	return 0;</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div><br></div><div>2. keepalived/vrrp/vrrp_track.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/* Returns total weights of all tracked interfaces :</font></div><div><font size="2"   >&nbsp;* - a positive interface weight adds to the global weight when the</font></div><div><font size="2"   >&nbsp;* &nbsp; interface is UP.</font></div><div><font size="2"   >&nbsp;* - a negative interface weight subtracts from the global weight when the</font></div><div><font size="2"   >&nbsp;* &nbsp; interface is DOWN.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >int</font></div><div><font size="2"   >vrrp_tracked_weight(list l)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >	element e;</font></div><div><font size="2"   >	tracked_if_t *tip;</font></div><div><font size="2"   >	int weight = 0;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >	for (e = LIST_HEAD(l); e; ELEMENT_NEXT(e)) {    // 接口的weight在<span style="line-height: 21px;"   >track_interface中配置.</span></font></div><div><font size="2"   >		tip = ELEMENT_DATA(e);</font></div><div><font size="2"   >		if (IF_ISUP(tip-&gt;ifp)) {</font></div><div><font size="2"   >			if (tip-&gt;weight &gt; 0)</font></div><div><font size="2"   >				weight += tip-&gt;weight;   // 当接口配置的weight大于0并且端口是UP时, 全局weight往上累加接口的weight.</font></div><div><font size="2"   >		} else {</font></div><div><font size="2"   >			if (tip-&gt;weight &lt; 0)</font></div><div><font size="2"   >				weight += tip-&gt;weight;    //  当接口配置的weight小于0并且端口是DOWN时, 全局的weight累计减去接口的weight.</font></div><div><font size="2"   >		}</font></div><div><font size="2"   >	}</font></div><div><font size="2"   >// 换句话说, 当接口配置的weight大于0, 但是端口为DOWN 时, 全局weight不会加也不会减.</font></div><div><font size="2"   >// 或者, 当接口配置的weight小于0, 端口为UP是, 全局weight同样不增不减.</font></div><div><font size="2"   >	return weight;</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >/* Test if all tracked scripts are either OK or weight-tracked */</font></div><div><font size="2"   >int</font></div><div><font size="2"   >vrrp_script_up(list l)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >	element e;</font></div><div><font size="2"   >	tracked_sc_t *tsc;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >	for (e = LIST_HEAD(l); e; ELEMENT_NEXT(e)) {</font></div><div><font size="2"   >		tsc = ELEMENT_DATA(e);</font></div><div><font size="2"   >		if ((tsc-&gt;scr-&gt;result == VRRP_SCRIPT_STATUS_DISABLED) ||</font></div><div><font size="2"   >		 &nbsp; &nbsp;(tsc-&gt;scr-&gt;result == VRRP_SCRIPT_STATUS_INIT_GOOD))</font></div><div><font size="2"   >			continue;</font></div><div><font size="2"   >		if (!tsc-&gt;weight &amp;&amp; tsc-&gt;scr-&gt;result &lt; tsc-&gt;scr-&gt;rise)</font></div><div><font size="2"   >			return 0;</font></div><div><font size="2"   >	}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >	return 1;</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >/* Returns total weights of all tracked scripts :</font></div><div><font size="2"   >&nbsp;* - a positive weight adds to the global weight when the result is OK</font></div><div><font size="2"   >&nbsp;* - a negative weight subtracts from the global weight when the result is KO</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >int</font></div><div><font size="2"   >vrrp_script_weight(list l)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >	element e;</font></div><div><font size="2"   >	tracked_sc_t *tsc;</font></div><div><font size="2"   >	int weight = 0;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >	for (e = LIST_HEAD(l); e; ELEMENT_NEXT(e)) {</font></div><div><font size="2"   >		tsc = ELEMENT_DATA(e);</font></div><div><font size="2"   >		if (tsc-&gt;scr-&gt;result == VRRP_SCRIPT_STATUS_DISABLED)</font></div><div><font size="2"   >			continue;</font></div><div><font size="2"   >		if (tsc-&gt;scr-&gt;result &gt;= tsc-&gt;scr-&gt;rise) {     // 当脚本的result&gt;=配置的rise时, 如果脚本配置的weight&gt;0 , 那么全局weight累加脚本weight.</font></div><div><font size="2"   >			if (tsc-&gt;weight &gt; 0)</font></div><div><font size="2"   >				weight += tsc-&gt;weight;</font></div><div><font size="2"   >		} else if (tsc-&gt;scr-&gt;result &lt; tsc-&gt;scr-&gt;rise) {  // 当脚本的result&lt;配置的rise时, 如果脚本配置的weight&lt;0, 那么全局weight减去脚本的weight.  脚本的result在vrrp_script_child_thread中跟踪.</font></div><div><font size="2"   >			if (tsc-&gt;weight &lt; 0)</font></div><div><font size="2"   >				weight += tsc-&gt;weight;</font></div><div><font size="2"   >		}</font></div><div><font size="2"   >	}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >	return weight;</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div><br></div><div>3. keepalived/include/vrrp_track.h</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/* VRRP script tracking results.</font></div><div><font size="2"   >&nbsp;* The result is an integer between 0 and rise-1 to indicate a DOWN state,</font></div><div><font size="2"   >&nbsp;* or between rise-1 and rise+fall-1 to indicate an UP state. Upon failure,</font></div><div><font size="2"   >&nbsp;* we decrease result and set it to zero when we pass below rise. Upon</font></div><div><font size="2"   >&nbsp;* success, we increase result and set it to rise+fall-1 when we pass above</font></div><div><font size="2"   >&nbsp;* rise-1.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >#define VRRP_SCRIPT_STATUS_DISABLED &nbsp;-3</font></div><div><font size="2"   >#define VRRP_SCRIPT_STATUS_INIT_GOOD -2</font></div><div><font size="2"   >#define VRRP_SCRIPT_STATUS_INIT &nbsp; &nbsp; &nbsp;-1</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >/* external script we call to track local processes */</font></div><div><font size="2"   >typedef struct _vrrp_script {</font></div><div><font size="2"   >	char			*sname;		/* instance name */</font></div><div><font size="2"   >	char			*script;	/* the command to be called */</font></div><div><font size="2"   >	long			interval;	/* interval between script calls */</font></div><div><font size="2"   >	long			timeout;	/* seconds before script timeout */</font></div><div><font size="2"   >	int			weight;		/* weight associated to this script */</font></div><div><font size="2"   >	int			result;		/* result of last call to this script: 0..R-1 = KO, R..R+F-1 = OK */</font></div><div><font size="2"   >	int			inuse;		/* how many users have weight&gt;0 ? */</font></div><div><font size="2"   >	int			rise;		/* R: how many successes before OK */</font></div><div><font size="2"   >	int			fall;		/* F: how many failures before KO */</font></div><div><font size="2"   >} vrrp_script_t;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >/* Tracked script structure definition */</font></div><div><font size="2"   >typedef struct _tracked_sc {</font></div><div><font size="2"   >	int			weight;		/* tracking weight when non-zero */</font></div><div><font size="2"   >	vrrp_script_t		*scr;		/* script pointer, cannot be NULL */</font></div><div><font size="2"   >} tracked_sc_t;</font></div><p></p></pre></div><div><br></div><div><br></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="2014年08月19日 - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>