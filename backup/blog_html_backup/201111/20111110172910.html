<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">CASE : MSA2312fc MULTIDISKs LEFTOVER at the same time</h2>
	<h5 id="">2011-11-10 17:29:10&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402011101052419952/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">今天一个HP MSA2312FC的存储发送了离奇的事情，多个VD上的多个磁盘状态变成了LEFTOVER。<div>造成的结果是多个VD变成QTOF状态如下 :&nbsp;</div><div><div># show vd</div><div>Name Size &nbsp; &nbsp; Free &nbsp; &nbsp;Own Pref &nbsp; RAID &nbsp; Disks Spr Chk &nbsp;Status Jobs &nbsp; &nbsp; &nbsp;</div><div>&nbsp; Serial Number &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div><div>------------------------------------------------------------------------</div><div>vd01 3996.7GB 751.5MB A &nbsp; A &nbsp; &nbsp; &nbsp;RAID5 &nbsp;5 &nbsp; &nbsp; 0 &nbsp; 64k &nbsp;QTOF &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp; 00c0ff10386b0000b519384c00000000&nbsp;</div><div>vd02 3996.7GB 751.5MB B &nbsp; B &nbsp; &nbsp; &nbsp;RAID5 &nbsp;5 &nbsp; &nbsp; 0 &nbsp; 64k &nbsp;FTOL &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp; 00c0ff1035b10000dd19384c00000000&nbsp;</div><div>vd03 3996.7GB 751.5MB A &nbsp; A &nbsp; &nbsp; &nbsp;RAID5 &nbsp;5 &nbsp; &nbsp; 0 &nbsp; 64k &nbsp;FTOL &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp; 00c0ff10386b0000f919384c00000000&nbsp;</div><div>vd04 3996.7GB 751.5MB B &nbsp; B &nbsp; &nbsp; &nbsp;RAID5 &nbsp;5 &nbsp; &nbsp; 0 &nbsp; 64k &nbsp;FTOL &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp; 00c0ff1035b100002d1a384c00000000&nbsp;</div><div>vd05 3996.7GB 751.5MB A &nbsp; A &nbsp; &nbsp; &nbsp;RAID5 &nbsp;5 &nbsp; &nbsp; 0 &nbsp; 64k &nbsp;QTOF &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp; 00c0ff10386b0000c19f554e00000000&nbsp;</div><div>vd06 3996.7GB 751.5MB B &nbsp; B &nbsp; &nbsp; &nbsp;RAID5 &nbsp;5 &nbsp; &nbsp; 0 &nbsp; 64k &nbsp;FTOL &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp; 00c0ff1035b10000ce9f554e00000000&nbsp;</div><div>vd07 3996.7GB 751.5MB A &nbsp; A &nbsp; &nbsp; &nbsp;RAID5 &nbsp;5 &nbsp; &nbsp; 0 &nbsp; 64k &nbsp;QTOF &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp; 00c0ff10386b0000da9f554e00000000&nbsp;</div><div>vd08 3996.7GB 751.5MB B &nbsp; B &nbsp; &nbsp; &nbsp;RAID5 &nbsp;5 &nbsp; &nbsp; 0 &nbsp; 64k &nbsp;FTOL &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp; 00c0ff1035b10000fc9f554e00000000&nbsp;</div><div>------------------------------------------------------------------------</div><div><br></div><div>在执行rescan之后，多个磁盘被找回，VD恢复FTOL。但是vd01上面还是有4块盘是leftover的状态。</div><div>根据HP工程师的指导，关闭所有的登录MSA2312FC的WEB页面。然后通过命令行连接到这台msa2312fc。</div><div>执行</div><div># trust enable</div><div># trust vdisk vd01</div><div>报错</div><div>Error: Command failed. (vd01) - Vdisk is not online or fault tolerant. Cannot be trusted.</div><br><wbr></div><div>这下搞得比较崩溃了，HP对CASE做了升级。</div><div>新的解决方案出来了。先去WEB页面解除VD01的隔离。如下。</div><div><div><img title="CASE : MSA2312fc MULTIDISKs LEFTOVER at the same time - 德哥@Digoal - The Heart,The World."   alt="CASE : MSA2312fc MULTIDISKs LEFTOVER at the same time - 德哥@Digoal - The Heart,The World."   style="margin:0 10px 0 0;"   src="http://img6.ph.126.net/5-VqffGo64Mt8eHR8WlIQA==/1163054603785502356.jpg"   ></div><div><br></div><div>右键点击vd01,选择Tools -&gt; Dequarantine Vdisk</div><div>按照指示解除vd01的隔离。</div><div>然后去命令行看vd01的状态会变成OFFL</div><div><div># show vd &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>Name Size &nbsp; &nbsp; Free &nbsp; &nbsp;Own Pref &nbsp; RAID &nbsp; Disks Spr Chk &nbsp;Status Jobs &nbsp; &nbsp; &nbsp;</div><div>&nbsp; Serial Number &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div><div>------------------------------------------------------------------------</div><div>vd01 3996.7GB 751.5MB A &nbsp; A &nbsp; &nbsp; &nbsp;RAID5 &nbsp;5 &nbsp; &nbsp; 0 &nbsp; 64k &nbsp;OFFL &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp; 00c0ff10386b0000b519384c00000000&nbsp;</div><div>vd02 3996.7GB 751.5MB B &nbsp; B &nbsp; &nbsp; &nbsp;RAID5 &nbsp;5 &nbsp; &nbsp; 0 &nbsp; 64k &nbsp;FTOL &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp; 00c0ff1035b10000dd19384c00000000&nbsp;</div><div>vd03 3996.7GB 751.5MB A &nbsp; A &nbsp; &nbsp; &nbsp;RAID5 &nbsp;5 &nbsp; &nbsp; 0 &nbsp; 64k &nbsp;FTOL &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp; 00c0ff10386b0000f919384c00000000&nbsp;</div><div>vd04 3996.7GB 751.5MB B &nbsp; B &nbsp; &nbsp; &nbsp;RAID5 &nbsp;5 &nbsp; &nbsp; 0 &nbsp; 64k &nbsp;FTOL &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp; 00c0ff1035b100002d1a384c00000000&nbsp;</div><div>vd05 3996.7GB 751.5MB A &nbsp; A &nbsp; &nbsp; &nbsp;RAID5 &nbsp;5 &nbsp; &nbsp; 0 &nbsp; 64k &nbsp;FTOL &nbsp; VRSC 56% &nbsp;</div><div>&nbsp; 00c0ff10386b0000c19f554e00000000&nbsp;</div><div>vd06 3996.7GB 751.5MB B &nbsp; B &nbsp; &nbsp; &nbsp;RAID5 &nbsp;5 &nbsp; &nbsp; 0 &nbsp; 64k &nbsp;FTOL &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp; 00c0ff1035b10000ce9f554e00000000&nbsp;</div><div>vd07 3996.7GB 751.5MB A &nbsp; A &nbsp; &nbsp; &nbsp;RAID5 &nbsp;5 &nbsp; &nbsp; 0 &nbsp; 64k &nbsp;FTOL &nbsp; VRSC 59% &nbsp;</div><div>&nbsp; 00c0ff10386b0000da9f554e00000000&nbsp;</div><div>vd08 3996.7GB 751.5MB B &nbsp; B &nbsp; &nbsp; &nbsp;RAID5 &nbsp;5 &nbsp; &nbsp; 0 &nbsp; 64k &nbsp;FTOL &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp; 00c0ff1035b10000fc9f554e00000000&nbsp;</div><div>------------------------------------------------------------------------</div></div><div><br></div><div>然后再到命令行执行</div><div># trust vdisk vd01</div><div>VD恢复为FTOL状态。</div><div><div># show vd &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>Name Size &nbsp; &nbsp; Free &nbsp; &nbsp;Own Pref &nbsp; RAID &nbsp; Disks Spr Chk &nbsp;Status Jobs &nbsp; &nbsp; &nbsp;</div><div>&nbsp; Serial Number &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</div><div>------------------------------------------------------------------------</div><div>vd01 3996.7GB 751.5MB A &nbsp; A &nbsp; &nbsp; &nbsp;RAID5 &nbsp;5 &nbsp; &nbsp; 0 &nbsp; 64k &nbsp;FTOL &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp; 00c0ff10386b0000b519384c00000000&nbsp;</div><div>vd02 3996.7GB 751.5MB B &nbsp; B &nbsp; &nbsp; &nbsp;RAID5 &nbsp;5 &nbsp; &nbsp; 0 &nbsp; 64k &nbsp;FTOL &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp; 00c0ff1035b10000dd19384c00000000&nbsp;</div><div>vd03 3996.7GB 751.5MB A &nbsp; A &nbsp; &nbsp; &nbsp;RAID5 &nbsp;5 &nbsp; &nbsp; 0 &nbsp; 64k &nbsp;FTOL &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp; 00c0ff10386b0000f919384c00000000&nbsp;</div><div>vd04 3996.7GB 751.5MB B &nbsp; B &nbsp; &nbsp; &nbsp;RAID5 &nbsp;5 &nbsp; &nbsp; 0 &nbsp; 64k &nbsp;FTOL &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp; 00c0ff1035b100002d1a384c00000000&nbsp;</div><div>vd05 3996.7GB 751.5MB A &nbsp; A &nbsp; &nbsp; &nbsp;RAID5 &nbsp;5 &nbsp; &nbsp; 0 &nbsp; 64k &nbsp;FTOL &nbsp; VRSC 56% &nbsp;</div><div>&nbsp; 00c0ff10386b0000c19f554e00000000&nbsp;</div><div>vd06 3996.7GB 751.5MB B &nbsp; B &nbsp; &nbsp; &nbsp;RAID5 &nbsp;5 &nbsp; &nbsp; 0 &nbsp; 64k &nbsp;FTOL &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp; 00c0ff1035b10000ce9f554e00000000&nbsp;</div><div>vd07 3996.7GB 751.5MB A &nbsp; A &nbsp; &nbsp; &nbsp;RAID5 &nbsp;5 &nbsp; &nbsp; 0 &nbsp; 64k &nbsp;FTOL &nbsp; VRSC 59% &nbsp;</div><div>&nbsp; 00c0ff10386b0000da9f554e00000000&nbsp;</div><div>vd08 3996.7GB 751.5MB B &nbsp; B &nbsp; &nbsp; &nbsp;RAID5 &nbsp;5 &nbsp; &nbsp; 0 &nbsp; 64k &nbsp;FTOL &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>&nbsp; 00c0ff1035b10000fc9f554e00000000&nbsp;</div><div>------------------------------------------------------------------------</div></div>&nbsp;</div><div>据HP称，这样操作可能导致部分数据丢失，可能指CACHE的脏数据, 或者是leftover掉的磁盘上的坏数据。</div><div>另外HP建议观察几天，没有问题的话升级一下固件。</div><div>另外如果正常情况下的leftover, 例如硬盘的错误次数达到一定的阈值, 这种情况下建议备份数据,重建vdisk, 再恢复.</div><br><div>卷的WR Policy可能会被修改为write-through, 后续可能需要手工开启.</div><br><div>trust命令 :&nbsp;</div><div><div># trust&nbsp;</div><div>DESCRIPTION</div><div>Enables an offline vdisk to be brought online for emergency data collection.</div><div>This command must be enabled before each use.</div><div><br></div><div>Caution: This command can cause unstable operation and data loss if used</div><div>improperly. It is intended for disaster recovery only.</div><div><br></div><div>The trust command resynchronizes the time and date stamp and any other metadata</div><div>on a bad disk disk. This makes the disk an active member of the vdisk again.</div><div>You might need to do this when:</div><div>- One or more disks in a vdisk start up more slowly or were powered on after</div><div>&nbsp; the rest of the disks in the vdisk. This causes the date and time stamps to</div><div>&nbsp; differ, which the system interprets as a problem with the "late" disks.</div><div>&nbsp; In this case, the vdisk functions normally after being trusted.</div><div>- A vdisk is offline because a disk is failing, you have no data backup, and</div><div>&nbsp; you want to try to recover the data from the vdisk. In this case, trust may</div><div>&nbsp; work, but only as long as the failing disk continues to operate.</div><div><br></div><div>When the "trusted" vdisk is back online, back up its data and audit the data</div><div>to make sure that it is intact. Then delete that vdisk, create a new vdisk, and</div><div>restore data from the backup to the new vdisk. Using a trusted vdisk is only a</div><div>disaster-recovery measure; the vdisk has no tolerance for any additional</div><div>failures.</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</div><div>INPUT</div><div>To enable the trust command:</div><div>trust enable</div><div><br></div><div>To trust a vdisk:</div><div>trust vdisk &lt;vdisk&gt;</div><div><br></div><div>enable</div><div>&nbsp; Enables the trust command before use.</div><div><br></div><div>vdisk &lt;vdisk&gt;</div><div>&nbsp; Name or serial number of the vdisk to trust. For syntax, type "help syntax".</div><div><br></div><div>EXAMPLE</div><div>Enable the trust command and then trust vdisk VD1:</div><div><br></div><div>&nbsp; # trust enable</div><div>&nbsp; Success: Command completed successfully.</div><div><br></div><div>&nbsp; # trust vdisk VD1</div><div>&nbsp; Success: Command completed successfully.</div></div></div>
	</div>
</div>
</body>
</html>