<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">how many performance decreased use dynamic SQL</h2>
	<h5 id="">2011-11-09 10:55:37&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402011109103953350/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">最近一些项目上的应用，必须使用PostgreSQL函数来保证事务一致性。<div>可以参考</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201110314133817/"  >http://blog.163.com/digoal@126/blog/static/163877040201110314133817/</a></div><div><br></div><div>接下来的问题是在函数中要使用到动态表名。那么就需要使用动态SQL来达到目的。</div><div><br></div><div>使用动态SQL的话就造成了SQL的硬解析。那么到底会带来多少的性能损失呢？来看看下面的测试：</div><div>测试版本 : PostgreSQL 9.1.1</div><div>测试表 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; \d parse_test&nbsp;</font></div><div><font size="2"  >&nbsp; Table "digoal.parse_test"</font></div><div><font size="2"  >&nbsp;Column | &nbsp;Type &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"  >--------+---------+-----------</font></div><div><font size="2"  >&nbsp;id &nbsp; &nbsp; | integer |&nbsp;</font></div><div><font size="2"  >&nbsp;info &nbsp; | text &nbsp; &nbsp;|&nbsp;</font></div><p></p></pre></div><div><br></div><div>测试函数 :&nbsp;</div><div>软解 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; \sf insert_parse_soft</font></div><div><font size="2"  >CREATE OR REPLACE FUNCTION digoal.insert_parse_soft(i_id integer, i_info text)</font></div><div><font size="2"  >&nbsp;RETURNS void</font></div><div><font size="2"  >&nbsp;LANGUAGE plpgsql</font></div><div><font size="2"  >AS $function$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >insert into parse_test (id,info) values (i_id,i_info);</font></div><div><font size="2"  >return;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$function$</font></div><p></p></pre></div><div>硬解 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; \sf insert_parse_hard</font></div><div><font size="2"  >CREATE OR REPLACE FUNCTION digoal.insert_parse_hard(i_id integer, i_info text)</font></div><div><font size="2"  >&nbsp;RETURNS void</font></div><div><font size="2"  >&nbsp;LANGUAGE plpgsql</font></div><div><font size="2"  >AS $function$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >execute $$insert into parse_test (id,info) values ($$||i_id||$$,'$$||i_info||$$')$$;</font></div><div><font size="2"  >return;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$function$</font></div><p></p></pre></div><div><br></div><div>测试脚本 :&nbsp;</div><div>软解 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; cat soft.sh</font></div><div><font size="2"  >nohup pgbench -M extended -r -c 32 -f ./insert_parse_soft.sql -j 16 -n -T 180 -h 127.0.0.1 -p 1996 -U digoal digoal &gt;&gt;./soft.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"  >postgres@db5-&gt; cat insert_parse_soft.sql&nbsp;</font></div><div><font size="2"  >SELECT * from &nbsp;insert_parse_soft(1,'digoal');</font></div><p></p></pre></div><div>硬解 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; cat hard.sh</font></div><div><font size="2"  >nohup pgbench -M extended -r -c 32 -f ./insert_parse_hard.sql -j 16 -n -T 180 -h 127.0.0.1 -p 1996 -U digoal digoal &gt;&gt;./hard.log 2&gt;&amp;1 &amp;</font></div><div><font size="2"  >postgres@db5-&gt; cat insert_parse_hard.sql&nbsp;</font></div><div><font size="2"  >SELECT * from &nbsp;insert_parse_hard(1,'digoal');</font></div><p></p></pre></div><div><br></div><div>测试结果 :&nbsp;</div><div>软解 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; cat soft.log&nbsp;</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: extended</font></div><div><font size="2"  >number of clients: 32</font></div><div><font size="2"  >number of threads: 16</font></div><div><font size="2"  >duration: 180 s</font></div><div><font size="2"  >number of transactions actually processed: 5576738</font></div><div><font size="2"  >tps = 30981.435432 (including connections establishing)</font></div><div><font size="2"  >tps = 30982.522494 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 1.030557 &nbsp; &nbsp; &nbsp; &nbsp;SELECT * from &nbsp;insert_parse_soft(1,'digoal');</font></div><p></p></pre></div><div>数据库服务器TOP :&nbsp;</div><div><div><div><img title="how many performance decreased use dynamic SQL - 德哥@Digoal - The Heart,The World."  alt="how many performance decreased use dynamic SQL - 德哥@Digoal - The Heart,The World."  style="margin:0 10px 0 0;"  src="http://img4.ph.126.net/PYG2eprpoJg4tl8mXJNv8w==/3094254418997312774.jpg"  ></div>&nbsp;</div>&nbsp;</div><div>硬解 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; cat hard.log&nbsp;</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: extended</font></div><div><font size="2"  >number of clients: 32</font></div><div><font size="2"  >number of threads: 16</font></div><div><font size="2"  >duration: 180 s</font></div><div><font size="2"  >number of transactions actually processed: 5459964</font></div><div><font size="2"  >tps = 30332.628632 (including connections establishing)</font></div><div><font size="2"  >tps = 30333.306981 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 1.052670 &nbsp; &nbsp; &nbsp; &nbsp;SELECT * from &nbsp;insert_parse_hard(1,'digoal');</font></div><p></p></pre></div><div>数据库服务器TOP :&nbsp;</div><div><div><img title="how many performance decreased use dynamic SQL - 德哥@Digoal - The Heart,The World."  alt="how many performance decreased use dynamic SQL - 德哥@Digoal - The Heart,The World."  style="margin:0 10px 0 0;"  src="http://img1.ph.126.net/D6bg6IddQXnRzeKnj20rTQ==/2573244237105884111.jpg"  ></div>&nbsp;</div><div><br></div><div>【小结】</div><div>硬解析给数据库服务器的CPU带来了较大的开销，约比软解析多消耗</div><div><pre class="prettyprint"  ><p><font size="2"  >100*(((1-0.256)-(1-0.357))/(1-0.357)) = 15.7% CPU。</font></p></pre></div><div>应尽量避免在数据库中使用动态SQL。</div></div>
	</div>
</div>
</body>
</html>