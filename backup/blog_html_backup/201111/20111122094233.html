<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL Notify/Listen Like ESB</h2>
	<h5 id="">2011-11-22 9:42:33&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201110229257331/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">&nbsp;ESB :&nbsp;<span style="color: rgb(1, 1, 1); font-family: 宋体, tahoma, Srial, helvetica, sans-serif; line-height: 25px; background-color: rgb(245, 248, 253);"  >基于消息的调用企业服务的通信模块.</span><div><font color="#010101"  face="宋体, tahoma, Srial, helvetica, sans-serif"  ><span style="line-height: 25px;"  >上个礼拜和一位老朋友吃饭，聊到他现在在做的一个产品。才初略的对ESB有点了解。</span></font></div><div><font color="#010101"  face="宋体, tahoma, Srial, helvetica, sans-serif"  ><span style="line-height: 25px;"  >发现PostgreSQL独有的Notify和Listen与总线实现的东西类似。一般用于监测表的改变，配合触发器使用，通知接收方表的数据有改变，接收方及时采取刷新动作。</span></font></div><div><span style="color: rgb(1, 1, 1); font-family: 宋体, tahoma, Srial, helvetica, sans-serif; line-height: 25px;"  >下面来简单的了解一下,详细的请参看PG源码src/backend/commands/async.c部分。</span></div><div><span style="color: rgb(1, 1, 1); font-family: 宋体, tahoma, Srial, helvetica, sans-serif; line-height: 25px;"  ><br></span></div><div><span style="color: rgb(1, 1, 1); font-family: 宋体, tahoma, Srial, helvetica, sans-serif; line-height: 25px;"  >LISTEN</span></div><div><span style="color: rgb(1, 1, 1); font-family: 宋体, tahoma, Srial, helvetica, sans-serif; line-height: 25px;"  >&nbsp; 用来注册一个消息通道。</span></div><div><span style="color: rgb(1, 1, 1); font-family: 宋体, tahoma, Srial, helvetica, sans-serif; line-height: 25px;"  >&nbsp; 如果在事务中执行listen, 那么事务必须成功commit, listen才生效.</span></div><div><span style="color: rgb(1, 1, 1); font-family: 宋体, tahoma, Srial, helvetica, sans-serif; line-height: 25px;"  >&nbsp; session 退出后listen自动释放.</span></div><div><span style="color: rgb(1, 1, 1); font-family: 宋体, tahoma, Srial, helvetica, sans-serif; line-height: 25px;"  >NOTIFY</span></div><div><font color="#010101"  face="宋体, tahoma, Srial, helvetica, sans-serif"  ><span style="line-height: 25px;"  >&nbsp; 用来往消息通道发送异步消息。</span></font></div><div><font color="#010101"  face="宋体, tahoma, Srial, helvetica, sans-serif"  ><span style="line-height: 25px;"  >&nbsp; 如果在事务中执行notify, 那么必须等事务成功commit之后这个消息才会塞进消息队列。</span></font></div><div><font color="#010101"  face="宋体, tahoma, Srial, helvetica, sans-serif"  ><span style="line-height: 25px;"  >&nbsp;&nbsp;</span></font><span style="color: rgb(1, 1, 1); font-family: 宋体, tahoma, Srial, helvetica, sans-serif; line-height: 25px;"  >消息在事务和事务之间的间隙传递。因此如果有一个listen的session中跑了一个很长的事务, 那么要等这个事务结束才能接收到这个过程中发出的notify。</span></div><div><span style="color: rgb(1, 1, 1); font-family: 宋体, tahoma, Srial, helvetica, sans-serif; line-height: 25px;"  >&nbsp; 一个消息如果在发出notify之前有监听者, 必须等这些监听者都接收到了这个消息才从消息队列中去除。</span></div><div><font color="#010101"  face="宋体, tahoma, Srial, helvetica, sans-serif"  ><span style="line-height: 25px;"  >UNLISTEN</span></font></div><div><font color="#010101"  face="宋体, tahoma, Srial, helvetica, sans-serif"  ><span style="line-height: 25px;"  >&nbsp; 释放已经注册的消息通道。</span></font></div><div><font color="#010101"  face="宋体, tahoma, Srial, helvetica, sans-serif"  ><br></font></div><div><font color="#010101"  face="宋体, tahoma, Srial, helvetica, sans-serif"  >不同的驱动接收异步消息的接口不一样，</font></div><div><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >The method a client application must use to detect notification events depends on which&nbsp;</span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >PostgreSQL</span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >&nbsp;application programming interface it uses. With the&nbsp;</span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >libpq</span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >&nbsp;library, the application issues&nbsp;</span><tt style="font-size: 12px; line-height: 18px;"  >LISTEN</tt><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >&nbsp;as an ordinary SQL command, and then must periodically call the function&nbsp;</span><code style="font-size: 12px; line-height: 18px;"  >PQnotifies</code><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >&nbsp;to find out whether any notification events have been received. Other interfaces such as&nbsp;</span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >libpgtcl</span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >&nbsp;provide higher-level methods for handling notify events; indeed, with&nbsp;</span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >libpgtcl</span><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >&nbsp;the application programmer should not even issue&nbsp;</span><tt style="font-size: 12px; line-height: 18px;"  >LISTEN</tt><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >&nbsp;or</span><tt style="font-size: 12px; line-height: 18px;"  >UNLISTEN</tt><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  >&nbsp;directly. See the documentation for the interface you are using for more details.</span></div><div><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18px;"  ><br></span></div><div><font face="verdana, sans-serif"  ><span style="font-size: 12px; line-height: 19px;"  >下面是psql中的</span></font><span style="color: rgb(1, 1, 1); font-family: 宋体, tahoma, Srial, helvetica, sans-serif; line-height: 25px;"  >测试 :&nbsp;</span></div><div><font color="#010101"  face="宋体, tahoma, Srial, helvetica, sans-serif"  ><span style="line-height: 25px;"  >SESSION A :&nbsp;</span></font></div><div><font color="#010101"  face="宋体, tahoma, Srial, helvetica, sans-serif"  ><span style="line-height: 25px;"  >注册一个监听通道'digoal',</span></font></div><div><font color="#010101"  face="宋体, tahoma, Srial, helvetica, sans-serif"  ><span style="line-height: 25px;"  ><div>blss=&gt; listen digoal;</div><div>LISTEN</div></span></font></div><div><span style="color: rgb(1, 1, 1); font-family: 宋体, tahoma, Srial, helvetica, sans-serif; line-height: 25px;"  ><br></span></div><div><span style="color: rgb(1, 1, 1); font-family: 宋体, tahoma, Srial, helvetica, sans-serif; line-height: 25px;"  >SESSION C :&nbsp;</span></div><div><span style="color: rgb(1, 1, 1); font-family: 宋体, tahoma, Srial, helvetica, sans-serif; line-height: 25px;"  >往监听通道</span><span style="color: rgb(1, 1, 1); font-family: 宋体, tahoma, Srial, helvetica, sans-serif; line-height: 25px;"  >'digoal'</span><span style="color: rgb(1, 1, 1); font-family: 宋体, tahoma, Srial, helvetica, sans-serif; line-height: 25px;"  >发送异步消息,</span></div><div><span style="color: rgb(1, 1, 1); font-family: 宋体, tahoma, Srial, helvetica, sans-serif; line-height: 25px;"  ><div>blss=&gt; notify digoal,'1';</div><div>NOTIFY</div><div>blss=&gt; notify digoal,'2';</div><div>NOTIFY</div><div><br></div><div>SESSION A :&nbsp;</div><div>接收异步消息,(注意异步消息在事务间隙传递,因此BEGIN的时候产生了这个间隙,消息被推送到接收方)</div><div><div>blss=&gt; begin;</div><div>BEGIN</div><div>Asynchronous notification "digoal" with payload "1" received from server process with PID 25964.</div><div>Asynchronous notification "digoal" with payload "2" received from server process with PID 25964.</div></div><div><span style="line-height: 25px;"  ><br></span></div><div><span style="line-height: 25px;"  >SESSION B :&nbsp;</span></div></span></div><div><div><span style="line-height: 25px; color: rgb(1, 1, 1); font-family: 宋体, tahoma, Srial, helvetica, sans-serif;"  >注册一个监听通道</span><span style="color: rgb(1, 1, 1); font-family: 宋体, tahoma, Srial, helvetica, sans-serif; line-height: 25px;"  >'digoal'</span><span style="color: rgb(1, 1, 1); font-family: 宋体, tahoma, Srial, helvetica, sans-serif; line-height: 25px;"  >,</span></div></div><div><div><span style="color: rgb(1, 1, 1); font-family: 宋体, tahoma, Srial, helvetica, sans-serif;"  >blss=&gt; listen digoal;</span></div><div><font color="#010101"  face="宋体, tahoma, Srial, helvetica, sans-serif"  >LISTEN</font></div><div><font color="#010101"  face="宋体, tahoma, Srial, helvetica, sans-serif"  >blss=&gt; begin;</font></div><div><font color="#010101"  face="宋体, tahoma, Srial, helvetica, sans-serif"  >BEGIN</font></div><div><font color="#010101"  face="宋体, tahoma, Srial, helvetica, sans-serif"  >blss=&gt;&nbsp;</font></div></div><div><font color="#010101"  face="宋体, tahoma, Srial, helvetica, sans-serif"  >未接收到之前的异步消息, 原因是已经移除了。</font></div><div><font color="#010101"  face="宋体, tahoma, Srial, helvetica, sans-serif"  ><br></font></div><div><font color="#010101"  face="宋体, tahoma, Srial, helvetica, sans-serif"  >SESSION A :&nbsp;</font></div><div><font color="#010101"  face="宋体, tahoma, Srial, helvetica, sans-serif"  >开启一个长事务,</font></div><div><font color="#010101"  face="宋体, tahoma, Srial, helvetica, sans-serif"  ><div>blss=&gt; select 1;</div><div>&nbsp;?column?&nbsp;</div><div>----------</div><div>&nbsp; &nbsp; &nbsp; &nbsp; 1</div><div>(1 row)</div><div><br></div><div>SESSION C :&nbsp;</div><div><span style="line-height: 25px;"  >往监听通道</span><span style="line-height: 25px;"  >'digoal'</span><span style="line-height: 25px;"  >发送异步消息,</span></div><div><div style="line-height: 25px;"  >blss=&gt; notify digoal,'3';</div><div style="line-height: 25px;"  >NOTIFY</div><div style="line-height: 25px;"  >blss=&gt; notify digoal,'4';</div><div style="line-height: 25px;"  >NOTIFY</div><div style="line-height: 25px;"  ><br></div><div><div style="line-height: 25px;"  >SESSION B :&nbsp;</div><div style="line-height: 25px;"  ><span style="line-height: 25px;"  >接收异步消息,</span></div><div><div><div>blss=&gt; end;</div><div>COMMIT</div><div>blss=&gt;&nbsp;</div><div>blss=&gt; begin;</div><div>BEGIN</div><div>Asynchronous notification "digoal" with payload "3" received from server process with PID 25964.</div><div>Asynchronous notification "digoal" with payload "4" received from server process with PID 25964.</div></div></div></div></div><div><br></div><div><span style="line-height: 25px;"  >SESSION D :&nbsp;</span></div><div><span style="line-height: 25px;"  >注册一个监听通道</span><span style="line-height: 25px;"  >'digoal'</span><span style="line-height: 25px;"  >,</span></div><div><div style="line-height: 25px;"  >blss=&gt; listen digoal;</div><div style="line-height: 25px;"  >LISTEN</div><div style="line-height: 25px;"  >blss=&gt; begin;</div><div style="line-height: 25px;"  >BEGIN</div><div style="line-height: 25px;"  >blss=&gt;&nbsp;</div><div style="line-height: 25px;"  >blss=&gt; end;</div><div style="line-height: 25px;"  >COMMIT</div><div style="line-height: 25px;"  >blss=&gt; begin;</div><div style="line-height: 25px;"  >BEGIN</div><div style="line-height: 25px;"  >blss=&gt;&nbsp;</div><div style="line-height: 25px;"  >虽然消息还在队列中，但是无法接收到。因为这个监听是在notify发出消息之后启动的。只能接收后面的消息。</div><div style="line-height: 25px;"  ><br></div><div style="line-height: 25px;"  ><div style="color: rgb(0, 0, 0); font-family: Arial, Helvetica, sans-serif;"  ><font color="#010101"  face="宋体, tahoma, Srial, helvetica, sans-serif"  >SESSION A :&nbsp;</font></div><div style="color: rgb(0, 0, 0); font-family: Arial, Helvetica, sans-serif;"  ><font color="#010101"  face="宋体, tahoma, Srial, helvetica, sans-serif"  >关闭长事务, 接收消息。</font></div></div><div><font color="#010101"  face="宋体, tahoma, Srial, helvetica, sans-serif"  ><div>blss=&gt; end;</div><div>COMMIT</div><div>blss=&gt; begin;</div><div>BEGIN</div><div>Asynchronous notification "digoal" with payload "3" received from server process with PID 25964.</div><div>Asynchronous notification "digoal" with payload "4" received from server process with PID 25964.</div></font></div></div></font></div><div><font color="#010101"  face="宋体, tahoma, Srial, helvetica, sans-serif"  ><span style="line-height: 25px;"  ><br></span></font></div><div><font color="#010101"  face="宋体, tahoma, Srial, helvetica, sans-serif"  ><span style="line-height: 25px;"  >相关数据库函数 :&nbsp;</span></font></div><div><font color="#010101"  face="宋体, tahoma, Srial, helvetica, sans-serif"  ><div style="line-height: 25px;"  ><pre class="prettyprint"  ><p></p><div style="line-height: 25px;"  >&nbsp; &nbsp;Schema &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| Result data type | Argument data types | &nbsp;Type &nbsp;</div><div style="line-height: 25px;"  >------------+-----------------------+------------------+---------------------+--------</div><div style="line-height: 25px;"  >&nbsp;pg_catalog | pg_listening_channels | SETOF text &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | normal</div><div>&nbsp;pg_catalog | pg_notify &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | void &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | text, text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| normal</div><p></p></pre></div></font></div><div><font color="#010101"  face="宋体, tahoma, Srial, helvetica, sans-serif"  ><span style="line-height: 25px;"  ><br></span></font><div>【参考】</div><div><a rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/sql-listen.html"  >http://www.postgresql.org/docs/9.1/static/sql-listen.html</a></div><div><a rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/sql-unlisten.html"  >http://www.postgresql.org/docs/9.1/static/sql-unlisten.html</a></div><div><a rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/sql-notify.html"  >http://www.postgresql.org/docs/9.1/static/sql-notify.html</a><br><wbr><div><a rel="nofollow" href="http://jdbc.postgresql.org/documentation/83/listennotify.html"  >http://jdbc.postgresql.org/documentation/83/listennotify.html</a></div><div>src/backend/commands/async.c</div><div><br></div></div></div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">bearmaphao - 2011-11-22 9:55:22</h5>
				<div>不错</div>
			</div>
	</div>
</div>
</body>
</html>