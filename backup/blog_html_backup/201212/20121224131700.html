<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL cluster table using index</h2>
	<h5 id="">2012-12-24 13:17:00&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020121124031374/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">今天一位群里的兄弟问到的cluster问题. 所以拿出来写一下.&nbsp;<div>PostgreSQL CLUSTER意在将表按照索引的顺序排布.&nbsp;</div><div>可以通过ctid来观察这个排布, 或者通过pg_stats.correlation来观察这个排布.&nbsp;</div><div>下面来举个例子 :&nbsp;</div><div>创建测试表 :&nbsp;</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; create table test (id int, val numeric);</font></div><div><font size="2"  >CREATE TABLE</font></div><p></p></pre></div><div>插入测试数据 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; insert into test select generate_series(1,100000),random();</font></div><div><font size="2"  >INSERT 0 100000</font></div><div><font size="2"  >表分析 :&nbsp;</font></div><div><font size="2"  >digoal=&gt; vacuum analyze test;</font></div><div><font size="2"  >VACUUM</font></div><p></p></pre></div></div><div>查询表的物理分布和对应列的值离散情况 :&nbsp;</div><div>可以看出id列的顺序和表的物理分布一致 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select correlation from pg_stats where schemaname='digoal' and tablename='test' and attname='id';</font></div><div><font size="2"  >&nbsp;correlation&nbsp;</font></div><div><font size="2"  >-------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >digoal=&gt; select correlation from pg_stats where schemaname='digoal' and tablename='test' and attname='val';</font></div><div><font size="2"  >&nbsp;correlation&nbsp;</font></div><div><font size="2"  >-------------</font></div><div><font size="2"  >&nbsp; 0.00625629</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>查询val的最小值的物理存储位置 :&nbsp;</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select ctid,id,val from test where val=(select min(val) from test);</font></div><div><font size="2"  >&nbsp; &nbsp;ctid &nbsp; &nbsp;| &nbsp;id &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;val &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >-----------+-------+------------------------</font></div><div><font size="2"  >&nbsp;(380,154) | 70420 | 0.00000077439472079277</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >查询id的最小值的物理存储位置 :&nbsp;</span></div><div><span style="line-height: 22px;"  >因为测试数据是generate_series(1,100000)生成的, 所以ID列的值与物理分布相同 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select ctid,id,val from test where id=(select min(id) from test);</font></div><div><font size="2"  >&nbsp;ctid &nbsp;| id | &nbsp; &nbsp; &nbsp; &nbsp;val &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >-------+----+-------------------</font></div><div><font size="2"  >&nbsp;(0,1) | &nbsp;1 | 0.645392156671733</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div></div><div>创建索引 :&nbsp;</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; create index idx_test_1 on test(id);</font></div><div><font size="2"  >CREATE INDEX</font></div><div><font size="2"  >digoal=&gt; create index idx_test_2 on test(val);</font></div><div><font size="2"  >CREATE INDEX</font></div><p></p></pre></div><div>使用cluster重新对表进行物理分布 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; cluster test using idx_test_2;</font></div><div><font size="2"  >CLUSTER</font></div><p></p></pre></div><div>再次查看<span style="line-height: 22px;"  >val的最小值的物理存储位置 :&nbsp;</span></div><div><span style="line-height: 22px;"  >说明表的物理分布已经和idx_test_2的排序相同了.</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select ctid,id,val from test where val=(select min(val) from test);</font></div><div><font size="2"  >&nbsp;ctid &nbsp;| &nbsp;id &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;val &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >-------+-------+------------------------</font></div><div><font size="2"  >&nbsp;(0,1) | 70420 | 0.00000077439472079277</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >再次查看id</span><span style="line-height: 22px;"  >的最小值的物理存储位置 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select ctid,id,val from test where id=(select min(id) from test);</font></div><div><font size="2"  >&nbsp; &nbsp;ctid &nbsp; | id | &nbsp; &nbsp; &nbsp; &nbsp;val &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----------+----+-------------------</font></div><div><font size="2"  >&nbsp;(349,37) | &nbsp;1 | 0.645392156671733</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>分析表 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; vacuum analyze test;</font></div><div><font size="2"  >VACUUM</font></div><p></p></pre></div></div><div><span style="line-height: 22px;"  >查询表的物理分布和对应列的值离散情况 :&nbsp;</span></div><div><span style="line-height: 22px;"  >可以看出现在表的物理分布和val列的值顺序一致.</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select correlation from pg_stats where schemaname='digoal' and tablename='test' and attname='id';</font></div><div><font size="2"  >&nbsp;correlation&nbsp;</font></div><div><font size="2"  >-------------</font></div><div><font size="2"  >&nbsp;-0.00118176</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >digoal=&gt; select correlation from pg_stats where schemaname='digoal' and tablename='test' and attname='val';</font></div><div><font size="2"  >&nbsp;correlation&nbsp;</font></div><div><font size="2"  >-------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div><div>现在使用idx_test_1这个索引来重分布test表 :&nbsp;</div><div>结果不再解释.</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal=&gt; cluster verbose test using idx_test_1;</font></div><div><font size="2"  >INFO: &nbsp;clustering "digoal.test" using index scan on "idx_test_1"</font></div><div><font size="2"  >INFO: &nbsp;"test": found 0 removable, 100000 nonremovable row versions in 542 pages</font></div><div><font size="2"  >DETAIL: &nbsp;0 dead row versions cannot be removed yet.</font></div><div><font size="2"  >CPU 0.00s/0.15u sec elapsed 0.19 sec.</font></div><div><font size="2"  >CLUSTER</font></div><div><font size="2"  >digoal=&gt; select ctid,id,val from test where val=(select min(val) from test);</font></div><div><font size="2"  >&nbsp; &nbsp;ctid &nbsp; &nbsp;| &nbsp;id &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;val &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >-----------+-------+------------------------</font></div><div><font size="2"  >&nbsp;(380,154) | 70420 | 0.00000077439472079277</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >digoal=&gt; select ctid,id,val from test where id=(select min(id) from test);</font></div><div><font size="2"  >&nbsp;ctid &nbsp;| id | &nbsp; &nbsp; &nbsp; &nbsp;val &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >-------+----+-------------------</font></div><div><font size="2"  >&nbsp;(0,1) | &nbsp;1 | 0.645392156671733</font></div><div><font size="2"  >(1 row)</font></div></div><div><font size="2"  >digoal=&gt; vacuum analyze test;</font></div><div><div><font size="2"  >VACUUM</font></div></div><div><font size="2"  >digoal=&gt; select correlation from pg_stats where schemaname='digoal' and tablename='test' and attname='id';</font></div><div><div><font size="2"  >&nbsp;correlation&nbsp;</font></div><div><font size="2"  >-------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >digoal=&gt; select correlation from pg_stats where schemaname='digoal' and tablename='test' and attname='val';</font></div><div><font size="2"  >&nbsp;correlation&nbsp;</font></div><div><font size="2"  >-------------</font></div><div><font size="2"  >&nbsp; 0.00780408</font></div><div><font size="2"  >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>cluster的好处 :&nbsp;</div><div>1. 因为PostgreSQL 统计了表的物理存储顺序和每一列值的顺态值, 在执行计划选择时, 可以用到这个顺态值用作计算走索引的成本.</div><div>这个值越接近0, 说明表的物理分布上这个列的值比较离散, 走索引的成本越高;&nbsp;</div><div>反之这个值越接近1或者-1,&nbsp;<span style="line-height: 22px;"  >说明表的物理分布上这个列的值比较有序, 走索引的成本越低;&nbsp;</span></div><div><span style="line-height: 22px;"  >2. cluster 后, 表的物理分布就和索引一致了, 观察上面ctid的变化就可以得知. cluster完后查看pg_stats.correlation会等于1.</span></div><div><span style="line-height: 22px;"  >3. 注意cluster是一次性的, 在这个表做了dml 后, 物理分布又会被打乱.</span></div><div><span style="line-height: 22px;"  >4. 结合块设备的read ahead, cluster后, 如果执行计划走这个cluster了的索引取数据(如几百条到几万条[取数在全表来说是比较少的时候]), 可以减少大量的物理磁盘读请求.</span></div><div><br></div><div>cluster加哪些锁?</div><div>SESSION 1 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal=&gt; begin;</font></div><div><font size="2"  >BEGIN</font></div><div><font size="2"  >digoal=&gt; cluster test using idx_test_2;</font></div><div><font size="2"  >CLUSTER</font></div></div><div><div><font size="2"  >digoal=&gt; select pg_backend_pid();</font></div><div><font size="2"  >&nbsp;pg_backend_pid&nbsp;</font></div><div><font size="2"  >----------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 10222</font></div></div><p></p></pre></div><div><br></div><div>SESSION 2 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select pid,locktype,database,relation,granted,mode,b.relname from pg_locks a,pg_class b where a.relation=b.oid and pid=10222;</font></div><div><font size="2"  >&nbsp; pid &nbsp;| locktype | database | relation | granted | &nbsp; &nbsp; &nbsp; &nbsp;mode &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp;relname &nbsp;&nbsp;</font></div><div><font size="2"  >-------+----------+----------+----------+---------+---------------------+------------</font></div><div><font size="2"  >&nbsp;10222 | relation | &nbsp; &nbsp;16386 | &nbsp; &nbsp;89731 | t &nbsp; &nbsp; &nbsp; | AccessShareLock &nbsp; &nbsp; | idx_test_2</font></div><div><font size="2"  >&nbsp;10222 | relation | &nbsp; &nbsp;16386 | &nbsp; &nbsp;89731 | t &nbsp; &nbsp; &nbsp; | AccessExclusiveLock | idx_test_2</font></div><div><font size="2"  >&nbsp;10222 | relation | &nbsp; &nbsp;16386 | &nbsp; &nbsp;89729 | t &nbsp; &nbsp; &nbsp; | AccessShareLock &nbsp; &nbsp; | idx_test_1</font></div><div><font size="2"  >&nbsp;10222 | relation | &nbsp; &nbsp;16386 | &nbsp; &nbsp;89729 | t &nbsp; &nbsp; &nbsp; | AccessExclusiveLock | idx_test_1</font></div><div><font size="2"  >&nbsp;10222 | relation | &nbsp; &nbsp;16386 | &nbsp; &nbsp;89726 | t &nbsp; &nbsp; &nbsp; | ShareLock &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | test</font></div><div><font size="2"  >&nbsp;10222 | relation | &nbsp; &nbsp;16386 | &nbsp; &nbsp;89726 | t &nbsp; &nbsp; &nbsp; | AccessExclusiveLock | test</font></div><div><font size="2"  >(6 rows)</font></div><p></p></pre></div><div>对照<span style="line-height: 22px;"  >src/include/storage/lock.h的定义, 可以看出这里总共涉及了以下锁 :&nbsp;</span></div><div><span style="line-height: 22px;"  >test表的ShareLock 是</span>CREATE INDEX (WITHOUT CONCURRENTLY)申请的.</div><div>test表的<span style="line-height: 22px;"  >AccessExclusiveLock 是重建表申请的,</span></div><div><span style="line-height: 22px;"  >索引的</span>AccessShareLock和<span style="line-height: 22px;"  >AccessExclusiveLock</span><span style="line-height: 22px;"  >&nbsp;是重建索引申请的.</span></div><div><span style="line-height: 22px;"  >也就是说cluster不但要重建表还要重建索引.</span></div><div>AccessExclusiveLock和所有锁冲突, 因此select也被阻断 :&nbsp;</div><div>SESSION 1 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; begin;</font></div><div><font size="2"  >BEGIN</font></div><div><font size="2"  >digoal=&gt; cluster test using idx_test_1;</font></div><div><font size="2"  >CLUSTER</font></div><p></p></pre></div><div><br></div><div>SESSION 2 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select * from test limit 1;</font></div><div><font size="2"  >waiting...</font></div><p></p></pre></div><div><br></div><div>SESSION 3 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select pid,locktype,database,relation,granted,mode,b.relname from pg_locks a,pg_class b where a.relation=b.oid;</font></div><div><font size="2"  >&nbsp; pid &nbsp;| locktype | database | relation | granted | &nbsp; &nbsp; &nbsp; &nbsp;mode &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;relname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >-------+----------+----------+----------+---------+---------------------+----------------------------</font></div><div><font size="2"  >&nbsp;12044 | relation | &nbsp; &nbsp;16386 | &nbsp; &nbsp; 2663 | t &nbsp; &nbsp; &nbsp; | AccessShareLock &nbsp; &nbsp; | pg_class_relname_nsp_index</font></div><div><font size="2"  >&nbsp;12044 | relation | &nbsp; &nbsp;16386 | &nbsp; &nbsp; 2662 | t &nbsp; &nbsp; &nbsp; | AccessShareLock &nbsp; &nbsp; | pg_class_oid_index</font></div><div><font size="2"  >&nbsp;12044 | relation | &nbsp; &nbsp;16386 | &nbsp; &nbsp; 1259 | t &nbsp; &nbsp; &nbsp; | AccessShareLock &nbsp; &nbsp; | pg_class</font></div><div><font size="2"  >&nbsp;12044 | relation | &nbsp; &nbsp;16386 | &nbsp; &nbsp;11069 | t &nbsp; &nbsp; &nbsp; | AccessShareLock &nbsp; &nbsp; | pg_locks</font></div><div><font size="2"  >&nbsp;10759 | relation | &nbsp; &nbsp;16386 | &nbsp; &nbsp;89762 | f &nbsp; &nbsp; &nbsp; | AccessShareLock &nbsp; &nbsp; | test</font></div><div><font size="2"  >&nbsp; 5685 | relation | &nbsp; &nbsp;16386 | &nbsp; &nbsp;89768 | t &nbsp; &nbsp; &nbsp; | AccessShareLock &nbsp; &nbsp; | idx_test_1</font></div><div><font size="2"  >&nbsp; 5685 | relation | &nbsp; &nbsp;16386 | &nbsp; &nbsp;89768 | t &nbsp; &nbsp; &nbsp; | AccessExclusiveLock | idx_test_1</font></div><div><font size="2"  >&nbsp; 5685 | relation | &nbsp; &nbsp;16386 | &nbsp; &nbsp;89765 | t &nbsp; &nbsp; &nbsp; | AccessExclusiveLock | pg_toast_89762</font></div><div><font size="2"  >&nbsp; 5685 | relation | &nbsp; &nbsp;16386 | &nbsp; &nbsp;89762 | t &nbsp; &nbsp; &nbsp; | ShareLock &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | test</font></div><div><font size="2"  >&nbsp; 5685 | relation | &nbsp; &nbsp;16386 | &nbsp; &nbsp;89762 | t &nbsp; &nbsp; &nbsp; | AccessExclusiveLock | test</font></div><div><font size="2"  >&nbsp; 5685 | relation | &nbsp; &nbsp;16386 | &nbsp; &nbsp;89769 | t &nbsp; &nbsp; &nbsp; | AccessShareLock &nbsp; &nbsp; | idx_test_2</font></div><div><font size="2"  >&nbsp; 5685 | relation | &nbsp; &nbsp;16386 | &nbsp; &nbsp;89769 | t &nbsp; &nbsp; &nbsp; | AccessExclusiveLock | idx_test_2</font></div><div><font size="2"  >(12 rows)</font></div><p></p></pre></div><div>pid=10759的会话正在等待test表的AccessShareLock.</div><div><span style="line-height: 22px;"  ><br></span></div><div>因此filenode也是发生变化的, 如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal=&gt; \d+ test</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Table "digoal.test"</font></div><div><font size="2"  >&nbsp; Column &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Modifiers | Storage | Stats target | Description&nbsp;</font></div><div><font size="2"  >----------+-----------------------------+-----------+---------+--------------+-------------</font></div><div><font size="2"  >&nbsp;id &nbsp; &nbsp; &nbsp; | integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >&nbsp;crt_time | timestamp without time zone | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >Indexes:</font></div><div><font size="2"  >&nbsp; &nbsp; "idx_test_1" btree (id)</font></div><div><font size="2"  >&nbsp; &nbsp; "idx_test_2" btree (crt_time DESC) CLUSTER</font></div><div><font size="2"  >Has OIDs: no</font></div></div><div><div><font size="2"  >digoal=&gt; select pg_relation_filepath('test'::regclass);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pg_relation_filepath &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >----------------------------------------------</font></div><div><font size="2"  >&nbsp;pg_tblspc/16385/PG_9.2_201204301/16386/89752</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >digoal=&gt; select pg_relation_filepath('idx_test_1'::regclass);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pg_relation_filepath &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >----------------------------------------------</font></div><div><font size="2"  >&nbsp;pg_tblspc/16385/PG_9.2_201204301/16386/89755</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >digoal=&gt; select pg_relation_filepath('idx_test_2'::regclass);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pg_relation_filepath &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >----------------------------------------------</font></div><div><font size="2"  >&nbsp;pg_tblspc/16385/PG_9.2_201204301/16386/89756</font></div><div><font size="2"  >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>执行cluster后, 表, 索引的文件名都发生了变化 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; cluster test using idx_test_2;</font></div><div><font size="2"  >CLUSTER</font></div><div><font size="2"  >digoal=&gt; select pg_relation_filepath('test'::regclass);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pg_relation_filepath &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >----------------------------------------------</font></div><div><font size="2"  >&nbsp;pg_tblspc/16385/PG_9.2_201204301/16386/89757</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >digoal=&gt; select pg_relation_filepath('idx_test_1'::regclass);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pg_relation_filepath &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >----------------------------------------------</font></div><div><font size="2"  >&nbsp;pg_tblspc/16385/PG_9.2_201204301/16386/89760</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >digoal=&gt; select pg_relation_filepath('idx_test_2'::regclass);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;pg_relation_filepath &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >----------------------------------------------</font></div><div><font size="2"  >&nbsp;pg_tblspc/16385/PG_9.2_201204301/16386/89761</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div><div>【参考】</div><div>1.&nbsp;src/backend/commands/cluster.c</div><div>2.&nbsp;</div><div>pg_stats.correlation</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >Statistical correlation between physical row ordering and logical ordering of the column values.&nbsp;</font></div><div><font size="2"  >This ranges from -1 to +1.&nbsp;</font></div><div><font size="2"  >When the value is near -1 or +1, an index scan on the column will be estimated to be cheaper than when it is near zero, due to reduction of random access to the disk.&nbsp;</font></div><div><font size="2"  >(This column is null if the column data type does not have a &lt; operator.)</font></div></div><div><font size="2"  >digoal=&gt; \d pg_stats</font><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; View "pg_catalog.pg_stats"</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Column &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; Type &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"  >------------------------+----------+-----------</font></div><div><font size="2"  >&nbsp;schemaname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | name &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >&nbsp;tablename &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| name &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >&nbsp;attname &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| name &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >&nbsp;inherited &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| boolean &nbsp;|&nbsp;</font></div><div><font size="2"  >&nbsp;null_frac &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| real &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >&nbsp;avg_width &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| integer &nbsp;|&nbsp;</font></div><div><font size="2"  >&nbsp;n_distinct &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | real &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >&nbsp;most_common_vals &nbsp; &nbsp; &nbsp; | anyarray |&nbsp;</font></div><div><font size="2"  >&nbsp;most_common_freqs &nbsp; &nbsp; &nbsp;| real[] &nbsp; |&nbsp;</font></div><div><font size="2"  >&nbsp;histogram_bounds &nbsp; &nbsp; &nbsp; | anyarray |&nbsp;</font></div><div><font size="2"  >&nbsp;correlation &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| real &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >&nbsp;most_common_elems &nbsp; &nbsp; &nbsp;| anyarray |&nbsp;</font></div><div><font size="2"  >&nbsp;most_common_elem_freqs | real[] &nbsp; |&nbsp;</font></div><div><font size="2"  >&nbsp;elem_count_histogram &nbsp; | real[] &nbsp; |&nbsp;</font></div></div><p></p></pre></div><div><div>3.&nbsp;src/include/storage/lock.h</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >#define NoLock &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >#define AccessShareLock &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* SELECT */</font></div><div><font size="2"  >#define RowShareLock &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* SELECT FOR UPDATE/FOR SHARE */</font></div><div><font size="2"  >#define RowExclusiveLock &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* INSERT, UPDATE, DELETE */</font></div><div><font size="2"  >#define ShareUpdateExclusiveLock 4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* VACUUM (non-FULL),ANALYZE, CREATE</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* INDEX CONCURRENTLY */</font></div><div><font size="2"  >#define ShareLock &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* CREATE INDEX (WITHOUT CONCURRENTLY) */</font></div><div><font size="2"  >#define ShareRowExclusiveLock &nbsp; 6 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* like EXCLUSIVE MODE, but allows ROW</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* SHARE */</font></div><div><font size="2"  >#define ExclusiveLock &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 7 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* blocks ROW SHARE/SELECT...FOR</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* UPDATE */</font></div><div><font size="2"  >#define AccessExclusiveLock &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* ALTER TABLE, DROP TABLE, VACUUM</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* FULL, and unqualified LOCK TABLE */</font></div><p></p></pre></div><div>4.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/sql-cluster.html"  >http://www.postgresql.org/docs/9.2/static/sql-cluster.html</a></div>5.&nbsp;<wbr><a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/view-pg-stats.html"  >http://www.postgresql.org/docs/9.2/static/view-pg-stats.html</a></div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">chengh0201 - 2012-12-24 13:36:58</h5>
				<div><IMG src="http://b.bst.126.net/common/portrait/face/preview/face55.gif"  ></div>
			</div>
	</div>
</div>
</body>
</html>