<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL WHY ERROR:  invalid byte sequence for encoding "UTF8"</h2>
	<h5 id="">2012-12-28 14:31:56&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201211281407682/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>使用PostgreSQL 的朋友可能遇到过类似ERROR: &nbsp;invalid byte sequence for encoding "UTF8": 0x00 的报错.</div><div>这是什么原因呢? 本文就来解释一下 :&nbsp;</div><div>首先我们这里说的是UTF8字符集, 我的测试环境如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ocz@db-172-16-3-150-&gt; psql digoal digoal</font></div><div><font size="2"   >psql (9.2.1)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=&gt; \l</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of databases</font></div><div><font size="2"   >&nbsp; &nbsp;Name &nbsp; &nbsp;| &nbsp;Owner &nbsp; | Encoding | Collate | Ctype | &nbsp; Access privileges &nbsp;&nbsp;</font></div><div><font size="2"   >-----------+----------+----------+---------+-------+-----------------------</font></div><div><font size="2"   >&nbsp;digoal &nbsp; &nbsp;| postgres | UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; | =Tc/postgres &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | postgres=CTc/postgres+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | digoal=CTc/postgres</font></div><div><font size="2"   >&nbsp;postgres &nbsp;| postgres | UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;skycac &nbsp; &nbsp;| postgres | UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; | =Tc/postgres &nbsp; &nbsp; &nbsp; &nbsp; +</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | postgres=CTc/postgres+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | skycac=CTc/postgres</font></div><div><font size="2"   >&nbsp;template0 | postgres | UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; | =c/postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | postgres=CTc/postgres</font></div><div><font size="2"   >&nbsp;template1 | postgres | UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; | =c/postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | postgres=CTc/postgres</font></div><div><font size="2"   >(5 rows)</font></div><p></p></pre></div><div>Encoding = UTF8.</div><div>这个字符集的详细信息可以去看本文参考部分提到的几篇文章.</div><div>UTF8是变长的, 1-6个字节.</div><div>它需要遵循如下编码规则 :&nbsp;</div><div><div><img title="PostgreSQL WHY ERROR:  invalid byte sequence for encoding UTF8 - 德哥@Digoal - The Heart,The World."   alt="PostgreSQL WHY ERROR:  invalid byte sequence for encoding UTF8 - 德哥@Digoal - The Heart,The World."   style="margin:0 10px 0 0;"   src="http://img4.ph.126.net/lDHOx69_6AoC5TE-ZyGx0A==/2534400690320777564.jpg"   ></div>实际能使用的比特位总数是7, 11, 16, 21, 26, 31.&nbsp;</div><div>上图每个字节中的x表示可以实际使用的位置. 其他的位置必须固定, 这么设计的好处之一是读到第一个字节的时候就知道这个字符占用几个字节.</div><div>正因为有以上规定, 凡是不符合这个规则的都视为非法字符.</div><div>合法使用的例子 :&nbsp;</div><div><div><img title="PostgreSQL WHY ERROR:  invalid byte sequence for encoding UTF8 - 德哥@Digoal - The Heart,The World."   alt="PostgreSQL WHY ERROR:  invalid byte sequence for encoding UTF8 - 德哥@Digoal - The Heart,The World."   style="margin:0 10px 0 0;"   src="http://img8.ph.126.net/Xz2r7tm6GFcfW5izTn-HCg==/2757891821828829078.jpg"   ></div><div>Binary UTF-8的黑色数字就是固定位置的数字.</div><div>例如在数据库中查询以上Hexadecimal UTF-8 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select E'\x24';</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp;$</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=&gt; select E'\xC2\xA2';</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp;￠</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=&gt; select E'\xe2\x82\xac';</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp;?</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>反向转换也是可以的 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select 'a'::bytea;</font></div><div><font size="2"   >&nbsp;bytea&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp;\x61</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=&gt; select 'abc'::bytea;</font></div><div><font size="2"   >&nbsp; bytea &nbsp;&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp;\x616263</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=&gt; select '你好'::bytea;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;bytea &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------------</font></div><div><font size="2"   >&nbsp;\xe4bda0e5a5bd</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>如果输入的字符编码违反了图中的规定, 就会报错 :&nbsp;</div><div>例如 :&nbsp;</div><div>10001111 转换成16进制是8F, 查询就报错 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select E'\x8f';</font></div><div><font size="2"   >ERROR: &nbsp;invalid byte sequence for encoding "UTF8": 0x8f</font></div><p></p></pre></div><div>又或者 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select E'\x00';</font></div><div><font size="2"   >ERROR: &nbsp;invalid byte sequence for encoding "UTF8": 0x00</font></div><p></p></pre></div>0x00报错又是为什么呢? 它是合法的UTF8字符!</div><div>因为 ：psql does not support embedded NUL bytes in variable values.　NUL就是E'\x00'.</div><div>如果要存储NUL, 请使用bytea类型 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select '\x00'::bytea;</font></div><div><font size="2"   >&nbsp;bytea&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp;\x00</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>转义参考 :&nbsp;</div><div><div>String Constants with C-style Escapes</div><div>String Constants with Unicode Escapes</div></div><div><br></div>【参考】<div>1.&nbsp;<a target="_blank" rel="nofollow" href="http://en.wikipedia.org/wiki/UTF-8"   >http://en.wikipedia.org/wiki/UTF-8</a></div><div>2.&nbsp;<a target="_blank" rel="nofollow" href="http://en.wikipedia.org/wiki/Unicode"   >http://en.wikipedia.org/wiki/Unicode</a></div><div>3.&nbsp;<a target="_blank" rel="nofollow" href="http://tools.ietf.org/html/rfc3629"   >http://tools.ietf.org/html/rfc3629</a></div><div>4.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/sql-syntax-lexical.html"   >http://www.postgresql.org/docs/9.1/static/sql-syntax-lexical.html</a></div><div>5.&nbsp;<a target="_blank" rel="nofollow" href="http://stackoverflow.com/questions/1347646/postgres-error-on-insert-error-invalid-byte-sequence-for-encoding-utf8-0x0?rq=1"   >http://stackoverflow.com/questions/1347646/postgres-error-on-insert-error-invalid-byte-sequence-for-encoding-utf8-0x0?rq=1</a></div><div><br></div><div><br><br><wbr></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL WHY ERROR:  invalid byte sequence for encoding UTF8 - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">Cutis_Dow - 2015-01-30 11:30:07</h5>
				<div>我在coordinator中将dct_test_01&nbsp;重新分布：&nbsp;alter table dct_test_01 DISTRIBUTE BY hash(id), to node(datanode2,datanode3);报错<span class="pln"  style=""  >invalid </span><span class="kwd"  style=""  >byte</span><span class="pln"  style=""  > sequence </span><span class="kwd"  style=""  >for</span><span class="pln"  style=""  > encoding </span><span class="str"  style=""  >"UTF8"</span><span class="pun"  style=""  >:</span><span class="pln"  style=""  > </span><span class="lit"  style=""  >0x00，我也以为是有null然后检查了所有字段都没有，这是怎么回事呢。注：该表原先分布在五个节点上，我打算将他们分布到2、3节点。</span></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 Cutis_Dow - 2015-01-30 11:30:07</h5>
				<div style="width:600px;">数据有问题, 你可以修改一下COPY代码, 绕过字符集合法性检测.&nbsp;</div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 Cutis_Dow - 2015-01-30 11:30:07</h5>
				<div style="width:600px;"><div>参考</div>http://blog.163.com/digoal@126/blog/static/16387704020141139372877/</div>
			</div>
			<div id="">
				<h5 id="">11 - 2013-11-30 15:02:44</h5>
				<div>咋解决</div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 11 - 2013-11-30 15:02:44</h5>
				<div style="width:600px;">文中已说明.</div>
			</div>
	</div>
</div>
</body>
</html>