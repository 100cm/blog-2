<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">smartctl command's RETURN VALUES</h2>
	<h5 id="">2012-12-04 7:54:30&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201211345235119/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>smartctl 的返回值是由8个比特位组成的 , 具体的解释参考本为末尾部分。</div><div>使用smartctl -H可以根据磁盘已经收集的信息检测磁盘的监控状态。返回的是一个数值类型。</div><div>返回值具体代表什么意思需要翻译成8个比特位，并查询smartctl的RETURN VALUES。</div><div>如果smartctl的输出了failing的健康状态的话, 表示磁盘已经failed或者将要在24小时内failed了.&nbsp;</div><div>1. 首先确保开启硬盘的几个选项 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ><span style="line-height: 22px;"  >smartctl&nbsp;</span>-S on -s on -o on /dev/sdd</font></div><div><div><font size="2"  >[root@db-172-16-3-150 ~]# /opt/smartmontools-6.0/sbin/smartctl -S on -s on -o on /dev/sdd</font></div><div><font size="2"  >smartctl 6.0 2012-10-10 r3643 [x86_64-linux-2.6.18-274.el5] (local build)</font></div><div><font size="2"  >Copyright (C) 2002-12, Bruce Allen, Christian Franke, www.smartmontools.org</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >=== START OF ENABLE/DISABLE COMMANDS SECTION ===</font></div><div><font size="2"  >SMART Enabled.</font></div><div><font size="2"  >SMART Attribute Autosave Enabled.</font></div><div><font size="2"  >SMART Automatic Offline Testing Enabled every four hours.</font></div></div><p></p></pre></div><div>2. smartctl健康检查选项 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;-H, --health</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Check: Ask the device to report its SMART health status or pending TapeAlert messages. &nbsp;SMART status &nbsp;is</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; based &nbsp;on &nbsp;information &nbsp;that &nbsp;it &nbsp;has &nbsp;gathered from online and offline tests, which were used to deter-</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mine/update its SMART vendor-specific Attribute values. TapeAlert status &nbsp;is &nbsp;obtained &nbsp;by &nbsp;reading &nbsp;the</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TapeAlert log page.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; If &nbsp;the &nbsp;device &nbsp;reports failing health status, this means either that the device has already failed, or</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; that it is predicting its own failure within the next 24 hours. &nbsp;If this happens, use the ′-a′ option to</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; get more information, and get your data off the disk and to someplace safe as soon as you can.</font></div><p></p></pre></div><div><div>健康检查示例 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db-172-16-3-150 ~]# /opt/smartmontools-6.0/sbin/smartctl -H /dev/sdd</font></div><div><font size="2"  >smartctl 6.0 2012-10-10 r3643 [x86_64-linux-2.6.18-274.el5] (local build)</font></div><div><font size="2"  >Copyright (C) 2002-12, Bruce Allen, Christian Franke, www.smartmontools.org</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >=== START OF READ SMART DATA SECTION ===</font></div><div><font size="2"  >SMART overall-health self-assessment test result: PASSED</font></div><div><font size="2"  >返回值 : </font></div><div><font size="2"  >[root@db-172-16-3-150 ~]# echo $?</font></div><div><font size="2"  >0</font></div><p></p></pre></div></div><div>或者仅输出错误 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db-172-16-3-150 ~]# /opt/smartmontools-6.0/sbin/smartctl -H -q errorsonly /dev/sdd</font></div><div><font size="2"  >[root@db-172-16-3-150 ~]#&nbsp;</font></div><p></p></pre></div><div>3. 返回值解析脚本 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db-172-16-3-150 ~]# cat smart.sh</font></div><div><font size="2"  >/opt/smartmontools-6.0/sbin/smartctl -H -d sat+megaraid,2 /dev/sdb</font></div><div><font size="2"  >status=$?</font></div><div><font size="2"  >for ((i=0; i&lt;8; i++)); do</font></div><div><font size="2"  >&nbsp; echo "Bit $i: $((status &amp; 2**i &amp;&amp; 1))"</font></div><div><font size="2"  >done</font></div><p></p></pre></div><div>执行这个shell script :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@db-172-16-3-150 ~]# . ./smart.sh</font></div><div><font size="2"  >smartctl 6.0 2012-10-10 r3643 [x86_64-linux-2.6.18-274.el5] (local build)</font></div><div><font size="2"  >Copyright (C) 2002-12, Bruce Allen, Christian Franke, www.smartmontools.org</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >=== START OF READ SMART DATA SECTION ===</font></div><div><font size="2"  >SMART overall-health self-assessment test result: PASSED</font></div><div><font size="2"  >Warning: This result is based on an Attribute check.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Bit 0: 0</font></div><div><font size="2"  >Bit 1: 0</font></div><div><font size="2"  >Bit 2: 1</font></div><div><font size="2"  >Bit 3: 0</font></div><div><font size="2"  >Bit 4: 0</font></div><div><font size="2"  >Bit 5: 0</font></div><div><font size="2"  >Bit 6: 0</font></div><div><font size="2"  >Bit 7: 0</font></div><p></p></pre></div><div>以上这些比特位的含义见参考部分.&nbsp;</div><div>这个结果是PASSWD的但是返回值不是0, 而是4. (bit2 :1).</div><div>从源码ataprint.cpp部分来看 :&nbsp;</div><div>ataSmartStatus2(device) 这里的&nbsp;<span style="line-height: 22px;"  >ataSmartStatus2(device) 返回值并非0或-1.</span></div><div>所以到了如下代码段 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp; &nbsp; default:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; // Something went wrong with the SMART STATUS command.</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; // The ATA SMART RETURN STATUS command provides the result in the ATA output</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; // registers. Buggy ATA/SATA drivers and SAT Layers often do not properly</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; // return the registers values.</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; failuretest(OPTIONAL_CMD, returnval|=FAILSMART);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; if (!(smart_val_ok &amp;&amp; smart_thres_ok)) {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; print_on();</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; pout("SMART overall-health self-assessment test result: UNKNOWN!\n"</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"SMART Status, Attributes and Thresholds cannot be read.\n\n");</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; else if (find_failed_attr(&amp;smartval, &amp;smartthres, attribute_defs, 1)) {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; print_on();</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; pout("SMART overall-health self-assessment test result: FAILED!\n"</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"Drive failure expected in less than 24 hours. SAVE ALL DATA.\n");</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; print_off();</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; returnval|=FAILATTR;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; returnval|=FAILSTATUS;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; if (options.smart_vendor_attrib)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pout("See vendor-specific Attribute list for failed Attributes.\n\n");</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; else {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; print_on();</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pout("Failed Attributes:\n");</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PrintSmartAttribWithThres(&amp;smartval, &amp;smartthres, attribute_defs, rpm, 1, options.output_format);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; else {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; pout("SMART overall-health self-assessment test result: PASSED\n");</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; pout("Warning: This result is based on an Attribute check.\n");</font></div><p></p></pre></div><div><br></div>【参考】<div>1.&nbsp;<a target="_blank" rel="nofollow" href="http://www.linuxjournal.com/article/6983"  >http://www.linuxjournal.com/article/6983</a><br><div><div>2. RETURN VALUES</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;The &nbsp;return &nbsp;values of smartctl are defined by a bitmask. &nbsp;If all is well with the disk, the return value (exit</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;status) of smartctl is 0 (all bits turned off). &nbsp;If a problem occurs, or an error, potential error, or fault is</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;detected, &nbsp;then a non-zero status is returned. &nbsp;In this case, the eight different bits in the return value have</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;the following meanings for ATA disks; some of these values may also be returned for SCSI disks.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;Bit 0: Command line did not parse.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;Bit 1: Device open failed, device did not return an IDENTIFY DEVICE structure, or device is in a low-power mode</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (see ′-n′ option above).</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;Bit 2: Some SMART or other ATA command to the disk failed, or there was a checksum error in a SMART data struc-</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ture (see ′-b′ option above).</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;Bit 3: SMART status check returned "DISK FAILING".</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;Bit 4: We found prefail Attributes &lt;= threshold.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;Bit 5: SMART status check returned "DISK OK" but we found that some (usage or prefail) Attributes have been &nbsp;&lt;=</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; threshold at some time in the past.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;Bit 6: The device error log contains records of errors.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;Bit 7: The &nbsp;device &nbsp;self-test log contains records of errors. &nbsp;[ATA only] Failed self-tests outdated by a newer</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; successful extended self-test are ignored.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;To test within the shell for whether or not the different bits are turned on or off, you can use the &nbsp;following</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;type of construction (this is bash syntax):</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;smartstat=$(($? &amp; 8))</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;This &nbsp;looks &nbsp;at &nbsp;only &nbsp;at &nbsp;bit &nbsp;3 &nbsp;of the exit status $? &nbsp;(since 8=2^3). &nbsp;The shell variable $smartstat will be</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;nonzero if SMART status check returned "disk failing" and zero otherwise.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;This bash script prints all status bits:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;status=$?</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;for ((i=0; i&lt;8; i++)); do</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;echo "Bit $i: $((status &amp; 2**i &amp;&amp; 1))"</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;done</font></div><p></p></pre></div><div><br></div><wbr></div></div></div>
	</div>
</div>
</body>
</html>