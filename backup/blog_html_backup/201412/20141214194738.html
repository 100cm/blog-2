<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">use trigger audit record which column modified, insert, delete.</h2>
	<h5 id="">2014-12-14 19:47:38&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402014111473644127/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>这个需求需要记录数据被插入的审计, 删除的审计, 更新的审计, 注意更新的审计包括哪些字段发生了变更.</div><div>不需要的审计, 注释对应的触发器代码即可.</div><div>触发器代码如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >create extension hstore;</font></div><font size="2"   ><br><wbr></font><div><div><font size="2"   >CREATE TABLE table_change_rec (</font></div><div><font size="2"   >&nbsp; id serial8 primary key,</font></div><div><font size="2"   >&nbsp; relid oid,</font></div><div><font size="2"   >&nbsp; table_schema name,</font></div><div><font size="2"   >&nbsp; table_name name,</font></div><div><font size="2"   >&nbsp; when_tg text,</font></div><div><font size="2"   >&nbsp; level text,</font></div><div><font size="2"   >&nbsp; op text,</font></div><div><font size="2"   >&nbsp; old_rec hstore,</font></div><div><font size="2"   >&nbsp; new_rec hstore,</font></div><div><font size="2"   >&nbsp; diff_old_rec text,</font></div><div><font size="2"   >&nbsp; diff_new_rec text,</font></div><div><font size="2"   >&nbsp; crt_time timestamp without time zone DEFAULT now(),</font></div><div><font size="2"   >&nbsp; username name,</font></div><div><font size="2"   >&nbsp; client_addr inet,</font></div><div><font size="2"   >&nbsp; client_port int</font></div><div><font size="2"   >);</font></div></div><p></p></pre></div><div><div><br></div><div>-- 创建通用的触发器函数</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE OR REPLACE FUNCTION dml_trace()</font></div><div><font size="2"   >RETURNS trigger</font></div><div><font size="2"   >LANGUAGE plpgsql</font></div><div><font size="2"   >AS $BODY$</font></div><div><font size="2"   >DECLARE</font></div><div><font size="2"   >&nbsp; v_new_rec hstore;</font></div><div><font size="2"   >&nbsp; v_old_rec hstore;</font></div><div><font size="2"   >&nbsp; v_diff_new_rec text;</font></div><div><font size="2"   >&nbsp; v_diff_old_rec text;</font></div><div><font size="2"   >&nbsp; v_username text := session_user;</font></div><div><font size="2"   >&nbsp; v_client_addr inet := inet_client_addr();</font></div><div><font size="2"   >&nbsp; v_client_port int := inet_client_port();</font></div><div><font size="2"   >BEGIN</font></div><div><font size="2"   >&nbsp; case TG_OP</font></div><div><font size="2"   >&nbsp; when 'DELETE' then&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; v_old_rec := hstore(OLD.*);</font></div><div><font size="2"   >&nbsp; &nbsp; insert into table_change_rec (relid, table_schema, table_name, when_tg, level, op, old_rec, username, client_addr, client_port)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; values (tg_relid, tg_table_schema, tg_table_name, tg_when, tg_level, tg_op, v_old_rec, v_username, v_client_addr, v_client_port);</font></div><div><font size="2"   >&nbsp; when 'INSERT' then&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; v_new_rec := hstore(NEW.*);</font></div><div><font size="2"   >&nbsp; &nbsp; insert into table_change_rec (relid, table_schema, table_name, when_tg, level, op, new_rec, username, client_addr, client_port)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; values (tg_relid, tg_table_schema, tg_table_name, tg_when, tg_level, tg_op, v_new_rec, v_username, v_client_addr, v_client_port);</font></div><div><font size="2"   >&nbsp; when 'UPDATE' then&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; v_old_rec := hstore(OLD.*);</font></div><div><font size="2"   >&nbsp; &nbsp; v_new_rec := hstore(NEW.*);</font></div><div><font size="2"   >&nbsp; &nbsp; select array_agg(o)::text,array_agg(n)::text into v_diff_old_rec,v_diff_new_rec from (select row_number() over() as rn,o from each(v_old_rec) as o) as o join</font></div><div><font size="2"   >&nbsp; &nbsp; (select row_number() over() as rn,n from each(v_new_rec) as n) as n on o.rn=n.rn and o&lt;&gt;n;</font></div><div><font size="2"   >&nbsp; &nbsp; insert into table_change_rec (relid, table_schema, table_name, when_tg, level, op, old_rec, new_rec, diff_old_rec, diff_new_rec, username, client_addr, client_port)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; values (tg_relid, tg_table_schema, tg_table_name, tg_when, tg_level, tg_op, v_old_rec, v_new_rec, v_diff_old_rec, v_diff_new_rec, v_username, v_client_addr, v_client_port);</font></div><div><font size="2"   >&nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; return null;</font></div><div><font size="2"   >&nbsp; end case;</font></div><div><font size="2"   >&nbsp; RETURN null;</font></div><div><font size="2"   >END;</font></div><div><font size="2"   >$BODY$ strict;</font></div><p></p></pre></div></div><div><br></div><div>测试 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# create table test (id int, c1 int, c2 text, c3 timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >postgres=# CREATE TRIGGER tg AFTER DELETE or INSERT or UPDATE ON test FOR EACH ROW EXECUTE PROCEDURE dml_trace();</font></div><div><font size="2"   >CREATE TRIGGER</font></div><div><font size="2"   >postgres=# truncate table_change_rec ;</font></div><div><font size="2"   >TRUNCATE TABLE</font></div><div><font size="2"   >postgres=# insert into test values (1,1,'digoal',now());</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >postgres=# insert into test values (2,2,'digoal',now());</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >postgres=# update test set id=null,c1=null,c2=null,c3=null where id=1;</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >postgres=# update test set c1=2,c3=now() where id=2;</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >postgres=# delete from test;</font></div><div><font size="2"   >DELETE 2</font></div><p></p></pre></div><div><br></div></div><div>查看审计</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select * from table_change_rec;</font></div><div><font size="2"   >-[ RECORD 1 ]+-------------------------------------------------------------------------</font></div><div><font size="2"   >id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 11</font></div><div><font size="2"   >relid &nbsp; &nbsp; &nbsp; &nbsp;| 16593</font></div><div><font size="2"   >table_schema | public</font></div><div><font size="2"   >table_name &nbsp; | test</font></div><div><font size="2"   >when_tg &nbsp; &nbsp; &nbsp;| AFTER</font></div><div><font size="2"   >level &nbsp; &nbsp; &nbsp; &nbsp;| ROW</font></div><div><font size="2"   >op &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | INSERT</font></div><div><font size="2"   >old_rec &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >new_rec &nbsp; &nbsp; &nbsp;| "c1"=&gt;"1", "c2"=&gt;"digoal", "c3"=&gt;"2014-12-15 03:43:12.135139", "id"=&gt;"1"</font></div><div><font size="2"   >diff_old_rec |&nbsp;</font></div><div><font size="2"   >diff_new_rec |&nbsp;</font></div><div><font size="2"   >crt_time &nbsp; &nbsp; | 2014-12-15 03:43:12.135139</font></div><div><font size="2"   >username &nbsp; &nbsp; | postgres</font></div><div><font size="2"   >client_addr &nbsp;|&nbsp;</font></div><div><font size="2"   >client_port &nbsp;|&nbsp;</font></div><div><font size="2"   >-[ RECORD 2 ]+-------------------------------------------------------------------------</font></div><div><font size="2"   >id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 12</font></div><div><font size="2"   >relid &nbsp; &nbsp; &nbsp; &nbsp;| 16593</font></div><div><font size="2"   >table_schema | public</font></div><div><font size="2"   >table_name &nbsp; | test</font></div><div><font size="2"   >when_tg &nbsp; &nbsp; &nbsp;| AFTER</font></div><div><font size="2"   >level &nbsp; &nbsp; &nbsp; &nbsp;| ROW</font></div><div><font size="2"   >op &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | INSERT</font></div><div><font size="2"   >old_rec &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >new_rec &nbsp; &nbsp; &nbsp;| "c1"=&gt;"2", "c2"=&gt;"digoal", "c3"=&gt;"2014-12-15 03:43:14.803063", "id"=&gt;"2"</font></div><div><font size="2"   >diff_old_rec |&nbsp;</font></div><div><font size="2"   >diff_new_rec |&nbsp;</font></div><div><font size="2"   >crt_time &nbsp; &nbsp; | 2014-12-15 03:43:14.803063</font></div><div><font size="2"   >username &nbsp; &nbsp; | postgres</font></div><div><font size="2"   >client_addr &nbsp;|&nbsp;</font></div><div><font size="2"   >client_port &nbsp;|&nbsp;</font></div><div><font size="2"   >diff的内容, 只有更新的字段被记录</font></div><div><font size="2"   >-[ RECORD 3 ]+-------------------------------------------------------------------------</font></div><div><font size="2"   >id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 13</font></div><div><font size="2"   >relid &nbsp; &nbsp; &nbsp; &nbsp;| 16593</font></div><div><font size="2"   >table_schema | public</font></div><div><font size="2"   >table_name &nbsp; | test</font></div><div><font size="2"   >when_tg &nbsp; &nbsp; &nbsp;| AFTER</font></div><div><font size="2"   >level &nbsp; &nbsp; &nbsp; &nbsp;| ROW</font></div><div><font size="2"   >op &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | UPDATE</font></div><div><font size="2"   >old_rec &nbsp; &nbsp; &nbsp;| "c1"=&gt;"1", "c2"=&gt;"digoal", "c3"=&gt;"2014-12-15 03:43:12.135139", "id"=&gt;"1"</font></div><div><font size="2"   >new_rec &nbsp; &nbsp; &nbsp;| "c1"=&gt;NULL, "c2"=&gt;NULL, "c3"=&gt;NULL, "id"=&gt;NULL</font></div><div><font size="2"   >diff_old_rec | {"(c1,1)","(c2,digoal)","(c3,\"2014-12-15 03:43:12.135139\")","(id,1)"}</font></div><div><font size="2"   >diff_new_rec | {"(c1,)","(c2,)","(c3,)","(id,)"}</font></div><div><font size="2"   >crt_time &nbsp; &nbsp; | 2014-12-15 03:43:18.832179</font></div><div><font size="2"   >username &nbsp; &nbsp; | postgres</font></div><div><font size="2"   >client_addr &nbsp;|&nbsp;</font></div><div><font size="2"   >client_port &nbsp;|&nbsp;</font></div><div><font size="2"   >diff的内容: 只有更新的字段被记录, 未更新的字段不会被记录</font></div><div><font size="2"   >-[ RECORD 4 ]+-------------------------------------------------------------------------</font></div><div><font size="2"   >id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 14</font></div><div><font size="2"   >relid &nbsp; &nbsp; &nbsp; &nbsp;| 16593</font></div><div><font size="2"   >table_schema | public</font></div><div><font size="2"   >table_name &nbsp; | test</font></div><div><font size="2"   >when_tg &nbsp; &nbsp; &nbsp;| AFTER</font></div><div><font size="2"   >level &nbsp; &nbsp; &nbsp; &nbsp;| ROW</font></div><div><font size="2"   >op &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | UPDATE</font></div><div><font size="2"   >old_rec &nbsp; &nbsp; &nbsp;| "c1"=&gt;"2", "c2"=&gt;"digoal", "c3"=&gt;"2014-12-15 03:43:14.803063", "id"=&gt;"2"</font></div><div><font size="2"   >new_rec &nbsp; &nbsp; &nbsp;| "c1"=&gt;"2", "c2"=&gt;"digoal", "c3"=&gt;"2014-12-15 03:43:35.977674", "id"=&gt;"2"</font></div><div><font size="2"   >diff_old_rec | {"(c3,\"2014-12-15 03:43:14.803063\")"}</font></div><div><font size="2"   >diff_new_rec | {"(c3,\"2014-12-15 03:43:35.977674\")"}</font></div><div><font size="2"   >crt_time &nbsp; &nbsp; | 2014-12-15 03:43:35.977674</font></div><div><font size="2"   >username &nbsp; &nbsp; | postgres</font></div><div><font size="2"   >client_addr &nbsp;|&nbsp;</font></div><div><font size="2"   >client_port &nbsp;|&nbsp;</font></div><div><font size="2"   >-[ RECORD 5 ]+-------------------------------------------------------------------------</font></div><div><font size="2"   >id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 15</font></div><div><font size="2"   >relid &nbsp; &nbsp; &nbsp; &nbsp;| 16593</font></div><div><font size="2"   >table_schema | public</font></div><div><font size="2"   >table_name &nbsp; | test</font></div><div><font size="2"   >when_tg &nbsp; &nbsp; &nbsp;| AFTER</font></div><div><font size="2"   >level &nbsp; &nbsp; &nbsp; &nbsp;| ROW</font></div><div><font size="2"   >op &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | DELETE</font></div><div><font size="2"   >old_rec &nbsp; &nbsp; &nbsp;| "c1"=&gt;NULL, "c2"=&gt;NULL, "c3"=&gt;NULL, "id"=&gt;NULL</font></div><div><font size="2"   >new_rec &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >diff_old_rec |&nbsp;</font></div><div><font size="2"   >diff_new_rec |&nbsp;</font></div><div><font size="2"   >crt_time &nbsp; &nbsp; | 2014-12-15 03:43:39.352938</font></div><div><font size="2"   >username &nbsp; &nbsp; | postgres</font></div><div><font size="2"   >client_addr &nbsp;|&nbsp;</font></div><div><font size="2"   >client_port &nbsp;|&nbsp;</font></div><div><font size="2"   >-[ RECORD 6 ]+-------------------------------------------------------------------------</font></div><div><font size="2"   >id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 16</font></div><div><font size="2"   >relid &nbsp; &nbsp; &nbsp; &nbsp;| 16593</font></div><div><font size="2"   >table_schema | public</font></div><div><font size="2"   >table_name &nbsp; | test</font></div><div><font size="2"   >when_tg &nbsp; &nbsp; &nbsp;| AFTER</font></div><div><font size="2"   >level &nbsp; &nbsp; &nbsp; &nbsp;| ROW</font></div><div><font size="2"   >op &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | DELETE</font></div><div><font size="2"   >old_rec &nbsp; &nbsp; &nbsp;| "c1"=&gt;"2", "c2"=&gt;"digoal", "c3"=&gt;"2014-12-15 03:43:35.977674", "id"=&gt;"2"</font></div><div><font size="2"   >new_rec &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >diff_old_rec |&nbsp;</font></div><div><font size="2"   >diff_new_rec |&nbsp;</font></div><div><font size="2"   >crt_time &nbsp; &nbsp; | 2014-12-15 03:43:39.352938</font></div><div><font size="2"   >username &nbsp; &nbsp; | postgres</font></div><div><font size="2"   >client_addr &nbsp;|&nbsp;</font></div><div><font size="2"   >client_port &nbsp;|&nbsp;</font></div><p></p></pre></div><div><br></div><div>[参考]</div><div>1.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201252575529358/"   >http://blog.163.com/digoal@126/blog/static/163877040201252575529358/</a></div><div>2.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/plpgsql-trigger.html"   >http://www.postgresql.org/docs/9.3/static/plpgsql-trigger.html</a></div><div>3.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/hstore.html"   >http://www.postgresql.org/docs/9.3/static/hstore.html</a></div><div>4.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014721981288/"   >http://blog.163.com/digoal@126/blog/static/1638770402014721981288/</a></div><div>5.&nbsp;<a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020121118112533410/"   >http://blog.163.com/digoal@126/blog/static/16387704020121118112533410/</a></div><div>6.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/sql-createaggregate.html"   >http://www.postgresql.org/docs/9.2/static/sql-createaggregate.html</a></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="use trigger audit record which column modified, insert, delete. - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>