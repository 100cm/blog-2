<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">ceph - add osd</h2>
	<h5 id="">2014-12-11 9:50:48&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201411104393905/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>&nbsp; &nbsp; 本文主要讲一下给一个已经存在的ceph存储集群添加osd 节点.</div><wbr><div>&nbsp; &nbsp; OSD节点存储用户的实际数据, 分散为对象存储在placement group中, placement group 可以理解为osd中的一些对象组.</div><div>&nbsp; &nbsp; 一般来说我们会对数据存储2份或以上, 那么问题来了.</div><div>&nbsp; &nbsp; 当OSD节点存储快满的时候, 如果一个OSD节点挂了, 会怎么样呢?</div><div>&nbsp; &nbsp; 因为数据要存储多份, 所以OSD挂了之后, 挂掉的OSD节点上的对象相当于少了一份, Ceph会从健康的OSD节点找到对应的对象, 复制到其他OSD节点, 使数据重新恢复要求的拷贝份数.</div><div>&nbsp; &nbsp; 如果OSD存储快满了, 就可能导致拷贝失败.</div><div>&nbsp; &nbsp; 因此我们需要通过参数来控制 .</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >BACKFILLING</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >When you add or remove Ceph OSD Daemons to a cluster, the CRUSH algorithm will want to rebalance the cluster by moving placement groups to or from Ceph OSD Daemons to restore the balance. The process of migrating placement groups and the objects they contain can reduce the cluster’s operational performance considerably. To maintain operational performance, Ceph performs this migration with ‘backfilling’, which allows Ceph to set backfill operations to a lower priority than requests to read or write data.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >osd max backfills</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Description:<span>	</span>The maximum number of backfills allowed to or from a single OSD.</font></div><div><font size="2"   >Type:<span>	</span>64-bit Unsigned Integer</font></div><div><font size="2"   >Default:<span>	</span>10</font></div><div><font size="2"   >osd backfill scan min</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Description:<span>	</span>The minimum number of objects per backfill scan.</font></div><div><font size="2"   >Type:<span>	</span>32-bit Integer</font></div><div><font size="2"   >Default:<span>	</span>64</font></div><div><font size="2"   >osd backfill scan max</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Description:<span>	</span>The maximum number of objects per backfill scan.</font></div><div><font size="2"   >Type:<span>	</span>32-bit Integer</font></div><div><font size="2"   >Default:<span>	</span>512</font></div><div><font size="2"   >osd backfill full ratio</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Description:<span>	</span>Refuse to accept backfill requests when the Ceph OSD Daemon’s full ratio is above this value.</font></div><div><font size="2"   >Type:<span>	</span>Float</font></div><div><font size="2"   >Default:<span>	</span>0.85</font></div><div><font size="2"   >osd backfill retry interval</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Description:<span>	</span>The number of seconds to wait before retrying backfill requests.</font></div><div><font size="2"   >Type:<span>	</span>Double</font></div><div><font size="2"   >Default:<span>	</span>10.0</font></div><p></p></pre></div><div><br></div><div>接下来进入正题, 当ceph存储使用率遇超标, 集群需要扩容时, 如何添加OSD节点呢?</div><div>首选要对操作系统内核, 文件系统, 磁盘参数做一定的限制.</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201411132433623/"   >http://blog.163.com/digoal@126/blog/static/163877040201411132433623/</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201411711835765/"   >http://blog.163.com/digoal@126/blog/static/163877040201411711835765/</a></div><div>1. 系统建议使用CentOS7,&nbsp;</div><div>2. 文件系统建议使用xfs,&nbsp;</div><div>3. 关闭硬盘的写缓存(仅限于老内核<span style="color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; line-height: 28px;"   >&lt;2.6.33需要这么做)</span></div><div><span style="color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; line-height: 28px;"   >4. 建议使用OMAP存储文件系统XATTR, 集群配置文件中加入</span></div><div><span style="color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; line-height: 28px;"   >filestore xattr use omap = true</span></div><div><span style="color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; line-height: 28px;"   ><br></span></div><div><span style="color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; line-height: 28px;"   >5. 建议每个osd daemon对应不同的物理块设备.</span></div><div><span style="color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; line-height: 28px;"   >6. 建议journal使用SSD. (文件系统或直接使用块设备)</span></div><div><pre class="prettyprint"   ><p></p><div><font color="#333333"   face="Hiragino Sans GB W3, Hiragino Sans GB, Arial, Helvetica, simsun, u5b8bu4f53"   size="2"   >osd journal</font></div><div><font color="#333333"   face="Hiragino Sans GB W3, Hiragino Sans GB, Arial, Helvetica, simsun, u5b8bu4f53"   size="2"   >Description:<span>	</span>The path to the OSD’s journal. This may be a path to a file or a block device (such as a partition of an SSD). If it is a file, you must create the directory to contain it. We recommend using a drive separate from the osd data drive.</font></div><div><font color="#333333"   face="Hiragino Sans GB W3, Hiragino Sans GB, Arial, Helvetica, simsun, u5b8bu4f53"   size="2"   >Type:<span>	</span>String</font></div><div><font color="#333333"   face="Hiragino Sans GB W3, Hiragino Sans GB, Arial, Helvetica, simsun, u5b8bu4f53"   size="2"   >Default:<span>	</span>/var/lib/ceph/osd/$cluster-$id/journal</font></div><div><font color="#333333"   face="Hiragino Sans GB W3, Hiragino Sans GB, Arial, Helvetica, simsun, u5b8bu4f53"   size="2"   ><br></font></div><div><font color="#333333"   face="Hiragino Sans GB W3, Hiragino Sans GB, Arial, Helvetica, simsun, u5b8bu4f53"   size="2"   >osd journal size</font></div><div><font color="#333333"   face="Hiragino Sans GB W3, Hiragino Sans GB, Arial, Helvetica, simsun, u5b8bu4f53"   size="2"   >Description:<span>	</span>The size of the journal in megabytes. If this is 0, and the journal is a block device, the entire block device is used. Since v0.54, this is ignored if the journal is a block device, and the entire block device is used.</font></div><div><font color="#333333"   face="Hiragino Sans GB W3, Hiragino Sans GB, Arial, Helvetica, simsun, u5b8bu4f53"   size="2"   >Type:<span>	</span>32-bit Integer</font></div><div><font color="#333333"   face="Hiragino Sans GB W3, Hiragino Sans GB, Arial, Helvetica, simsun, u5b8bu4f53"   size="2"   >Default:<span>	</span>5120</font></div><div><font color="#333333"   face="Hiragino Sans GB W3, Hiragino Sans GB, Arial, Helvetica, simsun, u5b8bu4f53"   size="2"   >Recommended:<span>	</span>Begin with 1GB. Should be at least twice the product of the expected speed multiplied by filestore max sync interval.</font></div><p></p></pre></div><div><font color="#333333"   face="Hiragino Sans GB W3, Hiragino Sans GB, Arial, Helvetica, simsun, u5b8bu4f53"   >7. journal大小建议, 1GB起步, 每TB OSD数据分配1GB journal.</font></div><div><br></div><div>操作系统配置建议 :&nbsp;</div><div>1. /etc/hosts</div><div>&nbsp; &nbsp; 包含所有osd,mon节点的hostname -s条目</div><div><br></div><div>2. 内核参数, limit</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># /etc/sysctl.conf</font></div><div><font size="2"   >kernel.pid_max=4194303</font></div><div><font size="2"   >kernel.shmmni = 4096</font></div><div><font size="2"   >kernel.sem = 50100 64128000 50100 1280</font></div><div><font size="2"   >fs.file-max = 7672460</font></div><div><font size="2"   >net.ipv4.ip_local_port_range = 9000 65000</font></div><div><font size="2"   >net.core.rmem_default = 1048576</font></div><div><font size="2"   >net.core.rmem_max = 4194304</font></div><div><font size="2"   >net.core.wmem_default = 262144</font></div><div><font size="2"   >net.core.wmem_max = 1048576</font></div><div><font size="2"   >net.ipv4.tcp_tw_recycle = 1</font></div><div><font size="2"   >net.ipv4.tcp_max_syn_backlog = 4096</font></div><div><font size="2"   >net.core.netdev_max_backlog = 10000</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># /etc/security/limits.conf</font></div><div><font size="2"   >* soft &nbsp; &nbsp;nofile &nbsp;131072</font></div><div><font size="2"   >* hard &nbsp; &nbsp;nofile &nbsp;131072</font></div><div><font size="2"   >* soft &nbsp; &nbsp;nproc &nbsp; 131072</font></div><div><font size="2"   >* hard &nbsp; &nbsp;nproc &nbsp; 131072</font></div><div><font size="2"   >* soft &nbsp; &nbsp;core &nbsp; &nbsp;unlimited</font></div><div><font size="2"   >* hard &nbsp; &nbsp;core &nbsp; &nbsp;unlimited</font></div><div><font size="2"   >* soft &nbsp; &nbsp;memlock 50000000</font></div><div><font size="2"   >* hard &nbsp; &nbsp;memlock 50000000</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># /etc/security/limits.d/90-nproc.conf&nbsp;</font></div><div><font size="2"   >* soft &nbsp; &nbsp;nproc &nbsp; 131072</font></div><div><font size="2"   >* hard &nbsp; &nbsp;nproc &nbsp; 131072</font></div><p></p></pre></div><div><br></div><div>3. 建议关闭selinux</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># setenforce 0</font></div><div><font size="2"   ># vi /etc/selinux/config</font></div><div><font size="2"   >SELINUX=disabled</font></div><p></p></pre></div><div><br></div><div>安装软件</div><div>1. 添加ceph和epel的源</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201410269169450/"   >http://blog.163.com/digoal@126/blog/static/163877040201410269169450/</a></div><div>2. 安装软件</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >yum install -y yum-plugin-priorities</font></div><div><font size="2"   >yum install -y snappy leveldb gdisk python-argparse gperftools-libs</font></div><div><font size="2"   >yum install -y ceph</font></div><p></p></pre></div><div><br></div><div>添加 OSD</div><div>参考</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201411141846487/"   >http://blog.163.com/digoal@126/blog/static/163877040201411141846487/</a></div><div>1. 为每个osd daemon生成osd uuid</div><div>2. 从mon节点<span style="line-height: 28px;"   >获取KEY, 拷贝到osd节点的/etc/ceph目录下.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@mon2 ~]# cd /etc/ceph/</font></div><div><font size="2"   >[root@mon2 ceph]# ll</font></div><div><font size="2"   >total 12</font></div><div><font size="2"   >-rw------- 1 root root &nbsp;63 Dec &nbsp;9 15:47 ceph.client.admin.keyring</font></div><div><font size="2"   >-rw-r--r-- 1 root root 529 Dec &nbsp;9 15:46 ceph.conf</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >3.&nbsp;</span><span style="line-height: 28px;"   >从mon节点</span><span style="line-height: 28px;"   >获取</span><span style="line-height: 28px;"   >集群配置文件 (配置文件中务必包含mon节点的信息)</span></div><div><span style="line-height: 28px;"   >如 &nbsp;:&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >mon initial members = mon1, mon2, mon3</font></div><div><font size="2"   >mon host = 172.17.0.2, 172.17.0.3, 172.17.0.4</font></div><p></p></pre></div><div>4. 创建OSD daemon</div><div>例如 :&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >ceph osd create 854777b2-c188-4509-9df4-02f57bd17e12</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   ># 该命令返回osd id.</span></div><div><span style="line-height: 28px;"   ><br></span></div><div>5. 为每个OSD daemon创建OSD数据目录和journal所在目录. (建议分开物理块设备存储)</div><div>数据目录软链接指向 &nbsp;/var/lib/ceph/osd/{clustername}-{id}</div><div>journal软链接指向 &nbsp;<span style="line-height: 28px;"   >/var/lib/ceph/osd/{clustername}-{id}/journal</span></div><div><span style="line-height: 28px;"   >如不做以上软链接, 不能使用/etc/init.d/ceph来管理osd服务, 那么就需要手工启动ceph-osd了.</span></div><div>6.&nbsp;初始化osd 数据目录</div><pre class="prettyprint"   ><p></p><div><font size="2"   >ceph-osd -i {osd-num} --mkfs --mkkey --osd-uuid [{uuid}] --cluster {cluster_name}</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >例如</span></div><div><pre class="prettyprint"   ><p><font size="2"   >ceph-osd -i 1 --mkfs --mkjournal --mkkey --osd-uuid 854777b2-c188-4509-9df4-02f57bd17e12 --cluster ceph --osd-data=/data01/ceph/osd/ceph-1 --osd-journal=/data01/ceph/osd/ceph-1/journal</font></p></pre></div><div>7.&nbsp;<span style="color: rgb(51, 51, 51); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, u5b8bu4f53; line-height: 28px;"   >注册OSD认证key</span></div><div><p></p><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ceph auth add osd.{osd-num} osd 'allow *' mon 'allow profile osd' -i /var/lib/ceph/osd/ceph-{osd-num}/keyring</font></div><div><font size="2"   >例如</font></div><div><font size="2"   ># ceph auth add osd.1 osd 'allow *' mon 'allow profile osd' -i /data01/ceph/osd/ceph-1/keyring</font></div><div><font size="2"   >added key for osd.1</font></div><p></p></pre></div><p></p></div><div><font color="#333333"   face="Hiragino Sans GB W3, Hiragino Sans GB, Arial, Helvetica, simsun, u5b8bu4f53"   ><div>8.&nbsp;添加bucket, 例如将新增的Ceph Node添加到CRUSH map(一个主机只需要添加一次).</div></font><pre class="prettyprint"   ><p></p><div><font size="2"   >ceph osd crush add-bucket {hostname} host</font></div><div></div><p></p></pre><font color="#333333"   face="Hiragino Sans GB W3, Hiragino Sans GB, Arial, Helvetica, simsun, u5b8bu4f53"   ><div><span style="line-height: 28px;"   >例如 :&nbsp;</span></div></font><pre class="prettyprint"   ><p></p><div><font size="2"   >ceph osd crush add-bucket osd1 host</font></div><div></div><p></p></pre><font color="#333333"   face="Hiragino Sans GB W3, Hiragino Sans GB, Arial, Helvetica, simsun, u5b8bu4f53"   ><div><span style="line-height: 28px;"   >9.&nbsp;</span><span style="line-height: 28px;"   >添加ceph node到default root.</span></div></font><pre class="prettyprint"   ><p></p><div><font size="2"   >ceph osd crush move osd1 root=default</font></div><div></div><p></p></pre><font color="#333333"   face="Hiragino Sans GB W3, Hiragino Sans GB, Arial, Helvetica, simsun, u5b8bu4f53"   ><div><span style="line-height: 28px;"   >10.&nbsp;添加osd daemon到对应主机的bucket. 同样是修改crush map. (如果一台主机有多个osd daemon, 每个osd daemon都要添加到对应的bucket)</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ceph osd crush add osd.{osd_num}|{id-or-name} {weight} [{bucket-type}={bucket-name} ...]</font></div><div><font size="2"   >例如</font></div><div><font size="2"   >ceph osd crush add osd.1 1.0 host=osd1</font></div><p></p></pre></div><div>11. 如果要使用sysv来管理服务, 务必在/var/lib/ceph/osd/{clustername}-{osd id}目录下添加两个空文件</div><div>例如</div></font><pre class="prettyprint"   ><p></p><div><font size="2"   >touch /var/lib/ceph/osd/ceph-1/sysvinit</font></div><div></div><p></p></pre><font color="#333333"   face="Hiragino Sans GB W3, Hiragino Sans GB, Arial, Helvetica, simsun, u5b8bu4f53"   ><div><span style="line-height: 28px;"   >12. 启动osd daemon</span></div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >使用sysv启动</font></div><div><font size="2"   >service ceph start osd.1</font></div><div><font size="2"   >或手工启动&nbsp;</font></div><div><font size="2"   >/usr/bin/ceph-osd -i 1 --pid-file /var/run/ceph/osd.1.pid -c /etc/ceph/ceph.conf --cluster ceph&nbsp;--osd-data=<span style="color: rgb(0, 0, 0); font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, 宋体; line-height: 28px;"   >/data01/ceph/osd/ceph-1</span>&nbsp;--osd-journal=<span style="line-height: 28px; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, 宋体;"   >/data01/ceph/osd/ceph-1/journal</span></font></div><p></p></pre></div></font></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://docs.ceph.com/docs/master/rados/operations/add-or-rm-osds/"   >http://docs.ceph.com/docs/master/rados/operations/add-or-rm-osds/</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201411141846487/"   >http://blog.163.com/digoal@126/blog/static/163877040201411141846487/</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201411132433623/"   >http://blog.163.com/digoal@126/blog/static/163877040201411132433623/</a></div><div>4.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201411711835765/"   >http://blog.163.com/digoal@126/blog/static/163877040201411711835765/</a></div><div>5.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020141119337851/"   >http://blog.163.com/digoal@126/blog/static/16387704020141119337851/</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="ceph - add osd - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>