<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">about ceph monitor's consistency</h2>
	<h5 id="">2014-12-10 14:39:10&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201411102334825/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>&nbsp; &nbsp; ceph 的mon节点维护了整个ceph 存储集群的map状态.</div><div>&nbsp; &nbsp; 因为mon节点是多个的, 所以要求所有mon节点的map状态一致, mon使用paxos算法(分布式一致性算法)来修改map的状态, 确保所有mon节点的map数据一致.</div><div>&nbsp; &nbsp; 因此mon节点并不是通过集群配置文件如ceph.conf来保持map一致的, 而是map文件.</div><div>&nbsp; &nbsp; 每次map文件变更前, 需要多数monitor节点同意, 确保多数或所有(quorum)节点的map文件一致, 并且map文件是增量更新的, 每次更新产生一个新的version, 所以当mon节点离线再加入时, 需要同步增量部分的信息.&nbsp;</div><div>&nbsp; &nbsp; monitor相互之间是如何发现的呢?&nbsp;</div><div>&nbsp; &nbsp; 同样是通过map文件, 而不是静态的集群配置文件如ceph.conf.</div><div>&nbsp; &nbsp; 我们来dump一个map文件的信息看看 ?&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@mon5 ~]# ceph mon getmap -o /tmp/monmap</font></div><div><font size="2"   >got monmap epoch 8</font></div><p></p></pre></div><div>打印map文件内容</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@mon5 ~]# monmaptool --print /tmp/monmap&nbsp;</font></div><div><font size="2"   >monmaptool: monmap file /tmp/monmap</font></div><div><font size="2"   >epoch 8</font></div><div><font size="2"   >fsid f649b128-963c-4802-ae17-5a76f36c4c76</font></div><div><font size="2"   >last_changed 2014-12-10 11:52:43.961159</font></div><div><font size="2"   >created 2014-12-09 15:24:33.339570</font></div><div><font size="2"   >0: 172.17.0.2:6789/0 mon.mon1</font></div><div><font size="2"   >1: 172.17.0.3:6789/0 mon.mon2</font></div><div><font size="2"   >2: 172.17.0.4:6789/0 mon.mon3</font></div><div><font size="2"   >3: 172.17.0.9:6789/0 mon.mon4</font></div><div><font size="2"   >4: 172.17.0.10:6789/0 mon.mon5</font></div><p></p></pre></div><div>所有mon节点的信息应该是一致的.</div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://docs.ceph.com/docs/master/rados/operations/add-or-rm-mons/"   >http://docs.ceph.com/docs/master/rados/operations/add-or-rm-mons/</a></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Monitors are critical components of a Ceph cluster, and they need to maintain a quorum for the whole system to work properly. To establish a quorum, the monitors need to discover each other. Ceph has strict requirements for discovering monitors.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Ceph clients and other Ceph daemons use ceph.conf to discover monitors. However, monitors discover each other using the monitor map, not ceph.conf. For example, if you refer to Adding a Monitor (Manual) you will see that you need to obtain the current monmap for the cluster when creating a new monitor, as it is one of the required arguments of ceph-mon -i {mon-id} --mkfs. The following sections explain the consistency requirements for Ceph monitors, and a few safe ways to change a monitor’s IP address.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CONSISTENCY REQUIREMENTS</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >A monitor always refers to the local copy of the monmap when discovering other monitors in the cluster. Using the monmap instead of ceph.conf avoids errors that could break the cluster (e.g., typos in ceph.conf when specifying a monitor address or port). Since monitors use monmaps for discovery and they share monmaps with clients and other Ceph daemons, the monmap provides monitors with a strict guarantee that their consensus is valid.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Strict consistency also applies to updates to the monmap. As with any other updates on the monitor, changes to the monmap always run through a distributed consensus algorithm called Paxos. The monitors must agree on each update to the monmap, such as adding or removing a monitor, to ensure that each monitor in the quorum has the same version of the monmap. Updates to the monmap are incremental so that monitors have the latest agreed upon version, and a set of previous versions, allowing a monitor that has an older version of the monmap to catch up with the current state of the cluster.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >If monitors discovered each other through the Ceph configuration file instead of through the monmap, it would introduce additional risks because the Ceph configuration files aren’t updated and distributed automatically. Monitors might inadvertently use an older ceph.conf file, fail to recognize a monitor, fall out of a quorum, or develop a situation where Paxos isn’t able to determine the current state of the system accurately. Consequently, making changes to an existing monitor’s IP address must be done with great care.</font></div><p></p></pre></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="about ceph monitors consistency - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>