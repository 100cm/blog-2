<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">ceph performance tune , mount the osd mon data directory to diff block dev</h2>
	<h5 id="">2014-12-03 11:22:36&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201411311945949/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>在centos或rhel中, ceph服务可以通过ceph sysv脚本来管理, 例如用来管理mds, osd, mon节点.</div><div>如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   ># less /etc/init.d/ceph</font></div><div><font size="2"   >usage_exit() {</font></div><div><font size="2"   >&nbsp; &nbsp; echo "usage: $0 [options] {start|stop|restart|condrestart} [mon|osd|mds]..."</font></div><div><font size="2"   >&nbsp; &nbsp; printf "\t-c ceph.conf\n"</font></div><div><font size="2"   >&nbsp; &nbsp; printf "\t--cluster [cluster name]\tdefine the cluster name\n"</font></div><div><font size="2"   >&nbsp; &nbsp; printf "\t--valgrind\trun via valgrind\n"</font></div><div><font size="2"   >&nbsp; &nbsp; printf "\t--hostname [hostname]\toverride hostname lookup\n"</font></div><div><font size="2"   >&nbsp; &nbsp; exit</font></div><div><font size="2"   >}</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >for name in $what; do</font></div><div><font size="2"   >&nbsp; &nbsp; type=`echo $name | cut -c 1-3` &nbsp; # e.g. 'mon', if $item is 'mon1'</font></div><div><font size="2"   >&nbsp; &nbsp; id=`echo $name | cut -c 4- | sed 's/^\\.//'`</font></div><div><font size="2"   >&nbsp; &nbsp; num=$id</font></div><div><font size="2"   >&nbsp; &nbsp; name="$type.$id"</font></div></div><p></p></pre></div></div><div><br></div><div>例如我们要管理osd.0 daemon, 那么可以使用类似如下命令 :&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >service ceph start osd.0</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >管理mon1例如 :&nbsp;</span></div><div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >sudo /etc/init.d/ceph start mon.mon1</font></div></div><div></div><p></p></pre></div></div><div>mon 节点和 osd节点都涉及数据目录, 特别是osd, 数据目录的读写可能会比较频繁.</div><div>默认的话, 目录在哪里呢, 从/etc/init.d/ceph脚本可以看到, 都在/var/lib/ceph下面, 例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >/var/lib/ceph/osd/$cluster-$id</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >/var/lib/ceph/mon/ceph-$id</font></span></div><p></p></pre></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >OSD :&nbsp;</span></div><div><div><pre class="prettyprint"   ><div><font size="2"   >[root@osd1 ~]# cd /var/lib/ceph/osd/</font></div><div><font size="2"   >[root@osd1 osd]# ll</font></div><div><font size="2"   >total 4</font></div><div><font size="2"   >drwxr-xr-x 3 root root 4096 Dec &nbsp;2 09:00 ceph-0</font></div><div><font size="2"   >[root@osd1 osd]# cd ceph-0/</font></div><div><font size="2"   >[root@osd1 ceph-0]# ll</font></div><div><font size="2"   >total 1048616</font></div><div><font size="2"   >-rw-r--r-- &nbsp;1 root root &nbsp; &nbsp; &nbsp; &nbsp; 37 Dec &nbsp;2 08:52 ceph_fsid</font></div><div><font size="2"   >drwxr-xr-x 60 root root &nbsp; &nbsp; &nbsp; 4096 Dec &nbsp;2 09:45 current</font></div><div><font size="2"   >-rw-r--r-- &nbsp;1 root root &nbsp; &nbsp; &nbsp; &nbsp; 37 Dec &nbsp;2 08:52 fsid</font></div><div><font size="2"   >-rw-r--r-- &nbsp;1 root root 1073741824 Dec &nbsp;3 09:45 journal</font></div><div><font size="2"   >-rw------- &nbsp;1 root root &nbsp; &nbsp; &nbsp; &nbsp; 56 Dec &nbsp;2 08:52 keyring</font></div><div><font size="2"   >-rw-r--r-- &nbsp;1 root root &nbsp; &nbsp; &nbsp; &nbsp; 21 Dec &nbsp;2 08:52 magic</font></div><div><font size="2"   >-rw-r--r-- &nbsp;1 root root &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;6 Dec &nbsp;2 08:52 ready</font></div><div><font size="2"   >-rw-r--r-- &nbsp;1 root root &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 Dec &nbsp;2 08:52 store_version</font></div><div><font size="2"   >-rw-r--r-- &nbsp;1 root root &nbsp; &nbsp; &nbsp; &nbsp; 53 Dec &nbsp;2 08:52 superblock</font></div><div><font size="2"   >-rw-r--r-- &nbsp;1 root root &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 Dec &nbsp;2 08:59 sysvinit</font></div><div><font size="2"   >-rw-r--r-- &nbsp;1 root root &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 Dec &nbsp;2 08:52 whoami</font></div><p></p></pre></div></div><div><br></div><div>MON :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@mon1 ~]# cd /var/lib/ceph/mon/</font></div><div><font size="2"   >[root@mon1 mon]# cd ceph-mon1</font></div><div><div><font size="2"   >[root@mon1 ceph-mon1]# ll</font></div><div><font size="2"   >total 8</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp; &nbsp;0 Dec &nbsp;1 15:52 done</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp; 77 Dec &nbsp;1 15:52 keyring</font></div><div><font size="2"   >drwxr-xr-x 2 root root 4096 Dec &nbsp;1 17:19 store.db</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp; &nbsp;0 Dec &nbsp;1 15:52 sysvinit</font></div></div><p></p></pre></div><div><br></div><div>为了获得更好的性能, 我们一般建议.</div><div>OSD的journal使用SSD.</div><div>OSD的数据目录使用普通机械盘, 同时和操作系统使用的机械盘分开.</div><div>mon的数据目录至少和操作系统使用的盘分开.</div><div><br></div><div>修改举例如下 :&nbsp;</div><div>MON</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >停止服务</font></div><div><div><font size="2"   >[root@mon1 ~]# service ceph stop mon.mon1</font></div><div><font size="2"   >=== mon.mon1 ===&nbsp;</font></div><div><font size="2"   >Stopping Ceph mon.mon1 on mon1...kill 18469...done</font></div></div><div><font size="2"   >将数据目录移动到其他磁盘分区</font></div><div><div><font size="2"   >[root@mon1 ~]# mv /var/lib/ceph/mon/ceph-mon1 /data01/</font></div><div><font size="2"   >[root@mon1 ~]# ln -s /data01/ceph-mon1 /var/lib/ceph/mon/</font></div></div><div><font size="2"   >重启服务</font></div><div><div><font size="2"   >[root@mon1 ~]# service ceph start mon.mon1</font></div><div><font size="2"   >=== mon.mon1 ===&nbsp;</font></div><div><font size="2"   >Starting Ceph mon.mon1 on mon1...</font></div><div><font size="2"   >Starting ceph-create-keys on mon1...</font></div></div><div><font size="2"   >检查</font></div><div><div><font size="2"   >[root@mon1 ~]# ceph -s</font></div><div><font size="2"   >&nbsp; &nbsp; cluster f649b128-963c-4802-ae17-5a76f36c4c76</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;health HEALTH_OK</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;monmap e1: 3 mons at {mon1=172.17.0.2:6789/0,mon2=172.17.0.3:6789/0,mon3=172.17.0.4:6789/0}, election epoch 16, quorum 0,1,2 mon1,mon2,mon3</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;osdmap e32: 4 osds: 4 up, 4 in</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; pgmap v202: 128 pgs, 1 pools, 0 bytes data, 0 objects</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 6435 MB used, 31257 MB / 39805 MB avail</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;128 active+clean</font></div></div><p></p></pre></div><div><br></div><div>OSD</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >停止服务</font></div><div><div><font size="2"   >[root@osd1 ~]# service ceph stop osd.0</font></div><div><font size="2"   >=== osd.0 ===&nbsp;</font></div><div><font size="2"   >Stopping Ceph osd.0 on osd1...kill 1776...kill 1776...done</font></div></div><div><font size="2"   >移动数据目录</font></div><div><div><font size="2"   >[root@osd1 ~]# cd /var/lib/ceph/osd</font></div><div><font size="2"   >[root@osd1 osd]# ll</font></div><div><font size="2"   >total 4</font></div><div><font size="2"   >drwxr-xr-x 3 root root 4096 Dec &nbsp;2 09:00 ceph-0</font></div><div><font size="2"   >[root@osd1 osd]# mv ceph-0 /data01/</font></div></div><div><font size="2"   >[root@osd1 osd]# ln -s /data01/ceph-0 /var/lib/ceph/osd/</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >移动JOURNAL</font></div><div><div><font size="2"   >[root@osd1 ceph-0]# cd /var/lib/ceph/osd/ceph-0/</font></div><div><font size="2"   >[root@osd1 ceph-0]# ll</font></div><div><font size="2"   >total 1048612</font></div><div><font size="2"   >-rw-r--r-- &nbsp;1 root root &nbsp; &nbsp; &nbsp; &nbsp; 37 Dec &nbsp;2 08:52 ceph_fsid</font></div><div><font size="2"   >drwxr-xr-x 60 root root &nbsp; &nbsp; &nbsp; 4096 Dec &nbsp;2 09:45 current</font></div><div><font size="2"   >-rw-r--r-- &nbsp;1 root root &nbsp; &nbsp; &nbsp; &nbsp; 37 Dec &nbsp;2 08:52 fsid</font></div><div><font size="2"   >-rw-r--r-- &nbsp;1 root root 1073741824 Dec &nbsp;3 09:45 journal</font></div><div><font size="2"   >-rw------- &nbsp;1 root root &nbsp; &nbsp; &nbsp; &nbsp; 56 Dec &nbsp;2 08:52 keyring</font></div><div><font size="2"   >-rw-r--r-- &nbsp;1 root root &nbsp; &nbsp; &nbsp; &nbsp; 21 Dec &nbsp;2 08:52 magic</font></div><div><font size="2"   >-rw-r--r-- &nbsp;1 root root &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;6 Dec &nbsp;2 08:52 ready</font></div><div><font size="2"   >-rw-r--r-- &nbsp;1 root root &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4 Dec &nbsp;2 08:52 store_version</font></div><div><font size="2"   >-rw-r--r-- &nbsp;1 root root &nbsp; &nbsp; &nbsp; &nbsp; 53 Dec &nbsp;2 08:52 superblock</font></div><div><font size="2"   >-rw-r--r-- &nbsp;1 root root &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 Dec &nbsp;2 08:59 sysvinit</font></div><div><font size="2"   >-rw-r--r-- &nbsp;1 root root &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;2 Dec &nbsp;2 08:52 whoami</font></div><div><font size="2"   >[root@osd1 ceph-0]# mv journal /data02/</font></div><div><font size="2"   >[root@osd1 ceph-0]# ln -s /data02/journal ./</font></div><div><font size="2"   >[root@osd1 ceph-0]# ll</font></div><div><font size="2"   >total 36</font></div><div><font size="2"   >-rw-r--r-- &nbsp;1 root root &nbsp; 37 Dec &nbsp;2 08:52 ceph_fsid</font></div><div><font size="2"   >drwxr-xr-x 60 root root 4096 Dec &nbsp;2 09:45 current</font></div><div><font size="2"   >-rw-r--r-- &nbsp;1 root root &nbsp; 37 Dec &nbsp;2 08:52 fsid</font></div><div><font size="2"   >lrwxrwxrwx &nbsp;1 root root &nbsp; 15 Dec &nbsp;3 11:20 journal -&gt; /data02/journal</font></div><div><font size="2"   >-rw------- &nbsp;1 root root &nbsp; 56 Dec &nbsp;2 08:52 keyring</font></div><div><font size="2"   >-rw-r--r-- &nbsp;1 root root &nbsp; 21 Dec &nbsp;2 08:52 magic</font></div><div><font size="2"   >-rw-r--r-- &nbsp;1 root root &nbsp; &nbsp;6 Dec &nbsp;2 08:52 ready</font></div><div><font size="2"   >-rw-r--r-- &nbsp;1 root root &nbsp; &nbsp;4 Dec &nbsp;2 08:52 store_version</font></div><div><font size="2"   >-rw-r--r-- &nbsp;1 root root &nbsp; 53 Dec &nbsp;2 08:52 superblock</font></div><div><font size="2"   >-rw-r--r-- &nbsp;1 root root &nbsp; &nbsp;0 Dec &nbsp;2 08:59 sysvinit</font></div><div><font size="2"   >-rw-r--r-- &nbsp;1 root root &nbsp; &nbsp;2 Dec &nbsp;2 08:52 whoami</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >启动服务</font></div><div><div><font size="2"   >[root@osd1 ceph-0]# service ceph start osd.0</font></div><div><font size="2"   >=== osd.0 ===&nbsp;</font></div><div><font size="2"   >create-or-move updated item name 'osd.0' weight 0.4 at location {host=osd1,root=default} to crush map</font></div><div><font size="2"   >Starting Ceph osd.0 on osd1...</font></div><div><font size="2"   >starting osd.0 at :/0 osd_data /var/lib/ceph/osd/ceph-0 /var/lib/ceph/osd/ceph-0/journal</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >检查状态</font></div><div><font size="2"   >[root@osd1 ceph-0]# ceph -s</font></div><div><font size="2"   >&nbsp; &nbsp; cluster f649b128-963c-4802-ae17-5a76f36c4c76</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;health HEALTH_OK</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;monmap e1: 3 mons at {mon1=172.17.0.2:6789/0,mon2=172.17.0.3:6789/0,mon3=172.17.0.4:6789/0}, election epoch 16, quorum 0,1,2 mon1,mon2,mon3</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;osdmap e36: 4 osds: 4 up, 4 in</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; pgmap v211: 128 pgs, 1 pools, 0 bytes data, 0 objects</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 12288 MB used, 424 GB / 438 GB avail</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;128 active+clean</font></div></div><p></p></pre></div><div><br></div><div>当然, 也可以通过修改ceph集群配置文件来修改他们的位置,</div><div>参考 :&nbsp;</div><div>src/sample.ceph.conf</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >&nbsp; &nbsp; # The monitor's data location</font></div><div><font size="2"   >&nbsp; &nbsp; # Default: /var/lib/ceph/mon/$cluster-$id</font></div><div><font size="2"   >&nbsp; &nbsp; ;mon data &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = /var/lib/ceph/mon/$name</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >&nbsp; &nbsp; # Default: /var/lib/ceph/osd/$cluster-$id</font></div><div><font size="2"   >&nbsp; &nbsp; ;osd data &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; = /var/lib/ceph/osd/$name</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >&nbsp; &nbsp; # Default: /var/lib/ceph/osd/$cluster-$id/journal</font></div><div><font size="2"   >&nbsp; &nbsp; ;osd journal &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= /var/lib/ceph/osd/$name/journal</font></div></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >[参考]</span></div><wbr><div>1. /etc/init.d/ceph</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; get_conf osd_data "/var/lib/ceph/osd/$cluster-$id" "osd data"</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; get_conf mon_data "/var/lib/ceph/mon/ceph-$id" "mon data"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if [ "$mon_data" = "/var/lib/ceph/mon/ceph-$id" -a "$asok" = "/var/run/ceph/ceph-mon.$id.asok" ]; then</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; echo Starting ceph-create-keys on $host...</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cmd2="$SBINDIR/ceph-create-keys --cluster $cluster -i $id 2&gt; /dev/null &amp;"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; do_cmd "$cmd2"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fi</font></div></div><p></p></pre></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="ceph performance tune , mount the osd mon data directory to diff block dev - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>