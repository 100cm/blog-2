<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">use Docker as OpenStack Cloud Operating System Compute Node - Nova's Hypervisor</h2>
	<h5 id="">2014-12-05 17:01:09&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201411545128878/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>OpenStack现已支持Docker作为Nova的Hypervisor, 同时支持将image存储在Glance中, 目前的版本还需要使用docker-registry来代理请求到glance获取image.</div><div>未来可能会去掉registry, 直接从glance获取image.</div><div><br></div><div><div><img title="use Docker as OpenStack Cloud Operating System Compute Node - Novas Hypervisor - 德哥@Digoal - PostgreSQL research"   alt="use Docker as OpenStack Cloud Operating System Compute Node - Novas Hypervisor - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/z6H6VARDeNNb8Xsl2FGvWg==/6608631131422910928.png"   ></div><br></div><div>部署步骤 :&nbsp;</div><div>1. Nova节点安装Docker server, 赋予nova用户docker组权限.</div><div>2. 安装nova docker驱动</div><div>3. 在nova配置中, 改为默认使用docker driver</div><div>4. compute_driver = novadocker.virt.docker.DockerDriver</div><div>5. 让nova控制网络, 即使有netns, --net=none启动容器.</div><div>6. Glance配置, 添加docker镜像支持.</div><div>使用 :&nbsp;</div><div>1. 下载docker镜像</div><div>2. 将docker镜像导入glance(例子)</div><div><div>docker pull samalba/hipache</div><div>docker save samalba/hipache | glance image-create --is-public=True --container-format=docker --disk-format=raw --name samalba/hipache</div></div><div>3. 使用nova启动容器(没有看到镜像下载过程, 已经在本地了, 如果镜像不在本地, 还需要配置registry, glance, 此处略)</div><div>nova boot --image "samalba/hipache" --flavor m1.tiny test</div><div><br></div><div><h2 style="margin: 10px 0px; font-family: 'PT Sans', sans-serif; line-height: 40px; color: rgb(51, 51, 51); text-rendering: optimizelegibility; font-size: 31.5px;"   ><span id="Configure_OpenStack_to_enable_Docker"   >Configure OpenStack to enable Docker</span></h2><h3 style="margin: 10px 0px; font-family: 'PT Sans', sans-serif; line-height: 40px; color: rgb(51, 51, 51); text-rendering: optimizelegibility; font-size: 24.5px;"   ><span id="Installing_Docker_for_OpenStack"   >Installing Docker for OpenStack</span></h3><p style="margin-top: 0px; color: rgb(51, 51, 51); font-family: 'Arial Unicode MS', Arial, sans-serif; font-size: 14px; line-height: 20px;"   >The first requirement is to&nbsp;<a rel="nofollow" href="http://docs.docker.io/en/latest/installation/"   >install Docker</a>&nbsp;on your compute hosts.</p><p style="margin-top: 0px; color: rgb(51, 51, 51); font-family: 'Arial Unicode MS', Arial, sans-serif; font-size: 14px; line-height: 20px;"   >In order for Nova to communicate with Docker over its local socket, add&nbsp;<i>nova</i>&nbsp;to the&nbsp;<i>docker</i>&nbsp;group and restart the compute service to pick up the change:</p><pre style="padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: rgb(51, 51, 51); border-radius: 4px; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); background-color: rgb(245, 245, 245);"   >usermod -G docker nova
service openstack-nova-compute restart
</pre><p style="margin-top: 0px; color: rgb(51, 51, 51); font-family: 'Arial Unicode MS', Arial, sans-serif; font-size: 14px; line-height: 20px;"   >You will also need to install the driver:</p><pre style="padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: rgb(51, 51, 51); border-radius: 4px; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); background-color: rgb(245, 245, 245);"   >pip install -e git+<a rel="nofollow" href="https://github.com/stackforge/nova-docker#egg=novadocker"   >https://github.com/stackforge/nova-docker#egg=novadocker</a>
</pre><p style="margin-top: 0px; color: rgb(51, 51, 51); font-family: 'Arial Unicode MS', Arial, sans-serif; font-size: 14px; line-height: 20px;"   >You should then install the required modules</p><pre style="padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: rgb(51, 51, 51); border-radius: 4px; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); background-color: rgb(245, 245, 245);"   >cd src/novadocker/
python setup.py install
</pre><p style="margin-top: 0px; color: rgb(51, 51, 51); font-family: 'Arial Unicode MS', Arial, sans-serif; font-size: 14px; line-height: 20px;"   >You may optionally choose to create operating-system packages for this, or use another appropriate installation method for your deployment.</p><h3 style="margin: 10px 0px; font-family: 'PT Sans', sans-serif; line-height: 40px; color: rgb(51, 51, 51); text-rendering: optimizelegibility; font-size: 24.5px;"   ><span id="Nova_configuration"   >Nova configuration</span></h3><p style="margin-top: 0px; color: rgb(51, 51, 51); font-family: 'Arial Unicode MS', Arial, sans-serif; font-size: 14px; line-height: 20px;"   >Nova needs to be configured to use the Docker virt driver.</p><p style="margin-top: 0px; color: rgb(51, 51, 51); font-family: 'Arial Unicode MS', Arial, sans-serif; font-size: 14px; line-height: 20px;"   >Edit the configuration file /etc/nova/nova.conf according to the following options:</p><pre style="padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: rgb(51, 51, 51); border-radius: 4px; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); background-color: rgb(245, 245, 245);"   >[DEFAULT]
compute_driver = novadocker.virt.docker.DockerDriver
</pre><p style="margin-top: 0px; color: rgb(51, 51, 51); font-family: 'Arial Unicode MS', Arial, sans-serif; font-size: 14px; line-height: 20px;"   >Create the directory /etc/nova/rootwrap.d, if it does not already exist, and inside that directory create a file "docker.filters" with the following content:</p><pre style="padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: rgb(51, 51, 51); border-radius: 4px; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); background-color: rgb(245, 245, 245);"   ># nova-rootwrap command filters for setting up network in the docker driver
# This file should be owned by (and only-writeable by) the root user

[Filters]
# nova/virt/docker/driver.py: 'ln', '-sf', '/var/run/netns/.*'
ln: CommandFilter, /bin/ln, root
</pre><h3 style="margin: 10px 0px; font-family: 'PT Sans', sans-serif; line-height: 40px; color: rgb(51, 51, 51); text-rendering: optimizelegibility; font-size: 24.5px;"   ><span id="Glance_configuration"   >Glance configuration</span></h3><p style="margin-top: 0px; color: rgb(51, 51, 51); font-family: 'Arial Unicode MS', Arial, sans-serif; font-size: 14px; line-height: 20px;"   >Glance needs to be configured to support the "docker" container format. It's important to leave the default ones in order to not break an existing glance install.</p><pre style="padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: rgb(51, 51, 51); border-radius: 4px; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); background-color: rgb(245, 245, 245);"   >[DEFAULT]
container_formats = ami,ari,aki,bare,ovf,docker
</pre><h2 style="margin: 10px 0px; font-family: 'PT Sans', sans-serif; line-height: 40px; color: rgb(51, 51, 51); text-rendering: optimizelegibility; font-size: 31.5px;"   ><span id="Deployment_with_DevStack"   >Deployment with DevStack</span></h2><p style="margin-top: 0px; color: rgb(51, 51, 51); font-family: 'Arial Unicode MS', Arial, sans-serif; font-size: 14px; line-height: 20px;"   >Using Docker hypervisor through DevStack replaces all manual configuration needed above.</p><p style="margin-top: 0px; color: rgb(51, 51, 51); font-family: 'Arial Unicode MS', Arial, sans-serif; font-size: 14px; line-height: 20px;"   >Before running&nbsp;<a rel="nofollow" href="http://devstack.org/"   >DevStack</a>'s stack.sh script, configure the following options in the "localrc" file:</p><pre style="padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: rgb(51, 51, 51); border-radius: 4px; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); background-color: rgb(245, 245, 245);"   >VIRT_DRIVER=docker
</pre><p style="margin-top: 0px; color: rgb(51, 51, 51); font-family: 'Arial Unicode MS', Arial, sans-serif; font-size: 14px; line-height: 20px;"   >Then, run follow instructions in the&nbsp;<a rel="nofollow" href="https://raw.githubusercontent.com/stackforge/nova-docker/master/contrib/devstack/README.rst"   >README.rst</a></p><p style="margin-top: 0px; color: rgb(51, 51, 51); font-family: 'Arial Unicode MS', Arial, sans-serif; font-size: 14px; line-height: 20px;"   >Finally, run stack.sh from devstack directory:</p><pre style="padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: rgb(51, 51, 51); border-radius: 4px; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); background-color: rgb(245, 245, 245);"   >$ ./stack.sh
</pre><h2 style="margin: 10px 0px; font-family: 'PT Sans', sans-serif; line-height: 40px; color: rgb(51, 51, 51); text-rendering: optimizelegibility; font-size: 31.5px;"   ><span id="How_to_use_it"   >How to use it</span></h2><p style="margin-top: 0px; color: rgb(51, 51, 51); font-family: 'Arial Unicode MS', Arial, sans-serif; font-size: 14px; line-height: 20px;"   >Once you configured Nova to use the docker driver, the flow is the same as any other driver.</p><pre style="padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: rgb(51, 51, 51); border-radius: 4px; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); background-color: rgb(245, 245, 245);"   >$ glance image-list
+-------------------------------+---------------------------------+-------------+------------------+----------+--------+
| ID                            | Name                            | Disk Format | Container Format | Size     | Status |
+-------------------------------+---------------------------------+-------------+------------------+----------+--------+
| f5049d8b-93cf-49ab-af56-e7... | cirros-0.3.1-x86_64-uec         | ami         | ami              | 25165824 | active |
| 0f1ec86c-157f-4f22-9889-c0... | cirros-0.3.1-x86_64-uec-kernel  | aki         | aki              | 4955792  | active |
| 03a54807-2e35-4864-a337-45... | cirros-0.3.1-x86_64-uec-ramdisk | ari         | ari              | 3714968  | active |
| 77083f3c-d320-46e3-bcba-0c... | docker-busybox:latest           | raw         | docker           | 2271596  | active |
+-------------------------------+---------------------------------+-------------+------------------+----------+--------+
</pre><p style="margin-top: 0px; color: rgb(51, 51, 51); font-family: 'Arial Unicode MS', Arial, sans-serif; font-size: 14px; line-height: 20px;"   >Only images with a "docker" container format will be bootable. The image contains basically a tarball of the container filesystem.</p><p style="margin-top: 0px; color: rgb(51, 51, 51); font-family: 'Arial Unicode MS', Arial, sans-serif; font-size: 14px; line-height: 20px;"   >It's recommended to add new images to Glance by using Docker. For instance, here is how you can fetch images from the public registry and push them back to Glance in order to boot a Nova instance with it:</p><pre style="padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: rgb(51, 51, 51); border-radius: 4px; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); background-color: rgb(245, 245, 245);"   > $ docker search hipache
Found 3 results matching your query ("hipache")
NAME                             DESCRIPTION
samalba/hipache                  <a rel="nofollow" href="https://github.com/dotcloud/hipache"   >https://github.com/dotcloud/hipache</a>
</pre><p style="margin-top: 0px; color: rgb(51, 51, 51); font-family: 'Arial Unicode MS', Arial, sans-serif; font-size: 14px; line-height: 20px;"   >Then, pull the image and push it to Glance:</p><pre style="padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: rgb(51, 51, 51); border-radius: 4px; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); background-color: rgb(245, 245, 245);"   > $ docker pull samalba/hipache
 $ docker save samalba/hipache | glance image-create --is-public=True --container-format=docker --disk-format=raw --name samalba/hipache
</pre><p style="margin-top: 0px; color: rgb(51, 51, 51); font-family: 'Arial Unicode MS', Arial, sans-serif; font-size: 14px; line-height: 20px;"   ><b>NOTE: The name you provide to glance must match the name by which the image is known to docker.</b></p><pre style="padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: rgb(51, 51, 51); border-radius: 4px; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); background-color: rgb(245, 245, 245);"   > $ glance image-list
+-------------------------------+---------------------------------+-------------+------------------+----------+--------+
| ID                            | Name                            | Disk Format | Container Format | Size     | Status |
+-------------------------------+---------------------------------+-------------+------------------+----------+--------+
| f5049d8b-93cf-49ab-af56-e7... | cirros-0.3.1-x86_64-uec         | ami         | ami              | 25165824 | active |
| 0f1ec86c-157f-4f22-9889-c0... | cirros-0.3.1-x86_64-uec-kernel  | aki         | aki              | 4955792  | active |
| 03a54807-2e35-4864-a337-45... | cirros-0.3.1-x86_64-uec-ramdisk | ari         | ari              | 3714968  | active |
| 77083f3c-d320-46e3-bcba-0c... | docker-busybox:latest           | raw         | docker           | 2271596  | active |
| 998f52ba-fe03-46b0-b5a6-4b... | samalba/hipache               | raw         | docker           | 486      | active |
+-------------------------------+---------------------------------+-------------+------------------+----------+--------+
</pre><p style="margin-top: 0px; color: rgb(51, 51, 51); font-family: 'Arial Unicode MS', Arial, sans-serif; font-size: 14px; line-height: 20px;"   >You can obviously boot instances from nova cli:</p><pre style="padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: rgb(51, 51, 51); border-radius: 4px; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); background-color: rgb(245, 245, 245);"   > $ nova boot --image "samalba/hipache" --flavor m1.tiny test
+--------------------------------------+--------------------------------------+
| Property                             | Value                                |
+--------------------------------------+--------------------------------------+
| OS-EXT-STS:task_state                | scheduling                           |
| image                                | samalba/hipache                |
| OS-EXT-STS:vm_state                  | building                             |
| OS-EXT-SRV-ATTR:instance_name        | instance-0000002d                    |
| OS-SRV-USG:launched_at               | None                                 |
| flavor                               | m1.micro                             |
| id                                   | 31086c50-f937-4f80-9790-045096ecb32c |
| security_groups                      | [{u'name': u'default'}]              |
| user_id                              | 1a3eed38d1344e869dd019b3636db12b     |
| OS-DCF:diskConfig                    | MANUAL                               |
| accessIPv4                           |                                      |
| accessIPv6                           |                                      |
| progress                             | 0                                    |
| OS-EXT-STS:power_state               | 0                                    |
| OS-EXT-AZ:availability_zone          | nova                                 |
| config_drive                         |                                      |
| status                               | BUILD                                |
| updated                              | 2013-08-25T00:22:32Z                 |
| hostId                               |                                      |
| OS-EXT-SRV-ATTR:host                 | None                                 |
| OS-SRV-USG:terminated_at             | None                                 |
| key_name                             | None                                 |
| OS-EXT-SRV-ATTR:hypervisor_hostname  | None                                 |
| name                                 | test                                 |
| adminPass                            | QwczSPAAT6Mm                         |
| tenant_id                            | 183a9b7ed7c6465f97387458d693ca4c     |
| created                              | 2013-08-25T00:22:31Z                 |
| os-extended-volumes:volumes_attached | []                                   |
| metadata                             | {}                                   |
+--------------------------------------+--------------------------------------+
</pre><p style="margin-top: 0px; color: rgb(51, 51, 51); font-family: 'Arial Unicode MS', Arial, sans-serif; font-size: 14px; line-height: 20px;"   >Once the instance is booted:</p><pre style="padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: rgb(51, 51, 51); border-radius: 4px; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); background-color: rgb(245, 245, 245);"   >$ nova list
+--------------------------------------+------+--------+------------+-------------+------------------+
| ID                                   | Name | Status | Task State | Power State | Networks         |
+--------------------------------------+------+--------+------------+-------------+------------------+
| 31086c50-f937-4f80-9790-045096ecb32c | test | ACTIVE | None       | Running     | private=10.0.0.2 |
+--------------------------------------+------+--------+------------+-------------+------------------+
</pre><p style="margin-top: 0px; color: rgb(51, 51, 51); font-family: 'Arial Unicode MS', Arial, sans-serif; font-size: 14px; line-height: 20px;"   >You can also see the corresponding container on docker:</p><pre style="padding: 9.5px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; font-size: 13px; color: rgb(51, 51, 51); border-radius: 4px; margin-top: 0px; margin-bottom: 10px; line-height: 20px; word-break: break-all; word-wrap: break-word; white-space: pre-wrap; border: 1px solid rgba(0, 0, 0, 0.14902); background-color: rgb(245, 245, 245);"   >$ docker ps
docker ps
ID              IMAGE                                  COMMAND      CREATED             STATUS          PORTS
f337c7fec5ff    samalba/hipache              sh           10 seconds ago      Up 10 seconds
</pre><p style="margin-top: 0px; color: rgb(51, 51, 51); font-family: 'Arial Unicode MS', Arial, sans-serif; font-size: 14px; line-height: 20px;"   >The command used here is the one configured in the image. Each container image can have a command configured for the run. The driver does not usually override this. You can image booting an apache2 instance, it will start the apache process if the image is authored properly via a&nbsp;<a rel="nofollow" href="http://docs.docker.io/en/latest/use/builder/"   >Dockerfile</a>.</p><h2 style="margin: 10px 0px; font-family: 'PT Sans', sans-serif; line-height: 40px; color: rgb(51, 51, 51); text-rendering: optimizelegibility; font-size: 31.5px;"   ><span id="Resources"   >Resources</span></h2><ul style="margin-top: 0.3em; margin-bottom: 0px; margin-left: 1.6em; color: rgb(51, 51, 51); font-family: 'Arial Unicode MS', Arial, sans-serif; font-size: 14px; line-height: 20px;"   ><li style="line-height: 20px;"   >Nickoloff, Jeff;&nbsp;<a rel="nofollow" href="http://www.manning.com/nickoloff/"   >Docker in Action</a>, Manning Publications, 2014,&nbsp;<a style="color: rgb(0, 136, 204); text-decoration: none; cursor: pointer;" rel="nofollow" href="https://wiki.openstack.org/wiki/Special:BookSources/9781633430235"   >ISBN 978-1-6334-3023-5</a></li></ul></div><div><br></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://wiki.openstack.org/wiki/Docker"   >https://wiki.openstack.org/wiki/Docker</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201411514759357/"   >http://blog.163.com/digoal@126/blog/static/163877040201411514759357/</a></div></div>
	</div>
</div>
</body>
</html>