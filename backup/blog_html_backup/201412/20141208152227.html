<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Ceph cluster configure introduce - 2</h2>
	<h5 id="">2014-12-08 15:22:27&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020141182109300/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>一般配置 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >初始化时的监控节点配置, 包含(非FQDN)hostname -s, IP.</font></div><div><div><font size="2"   >[global]</font></div><div><font size="2"   >mon_initial_members = ceph1</font></div><div><font size="2"   >mon_host = 10.0.0.1</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >如果是手工部署, 可以写3个mon节点的信息, 如 :&nbsp;</font></div><div><div><font size="2"   >mon initial members = mon1, mon2, mon3</font></div><div><font size="2"   >mon host = 172.17.0.2, 172.17.0.3, 172.17.0.4</font></div></div><div><font size="2"   ><br></font></div><div><span style="line-height: 28px;"   ><font size="2"   >如果是使用chef, ceph-deploy来配置, 建议配置时只使用一个节点, 后面再添加, 如 :&nbsp;</font></span></div><div><div style="line-height: 28px;"   ><font size="2"   >mon_initial_members = ceph1</font></div><div style="line-height: 28px;"   ><font size="2"   >mon_host = 10.0.0.1</font></div></div><p></p></pre></div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >网络配置 :&nbsp;</div><div style="line-height: 28px;"   >生产环境建议至少应该将public网络和cluster网络分开.</div><div style="line-height: 28px;"   >public网络中有ceph客户端的流量, 有ceph 监控的流量, 还有ceph mds的流量.</div><div style="line-height: 28px;"   >集群网络的话, 主要包含osd节点之间的数据复制流量, 心跳流量.</div><div style="line-height: 28px;"   ><div><img title="Ceph cluster configure introduce - 2 - 德哥@Digoal - PostgreSQL research"   alt="Ceph cluster configure introduce - 2 - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/aC8fZn4uuT41R0OuELLnbw==/2892718335673144068.png"   ></div>OSD节点的交互包括 :&nbsp;</div><div style="line-height: 28px;"   >OSD节点之间的复制交互, 心跳交互</div><div style="line-height: 28px;"   >OSD节点和客户端, 监控节点的交互</div><div style="line-height: 28px;"   ><img title="Ceph cluster configure introduce - 2 - 德哥@Digoal - PostgreSQL research"   alt="Ceph cluster configure introduce - 2 - 德哥@Digoal - PostgreSQL research"   src="http://img1.ph.126.net/xMTgjTowU7aI9zO1EF-3GA==/6619304090793526807.png"   style="line-height: 28px; margin: 0px 10px 0px 0px;"   ></div><div style="line-height: 28px;"   >网络配置举例 :&nbsp;</div><div><a target="_blank" rel="nofollow" href="http://ceph.com/docs/master/rados/configuration/network-config-ref"   >http://ceph.com/docs/master/rados/configuration/network-config-ref</a></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[mon.a]</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; host = {hostname}</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; mon addr = {ip-address}:6789</font></div></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >[osd.0]</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; public addr = {ip-address}/{netmask} [, {ip-address}/{netmask}] &nbsp;192.168.0.0/24</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; cluster addr = {ip-address}/{netmask} [, {ip-address}/{netmask}] &nbsp;10.0.0.0/24</font></div></div><p></p></pre></div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >监控配置 :&nbsp;</div><div><a target="_blank" rel="nofollow" href="http://ceph.com/docs/master/rados/configuration/mon-config-ref"   >http://ceph.com/docs/master/rados/configuration/mon-config-ref</a></div><div style="line-height: 28px;"   >监控节点主要配置地址, 数据目录, 例如 :&nbsp;</div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[mon]</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; mon host = hostname1,hostname2,hostname3</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; mon addr = 10.0.0.10:6789,10.0.0.11:6789,10.0.0.12:6789</font></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; mon data =&nbsp;/var/lib/ceph/mon/$cluster-$id</font></span></div><div style="line-height: 28px;"   ><font size="2"   >[mon.a]</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; host = hostname1</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; mon addr = 10.0.0.10:6789</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br></div></div></div><div style="line-height: 28px;"   >认证配置 :&nbsp;</div><div><a target="_blank" rel="nofollow" href="http://ceph.com/docs/master/rados/operations/authentication"   >http://ceph.com/docs/master/rados/operations/authentication</a></div><div><a target="_blank" rel="nofollow" href="http://ceph.com/docs/master/rados/configuration/auth-config-ref"   >http://ceph.com/docs/master/rados/configuration/auth-config-ref</a></div><div style="line-height: 28px;"   >升级CEPH版本前, 建议关闭认证, 升级完再打开, 配置例如 :&nbsp;</div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >auth cluster required = cephx</font></div><div style="line-height: 28px;"   ><font size="2"   >auth service required = cephx</font></div><div style="line-height: 28px;"   ><font size="2"   >auth client required = cephx</font></div><p></p></pre></div></div><div style="line-height: 28px;"   >key配置未列出.</div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >OSD配置</div><div><a target="_blank" rel="nofollow" href="http://ceph.com/docs/master/rados/configuration/osd-config-ref"   >http://ceph.com/docs/master/rados/configuration/osd-config-ref</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201411711835765/"   >http://blog.163.com/digoal@126/blog/static/163877040201411711835765/</a></div><div style="line-height: 28px;"   >OSD一般需要配置journal大小路径, 数据目录路径, 文件系统的XATTR是否使用OMAP存储(ext4必须使用omap), 等, 例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[osd]</font></div><div><font size="2"   >&nbsp; &nbsp; osd journal =&nbsp;/var/lib/ceph/osd/$cluster-$id/journal</font></div><div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; osd journal size = 1024</font></div><div><font size="2"   >&nbsp; &nbsp; osd data =&nbsp;/var/lib/ceph/osd/$cluster-$id</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; filestore xattr use omap = true</font></div></div><p></p></pre></div><div><div style="line-height: 28px;"   ><br></div></div><div style="line-height: 28px;"   >心跳配置</div><div><a target="_blank" rel="nofollow" href="http://docs.ceph.com/docs/master/rados/configuration/mon-osd-interaction/"   >http://docs.ceph.com/docs/master/rados/configuration/mon-osd-interaction/</a></div><div>首先看看心跳流程 :&nbsp;</div><div>OSD1检测到OSD2异常.</div><pre class="prettyprint"   ><p></p><div><font size="2"   >间隔 [osd] osd heartbeat interval = 秒.</font></div><div><div></div></div><p></p></pre><div><font size="2"   ><img title="Ceph cluster configure introduce - 2 - 德哥@Digoal - PostgreSQL research"   alt="Ceph cluster configure introduce - 2 - 德哥@Digoal - PostgreSQL research"   src="http://img2.ph.126.net/dP3QxnklQ6Fhy8iym_jCLg==/2861474613258346232.png"   style="line-height: 28px; margin: 0px 10px 0px 0px;"   ></font></div><div><div><br></div>OSD1 向monitor报告其他节点异常.</div><div><pre class="prettyprint"   ><p><font size="2"   >[mon]&nbsp;mon osd min down reports = 多少次mon将其标记为down状态<br></font></p><div></div><p></p></pre><div><img title="Ceph cluster configure introduce - 2 - 德哥@Digoal - PostgreSQL research"   alt="Ceph cluster configure introduce - 2 - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/uiuB7GYBCxk_mFbkOro-jQ==/1168965578297091993.png"   ></div>OSD 报告peer异常.</div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >[osd] osd mon heartbeat interval = 多少秒</font></span></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >osd间隔默认30秒向mon请求最新的map, 并检测map中的其他osd的状态. 向mon报告.</span></div><div><div><img title="Ceph cluster configure introduce - 2 - 德哥@Digoal - PostgreSQL research"   alt="Ceph cluster configure introduce - 2 - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/Hb_ikOj96uY5PNotaqdVEA==/6608635529469429081.png"   ></div><span style="line-height: 28px;"   >OSD1 向montiro报告自身异常.</span></div><div>当mon osd report timeout时间之后未收到OSD主动发起的状态信息报告, MON将标记该OSD DOWN.</div><div>那么OSD多久给MON发一次报告呢? 除了状态改变引起的报告, 还可以设置间隔.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[osd]</font></div><div><font size="2"   >osd mon report interval min = 5秒 默认</font></div><div><font size="2"   >osd mon report interval max = 120秒 默认</font></div><p></p></pre></div><div><img title="Ceph cluster configure introduce - 2 - 德哥@Digoal - PostgreSQL research"   alt="Ceph cluster configure introduce - 2 - 德哥@Digoal - PostgreSQL research"   src="http://img2.ph.126.net/3Sp64mGfNgmJvqDzkCH4BQ==/3835378032759617402.png"   style="line-height: 28px; margin: 0px 10px 0px 0px;"   ></div><div><br></div><div style="line-height: 28px;"   >日志,debug配置</div><div><a target="_blank" rel="nofollow" href="http://docs.ceph.com/docs/master/rados/troubleshooting/log-and-debug/"   >http://docs.ceph.com/docs/master/rados/troubleshooting/log-and-debug/</a></div><div style="line-height: 28px;"   >例子</div><div style="line-height: 28px;"   >DEBUG参考配置 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[global]</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; debug ms = 1/5</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[mon]</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; debug mon = 20</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; debug paxos = 1/5</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; debug auth = 2</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[osd]</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; debug osd = 1/5</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; debug filestore = 1/5</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; debug journal = 1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; debug monc = 5/20</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[mds]</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; debug mds = 1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; debug mds balancer = 1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; debug mds log = 1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; debug mds migrator = 1</font></div><p></p></pre></div><div><br></div><div>日志文件rotate参考配置</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >rotate 7</font></div><div><font size="2"   >weekly</font></div><div><font size="2"   >compress</font></div><div><font size="2"   >sharedscripts</font></div><div><font size="2"   >Modify it by adding a size setting.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >rotate 7</font></div><div><font size="2"   >weekly</font></div><div><font size="2"   >size 500M</font></div><div><font size="2"   >compress</font></div><div><font size="2"   >sharedscripts</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Then, start the crontab editor for your user space.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >crontab -e</font></div><div><font size="2"   >Finally, add an entry to check the etc/logrotate.d/ceph file.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >30 * * * * /usr/sbin/logrotate /etc/logrotate.d/ceph &gt;/dev/null 2&gt;&amp;1</font></div><p></p></pre></div><div><br></div><div>日志参考配置 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >log file =&nbsp;/var/log/ceph/$cluster-$name.log</font></div><div><font size="2"   >mon cluster log file =&nbsp;/var/log/ceph/$cluster.log</font></div><p></p></pre></div><div><br></div><wbr><div><br></div>[参考<span style="line-height: 28px;"   >]</span><div><wbr></div><div><span style="line-height: 28px;"   >1.&nbsp;</span><a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014118103927428/"   >http://blog.163.com/digoal@126/blog/static/1638770402014118103927428/</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://ceph.com/docs/master/rados/configuration/ceph-conf/"   >http://ceph.com/docs/master/rados/configuration/ceph-conf/</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="Ceph cluster configure introduce - 2 - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>