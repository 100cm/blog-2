<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">add network card|interface to docker container online</h2>
	<h5 id="">2014-12-05 16:48:51&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201411544551296/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><span style="line-height: 28px;"   >本文将讲解一下如何对一个正在运行的container添加网卡.&nbsp;</span></div><div>其实就是用的netns, 使用--net=none或--net=bridge都无所谓.</div><div><span style="line-height: 28px;"   ><br></span></div><div>启动一个容器, 默认使用bridge. 所以会自动创建一个网卡.</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >[root@localhost ~]# docker run --name=test -t -i --rm centos:centos6 /bin/bash</font></span></div><div><font size="2"   >[root@878894e4216d /]# ip link</font></div><div><font size="2"   >1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</font></div><div><font size="2"   >49: eth0: &lt;BROADCAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</font></div><div><font size="2"   >&nbsp; &nbsp; link/ether 1e:a6:7f:14:f1:e5 brd ff:ff:ff:ff:ff:ff</font></div><p></p></pre></div><div><br></div><div>为这个容器添加一块网卡 :&nbsp;</div><div>首选要获得容器的PID.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost ~]# docker inspect -f '{{.State.Pid}}' test</font></div><div><font size="2"   >27175</font></div><p></p></pre></div><div>将这个PID的进程信息ns/net拷贝到/var/run/netns.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost ~]# mkdir -p /var/run/netns</font></div><div><font size="2"   >[root@localhost ~]# ln -s /proc/27175/ns/net /var/run/netns/27175</font></div><p></p></pre></div><div>在本地添加一对peer接口.</div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost ~]# ip link add v1 type veth peer name vp1</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >将一个端口加入网桥</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost ~]# brctl show</font></div><div><font size="2"   >bridge name &nbsp; &nbsp; bridge id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; STP enabled &nbsp; &nbsp; interfaces</font></div><div><font size="2"   >br0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8000.000000000000 &nbsp; &nbsp; &nbsp; no</font></div><div><font size="2"   >docker0 &nbsp; &nbsp; &nbsp; &nbsp; 8000.56847afe9799 &nbsp; &nbsp; &nbsp; no &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;veth19a1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; veth7428</font></div><div><font size="2"   >virbr0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8000.000000000000 &nbsp; &nbsp; &nbsp; yes</font></div><div><font size="2"   >[root@localhost ~]# brctl addif docker0 vp1</font></div><div><font size="2"   >[root@localhost ~]# ip link set vp1 up</font></div><p></p></pre></div><div>另一个端口加入container的network namespace.</div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost ~]# ip link set v1 netns 27175</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >为加入container的端口配置IP地址.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost ~]# ip netns help</font></div><div><font size="2"   >Usage: ip netns list</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;ip netns add NAME</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;ip netns delete NAME</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;ip netns identify PID</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;ip netns pids NAME</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;ip netns exec NAME cmd ...</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;ip netns monitor</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@localhost ~]# ip netns exec 27175 ip link set v1 up</font></div><div><font size="2"   >[root@localhost ~]# ip netns exec 27175 ip addr add 172.17.0.99/16 dev v1</font></div><p></p></pre></div><div>测试是否正常 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost ~]# ping 172.17.0.99</font></div><div><font size="2"   >PING 172.17.0.99 (172.17.0.99) 56(84) bytes of data.</font></div><div><font size="2"   >64 bytes from 172.17.0.99: icmp_seq=1 ttl=64 time=0.107 ms</font></div><div><font size="2"   >^C</font></div><div><font size="2"   >--- 172.17.0.99 ping statistics ---</font></div><div><font size="2"   >1 packets transmitted, 1 received, 0% packet loss, time 0ms</font></div><div><font size="2"   >rtt min/avg/max/mdev = 0.107/0.107/0.107/0.000 ms</font></div><p></p></pre></div><div>容器中多了一个端口, v1 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@878894e4216d /]# ip addr</font></div><div><font size="2"   >1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</font></div><div><font size="2"   >&nbsp; &nbsp; inet 127.0.0.1/8 scope host lo</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;valid_lft forever preferred_lft forever</font></div><div><font size="2"   >&nbsp; &nbsp; inet6 ::1/128 scope host&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;valid_lft forever preferred_lft forever</font></div><div><font size="2"   >49: eth0: &lt;BROADCAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</font></div><div><font size="2"   >&nbsp; &nbsp; link/ether 1e:a6:7f:14:f1:e5 brd ff:ff:ff:ff:ff:ff</font></div><div><font size="2"   >&nbsp; &nbsp; inet 172.17.0.8/16 scope global eth0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;valid_lft forever preferred_lft forever</font></div><div><font size="2"   >&nbsp; &nbsp; inet6 fe80::1ca6:7fff:fe14:f1e5/64 scope link&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;valid_lft forever preferred_lft forever</font></div><div><font size="2"   >52: v1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</font></div><div><font size="2"   >&nbsp; &nbsp; link/ether 1a:5a:59:97:d3:78 brd ff:ff:ff:ff:ff:ff</font></div><div><font size="2"   >&nbsp; &nbsp; inet 172.17.0.99/16 scope global v1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;valid_lft forever preferred_lft forever</font></div><div><font size="2"   >&nbsp; &nbsp; inet6 fe80::185a:59ff:fe97:d378/64 scope link&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;valid_lft forever preferred_lft forever</font></div><p></p></pre></div><div><br></div><div>为什么要创建/var/run/netns目录呢?</div><div>参考man ip-netns</div><div>network namespace name存储在/var/run/netns/中.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >DESCRIPTION</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;A network namespace is logically another copy of the network stack, with its own routes, firewall rules, and network</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;devices.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;By convention a named network namespace is an object at /var/run/netns/NAME that can be opened. &nbsp;The file descriptor</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;resulting from opening /var/run/netns/NAME refers to the specified network namespace. &nbsp;Holding that file descriptor open</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;keeps the network namespace alive. &nbsp;The file descriptor can be used with the setns(2) system call to change the network</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;namespace associated with a task.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;For applications that are aware of network namespaces, the convention is to look for global network configuration files</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;first in /etc/netns/NAME/ then in /etc/. &nbsp;For example, if you want a different version of /etc/resolv.conf for a network</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;namespace used to isolate your vpn you would name it /etc/netns/myvpn/resolv.conf.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;ip netns exec automates handling of this configuration, file convention for network namespace unaware applications, by</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;creating a mount namespace and bind mounting all of the per network namespace configure files into their traditional</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;location in /etc.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;ip netns list - show all of the named network namespaces</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; This command displays all of the network namespaces in /var/run/netns</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;ip netns add NAME - create a new named network namespace</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; If NAME is available in /var/run/netns/ this command creates a new network namespace and assigns NAME.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;ip netns delete NAME - delete the name of a network namespace</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; If NAME is present in /var/run/netns it is umounted and the mount point is removed. &nbsp;If this is the last user of</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; the network namespace the network namespace will be freed, otherwise the network namespace persists until it has</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; no more users. &nbsp;ip netns delete may fail if the mount point is in use in another mount namespace.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;ip netns identify PID - Report network namespaces names for process</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; This command walks through /var/run/netns and finds all the network namespace names for network namespace of the</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; specified process.</font></div><p></p></pre></div><div><br></div><div>[参考]</div><div>1. man ip-netns</div><div><br></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="add network card|interface to docker container online - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>