<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">ceph - adding A monitor (MANUAL)</h2>
	<h5 id="">2014-12-09 17:50:09&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201411952056378/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>本文讲一下如何对一个已经存在的ceph storage cluster手工添加一个监控节点.</div><div>建议的监控节点数为奇数. 因为需要使用paxos算法确保监控节点健康(大于一半的节点健康表示健康).</div><div>大致步骤 :&nbsp;</div><div>1. 环境准备</div><div>2. 安装软件</div><div>3. 添加节点</div><div><br></div><div>以docker为例演示一下如何添加monitor节点 :&nbsp;</div><div>测试环境请参考 :&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201410269169450/"   >http://blog.163.com/digoal@126/blog/static/163877040201410269169450/</a></div><div>已有3个monitor节点, 本文再添加2个monitor节点.</div><div><br></div><div>创建卷 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost ~]# mkdir -p /data01/mon4</font></div><div><font size="2"   >[root@localhost ~]# mkdir -p /data01/mon5</font></div><p></p></pre></div><div><br></div><div>启动容器 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># docker run -d --net=none --dns=202.101.172.35 --name=mon4 --hostname=mon4 --privileged=true -v /data01/mon4:/data01 digoal/sshd_ceph:giant</font></div><div><font size="2"   ><span style="line-height: 28px;"   ># docker run -d --net=none --dns=202.101.172.35 --name=mon5 --hostname=mon5 --privileged=true -v /data01/mon5:/data01 digoal/sshd_ceph:</span>giant</font></div><p></p></pre></div><div><br></div><div>配置容器网络 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >./pipework.sh docker0 -i eth0 mon4 172.17.0.9/16</font></div><div><font size="2"   >./pipework.sh br0 -i eth1 mon4 172.18.0.9/16</font></div><div><font size="2"   >./pipework.sh br1 -i eth2 mon4 172.19.0.9/16</font></div><div><div style="line-height: 28px;"   ><font size="2"   >./pipework.sh docker0 -i eth0 mon5 172.17.0.10/16</font></div><div style="line-height: 28px;"   ><font size="2"   >./pipework.sh br0 -i eth1 mon5 172.18.0.10/16</font></div><div style="line-height: 28px;"   ><font size="2"   >./pipework.sh br1 -i eth2 mon5 172.19.0.10/16</font></div></div><div style="line-height: 28px;"   ><font size="2"   ><br></font></div><div><font size="2"   >ssh 172.17.0.9</font></div><div><font size="2"   >ip route add default via 172.17.42.1 dev eth0</font></div><div><font size="2"   ><br></font></div><div><div style="line-height: 28px;"   ><font size="2"   >ssh 172.17.0.10</font></div><div style="line-height: 28px;"   ><font size="2"   >ip route add default via 172.17.42.1 dev eth0</font></div></div><p></p></pre></div><div><br></div><div>配置所有节点主机名(所有节点) :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >ssh to 172.17.0.2, 3, 4, 9, 10</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   ><br></font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >vi /etc/hosts</font></span></div><div><div><font size="2"   >172.17.0.1 &nbsp; &nbsp; &nbsp;deploy</font></div><div><font size="2"   >172.17.0.2 &nbsp; &nbsp; &nbsp;mon1</font></div><div><font size="2"   >172.17.0.3 &nbsp; &nbsp; &nbsp;mon2</font></div><div><font size="2"   >172.17.0.4 &nbsp; &nbsp; &nbsp;mon3</font></div><div><div style="line-height: 28px;"   ><font size="2"   >172.17.0.9 &nbsp; &nbsp; &nbsp;mon4</font></div><div style="line-height: 28px;"   ><font size="2"   >172.17.0.10 &nbsp; &nbsp; &nbsp;mon5</font></div></div><div><font size="2"   >172.17.0.5 &nbsp; &nbsp; &nbsp;osd1</font></div><div><font size="2"   >172.17.0.6 &nbsp; &nbsp; &nbsp;osd2</font></div><div><font size="2"   >172.17.0.7 &nbsp; &nbsp; &nbsp;osd3</font></div><div><font size="2"   >172.17.0.8 &nbsp; &nbsp; &nbsp;osd4</font></div></div><p></p></pre></div><div><br></div><div>配置yum仓库(mon4, mon5) :&nbsp;</div><div>参考 :&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201410269169450/"   >http://blog.163.com/digoal@126/blog/static/163877040201410269169450/</a></div><div><br></div><div>配置内核参数 :&nbsp;</div></div><div><div style="line-height: 28px;"   >参考 :&nbsp;</div><div style="line-height: 28px;"   ><a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201410269169450/"   >http://blog.163.com/digoal@126/blog/static/163877040201410269169450/</a></div></div><div><br></div><div><span style="line-height: 28px;"   >安装软件 :&nbsp;</span></div><div><div style="line-height: 28px;"   >参考 :&nbsp;</div><div style="line-height: 28px;"   ><a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201410269169450/"   >http://blog.163.com/digoal@126/blog/static/163877040201410269169450/</a></div></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201410274232276/"   >http://blog.163.com/digoal@126/blog/static/163877040201410274232276/</a></div><div><br></div><div>创建数据目录(两种方法) :&nbsp;</div><div>默认目录 :&nbsp;</div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@mon4 ~]# mkdir -p /var/lib/ceph/mon/ceph-4</font></div><div style="line-height: 28px;"   ><font size="2"   >[root@mon5 ~]# mkdir -p /var/lib/ceph/mon/ceph-5</font></div><p></p></pre></div></div><div>或者你可以使用非默认目录, 使用非默认目录后, 不能使用/etc/init.d/ceph来启动mon :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@mon4 ~]# mkdir -p /data01/ceph/mon/ceph-4</font></div><div><font size="2"   >[root@mon5 ~]# mkdir -p /data01/ceph/mon/ceph-5</font></div><p></p></pre></div><div><br></div><div>从现有监控节点生成新增节点的信息, (或者从网络接收KEY, 在新增节点本地生成)</div><div>并拷贝配置文件和key到新增节点 :&nbsp;</div><div>在已有节点生成的方法 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost ~]# ssh 172.17.0.2</font></div><div><font size="2"   >root@172.17.0.2's password:&nbsp;</font></div><div><font size="2"   >Last login: Tue Dec &nbsp;9 16:13:47 2014 from 172.17.42.1</font></div><div><div><font size="2"   >[root@mon1 ~]# ceph-mon --mkfs -i mon4 --monmap /tmp/monmap --keyring /tmp/ceph.mon.keyring&nbsp;</font></div><div><font size="2"   >ceph-mon: set fsid to f649b128-963c-4802-ae17-5a76f36c4c76</font></div><div><font size="2"   >ceph-mon: created monfs at /var/lib/ceph/mon/ceph-mon4 for mon.mon4</font></div><div><font size="2"   >[root@mon1 ~]# ceph-mon --mkfs -i mon5 --monmap /tmp/monmap --keyring /tmp/ceph.mon.keyring&nbsp;</font></div><div><font size="2"   >ceph-mon: set fsid to f649b128-963c-4802-ae17-5a76f36c4c76</font></div><div><font size="2"   >ceph-mon: created monfs at /var/lib/ceph/mon/ceph-mon5 for mon.mon5</font></div></div><p></p></pre></div><div>创建完拷贝到新加节点的对应目录即可.</div><div><br></div><div>在本地生成的方法 :&nbsp;</div><div>1. 首选要将配置拷贝到新节点 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@mon1 ~]# scp /etc/ceph/ceph.conf /etc/ceph/ceph.client.admin.keyring 172.17.0.9:/etc/ceph</font></div><div><font size="2"   >[root@mon1 ~]# scp /etc/ceph/ceph.conf /etc/ceph/ceph.client.admin.keyring 172.17.0.10:/etc/ceph</font></div><p></p></pre></div><div>2. 接收KEY</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@mon4 ~]# ceph auth get mon. -o /tmp/key</font></div><div><font size="2"   >exported keyring for mon.</font></div></div><div><div><font size="2"   >[root@mon5 ~]# ceph auth get mon. -o /tmp/key</font></div><div><font size="2"   >exported keyring for mon.</font></div></div><p></p></pre></div><div>3. 接收cluster map信息</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@mon4 ~]# ceph mon getmap -o /tmp/map</font></div><div><font size="2"   >got monmap epoch 1</font></div></div><div><div><font size="2"   >[root@mon5 ~]# ceph mon getmap -o /tmp/map</font></div><div><font size="2"   >got monmap epoch 1</font></div></div><p></p></pre></div><div>4. 生成数据目录文件</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@mon4 ~]# ceph-mon -i mon4 --mkfs --monmap /tmp/map --keyring /tmp/key --mon-data /data01/ceph/mon/ceph-4</font></div><div><font size="2"   >ceph-mon: set fsid to f649b128-963c-4802-ae17-5a76f36c4c76</font></div><div><font size="2"   >ceph-mon: created monfs at /data01/ceph/mon/ceph-4 for mon.mon4</font></div></div><div><div><font size="2"   >[root@mon5 ~]# ceph-mon -i mon5 --mkfs --monmap /tmp/map --keyring /tmp/key --mon-data /data01/ceph/mon/ceph-5</font></div><div><font size="2"   >ceph-mon: set fsid to f649b128-963c-4802-ae17-5a76f36c4c76</font></div><div><font size="2"   >ceph-mon: created monfs at /data01/ceph/mon/ceph-5 for mon.mon5</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   ># ceph-mon --help</font></div><div><font size="2"   >usage: ceph-mon -i monid [flags]</font></div><div><font size="2"   >&nbsp; --debug_mon n</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; debug monitor level (e.g. 10)</font></div><div><font size="2"   >&nbsp; --mkfs</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; build fresh monitor fs</font></div><div><font size="2"   >&nbsp; --force-sync</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; force a sync from another mon by wiping local data (BE CAREFUL)</font></div><div><font size="2"   >&nbsp; --yes-i-really-mean-it</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; mandatory safeguard for --force-sync</font></div><div><font size="2"   >&nbsp; --compact</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; compact the monitor store</font></div><div><font size="2"   >&nbsp; --osdmap &lt;filename&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; only used when --mkfs is provided: load the osdmap from &lt;filename&gt;</font></div><div><font size="2"   >&nbsp; --inject-monmap &lt;filename&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; write the &lt;filename&gt; monmap to the local monitor store and exit</font></div><div><font size="2"   >&nbsp; --extract-monmap &lt;filename&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; extract the monmap from the local monitor store and exit</font></div><div><font size="2"   >&nbsp; --mon-data &lt;directory&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; where the mon store and keyring are located</font></div><div><font size="2"   >&nbsp; --conf/-c FILE &nbsp; &nbsp;read configuration from the given configuration file</font></div><div><font size="2"   >&nbsp; --id/-i ID &nbsp; &nbsp; &nbsp; &nbsp;set ID portion of my name</font></div><div><font size="2"   >&nbsp; --name/-n TYPE.ID set name</font></div><div><font size="2"   >&nbsp; --cluster NAME &nbsp; &nbsp;set cluster name (default: ceph)</font></div><div><font size="2"   >&nbsp; --version &nbsp; &nbsp; &nbsp; &nbsp; show version and quit</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; -d &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;run in foreground, log to stderr.</font></div><div><font size="2"   >&nbsp; -f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;run in foreground, log to usual location.</font></div><div><font size="2"   >&nbsp; --debug_ms N &nbsp; &nbsp; &nbsp;set message debug level (e.g. 1)</font></div></div><p></p></pre></div><div><br></div><div>5. 添加新增节点(在任意节点添加一次即可).</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@mon4 ~]# ceph mon add mon4 172.17.0.9</font></div><div><font size="2"   >port defaulted to 6789; added mon.mon4 at 172.17.0.9:6789/0</font></div><div><font size="2"   >[root@mon4 ~]# ceph mon add mon5 172.17.0.10</font></div><div><font size="2"   >port defaulted to 6789; added mon.mon5 at 172.17.0.10:6789/0</font></div><p></p></pre></div><div><br></div><div>启动mon</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@mon4 ~]# ceph-mon -i mon4 --public-addr 172.17.0.9 --mon-data /data01/ceph/mon/ceph-4</font></div><div><font size="2"   >[root@mon4 ~]# ps -ewf|grep ceph</font></div><div><font size="2"   >root &nbsp; &nbsp; &nbsp; &nbsp; 223 &nbsp; &nbsp; &nbsp; 1 &nbsp;3 17:45 pts/0 &nbsp; &nbsp;00:00:00 ceph-mon -i mon4 --public-addr 172.17.0.9 --mon-data /data01/ceph/mon/ceph-4</font></div><div><font size="2"   >root &nbsp; &nbsp; &nbsp; &nbsp; 254 &nbsp; &nbsp; &nbsp;27 &nbsp;0 17:45 pts/0 &nbsp; &nbsp;00:00:00 grep --color=auto ceph</font></div></div><div><div><font size="2"   >[root@mon5 ~]# ceph-mon -i mon5 --public-addr 172.17.0.10 --mon-data /data01/ceph/mon/ceph-5</font></div><div><font size="2"   >[root@mon5 ~]# ps -ewf|grep ceph</font></div><div><font size="2"   >root &nbsp; &nbsp; &nbsp; &nbsp; 127 &nbsp; &nbsp; &nbsp; 1 &nbsp;2 17:45 pts/0 &nbsp; &nbsp;00:00:00 ceph-mon -i mon5 --public-addr 172.17.0.10 --mon-data /data01/ceph/mon/ceph-5</font></div><div><font size="2"   >root &nbsp; &nbsp; &nbsp; &nbsp; 160 &nbsp; &nbsp; &nbsp;28 &nbsp;0 17:45 pts/0 &nbsp; &nbsp;00:00:00 grep --color=auto ceph</font></div></div><p></p></pre></div><div>启动加入/etc/rc.local (注意centos7需要添加文件的执行权限chmod +x /etc/rc.d/rc.local)</div><div><br></div><div>查看集群状态, 可以看到新增的mon节点信息 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@mon5 ~]# ceph -s</font></div><div><font size="2"   >&nbsp; &nbsp; cluster f649b128-963c-4802-ae17-5a76f36c4c76</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;health HEALTH_OK</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;monmap e3: 5 mons at {mon1=172.17.0.2:6789/0,mon2=172.17.0.3:6789/0,mon3=172.17.0.4:6789/0,mon4=172.17.0.9:6789/0,mon5=172.17.0.10:6789/0}, election epoch 14, quorum 0,1,2,3,4 mon1,mon2,mon3,mon4,mon5</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;osdmap e29: 4 osds: 4 up, 4 in</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; pgmap v265: 128 pgs, 1 pools, 0 bytes data, 0 objects</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 39588 MB used, 1597 GB / 1636 GB avail</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;128 active+clean</font></div><p></p></pre></div><div><br></div><div>最后, 建议修改所有mon节点的配置文件, 将新增的mon节点信息加进去.</div><div><span style="line-height: 28px;"   >(修改ceph.conf只是为了好看, 其实mon节点之间是通过monmap来发现其他mon节点的, 所以配置文件不是必须的)</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@xxxxxxxxxxxx ~]# cat /etc/ceph/ceph.conf&nbsp;</font></div><div><font size="2"   >.... 如下 :&nbsp;</font></div><div><font size="2"   >mon initial members = mon1, mon2, mon3, mon4, mon5</font></div><div><font size="2"   >mon host = 172.17.0.2, 172.17.0.3, 172.17.0.4,&nbsp;<span style="line-height: 28px;"   >172.17.0.9,&nbsp;</span><span style="line-height: 28px;"   >172.17.0.10</span></font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://docs.ceph.com/docs/master/rados/operations/add-or-rm-mons/"   >http://docs.ceph.com/docs/master/rados/operations/add-or-rm-mons/</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201410269169450/"   >http://blog.163.com/digoal@126/blog/static/163877040201410269169450/</a></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="ceph - adding A monitor (MANUAL) - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>