<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Docker export import containers, save load images, commit containers, docker images tree</h2>
	<h5 id="">2014-12-05 14:28:10&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201411514759357/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>本文讨论一下与docker镜像相关的几个接口.</div><div>制作镜像相关 :&nbsp;</div><div>使用dockerfile制作一个sshd镜像</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014102711413675/"   >http://blog.163.com/digoal@126/blog/static/1638770402014102711413675/</a></div><div>从container制作镜像(使用docker commit)</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014923112924656/"   >http://blog.163.com/digoal@126/blog/static/1638770402014923112924656/</a></div><div>制作base镜像</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201410443845799/"   >http://blog.163.com/digoal@126/blog/static/163877040201410443845799/</a></div><div><br></div><div>另外Docker还可以导出container到一个文件(docker export)</div><div>将文件导入成为镜像<span style="line-height: 28px;"   >(docker import)</span><span style="line-height: 28px;"   >.</span></div><div><br></div><div>同时还支持导出已有镜像到一个文件,<span style="line-height: 28px;"   >(docker save)</span></div><div>将镜像导入<span style="line-height: 28px;"   >(docker load)</span><span style="line-height: 28px;"   >.</span></div><div><br></div><div>使用举例 :&nbsp;</div><div>save镜像, load to image :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >查看镜像</font></div><div><div><font size="2"   >[root@db-172-16-3-221 ~]# docker images</font></div><div><font size="2"   >REPOSITORY &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TAG &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IMAGE ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;CREATED &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; VIRTUAL SIZE</font></div><div><font size="2"   >registry &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0.8.1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3e7767ddd728 &nbsp; &nbsp; &nbsp; &nbsp;5 weeks ago &nbsp; &nbsp; &nbsp; &nbsp; 427.9 MB</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >导出到一个tar文件</font></div><div><div><font size="2"   >[root@db-172-16-3-221 ~]# docker save -o ./registry.tar 3e7767ddd728</font></div><div><span style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-221 ~]# ll -h registry.tar&nbsp;</font></span></div><div><font size="2"   >-rw-r--r-- 1 root root 427M Dec &nbsp;5 14:09 registry.tar</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >将tar文件拷贝到另一台主机</font></div><div><font size="2"   >[root@db-172-16-3-221 ~]# scp registry.tar 172.16.3.150:/opt/soft_bak/</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >在另一台主机导入</font></div><div><font size="2"   >[root@localhost soft_bak]# docker load -i /opt/soft_bak/registry.tar</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >导入后未命名</font></div><div><font size="2"   >[root@localhost soft_bak]# docker images</font></div><div><font size="2"   >&lt;none&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;none&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3e7767ddd728 &nbsp; &nbsp; &nbsp; &nbsp;5 weeks ago &nbsp; &nbsp; &nbsp; &nbsp; 427.9 MB</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >打上tag</font></div><div><font size="2"   >[root@localhost soft_bak]# docker tag 3e7767ddd728 digoal/registry</font></div><div><span style="line-height: 28px;"   ><font size="2"   >[root@localhost soft_bak]# docker images</font></span></div><div><font size="2"   >digoal/registry &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; latest &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3e7767ddd728 &nbsp; &nbsp; &nbsp; &nbsp;5 weeks ago &nbsp; &nbsp; &nbsp; &nbsp; 427.9 MB</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >参考以下方法使用刚才load进来的image创建一个私有registry.</font></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201410393931894/"   ><font size="2"   >http://blog.163.com/digoal@126/blog/static/163877040201410393931894/</font></a></div><div><div><font size="2"   >[root@localhost registry_conf]# docker run -d --net="host" -p 5000:5000 -v /data01/registry_conf:/registory_conf -v /data01/registry_sto:/registry_sto -e DOCKER_REGISTRY_CONFIG=/registory_conf/config_sample.yml -e STORAGE_PATH=/registry_sto -e SETTINGS_FLAVOR=local --name=registry &nbsp;digoal/registry</font></div><div><font size="2"   >ea75c68e44b68d186b1551a6ddc8b70b1b0a39179ca28166eacd1be5751f7b27</font></div><div><font size="2"   >[root@localhost registry_conf]#&nbsp;</font></div><div><font size="2"   >[root@localhost registry_conf]# docker ps</font></div><div><font size="2"   >CONTAINER ID &nbsp; &nbsp; &nbsp; &nbsp;IMAGE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;COMMAND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;CREATED &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; STATUS &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PORTS &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NAMES</font></div><div><font size="2"   >ea75c68e44b6 &nbsp; &nbsp; &nbsp; &nbsp;digoal/registry:latest &nbsp; "/bin/sh -c 'exec do &nbsp; 3 seconds ago &nbsp; &nbsp; &nbsp; Up 2 seconds &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;registry &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >export container, import to image :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 28px;"   ><font size="2"   >查看当前正在运行或已经停止的container</font></span></div><div><div><font size="2"   >[root@localhost registry_conf]# docker ps -a</font></div><div><font size="2"   >CONTAINER ID &nbsp; &nbsp; &nbsp; &nbsp;IMAGE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;COMMAND &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;CREATED &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; STATUS &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PORTS &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NAMES</font></div><div><font size="2"   >ea75c68e44b6 &nbsp; &nbsp; &nbsp; &nbsp;digoal/registry:latest &nbsp; "/bin/sh -c 'exec do &nbsp; 4 minutes ago &nbsp; &nbsp; &nbsp; Up 4 minutes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;registry &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >4c098166cc5d &nbsp; &nbsp; &nbsp; &nbsp;digoal/sshd:latest &nbsp; &nbsp; &nbsp; "/usr/sbin/sshd -D" &nbsp; &nbsp;7 days ago &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Exited (0) 28 hours ago &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; osd4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >f6df72b9780f &nbsp; &nbsp; &nbsp; &nbsp;digoal/sshd:latest &nbsp; &nbsp; &nbsp; "/usr/sbin/sshd -D" &nbsp; &nbsp;7 days ago &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Exited (0) 28 hours ago &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; osd3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >02d922ce295b &nbsp; &nbsp; &nbsp; &nbsp;digoal/sshd:latest &nbsp; &nbsp; &nbsp; "/usr/sbin/sshd -D" &nbsp; &nbsp;7 days ago &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Exited (0) 28 hours ago &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; osd2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >59c41fc9560e &nbsp; &nbsp; &nbsp; &nbsp;digoal/sshd:latest &nbsp; &nbsp; &nbsp; "/usr/sbin/sshd -D" &nbsp; &nbsp;7 days ago &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Exited (0) 28 hours ago &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; deploy &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >34a7ceefcfd3 &nbsp; &nbsp; &nbsp; &nbsp;digoal/sshd:latest &nbsp; &nbsp; &nbsp; "/usr/sbin/sshd -D" &nbsp; &nbsp;7 days ago &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Exited (0) 28 hours ago &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; osd1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >9c9391eb3e1a &nbsp; &nbsp; &nbsp; &nbsp;digoal/sshd:latest &nbsp; &nbsp; &nbsp; "/usr/sbin/sshd -D" &nbsp; &nbsp;7 days ago &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Exited (0) 28 hours ago &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mon3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >5de0fae0d8bd &nbsp; &nbsp; &nbsp; &nbsp;digoal/sshd:latest &nbsp; &nbsp; &nbsp; "/usr/sbin/sshd -D" &nbsp; &nbsp;7 days ago &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Exited (0) 28 hours ago &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mon2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >fa24ec5115f6 &nbsp; &nbsp; &nbsp; &nbsp;digoal/sshd:latest &nbsp; &nbsp; &nbsp; "/usr/sbin/sshd -D" &nbsp; &nbsp;7 days ago &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Exited (0) 28 hours ago &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mon1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >使用docker export将container到处到tar文件</font></div><div><font size="2"   >[root@localhost registry_conf]# docker export deploy &gt; ./sshd.tar</font></div><div><font size="2"   >[root@localhost registry_conf]# ll -h sshd.tar&nbsp;</font></div><div><font size="2"   >-rw-r--r-- 1 root root 606M Dec &nbsp;5 22:20 sshd.tar</font></div><div><font size="2"   >使用docker import导入</font></div><div><font size="2"   >[root@localhost registry_conf]# cat sshd.tar | docker import - digoal/sshd_deploy</font></div><div><font size="2"   >9110f1eb1ce1e95285e9b0daa7451e7de5165e350df8289aa92a36cacf499bcc</font></div><div><font size="2"   >查看导入的镜像</font></div><div><font size="2"   >[root@localhost registry_conf]# docker images digoal/*</font></div><div><font size="2"   >REPOSITORY &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TAG &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IMAGE ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;CREATED &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; VIRTUAL SIZE</font></div><div><font size="2"   >digoal/sshd_deploy &nbsp; latest &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;9110f1eb1ce1 &nbsp; &nbsp; &nbsp; &nbsp;19 seconds ago &nbsp; &nbsp; &nbsp;620.4 MB</font></div><div><font size="2"   >digoal/sshd &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;latest &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3e5d8edfaeee &nbsp; &nbsp; &nbsp; &nbsp;8 days ago &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;298.1 MB</font></div><div><font size="2"   >digoal/registry &nbsp; &nbsp; &nbsp;latest &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3e7767ddd728 &nbsp; &nbsp; &nbsp; &nbsp;5 weeks ago &nbsp; &nbsp; &nbsp; &nbsp; 427.9 MB</font></div><div><font size="2"   >使用导入的镜像, 创建一个容器</font></div><div><font size="2"   >[root@localhost registry_conf]# docker run -t -i --rm digoal/sshd_deploy /bin/bash</font></div><div><font size="2"   >容器中安装的软件仍在, 所以在容器中的改变都被打包到镜像了, 和docker commit制作的镜像类似.</font></div><div><font size="2"   >[root@1a3adda5d7b9 /]# rpm -qa|grep deploy</font></div><div><font size="2"   >ceph-deploy-1.5.20-0.noarch</font></div><div><font size="2"   >ph-deploy</font></div><div><font size="2"   >[root@1a3adda5d7b9 /]# cd /var/lib/ceph/</font></div><div><font size="2"   >[root@1a3adda5d7b9 ceph]# ll</font></div><div><font size="2"   >total 24</font></div><div><font size="2"   >drwxr-xr-x 2 root root 4096 Oct 29 18:35 bootstrap-mds</font></div><div><font size="2"   >drwxr-xr-x 2 root root 4096 Oct 29 18:35 bootstrap-osd</font></div><div><font size="2"   >drwxr-xr-x 2 root root 4096 Oct 29 18:35 mds</font></div><div><font size="2"   >drwxr-xr-x 2 root root 4096 Oct 29 18:35 mon</font></div><div><font size="2"   >drwxr-xr-x 2 root root 4096 Oct 29 18:35 osd</font></div><div><font size="2"   >drwxr-xr-x 2 root root 4096 Oct 29 18:35 tmp</font></div></div><p></p></pre></div><div><div><br></div></div><div>最后docker镜像查看还支持tree输出. 可以列出镜像之间的关系.</div><div>例如digoal/postgresql:9.3.5是使用centos:centos6镜像制作的, 所以打印出了继承关系</div><div>还有很多未命名的, 是制作镜像时使用RUN产生的中间镜像.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@localhost registry_conf]# docker images -a --tree</font></div><div><font size="2"   >Warning: '--tree' is deprecated, it will be removed soon. See usage.</font></div></div><div><div><font size="2"   >&nbsp; └─5b12ef8fd570 Virtual Size: 0 B</font></div><div><font size="2"   >&nbsp; &nbsp; ├─192178b11d36 Virtual Size: 466.9 MB Tags: centos:centos5</font></div><div><font size="2"   >&nbsp; &nbsp; ├─70441cac1ed5 Virtual Size: 215.8 MB Tags: centos:centos6</font></div><div><font size="2"   >&nbsp; &nbsp; │ └─d70b9ae9e9ff Virtual Size: 330.3 MB Tags: 172.16.3.221:5000/digoal/postgresql:9.3.5</font></div><div><font size="2"   >&nbsp; &nbsp; └─ae0c2d0bdc10 Virtual Size: 224 MB Tags: centos:centos7</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; └─3c5e418bb4b1 Virtual Size: 224 MB</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; └─c48a513d5431 Virtual Size: 298.1 MB</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; └─e61b7a8bb4d9 Virtual Size: 298.1 MB</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; └─8ed4d6eb45c1 Virtual Size: 298.1 MB</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; └─ecb67638a0df Virtual Size: 298.1 MB</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; └─2b73dfeaebf1 Virtual Size: 298.1 MB</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; └─6e0fcfed929b Virtual Size: 298.1 MB</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; └─3e5d8edfaeee Virtual Size: 298.1 MB Tags: digoal/sshd:latest</font></div></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://tuhrig.de/difference-between-save-and-export-in-docker/"   >http://tuhrig.de/difference-between-save-and-export-in-docker/</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://tuhrig.de/flatten-a-docker-container-or-image/"   >http://tuhrig.de/flatten-a-docker-container-or-image/</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.jamescoyle.net/how-to/1512-export-and-import-a-docker-image-between-nodes"   >http://www.jamescoyle.net/how-to/1512-export-and-import-a-docker-image-between-nodes</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="Docker export import containers, save load images, commit containers, docker images tree - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>