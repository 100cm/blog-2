<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">use cgroup blkio resource control limit throttle</h2>
	<h5 id="">2014-12-03 16:39:00&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201411341949278/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>本文将测试一下使用cgroup的blkio组来控制IO吞吐量 :&nbsp;</div><div>测试环境CentOS 7.x x64</div><div>创建一个继承组</div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 21px;"   >[root@150 rg1]# cd /sys/fs/cgroup/blkio/<br>[root@150 blkio]# mkdir rg1</span></font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >继承组自动创建对应的限制文件</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 21px;"   >[root@150 blkio]# cd rg1<br>[root@150 rg1]# ll<br>total 0<br>-r--r--r-- 1 root root 0 Dec  4 00:26 blkio.io_merged<br>-r--r--r-- 1 root root 0 Dec  4 00:26 blkio.io_merged_recursive<br>-r--r--r-- 1 root root 0 Dec  4 00:26 blkio.io_queued<br>-r--r--r-- 1 root root 0 Dec  4 00:26 blkio.io_queued_recursive<br>-r--r--r-- 1 root root 0 Dec  4 00:26 blkio.io_service_bytes<br>-r--r--r-- 1 root root 0 Dec  4 00:26 blkio.io_service_bytes_recursive<br>-r--r--r-- 1 root root 0 Dec  4 00:26 blkio.io_serviced<br>-r--r--r-- 1 root root 0 Dec  4 00:26 blkio.io_serviced_recursive<br>-r--r--r-- 1 root root 0 Dec  4 00:26 blkio.io_service_time<br>-r--r--r-- 1 root root 0 Dec  4 00:26 blkio.io_service_time_recursive<br>-r--r--r-- 1 root root 0 Dec  4 00:26 blkio.io_wait_time<br>-r--r--r-- 1 root root 0 Dec  4 00:26 blkio.io_wait_time_recursive<br>-rw-r--r-- 1 root root 0 Dec  4 00:26 blkio.leaf_weight<br>-rw-r--r-- 1 root root 0 Dec  4 00:26 blkio.leaf_weight_device<br>--w------- 1 root root 0 Dec  4 00:26 blkio.reset_stats<br>-r--r--r-- 1 root root 0 Dec  4 00:26 blkio.sectors<br>-r--r--r-- 1 root root 0 Dec  4 00:26 blkio.sectors_recursive<br>-r--r--r-- 1 root root 0 Dec  4 00:26 blkio.throttle.io_service_bytes<br>-r--r--r-- 1 root root 0 Dec  4 00:26 blkio.throttle.io_serviced<br>-rw-r--r-- 1 root root 0 Dec  4 00:29 blkio.throttle.read_bps_device<br>-rw-r--r-- 1 root root 0 Dec  4 00:26 blkio.throttle.read_iops_device<br>-rw-r--r-- 1 root root 0 Dec  4 00:26 blkio.throttle.write_bps_device<br>-rw-r--r-- 1 root root 0 Dec  4 00:26 blkio.throttle.write_iops_device<br>-r--r--r-- 1 root root 0 Dec  4 00:26 blkio.time<br>-r--r--r-- 1 root root 0 Dec  4 00:26 blkio.time_recursive<br>-rw-r--r-- 1 root root 0 Dec  4 00:26 blkio.weight<br>-rw-r--r-- 1 root root 0 Dec  4 00:26 blkio.weight_device<br>-rw-r--r-- 1 root root 0 Dec  4 00:26 cgroup.clone_children<br>--w--w--w- 1 root root 0 Dec  4 00:26 cgroup.event_control<br>-rw-r--r-- 1 root root 0 Dec  4 00:26 cgroup.procs<br>-rw-r--r-- 1 root root 0 Dec  4 00:26 notify_on_release<br>-rw-r--r-- 1 root root 0 Dec  4 00:27 tasks</span></font></div><p></p></pre></div><div>继承组的tasks为空.</div><div><br></div><div>找一个块设备作为测试目标, 注意现在只能控制块设备, 不能控制单个分区.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@150 ~]# df -h</font></div><div><font size="2"   >Filesystem &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Size &nbsp;Used Avail Use% Mounted on</font></div><div><font size="2"   >/dev/sda1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 40G &nbsp;2.0G &nbsp; 38G &nbsp; 6% /</font></div><div><font size="2"   >devtmpfs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;48G &nbsp; &nbsp; 0 &nbsp; 48G &nbsp; 0% /dev</font></div><div><font size="2"   >tmpfs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 48G &nbsp; &nbsp; 0 &nbsp; 48G &nbsp; 0% /dev/shm</font></div><div><font size="2"   >tmpfs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 48G &nbsp; 25M &nbsp; 48G &nbsp; 1% /run</font></div><div><font size="2"   >tmpfs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 48G &nbsp; &nbsp; 0 &nbsp; 48G &nbsp; 0% /sys/fs/cgroup</font></div><div><font size="2"   >/dev/sda3 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 95G &nbsp;2.8G &nbsp; 87G &nbsp; 4% /opt</font></div><p></p></pre></div><div><div style="line-height: 28px;"   >例如我这里要控制/dev/sda这个块设备 :&nbsp;</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@150 opt]# ll /dev/sda</font></div><div style="line-height: 28px;"   ><font size="2"   >brw-rw---- 1 root disk 8, 0 Nov 27 19:03 /dev/sda</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br></div></div><div style="line-height: 28px;"   >将文件写入/dev/sda的一个文件系统中.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@150 rg1]# cd /opt</font></div><div><font size="2"   >[root@150 opt]# dd if=/dev/zero of=./test.img bs=1k count=102400&nbsp;</font></div><div><font size="2"   >102400+0 records in</font></div><div><font size="2"   >102400+0 records out</font></div><div><font size="2"   >104857600 bytes (105 MB) copied, 0.350907 s, 299 MB/s</font></div><p></p></pre></div><div>直接从块设备读取到/dev/null, 不限制的话, 速度是14MB/S</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@150 opt]# dd if=./test.img of=/dev/null bs=1k count=102400 iflag=direct</font></div><div><font size="2"   >102400+0 records in</font></div><div><font size="2"   >102400+0 records out</font></div><div><font size="2"   >104857600 bytes (105 MB) copied, 7.43936 s, 14.1 MB/s</font></div><p></p></pre></div><div><br></div><div><div style="line-height: 28px;"   >限制读吞吐量是1MB/s :&nbsp;</div><div><div><pre class="prettyprint"   ><p style="line-height: 28px;"   ></p><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >- Specify a bandwidth rate on particular device for root group. The format</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; for policy is "&lt;major&gt;:&lt;minor&gt; &nbsp;&lt;bytes_per_second&gt;".</font></div></div><div style="line-height: 28px;"   ><font size="2"   >[root@150 opt]# echo "8:0 &nbsp;1048576" &gt; /sys/fs/cgroup/blkio/rg1/blkio.throttle.read_bps_device</font></div><div style="line-height: 28px;"   ><font size="2"   >将当前shell PID放到该组中</font></div><div><font size="2"   >[root@150 opt]# echo $$ &gt; /sys/fs/cgroup/blkio/rg1/tasks</font></div><p style="line-height: 28px;"   ></p></pre></div></div></div><div style="line-height: 28px;"   >再次读取, 速度被限制到1MB/S</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@150 opt]# dd if=./test.img of=/dev/null bs=1k count=102400 iflag=direct</font></div><div><font size="2"   >102400+0 records in</font></div><div><font size="2"   >102400+0 records out</font></div><div><font size="2"   >104857600 bytes (105 MB) copied, 100.001 s, 1.0 MB/s</font></div><p></p></pre></div></div><div><br></div><div>清除限制</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@150 opt]# echo "8:0 &nbsp;0" &gt; /sys/fs/cgroup/blkio/rg1/blkio.throttle.read_bps_device</font></div><div></div><p></p></pre></div><div>清除后速度恢复</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@150 opt]# dd if=./test.img of=/dev/null bs=1k count=102400 iflag=direct</font></div><div><font size="2"   >102400+0 records in</font></div><div><font size="2"   >102400+0 records out</font></div><div><font size="2"   >104857600 bytes (105 MB) copied, 7.32235 s, 14.3 MB/s</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://www.kernel.org/doc/Documentation/cgroups/blkio-controller.txt"   >https://www.kernel.org/doc/Documentation/cgroups/blkio-controller.txt</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014102653934376/"   >http://blog.163.com/digoal@126/blog/static/1638770402014102653934376/</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="use cgroup blkio resource control control throttle - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">larnsan@126 - 2015-05-22 16:36:56</h5>
				<div>这样是能限制，却只能在同步写情况下看到效果，生产环境你可以这样设置？</div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 larnsan@126 - 2015-05-22 16:36:56</h5>
				<div style="width:600px;">我们没有在生产中使用</div>
			</div>
	</div>
</div>
</body>
</html>