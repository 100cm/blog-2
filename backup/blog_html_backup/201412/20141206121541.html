<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Install OpenVSwitch into CentOS 7 userspace</h2>
	<h5 id="">2014-12-06 12:15:41&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402014116105640579/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>之前写过一篇较详细的CentOS 6下安装openvswitch的文章.</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020147111358858/"   >http://blog.163.com/digoal@126/blog/static/16387704020147111358858/</a></div><div>这里简单的介绍一下在centos 7下的安装, 其实差不多. 只是目前openvswitch没有针对CentOS7或rhel7的spec中, 只能生成userspace 安装包, 不能生成kmod包.</div><div>使用Docker加OpenVSwitch可以很方便的模拟一些应用场景, OpenVswitch相比bridge多了很多交换机的功能, 例如VLAN, GRE等等.</div><div><br></div><div>环境 :&nbsp;</div><div>CentOS 7</div><div>未开启selinux.</div><div><br></div><div>下载源码包</div><div><a target="_blank" rel="nofollow" href="http://openvswitch.org/download/"   >http://openvswitch.org/download/</a></div><div>当前版本 :&nbsp;</div><div><a target="_blank" rel="nofollow" href="http://openvswitch.org/releases/openvswitch-2.3.0.tar.gz"   >http://openvswitch.org/releases/openvswitch-2.3.0.tar.gz</a></div><div><br></div><div>安装详情请参考源码包中的<span style="line-height: 28px;"   >INSTALL.RHEL</span></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >1. 安装依赖包</span></div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div><div style="line-height: 28px;"   ><font size="2"   >[root@localhost openvswitch-2.3.0]# uname -r</font></div><div style="line-height: 28px;"   ><font size="2"   >3.10.0-123.el7.x86_64</font></div></div><div><div><font size="2"   >&nbsp; &nbsp;yum install -y gcc make python-devel openssl-devel graphviz \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;autoconf automake rpm-build redhat-rpm-config \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;libtool \</font></div></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;kernel-devel-3.10.0-123.el7.x86_64 &nbsp;kernel-debug-devel-3.10.0-123.el7.x86_64&nbsp;</font></div><p></p></pre></div></div><div>2. &nbsp;修复内核BUG. version为内核版本.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;cd /lib/modules/&lt;version&gt;</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >应该看到这个链接, 否则是内核BUG, 需要修复 :&nbsp;</span></div><pre class="prettyprint"   ><p></p><div><div><span style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx. &nbsp;1 root root &nbsp; &nbsp; 38 Nov 26 18:15 build -&gt; /usr/src/kernels/3.10.0-123.el7.x86_64</font></span></div></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >如果没有这个软链接, 那么需要修复如下 :&nbsp;</span></div></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;cd /lib/modules/&lt;version&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;rm build</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;ln -s /usr/src/kernels/&lt;target&gt; build</font></div><p></p></pre></div><div>3. &nbsp;创建rpmbuild源码目录</div><pre class="prettyprint"   ><p></p><div><font size="2"   >mkdir -p /root/rpmbuild/SOURCES</font></div><div></div><p></p></pre><div><span style="line-height: 28px;"   >4. 安装</span></div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost soft_bak]# cp openvswitch-2.3.0.tar.gz /root/rpmbuild/SOURCES/</font></div><div><font size="2"   >[root@localhost soft_bak]# cd openvswitch-2.3.0</font></div><p></p></pre></div><div>生成userspace rpm, 因为依赖kmod包, 但是kmod包又无法生成, 所以必须修改一下spec.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@localhost openvswitch-2.3.0]# sed 's/openvswitch-kmod, //g' rhel/openvswitch.spec &gt;rhel/openvswitch_no_kmod.spec</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@localhost openvswitch-2.3.0]# rpmbuild -bb --without check rhel/<span style="line-height: 28px;"   >openvswitch_no_kmod.spec</span></font></div></div><div><div><font size="2"   >[root@localhost x86_64]# ll /root/rpmbuild/RPMS/x86_64</font></div><div><font size="2"   >total 9488</font></div><div><font size="2"   >-rw-r--r-- 1 root root 2010312 Dec &nbsp;6 19:06 openvswitch-2.3.0-1.x86_64.rpm</font></div><div><font size="2"   >-rw-r--r-- 1 root root 7702836 Dec &nbsp;6 19:06 openvswitch-debuginfo-2.3.0-1.x86_64.rpm</font></div></div><p></p></pre></div></div><div><br></div><div>生成kernel module rpm, 失败.(有异常)</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@localhost openvswitch-2.3.0]# cp rhel/openvswitch-kmod.files /root/rpmbuild/SOURCES/</font></div><div><font size="2"   >[root@localhost openvswitch-2.3.0]# uname -r</font></div><div><font size="2"   >3.10.0-123.el7.x86_64</font></div></div><div><div><font size="2"   >[root@localhost openvswitch-2.3.0]#&nbsp;rpmbuild -bb \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -D "kversion 3.10.0-123.el7.x86_64" \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -D "kflavors default debug kdump" \ &nbsp;# 需删除debug, kdump内核选项才能编译, 但是照样编译错误</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rhel/openvswitch-kmod-rhel6.spec</font></div></div><div><font size="2"   >报错比较多</font></div><div><div><font size="2"   >In file included from /root/rpmbuild/BUILD/openvswitch-2.3.0/_default/../datapath/linux/compat/include/net/gre.h:10:0,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;from /root/rpmbuild/BUILD/openvswitch-2.3.0/_default/datapath/linux/vport-gre.c:44:</font></div><div><font size="2"   >include/net/gre.h: In function 'gre_handle_offloads':</font></div><div><font size="2"   >include/net/gre.h:42:2: error: implicit declaration of function 'iptunnel_handle_offloads' [-Werror=implicit-function-declaration]</font></div><div><font size="2"   >&nbsp; return iptunnel_handle_offloads(skb, gre_csum, SKB_GSO_GRE);</font></div><div><font size="2"   >&nbsp; ^</font></div><div><font size="2"   >include/net/gre.h:42:2: warning: return makes pointer from integer without a cast [enabled by default]</font></div><div><font size="2"   >cc1: some warnings being treated as errors</font></div><div><font size="2"   >make[2]: *** [/root/rpmbuild/BUILD/openvswitch-2.3.0/_default/datapath/linux/vport.o] Error 1</font></div><div><font size="2"   >make[2]: *** [/root/rpmbuild/BUILD/openvswitch-2.3.0/_default/datapath/linux/vport-gre.o] Error 1</font></div><div><font size="2"   >make[2]: *** [/root/rpmbuild/BUILD/openvswitch-2.3.0/_default/datapath/linux/datapath.o] Error 1</font></div><div><font size="2"   >make[1]: *** [_module_/root/rpmbuild/BUILD/openvswitch-2.3.0/_default/datapath/linux] Error 2</font></div><div><font size="2"   >make[1]: Leaving directory `/usr/src/kernels/3.10.0-123.el7.x86_64'</font></div><div><font size="2"   >make: *** [default] Error 2</font></div><div><font size="2"   >make: Leaving directory `/root/rpmbuild/BUILD/openvswitch-2.3.0/_default/datapath/linux'</font></div><div><font size="2"   >error: Bad exit status from /var/tmp/rpm-tmp.gf6noy (%build)</font></div></div><p></p></pre></div><div><br></div><div>安装userspace &nbsp;rpm</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@localhost x86_64]# rpm -ivh openvswitch-2.3.0-1.x86_64.rpm&nbsp;</font></div><div><font size="2"   >Preparing... &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;################################# [100%]</font></div><div><font size="2"   >Updating / installing...</font></div><div><font size="2"   >&nbsp; &nbsp;1:openvswitch-2.3.0-1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;################################# [100%]</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@localhost x86_64]# chkconfig --list openvswitch <br><br>Note: This output shows SysV services only and does not include native<br>      systemd services. SysV configuration data might be overridden by native<br>      systemd configuration.<br><br>      If you want to list systemd services use 'systemctl list-unit-files'.<br>      To see services enabled on particular target use<br>      'systemctl list-dependencies [target]'.<br><br>openvswitch     0:off   1:off   2:on    3:on    4:on    5:on    6:off</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@localhost x86_64]# service openvswitch status</font></div><div><font size="2"   >ovsdb-server is not running</font></div><div><font size="2"   >ovs-vswitchd is not running</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@localhost x86_64]# service openvswitch start</font></div><div><font size="2"   >Starting openvswitch (via systemctl): &nbsp;[ &nbsp;OK &nbsp;]</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@localhost x86_64]# ovs-vsctl show</font></div><div><font size="2"   >f345b7e3-fcb0-4ef3-8295-36d3ef69ceef</font></div><div><font size="2"   >&nbsp; &nbsp; ovs_version: "2.3.0"</font></div></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020147111358858/"   >http://blog.163.com/digoal@126/blog/static/16387704020147111358858/</a></div><div>2.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >openvswitch-2.3.0</font></div><div><font size="2"   >-rw-rw-r-- 1 ceph ceph &nbsp;22691 Aug 15 04:34 INSTALL</font></div><div><font size="2"   >-rw-rw-r-- 1 ceph ceph &nbsp; 3162 Aug 15 04:33 INSTALL.Debian</font></div><div><font size="2"   >-rw-rw-r-- 1 ceph ceph &nbsp; 3200 Aug 15 04:34 INSTALL.DPDK</font></div><div><font size="2"   >-rw-rw-r-- 1 ceph ceph &nbsp; 1862 Aug 15 04:34 INSTALL.Fedora</font></div><div><font size="2"   >-rw-rw-r-- 1 ceph ceph &nbsp; 2584 Aug 15 04:17 INSTALL.KVM</font></div><div><font size="2"   >-rw-rw-r-- 1 ceph ceph &nbsp; 2273 Oct 19 &nbsp;2013 INSTALL.Libvirt</font></div><div><font size="2"   >-rw-rw-r-- 1 ceph ceph &nbsp; 1106 Aug 15 04:34 INSTALL.NetBSD</font></div><div><font size="2"   >-rw-rw-r-- 1 ceph ceph &nbsp; 4886 Aug 15 04:34 INSTALL.RHEL</font></div><div><font size="2"   >-rw-rw-r-- 1 ceph ceph &nbsp;12806 Aug 15 04:28 INSTALL.SSL</font></div><div><font size="2"   >-rw-rw-r-- 1 ceph ceph &nbsp; 3101 Jul 14 18:28 INSTALL.userspace</font></div><div><font size="2"   >-rw-rw-r-- 1 ceph ceph &nbsp; 7926 Aug 15 04:34 INSTALL.XenServer</font></div><p></p></pre></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="Install OpenVSwitch into CentOS 7 userspace - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>