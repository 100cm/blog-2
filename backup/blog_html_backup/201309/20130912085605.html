<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">systemtap probe point's "context variables" or "target variables"</h2>
	<h5 id="">2013-09-12 8:56:05&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020138113455697/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>在systemtap language reference手册的第三章有这么一段话 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >The probe handler is interpreted relative to the context of each event. For events associated with kernel code, this context may include variables defined in the source code at that location. These target variables (or ``context variables'') are presented to the script as variables whose names are prefixed with a dollar sign ($). They may be accessed only if the compiler used to compile the kernel preserved them, despite optimization. This is the same constraint imposed by a debugger when working with optimized code. Other events may have very little context.</font></p></pre></div><div>前面已经接触过类似的话题, 例如通过$$vars来输出probe points对应的target variables.</div><div>参考下文第二部分.</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201381044416754/"   >http://blog.163.com/digoal@126/blog/static/163877040201381044416754/</a></div><div>本文将对context variables做一次详细的分析. 主要来自stapprobes的man手册(本文末尾).</div><div>下面要介绍一下本文的测试事件例子.</div><div>用到的事件是kprocess.create</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -l 'kproce**'</font></div><div><font size="2"   >kprocess.create</font></div><p></p></pre></div><div>对应的函数</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# grep -r kprocess.create /usr/share/systemtap/</font></div><div><font size="2"   >/usr/share/systemtap/tapset/kprocess.stp: * probe kprocess.create - Fires whenever a new process or thread is successfully created</font></div><div><font size="2"   >/usr/share/systemtap/tapset/kprocess.stp:probe kprocess.create = kernel.function("copy_process").return {</font></div><p></p></pre></div><div>对应的代码</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -l 'kernel.function("copy_process")'</font></div><div><font size="2"   >kernel.function("copy_process@kernel/fork.c:1107")</font></div><p></p></pre></div><div>源文件如下</div><div><pre class="prettyprint"   ><p><font size="2"   >/usr/src/debug/kernel-2.6.18/linux-2.6.18-348.12.1.el5.x86_64/kernel/fork.c</font></p></pre></div><div>对应的函数如下(截取部分内容)</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >static struct task_struct *copy_process(unsigned long clone_flags,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; unsigned long stack_start,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; struct pt_regs *regs,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; unsigned long stack_size,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int __user *parent_tidptr,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int __user *child_tidptr,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; int pid)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int retval;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; struct task_struct *p = NULL;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp;... 略去部分内容</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"   >源文件中定义的全局变量如下, 在测试&nbsp;</span>@var("varname@src/file.c") 时用到</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* Protected counters by write_lock_irq(&amp;tasklist_lock)</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >unsigned long total_forks; &nbsp; &nbsp; &nbsp;/* Handle normal Linux uptimes. */</font></div><div><font size="2"   >int nr_threads; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* The idle threads do not count.. */</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >int max_threads; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* tunable limit on nr_threads */</font></div><p></p></pre></div><div><br></div><div>下面对手册中描述的用法举例说明.</div><div>1. $var, 这个很好理解, 就是输出probe point所在范围内的变量值. 如果是int类型的将输出64位数字, 如果是char *类型, 则可以使用kernel_string或者user_string函数输出该地址对应的字符串.</div><div>如果不是数字也不是字符串, 可以用@cast进行转换.</div><div>测试用到$pid. 它是int类型</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# cat test.stp&nbsp;</font></div><div><font size="2"   >probe kprocess.create {</font></div><div><font size="2"   >&nbsp; printf("%d\n", $pid)</font></div><div><font size="2"   >&nbsp; exit()</font></div><div><font size="2"   >}</font></div><div><font size="2"   >[root@db-172-16-3-39 ~]# stap test.stp&nbsp;</font></div><div><font size="2"   >18498</font></div><p></p></pre></div><div>字符串类型参考此文, 这里就不举例了.</div><div><a href="http://blog.163.com/digoal@126/blog/static/16387704020138352516878/"   >http://blog.163.com/digoal@126/blog/static/16387704020138352516878/</a></div><div><br></div><div>2.&nbsp;@var("varname") 与$var一样的效果.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# cat test.stp&nbsp;</font></div><div><font size="2"   >probe kprocess.create {</font></div><div><font size="2"   >&nbsp; printf("%d, %d\n", $pid, @var("pid"))</font></div><div><font size="2"   >&nbsp; exit()</font></div><div><font size="2"   >}</font></div><div><font size="2"   >[root@db-172-16-3-39 ~]# stap test.stp&nbsp;</font></div><div><font size="2"   >18756, 18756</font></div><p></p></pre></div><div>如果使用了一个不存在的本地变量, 那么会打印出可选的本地变量</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap --vp 5 test.stp&nbsp;</font></div><div><font size="2"   >Parsed kernel "/lib/modules/2.6.18-348.12.1.el5/build/.config", containing 1977 tuples</font></div><div><font size="2"   >Parsed kernel /lib/modules/2.6.18-348.12.1.el5/build/Module.symvers, which contained 3546 vmlinux exports</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 4, processed: 4</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/*.stp ", found: 81, processed: 81</font></div><div><font size="2"   >Pass 1: parsed user script and 85 library script(s) using 146808virt/23700res/3008shr/21404data kb, in 160usr/10sys/172real ms.</font></div><div><font size="2"   >semantic error: unable to find local 'current' near pc 0xffffffff8001f5c0 in copy_process kernel/fork.c ( (alternatives: $clone_flags $stack_start $regs $stack_size $parent_tidptr $child_tidptr $pid $retval $p): identifier '$current' at test.stp:2:20</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; source: &nbsp; printf("%d, \n", $current[1])</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"   >Pass 2: analysis failed. &nbsp;Try again with another '--vp 01' option.</font></div><p></p></pre></div><div><br></div><div>3.&nbsp;@var("varname@src/file.c")</div><div>输出事件触发时, 该源文件的全局变量的值.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# cat test.stp&nbsp;</font></div><div><font size="2"   >probe kprocess.create {</font></div><div><font size="2"   >&nbsp; printf("%d, %d\n", $pid, @var("pid"))</font></div><div><font size="2"   >&nbsp; printf("global variables in fork.c: %d, %d, %d\n", @var("max_threads@kernel/fork.c"), @var("total_forks@kernel/fork.c"), @var("nr_threads@kernel/fork.c"))</font></div><div><font size="2"   >&nbsp; exit()</font></div><div><font size="2"   >}</font></div><div><font size="2"   >[root@db-172-16-3-39 ~]# stap test.stp&nbsp;</font></div><div><font size="2"   >18896, 18896</font></div><div><font size="2"   >global variables in fork.c: 127569, 6473035, 254</font></div><p></p></pre></div><div>如果使用了一个不存在的全局变量, 会打印出可选的全局变量 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap --vp 5 test.stp&nbsp;</font></div><div><font size="2"   >Parsed kernel "/lib/modules/2.6.18-348.12.1.el5/build/.config", containing 1977 tuples</font></div><div><font size="2"   >Parsed kernel /lib/modules/2.6.18-348.12.1.el5/build/Module.symvers, which contained 3546 vmlinux exports</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 4, processed: 4</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/*.stp ", found: 81, processed: 81</font></div><div><font size="2"   >Pass 1: parsed user script and 85 library script(s) using 146872virt/23700res/3008shr/21468data kb, in 160usr/10sys/171real ms.</font></div><div><font size="2"   >semantic error: unable to find global 'current' in kernel/fork.c kernel/fork.c ( (alternatives: $console_printk $hex_asc $_cpu_pda $cpu_possible_map $cpu_online_map $mmu_cr4_features $boot_cpu_data $node_data $mp_ioapics $skip_ioapic_setup $cpu_callout_map $bios_cpu_apicid $memnode $mem_section $malloc_sizes $vm_area_cachep $files_cachep $fs_cachep $sighand_cachep $xtime $time_status $time_maxerror $time_esterror $time_adjust $leap_second $jiffies $per_cpu__rcu_data $per_cpu__rcu_bh_data $total_forks $nr_threads $per_cpu__process_counts $tasklist_lock $mmlist_lock $root_user $init_task $init_mm $vfsmount_lock $policy_zone $dcache_lock $irq_desc $mm_tracking_struct $init_level4_pgt $__supported_pte_mask $pgd_lock $pgd_list $protection_map $zone_table $per_cpu__vm_event_states $vm_stat $swapper_space $number_of_cpusets $mmap_min_addr $security_ops $swap_token_mm $anon_vma_cachep $ioport_resource $bad_dma_address $dma_ops $genl_sock $taskstats_cache $delayacct_on $delayacct_cache $idt_table $cpu_gdt_descr $max_threads $__crc_tasklist_lock $__kcrctab_tasklist_lock $__kstrtab_tasklist_lock $__ksymtab_tasklist_lock $mm_flags_hash $mm_flags_lock $task_struct_cachep $signal_cachep $mm_cachep $__crc_free_task $__kcrctab_free_task $__kstrtab_free_task $__ksymtab_free_task $__crc___put_task_struct $__kcrctab___put_task_struct $__kstrtab___put_task_struct $__ksymtab___put_task_struct $init_task_aux $default_dump_filter $__setup_str_coredump_filter_setup $__setup_coredump_filter_setup $__crc_mmput $__kcrctab_mmput $__kstrtab_mmput $__ksymtab_mmput $__crc_get_task_mm $__kcrctab_get_task_mm $__kstrtab_get_task_mm $__ksymtab_get_task_mm $__crc_copy_fs_struct $__kcrctab_copy_fs_struct $__kstrtab_copy_fs_struct $__ksymtab_copy_fs_struct $__crc_unshare_files $__kcrctab_unshare_files $__kstrtab_unshare_files $__ksymtab_unshare_files $console_printk $hex_asc $_cpu_pda $cpu_possible_map $cpu_online_map $mmu_cr4_features $boot_cpu_data $node_data $mp_ioapics $skip_ioapic_setup $cpu_callout_map $bios_cpu_apicid $memnode $mem_section $malloc_sizes $vm_area_cachep $files_cachep $fs_cachep $sighand_cachep $xtime $time_status $time_maxerror $time_esterror $time_adjust $leap_second $jiffies $per_cpu__rcu_data $per_cpu__rcu_bh_data $total_forks $nr_threads $per_cpu__process_counts $tasklist_lock $mmlist_lock $root_user $init_task $init_mm $vfsmount_lock $policy_zone $dcache_lock $irq_desc $mm_tracking_struct $init_level4_pgt $__supported_pte_mask $pgd_lock $pgd_list $protection_map $zone_table $per_cpu__vm_event_states $vm_stat $swapper_space $number_of_cpusets $mmap_min_addr $security_ops $swap_token_mm $anon_vma_cachep $ioport_resource $bad_dma_address $dma_ops $genl_sock $taskstats_cache $delayacct_on $delayacct_cache $idt_table $cpu_gdt_descr $max_threads $__crc_tasklist_lock $mm_flags_hash $mm_flags_lock $__crc_free_task $__crc___put_task_struct $__crc_mmput $__crc_get_task_mm $__crc_copy_fs_struct $__crc_unshare_files): identifier '@var' at test.stp:2:20</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; source: &nbsp; printf("%d, \n", @var("current@kernel/fork.c")[1])</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"   >Pass 2: analysis failed. &nbsp;Try again with another '--vp 01' option.</font></div><p></p></pre></div><div><br></div><div>4.&nbsp;$var-&gt;field</div><div>在源文件中除了数字和字符串, 还有其他类型, 例如结构, 指针等. 这些类型中的member或field可以通过$var-&gt;field来输出.</div><div>注意由于.点符号在systemtap中是字符串的连接符号, &nbsp;所以结构的member也使用-&gt;来表示, 而不是.点符号.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-39 ~]# cat test.stp&nbsp;</font></div><div><font size="2"   >probe kprocess.create {</font></div><div><font size="2"   >&nbsp; printf(".is string's concat operator : %s\n", "i" . " am digoal")</font></div><div><font size="2"   >&nbsp; exit()</font></div><div><font size="2"   >}</font></div></div><div><div><font size="2"   >[root@db-172-16-3-39 ~]# stap test.stp&nbsp;</font></div><div><font size="2"   >.is string's concat operator : i am digoal</font></div></div><p></p></pre></div><div>取结构中的数据,本例的copy_process的返回值类型为static struct task_struct *</div><div>结构中包含pid, wchar, rchar, utime等值, 下面stp脚本可以取到.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-39 ~]# cat test.stp</font></div><div><font size="2"   >probe kprocess.create {</font></div><div><font size="2"   >&nbsp; printf("pid:%d, pid:%d, rchar:%d, wchar:%d, utime:%d, mempolicy:%d\n", $pid, $return-&gt;pid, $return-&gt;rchar, $return-&gt;wchar, $return-&gt;utime, $return-&gt;mempolicy)</font></div><div><font size="2"   >&nbsp; exit()</font></div><div><font size="2"   >}</font></div></div><div><font size="2"   ><br></font></div><div><span style="line-height: 22px;"   ><font size="2"   >[root@db-172-16-3-39 ~]# stap test.stp&nbsp;</font></span></div><p></p></pre></div><div>然后开启一个进程.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[pg94@db-172-16-3-39 ~]$ psql</font></div><div><font size="2"   >psql (9.4devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=#&nbsp;</font></div><p></p></pre></div><div><span style="line-height: 22px;"   >可以看到 stap返回值 :&nbsp;</span></div><div><pre class="prettyprint"   ><p><font size="2"   >pid:7402, pid:7402, rchar:0, wchar:0, utime:0, mempolicy:0</font></p></pre></div><div><span style="line-height: 22px;"   >如果指定了一个结构中不存在的member, 那么会返回可选的member :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap --vp 5 test.stp&nbsp;</font></div><div><font size="2"   >Parsed kernel "/lib/modules/2.6.18-348.12.1.el5/build/.config", containing 1977 tuples</font></div><div><font size="2"   >Parsed kernel /lib/modules/2.6.18-348.12.1.el5/build/Module.symvers, which contained 3546 vmlinux exports</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 4, processed: 4</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/*.stp ", found: 81, processed: 81</font></div><div><font size="2"   >Pass 1: parsed user script and 85 library script(s) using 147760virt/23716res/3008shr/22356data kb, in 160usr/10sys/172real ms.</font></div><div><font size="2"   >semantic error: unable to find member 'p' for struct pt_regs (alternatives: r15 r14 r13 r12 rbp rbx r11 r10 r9 r8 rax rcx rdx rsi rdi orig_rax rip cs eflags rsp ss): operator '-&gt;' at test.stp:2:25</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; source: &nbsp; printf("%d, \n", $regs-&gt;p[1])</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^</font></div><div><font size="2"   >Pass 2: analysis failed. &nbsp;Try again with another '--vp 01' option.</font></div><p></p></pre></div><div><br></div><div>5. $return, 只有当被探测到函数有返回值时才有用, 上面的例子已经用到了.</div><div><br></div><div>6. $var[N], N是数字. 指函数中的数组变量.</div><div>例如这里用到的是/usr/src/debug/kernel-2.6.18/linux-2.6.18-348.12.1.el5.x86_64/net/ipv4/icmp.c 中的一个结构中包含的数组.</div><div><p></p><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >struct icmp_bxm {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; struct sk_buff *skb;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int offset;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int data_len;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; struct {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; struct icmphdr icmph;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; __u32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;times[3];</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; } data;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int head_len;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; struct ip_options replyopts;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; unsigned char &nbsp;optbuf[40];</font></div><div><font size="2"   >};</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >函数 :&nbsp;</font></div><div><font size="2"   >static void icmp_push_reply(struct icmp_bxm *icmp_param,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; struct ipcm_cookie *ipc, struct rtable *rt)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; struct sk_buff *skb;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (ip_append_data(icmp_socket-&gt;sk, icmp_glue_bits, icmp_param,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;icmp_param-&gt;data_len+icmp_param-&gt;head_len,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;icmp_param-&gt;head_len,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ipc, rt, MSG_DONTWAIT) &lt; 0)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ip_flush_pending_frames(icmp_socket-&gt;sk);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; else if ((skb = skb_peek(&amp;icmp_socket-&gt;sk-&gt;sk_write_queue)) != NULL) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; struct icmphdr *icmph = skb-&gt;h.icmph;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; unsigned int csum = 0;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; struct sk_buff *skb1;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; skb_queue_walk(&amp;icmp_socket-&gt;sk-&gt;sk_write_queue, skb1) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; csum = csum_add(csum, skb1-&gt;csum);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; csum = csum_partial_copy_nocheck((void *)&amp;icmp_param-&gt;data,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(char *)icmph,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;icmp_param-&gt;head_len, csum);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; icmph-&gt;checksum = csum_fold(csum);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; skb-&gt;ip_summed = CHECKSUM_NONE;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ip_push_pending_frames(icmp_socket-&gt;sk);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >}</font></div></div><p></p></pre></div><p></p></div><div>这个探针如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -l 'kernel.function("**")'|grep icmp_push_reply</font></div><div><font size="2"   >kernel.function("icmp_push_reply@net/ipv4/icmp.c:347")</font></div><p></p></pre></div><div>测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# cat test.stp&nbsp;</font></div><div><font size="2"   >probe kernel.function("icmp_push_reply@net/ipv4/icmp.c:347") {</font></div><div><font size="2"   >&nbsp; for (i=0; i&lt;$1; i++) {</font></div><div><font size="2"   >&nbsp; &nbsp; printf("%d, ", $icmp_param-&gt;data-&gt;times[i])</font></div><div><font size="2"   >&nbsp; }</font></div><div><font size="2"   >&nbsp; printf("end\n")</font></div><div><font size="2"   >&nbsp; exit()</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-39 ~]# stap --vp 5 test.stp 10</font></div><div><font size="2"   >Parsed kernel "/lib/modules/2.6.18-348.12.1.el5/build/.config", containing 1977 tuples</font></div><div><font size="2"   >Parsed kernel /lib/modules/2.6.18-348.12.1.el5/build/Module.symvers, which contained 3546 vmlinux exports</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 4, processed: 4</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/*.stp ", found: 81, processed: 81</font></div><div><font size="2"   >Pass 1: parsed user script and 85 library script(s) using 146796virt/23700res/3008shr/21392data kb, in 160usr/10sys/173real ms.</font></div><div><font size="2"   >WARNING: For probing a particular line, use a .statement() probe, not .function(): keyword at test.stp:1:1</font></div><div><font size="2"   >&nbsp;source: probe kernel.function("icmp_push_reply@net/ipv4/icmp.c:347") {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"   >2147839040, 4294967295, 2149938976, 8, 0, 0, 2, 2, 0, 0, end</font></div><p></p></pre></div><div><br></div><div>下半部分是操作符 :&nbsp;</div><div>1. $$vars</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-39 ~]# cat test.stp</font></div><div><font size="2"   >probe kernel.function("icmp_push_reply@net/ipv4/icmp.c:347") {</font></div><div><font size="2"   >&nbsp; printf("$$vars: %s\n", $$vars)</font></div><div><font size="2"   >&nbsp; printf("%x\n", $icmp_param)</font></div><div><font size="2"   >&nbsp; exit()</font></div><div><font size="2"   >}</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@db-172-16-3-39 ~]# stap --vp 5 test.stp</font></div><div><font size="2"   >Parsed kernel "/lib/modules/2.6.18-348.12.1.el5/build/.config", containing 1977 tuples</font></div><div><font size="2"   >Parsed kernel /lib/modules/2.6.18-348.12.1.el5/build/Module.symvers, which contained 3546 vmlinux exports</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 4, processed: 4</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/*.stp ", found: 81, processed: 81</font></div><div><font size="2"   >Pass 1: parsed user script and 85 library script(s) using 147760virt/23716res/3008shr/22356data kb, in 160usr/10sys/172real ms.</font></div><div><font size="2"   >WARNING: For probing a particular line, use a .statement() probe, not .function(): keyword at test.stp:1:1</font></div><div><font size="2"   >&nbsp;source: probe kernel.function("icmp_push_reply@net/ipv4/icmp.c:347") {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"   >$$vars: icmp_param=0xffff810133953dc8 ipc=0xffff810133953d68 rt=0xffff8101af062b40 skb=?</font></div><div><font size="2"   >ffff810133953dc8</font></div></div><p></p></pre></div><div>2. $$locals, $$parms, $$return 是从$$vars中分子出来的本地变量, 函数参数, 函数返回值.</div><div>3. 取变量地址.</div><pre class="prettyprint"   ><p></p><div><font size="2"   >&amp; $EXPR</font></div><div></div><p></p></pre><div><span style="line-height: 22px;"   >4. 判断变量是否存在.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >@defined($EXPR)</font></div><div><font size="2"   >@defined($foo-&gt;bar) ? $foo-&gt;bar : 0</font></div><p></p></pre></div><div>5. &nbsp; 输出结构包括第一层member的表达式.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; $EXPR$ expands to a string with all of $EXPR’s members, equivalent to</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sprintf("{.a=%i, .b=%u, .c={...}, .d=[...]}",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;$EXPR-&gt;a, $EXPR-&gt;b)</font></div><p></p></pre></div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# cat test.stp</font></div><div><font size="2"   >probe kernel.function("icmp_push_reply@net/ipv4/icmp.c:347") {</font></div><div><font size="2"   >&nbsp; printf("%s\n", $icmp_param$)</font></div><div><font size="2"   >&nbsp; exit()</font></div><div><font size="2"   >}</font></div><div><font size="2"   >[root@db-172-16-3-39 ~]# stap --vp 5 test.stp</font></div><div><font size="2"   >Parsed kernel "/lib/modules/2.6.18-348.12.1.el5/build/.config", containing 1977 tuples</font></div><div><font size="2"   >Parsed kernel /lib/modules/2.6.18-348.12.1.el5/build/Module.symvers, which contained 3546 vmlinux exports</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 4, processed: 4</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/*.stp ", found: 81, processed: 81</font></div><div><font size="2"   >Pass 1: parsed user script and 85 library script(s) using 146800virt/23704res/3008shr/21396data kb, in 170usr/10sys/172real ms.</font></div><div><font size="2"   >WARNING: For probing a particular line, use a .statement() probe, not .function(): keyword at test.stp:1:1</font></div><div><font size="2"   >&nbsp;source: probe kernel.function("icmp_push_reply@net/ipv4/icmp.c:347") {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"   >{.skb=0xffff8102207e1080, .offset=0, .data_len=56, .data={...}, .head_len=8, .replyopts={...}, .optbuf=[...]}</font></div><p></p></pre></div><div><br></div><div>6. &nbsp;输出结构包括所有层member的值的表达式.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;$EXPR$$</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; expands to a string with all of $var’s members and submembers, equivalent to</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sprintf("{.a=%i, .b=%u, .c={.x=%p, .y=%c}, .d=[%i, ...]}",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $EXPR-&gt;a, $EXPR-&gt;b, $EXPR-&gt;c-&gt;x, $EXPR-&gt;c-&gt;y, $EXPR-&gt;d[0])</font></div><p></p></pre></div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# cat test.stp</font></div><div><font size="2"   >probe kernel.function("icmp_push_reply@net/ipv4/icmp.c:347") {</font></div><div><font size="2"   >&nbsp; printf("%s\n", $icmp_param$$)</font></div><div><font size="2"   >&nbsp; exit()</font></div><div><font size="2"   >}</font></div><div><font size="2"   >[root@db-172-16-3-39 ~]# stap --vp 5 test.stp</font></div><div><font size="2"   >Parsed kernel "/lib/modules/2.6.18-348.12.1.el5/build/.config", containing 1977 tuples</font></div><div><font size="2"   >Parsed kernel /lib/modules/2.6.18-348.12.1.el5/build/Module.symvers, which contained 3546 vmlinux exports</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 4, processed: 4</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/*.stp ", found: 81, processed: 81</font></div><div><font size="2"   >Pass 1: parsed user script and 85 library script(s) using 146800virt/23700res/3008shr/21396data kb, in 160usr/10sys/173real ms.</font></div><div><font size="2"   >WARNING: For probing a particular line, use a .statement() probe, not .function(): keyword at test.stp:1:1</font></div><div><font size="2"   >&nbsp;source: probe kernel.function("icmp_push_reply@net/ipv4/icmp.c:347") {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"   >{.skb=0xffff81022fc1a2c0, .offset=0, .data_len=56, .data={.icmph={.type='\000', .code='\000', .checksum=0, .un={.echo={.id=9086, .sequence=31749}, .gateway=2080711550, .frag={.__unused=9086, .mtu=31749}}}, .times=[2147839040, ...]}, .head_len=8, .replyopts={.faddr=0, .optlen='\000', .srr='\000', .rr='\000', .ts='\000', .is_setbyuser=0, .is_data=1, .is_strictroute=0, .srr_is_hit=0, .is_changed=0, .rr_needaddr=0, .ts_needtime=0, .ts_needaddr=0, .router_alert='\000', .cipso='\000', .rhel_alloc_flag=0, .__data</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="https://sourceware.org/systemtap/langref/Components_SystemTap_script.html"   >https://sourceware.org/systemtap/langref/Components_SystemTap_script.html</a></div><div>4. man stap</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp;TYPECASTING</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;Once &nbsp;a pointer has been saved into a script integer variable, the translator loses the type information neces-</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;sary to access members from that pointer. &nbsp;Using the @cast() operator tells the translator how to read a point-</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;er.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; @cast(p, "type_name"[, "module"])-&gt;member</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;This will interpret p as a pointer to a struct/union named type_name and dereference the member value. &nbsp;Further</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;-&gt;subfield expressions may be appended to dereference more levels. &nbsp; NOTE: the same dereferencing &nbsp;operator &nbsp;-&gt;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;is &nbsp;used to refer to both direct containment or pointer indirection. &nbsp;Systemtap automatically determines which.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;The optional module tells the translator where to look for information about that type. &nbsp;Multiple &nbsp;modules &nbsp;may</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;be &nbsp;specified as a list with : separators. &nbsp;If the module is not specified, it will default either to the probe</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;module for dwarf probes, or to "kernel" for functions and all other probes types.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;The translator can create its own module with type information from a header surrounded by angle &nbsp;brackets, &nbsp;in</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;case &nbsp;normal &nbsp;debuginfo &nbsp;is &nbsp;not available. &nbsp;For kernel headers, prefix it with "kernel" to use the appropriate</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;build system. &nbsp;All other headers are build with default GCC parameters into a user &nbsp;module. &nbsp; Multiple &nbsp;headers</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;may be specified in sequence to resolve a codependency.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; @cast(tv, "timeval", "&lt;sys/time.h&gt;")-&gt;tv_sec</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; @cast(task, "task_struct", "kernel&lt;linux/sched.h&gt;")-&gt;tgid</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; @cast(task, "task_struct",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; "kernel&lt;linux/sched.h&gt;&lt;linux/fs_struct.h&gt;")-&gt;fs-&gt;umask</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;Values acquired by @cast may be pretty-printed by the &nbsp;$ " and " $$ suffix operators, the same way as described</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;in the CONTEXT VARIABLES section of the stapprobes(3stap) manual page.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;When in guru mode, the translator will also allow scripts to assign new values to members of typecasted &nbsp;point-</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;ers.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;Typecasting is also useful in the case of void* members whose type may be determinable at runtime.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; probe foo {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ($var-&gt;type == 1) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; value = @cast($var-&gt;data, "type1")-&gt;bar</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; value = @cast($var-&gt;data, "type2")-&gt;baz</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; print(value)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><p></p></pre></div><div>3. man stapprobes</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >&nbsp; &nbsp;CONTEXT VARIABLES</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;Many of the source-level context variables, such as function parameters, locals, globals visible in the &nbsp;compi-</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;lation &nbsp;unit, may be visible to probe handlers. &nbsp;They may refer to these variables by prefixing their name with</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;"$" within the scripts. &nbsp;In addition, a special syntax allows limited traversal of &nbsp;structures, &nbsp;pointers, &nbsp;and</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;arrays. &nbsp;More syntax allows pretty-printing of individual variables or their groups. &nbsp;See also @cast.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;$var &nbsp; refers to an in-scope variable "var". &nbsp;If it’s an integer-like type, it will be cast to a 64-bit int for</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; systemtap script use. &nbsp;String-like pointers (char *) may be copied to systemtap string values using &nbsp;the</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kernel_string or user_string functions.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;@var("varname")</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; an alternative syntax for $varname</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;@var("varname@src/file.c")</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; refers &nbsp;to &nbsp;the global (either file local or external) variable varname defined when the file src/file.c</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; was compiled. The CU in which the variable is resolved is the first CU in the module of the probe &nbsp;point</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; which &nbsp;matches &nbsp;the &nbsp;given &nbsp;file &nbsp;name &nbsp;at &nbsp;the &nbsp;end &nbsp;and &nbsp;has &nbsp;the &nbsp;shortest file name path (e.g. given</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; @var("foo@bar/baz.c") and CUs with file name paths src/sub/module/bar/baz.c and src/bar/baz.c the second</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CU will be chosen to resolve the (file) global variable foo</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;$var-&gt;field traversal via a structure’s or a pointer’s field. &nbsp;This</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; generalized &nbsp;indirection &nbsp;operator &nbsp;may be repeated to follow more levels. &nbsp;Note that the . &nbsp;operator is</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; not used for plain structure members, only -&gt; for both purposes. &nbsp;(This is because "." is &nbsp;reserved &nbsp;for</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; string concatenation.)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;$return</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; is available in return probes only for functions that are declared with a return value.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;$var[N]</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; indexes into an array. &nbsp;The index given with a literal number or even an arbitrary numeric expression.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;A number of operators exist for such basic context variable expressions:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;$$vars expands to a character string that is equivalent to</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sprintf("parm1=%x ... parmN=%x var1=%x ... varN=%x",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; parm1, ..., parmN, var1, ..., varN)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;for &nbsp;each &nbsp;variable &nbsp;in scope at the probe point. &nbsp;Some values may be printed as =? &nbsp;if their run-time location</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;cannot be found.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;$$locals</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; expands to a subset of $$vars for only local variables.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;$$parms</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; expands to a subset of $$vars for only function parameters.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;$$return</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; is available in return probes only. &nbsp;It expands to a string that is equivalent &nbsp;to &nbsp;sprintf("return=%x",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $return) if the probed function has a return value, or else an empty string.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;&amp; $EXPR</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; expands to the address of the given context variable expression, if it is addressable.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;@defined($EXPR)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; expands &nbsp;to 1 or 0 iff the given context variable expression is resolvable, for use in conditionals such</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; as</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; @defined($foo-&gt;bar) ? $foo-&gt;bar : 0</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;$EXPR$ expands to a string with all of $EXPR’s members, equivalent to</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sprintf("{.a=%i, .b=%u, .c={...}, .d=[...]}",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;$EXPR-&gt;a, $EXPR-&gt;b)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;$EXPR$$</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; expands to a string with all of $var’s members and submembers, equivalent to</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sprintf("{.a=%i, .b=%u, .c={.x=%p, .y=%c}, .d=[%i, ...]}",</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $EXPR-&gt;a, $EXPR-&gt;b, $EXPR-&gt;c-&gt;x, $EXPR-&gt;c-&gt;y, $EXPR-&gt;d[0])</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;For ".return" probes, context variables other than the "$return" value itself are only available for the &nbsp;func-</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;tion call parameters. &nbsp;The expressions evaluate to the entry-time values of those variables, since that is when</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;a snapshot is taken. &nbsp;Other local variables are not generally accessible, since by the time a &nbsp;".return" &nbsp;probe</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;hits, the probed function will have already returned.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;Arbitrary &nbsp;entry-time &nbsp;expressions can also be saved for ".return" probes using the @entry(expr) operator. &nbsp;For</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;example, one can compute the elapsed time of a function:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; probe kernel.function("do_filp_open").return {</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; println( get_timeofday_us() - @entry(get_timeofday_us()) )</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>