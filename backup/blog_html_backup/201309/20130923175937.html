<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL history table use unlogged table performance tuning case</h2>
	<h5 id="">2013-09-23 17:59:37&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201382341433512/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>unlogged table不写xlog, 同时在数据库崩溃后进入recovery阶段时会清除unlogged table的数据.</div><div>由于unlogged table不写xlog , 所以也不能通过流复制或者log shipping复制到standby中.</div><div>一般的应用场景是用来记录历史数据, 但是这也有一个弊端, 但任何情况下数据库发生crash , 需要recovery的话, unlogged table会被清除掉. 清除的动作在xlog.c中,&nbsp;<span style="line-height: 28px;"   >详见</span></div><div><span style="color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; line-height: 23px;"   >src/backend/access/transam/xlog.c</span></div><div><pre class="prettyprint"   ><p></p><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   size="2"   >ResetUnloggedRelations(UNLOGGED_RELATION_CLEANUP);</font></div><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   size="2"   ><div>&nbsp; &nbsp; &nbsp; &nbsp; /*</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Reset initial contents of unlogged relations. &nbsp;This has to be done</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* AFTER recovery is complete so that any unlogged relations created</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* during recovery also get picked up.</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</div><div>&nbsp; &nbsp; &nbsp; &nbsp; if (InRecovery)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ResetUnloggedRelations(UNLOGGED_RELATION_INIT);</div></font></div><p></p></pre></div><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   >但是你会发现注释掉这两行</font><span style="line-height: 22.75px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; font-size: small; white-space: pre;"   >ResetUnloggedRelations也没有效果, 同样可能丢数据.</span></div><div><span style="line-height: 22.75px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; font-size: small; white-space: pre;"   >原因是, checkpoint的时候, unlogged table的脏块不一定会flush到磁盘.</span></div><div><span style="line-height: 22.75px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53; font-size: small; white-space: pre;"   ><br></span></div><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   >如果又要利用unlogged table的不写xlog的高效性, 同时还不能让他被数据库recovery时清除掉怎么办呢?</font></div><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   >这里有个办法, 就是在使用时将表改成unlogged table, 使用后改成持久化表.</font></div><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   >但是这也不是非常安全的, 因为init文件可能会自动生成. (例如truncate表然后vacuum表后, 会自动生成init文件)</font></div><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   >测试如下 :&nbsp;</font></div><div><font color="#333333"   face="Arial, Helvetica, simsun, u5b8bu4f53"   ><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-39-&gt; psql</font></div><div><font size="2"   >psql (9.3beta2)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><div><font size="2"   >digoal=# create unlogged table t4 (id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# insert into t4 select generate_series(1,1000000);</font></div><div><font size="2"   >INSERT 0 1000000</font></div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><div><font size="2"   >digoal=# update pg_class set relpersistence ='p' where relname='t4';</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div></div><p></p></pre></div><div>先正常关闭数据库.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-39-&gt; pg_ctl stop -m fast</font></div><div><font size="2"   >waiting for server to shut down.... done</font></div><div><font size="2"   >server stopped</font></div><div><font size="2"   >pg93@db-172-16-3-39-&gt; pg_ctl start</font></div><div><font size="2"   >server starting</font></div><div><font size="2"   >pg93@db-172-16-3-39-&gt; LOG: &nbsp;00000: loaded library "pg_stat_statements"</font></div><div><font size="2"   >LOCATION: &nbsp;load_libraries, miscinit.c:1296</font></div><p></p></pre></div><div>正常关闭数据库再启动, unlogged table的数据还在.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-39-&gt; psql</font></div><div><font size="2"   >psql (9.3beta2)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# select count(*) from t4;</font></div><div><font size="2"   >&nbsp; count &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;1000000</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# \q</font></div><p></p></pre></div><div>非正常关闭数据库,&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-39-&gt; pg_ctl restart -m immediate</font></div><div><font size="2"   >waiting for server to shut down.... done</font></div><div><font size="2"   >server stopped</font></div><div><font size="2"   >server starting</font></div><div><font size="2"   >pg93@db-172-16-3-39-&gt; LOG: &nbsp;00000: loaded library "pg_stat_statements"</font></div><div><font size="2"   >LOCATION: &nbsp;load_libraries, miscinit.c:1296</font></div><p></p></pre></div><div>显然数据丢失了. &nbsp;也就是说初始创建的unlogged表仅仅使用更新pg_class.<span style="line-height: 23px;"   >relpersistence</span><span style="line-height: 23px;"   >&nbsp;不能达到持久化的目的.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-39-&gt; psql</font></div><div><font size="2"   >psql (9.3beta2)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# select count(*) from t4;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div><br></div><div>如果初始创建的表是logged的, 情况又不一样了.&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table t3(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><p></p></pre></div><div>正常的插入</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# insert into t3 select generate_series(1,1000000);</font></div><div><font size="2"   >INSERT 0 1000000</font></div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><p></p></pre></div><div>改成unlogged后插入</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# update pg_class set relpersistence ='u' where relname='t3';</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><div><font size="2"   >digoal=# insert into t3 select generate_series(1,1000000);</font></div><div><font size="2"   >INSERT 0 1000000</font></div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><div><font size="2"   >digoal=# update pg_class set relpersistence ='p' where relname='t3';</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><p></p></pre></div></div><div>先正常关闭数据库,&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-39-&gt; pg_ctl stop -m fast</font></div><div><font size="2"   >waiting for server to shut down.... done</font></div><div><font size="2"   >server stopped</font></div><div><font size="2"   >pg93@db-172-16-3-39-&gt; pg_ctl start</font></div><div><font size="2"   >server starting</font></div><div><font size="2"   >pg93@db-172-16-3-39-&gt; LOG: &nbsp;00000: loaded library "pg_stat_statements"</font></div><div><font size="2"   >LOCATION: &nbsp;load_libraries, miscinit.c:1296</font></div><p></p></pre></div><div>启动后数据还在.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-39-&gt; psql</font></div><div><font size="2"   >psql (9.3beta2)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# select count(*) from t3;</font></div><div><font size="2"   >&nbsp; count &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;2000000</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>异常关闭数据库后, 使用unlogged方式插入的数据也还在.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# \q</font></div><div><font size="2"   >pg93@db-172-16-3-39-&gt; pg_ctl restart -m immediate</font></div><div><font size="2"   >waiting for server to shut down.... done</font></div><div><font size="2"   >server stopped</font></div><div><font size="2"   >server starting</font></div><div><font size="2"   >pg93@db-172-16-3-39-&gt; LOG: &nbsp;00000: loaded library "pg_stat_statements"</font></div><div><font size="2"   >LOCATION: &nbsp;load_libraries, miscinit.c:1296</font></div><div><font size="2"   >pg93@db-172-16-3-39-&gt;&nbsp;</font></div><div><font size="2"   >pg93@db-172-16-3-39-&gt; psql</font></div><div><font size="2"   >psql (9.3beta2)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# select count(*) from t3;</font></div><div><font size="2"   >&nbsp; count &nbsp;</font></div><div><font size="2"   >---------</font></div><div><font size="2"   >&nbsp;2000000</font></div><p></p></pre></div></div><div><br></div><div>那么初始表是logged table , 改成unlogged table后, xlog的生产量和以前是否有节省?</div><div><p style="font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ></p><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><pre class="prettyprint"   ><p></p><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><div><font size="2"   >digoal=# create table t3(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><div><font size="2"   >digoal=# select pg_current_xlog_location();</font></div><div><font size="2"   >&nbsp;pg_current_xlog_location&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;0/51EBACE0</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# insert into t3 select generate_series(1,10000000);</font></div><div><font size="2"   >INSERT 0 10000000</font></div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><div><font size="2"   >digoal=# select pg_current_xlog_location();</font></div><div><font size="2"   >&nbsp;pg_current_xlog_location&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;0/781FA3A0</font></div><div><font size="2"   >(1 row)</font></div></div><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><div><font size="2"   >digoal=# select pg_xlog_location_diff('0/781FA3A0', '0/51EBACE0');</font></div><div><font size="2"   >&nbsp;pg_xlog_location_diff&nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;640939712</font></div><div><font size="2"   >(1 row)</font></div></div><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><font size="2"   >使用unlogged插入.</font></div><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><div><font size="2"   >digoal=# update pg_class set relpersistence ='u' where relname='t3';</font></div><div><font size="2"   >UPDATE 1</font></div></div><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><div><font size="2"   >digoal=# truncate t3;</font></div><div><font size="2"   >TRUNCATE TABLE</font></div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div></div><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><div><font size="2"   >digoal=# select pg_current_xlog_location();</font></div><div><font size="2"   >&nbsp;pg_current_xlog_location&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;0/78208760</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# insert into t3 select generate_series(1,10000000);</font></div><div><font size="2"   >INSERT 0 10000000</font></div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><div><font size="2"   >digoal=# select pg_current_xlog_location();</font></div><div><font size="2"   >&nbsp;pg_current_xlog_location&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;0/7820A690</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select pg_xlog_location_diff('0/7820A690', '0/78208760');</font></div><div><font size="2"   >&nbsp;pg_xlog_location_diff&nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 7984</font></div><div><font size="2"   >(1 row)</font></div></div><div style="font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><font size="2"   ><span style="line-height: 20px;"   >改回logged</span></font></div><div><font size="2"   >digoal=# update pg_class set relpersistence ='p' where relname='t3';<br>UPDATE 1</font></div><p></p></pre></div><p style="font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ></p></div><div>显然起到了节约xlog的作用.</div><div>为什么不会被清除, 原因是普通表创建时不会生成init文件. 小结部分会讲到.</div><div><br></div></font></div><div>[小结]</div><div>1. 初始创建的表必须是logged table, 而不是unlogged table. 原因常见第三点.</div><div>2. 使用unlogged 模式插入的数据, 部分数据可能在shared buffer中, 没有flush到磁盘, 如果此时down机, 是可能造成部分数据丢失的. 即使使用checkpoint也无法做到, checkpoint时对于unlogged table在shared buffer中的数据不会flush到disk中.</div><div>&nbsp; &nbsp; 这些数据只有当所有的shared buffer中的 数据 flush到磁盘后才不会丢失. 因为pg_xlog中没有这些数据可以用作恢复.</div><div>&nbsp; &nbsp; 在测试时pg_ctl stop -m fast正好起到了flush shared buffer的目的.</div><div>3. 为什么unlogged table改成logged后, 遇到数据库crash还是会遭到初始话处理呢?</div><div>原因在这里, unlogged table比普通表多了个文件.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# create unlogged table u_log1(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# insert into u_log1 select generate_series(1,10000);</font></div><div><font size="2"   >INSERT 0 10000</font></div><div><font size="2"   >digoal=# checkpoint;</font></div></div><div><div><font size="2"   >digoal=# select pg_relation_filepath('u_log1'::regclass);</font></div><div><font size="2"   >&nbsp;pg_relation_filepath&nbsp;</font></div><div><font size="2"   >----------------------</font></div><div><font size="2"   >&nbsp;base/16384/24600</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   >pg94@db-172-16-3-39-&gt; cd $PGDATA/</font></div><div><div><font size="2"   >pg94@db-172-16-3-39-&gt; ll base/16384/24600*</font></div><div><font size="2"   >-rw------- 1 pg94 pg94 360K Sep 23 18:07 base/16384/24600</font></div><div><font size="2"   >-rw------- 1 pg94 pg94 &nbsp;24K Sep 23 18:07 base/16384/24600_fsm</font></div><div><font size="2"   >-rw------- 1 pg94 pg94 &nbsp; &nbsp;0 Sep 23 18:07 base/16384/24600_init</font></div></div><p></p></pre></div><div>24600_init这个文件是unlogged 表的标签文件.</div><div><div>Unlogged tables and indexes&nbsp;<span style="line-height: 23px;"   >have a third fork, known as the initialization fork, which is stored in a fork&nbsp;</span><span style="line-height: 23px;"   >with the suffix _init</span></div></div><div><span style="line-height: 23px;"   >这个文件表示数据库在recovery阶段会替换掉main fork, 也就是recovery阶段清理unlogged table的数据的作用.</span></div><div>下面创建普通表 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# create table log1(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# insert into log1 select generate_series(1,10000);</font></div><div><font size="2"   >INSERT 0 10000</font></div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><div><font size="2"   >digoal=# select pg_relation_filepath('log1'::regclass);</font></div><div><font size="2"   >&nbsp;pg_relation_filepath&nbsp;</font></div><div><font size="2"   >----------------------</font></div><div><font size="2"   >&nbsp;base/16384/24603</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >pg94@db-172-16-3-39-&gt; ll base/16384/24603*</font></div><div><font size="2"   >-rw------- 1 pg94 pg94 360K Sep 23 18:08 base/16384/24603</font></div><div><font size="2"   >-rw------- 1 pg94 pg94 &nbsp;24K Sep 23 18:08 base/16384/24603_fsm</font></div></div><p></p></pre></div><div>普通表没有init结尾的文件.</div><div>如果把unlogged表的init文件删除掉, 那么数据库恢复时这个unlogged 表就不会被初始化了.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg94@db-172-16-3-39-&gt; rm base/16384/24600_init</font></div><div><font size="2"   >rm: remove regular empty file `base/16384/24600_init'? y</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >pg94@db-172-16-3-39-&gt; pg_ctl stop -m fast</font></div><div><font size="2"   >waiting for server to shut down....DEBUG: &nbsp;00000: logger shutting down</font></div><div><font size="2"   >LOCATION: &nbsp;SysLoggerMain, syslogger.c:517</font></div><div><font size="2"   >&nbsp;done</font></div><div><font size="2"   >server stopped</font></div><div><font size="2"   >pg94@db-172-16-3-39-&gt; pg_ctl start</font></div><div><font size="2"   >server starting</font></div><div><font size="2"   >pg94@db-172-16-3-39-&gt; LOG: &nbsp;00000: loaded library "pg_stat_statements"</font></div><div><font size="2"   >LOCATION: &nbsp;load_libraries, miscinit.c:1297</font></div><div><font size="2"   >LOG: &nbsp;00000: redirecting log output to logging collector process</font></div><div><font size="2"   >HINT: &nbsp;Future log output will appear in directory "pg_log".</font></div><div><font size="2"   >LOCATION: &nbsp;SysLogger_Start, syslogger.c:649</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal=# select count(*) from u_log1 ;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp;10000</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>非正常重启数据库, unlogged表的数据未被清除掉.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg94@db-172-16-3-39-&gt; pg_ctl restart -m immediate</font></div><div><font size="2"   >waiting for server to shut down....DEBUG: &nbsp;00000: logger shutting down</font></div><div><font size="2"   >LOCATION: &nbsp;SysLoggerMain, syslogger.c:517</font></div><div><font size="2"   >&nbsp;done</font></div><div><font size="2"   >server stopped</font></div><div><font size="2"   >server starting</font></div><div><font size="2"   >pg94@db-172-16-3-39-&gt; LOG: &nbsp;00000: loaded library "pg_stat_statements"</font></div><div><font size="2"   >LOCATION: &nbsp;load_libraries, miscinit.c:1297</font></div><div><font size="2"   >LOG: &nbsp;00000: redirecting log output to logging collector process</font></div><div><font size="2"   >HINT: &nbsp;Future log output will appear in directory "pg_log".</font></div><div><font size="2"   >LOCATION: &nbsp;SysLogger_Start, syslogger.c:649</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg94@db-172-16-3-39-&gt; psql</font></div><div><font size="2"   >psql (9.4devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# select count(*) from u_log1 ;</font></div><div><font size="2"   >&nbsp;count&nbsp;</font></div><div><font size="2"   >-------</font></div><div><font size="2"   >&nbsp;10000</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>4. 如果真的要用unlogged table, 并且又要保证数据在crash后不丢失. 可以这么来做, 当然我非常不建议大家这样做.</div><div>unlogged table目前的初衷就不是这么来用的.</div><div>未来大家如果都有这方面的需求, 也许pg会改进代码.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >1. 修改源代码, 注释src/backend/access/transam/xlog.c中的ResetUnloggedRelations, 重新make , make install</font></div><div><font size="2"   >2. 创建普通的logged table</font></div><div><font size="2"   >3. 修改对应表和索引的 pg_class.relpersistence='u'</font></div><div><font size="2"   >4. 导入数据, 此时是不会写xlog的.</font></div><div><font size="2"   >5. 正常重启数据库, 目的是把shared buffer中的unlogged table 的dirty page flush到磁盘, 或者以后还有什么方法可以做到手工的flush unlogged table的dirty page到磁盘. 目前看来只有重启数据库, 因为checkpoint对unlogged table dirty page不感冒.</font></div><div><font size="2"   >6. 现在开始数据是安全的了.</font></div><div><font size="2"   >7. 但是在表被truncate或者其他方式重写表后, 可能会自动生成init文件, 不过已经改了源码, 绕过了resetunlogged表的函数, 所以就没有关系了.</font></div><p></p></pre></div><div>为什么说 checkpoint对unlogged table的脏块不感冒, 来看个测试</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# truncate u;</font></div><div><font size="2"   >TRUNCATE TABLE</font></div><div><font size="2"   >digoal=# insert into u select generate_series(1,100000);</font></div><div><font size="2"   >INSERT 0 100000</font></div><div><font size="2"   >digoal=# select * from pg_stat_file(pg_relation_filepath('u')), pg_relation_filepath('u');</font></div><div><font size="2"   >&nbsp; size &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; access &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;modification &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; change &nbsp; &nbsp; &nbsp; &nbsp; | creation | isdir | pg_relation_filepath&nbsp;</font></div><div><font size="2"   >---------+------------------------+------------------------+------------------------+----------+-------+----------------------</font></div><div><font size="2"   >&nbsp;3629056 | 2013-12-23 17:08:36+08 | 2013-12-23 17:08:40+08 | 2013-12-23 17:08:40+08 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; | base/16399/114695</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><p></p></pre></div><div>看到checkpoint之后, 数据文件没有变化, 修改的时间戳不变.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# select * from pg_stat_file(pg_relation_filepath('u')), pg_relation_filepath('u');</font></div><div><font size="2"   >&nbsp; size &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; access &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;modification &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; change &nbsp; &nbsp; &nbsp; &nbsp; | creation | isdir | pg_relation_filepath&nbsp;</font></div><div><font size="2"   >---------+------------------------+------------------------+------------------------+----------+-------+----------------------</font></div><div><font size="2"   >&nbsp;3629056 | 2013-12-23 17:08:36+08 | 2013-12-23 17:08:40+08 | 2013-12-23 17:08:40+08 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; | base/16399/114695</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   >pg94@db-172-16-3-150-&gt; pg_ctl restart -m fast</font></div><p></p></pre></div></div><div>但是正常的重启数据库后, 时间戳变了, 说明正常的关库发生的checkpoint会处理unlogged table的脏块.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg94@db-172-16-3-150-&gt; psql</font></div><div><font size="2"   >psql (9.4devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# select * from pg_stat_file(pg_relation_filepath('u')), pg_relation_filepath('u');</font></div><div><font size="2"   >&nbsp; size &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; access &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;modification &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; change &nbsp; &nbsp; &nbsp; &nbsp; | creation | isdir | pg_relation_filepath&nbsp;</font></div><div><font size="2"   >---------+------------------------+------------------------+------------------------+----------+-------+----------------------</font></div><div><font size="2"   >&nbsp;3629056 | 2013-12-23 17:08:36+08 | 2013-12-23 17:08:52+08 | 2013-12-23 17:08:52+08 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; | base/16399/114695</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>如果是普通表, checkpoint会把它在shared buffer中的脏块写到磁盘上</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# update pg_class set relpersistence ='p' where relname='u';</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >digoal=# insert into u select generate_series(1,100000);</font></div><div><font size="2"   >INSERT 0 100000</font></div><div><font size="2"   >digoal=# select * from pg_stat_file(pg_relation_filepath('u')), pg_relation_filepath('u');</font></div><div><font size="2"   >&nbsp; size &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; access &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;modification &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; change &nbsp; &nbsp; &nbsp; &nbsp; | creation | isdir | pg_relation_filepath&nbsp;</font></div><div><font size="2"   >---------+------------------------+------------------------+------------------------+----------+-------+----------------------</font></div><div><font size="2"   >&nbsp;7258112 | 2013-12-23 17:20:17+08 | 2013-12-23 17:21:27+08 | 2013-12-23 17:21:27+08 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; | base/16399/114696</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><div><font size="2"   >digoal=# select * from pg_stat_file(pg_relation_filepath('u')), pg_relation_filepath('u');</font></div><div><font size="2"   >&nbsp; size &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; access &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp;modification &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; change &nbsp; &nbsp; &nbsp; &nbsp; | creation | isdir | pg_relation_filepath&nbsp;</font></div><div><font size="2"   >---------+------------------------+------------------------+------------------------+----------+-------+----------------------</font></div><div><font size="2"   >&nbsp;7258112 | 2013-12-23 17:20:17+08 | 2013-12-23 17:21:32+08 | 2013-12-23 17:21:32+08 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; | base/16399/114696</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>一共有几种checkpoint, 如下 :&nbsp;</div><div>src/include/access/xlog.h</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/* These directly affect the behavior of CreateCheckPoint and subsidiaries */</font></div><div><font size="2"   >#define CHECKPOINT_IS_SHUTDOWN &nbsp;0x0001 &nbsp;/* Checkpoint is for shutdown */</font></div><div><font size="2"   >#define CHECKPOINT_END_OF_RECOVERY &nbsp; &nbsp; &nbsp;0x0002 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* Like shutdown checkpoint,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* but issued at end of WAL</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* recovery */</font></div><div><font size="2"   >#define CHECKPOINT_IMMEDIATE &nbsp; &nbsp;0x0004 &nbsp;/* Do it without delays */</font></div><div><font size="2"   >#define CHECKPOINT_FORCE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0x0008 &nbsp;/* Force even if no activity */</font></div><div><font size="2"   >/* These are important to RequestCheckpoint */</font></div><div><font size="2"   >#define CHECKPOINT_WAIT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x0010 &nbsp;/* Wait for completion */</font></div><div><font size="2"   >/* These indicate the cause of a checkpoint request */</font></div><div><font size="2"   >#define CHECKPOINT_CAUSE_XLOG &nbsp; 0x0020 &nbsp;/* XLOG consumption */</font></div><div><font size="2"   >#define CHECKPOINT_CAUSE_TIME &nbsp; 0x0040 &nbsp;/* Elapsed time */</font></div><p></p></pre></div><div>请求checkpoint时, 调用src/backend/postmaster/checkpointer.c:RequestCheckpoint(int flags)</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* RequestCheckpoint</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Called in backend processes to request a checkpoint</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* flags is a bitwise OR of the following:</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;CHECKPOINT_IS_SHUTDOWN: checkpoint is for database shutdown.</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;CHECKPOINT_END_OF_RECOVERY: checkpoint is for end of WAL recovery.</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;CHECKPOINT_IMMEDIATE: finish the checkpoint ASAP,</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ignoring checkpoint_completion_target parameter.</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;CHECKPOINT_FORCE: force a checkpoint even if no XLOG activity has occurred</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;since the last one (implied by CHECKPOINT_IS_SHUTDOWN or</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;CHECKPOINT_END_OF_RECOVERY).</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;CHECKPOINT_WAIT: wait for completion before returning (otherwise,</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;just signal checkpointer to do it, and return).</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;CHECKPOINT_CAUSE_XLOG: checkpoint is requested due to xlog filling.</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(This affects logging, and in particular enables CheckPointWarning.)</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >void</font></div><div><font size="2"   >RequestCheckpoint(int flags)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* use volatile pointer to prevent code rearrangement */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; volatile CheckpointerShmemStruct *cps = CheckpointerShmem;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ntries;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; old_failed,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; old_started;</font></div><p></p></pre></div><div>写脏块的函数 :&nbsp;</div><div>src/backend/storage/buffer/bufmgr.c</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* BufferSync -- Write out all dirty buffers in the pool.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* This is called at checkpoint time to write out all dirty shared buffers.</font></div><div><font size="2"   >&nbsp;* The checkpoint request flags should be passed in. &nbsp;If CHECKPOINT_IMMEDIATE</font></div><div><font size="2"   >&nbsp;* is set, we disable delays between writes; if CHECKPOINT_IS_SHUTDOWN is</font></div><div><font size="2"   >&nbsp;* set, we write even unlogged buffers, which are otherwise skipped. &nbsp;The</font></div><div><font size="2"   >&nbsp;* remaining flags currently have no effect here.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >static void</font></div><div><font size="2"   >BufferSync(int flags)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; buf_id;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; num_to_scan;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; num_to_write;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; num_written;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mask = BM_DIRTY;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Make sure we can handle the pin inside SyncOneBuffer */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ResourceOwnerEnlargeBuffers(CurrentResourceOwner);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Unless this is a shutdown checkpoint, we write only permanent, dirty</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* buffers. &nbsp;But at shutdown or end of recovery, we write all dirty</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* buffers.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (!((flags &amp; CHECKPOINT_IS_SHUTDOWN) || (flags &amp; CHECKPOINT_END_OF_RECOVERY)))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; mask |= BM_PERMANENT;</font></div><p></p></pre></div><div><br></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 23px;" href="http://blog.163.com/digoal@126/blog/static/16387704020121210128345/"   >http://blog.163.com/digoal@126/blog/static/16387704020121210128345/</a></div><div>2.&nbsp;<a style="line-height: 23px;" href="http://blog.163.com/digoal@126/blog/static/163877040201151402832128/"   >http://blog.163.com/digoal@126/blog/static/163877040201151402832128/</a></div><div>3.&nbsp;<a style="line-height: 23px;" href="http://blog.163.com/digoal@126/blog/static/16387704020133274380469/"   >http://blog.163.com/digoal@126/blog/static/16387704020133274380469/</a></div><div>4.&nbsp;src/backend/storage/file/reinit.c</div></div>
	</div>
</div>
</body>
</html>