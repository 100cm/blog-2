<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Systemtap Userspace probing - 1</h2>
	<h5 id="">2013-09-29 17:16:31&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201382941342901/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><pre class="prettyprint"   ><p></p><div><font size="2"   >Systemtap&nbsp;Support for userspace probing is supported on kernels that are configured to include the utrace or uprobes extensions.</font></div><div></div><p></p></pre><div>前面几篇blog介绍了DWARF和DWARF-less探针, 本文将要介绍一个新的探针分类, userspace probe, 这个顾名思义是和用户或者运行的程序更相关的探针.</div><div><span style="line-height: 23px;"   >要支持</span><span style="line-height: 23px;"   >user-space probing, 首先内核要支持, 内核需包含了utrace或者uprobes扩展.</span></div><div><span style="line-height: 23px;"   >Systemtap最初是为内核空间监视设计的, 在0.6的版本后才加入了进程空间的监视, 即user-space probe.</span></div><div><div style="widows: 2; orphans: 2; line-height: 15.46875px; padding-top: 0px; margin-top: 0.3em; padding-bottom: 0px; margin-bottom: 1em; font-family: 'liberation sans', 'Myriad ', 'Bitstream Vera Sans', 'Lucida Grande', 'Luxi Sans', 'Trebuchet MS', helvetica, verdana, arial, sans-serif; font-size: 12px;"   >SystemTap initially focused on kernel-space probing. However, there are many instances where user-space probing can help diagnose a problem. SystemTap 0.6 added support to allow probing user-space processes. SystemTap includes support for probing the entry into and return from a function in user-space processes, probing predefined markers in user-space code, and monitoring user-process events.</div><div style="widows: 2; orphans: 2; line-height: 15.46875px; padding-top: 0px; margin-top: 0.3em; padding-bottom: 0px; margin-bottom: 1em; font-family: 'liberation sans', 'Myriad ', 'Bitstream Vera Sans', 'Lucida Grande', 'Luxi Sans', 'Trebuchet MS', helvetica, verdana, arial, sans-serif; font-size: 12px;"   >The SystemTap user-space probing requires the utrace kernel extensions which provide an API for tracking various user-space events. More details about the utrace infrastructure are available at<a style="outline: none; text-decoration: none; border-bottom-width: 1px; border-bottom-style: dotted; color: rgb(102, 153, 204);" rel="nofollow" href="http://sourceware.org/systemtap/wiki/utrace"   >http://sourceware.org/systemtap/wiki/utrace</a>. The following command determines whether the currently running Linux kernel provides the needed utrace support:</div><pre style="widows: 2; orphans: 2; line-height: 15.46875px; font-family: 'liberation mono', 'bitstream vera mono', 'dejavu mono', monospace; background-color: rgb(245, 245, 245); border: 1px solid rgb(170, 170, 170); margin-bottom: 0.3em; padding: 0.5em 1em; white-space: pre-wrap; word-wrap: break-word; font-size: 12px; border-top-left-radius: 11px; border-top-right-radius: 11px; border-bottom-right-radius: 11px; border-bottom-left-radius: 11px; page-break-inside: avoid;"   >grep CONFIG_UTRACE /boot/config-`uname -r`</pre><div style="widows: 2; orphans: 2; line-height: 15.46875px; padding-top: 0px; margin-top: 0.3em; padding-bottom: 0px; margin-bottom: 1em; font-family: 'liberation sans', 'Myriad ', 'Bitstream Vera Sans', 'Lucida Grande', 'Luxi Sans', 'Trebuchet MS', helvetica, verdana, arial, sans-serif; font-size: 12px;"   >If the Linux kernel support user-space probing, the following output is printed:</div><pre style="widows: 2; orphans: 2; line-height: 15.46875px; font-family: 'liberation mono', 'bitstream vera mono', 'dejavu mono', monospace; background-color: rgb(245, 245, 245); border: 1px solid rgb(170, 170, 170); margin-bottom: 0.3em; padding: 0.5em 1em; white-space: pre-wrap; word-wrap: break-word; font-size: 12px; border-top-left-radius: 11px; border-top-right-radius: 11px; border-bottom-right-radius: 11px; border-bottom-left-radius: 11px; page-break-inside: avoid;"   >CONFIG_UTRACE=y</pre><div style="widows: 2; orphans: 2; line-height: 15.46875px; padding-top: 0px; margin-top: 0.3em; padding-bottom: 0px; margin-bottom: 1em; font-family: 'liberation sans', 'Myriad ', 'Bitstream Vera Sans', 'Lucida Grande', 'Luxi Sans', 'Trebuchet MS', helvetica, verdana, arial, sans-serif; font-size: 12px;"   >The SystemTap user-space probing also needs the uprobes kernel module. If the uprobes kernel module is not available, you will see an error message like the following when attempting to run a script that requires the uprobes kernel module:</div><pre style="widows: 2; orphans: 2; line-height: 15.46875px; font-family: 'liberation mono', 'bitstream vera mono', 'dejavu mono', monospace; background-color: rgb(245, 245, 245); border: 1px solid rgb(170, 170, 170); margin-bottom: 0.3em; padding: 0.5em 1em; white-space: pre-wrap; word-wrap: break-word; font-size: 12px; border-top-left-radius: 11px; border-top-right-radius: 11px; border-bottom-right-radius: 11px; border-bottom-left-radius: 11px; page-break-inside: avoid;"   >SystemTap's version of uprobes is out of date.
As root, or a member of the 'root' group, run
"make -C /usr/share/systemtap/runtime/uprobes".
Pass 4: compilation failed.  Try again with another '--vp 0001' option.</pre><div style="widows: 2; orphans: 2; line-height: 15.46875px; padding-top: 0px; margin-top: 0.3em; padding-bottom: 0px; margin-bottom: 1em; font-family: 'liberation sans', 'Myriad ', 'Bitstream Vera Sans', 'Lucida Grande', 'Luxi Sans', 'Trebuchet MS', helvetica, verdana, arial, sans-serif; font-size: 12px;"   >If this occurs, you need to generate a uprobes.ko module for the kernel as directed.</div></div><div><span style="line-height: 23px;"   >UTRACE介绍截取自</span><span style="line-height: 23px;"   >/usr/share/doc/kernel-doc-x.x.x/Documentation/utrace.txt</span><span style="line-height: 23px;"   >&nbsp;:&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >The UTRACE is infrastructure code for tracing and controlling user</font></div><div><font size="2"   >threads. &nbsp;This is the foundation for writing tracing engines, which</font></div><div><font size="2"   >can be loadable kernel modules. &nbsp;The UTRACE interfaces provide three</font></div><div><font size="2"   >basic facilities:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >* Thread event reporting</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; Tracing engines can request callbacks for events of interest in</font></div><div><font size="2"   >&nbsp; the thread: signals, system calls, exit, exec, clone, etc.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >* Core thread control</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; Tracing engines can prevent a thread from running (keeping it in</font></div><div><font size="2"   >&nbsp; TASK_TRACED state), or make it single-step or block-step (when</font></div><div><font size="2"   >&nbsp; hardware supports it). &nbsp;Engines can cause a thread to abort system</font></div><div><font size="2"   >&nbsp; calls, they change the behaviors of signals, and they can inject</font></div><div><font size="2"   >&nbsp; signal-style actions at will.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >* Thread machine state access</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; Tracing engines can read and write a thread's registers and</font></div><div><font size="2"   >&nbsp; similar per-thread CPU state.</font></div><p></p></pre></div><div>检查内核是否支持utrace :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 pg93]# grep CONFIG_UTRACE /boot/config-`uname -r`</font></div><div><font size="2"   >CONFIG_UTRACE=y</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >userspace probe的几种使用方法.</span></div><div>1. 进程创建和进程消亡.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >process.begin &nbsp; 所有进程创建时触发. (如果为target process模式则受指定进程限制.stap -c or -x; 或者是stap --unprivileged 则限定为当前用户的进程)</font></div><div><font size="2"   >process("PATH").begin PATH可以为当前的相对路径或者绝对路径</font><span style="line-height: 20px; font-size: small; font-family: Arial, Helvetica, sans-serif;"   >或者在当前环境下的$PATH中搜索</span><span style="line-height: 20px; font-size: small; font-family: Arial, Helvetica, sans-serif;"   >指定的进程名称. 在该进程创建时触发.</span></div><div><font size="2"   >process(PID).begin 指进程ID为指定PID的进程被创建时触发</font></div><div><font size="2"   >以下<span style="line-height: 23px;"   >同上, 只不过代表线程.</span></font></div><div><font size="2"   >process.thread.begin&nbsp;</font></div><div><font size="2"   >process("PATH").thread.begin</font></div><div><font size="2"   >process(PID).thread.begin</font></div><div><font size="2"   >.end 指进程消亡时触发. 其他含义同上.</font></div><div><font size="2"   >process.end</font></div><div><font size="2"   >process("PATH").end</font></div><div><font size="2"   >process(PID).end</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >process.thread.end</font></div><div><font size="2"   >process("PATH").thread.end</font></div><div><font size="2"   >process(PID).thread.end</font></div><div><font size="2"   ><br></font></div><div><p style="font-family: Simsun; line-height: normal; white-space: normal;"   ><font size="2"   >The&nbsp;<tt>.begin</tt>&nbsp;variant is called when a new process described by&nbsp;<tt>PID</tt>&nbsp;or&nbsp;<tt>PATH</tt>&nbsp;is created. If no&nbsp;<tt>PID</tt>&nbsp;or&nbsp;<tt>PATH</tt>&nbsp;argument is specified (for example&nbsp;<tt>process.begin</tt>), the probe flags any new process being spawned.</font></p><p style="font-family: Simsun; line-height: normal; white-space: normal;"   ><font size="2"   >The&nbsp;<tt>.thread.begin</tt>&nbsp;variant is called when a new thread described by&nbsp;<tt>PID</tt>&nbsp;or&nbsp;<tt>PATH</tt>&nbsp;is created.</font></p><p style="font-family: Simsun; line-height: normal; white-space: normal;"   ><font size="2"   >The&nbsp;<tt>.end</tt>&nbsp;variant is called when a process described by&nbsp;<tt>PID</tt>&nbsp;or&nbsp;<tt>PATH</tt>&nbsp;dies.</font></p><p style="font-family: Simsun; line-height: normal; white-space: normal;"   ><font size="2"   >The&nbsp;<tt>.thread.end</tt>&nbsp;variant is called when a thread described by&nbsp;<tt>PID</tt>&nbsp;or&nbsp;<tt>PATH</tt>&nbsp;dies.</font></p></div><p></p></pre></div><div>例如 :&nbsp;</div><div>相对路径 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-39 pgsql]# cd /opt</font></div><div><font size="2"   >[root@db-172-16-3-39 opt]# ll pgsql9.3beta2/bin/postgres</font></div><div><font size="2"   >-rwxr-xr-x 1 root root 5710772 Aug &nbsp;8 22:01 pgsql9.3beta2/bin/postgres</font></div></div><div><div><font size="2"   >[root@db-172-16-3-39 opt]# stap -e 'probe process("pgsql9.3beta2/bin/postgres").begin {printf("%s, %s, %d, %d\n", execname(), pp(), pid(), cpu()); exit();}'</font></div><div><font size="2"   >postgres, process("/opt/pgsql9.3beta2/bin/postgres").begin, 13707, 0</font></div></div><p></p></pre></div><div>绝对路径 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 opt]# cd</font></div><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -e 'probe process("/opt/pgsql9.3beta2/bin/postgres").begin {printf("%s, %s, %d, %d\n", execname(), pp(), pid(), cpu()); exit();}'</font></div><div><font size="2"   >postgres, process("/opt/pgsql9.3beta2/bin/postgres").begin, 13707, 0</font></div><p></p></pre></div><div>注意这个进程并不是探测过程中新建的, 而是已经存在的, 和systemtap介绍的不一样?</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# ps -ewf|grep 13707</font></div><div><font size="2"   >pg93 &nbsp; &nbsp; 13707 &nbsp;3917 &nbsp;0 16:27 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: postgres digoal [local] idle</font></div><div><font size="2"   >root &nbsp; &nbsp; 14008 &nbsp;3537 &nbsp;0 16:29 pts/2 &nbsp; &nbsp;00:00:00 grep 13707</font></div><p></p></pre></div><div>.end 指进程消亡时倒是对的.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -e 'probe process("/opt/pgsql9.3beta2/bin/postgres").end {printf("%s, %s, %d, %d\n", execname(), pp(), pid(), cpu()); exit();}'</font></div><div><font size="2"   >进程退出后, 输出如下 :&nbsp;</font></div><div><font size="2"   >postgres, process("/opt/pgsql9.3beta2/bin/postgres").end, 13707, 4</font></div><p></p></pre></div><div>2. 进程的系统调用</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Constructs:</font></div><div><font size="2"   >process.syscall</font></div><div><font size="2"   >process("PATH").syscall</font></div><div><font size="2"   >process(PID).syscall</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >process.syscall.return</font></div><div><font size="2"   >process("PATH").syscall.return</font></div><div><font size="2"   >process(PID).syscall.return</font></div><div><font size="2"   >The .syscall variant is called when a thread described by PID or PATH makes a system call.&nbsp;</font></div><div><font size="2"   >The system call number is available in the $syscall context variable.&nbsp;</font></div><div><font size="2"   >The first six arguments of the system call are available in the $argN parameter, for example $arg1, $arg2, and so on.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The .syscall.return variant is called when a thread described by PID or PATH returns from a system call.&nbsp;</font></div><div><font size="2"   >The system call number is available in the $syscall context variable.&nbsp;</font></div><div><font size="2"   >The return value of the system call is available in the $return context variable.</font></div><p></p></pre></div><div>以上为指定进程或所有进程的系统调用探针的用法.</div><div><br></div><div>操作系统中支持哪些系统调用可以通过stap -l 'syscall.**'来输出.</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -l 'syscall.**'|less</font></div><div><div><font size="2"   >syscall.accept</font></div><div><font size="2"   >syscall.accept.return</font></div><div><font size="2"   >syscall.access</font></div><div><font size="2"   >syscall.access.return</font></div></div><div><font size="2"   >.....略</font></div><div><div><font size="2"   >syscall.write</font></div><div><font size="2"   >syscall.write.return</font></div></div><p></p></pre></div><div>举例 :&nbsp;</div><div>$syscall表示系统调用号, $arg1 - $arg6表示该系统调函数的前6个参数. .return不支持$arg, 但是支持$return.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -e 'probe process("/opt/pgsql9.3beta2/bin/postgres").syscall { printf("%s, %d, %s, %d, %d, %d\n", execname(), $syscall, pp(), pid(), cpu(), $arg1); } probe timer.s(1) { exit(); }'</font></div><div><font size="2"   >postgres, 0, process("/opt/pgsql9.3beta2/bin/postgres").syscall, 3918, 1, 3</font></div><div><font size="2"   >postgres, 7, process("/opt/pgsql9.3beta2/bin/postgres").syscall, 3918, 1, 140734936355648</font></div><div><font size="2"   >postgres, 45, process("/opt/pgsql9.3beta2/bin/postgres").syscall, 4583, 1, 6</font></div><div><font size="2"   >postgres, 45, process("/opt/pgsql9.3beta2/bin/postgres").syscall, 4591, 1, 7</font></div><div><font size="2"   >postgres, 0, process("/opt/pgsql9.3beta2/bin/postgres").syscall, 3920, 2, 3</font></div><div><font size="2"   >postgres, 0, process("/opt/pgsql9.3beta2/bin/postgres").syscall, 3921, 4, 3</font></div><div><font size="2"   >postgres, 0, process("/opt/pgsql9.3beta2/bin/postgres").syscall, 3922, 6, 3</font></div><div><font size="2"   >postgres, 0, process("/opt/pgsql9.3beta2/bin/postgres").syscall, 3924, 7, 3</font></div><div><font size="2"   >postgres, 7, process("/opt/pgsql9.3beta2/bin/postgres").syscall, 3921, 4, 140734936357808</font></div><div><font size="2"   >postgres, 7, process("/opt/pgsql9.3beta2/bin/postgres").syscall, 3920, 2, 140734936357776</font></div><div><font size="2"   >postgres, 7, process("/opt/pgsql9.3beta2/bin/postgres").syscall, 3922, 6, 140734936357808</font></div><div><font size="2"   >postgres, 7, process("/opt/pgsql9.3beta2/bin/postgres").syscall, 3924, 7, 140734936356176</font></div><div><font size="2"   >postgres, 0, process("/opt/pgsql9.3beta2/bin/postgres").syscall, 3923, 4, 3</font></div><div><font size="2"   >postgres, 7, process("/opt/pgsql9.3beta2/bin/postgres").syscall, 3923, 4, 140734936358000</font></div><div><font size="2"   >postgres, 45, process("/opt/pgsql9.3beta2/bin/postgres").syscall, 4758, 4, 7</font></div><div><font size="2"   >postgres, 0, process("/opt/pgsql9.3beta2/bin/postgres").syscall, 3922, 6, 3</font></div><div><font size="2"   >postgres, 7, process("/opt/pgsql9.3beta2/bin/postgres").syscall, 3922, 6, 140734936357808</font></div><div><font size="2"   >postgres, 0, process("/opt/pgsql9.3beta2/bin/postgres").syscall, 3922, 6, 3</font></div><div><font size="2"   >postgres, 7, process("/opt/pgsql9.3beta2/bin/postgres").syscall, 3922, 6, 140734936357808</font></div><div><font size="2"   >postgres, 0, process("/opt/pgsql9.3beta2/bin/postgres").syscall, 3922, 6, 3</font></div><div><font size="2"   >postgres, 7, process("/opt/pgsql9.3beta2/bin/postgres").syscall, 3922, 6, 140734936357808</font></div><div><font size="2"   >postgres, 0, process("/opt/pgsql9.3beta2/bin/postgres").syscall, 3922, 6, 3</font></div><div><font size="2"   >postgres, 7, process("/opt/pgsql9.3beta2/bin/postgres").syscall, 3922, 6, 140734936357808</font></div><p></p></pre></div><div>系统调用返回探针</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -e 'probe process("/opt/pgsql9.3beta2/bin/postgres").syscall.return { printf("%s, %d, %s, %d, %d, %d\n", execname(), $syscall, pp(), pid(), cpu(), $return); } probe timer.s(1) { exit(); }'</font></div><div><font size="2"   >postgres, 0, process("/opt/pgsql9.3beta2/bin/postgres").syscall.return, 3922, 6, -11</font></div><div><font size="2"   >postgres, 0, process("/opt/pgsql9.3beta2/bin/postgres").syscall.return, 3921, 4, -11</font></div><div><font size="2"   >postgres, 0, process("/opt/pgsql9.3beta2/bin/postgres").syscall.return, 3923, 4, -11</font></div><div><font size="2"   >postgres, 7, process("/opt/pgsql9.3beta2/bin/postgres").syscall.return, 3922, 6, 0</font></div><div><font size="2"   >postgres, 0, process("/opt/pgsql9.3beta2/bin/postgres").syscall.return, 3922, 6, -11</font></div><div><font size="2"   >postgres, 7, process("/opt/pgsql9.3beta2/bin/postgres").syscall.return, 3922, 6, 0</font></div><div><font size="2"   >postgres, 0, process("/opt/pgsql9.3beta2/bin/postgres").syscall.return, 3922, 6, -11</font></div><div><font size="2"   >postgres, 7, process("/opt/pgsql9.3beta2/bin/postgres").syscall.return, 3922, 6, 0</font></div><div><font size="2"   >postgres, 0, process("/opt/pgsql9.3beta2/bin/postgres").syscall.return, 3922, 6, -11</font></div><div><font size="2"   >postgres, 7, process("/opt/pgsql9.3beta2/bin/postgres").syscall.return, 3922, 6, 0</font></div><div><font size="2"   >postgres, 0, process("/opt/pgsql9.3beta2/bin/postgres").syscall.return, 3922, 6, -11</font></div><p></p></pre></div><div><br></div><div>3. 进程的函数或者语句级探针.</div><div>与内核的函数和语句级探针类似, 只是这里限定在指定进程的函数调用或者语句探针.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >Constructs:</font></div><div><font size="2"   >process("PATH").function("NAME")</font></div><div><font size="2"   >process("PATH").statement("*@FILE.c:123")</font></div><div><font size="2"   >process("PATH").function("*").return</font></div><div><font size="2"   >process("PATH").function("myfun").label("foo")</font></div><div><font size="2"   >Full symbolic source-level probes in userspace programs and shared libraries are supported.&nbsp;</font></div><div><font size="2"   >These are exactly analogous to the symbolic DWARF-based kernel or module probes described previously and expose similar contextual $-variables.</font></div></div><div><div><font size="2"   >Here is an example of prototype symbolic userspace probing support:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># stap -e 'probe process("ls").function("*").call {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;log (probefunc()." ".$$parms)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}' \</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;-c 'ls -l'</font></div><div><font size="2"   >To run, this script requires debugging information for the named program and utrace support in the kernel.&nbsp;</font></div><div><font size="2"   >If you see a "pass 4a-time" build failure, check that your kernel supports utrace.</font></div></div><p></p></pre></div><div>注意如果要使用进程的函数或语句级探针, 与DWARF-based kernel or module探针一样, 需要先安装debuginfo包(指对应的function或者statement指定的函数对应的debug信息), 当然也需要内核支持utrace.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# rpm -qa|grep debuginf</font></div><div><font size="2"   >kernel-debuginfo-common-2.6.18-348.12.1.el5</font></div><div><font size="2"   >kernel-debuginfo-2.6.18-348.12.1.el5</font></div><p></p></pre></div><div>进程级的函数或语句探针, 同样支持函数参数, 本地变量, 全局变量等. 详细介绍请参考</div></div><div><a href="http://blog.163.com/digoal@126/blog/static/1638770402013823101827553/"   >http://blog.163.com/digoal@126/blog/static/1638770402013823101827553/</a></div><div>举例 :&nbsp;</div><div>当进程不支持debuginfo时, 会报错 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -e 'probe process("/opt/pgsql9.3beta2/bin/postgres").function("tcp_v4_connect") { printf("%s, %d, %d, %s\n", pp(), pid(), cpu(), $$vars); } probe timer.s(1) { exit(); }'</font></div><div><font size="2"   >WARNING: cannot find module /opt/pgsql9.3beta2/bin/postgres debuginfo: No DWARF information found</font></div><div><font size="2"   >semantic error: while resolving probe point: identifier 'process' at &lt;input&gt;:1:7</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; source: probe process("/opt/pgsql9.3beta2/bin/postgres").function("tcp_v4_connect") { printf("%s, %d, %d, %s\n", pp(), pid(), cpu(), $$vars); } probe timer.s(1) { exit(); }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >semantic error: no match</font></div><div><font size="2"   >Pass 2: analysis failed. &nbsp;Try again with another '--vp 01' option.</font></div><p></p></pre></div><div>postgresql编译时未加--enable-dtrace参数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-39-&gt; pg_config --configure</font></div><div><font size="2"   >'--prefix=/opt/pgsql9.3beta2' '--with-pgport=1921' '--with-perl' '--with-python' '--with-openssl' '--with-pam' '--without-ldap' '--with-libxml' '--with-libxslt' '--enable-thread-safety' '--with-wal-blocksize=16'</font></div><p></p></pre></div><div><span style="line-height: 23px;"   >换个加了--enable-dtrace以及--enable-debug的试试 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg94@db-172-16-3-39-&gt; pg_config --configure</font></div><div><font size="2"   >'--prefix=/home/pg94/pgsql9.4devel' '--with-pgport=2999' '--with-perl' '--with-tcl' '--with-python' '--with-openssl' '--with-pam' '--without-ldap' '--with-libxml' '--with-libxslt' '--enable-thread-safety' '--with-wal-blocksize=16' '--enable-dtrace' '--enable-debug'</font></div><p></p></pre></div><div>可以了</div><div><pre class="prettyprint"   ><p><font size="2"   ><span style="line-height: 21px;"   >[root@db-172-16-3-150 ~]# /usr/bin/stap -e 'probe process("/home/pg93/pgsql9.3.1/bin/postgres").function("*") { printf("%s, %d, %d, %s\n", pp(), pid(), cpu(), probefunc()); }'<br>WARNING: u*probe failed postgres[10269] 'process("/home/pg93/pgsql9.3.1/bin/postgres").function("tas@../../../../src/include/storage/s_lock.h:204")' addr 00000000004b08fd rc -1<br>WARNING: u*probe failed postgres[10268] 'process("/home/pg93/pgsql9.3.1/bin/postgres").function("tas@../../../../src/include/storage/s_lock.h:204")' addr 00000000004b08fd rc -1<br>WARNING: u*probe failed postgres[10269] 'process("/home/pg93/pgsql9.3.1/bin/postgres").function("tas@../../../src/include/storage/s_lock.h:204")' addr 0000000000622070 rc -1<br>WARNING: u*probe failed postgres[10269] 'process("/home/pg93/pgsql9.3.1/bin/postgres").function("tas@../../../src/include/storage/s_lock.h:204")' addr 0000000000622160 rc -1<br>WARNING: u*probe failed postgres[10268] 'process("/home/pg93/pgsql9.3.1/bin/postgres").function("tas@../../../src/include/storage/s_lock.h:204")' addr 0000000000622070 rc -1<br>WARNING: u*probe failed postgres[10268] 'process("/home/pg93/pgsql9.3.1/bin/postgres").function("tas@../../../src/include/storage/s_lock.h:204")' addr 0000000000622160 rc -1<br>process("/home/pg93/pgsql9.3.1/bin/postgres").function("ResetLatch@/opt/soft_bak/postgresql-9.3.1/src/backend/port/pg_latch.c:552"), 10269, 1, ResetLatch<br>process("/home/pg93/pgsql9.3.1/bin/postgres").function("XLogBackgroundFlush@/opt/soft_bak/postgresql-9.3.1/src/backend/access/transam/xlog.c:2074"), 10269, 1, XLogBackgroundFlush<br>process("/home/pg93/pgsql9.3.1/bin/postgres").function("RecoveryInProgress@/opt/soft_bak/postgresql-9.3.1/src/backend/access/transam/xlog.c:6223"), 10269, 1, RecoveryInProgress<br>process("/home/pg93/pgsql9.3.1/bin/postgres").function("tas@../../../../src/include/storage/s_lock.h:204"), 10269, 1, tas<br>process("/home/pg93/pgsql9.3.1/bin/postgres").function("tas@../../../../src/include/storage/s_lock.h:204"), 10269, 1, tas<br>process("/home/pg93/pgsql9.3.1/bin/postgres").function("WaitLatch@/opt/soft_bak/postgresql-9.3.1/src/backend/port/pg_latch.c:194"), 10269, 1, WaitLatch</span></font></p><p><font size="2"   ><span style="line-height: 21px;"   >......略</span></font></p></pre></div><div>使用stap -l输出支持的探针.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 21px;"   >[root@db-172-16-3-150 ~]# /usr/bin/stap -l 'process("/home/pg93/pgsql9.3.1/bin/postgres").function("*")'|less<br>process("/home/pg93/pgsql9.3.1/bin/postgres").function("ATAddCheckConstraint@/opt/soft_bak/postgresql-9.3.1/src/backend/commands/tablecmds.c:5659")<br>process("/home/pg93/pgsql9.3.1/bin/postgres").function("ATAddForeignKeyConstraint@/opt/soft_bak/postgresql-9.3.1/src/backend/commands/tablecmds.c:5780")<br>process("/home/pg93/pgsql9.3.1/bin/postgres").function("ATColumnChangeRequiresRewrite@/opt/soft_bak/postgresql-9.3.1/src/backend/commands/tablecmds.c:7382")<br>process("/home/pg93/pgsql9.3.1/bin/postgres").function("ATController@/opt/soft_bak/postgresql-9.3.1/src/backend/commands/tablecmds.c:2913")</span></font></div><div><font size="2"   ><span style="line-height: 21px;"   >... 略</span></font></div><p></p></pre></div><div>使用系统提供的例子 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -e 'probe process("ls").function("*").call {</font></div><div><font size="2"   >&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;log (probefunc()." ".$$parms)</font></div><div><font size="2"   >&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}' \</font></div><div><font size="2"   >&gt; &nbsp; &nbsp; &nbsp; &nbsp;-c 'ls -l'</font></div><div><font size="2"   >WARNING: cannot find module /bin/ls debuginfo: No DWARF information found</font></div><div><font size="2"   >semantic error: while resolving probe point: identifier 'process' at &lt;input&gt;:1:7</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; source: probe process("ls").function("*").call {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >semantic error: no match</font></div><div><font size="2"   >Pass 2: analysis failed. &nbsp;Try again with another '--vp 01' option.</font></div><div><font size="2"   >Missing separate debuginfos, use: debuginfo-install coreutils-5.97-34.el5.x86_64&nbsp;</font></div><p></p></pre></div><div>以上报错原因是系统中未安装ls的debuginfo.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -l 'process("/bin/ls").function("**")'</font></div><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -l 'process("/bin/ls").function("*")'</font></div><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -l 'process("/bin/ls").function("*.*")'</font></div><p></p></pre></div><div><br></div><div>4.&nbsp;Absolute variant</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >A non-symbolic probe point such as process(PID).statement(ADDRESS).absolute is analogous to&nbsp;</font></div><div><font size="2"   >kernel.statement(ADDRESS).absolute in that both use raw, unverified virtual addresses and provide no $variables.&nbsp;</font></div><div><font size="2"   >The target PID parameter must identify a running process and ADDRESS must identify a valid instruction address.&nbsp;</font></div><div><font size="2"   >All threads of the listed process will be probed.&nbsp;</font></div><div><font size="2"   >This is a guru mode probe.</font></div><p></p></pre></div><div>必须使用stap -g 模式运行.</div><div><br></div><div>5. 进程路径搜索(PATH).</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >For all process probes, PATH names refer to executables that are searched the same way that shells do: the explicit path specified if the path name begins with a slash (/) character sequence; otherwise $PATH is searched. For example, the following probe syntax:</font></div><div><font size="2"   >probe process("ls").syscall {}</font></div><div><font size="2"   >probe process("./a.out").syscall {}</font></div><div><font size="2"   >works the same as:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >probe process("/bin/ls").syscall {}</font></div><div><font size="2"   >probe process("/my/directory/a.out").syscall {}</font></div><div><font size="2"   >If a process probe is specified without a PID or PATH parameter, all user threads are probed. However, if systemtap is invoked in target process mode, process probes are restricted to the process hierarchy associated with the target process. If stap is running in -unprivileged mode, only processes owned by the current user are selected.</font></div><p></p></pre></div><div>相对路径, 绝对路径, 或者当前环境$PATH下搜索.</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >root@db-172-16-3-39-&gt; which postgres</font></div><div><font size="2"   >/home/pg94/pgsql9.4devel/bin/postgres</font></div></div><div><div><font size="2"   >root@db-172-16-3-39-&gt; whoami</font></div><div><font size="2"   >root</font></div></div><div><font size="2"   >当前环境中搜索</font></div><div><div><font size="2"   >root@db-172-16-3-39-&gt; stap -e 'probe process("postgres").syscall { printf("%s, %d\n", pp(), $syscall); exit() }'</font></div><div><font size="2"   >process("/home/pg94/pgsql9.4devel/bin/postgres").syscall, 23</font></div></div><div><font size="2"   >相对路径</font></div><div><div><font size="2"   >root@db-172-16-3-39-&gt; stap -e 'probe process("pgsql9.4devel/bin/postgres").syscall { printf("%s, %d\n", pp(), $syscall); exit() }'</font></div><div><font size="2"   >process("/home/pg94/pgsql9.4devel/bin/postgres").syscall, 0</font></div></div><div><font size="2"   >绝对路径</font></div><div><div><font size="2"   >root@db-172-16-3-39-&gt; stap -e 'probe process("/home/pg94/pgsql9.4devel/bin/postgres").syscall { printf("%s, %d\n", pp(), $syscall); exit() }'</font></div><div><font size="2"   >process("/home/pg94/pgsql9.4devel/bin/postgres").syscall, 0</font></div></div><p></p></pre></div><div><br></div><div>未完待续.</div><div><span style="line-height: 23px;"   >[参考]</span></div><wbr><div>1.&nbsp;<a style="line-height: 23px;" rel="nofollow" href="https://sourceware.org/systemtap/langref/Probe_points.html"   >https://sourceware.org/systemtap/langref/Probe_points.html</a></div><div>2.&nbsp;<a style="line-height: 23px;" rel="nofollow" href="http://lwn.net/Articles/499190/"   >http://lwn.net/Articles/499190/</a></div><div>3.&nbsp;<a style="line-height: 23px;" rel="nofollow" href="http://lwn.net/Articles/224772/"   >http://lwn.net/Articles/224772/</a></div><div>4.&nbsp;/usr/share/doc/kernel-doc-x.x.x/Documentation/utrace.txt</div><div>5.&nbsp;<a style="line-height: 23px;" href="http://blog.163.com/digoal@126/blog/static/1638770402013823101827553/"   >http://blog.163.com/digoal@126/blog/static/1638770402013823101827553/</a></div>6.&nbsp;<a rel="nofollow" href="https://sourceware.org/systemtap/SystemTap_Beginners_Guide/userspace-probing.html"   >https://sourceware.org/systemtap/SystemTap_Beginners_Guide/userspace-probing.html</a></div>
	</div>
</div>
</body>
</html>