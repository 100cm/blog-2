<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">systemtap probe point followed by ! or ? or "if (expr)"</h2>
	<h5 id="">2013-09-11 10:16:16&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013811957335/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>首先截取 man stapprobes 中的一段介绍 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;However, &nbsp;a &nbsp;probe point may be followed by a "?" character, to indicate that it is optional, and that no error</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;should result if it fails to resolve. &nbsp;Optionalness passes down through all levels of alias/wildcard expansion.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;Alternately, &nbsp;a probe point may be followed by a "!" character, to indicate that it is both optional and suffi-</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;cient. &nbsp;(Think vaguely of the Prolog cut operator.) If it does resolve, then no further &nbsp;probe &nbsp;points &nbsp;in &nbsp;the</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;same comma-separated list will be resolved. &nbsp;Therefore, the "!" &nbsp;sufficiency mark only makes sense in a list of</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;probe point alternatives.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;Additionally, a probe point may be followed by a "if (expr)" statement, in order to &nbsp;enable/disable &nbsp;the &nbsp;probe</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;point &nbsp;on-the-fly. With the "if" statement, if the "expr" is false when the probe point is hit, the whole probe</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;body including alias’s body is skipped. The condition is stacked up through all levels of alias/wildcard expan-</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;sion. So the final condition becomes the logical-and of conditions of all expanded alias/wildcard.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;These &nbsp;are &nbsp;all &nbsp;syntactically &nbsp;valid probe points. &nbsp;(They are generally semantically invalid, depending on the</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;contents of the tapsets, and the versions of kernel/user software installed.)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kernel.function("foo").return</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; process("/bin/vi").statement(0x2222)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; end</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; syscall.*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sys**open</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kernel.function("no_such_function") ?</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; module("awol").function("no_such_function") !</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; signal.*? if (switch)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; kprobe.function("foo")</font></div><p></p></pre></div><div>正常情况下, 如果probe point在路径中搜索不到, 会报错, 如下notexists这个point不存在, 所以报错了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap --vp 5 -e "probe notexists { exit() }"</font></div><div><font size="2"   >Parsed kernel "/lib/modules/2.6.18-348.12.1.el5/build/.config", containing 1977 tuples</font></div><div><font size="2"   >Parsed kernel /lib/modules/2.6.18-348.12.1.el5/build/Module.symvers, which contained 3546 vmlinux exports</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 4, processed: 4</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/*.stp ", found: 81, processed: 81</font></div><div><font size="2"   >Pass 1: parsed user script and 85 library script(s) using 147256virt/23696res/3012shr/21852data kb, in 170usr/10sys/172real ms.</font></div><div><font size="2"   >semantic error: while resolving probe point: identifier 'notexists' at &lt;input&gt;:1:7</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; source: probe notexists { exit() }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >semantic error: probe point mismatch at position 0 &nbsp;(alternatives: __nfs __scheduler __signal __tcpmib __vm _linuxmib _signal _sunrpc _syscall _vfs begin begin(number) end end(number) error error(number) generic ioblock ioblock_trace ioscheduler ioscheduler_trace ipmib irq_handler kernel kprobe kprocess linuxmib module(string) nd_syscall netdev netfilter never nfs nfsd perf process process(number) process(string) procfs procfs(string) scheduler scsi signal socket softirq stap staprun sunrpc syscall tcp tcpmib timer tty udp vfs vm workqueue): identifier 'notexists' at :1:7</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; source: probe notexists { exit() }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Pass 2: analysis failed. &nbsp;Try again with another '--vp 01' option.</font></div><p></p></pre></div><div><br></div><div>使用?表示如果这个point不存在, 也不会报错, 如下.</div><div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-39 ~]# stap --vp 5 -e "probe notexists ? { exit() }"</font></div><div><font size="2"   >Parsed kernel "/lib/modules/2.6.18-348.12.1.el5/build/.config", containing 1977 tuples</font></div><div><font size="2"   >Parsed kernel /lib/modules/2.6.18-348.12.1.el5/build/Module.symvers, which contained 3546 vmlinux exports</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 4, processed: 4</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/*.stp ", found: 81, processed: 81</font></div><div><font size="2"   >Pass 1: parsed user script and 85 library script(s) using 147756virt/23716res/3012shr/22352data kb, in 160usr/10sys/172real ms.</font></div><div><font size="2"   >semantic error: no probes found</font></div><div><font size="2"   >Pass 2: analysis failed. &nbsp;Try again with another '--vp 01' option.</font></div></div><div></div><p></p></pre></div></div><div><br></div><div>!和?差不多, 具有不存在着不报错的功能, 如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap --vp 5 -e "probe notexists ! { exit() }"</font></div><div><font size="2"   >Parsed kernel "/lib/modules/2.6.18-348.12.1.el5/build/.config", containing 1977 tuples</font></div><div><font size="2"   >Parsed kernel /lib/modules/2.6.18-348.12.1.el5/build/Module.symvers, which contained 3546 vmlinux exports</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 4, processed: 4</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/*.stp ", found: 81, processed: 81</font></div><div><font size="2"   >Pass 1: parsed user script and 85 library script(s) using 146788virt/23696res/3012shr/21384data kb, in 170usr/10sys/172real ms.</font></div><div><font size="2"   >semantic error: no probes found</font></div><div><font size="2"   >Pass 2: analysis failed. &nbsp;Try again with another '--vp 01' option.</font></div><p></p></pre></div><div><br></div><div>!同时还具备一个功能, 如果一个probe 中定义了多个point, 那么使用了!的point只要被检索到了, 这个列表中的其他point都不会被解析. 例如.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# cat test.stp</font></div><div><font size="2"   >probe a=begin {</font></div><div><font size="2"   >&nbsp; printf("a\n")</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe b=begin {</font></div><div><font size="2"   >&nbsp; printf("b\n")</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe c !, b !, a {</font></div><div><font size="2"   >&nbsp; printf("optinal and suffieince\n")</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-39 ~]# stap --vp 5 test.stp&nbsp;</font></div><div><font size="2"   >Parsed kernel "/lib/modules/2.6.18-348.12.1.el5/build/.config", containing 1977 tuples</font></div><div><font size="2"   >Parsed kernel /lib/modules/2.6.18-348.12.1.el5/build/Module.symvers, which contained 3546 vmlinux exports</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 4, processed: 4</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/*.stp ", found: 81, processed: 81</font></div><div><font size="2"   >Pass 1: parsed user script and 85 library script(s) using 146868virt/23712res/3008shr/21464data kb, in 170usr/0sys/172real ms.</font></div><div><font size="2"   >b</font></div><div><font size="2"   >optinal and suffieince</font></div><p></p></pre></div><div>point a不存在, 使用!不报错.</div><div>point b存在, 同时使用了!, 所以位于b后面的point a不会被解析.</div><div>如果把!放在a后面, b可以被解析, 因为b在a前面.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-39 ~]# vi test.stp&nbsp;</font></div><div><font size="2"   >probe a=begin {</font></div><div><font size="2"   >&nbsp; printf("a\n")</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe b=begin {</font></div><div><font size="2"   >&nbsp; printf("b\n")</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe c !, b , a ! {</font></div><div><font size="2"   >&nbsp; printf("optinal and suffieince\n")</font></div><div><font size="2"   >}</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@db-172-16-3-39 ~]# stap --vp 5 test.stp&nbsp;</font></div><div><font size="2"   >Parsed kernel "/lib/modules/2.6.18-348.12.1.el5/build/.config", containing 1977 tuples</font></div><div><font size="2"   >Parsed kernel /lib/modules/2.6.18-348.12.1.el5/build/Module.symvers, which contained 3546 vmlinux exports</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 4, processed: 4</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/*.stp ", found: 81, processed: 81</font></div><div><font size="2"   >Pass 1: parsed user script and 85 library script(s) using 146796virt/23700res/3008shr/21392data kb, in 160usr/10sys/173real ms.</font></div><div><font size="2"   >b</font></div><div><font size="2"   >optinal and suffieince</font></div><div><font size="2"   >a</font></div><div><font size="2"   >optinal and suffieince</font></div></div><p></p></pre></div><div><br></div><div>再如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# cat test.stp&nbsp;</font></div><div><font size="2"   >probe a=begin {</font></div><div><font size="2"   >&nbsp; printf("a\n")</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe b=begin {</font></div><div><font size="2"   >&nbsp; printf("b\n")</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe c !, b, b, a, a !, b, a {</font></div><div><font size="2"   >&nbsp; printf("optinal and suffieince\n")</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-39 ~]# stap --vp 5 test.stp&nbsp;</font></div><div><font size="2"   >Parsed kernel "/lib/modules/2.6.18-348.12.1.el5/build/.config", containing 1977 tuples</font></div><div><font size="2"   >Parsed kernel /lib/modules/2.6.18-348.12.1.el5/build/Module.symvers, which contained 3546 vmlinux exports</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 4, processed: 4</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/*.stp ", found: 81, processed: 81</font></div><div><font size="2"   >Pass 1: parsed user script and 85 library script(s) using 146808virt/23700res/3008shr/21404data kb, in 160usr/10sys/172real ms.</font></div><div><font size="2"   >b</font></div><div><font size="2"   >optinal and suffieince</font></div><div><font size="2"   >b</font></div><div><font size="2"   >optinal and suffieince</font></div><div><font size="2"   >a</font></div><div><font size="2"   >optinal and suffieince</font></div><div><font size="2"   >a</font></div><div><font size="2"   >optinal and suffieince</font></div><p></p></pre></div><div><br></div><div>最后是在probe point后面使用表达式 if (exp) :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# cat test.stp</font></div><div><font size="2"   >probe begin if($1) {</font></div><div><font size="2"   >&nbsp; printf("%d is true\n", $1)</font></div><div><font size="2"   >&nbsp; exit()</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div>非0表示true, 被触发</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap --vp 5 test.stp 1</font></div><div><font size="2"   >Parsed kernel "/lib/modules/2.6.18-348.12.1.el5/build/.config", containing 1977 tuples</font></div><div><font size="2"   >Parsed kernel /lib/modules/2.6.18-348.12.1.el5/build/Module.symvers, which contained 3546 vmlinux exports</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 4, processed: 4</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/*.stp ", found: 81, processed: 81</font></div><div><font size="2"   >Pass 1: parsed user script and 85 library script(s) using 147760virt/23712res/3008shr/22356data kb, in 160usr/10sys/172real ms.</font></div><div><font size="2"   >1 is true</font></div><p></p></pre></div><div>0表示false, 那么这个事件不会被触发.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap --vp 5 test.stp 0</font></div><div><font size="2"   >Parsed kernel "/lib/modules/2.6.18-348.12.1.el5/build/.config", containing 1977 tuples</font></div><div><font size="2"   >Parsed kernel /lib/modules/2.6.18-348.12.1.el5/build/Module.symvers, which contained 3546 vmlinux exports</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 4, processed: 4</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/*.stp ", found: 81, processed: 81</font></div><div><font size="2"   >Pass 1: parsed user script and 85 library script(s) using 146788virt/23684res/3008shr/21384data kb, in 170usr/0sys/172real ms.</font></div><p></p></pre></div></div><div><br></div><div>[参考]</div><div>1. man stapprobes</div><div><br></div><wbr></div>
	</div>
</div>
</body>
</html>