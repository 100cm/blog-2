<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL pending patch : Compression of full-page-writes</h2>
	<h5 id="">2013-09-19 21:01:49&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201381963422198/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Done. Attached is the updated version of the patch.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >In this patch, full_page_writes accepts three values: on, compress, and off.</font></div><div><font size="2"   >When it's set to compress, the full page image is compressed before it's</font></div><div><font size="2"   >inserted into the WAL buffers.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >I measured how much this patch affects the performance and the WAL</font></div><div><font size="2"   >volume again, and I also measured how much this patch affects the</font></div><div><font size="2"   >recovery time.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >* Server spec</font></div><div><font size="2"   >&nbsp; CPU: 8core, Intel(R) Core(TM) i7-3630QM CPU @ 2.40GHz</font></div><div><font size="2"   >&nbsp; Mem: 16GB</font></div><div><font size="2"   >&nbsp; Disk: 500GB SSD Samsung 840</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >* Benchmark</font></div><div><font size="2"   >&nbsp; pgbench -c 32 -j 4 -T 900 -M prepared</font></div><div><font size="2"   >&nbsp; scaling factor: 100</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; checkpoint_segments = 1024</font></div><div><font size="2"   >&nbsp; checkpoint_timeout = 5min</font></div><div><font size="2"   >&nbsp; (every checkpoint during benchmark were triggered by checkpoint_timeout)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >* Result</font></div><div><font size="2"   >&nbsp; [tps]</font></div><div><font size="2"   >&nbsp; 1344.2 (full_page_writes = on)</font></div><div><font size="2"   >&nbsp; 1605.9 (compress)</font></div><div><font size="2"   >&nbsp; 1810.1 (off)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; [the amount of WAL generated during running pgbench]</font></div><div><font size="2"   >&nbsp; 4422 MB (on)</font></div><div><font size="2"   >&nbsp; 1517 MB (compress)</font></div><div><font size="2"   >&nbsp; &nbsp; 885 MB (off)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; [time required to replay WAL generated during running pgbench]</font></div><div><font size="2"   >&nbsp; 61s (on) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .... 1209911 transactions were replayed,</font></div><div><font size="2"   >recovery speed: 19834.6 transactions/sec</font></div><div><font size="2"   >&nbsp; 39s (compress) &nbsp; &nbsp; &nbsp;.... 1445446 transactions were replayed,</font></div><div><font size="2"   >recovery speed: 37062.7 transactions/sec</font></div><div><font size="2"   >&nbsp; 37s (off) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .... 1629235 transactions were replayed,</font></div><div><font size="2"   >recovery speed: 44033.3 transactions/sec</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >When full_page_writes is disabled, the recovery speed is basically very low</font></div><div><font size="2"   >because of random I/O. But, ISTM that, since I was using SSD in my box,</font></div><div><font size="2"   >the recovery with full_page_writse=off was fastest.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Regards,</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >--&nbsp;</font></div><div><font size="2"   >Fujii Masao</font></div><p></p></pre></div><div>这个补丁针对full page write写, 在将块插入wal buffer之前, 使用pg_lzcompress进行压缩.</div><div>这么做的好处是减少了wal的大小, 可以节省xlog归档的归档存储, 对应wal写成为瓶颈的数据库也可以起到缓解作用. 同时对于流复制环境也是有帮助的, 它显然可以减少网络上传输的xlog数据量. 当然在数据库做pitr恢复时, 解压也会带来一些额外的计算量. 不过总体来说, 现在的瓶颈还是在io上的场景比较多一些.&nbsp;</div><div>本补丁只是增加了一种full page write的选择, 你如果觉得没有必要的话, 完全可以不开启压缩. 通过参数full_page_writes进行配置.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >! #full_page_writes = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# recover from partial page writes;</font></div><div><font size="2"   >! &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # off, compress, or on</font></div><p></p></pre></div><div>测试 :&nbsp;</div><div>使用PostgreSQL源码镜像如下 :&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >wget 'http://git.postgresql.org/gitweb/?p=postgresql.git;a=snapshot;h=71901ab6daaad65c0168c05e016e4208efe5b71a;sf=tgz'</font></div><div></div><p></p></pre><div><span style="line-height: 23px;"   >打补丁 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# cd /opt/soft_bak/postgresql-<span style="line-height: 23px;"   >71901ab</span></font></div><div><font size="2"   >[root@db-172-16-3-39 postgresql-<span style="line-height: 23px;"   >71901ab</span>]# wget http://www.postgresql.org/message-id/attachment/30082/compress_fpw_v2.patch</font></div><div><font size="2"   >[root@db-172-16-3-39 postgresql-<span style="line-height: 23px;"   >71901ab</span>]# patch -p1 &lt; compress_fpw_v2.patch&nbsp;</font></div><div><font size="2"   >[root@db-172-16-3-39 postgresql-71901ab]# ./configure --prefix=/home/pg94/pgsql9.4devel --with-pgport=2999 --with-perl --with-tcl --with-python --with-openssl --with-pam --without-ldap --with-libxml --with-libxslt --enable-thread-safety --with-wal-blocksize=16 --enable-dtrace &amp;&amp; gmake &amp;&amp; gmake install</font></div><div><span style="line-height: 23px;"   ><font size="2"   >[root@db-172-16-3-39 postgresql-71901ab]# cd contrib</font></span></div><div><span style="line-height: 23px;"   ><font size="2"   >[root@db-172-16-3-39 postgresql-71901ab]# gmake &amp;&amp; gmake install</font></span></div><div><font size="2"   >[root@db-172-16-3-39 postgresql-<span style="line-height: 23px;"   >71901ab</span>]# su - pg94</font></div><div><span style="line-height: 23px;"   ><font size="2"   >pg94@db-172-16-3-39-&gt; initdb -D $PGDATA -E UTF8 --locale=C -W -U postgres</font></span></div><div><div><font size="2"   >pg94@db-172-16-3-39-&gt; cd $PGDATA</font></div></div><p></p></pre></div><div><div>使用如下数据库配置 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg94@db-172-16-3-39-&gt; vi postgresql.conf&nbsp;</font></div></div><div><div><font size="2"   >listen_addresses = '0.0.0.0' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# what IP address(es) to listen on;</font></div><div><font size="2"   >port = 2999 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >max_connections = 1000 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   >superuser_reserved_connections = 13 &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >unix_socket_directories = '.' &nbsp; # comma-separated list of directories</font></div><div><font size="2"   >unix_socket_permissions = 0700 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# begin with 0 to use octal notation</font></div><div><font size="2"   >shared_buffers = 1024MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 128kB</font></div><div><font size="2"   >maintenance_work_mem = 512MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# min 1MB</font></div><div><font size="2"   >shared_preload_libraries = 'pg_stat_statements' &nbsp; &nbsp; &nbsp; &nbsp; # (change requires restart)</font></div><div><font size="2"   >wal_level = hot_standby &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # minimal, archive, or hot_standby</font></div><div><font size="2"   >synchronous_commit = off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# synchronization level;</font></div><div><font size="2"   >wal_sync_method = fdatasync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # the default is the first option</font></div><div><font size="2"   >full_page_writes = compress &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# recover from partial page writes</font></div><div><font size="2"   >wal_buffers = 16384kB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # min 32kB, -1 sets based on shared_buffers</font></div><div><font size="2"   >wal_writer_delay = 20ms &nbsp; &nbsp; &nbsp; &nbsp; # 1-10000 milliseconds</font></div><div><font size="2"   >checkpoint_segments = 128 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # in logfile segments, min 1, 16MB each</font></div><div><font size="2"   >max_wal_senders = 32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# max number of walsender processes</font></div><div><font size="2"   >wal_keep_segments = 128 &nbsp; &nbsp; &nbsp; &nbsp; # in logfile segments, 16MB each; 0 disables</font></div><div><font size="2"   >hot_standby = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# "on" allows queries during recovery</font></div><div><font size="2"   >max_standby_archive_delay = -1 &nbsp;# max delay before canceling queries</font></div><div><font size="2"   >max_standby_streaming_delay = -1 &nbsp; &nbsp; &nbsp; &nbsp;# max delay before canceling queries</font></div><div><font size="2"   >wal_receiver_status_interval = 1s &nbsp; &nbsp; &nbsp; # send replies at least this often</font></div><div><font size="2"   >hot_standby_feedback = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # send info from standby to prevent</font></div><div><font size="2"   >random_page_cost = 1.0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# same scale as above</font></div><div><font size="2"   >effective_cache_size = 10240MB</font></div><div><font size="2"   >log_destination = 'csvlog' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Valid values are combinations of</font></div><div><font size="2"   >logging_collector = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Enable capturing of stderr and csvlog</font></div><div><font size="2"   >log_directory = 'pg_log' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# directory where log files are written,</font></div><div><font size="2"   >log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log' # log file name pattern,</font></div><div><font size="2"   >log_file_mode = 0600 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# creation mode for log files,</font></div><div><font size="2"   >log_truncate_on_rotation = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # If on, an existing log file with the</font></div><div><font size="2"   >log_rotation_age = 1d &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Automatic rotation of logfiles will</font></div><div><font size="2"   >log_rotation_size = 10MB &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# Automatic rotation of logfiles will</font></div><div><font size="2"   >log_min_duration_statement = 1s # -1 is disabled, 0 logs all statements</font></div><div><font size="2"   >log_checkpoints = on</font></div><div><font size="2"   >log_connections = on</font></div><div><font size="2"   >log_disconnections = on</font></div><div><font size="2"   >log_error_verbosity = verbose &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # terse, default, or verbose messages</font></div><div><font size="2"   >log_lock_waits = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # log lock waits &gt;= deadlock_timeout</font></div><div><font size="2"   >log_statement = 'ddl' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # none, ddl, mod, all</font></div><div><font size="2"   >log_timezone = 'PRC'</font></div><div><font size="2"   >track_activity_query_size = 2048 &nbsp; &nbsp; &nbsp; &nbsp;# (change requires restart)</font></div><div><font size="2"   >autovacuum = on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Enable autovacuum subprocess? &nbsp;'on'</font></div><div><font size="2"   >log_autovacuum_min_duration = 0 # -1 disables, 0 logs all actions and</font></div><div><font size="2"   >datestyle = 'iso, mdy'</font></div><div><font size="2"   >timezone = 'PRC'</font></div><div><font size="2"   >lc_messages = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for system error message</font></div><div><font size="2"   >lc_monetary = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for monetary formatting</font></div><div><font size="2"   >lc_numeric = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# locale for number formatting</font></div><div><font size="2"   >lc_time = 'C' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # locale for time formatting</font></div><div><font size="2"   >default_text_search_config = 'pg_catalog.english'</font></div><div><font size="2"   >pg_stat_statements.max = 1000</font></div><div><font size="2"   >pg_stat_statements.track = all</font></div></div><p></p></pre></div></div><div>full_page_writes配置为压缩模式 :&nbsp;<span style="white-space:pre;"   >	</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg94@db-172-16-3-39-&gt; pg_ctl restart -m fast</font></div><div><div><font size="2"   >pg94@db-172-16-3-39-&gt; psql</font></div><div><font size="2"   >psql (9.4devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# show full_page_writes;</font></div><div><font size="2"   >&nbsp;full_page_writes&nbsp;</font></div><div><font size="2"   >------------------</font></div><div><font size="2"   >&nbsp;compress</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>创建测试表以及测试函数 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# create table test(id int primary key, info text, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div></div><div><div><font size="2"   >digoal=# create or replace function f_test(i_id int) returns void as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; update test set crt_time=clock_timestamp() where id=i_id;</font></div><div><font size="2"   >&nbsp; if not found then</font></div><div><font size="2"   >&nbsp; &nbsp; insert into test values (i_id, md5(random()::text), clock_timestamp());</font></div><div><font size="2"   >&nbsp; end if;&nbsp;</font></div><div><font size="2"   >&nbsp; return;</font></div><div><font size="2"   >&nbsp; exception&nbsp;</font></div><div><font size="2"   >&nbsp; when others then</font></div><div><font size="2"   >&nbsp; &nbsp; return;</font></div><div><font size="2"   >end; &nbsp;&nbsp;</font></div><div><font size="2"   >$$ language plpgsql strict;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >digoal=# select f_test(1);</font></div><div><font size="2"   >&nbsp;f_test&nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select f_test(1);</font></div><div><font size="2"   >&nbsp;f_test&nbsp;</font></div><div><font size="2"   >--------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select * from test;</font></div><div><font size="2"   >&nbsp;id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+----------------------------------+----------------------------</font></div><div><font size="2"   >&nbsp; 1 | d6eaddd7dc776cf8eafd094afab4b8ac | 2013-09-19 18:39:01.046142</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><span style="line-height: 23px;"   >测试1 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >使用如下pgbench测试脚本.</font></div><div><div><font size="2"   >pg94@db-172-16-3-39-&gt; vi test.sql</font></div><div><font size="2"   >\setrandom id 1 5000000</font></div><div><font size="2"   >select f_test(:id);</font></div></div><div><font size="2"   >获取当前的xlog位置.</font></div><div><div><font size="2"   >pg94@db-172-16-3-39-&gt; psql</font></div><div><font size="2"   >psql (9.4devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div></div><div><div><font size="2"   >digoal=# select pg_current_xlog_location();</font></div><div><font size="2"   >&nbsp;pg_current_xlog_location&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;0/18411F0</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   >使用pgbench提交160W次函数请求.</font></div><div><div><font size="2"   >pg94@db-172-16-3-39-&gt; pgbench -M prepared -n -r -f ./test.sql -P 3 -c 16 -j 4 -t 100000&nbsp;</font></div><div><font size="2"   >progress: 3.0 s, 42121.0 tps, 0.380 ms lat</font></div><div><font size="2"   >progress: 6.0 s, 44615.4 tps, 0.359 ms lat</font></div><div><font size="2"   >progress: 9.0 s, 44958.5 tps, 0.356 ms lat</font></div><div><font size="2"   >progress: 12.0 s, 44280.3 tps, 0.361 ms lat</font></div><div><font size="2"   >progress: 15.0 s, 44530.0 tps, 0.359 ms lat</font></div><div><font size="2"   >progress: 18.0 s, 44618.3 tps, 0.359 ms lat</font></div><div><font size="2"   >progress: 21.0 s, 44605.5 tps, 0.359 ms lat</font></div><div><font size="2"   >progress: 24.0 s, 44400.1 tps, 0.360 ms lat</font></div><div><font size="2"   >progress: 27.0 s, 44794.4 tps, 0.357 ms lat</font></div><div><font size="2"   >progress: 30.0 s, 44801.6 tps, 0.357 ms lat</font></div><div><font size="2"   >progress: 33.0 s, 44349.6 tps, 0.361 ms lat</font></div><div><font size="2"   >progress: 36.0 s, 41668.4 tps, 0.384 ms lat</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >number of transactions per client: 100000</font></div><div><font size="2"   >number of transactions actually processed: 1600000/1600000</font></div><div><font size="2"   >tps = 43774.563515 (including connections establishing)</font></div><div><font size="2"   >tps = 43792.470057 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.001522 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 5000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.353626 &nbsp; &nbsp; &nbsp; &nbsp;select f_test(:id);</font></div></div><div><font size="2"   >测试完后执行checkpoint, 并获得当前的xlog位置</font></div><div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><div><font size="2"   >digoal=# select pg_current_xlog_location();</font></div><div><font size="2"   >&nbsp;pg_current_xlog_location&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;0/18EFFC20</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   >得到压力测试过程产生的xlog大小.</font></div><div><div><font size="2"   >digoal=# select pg_xlog_location_diff('0/18EFFC20', '0/18411F0');</font></div><div><font size="2"   >&nbsp;pg_xlog_location_diff&nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;392948272</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>测试2 :&nbsp;</div><div>改为on</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >full_page_writes = on</font></div><div><font size="2"   >pg94@db-172-16-3-39-&gt; pg_ctl restart -m fast</font></div><div><div><font size="2"   >digoal=# select pg_current_xlog_location();</font></div><div><font size="2"   >&nbsp;pg_current_xlog_location&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;0/18EFFC88</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >pg94@db-172-16-3-39-&gt; pgbench -M prepared -n -r -f ./test.sql -P 3 -c 16 -j 4 -t 100000&nbsp;</font></div><div><font size="2"   >progress: 3.0 s, 36457.6 tps, 0.439 ms lat</font></div><div><font size="2"   >progress: 6.0 s, 42782.2 tps, 0.374 ms lat</font></div><div><font size="2"   >progress: 9.0 s, 44030.6 tps, 0.363 ms lat</font></div><div><font size="2"   >progress: 12.0 s, 43835.4 tps, 0.365 ms lat</font></div><div><font size="2"   >progress: 15.0 s, 43862.8 tps, 0.365 ms lat</font></div><div><font size="2"   >progress: 18.0 s, 43982.1 tps, 0.364 ms lat</font></div><div><font size="2"   >progress: 21.0 s, 44164.0 tps, 0.362 ms lat</font></div><div><font size="2"   >progress: 24.0 s, 44102.8 tps, 0.363 ms lat</font></div><div><font size="2"   >progress: 27.0 s, 43705.6 tps, 0.366 ms lat</font></div><div><font size="2"   >progress: 30.0 s, 44375.6 tps, 0.361 ms lat</font></div><div><font size="2"   >progress: 33.0 s, 44305.6 tps, 0.361 ms lat</font></div><div><font size="2"   >progress: 36.0 s, 44016.1 tps, 0.364 ms lat</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >number of transactions per client: 100000</font></div><div><font size="2"   >number of transactions actually processed: 1600000/1600000</font></div><div><font size="2"   >tps = 43094.830471 (including connections establishing)</font></div><div><font size="2"   >tps = 43111.491031 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.001555 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 5000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.361177 &nbsp; &nbsp; &nbsp; &nbsp;select f_test(:id);</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><div><font size="2"   >digoal=# select pg_current_xlog_location();</font></div><div><font size="2"   >&nbsp;pg_current_xlog_location&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;0/38410A68</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select pg_xlog_location_diff('0/38410A68', '0/18EFFC88');</font></div><div><font size="2"   >&nbsp;pg_xlog_location_diff&nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;525405664</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div><div><span style="line-height: 23px;"   >测试3 :&nbsp;</span></div><div>改为off</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >full_page_writes = off</font></div><div><font size="2"   >pg94@db-172-16-3-39-&gt; pg_ctl restart -m fast</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >pg94@db-172-16-3-39-&gt; psql</font></div><div><font size="2"   >psql (9.4devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# select pg_current_xlog_location();</font></div><div><font size="2"   >&nbsp;pg_current_xlog_location&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;0/38410AD0</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >pg94@db-172-16-3-39-&gt; pgbench -M prepared -n -r -f ./test.sql -P 3 -c 16 -j 4 -t 100000&nbsp;</font></div><div><font size="2"   >progress: 3.0 s, 38206.2 tps, 0.419 ms lat</font></div><div><font size="2"   >progress: 6.0 s, 42497.9 tps, 0.376 ms lat</font></div><div><font size="2"   >progress: 9.0 s, 43040.5 tps, 0.372 ms lat</font></div><div><font size="2"   >progress: 12.0 s, 43555.0 tps, 0.367 ms lat</font></div><div><font size="2"   >progress: 15.0 s, 43763.7 tps, 0.366 ms lat</font></div><div><font size="2"   >progress: 18.0 s, 43997.5 tps, 0.364 ms lat</font></div><div><font size="2"   >progress: 21.0 s, 43891.3 tps, 0.365 ms lat</font></div><div><font size="2"   >progress: 24.0 s, 43706.4 tps, 0.366 ms lat</font></div><div><font size="2"   >progress: 27.0 s, 43955.7 tps, 0.364 ms lat</font></div><div><font size="2"   >progress: 30.0 s, 43948.5 tps, 0.364 ms lat</font></div><div><font size="2"   >progress: 33.0 s, 43723.6 tps, 0.366 ms lat</font></div><div><font size="2"   >progress: 36.0 s, 43403.8 tps, 0.369 ms lat</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 16</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >number of transactions per client: 100000</font></div><div><font size="2"   >number of transactions actually processed: 1600000/1600000</font></div><div><font size="2"   >tps = 41054.353809 (including connections establishing)</font></div><div><font size="2"   >tps = 41072.579612 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.001585 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 5000000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.360673 &nbsp; &nbsp; &nbsp; &nbsp;select f_test(:id);</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><div><font size="2"   >digoal=# select pg_current_xlog_location();</font></div><div><font size="2"   >&nbsp;pg_current_xlog_location&nbsp;</font></div><div><font size="2"   >--------------------------</font></div><div><font size="2"   >&nbsp;0/4F7C1BD0</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select pg_xlog_location_diff('0/4F7C1BD0', '0/38410AD0');</font></div><div><font size="2"   >&nbsp;pg_xlog_location_diff&nbsp;</font></div><div><font size="2"   >-----------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;389746944</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>从以上对<span style="line-height: 23px;"   >full_page_writes在三种参数(compress, on, off)下的测试结果来看, compress的压缩效果非常好.</span></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 23px;" rel="nofollow" href="http://www.postgresql.org/message-id/flat/51366323.8070606@vmware.com#51366323.8070606@vmware.com"   >http://www.postgresql.org/message-id/flat/51366323.8070606@vmware.com#51366323.8070606@vmware.com</a></div><div>2.&nbsp;<a style="line-height: 23px;" rel="nofollow" href="http://www.postgresql.org/message-id/flat/CAHGQGwGqG8e9YN0fNCUZqTTT=hNr7Ly516kfT5ffqf4pp1qnHg@mail.gmail.com#CAHGQGwGqG8e9YN0fNCUZqTTT=hNr7Ly516kfT5ffqf4pp1qnHg@mail.gmail.com"   >http://www.postgresql.org/message-id/flat/CAHGQGwGqG8e9YN0fNCUZqTTT=hNr7Ly516kfT5ffqf4pp1qnHg@mail.gmail.com#CAHGQGwGqG8e9YN0fNCUZqTTT=hNr7Ly516kfT5ffqf4pp1qnHg@mail.gmail.com</a></div><div>3.&nbsp;src/backend/access/transam/xlog.c</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >&nbsp; /*</font></div><div><font size="2"   >+ &nbsp;* Create a compressed version of a backup block</font></div><div><font size="2"   >+ &nbsp;*</font></div><div><font size="2"   >+ &nbsp;* If successful, return a compressed result and set 'len' to its length.</font></div><div><font size="2"   >+ &nbsp;* Otherwise (ie, compressed result is actually bigger than original),</font></div><div><font size="2"   >+ &nbsp;* return NULL.</font></div><div><font size="2"   >+ &nbsp;*/</font></div><div><font size="2"   >+ static char *</font></div><div><font size="2"   >+ CompressBackupBlock(char *page, uint32 orig_len, uint32 *len)</font></div><div><font size="2"   >+ {</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; struct varlena *buf;</font></div><div><font size="2"   >+&nbsp;</font></div><div><font size="2"   >+ #define &nbsp; &nbsp; &nbsp; PGLZ_BLCKSZ &nbsp; &nbsp; PGLZ_MAX_OUTPUT(BLCKSZ)</font></div><div><font size="2"   >+&nbsp;</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; buf = (struct varlena *) palloc(PGLZ_BLCKSZ);</font></div><div><font size="2"   >+&nbsp;</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;* We recheck the actual size even if pglz_compress() reports success,</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;* because it might be satisfied with having saved as little as one byte</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;* in the compressed data --- which could turn into a net loss once you</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;* consider header and alignment padding. &nbsp;Worst case, the compressed</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;* format might require three padding bytes (plus header, which is</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;* included in VARSIZE(buf)), whereas the uncompressed format would take</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;* only one header byte and no padding if the value is short enough. &nbsp;So</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;* we insist on a savings of more than 2 bytes to ensure we have a gain.</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; if (pglz_compress(page, BLCKSZ,</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (PGLZ_Header *) buf, PGLZ_strategy_default) &amp;&amp;</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; VARSIZE(buf) &lt; orig_len - 2)</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* successful compression */</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; *len = VARHDRSZ + VARSIZE(buf);</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return (char *) buf;</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; {</font></div></div><div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* incompressible data */</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pfree(buf);</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return NULL;</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >+ }</font></div></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>