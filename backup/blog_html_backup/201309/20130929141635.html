<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Systemtap DWARF-less probing (kprobe)</h2>
	<h5 id="">2013-09-29 14:16:35&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201382914152385/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div><pre class="prettyprint"   ><p><font size="2"   >In the absence of debugging information, you can still use the kprobe family of probes to examine the entry and exit points of kernel and module functions. You cannot look up the arguments or local variables of a function using these probes. However, you can access the parameters by following this procedure:</font></p></pre></div><div>当系统中没有安装内核对应的<span style="line-height: 23px;"   >debuginfo包时, 不能通过kernel.来使用DWARF探针, 也就是前一篇blog中提到的.</span></div><div><a href="http://blog.163.com/digoal@126/blog/static/1638770402013823101827553/"   >http://blog.163.com/digoal@126/blog/static/1638770402013823101827553/</a></div><div><br></div><div>例如&nbsp;</div><div>主机A:</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db ~]# rpm -qa|grep debuginfo</font></div><div><font size="2"   >没有输出</font></div><p></p></pre></div><div>主机B :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# rpm -qa|grep debuginfo</font></div><div><font size="2"   >kernel-debuginfo-common-2.6.18-348.12.1.el5</font></div><div><font size="2"   >kernel-debuginfo-2.6.18-348.12.1.el5</font></div><p></p></pre></div><div>在主机A上使用kernel.function探针将报错 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db- ~]# &nbsp;stap --vp 5 -e 'probe kernel.function("tcp_v4_connect") {exit()}'</font></div><div><font size="2"   >SystemTap translator/driver (version 1.1/0.141 non-git sources)</font></div><div><font size="2"   >Copyright (C) 2005-2010 Red Hat, Inc. and others</font></div><div><font size="2"   >This is free software; see the source for copying conditions.</font></div><div><font size="2"   >Session arch: x86_64 release: 2.6.18-194.el5</font></div><div><font size="2"   >Created temporary directory "/tmp/stapF9BQl7"</font></div><div><font size="2"   >Parsed kernel "/lib/modules/2.6.18-194.el5/build/.config", number of tuples: 1932</font></div><div><font size="2"   >Searched "/usr/share/systemtap/tapset/x86_64/*.stp", found 3</font></div><div><font size="2"   >Searched "/usr/share/systemtap/tapset/*.stp", found 62</font></div><div><font size="2"   >Pass 1: parsed user script and 65 library script(s) using 43936virt/19484res/1768shr kb, in 170usr/0sys/173real ms.</font></div><div><font size="2"   >semantic error: missing x86_64 kernel/module debuginfo under '/lib/modules/2.6.18-194.el5/build' while resolving probe point kernel.function("tcp_v4_connect")</font></div><div><font size="2"   >Pass 2: analysis failed. &nbsp;Try again with another '--vp 01' option.</font></div></div><div><font size="2"   >由于缺少debuginfo包, 报错中显示<span style="line-height: 23px;"   >semantic error: missing x86_64 kernel/module debuginfo under '/lib/modules/2.6.18-194.el5/build' while resolving probe point kernel.function("tcp_v4_connect")</span></font></div><p></p></pre></div><div><span style="line-height: 23px;"   >在主机B上可以正常使用 :&nbsp;</span></div><div><span style="line-height: 23px;"   ><font size="2"   ><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 23px;"   ><font size="2"   ><div>[root@db-172-16-3-39 ~]# stap --vp 5 -e 'probe kernel.function("tcp_v4_connect") {exit()}'</div><div>Parsed kernel "/lib/modules/2.6.18-348.12.1.el5/build/.config", containing 1977 tuples</div><div>Parsed kernel /lib/modules/2.6.18-348.12.1.el5/build/Module.symvers, which contained 3546 vmlinux exports</div><div>Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 4, processed: 4</div><div>Searched: " /usr/share/systemtap/tapset/*.stp ", found: 81, processed: 81</div><div>Pass 1: parsed user script and 85 library script(s) using 146788virt/23700res/3012shr/21384data kb, in 170usr/10sys/173real ms.</div></font></span></div><div></div><p></p></pre></div></font></span></div><div>虽然没有安装debuginfo, 但是依然可以使用kprobe.来加载这些探针, 使用kprobe时有一些局限, 例如只能指定函数的入口部位或者是函数的返回部位(.return), 不能指定函数行号.</div><div>使用kprobe时, 无法获得函数的本地变量的值, 但是可以通过其他方法获得函数参数值(非$var).</div><div><br></div><div><pre class="prettyprint"   ><p><font size="2"   >When you're stopped at the entry to a function, you can refer to the function's arguments by number. For example, when probing the function declared:</font></p></pre></div><div>如果使用的是函数返回部位的探针, 那么返回值也不能简单的通过$return来获得, 而是要通过其他函数来获得.</div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >asmlinkage ssize_t sys_read(unsigned int fd, char __user * buf, size_t</font></div><div><font size="2"   >count)</font></div><div><font size="2"   >You can obtain the values of fd, buf, and count, respectively, as uint_arg(1), pointer_arg(2), and ulong_arg(3). In this case, your probe code must first call asmlinkage(), because on some architectures the asmlinkage attribute affects how the function's arguments are passed.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >When you're in a return probe, $return isn't supported without DWARF, but you can call returnval() to get the value of the register in which the function value is typically returned, or call returnstr() to get a string version of that value.</font></div><p></p></pre></div><div>例如以上函数有3个参数, 通过uint_arg(1),&nbsp;pointer_arg(2), and ulong_arg(3)来取这些参数值. 在使用类似函数获得参数值时, 请先调用asmlinkage ()函数.</div><div>返回部位探针的返回值则通过returnval()或者returnstr()来获取.</div><div>例如 :&nbsp;</div><div>上一篇blog中举例用到的tcp_v4_connect函数, 有3个参数.</div><pre class="prettyprint"   ><p></p><div><font size="2"   >int tcp_v4_connect(struct sock *sk, struct sockaddr *uaddr, int addr_len)</font></div><div></div><p></p></pre><div><span style="line-height: 23px;"   >kprobe使用如下, 记得先调用asmlinkage().</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db- ~]# stap -e 'probe kprobe.function("tcp_v4_connect") {asmlinkage(); printf("%s, %d, %d, 0x%x, 0x%x, %d\n", pp(), pid(), cpu(), pointer_arg(1), pointer_arg(2), uint_arg(3));}'</font></div><div><font size="2"   >kprobe.function("tcp_v4_connect"), 32372, 11, 0xffff81024ce51380, 0xffff81038aa2fec8, 16</font></div><p></p></pre></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db- ~]# stap -e 'probe kprobe.function("tcp_v4_connect").return {asmlinkage(); printf("%d\n", returnval());}'</font></div><div><font size="2"   >0</font></div><p></p></pre></div><div>更多的类型对应的获取它们的值的函数请参考</div><div><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/"   >https://sourceware.org/systemtap/tapsets/</a></div><div>如: int_arg, long_arg, longlong_arg, pointer_arg, s32_arg, s64_arg, u32_arg, u64_arg, uint_arg, ulong_arg, ulonglong_arg.</div><div><br></div><div><pre class="prettyprint"   ><p><font size="2"   >And at any code probepoint, you can call register("regname") to get the value of the specified CPU register when the probe point was hit. u_register("regname") is like register("regname"), but interprets the value as an unsigned integer.</font></p></pre></div><div>CPU寄存器的值可以通过register("regname")或者u_register获得.</div><div>参考</div><div><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-print-regs.html"   >https://sourceware.org/systemtap/tapsets/API-print-regs.html</a></div><div><a rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-register.html"   >https://sourceware.org/systemtap/tapsets/API-register.html</a></div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db- ~]# stap -e 'probe kprobe.function("tcp_v4_connect") {asmlinkage(); printf("%d, %d, %d\n", pid(), cpu(), print_regs()); exit()}'</font></div><div><font size="2"   >RIP: ffffffff8025b538</font></div><div><font size="2"   >RSP: ffff81061a62be50 &nbsp;EFLAGS: 00000246</font></div><div><font size="2"   >RAX: ffffffff8035bda0 RBX: ffff8105fa1e1300 RCX: 0000000000000802</font></div><div><font size="2"   >RDX: 0000000000000010 RSI: ffff81061a62bec8 RDI: ffff8105fa1e1300</font></div><div><font size="2"   >RBP: 00000000ffffffea R08: ffffffff802a4f80 R09: ffff8105fa1e1300</font></div><div><font size="2"   >R10: 0000000000000000 R11: ffff81045fc1a350 R12: ffff81061a62bec8</font></div><div><font size="2"   >R13: ffff81045fc1a300 R14: 0000000000000010 R15: 0000000000000802</font></div><div><font size="2"   >FS: &nbsp;00002b12ea2a0a60(0000) GS:ffff81033a97e940(0000) knlGS:0000000000000000</font></div><div><font size="2"   >CS: &nbsp;0010 DS: 0000 ES: 0000 CR0: 0000000080050033</font></div><div><font size="2"   >CR2: 0000003aca8e0090 CR3: 000000062b47f000 CR4: 00000000000006e0</font></div><div><font size="2"   >3666, 10, 0</font></div><p></p></pre></div><div>单独打印 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-192-168-101-35 ~]# stap -e 'probe kprobe.function("tcp_v4_connect") {asmlinkage(); printf("%d, %d, %x\n", pid(), cpu(), register("rip")); exit()}'</font></div><div><font size="2"   >4859, 10, ffffffff8025b538</font></div><p></p></pre></div><div>kprobe支持的格式 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >SystemTap supports the following constructs:</font></div><div><font size="2"   >kprobe.function(FUNCTION)</font></div><div><font size="2"   >kprobe.function(FUNCTION).return</font></div><div><font size="2"   >kprobe.module(NAME).function(FUNCTION)</font></div><div><font size="2"   >kprobe.module(NAME).function(FUNCTION).return</font></div><div><font size="2"   >kprobe.statement(ADDRESS).absolute</font></div><div><font size="2"   >Use <u>.function</u> probes for kernel functions and <u>.module</u> probes for probing functions of a specified module.&nbsp;</font></div><div><font size="2"   >If you do not know the absolute address of a kernel or module function, use <u>.statement</u> probes.&nbsp;</font></div><div><font size="2"   >Do not use wildcards in FUNCTION and MODULE names. Wildcards cause the probe to not register.&nbsp;</font></div><div><font size="2"   >Also, statement probes are available only in guru mode.</font></div><p></p></pre></div></div><div>这里几点需要注意,&nbsp;</div><div>1. 在函数和模块名部位, 不要使用通配符.</div><div>2. kprobe.statement探针仅仅支持guru模式运行, 也就是stap -g</div><div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;-g &nbsp; &nbsp; Guru mode. &nbsp;Enable parsing of unsafe expert-level constructs like embedded C.</font></div></div><div></div><p></p></pre></div></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 23px;" rel="nofollow" href="https://sourceware.org/systemtap/langref/Probe_points.html"   >https://sourceware.org/systemtap/langref/Probe_points.html</a></div><div>2.&nbsp;<a style="line-height: 23px;" rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-asmlinkage.html"   >https://sourceware.org/systemtap/tapsets/API-asmlinkage.html</a></div><div>3.&nbsp;<a style="line-height: 23px;" rel="nofollow" href="https://sourceware.org/systemtap/tapsets/"   >https://sourceware.org/systemtap/tapsets/</a></div><div>4.&nbsp;<a style="line-height: 23px;" rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-returnval.html"   >https://sourceware.org/systemtap/tapsets/API-returnval.html</a></div><div>5.&nbsp;<a style="line-height: 23px;" rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-returnval.html"   >https://sourceware.org/systemtap/tapsets/API-returnval.html</a></div><div>6.&nbsp;<a style="line-height: 23px;" rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-returnstr.html"   >https://sourceware.org/systemtap/tapsets/API-returnstr.html</a></div><div>7.&nbsp;<a style="line-height: 23px;" rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-register.html"   >https://sourceware.org/systemtap/tapsets/API-register.html</a></div><div>8.&nbsp;<a style="line-height: 23px;" rel="nofollow" href="https://sourceware.org/systemtap/tapsets/API-print-regs.html"   >https://sourceware.org/systemtap/tapsets/API-print-regs.html</a></div></div>
	</div>
</div>
</body>
</html>