<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL pending patch : Freezing without write I/O</h2>
	<h5 id="">2013-09-18 23:07:26&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201381854228562/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL MVCC机制中, 一个重要的概念是xid, 每条记录上都存储了32位的xid信息, 表示该记录被写入时的事务号. 由于xid值有限, 所以记录上的xid信息必须在产生一定量的事务(必须小于2^31)后置为freeze xid. 否则会变成未来的xid, 造成数据消失的假象.</div><div>freeze xid是一个特殊的xid, 持这个xid的记录对所有事务来说都是可见的.&nbsp;</div><div>这样就带来一个情况, 无论数据后续是否要被修改, 行上面存储的xid信息在发生若干的事务后都需要被置为freeze xid, (由于前面所述的xid wrap的原因.)</div><div>例如一个表只有插入, 没有更新也没有删除, 最老的一条记录的xid=100, 当发生了若干次事务后, 这个xid必须变更为freeze xid(=2). 所以这个page实际上就至少额外发生了一次写的操作.&nbsp;</div><div><br></div><div>本文所述的补丁, 原理如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >Here's a first draft. A lot of stuff missing and broken, but "make&nbsp;</font></div><div><font size="2"   >check" passes :-).</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >In the patch, instead of working with "half-epochs", there are "XID-LSN&nbsp;</font></div><div><font size="2"   >ranges", which can be of arbitrary size. An XID-LSN range consists of&nbsp;</font></div><div><font size="2"   >three values:</font></div><div><span style="line-height: 23px;"   ><font size="2"   >LSN指WAL文件的位置信息.</font></span></div><div><font size="2"   ><br></font></div><div><font size="2"   >本补丁的关键点在这里, 维护了1个列表, 这个列表中包含一系列的范围信息. 如minlsn 最小lsn号. minxid - maxxid指 大于该lsd的对应的xid的范围</font></div><div><font size="2"   >minlsn: The point in WAL where this range begins.</font></div><div><font size="2"   >minxid - maxxid: The range of XIDs allowed in this range.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Every point in WAL belongs to exactly one range. The minxid-maxxid of&nbsp;</font></div><div><font size="2"   >the ranges can overlap. For example:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >1. XIDs 25000942 - 27000003 LSN 0/3BB9938</font></div><div><font size="2"   >2. XIDs 23000742 - 26000003 LSN 0/2AB9288</font></div><div><font size="2"   >3. XIDs 22000721 - 25000003 LSN 0/1AB8BE0</font></div><div><font size="2"   >4. XIDs 22000002 - 24000003 LSN 0/10B1550</font></div><div><font size="2"   >每次页面被更新时, lsn随之更新, 根据lsn对应的minxid和maxxid范围来判断是否需要对该页面内小于minxid的xid做freeze处理(这些写操作在一次中完成). &nbsp;所以省去了后面再来做freeze的额外io. &nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The invariant with the ranges is that a page with a certain LSN is only&nbsp;</font></div><div><font size="2"   >allowed to contain XIDs that belong to the range specified by that LSN.&nbsp;</font></div><div><font size="2"   >For example, if a page has LSN 0/3500000, it belongs to the 2nd range,&nbsp;</font></div><div><font size="2"   >and can only contain XIDs between 23000742 - 26000003. If a backend&nbsp;</font></div><div><font size="2"   >updates the page, so that it's LSN is updated to, say, 0/3D12345, all&nbsp;</font></div><div><font size="2"   >XIDs on the page older than 25000942 must be frozen first, to avoid&nbsp;</font></div><div><font size="2"   >violating the rule.</font></div><div><font size="2"   >每个页面上都存储了一个lsn值, 代表最近一次该页面被更新时在xlog中的记录位置</font></div><div><font size="2"   >pd_lsn &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;- identifies xlog record for last change to this page.</font></div><div><font size="2"   >因为unlogged table不记录xlog, 所以本补丁不适用于unlogged table.</font></div><div><font size="2"   >作者的TODO LIST中包含该信息.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The system keeps track of a small number of these XID-LSN ranges. Where&nbsp;</font></div><div><font size="2"   >we currently truncate clog, we can also truncate the ranges with maxxid&nbsp;</font></div><div><font size="2"   >&lt; the clog truncation point. Vacuum removes any dead tuples and updates&nbsp;</font></div><div><font size="2"   >relfrozenxid as usual, to make sure that there are no dead tuples or&nbsp;</font></div><div><font size="2"   >aborted XIDs older than the minxid of the oldest tracked XID-LSN range.&nbsp;</font></div><div><font size="2"   >It no longer needs to freeze old committed XIDs, however - that's the&nbsp;</font></div><div><font size="2"   >gain from this patch (except to uphold the invariant, if it has to&nbsp;</font></div><div><font size="2"   >remove some dead tuples on the page and update its LSN).</font></div><div><font size="2"   >xid-lsn列表的删除需要配合clog的清理一起执行. 所以xid-lsn也不会太大.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >A new range is created whenever we reach the maxxid on the current one.&nbsp;</font></div><div><font size="2"   >The new range's minxid is set to the current global oldest xmin value,&nbsp;</font></div><div><font size="2"   >and maxxid is just the old maxxid plus a fixed number (1 million in the&nbsp;</font></div><div><font size="2"   >patch, but we probably want a higher value in reality). This ensures&nbsp;</font></div><div><font size="2"   >that if you modify a page and update its LSN, all the existing XIDs on&nbsp;</font></div><div><font size="2"   >the page that cannot be frozen yet are greater than the minxid of the&nbsp;</font></div><div><font size="2"   >latest range. In other words, you can always freeze old XIDs on a page,&nbsp;</font></div><div><font size="2"   >so that any remaining non-frozen XIDs are within the minxid-maxxid of&nbsp;</font></div><div><font size="2"   >the latest range.</font></div><div><font size="2"   >新xid-lsn数据的创建, minxid取当前数据库中未提交的最小事务.(txid_current_snapshot()函数可以查看).</font></div><div><font size="2"   >maxxid则在minxid的值上加一个常量值, 例如默认为100万.&nbsp;</font></div><div><font size="2"   >+ #define XID_LSN_RANGE_INTERVAL 1000000</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; ShmemVariableCache-&gt;nextSwitchXid = ShmemVariableCache-&gt;nextXid + XID_LSN_RANGE_INTERVAL;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The HeapTupleSatisfies functions are modified to look at the page's LSN&nbsp;</font></div><div><font size="2"   >first. If it's old enough, it doesn't look at the XIDs on the page level&nbsp;</font></div><div><font size="2"   >at all, and just considers everything on the page is visible to everyone&nbsp;</font></div><div><font size="2"   >(I'm calling this state a "mature page").</font></div><div><font size="2"   >加入了该机制后, 判断行是否可见的函数<span style="line-height: 23px;"   >HeapTupleSatisfies</span><span style="line-height: 23px;"   >&nbsp;首先会查看该页面的lsn信息, 如果lsn小于当前最小的xid-lsd中的lsn的值, 表明这些对应clog已经截断, 同时对应的xid-lsn也删除了, 这种页面被称为mature page, 所有数据对所有用户可见.</span></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&gt; I think the tricky part is going to be figuring out the</font></div><div><font size="2"   >&gt; synchronization around half-epoch boundaries.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Yep. I skipped all those difficult parts in this first version. There&nbsp;</font></div><div><font size="2"   >are two race conditions that need to be fixed:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >1. When a page is updated, we check if it needs to be frozen. If its LSN&nbsp;</font></div><div><font size="2"   >is greater than the latest range's LSN. IOW, if we've already modified&nbsp;</font></div><div><font size="2"   >the page, and thus frozen all older tuples, within the current range.&nbsp;</font></div><div><font size="2"   >However, it's possible that a new range is created immediately after&nbsp;</font></div><div><font size="2"   >we've checked that. When we then proceed to do the actual update on the&nbsp;</font></div><div><font size="2"   >page and WAL-log that, the new LSN falls within the next range, and we&nbsp;</font></div><div><font size="2"   >should've frozen the page. I'm planning to fix that by adding a "parity&nbsp;</font></div><div><font size="2"   >bit" on the page header. Each XID-LSN range is assigned a parity bit, 0&nbsp;</font></div><div><font size="2"   >or 1. When we check if a page needs to be frozen on update, we make note&nbsp;</font></div><div><font size="2"   >of the latest range's parity bit, and write it in the page header.&nbsp;</font></div><div><font size="2"   >Later, when we look at the page's LSN to determine which XID-LSN range&nbsp;</font></div><div><font size="2"   >it belongs to, we compare the parity. If the parity doesn't match, we&nbsp;</font></div><div><font size="2"   >know that the race condition happened, so we treat the page to belong to&nbsp;</font></div><div><font size="2"   >the previous range, not the one it would normally belong to, per the LSN.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >2. When we look at a page, and determine that it's not old enough to be&nbsp;</font></div><div><font size="2"   >"matured", we then check the clog as usual. A page is considered mature,&nbsp;</font></div><div><font size="2"   >if the XID-LSN range (and corresponding clog pages) has already been&nbsp;</font></div><div><font size="2"   >truncated away. It's possible that between those steps, the XID-LSN&nbsp;</font></div><div><font size="2"   >range and clog is truncated away, so that the backend tries to access a&nbsp;</font></div><div><font size="2"   >clog page that doesn't exist anymore. To fix that, the XID-LSN range and&nbsp;</font></div><div><font size="2"   >clog truncation needs to be done in two steps. First, mark the&nbsp;</font></div><div><font size="2"   >truncation point in shared memory. Then somehow wait until all backends&nbsp;</font></div><div><font size="2"   >see the new value, and go ahead with actually truncating the clog only&nbsp;</font></div><div><font size="2"   >after that.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Aside from those two race conditions, there are plenty of scalability&nbsp;</font></div><div><font size="2"   >issues remaining. Currently, the shared XID-LSN range array is checked&nbsp;</font></div><div><font size="2"   >every time a page is accessed, so it could quickly become a bottleneck.&nbsp;</font></div><div><font size="2"   >Need to cache that information in each backend. Oh, and I didn't&nbsp;</font></div><div><font size="2"   >implement the PD_RECENTLY_FROZEN bit in the page header yet, so you will&nbsp;</font></div><div><font size="2"   >get a freezing frenzy right after a new XID-LSN range is created.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >I'll keep hacking away on those things, but please let me know if you&nbsp;</font></div><div><font size="2"   >see some fatal flaw with this plan.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >- Heikki</font></div></div><div><font size="2"   >以上两个问题在随后的补丁中已经解决了 .&nbsp;</font></div><div><div><font size="2"   >Here's an updated patch. The race conditions I mentioned above have been&nbsp;</font></div><div><font size="2"   >fixed.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >This is still definitely work-in-progress, but overall I think this is&nbsp;</font></div><div><font size="2"   >quite promising. The patch basically works, although there are a bunch&nbsp;</font></div><div><font size="2"   >of TODO items like handling unlogged tables.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >This patch is also available in my git repository at&nbsp;</font></div><div><font size="2"   >git://git.postgresql.org/git/users/heikki/postgres.git, branch&nbsp;</font></div><div><font size="2"   >"freeze-by-xid-lsn-ranges".</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >- Heikki</font></div></div><p></p></pre></div><div><br></div><div>测试补丁 :&nbsp;</div><div>使用的数据库源码如下 :&nbsp;</div><pre class="prettyprint"   ><p><font size="2"   >http://git.postgresql.org/gitweb/?p=postgresql.git;a=snapshot;h=d41cb869aad493178777b6e6e8d1425535349acb;sf=tgz</font></p><div><font size="2"   >[root@db-172-16-3-33 soft_bak]# tar -zxvf postgresql-d41cb86.tar.gz&nbsp;</font></div><div><font size="2"   >[root@db-172-16-3-33 soft_bak]# cd postgresql-d41cb86</font></div><p></p></pre><div>下载补丁</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >wget&nbsp;http://www.postgresql.org/message-id/attachment/30162/xid-lsn-ranges-3.patch.gz</font></div><div><font size="2"   >wget&nbsp;http://www.postgresql.org/message-id/attachment/29948/xidtest.tar.gz</font></div><div><font size="2"   >[root@db-172-16-3-33 postgresql-d41cb86]# gunzip xid-lsn-ranges-3.patch.gz&nbsp;</font></div><div><div><font size="2"   >[root@db-172-16-3-33 postgresql-d41cb86]# tar -zxvf xidtest.tar.gz&nbsp;</font></div><div><font size="2"   >xidtest/</font></div><div><font size="2"   >xidtest/xidtest--1.0.sql</font></div><div><font size="2"   >xidtest/xidtest.c</font></div><div><font size="2"   >xidtest/Makefile</font></div><div><font size="2"   >xidtest/xidtest.control</font></div><div><font size="2"   >[root@db-172-16-3-33 postgresql-d41cb86]# mv xidtest contrib/</font></div></div><p></p></pre></div><div>打补丁</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 postgresql-d41cb86]# patch -p1 &lt; xid-lsn-ranges-3.patch&nbsp;</font></div><div><font size="2"   >patching file TODO-xidlsnranges.txt</font></div><div><font size="2"   >patching file contrib/pg_xlogdump/rmgrdesc.c</font></div><div><font size="2"   >patching file doc/src/sgml/maintenance.sgml</font></div><div><font size="2"   >patching file doc/src/sgml/ref/create_table.sgml</font></div><div><font size="2"   >patching file src/backend/access/heap/heapam.c</font></div><div><font size="2"   >patching file src/backend/access/heap/pruneheap.c</font></div><div><font size="2"   >patching file src/backend/access/rmgrdesc/Makefile</font></div><div><font size="2"   >patching file src/backend/access/rmgrdesc/varsupdesc.c</font></div><div><font size="2"   >patching file src/backend/access/rmgrdesc/xlogdesc.c</font></div><div><font size="2"   >patching file src/backend/access/transam/rmgr.c</font></div><div><font size="2"   >patching file src/backend/access/transam/varsup.c</font></div><div><font size="2"   >patching file src/backend/access/transam/xlog.c</font></div><div><font size="2"   >patching file src/backend/commands/cluster.c</font></div><div><font size="2"   >patching file src/backend/commands/vacuum.c</font></div><div><font size="2"   >patching file src/backend/commands/vacuumlazy.c</font></div><div><font size="2"   >patching file src/backend/nodes/copyfuncs.c</font></div><div><font size="2"   >patching file src/backend/nodes/equalfuncs.c</font></div><div><font size="2"   >patching file src/backend/parser/gram.y</font></div><div><font size="2"   >patching file src/backend/postmaster/autovacuum.c</font></div><div><font size="2"   >patching file src/backend/storage/ipc/procarray.c</font></div><div><font size="2"   >patching file src/backend/utils/misc/guc.c</font></div><div><font size="2"   >patching file src/backend/utils/misc/postgresql.conf.sample</font></div><div><font size="2"   >patching file src/backend/utils/time/snapmgr.c</font></div><div><font size="2"   >patching file src/backend/utils/time/tqual.c</font></div><div><font size="2"   >patching file src/include/access/heapam.h</font></div><div><font size="2"   >patching file src/include/access/rmgrlist.h</font></div><div><font size="2"   >patching file src/include/access/transam.h</font></div><div><font size="2"   >patching file src/include/access/varsup_internal.h</font></div><div><font size="2"   >patching file src/include/access/xlog.h</font></div><div><font size="2"   >patching file src/include/catalog/pg_control.h</font></div><div><font size="2"   >patching file src/include/commands/cluster.h</font></div><div><font size="2"   >patching file src/include/commands/vacuum.h</font></div><div><font size="2"   >patching file src/include/nodes/parsenodes.h</font></div><div><font size="2"   >patching file src/include/storage/procarray.h</font></div><div><font size="2"   >patching file src/include/utils/snapmgr.h</font></div><div><font size="2"   >patching file src/include/utils/tqual.h</font></div><p></p></pre></div><div>编译安装数据库</div><pre class="prettyprint"   ><p></p><div><font size="2"   >./configure --prefix=/home/pg94/pgsql9.4devel --with-pgport=2999 --with-perl --with-tcl --with-python --with-openssl --with-pam --without-ldap --with-libxml --with-libxslt --enable-thread-safety --with-wal-blocksize=16 --enable-dtrace &amp;&amp; gmake &amp;&amp; gmake install</font></div><div></div><p></p></pre><div><span style="line-height: 23px;"   >要用到一些模块, 把模块也编译安装掉</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >cd contrib</font></div><div><font size="2"   >gmake &amp;&amp; gmake install</font></div><p></p></pre></div><div>作者提到的xidtest模块也安装一下, &nbsp;方便查看xid-lsn列表信息,</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 postgresql-d41cb86]# cd contrib/xidtest/</font></div><div><font size="2"   >[root@db-172-16-3-33 xidtest]# export PATH=/home/pg94/pgsql9.4devel/bin:$PATH</font></div><div><font size="2"   >[root@db-172-16-3-33 xidtest]# gmake</font></div><div><font size="2"   >gcc -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fpic -I. -I. -I../../src/include -D_GNU_SOURCE -I/usr/include/libxml2 &nbsp; -c -o xidtest.o xidtest.c</font></div><div><font size="2"   >gcc -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fpic -shared -o xidtest.so xidtest.o -L../../src/port -L../../src/common &nbsp;-Wl,-rpath,'/home/pg94/pgsql9.4devel/lib',--enable-new-dtags &nbsp;</font></div><div><font size="2"   >[root@db-172-16-3-33 xidtest]# gmake install</font></div><div><font size="2"   >/bin/mkdir -p '/home/pg94/pgsql9.4devel/lib'</font></div><div><font size="2"   >/bin/mkdir -p '/home/pg94/pgsql9.4devel/share/extension'</font></div><div><font size="2"   >/bin/mkdir -p '/home/pg94/pgsql9.4devel/share/extension'</font></div><div><font size="2"   >/usr/bin/install -c -m 755 &nbsp;xidtest.so '/home/pg94/pgsql9.4devel/lib/xidtest.so'</font></div><div><font size="2"   >/usr/bin/install -c -m 644 xidtest.control '/home/pg94/pgsql9.4devel/share/extension/'</font></div><div><font size="2"   >/usr/bin/install -c -m 644 xidtest--1.0.sql '/home/pg94/pgsql9.4devel/share/extension/'</font></div><p></p></pre></div><div><br></div><div>初始化数据库, 启动数据库(略)</div><div>创建xidtest插件</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-33 xidtest]# su - pg94</font></div><div><font size="2"   >pg94@db-172-16-3-33-&gt; psql</font></div><div><font size="2"   >psql (9.4devel)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# create extension xidtest;</font></div><div><font size="2"   >CREATE EXTENSION</font></div><p></p></pre></div><div>这个插件包含两个函数, 一个用于消耗xid, 另一个用于查看xid-lsn列表</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# \df</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of functions</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; &nbsp; &nbsp;Name &nbsp; &nbsp; &nbsp; &nbsp;| Result data type | Argument data types | &nbsp;Type &nbsp;</font></div><div><font size="2"   >--------+--------------------+------------------+---------------------+--------</font></div><div><font size="2"   >&nbsp;public | consume_xids &nbsp; &nbsp; &nbsp; | void &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | integer &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | normal</font></div><div><font size="2"   >&nbsp;public | print_xidlsnranges | void &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | normal</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div>例如当前的xid-lsn列表信息如下</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from print_xidlsnranges();</font></div><div><font size="2"   >NOTICE: &nbsp;XIDs 3 - 0, MultiXIDs 1 - 0, LSN 0/0 (expires 0)</font></div><div><font size="2"   >NOTICE: &nbsp;page mature LSN 0/0</font></div><div><font size="2"   >&nbsp;print_xidlsnranges&nbsp;</font></div><div><font size="2"   >--------------------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>消耗100万个xid后</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select consume_xids(1000000);</font></div><div><font size="2"   >NOTICE: &nbsp;consumed 1000000 xids, nextXid = 1002085</font></div><div><font size="2"   >&nbsp;consume_xids&nbsp;</font></div><div><font size="2"   >--------------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 23px;"   >消耗100万个xid后</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select consume_xids(1000000);</font></div><div><font size="2"   >NOTICE: &nbsp;consumed 1000000 xids, nextXid = 2002086</font></div><div><font size="2"   >&nbsp;consume_xids&nbsp;</font></div><div><font size="2"   >--------------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# checkpoint;</font></div><div><font size="2"   >CHECKPOINT</font></div><p></p></pre></div><div>再次查看这个xid-lsn列表信息, 已经发生了一点改变. 新增了1条xid-lsn信息.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from print_xidlsnranges();</font></div><div><font size="2"   >NOTICE: &nbsp;XIDs 2084 - 0, MultiXIDs 1 - 0, LSN 0/16A5C80 (expires 0)</font></div><div><font size="2"   >NOTICE: &nbsp;XIDs 3 - 1001473, MultiXIDs 1 - 2, LSN 0/0 (expires 0)</font></div><div><font size="2"   >NOTICE: &nbsp;page mature LSN 0/0</font></div><div><font size="2"   >&nbsp;print_xidlsnranges&nbsp;</font></div><div><font size="2"   >--------------------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div><br></div><div>使用上一篇文章介绍的方法进行更新测试. 同时观察xid-lsn列表信息.</div><div><a href="http://blog.163.com/digoal@126/blog/static/16387704020138185042307/"   >http://blog.163.com/digoal@126/blog/static/16387704020138185042307/</a></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table test(id int primary key, info text, crt_time timestamp);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# create or replace function update_test(i_num int) returns void as &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >digoal-# $$</font></div><div><font size="2"   >digoal$# declare</font></div><div><font size="2"   >digoal$# begin</font></div><div><font size="2"   >digoal$# &nbsp; update test set info=md5(random()::text),crt_time=clock_timestamp() where id=mod(i_num,100);</font></div><div><font size="2"   >digoal$# &nbsp; return;</font></div><div><font size="2"   >digoal$# exception&nbsp;</font></div><div><font size="2"   >digoal$# &nbsp; when others then</font></div><div><font size="2"   >digoal$# &nbsp; &nbsp; return;</font></div><div><font size="2"   >digoal$# end;</font></div><div><font size="2"   >digoal$# $$ language plpgsql strict;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   >digoal=# insert into test select generate_series(0,99),md5(random()::text),clock_timestamp();</font></div><div><font size="2"   >INSERT 0 100</font></div><p></p></pre></div><div>pgbench脚本</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg94@db-172-16-3-33-&gt; vi test.sql</font></div><div><font size="2"   >select update_test(pg_backend_pid());</font></div><p></p></pre></div><div>测试100秒更新.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg94@db-172-16-3-33-&gt; &nbsp;pgbench -M prepared -n -r -f ./test.sql -P 1 -c 8 -j 4 -T 100 -h 127.0.0.1 -U postgres digoal</font></div><div><font size="2"   >progress: 1.0 s, 28709.1 tps, 0.279 ms lat</font></div><div><font size="2"   >progress: 2.0 s, 27751.8 tps, 0.288 ms lat</font></div><div><font size="2"   >progress: 3.0 s, 25238.4 tps, 0.317 ms lat</font></div><div><font size="2"   >progress: 4.0 s, 27509.2 tps, 0.291 ms lat</font></div></div><div><font size="2"   >.....</font></div><div><div><font size="2"   >progress: 98.0 s, 42864.7 tps, 0.187 ms lat</font></div><div><font size="2"   >progress: 99.0 s, 40282.1 tps, 0.199 ms lat</font></div><div><font size="2"   >progress: 100.0 s, 47759.9 tps, 0.168 ms lat</font></div><div><font size="2"   >transaction type: Custom query</font></div><div><font size="2"   >scaling factor: 1</font></div><div><font size="2"   >query mode: prepared</font></div><div><font size="2"   >number of clients: 8</font></div><div><font size="2"   >number of threads: 4</font></div><div><font size="2"   >duration: 100 s</font></div><div><font size="2"   >number of transactions actually processed: 3792496</font></div><div><font size="2"   >tps = 37923.591338 (including connections establishing)</font></div><div><font size="2"   >tps = 37926.672863 (excluding connections establishing)</font></div><div><font size="2"   >statement latencies in milliseconds:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 0.209422 &nbsp; &nbsp; &nbsp; &nbsp;select update_test(pg_backend_pid());</font></div></div><p></p></pre></div><div>pgbench更新完后, 来查看xid-lsn列表信息, 注意最新的这个minxid-maxxid, minxid已经到<span style="line-height: 23px;"   >16004987</span><span style="line-height: 23px;"   >了, maxxid=0, 可能是个bug.</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 23px;"   ><font size="2"   >digoal=# select * from print_xidlsnranges();</font></span></div><div><div><font size="2"   >NOTICE: &nbsp;XIDs 16004987 - 0, MultiXIDs 16 - 0, LSN 0/4D6265E0 (expires 0)<span style="line-height: 23px;"   >&nbsp;</span><span style="line-height: 23px;"   >表示当页面的lsd大于这个值时, 这个page中的xid取值范围.</span></font></div><div><font size="2"   >NOTICE: &nbsp;XIDs 15004796 - 16005121, MultiXIDs 15 - 17, LSN 0/480CE178 (expires 0)<span style="line-height: 23px;"   >&nbsp;</span><span style="line-height: 23px;"   >表示当页面的lsd大于这个值时, 这个page中的xid取值范围.</span></font></div><div><font size="2"   >NOTICE: &nbsp;XIDs 14004599 - 15004929, MultiXIDs 14 - 16, LSN 0/42B75FC0 (expires 0)<span style="line-height: 23px;"   >&nbsp;</span><span style="line-height: 23px;"   >表示当页面的lsd大于这个值时, 这个page中的xid取值范围.</span></font></div><div><font size="2"   >NOTICE: &nbsp;XIDs 13004407 - 14004737, MultiXIDs 13 - 15, LSN 0/3D60FBD0 (expires 0)<span style="line-height: 23px;"   >&nbsp;</span><span style="line-height: 23px;"   >表示当页面的lsd大于这个值时, 这个page中的xid取值范围.</span></font></div><div><font size="2"   >NOTICE: &nbsp;XIDs 12004216 - 13004545, MultiXIDs 12 - 14, LSN 0/380B5670 (expires 0)<span style="line-height: 23px;"   >&nbsp;</span><span style="line-height: 23px;"   >表示当页面的lsd大于这个值时, 这个page中的xid取值范围.</span></font></div><div><font size="2"   >NOTICE: &nbsp;XIDs 11004025 - 12004353, MultiXIDs 11 - 13, LSN 0/32B5B4D0 (expires 0)<span style="line-height: 23px;"   >&nbsp;</span><span style="line-height: 23px;"   >表示当页面的lsd大于这个值时, 这个page中的xid取值范围.</span></font></div><div><font size="2"   >NOTICE: &nbsp;XIDs 10004016 - 11004161, MultiXIDs 10 - 12, LSN 0/2C1F2C10 (expires 0)<span style="line-height: 23px;"   >&nbsp;</span><span style="line-height: 23px;"   >表示当页面的lsd大于这个值时, 这个page中的xid取值范围.</span></font></div><div><font size="2"   >NOTICE: &nbsp;XIDs 9003630 - 10004353, MultiXIDs 9 - 11, LSN 0/26C93220 (expires 0)<span style="line-height: 23px;"   >&nbsp;</span><span style="line-height: 23px;"   >表示当页面的lsd大于这个值时, 这个page中的xid取值范围.</span></font></div><div><font size="2"   >NOTICE: &nbsp;XIDs 8003513 - 9004161, MultiXIDs 8 - 10, LSN 0/2172F088 (expires 0)<span style="line-height: 23px;"   >&nbsp;</span><span style="line-height: 23px;"   >表示当页面的lsd大于这个值时, 这个page中的xid取值范围.</span></font></div><div><font size="2"   >NOTICE: &nbsp;XIDs 7003288 - 8003713, MultiXIDs 7 - 9, LSN 0/1C1B2F20 (expires 0)<span style="line-height: 23px;"   >&nbsp;</span><span style="line-height: 23px;"   >表示当页面的lsd大于这个值时, 这个page中的xid取值范围.</span></font></div><div><font size="2"   >NOTICE: &nbsp;XIDs 6002988 - 7003521, MultiXIDs 6 - 8, LSN 0/16C577A0 (expires 0)<span style="line-height: 23px;"   >&nbsp;</span><span style="line-height: 23px;"   >表示当页面的lsd大于这个值时, 这个page中的xid取值范围.</span></font></div><div><font size="2"   >NOTICE: &nbsp;XIDs 5002798 - 6003329, MultiXIDs 5 - 7, LSN 0/116FC000 (expires 0)<span style="line-height: 23px;"   >&nbsp;</span><span style="line-height: 23px;"   >表示当页面的lsd大于这个值时, 这个page中的xid取值范围.</span></font></div><div><font size="2"   >NOTICE: &nbsp;XIDs 4002361 - 5003137, MultiXIDs 4 - 6, LSN 0/C1A0560 (expires 0)<span style="line-height: 23px;"   >&nbsp;</span><span style="line-height: 23px;"   >表示当页面的lsd大于这个值时, 这个page中的xid取值范围.</span></font></div><div><font size="2"   >NOTICE: &nbsp;XIDs 3002038 - 4002945, MultiXIDs 3 - 5, LSN 0/6C41CD8 (expires 0)<span style="line-height: 23px;"   >&nbsp;</span><span style="line-height: 23px;"   >表示当页面的lsd大于这个值时, 这个page中的xid取值范围.</span></font></div><div><font size="2"   >NOTICE: &nbsp;XIDs 2085 - 3002625, MultiXIDs 2 - 4, LSN 0/16D1000 (expires 0)<span style="line-height: 23px;"   >&nbsp;</span><span style="line-height: 23px;"   >表示当页面的lsd大于这个值时, 这个page中的xid取值范围.</span></font></div><div><font size="2"   >NOTICE: &nbsp;XIDs 2084 - 2002177, MultiXIDs 1 - 3, LSN 0/16A5C80 (expires 0)<span style="line-height: 23px;"   >&nbsp;</span><span style="line-height: 23px;"   >表示当页面的lsd大于这个值时, 这个page中的xid取值范围.</span></font></div><div><font size="2"   >NOTICE: &nbsp;XIDs 3 - 1001473, MultiXIDs 1 - 2, LSN 0/0 (expires 0)<span style="line-height: 23px;"   >&nbsp;</span><span style="line-height: 23px;"   >表示当页面的lsd大于这个值时, 这个page中的xid取值范围.</span></font></div><div><font size="2"   >NOTICE: &nbsp;page mature LSN 0/0</font></div><div><font size="2"   >&nbsp;print_xidlsnranges&nbsp;</font></div><div><font size="2"   >--------------------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>接下来根据crt_time反向排序, 取出9条记录, 测试时我们用了8个连接, 所以有8条记录被更新了, 第9条应该是初始状态的记录.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select xmin,xmax,* from test order by crt_time desc limit 9;</font></div><div><font size="2"   >&nbsp; &nbsp;xmin &nbsp; | xmax | id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------+------+----+----------------------------------+----------------------------</font></div><div><font size="2"   >&nbsp;16011638 | &nbsp; &nbsp;0 | 73 | bffc12f83a4a6c5b8e230a5a22b09901 | 2013-09-18 22:37:20.989665</font></div><div><font size="2"   >&nbsp;16011636 | &nbsp; &nbsp;0 | 74 | 2e9303e2ae57a1d9810ef9074b265f89 | 2013-09-18 22:37:20.987248</font></div><div><font size="2"   >&nbsp;16011634 | &nbsp; &nbsp;0 | 75 | 32a7e953677ba36e45c0fbd073c84191 | 2013-09-18 22:37:20.987016</font></div><div><font size="2"   >&nbsp;16011632 | &nbsp; &nbsp;0 | 78 | 8275f216f17027f294c7a54a59bd15e1 | 2013-09-18 22:37:20.986985</font></div><div><font size="2"   >&nbsp;16011630 | &nbsp; &nbsp;0 | 77 | 2a51aa6f7ebc2455d8941b3869f0d4ea | 2013-09-18 22:37:20.986927</font></div><div><font size="2"   >&nbsp;16011628 | &nbsp; &nbsp;0 | 76 | cc679135a79e0cf4cffd85cf2c16ec50 | 2013-09-18 22:37:20.986913</font></div><div><font size="2"   >&nbsp;13004420 | &nbsp; &nbsp;0 | 79 | 0101ac985e5e76760b3029006f042931 | 2013-09-18 22:36:22.654286</font></div><div><font size="2"   >&nbsp;13004424 | &nbsp; &nbsp;0 | 80 | 7dbb1d686f58b1e94aa7e427db548bf4 | 2013-09-18 22:36:22.654202</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 2 | &nbsp; &nbsp;0 | 56 | ad09eac6856d030fa326926ab132a870 | 2013-09-18 21:10:15.450525</font></div><div><font size="2"   >(9 rows)</font></div><p></p></pre></div><div>接下来查看对应的ctid信息, 有了ctid, 我们就可以通过pageinspect这个模块查看页面的lsn信息. 并且根据页面中所有记录的xmin信息范围比对是否符合本补丁的约束.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from (select ctid,xmin,* from test order by crt_time desc limit 9) t order by ctid;</font></div><div><font size="2"   >&nbsp; ctid &nbsp; | &nbsp; xmin &nbsp; | id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------+----------+----+----------------------------------+----------------------------</font></div><div><font size="2"   >&nbsp;(0,53) &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;2 | 56 | ad09eac6856d030fa326926ab132a870 | 2013-09-18 21:10:15.450525</font></div><div><font size="2"   >&nbsp;(8,4) &nbsp; | 13004420 | 79 | 0101ac985e5e76760b3029006f042931 | 2013-09-18 22:36:22.654286</font></div><div><font size="2"   >&nbsp;(8,5) &nbsp; | 13004424 | 80 | 7dbb1d686f58b1e94aa7e427db548bf4 | 2013-09-18 22:36:22.654202</font></div><div><font size="2"   >&nbsp;(9,70) &nbsp;| 16011628 | 76 | cc679135a79e0cf4cffd85cf2c16ec50 | 2013-09-18 22:37:20.986913</font></div><div><font size="2"   >&nbsp;(10,54) | 16011638 | 73 | bffc12f83a4a6c5b8e230a5a22b09901 | 2013-09-18 22:37:20.989665</font></div><div><font size="2"   >&nbsp;(11,31) | 16011630 | 77 | 2a51aa6f7ebc2455d8941b3869f0d4ea | 2013-09-18 22:37:20.986927</font></div><div><font size="2"   >&nbsp;(12,60) | 16011634 | 75 | 32a7e953677ba36e45c0fbd073c84191 | 2013-09-18 22:37:20.987016</font></div><div><font size="2"   >&nbsp;(13,48) | 16011636 | 74 | 2e9303e2ae57a1d9810ef9074b265f89 | 2013-09-18 22:37:20.987248</font></div><div><font size="2"   >&nbsp;(14,67) | 16011632 | 78 | 8275f216f17027f294c7a54a59bd15e1 | 2013-09-18 22:37:20.986985</font></div><div><font size="2"   >(9 rows)</font></div><p></p></pre></div><div>创建pageinspect extension , 用于查看page的lsn信息.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create extension pageinspect;</font></div><div><font size="2"   >CREATE EXTENSION</font></div><div><div><font size="2"   >digoal=# select * from page_header(get_raw_page('test', 9));</font></div><div><font size="2"   >&nbsp; &nbsp; lsn &nbsp; &nbsp; | checksum | flags | lower | upper | special | pagesize | version | prune_xid&nbsp;</font></div><div><font size="2"   >------------+----------+-------+-------+-------+---------+----------+---------+-----------</font></div><div><font size="2"   >&nbsp;0/4D6B4EE0 | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; 5 | &nbsp; 416 | &nbsp;8120 | &nbsp; &nbsp;8192 | &nbsp; &nbsp; 8192 | &nbsp; &nbsp; &nbsp; 4 | &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>lsn符合这条<span style="line-height: 23px;"   >NOTICE: &nbsp;XIDs 16004987 - 0, MultiXIDs 16 - 0, LSN 0/4D6265E0 (expires 0)</span><span style="line-height: 23px;"   >&nbsp;</span><span style="line-height: 23px;"   >表示当页面的lsd大于这个值时, 这个page中的xid取值范围.</span></div><div><span style="line-height: 23px;"   >9号块的xmin范围, 符合以上xid-lsn对应的约束规则. (</span><span style="line-height: 23px;"   >16011628</span><span style="line-height: 23px;"   >&nbsp;&gt;&nbsp;</span><span style="line-height: 23px;"   >16004987</span><span style="line-height: 23px;"   >&nbsp;</span><span style="line-height: 23px;"   >)</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# select min(xmin::text::int8), max(xmin::text::int8) from test where ctid::text ~ '\(9,';</font></div><div><font size="2"   >&nbsp; &nbsp;min &nbsp; &nbsp;| &nbsp; max &nbsp; &nbsp;</font></div><div><font size="2"   >----------+----------</font></div><div><font size="2"   >&nbsp;16011628 | 16011628</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   >src/include/access/transam.h</font></div><div><div><font size="2"   >+ typedef struct XidLSNRange</font></div><div><font size="2"   >+ {</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; XLogRecPtr &nbsp; &nbsp; &nbsp;beginlsn;</font></div><div><font size="2"   >+&nbsp;</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; /* XID range */</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; TransactionId minxid; &nbsp; /* inclusive */</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; TransactionId maxxid; &nbsp; /* exclusive */</font></div><div><font size="2"   >+&nbsp;</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; /* Multi-XID range */</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; TransactionId minmxid; &nbsp;/* inclusive */</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; TransactionId maxmxid; &nbsp;/* exclusive */</font></div><div><font size="2"   >+&nbsp;</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;* Once oldest-xmin is &gt; expirationXmin, all backends have observed that</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;* the global pageMatureLSN is &gt; minlsn. At that point, no-one is going to</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;* look at the clog for XIDs older than minxid, so it can safely be</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;* truncated, and this range can be removed from the array.</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >+ &nbsp; &nbsp; &nbsp; TransactionId expirationXmin;</font></div><div><font size="2"   >+ } XidLSNRange;</font></div></div><p></p></pre></div><div><br></div><div>0号块的信息分析:&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from page_header(get_raw_page('test', 0));</font></div><div><font size="2"   >&nbsp; &nbsp; lsn &nbsp; &nbsp; | checksum | flags | lower | upper | special | pagesize | version | prune_xid&nbsp;</font></div><div><font size="2"   >------------+----------+-------+-------+-------+---------+----------+---------+-----------</font></div><div><font size="2"   >&nbsp;0/4D6B5480 | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; 5 | &nbsp; 480 | &nbsp;1568 | &nbsp; &nbsp;8192 | &nbsp; &nbsp; 8192 | &nbsp; &nbsp; &nbsp; 4 | &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>根据这个lsn信息, 这个页面中的xid取值范围应该是大于<span style="line-height: 23px;"   >16004987, 所有小于这个值的xid都必须置为freezexid=2.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select xmin from test where ctid::text ~ '\(0,' group by xmin order by xmin::text::int8;</font></div><div><font size="2"   >&nbsp; &nbsp;xmin &nbsp;&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 2</font></div><div><font size="2"   >&nbsp; 2842182</font></div><div><font size="2"   >&nbsp; 2842234</font></div><div><font size="2"   >&nbsp; 2842303</font></div><div><font size="2"   >&nbsp; 2842309</font></div><div><font size="2"   >&nbsp; 2842311</font></div><div><font size="2"   >&nbsp; 2842313</font></div><div><font size="2"   >&nbsp; 2842322</font></div><div><font size="2"   >&nbsp; 2842326</font></div><div><font size="2"   >&nbsp; 2842328</font></div><div><font size="2"   >&nbsp; 2842330</font></div><div><font size="2"   >&nbsp; 2842334</font></div><div><font size="2"   >&nbsp; 2842338</font></div><div><font size="2"   >&nbsp; 2842344</font></div><div><font size="2"   >&nbsp; 2842348</font></div><div><font size="2"   >&nbsp; 2842351</font></div><div><font size="2"   >&nbsp; 2842352</font></div><div><font size="2"   >&nbsp; 2842354</font></div><div><font size="2"   >&nbsp; 2842356</font></div><div><font size="2"   >&nbsp; 2842358</font></div><div><font size="2"   >&nbsp;10815213</font></div><div><font size="2"   >&nbsp;10815250</font></div><div><font size="2"   >&nbsp;10815286</font></div><div><font size="2"   >&nbsp;10815307</font></div><div><font size="2"   >&nbsp;10815318</font></div><div><font size="2"   >&nbsp;10815322</font></div><div><font size="2"   >&nbsp;10815324</font></div><div><font size="2"   >&nbsp;10815327</font></div><div><font size="2"   >&nbsp;10815328</font></div><div><font size="2"   >&nbsp;10815329</font></div><div><font size="2"   >&nbsp;10815335</font></div><div><font size="2"   >&nbsp;10815339</font></div><div><font size="2"   >&nbsp;10815341</font></div><div><font size="2"   >&nbsp;10815343</font></div><div><font size="2"   >&nbsp;10815348</font></div><div><font size="2"   >&nbsp;10815353</font></div><div><font size="2"   >&nbsp;10815355</font></div><div><font size="2"   >(37 rows)</font></div><p></p></pre></div><div>显然这个数据块的xmin范围违反了xid-lsn约束, 有一些小于minxid的xmin未置为freezexid. 这显然是个bug.</div><div>期待作者继续更新.</div><div>8号数据块也出现了类似问题 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select ctid,xmin,* from test where ctid::text ~ '\(8,';</font></div><div><font size="2"   >&nbsp;ctid &nbsp;| &nbsp; xmin &nbsp; | id | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-------+----------+----+----------------------------------+----------------------------</font></div><div><font size="2"   >&nbsp;(8,4) | 13004420 | 79 | 0101ac985e5e76760b3029006f042931 | 2013-09-18 22:36:22.654286</font></div><div><font size="2"   >&nbsp;(8,5) | 13004424 | 80 | 7dbb1d686f58b1e94aa7e427db548bf4 | 2013-09-18 22:36:22.654202</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   >digoal=# select * from page_header(get_raw_page('test', 8));</font></div><div><font size="2"   >&nbsp; &nbsp; lsn &nbsp; &nbsp; | checksum | flags | lower | upper | special | pagesize | version | prune_xid&nbsp;</font></div><div><font size="2"   >------------+----------+-------+-------+-------+---------+----------+---------+-----------</font></div><div><font size="2"   >&nbsp;0/4D6B5810 | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; 1 | &nbsp; 460 | &nbsp;7904 | &nbsp; &nbsp;8192 | &nbsp; &nbsp; 8192 | &nbsp; &nbsp; &nbsp; 4 | &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>按照xid-lsn的约束原则, 这两条记录的xmin本该置为freezexid.</div><div><br></div><div>[参考]</div><div><wbr><div>1.&nbsp;<a rel="nofollow" href="http://www.postgresql.org/message-id/flat/521CCC1F.6040904@vmware.com#521CCC1F.6040904@vmware.com"   >http://www.postgresql.org/message-id/flat/521CCC1F.6040904@vmware.com#521CCC1F.6040904@vmware.com</a></div><div>2.&nbsp;<a style="line-height: 23px;" href="http://blog.163.com/digoal@126/blog/static/16387704020138185042307/"   >http://blog.163.com/digoal@126/blog/static/16387704020138185042307/</a></div></div><div>3.&nbsp;<a style="line-height: 23px;" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/pageinspect.html"   >http://www.postgresql.org/docs/devel/static/pageinspect.html</a></div><div>4.&nbsp;<a style="line-height: 23px;" href="http://blog.163.com/digoal@126/blog/static/16387704020114273265960/"   >http://blog.163.com/digoal@126/blog/static/16387704020114273265960/</a></div><div>5.&nbsp;src/backend/access/transam/README</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 23px;"   ><font size="2"   >A basic assumption of a write AHEAD log is that log entries must reach stable</font></span></div><div><font size="2"   >storage before the data-page changes they describe. &nbsp;This ensures that</font></div><div><font size="2"   >replaying the log to its end will bring us to a consistent state where there</font></div><div><font size="2"   >are no partially-performed transactions. &nbsp;To guarantee this, each data page</font></div><div><font size="2"   >(either heap or index) is marked with the LSN (log sequence number --- in</font></div><div><font size="2"   >practice, a WAL file location) of the latest XLOG record affecting the page.</font></div><div><font size="2"   >Before the bufmgr can write out a dirty page, it must ensure that xlog has</font></div><div><font size="2"   >been flushed to disk at least up to the page's LSN. &nbsp;This low-level</font></div><div><font size="2"   >interaction improves performance by not waiting for XLOG I/O until necessary.</font></div><div><font size="2"   >The LSN check exists only in the shared-buffer manager, not in the local</font></div><div><font size="2"   >buffer manager used for temp tables; hence operations on temp tables must not</font></div><div><font size="2"   >be WAL-logged.</font></div><p></p></pre></div><div>6.&nbsp;<span style="line-height: 23px;"   >src/include/access/transam.h</span></div><div style="line-height: 23px;"   ><div style="line-height: 23px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 23px;"   ><font size="2"   >+ typedef struct XidLSNRange</font></div><div style="line-height: 23px;"   ><font size="2"   >+ {</font></div><div style="line-height: 23px;"   ><font size="2"   >+ &nbsp; &nbsp; &nbsp; XLogRecPtr &nbsp; &nbsp; &nbsp;beginlsn;</font></div><div style="line-height: 23px;"   ><font size="2"   >+&nbsp;</font></div><div style="line-height: 23px;"   ><font size="2"   >+ &nbsp; &nbsp; &nbsp; /* XID range */</font></div><div style="line-height: 23px;"   ><font size="2"   >+ &nbsp; &nbsp; &nbsp; TransactionId minxid; &nbsp; /* inclusive */</font></div><div style="line-height: 23px;"   ><font size="2"   >+ &nbsp; &nbsp; &nbsp; TransactionId maxxid; &nbsp; /* exclusive */</font></div><div style="line-height: 23px;"   ><font size="2"   >+&nbsp;</font></div><div style="line-height: 23px;"   ><font size="2"   >+ &nbsp; &nbsp; &nbsp; /* Multi-XID range */</font></div><div style="line-height: 23px;"   ><font size="2"   >+ &nbsp; &nbsp; &nbsp; TransactionId minmxid; &nbsp;/* inclusive */</font></div><div style="line-height: 23px;"   ><font size="2"   >+ &nbsp; &nbsp; &nbsp; TransactionId maxmxid; &nbsp;/* exclusive */</font></div><div style="line-height: 23px;"   ><font size="2"   >+&nbsp;</font></div><div style="line-height: 23px;"   ><font size="2"   >+ &nbsp; &nbsp; &nbsp; /*</font></div><div style="line-height: 23px;"   ><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;* Once oldest-xmin is &gt; expirationXmin, all backends have observed that</font></div><div style="line-height: 23px;"   ><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;* the global pageMatureLSN is &gt; minlsn. At that point, no-one is going to</font></div><div style="line-height: 23px;"   ><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;* look at the clog for XIDs older than minxid, so it can safely be</font></div><div style="line-height: 23px;"   ><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;* truncated, and this range can be removed from the array.</font></div><div style="line-height: 23px;"   ><font size="2"   >+ &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div style="line-height: 23px;"   ><font size="2"   >+ &nbsp; &nbsp; &nbsp; TransactionId expirationXmin;</font></div><div style="line-height: 23px;"   ><font size="2"   >+ } XidLSNRange;</font></div><p></p></pre></div></div></div>
	</div>
</div>
</body>
</html>