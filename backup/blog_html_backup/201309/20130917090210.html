<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Share volume between machines</h2>
	<h5 id="">2013-09-17 9:02:10&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020138178464876/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">共享存储卷在集群中应用广泛, 一般用作集群文件系统, 例如rhcs套件中间gfs.<div>但是如果不想使用集群文件系统的话, 同一时间不能同时被2台或者2台以上的系统挂载. 否则可能将文件系统破坏.</div><div>使用逻辑卷来管理是比较好的选择之一.</div><div>例如存储上划分了1个卷, 同时指派给2台主机.</div><div>在2台主机上都能看到这个存储卷.</div><div>例如 :&nbsp;</div><div>A主机 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-xxx-xxx-xxx-xxx ~]# multipath -ll</font></div><div><font size="2"   >msa_60_vd01vol01 (3600c0ff000da60c23d8a375201000000) dm-3 HP,MSA2312fc</font></div><div><font size="2"   >[size=1.4T][features=1 queue_if_no_path][hwhandler=0][rw]</font></div><div><font size="2"   >\_ round-robin 0 [prio=100][active]</font></div><div><font size="2"   >&nbsp;\_ 0:0:4:1 sdh 8:112 [active][ready]</font></div><div><font size="2"   >&nbsp;\_ 1:0:4:1 sds 65:32 [active][ready]</font></div><div><font size="2"   >\_ round-robin 0 [prio=20][enabled]</font></div><div><font size="2"   >&nbsp;\_ 0:0:3:1 sdf 8:80 &nbsp;[active][ready]</font></div><div><font size="2"   >&nbsp;\_ 1:0:3:1 sdq 65:0 &nbsp;[active][ready]</font></div><div><font size="2"   >msa_62_vd01vol01 (3600c0ff000da60e2f705385201000000) dm-5 HP,MSA2312fc</font></div><div><font size="2"   >[size=1.4T][features=1 queue_if_no_path][hwhandler=0][rw]</font></div><div><font size="2"   >\_ round-robin 0 [prio=100][active]</font></div><div><font size="2"   >&nbsp;\_ 0:0:6:1 sdk 8:160 [active][ready]</font></div><div><font size="2"   >&nbsp;\_ 1:0:6:1 sdv 65:80 [active][ready]</font></div><div><font size="2"   >\_ round-robin 0 [prio=20][enabled]</font></div><div><font size="2"   >&nbsp;\_ 0:0:5:1 sdj 8:144 [active][ready]</font></div><div><font size="2"   >&nbsp;\_ 1:0:5:1 sdu 65:64 [active][ready]</font></div><div><font size="2"   >msa_58_vd01vol01 (3600c0ff000da61d7258a375201000000) dm-1 HP,MSA2312fc</font></div><div><font size="2"   >[size=1.4T][features=1 queue_if_no_path][hwhandler=0][rw]</font></div><div><font size="2"   >\_ round-robin 0 [prio=100][active]</font></div><div><font size="2"   >&nbsp;\_ 0:0:2:1 sdd 8:48 &nbsp;[active][ready]</font></div><div><font size="2"   >&nbsp;\_ 1:0:2:1 sdo 8:224 [active][ready]</font></div><div><font size="2"   >\_ round-robin 0 [prio=20][enabled]</font></div><div><font size="2"   >&nbsp;\_ 0:0:1:1 sdb 8:16 &nbsp;[active][ready]</font></div><div><font size="2"   >&nbsp;\_ 1:0:1:1 sdm 8:192 [active][ready]</font></div><div><font size="2"   >msa_60_vd02vol01 (3600c0ff000da60ca488a375201000000) dm-4 HP,MSA2312fc</font></div><div><font size="2"   >[size=1.4T][features=1 queue_if_no_path][hwhandler=0][rw]</font></div><div><font size="2"   >\_ round-robin 0 [prio=100][active]</font></div><div><font size="2"   >&nbsp;\_ 0:0:3:2 sdg 8:96 &nbsp;[active][ready]</font></div><div><font size="2"   >&nbsp;\_ 1:0:3:2 sdr 65:16 [active][ready]</font></div><div><font size="2"   >\_ round-robin 0 [prio=20][enabled]</font></div><div><font size="2"   >&nbsp;\_ 0:0:4:2 sdi 8:128 [active][ready]</font></div><div><font size="2"   >&nbsp;\_ 1:0:4:2 sdt 65:48 [active][ready]</font></div><div><font size="2"   >msa_58_vd02vol01 (3600c0ff000da6318358a375201000000) dm-2 HP,MSA2312fc</font></div><div><font size="2"   >[size=1.4T][features=1 queue_if_no_path][hwhandler=0][rw]</font></div><div><font size="2"   >\_ round-robin 0 [prio=100][active]</font></div><div><font size="2"   >&nbsp;\_ 0:0:1:2 sdc 8:32 &nbsp;[active][ready]</font></div><div><font size="2"   >&nbsp;\_ 1:0:1:2 sdn 8:208 [active][ready]</font></div><div><font size="2"   >\_ round-robin 0 [prio=20][enabled]</font></div><div><font size="2"   >&nbsp;\_ 0:0:2:2 sde 8:64 &nbsp;[active][ready]</font></div><div><font size="2"   >&nbsp;\_ 1:0:2:2 sdp 8:240 [active][ready]</font></div><div><font size="2"   >msa_57_vd01vol01 (3600c0ff000da62c0be8d375201000000) dm-0 HP,MSA2312fc</font></div><div><font size="2"   >[size=1.4T][features=1 queue_if_no_path][hwhandler=0][rw]</font></div><div><font size="2"   >\_ round-robin 0 [prio=100][active]</font></div><div><font size="2"   >&nbsp;\_ 0:0:0:1 sda 8:0 &nbsp; [active][ready]</font></div><div><font size="2"   >&nbsp;\_ 1:0:0:1 sdl 8:176 [active][ready]</font></div><p></p></pre></div><div><font size="2"   >B主机 :&nbsp;</font></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-xxx-xxx-xxx-xxx ~]# multipath -ll</font></div><div><font size="2"   >msa_60_vd01vol01 (3600c0ff000da60c23d8a375201000000) dm-3 HP,MSA2312fc</font></div><div><font size="2"   >[size=1.4T][features=1 queue_if_no_path][hwhandler=0][rw]</font></div><div><font size="2"   >\_ round-robin 0 [prio=100][active]</font></div><div><font size="2"   >&nbsp;\_ 0:0:4:1 sdh 8:112 [active][ready]</font></div><div><font size="2"   >&nbsp;\_ 1:0:4:1 sds 65:32 [active][ready]</font></div><div><font size="2"   >\_ round-robin 0 [prio=20][enabled]</font></div><div><font size="2"   >&nbsp;\_ 0:0:2:1 sdd 8:48 &nbsp;[active][ready]</font></div><div><font size="2"   >&nbsp;\_ 1:0:2:1 sdo 8:224 [active][ready]</font></div><div><font size="2"   >msa_62_vd01vol01 (3600c0ff000da60e2f705385201000000) dm-5 HP,MSA2312fc</font></div><div><font size="2"   >[size=1.4T][features=1 queue_if_no_path][hwhandler=0][rw]</font></div><div><font size="2"   >\_ round-robin 0 [prio=100][active]</font></div><div><font size="2"   >&nbsp;\_ 0:0:5:1 sdj 8:144 [active][ready]</font></div><div><font size="2"   >&nbsp;\_ 1:0:6:1 sdv 65:80 [active][ready]</font></div><div><font size="2"   >\_ round-robin 0 [prio=20][enabled]</font></div><div><font size="2"   >&nbsp;\_ 0:0:6:1 sdk 8:160 [active][ready]</font></div><div><font size="2"   >&nbsp;\_ 1:0:5:1 sdu 65:64 [active][ready]</font></div><div><font size="2"   >msa_58_vd01vol01 (3600c0ff000da61d7258a375201000000) dm-1 HP,MSA2312fc</font></div><div><font size="2"   >[size=1.4T][features=1 queue_if_no_path][hwhandler=0][rw]</font></div><div><font size="2"   >\_ round-robin 0 [prio=100][active]</font></div><div><font size="2"   >&nbsp;\_ 0:0:3:1 sdf 8:80 &nbsp;[active][ready]</font></div><div><font size="2"   >&nbsp;\_ 1:0:1:1 sdm 8:192 [active][ready]</font></div><div><font size="2"   >\_ round-robin 0 [prio=20][enabled]</font></div><div><font size="2"   >&nbsp;\_ 0:0:1:1 sdb 8:16 &nbsp;[active][ready]</font></div><div><font size="2"   >&nbsp;\_ 1:0:3:1 sdq 65:0 &nbsp;[active][ready]</font></div><div><font size="2"   >msa_60_vd02vol01 (3600c0ff000da60ca488a375201000000) dm-4 HP,MSA2312fc</font></div><div><font size="2"   >[size=1.4T][features=1 queue_if_no_path][hwhandler=0][rw]</font></div><div><font size="2"   >\_ round-robin 0 [prio=100][active]</font></div><div><font size="2"   >&nbsp;\_ 0:0:2:2 sde 8:64 &nbsp;[active][ready]</font></div><div><font size="2"   >&nbsp;\_ 1:0:2:2 sdp 8:240 [active][ready]</font></div><div><font size="2"   >\_ round-robin 0 [prio=20][enabled]</font></div><div><font size="2"   >&nbsp;\_ 0:0:4:2 sdi 8:128 [active][ready]</font></div><div><font size="2"   >&nbsp;\_ 1:0:4:2 sdt 65:48 [active][ready]</font></div><div><font size="2"   >msa_58_vd02vol01 (3600c0ff000da6318358a375201000000) dm-2 HP,MSA2312fc</font></div><div><font size="2"   >[size=1.4T][features=1 queue_if_no_path][hwhandler=0][rw]</font></div><div><font size="2"   >\_ round-robin 0 [prio=100][active]</font></div><div><font size="2"   >&nbsp;\_ 0:0:1:2 sdc 8:32 &nbsp;[active][ready]</font></div><div><font size="2"   >&nbsp;\_ 1:0:3:2 sdr 65:16 [active][ready]</font></div><div><font size="2"   >\_ round-robin 0 [prio=20][enabled]</font></div><div><font size="2"   >&nbsp;\_ 0:0:3:2 sdg 8:96 &nbsp;[active][ready]</font></div><div><font size="2"   >&nbsp;\_ 1:0:1:2 sdn 8:208 [active][ready]</font></div><div><font size="2"   >msa_57_vd01vol01 (3600c0ff000da62c0be8d375201000000) dm-0 HP,MSA2312fc</font></div><div><font size="2"   >[size=1.4T][features=1 queue_if_no_path][hwhandler=0][rw]</font></div><div><font size="2"   >\_ round-robin 0 [prio=100][active]</font></div><div><font size="2"   >&nbsp;\_ 0:0:0:1 sda 8:0 &nbsp; [active][ready]</font></div><div><font size="2"   >&nbsp;\_ 1:0:0:1 sdl 8:176 [active][ready]</font></div><p></p></pre></div><div>在A主机上创建pv, vg, lv. 并格式文件系统.</div><div>创建完后, 在B主机上扫描 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pvscan</font></div><div><font size="2"   >vgscan</font></div><div><font size="2"   >lvscan</font></div><p></p></pre></div><div>扫描完后可以看到创建的pv, vg, lv.</div><div>此时在B主机上, lv处于未激活状态 :&nbsp;</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-xxx-xxx-xxx-xxx ~]# lvs</font></div><div><font size="2"   >&nbsp; LV &nbsp; VG &nbsp; &nbsp; &nbsp; Attr &nbsp; LSize Origin Snap% &nbsp;Move Log Copy% &nbsp;Convert</font></div><div><font size="2"   >&nbsp; lv01 vgdata01 -wi--- 8.17T</font></div><div><div><font size="2"   >[root@db-xxx-xxx-xxx-xxx ~]# ll /dev/mapper/vgdata01-lv01</font></div><div><font size="2"   >ls: /dev/mapper/vgdata01-lv01: No such file or directory</font></div></div><p></p></pre></div><div>而在A主机上, lv处于激活状态 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-xxx-xxx-xxx-xxx ~]# lvs</font></div><div><font size="2"   >&nbsp; LV &nbsp; VG &nbsp; &nbsp; &nbsp; Attr &nbsp; LSize Origin Snap% &nbsp;Move Log Copy% &nbsp;Convert</font></div><div><font size="2"   >&nbsp; lv01 vgdata01 -wi-a- 8.17T</font></div></div><div><div><font size="2"   >[root@db-xxx-xxx-xxx-xxx ~]# ll /dev/mapper/vgdata01-lv01&nbsp;</font></div><div><font size="2"   >brw-rw---- 1 root disk 253, 6 Sep 17 08:29 /dev/mapper/vgdata01-lv01</font></div></div><p></p></pre></div><div>在B主机上激活逻辑卷的命令,&nbsp;<span style="line-height: 23px;"   >激活后map device 被自动创建 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-<span style="line-height: 23px;"   >xxx-xxx-xxx-xxx</span>&nbsp;~]# lvchange -ay vgdata01/lv01</font></div><div><font size="2"   >[root@db-<span style="line-height: 23px;"   >xxx-xxx-xxx-xxx</span>&nbsp;~]# ll /dev/mapper/vgdata01-lv01</font></div><div><font size="2"   >brw-rw---- 1 root disk 253, 6 Sep 17 08:54 /dev/mapper/vgdata01-lv01</font></div><p></p></pre></div><div>此时可以将A主机卸载,&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-A ~]# umount /dev/mapper/vgdata01-lv01&nbsp;</font></div><div></div><p></p></pre><div><span style="line-height: 23px;"   >然后在B主机挂载该文件系统&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-B ~]# mount /dev/mapper/vgdata01-lv01 /database1</font></div><div></div><p></p></pre></div><div>在任意主机上创建的文件, 在另一主机挂载该卷后可以正常访问.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-B database1]# date +%F%T &gt;&gt;./test</font></div><div><font size="2"   >[root@db-B database1]# ll</font></div><div><font size="2"   >total 20</font></div><div><font size="2"   >drwx------ 2 root root 16384 Sep 17 08:29 lost+found</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp; &nbsp;19 Sep 17 08:57 test</font></div><div><font size="2"   >[root@db-B database1]# cat test</font></div><div><font size="2"   >2013-09-1708:57:22</font></div><p></p></pre></div><div>将B卸载并冻结lv后, 在A挂载.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-B ~]# umount /database1</font></div><div><span style="line-height: 23px;"   ><font size="2"   >[root@db-B ~]# lvchange -an vgdata01/lv01</font></span></div><div><span style="line-height: 23px;"   ><font size="2"   >[root@db-A ~]# lvchange -ay vgdata01/lv01</font></span></div><div><font size="2"   >[root@db-A ~]# mount /dev/mapper/vgdata01-lv01 /database</font></div><div><div><font size="2"   >[root@db-A ~]# cd /database/</font></div><div><font size="2"   >[root@db-A database]# ll</font></div><div><font size="2"   >total 20</font></div><div><font size="2"   >drwx------ 2 root root 16384 Sep 17 08:29 lost+found</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp; &nbsp;19 Sep 17 08:57 test</font></div><div><font size="2"   >[root@db-A database]# cat test</font></div><div><font size="2"   >2013-09-1708:57:22</font></div></div><p></p></pre></div><div><br></div><div>[注意]</div><div>1.&nbsp;<span style="line-height: 23px;"   >对于不使用集群文件系统共享卷的情况, 请务必小心, 切忌不要同时挂载该文件系统.</span></div><div><span style="line-height: 23px;"   >2. 不建议使用fstab自动挂载这类文件系统. 同时确保只有一个系统中的lv处于激活状态, 避免误挂载.</span></div><div><br></div><div>[参考]</div><div>1. man lvs</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; The lv_attr bits are:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 &nbsp;Volume &nbsp;type: &nbsp;(m)irrored, (M)irrored without initial sync, (o)rigin, (O)rigin with merging snapshot,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;(s)napshot, merging (S)napshot, (p)vmove, (v)irtual, &nbsp;mirror &nbsp;(i)mage, &nbsp;mirror &nbsp;(I)mage &nbsp;out-of-sync,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;under (c)onversion</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 &nbsp;Permissions: (w)riteable, (r)ead-only</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3 &nbsp;Allocation &nbsp;policy: &nbsp;(c)ontiguous, &nbsp;c(l)ing, (n)ormal, (a)nywhere, (i)nherited This is capitalised if</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;the volume is currently locked against allocation changes, for example during pvmove (8).</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4 &nbsp;fixed (m)inor</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5 &nbsp;State: (a)ctive, (s)uspended, (I)nvalid &nbsp;snapshot, &nbsp;invalid &nbsp;(S)uspended &nbsp;snapshot, &nbsp;mapped &nbsp;(d)evice</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;present without tables, mapped device present with (i)nactive table</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 6 &nbsp;device (o)pen</font></div><p></p></pre></div><div><br></div><br><wbr></div></div>
	</div>
</div>
</body>
</html>