<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">systemtap Built-in probe point types (DWARF-based kernel or module probes)</h2>
	<h5 id="">2013-09-29 10:31:00&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013823101827553/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><pre class="prettyprint"   ><p><font size="2"   >This family of probe points uses symbolic debugging information for the target kernel or module, as may be found in executables that have not been stripped, or in the separate debuginfo packages. They allow logical placement of probes into the execution path of the target by specifying a set of points in the source or object code. When a matching statement executes on any processor, the probe handler is run in that context.</font></p></pre></div><div>以上是Built-in probe point types的定义. 没有什么特别的, 它是操作系统自带的就行了. 每个内核版本有对应的包.</div><pre class="prettyprint"   ><p></p><div><font size="2"   >Probe points in a kernel are identified by module, source file, line number, function name or some combination of these.</font></div><div></div><p></p></pre><div><span style="line-height: 23px;"   >例如 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# rpm -qa|grep debuginfo</font></div><div><font size="2"   >kernel-debuginfo-common-2.6.18-348.12.1.el5</font></div><div><font size="2"   >kernel-debuginfo-2.6.18-348.12.1.el5</font></div><div><font size="2"   >[root@db-172-16-3-39 ~]# uname -a</font></div><div><font size="2"   >Linux db-172-16-3-39.sky-mobi.com 2.6.18-348.12.1.el5 #1 SMP Wed Jul 10 05:28:41 EDT 2013 x86_64 x86_64 x86_64 GNU/Linux</font></div><p></p></pre></div><div><span style="line-height: 23px;"   >探针的使用语法, 探针指定的方式和DNS类似, a.b.c.d, a为最大的类, b为a下面的子类, 以此类推. a也可以称为prefix, c也可称为suffix.</span></div><div><span style="line-height: 23px;"   >可能还有d, 一般为配置项. 例如 :&nbsp;</span></div><pre class="prettyprint"   ><p></p><div><font size="2"   >module(MPATTERN).function(PATTERN).return.maxactive(VALUE)</font></div><div></div><p></p></pre><div><span style="line-height: 23px;"   >一般的用法举例 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >kernel.function("foo")</font></div><div><font size="2"   >kernel.function("foo").return</font></div><div><font size="2"   >module("ext3").function("ext3_*")</font></div><div><font size="2"   >kernel.function("no_such_function") ? &nbsp;#这里的问号表示即使没有匹配的探针也不报错.</font></div><div><font size="2"   >syscall.*</font></div><div><font size="2"   >end</font></div><div><font size="2"   >timer.ms(5000)</font></div><p></p></pre></div><div>?的用法详见</div><div><a href="http://blog.163.com/digoal@126/blog/static/1638770402013811957335/"   >http://blog.163.com/digoal@126/blog/static/1638770402013811957335/</a></div><div><br></div><div>如果要获得当前系统中支持的函数探针 &nbsp;:&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -l 'kernel.function("**")'</font></div><div></div><p></p></pre><div><span style="line-height: 23px;"   >或者使用通配符, 通配符的用法可参考man stapprobes, 或者接着往下看.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -l 'kernel.function("zlib*")'</font></div><div><font size="2"   >kernel.function("zlib_adler32@include/linux/zutil.h:81")</font></div><div><font size="2"   >kernel.function("zlib_fixedtables@lib/zlib_inflate/inflate.c:94")</font></div><div><font size="2"   >kernel.function("zlib_inflate@lib/zlib_inflate/inflate.c:333")</font></div><div><font size="2"   >kernel.function("zlib_inflateEnd@lib/zlib_inflate/inflate.c:756")</font></div><div><font size="2"   >kernel.function("zlib_inflateIncomp@lib/zlib_inflate/inflate.c:888")</font></div><div><font size="2"   >kernel.function("zlib_inflateInit2@lib/zlib_inflate/inflate.c:64")</font></div><div><font size="2"   >kernel.function("zlib_inflateReset@lib/zlib_inflate/inflate.c:24")</font></div><div><font size="2"   >kernel.function("zlib_inflateSyncPacket@lib/zlib_inflate/inflate.c:162")</font></div><div><font size="2"   >kernel.function("zlib_inflate_table@lib/zlib_inflate/inftrees.c:25")</font></div><div><font size="2"   >kernel.function("zlib_inflate_workspacesize@lib/zlib_inflate/inflate.c:19")</font></div><div><font size="2"   >kernel.function("zlib_updatewindow@lib/zlib_inflate/inflate.c:117")</font></div><p></p></pre></div><div><span style="line-height: 23px;"   ><br></span></div><div><span style="line-height: 23px;"   >DWARF探针大致可以通过模块, 源文件, 行号, 函数名, 或者以上的组合来指定.</span></div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >kernel.function(PATTERN)</font></div><div><font size="2"   >kernel.function(PATTERN).call</font></div><div><font size="2"   >kernel.function(PATTERN).return</font></div><div><font size="2"   >kernel.function(PATTERN).return.maxactive(VALUE)</font></div><div><font size="2"   >kernel.function(PATTERN).inline</font></div><div><font size="2"   >kernel.function(PATTERN).label(LPATTERN)</font></div><div><font size="2"   >module(MPATTERN).function(PATTERN)</font></div><div><font size="2"   >module(MPATTERN).function(PATTERN).call</font></div><div><font size="2"   >module(MPATTERN).function(PATTERN).return.maxactive(VALUE)</font></div><div><font size="2"   >module(MPATTERN).function(PATTERN).inline</font></div><div><font size="2"   >kernel.statement(PATTERN)</font></div><div><font size="2"   >kernel.statement(ADDRESS).absolute</font></div><div><font size="2"   >module(MPATTERN).statement(PATTERN)</font></div><p></p></pre></div><div>以上探针的形式解释 :&nbsp;</div><pre class="prettyprint"   ><p></p><div><font size="2"   >The <u>.function</u> variant places a probe near the beginning of the named function, so that parameters are available as context variables.</font></div><div></div><p></p></pre><div><span style="line-height: 23px;"   >.function指函数开始位置(通过pp函数可以看到精确的位置信息). 所以使用.function探针可以打印函数的参数, 以及上下文相关变量.&nbsp;</span></div><div>例子1 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap --vp 5 -e 'probe kernel.function("tcp_v4_connect") {printf("%s, %d, %d, %s\n", pp(), pid(), cpu(), $$vars);}'</font></div><div><font size="2"   >Parsed kernel "/lib/modules/2.6.18-348.12.1.el5/build/.config", containing 1977 tuples</font></div><div><font size="2"   >Parsed kernel /lib/modules/2.6.18-348.12.1.el5/build/Module.symvers, which contained 3546 vmlinux exports</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 4, processed: 4</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/*.stp ", found: 81, processed: 81</font></div><div><font size="2"   >Pass 1: parsed user script and 85 library script(s) using 146796virt/23712res/3012shr/21392data kb, in 160usr/10sys/172real ms.</font></div><div><font size="2"   >handler输出如下.</font></div><div><font size="2"   >kernel.function("tcp_v4_connect@net/ipv4/tcp_ipv4.c:158"), 15460, 2, sk=0xffff810224ec5340 uaddr=0xffff8101dfd2dec8 addr_len=0x10 inet=? tp=? usin=? rt=? daddr=0xffff8102 nexthop=? tmp=? err=? inet_opt=?</font></div><p></p></pre></div><div><span style="line-height: 23px;"   >tcp_v4_connect函数源码参考本文末尾, 已经加了行号. 从以上输出可以看到, 探针的位置在158行, 也就是函数开始位置.</span></div><div><span style="line-height: 23px;"   >由于函数的本地变量未初始化, 所以这里打印出来的本地变量是未知的? .&nbsp;</span></div><div><span style="line-height: 23px;"   >daddr这个本地变量在第163行才定义, 但是在探针处158行, 函数开始位置为什么有值呢? 有缘人帮忙解答一下, 谢谢.</span></div><div><span style="line-height: 23px;"   ><br></span></div><div><pre class="prettyprint"   ><p><font size="2"   >The <u>.return</u> variant places a probe at the moment of return from the named function, so the return value is available as the $return context variable. The entry parameters are also available, though the function may have changed their values. Return probes may be further qualified with <u>.maxactive</u>, which specifies how many instances of the specified function can be probed simultaneously. You can leave off <u>.maxactive</u> in most cases, as the default (<u>KRETACTIVE</u>) should be sufficient. However, if you notice an excessive number of skipped probes, try setting <u>.maxactive</u> to incrementally higher values to see if the number of skipped probes decreases.</font></p></pre></div><div>.return 在函数返回时触发, 因此可以获得函数的返回值$return. 同样函数的参数也是可以被获得的, 但是, 这些值可能在函数内被变更过, .return后面还可以再加一个.maxactive()属性, 用来限定允许最大多少个该"函数探针"被同时触发. 默认取KRETACTIVE的值. 如果在调试过程中发现有很多skipped probes, 可以适当加大这个.maxactive值.</div><div><span style="line-height: 23px;"   >例子2 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 23px;"   ><font size="2"   ><div>[root@db-172-16-3-39 ~]# stap --vp 5 -e 'probe kernel.function("tcp_v4_connect") {printf("%s, %d, %d, %s, %s\n", pp(), pid(), cpu(), $$vars, $sk$$.$uaddr$$.$addr_len$$.$inet$$.$tp$$.$usin$$.$rt$$.$daddr$$.$nexthop$$.$tmp$$.$err$$.$inet_opt$$);}'</div><div>Parsed kernel "/lib/modules/2.6.18-348.12.1.el5/build/.config", containing 1977 tuples</div><div>Parsed kernel /lib/modules/2.6.18-348.12.1.el5/build/Module.symvers, which contained 3546 vmlinux exports</div><div>Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 4, processed: 4</div><div>Searched: " /usr/share/systemtap/tapset/*.stp ", found: 81, processed: 81</div><div>Pass 1: parsed user script and 85 library script(s) using 146812virt/23700res/3012shr/21408data kb, in 160usr/20sys/173real ms.</div><div>kernel.function("tcp_v4_connect@net/ipv4/tcp_ipv4.c:158"), 4284, 3, sk=0xffff81012d214d00 uaddr=0xffff8100aa907ec8 addr_len=0x10 inet=? tp=? usin=? rt=? daddr=0xffff8101 nexthop=? tmp=? err=? inet_opt=?, {.__sk_common={.skc_family=2, .skc_state='\a', .skc_reuse='\000', .skc_bound_dev_if=0, .skc_node={.next=0x0, .pprev=0x0}, .skc_bind_node={.next=0x0, .pprev=0x0}, .skc_refcnt={.counter=1}, .skc_hash=0, .skc_prot=0xffffffff80370780}, .sk_shutdown=0, .sk_no_check=0, .sk_userlocks=0, .sk_protocol='\006', .sk_type=1, .sk_rcvbuf=87380, .sk_lock={.slock={.raw_lock={.slock=1}}, .owner=0x1, .wq={.lock={.raw_lock={.slock=1}}, .task_list={.next=0xffff81012d214d58, .prev=0xffff81012d214d58}}}, .sk_sleep=0xffff81012ef9</div><div><br></div></font></span></div><div><font size="2"   ><div style="line-height: 23px;"   >[root@db-172-16-3-39 ~]# stap --vp 5 -e 'probe kernel.function("tcp_v4_connect").return {printf("%s, %d, %d, %s, %s\n", pp(), pid(), cpu(), $$vars, $sk$$.$uaddr$$.$addr_len$$.$inet$$.$tp$$.$usin$$.$rt$$.$daddr$$.$nexthop$$.$tmp$$.$err$$.$inet_opt$$);}'</div><div style="line-height: 23px;"   >Parsed kernel "/lib/modules/2.6.18-348.12.1.el5/build/.config", containing 1977 tuples</div><div style="line-height: 23px;"   >Parsed kernel /lib/modules/2.6.18-348.12.1.el5/build/Module.symvers, which contained 3546 vmlinux exports</div><div style="line-height: 23px;"   >Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 4, processed: 4</div><div style="line-height: 23px;"   >Searched: " /usr/share/systemtap/tapset/*.stp ", found: 81, processed: 81</div><div style="line-height: 23px;"   >Pass 1: parsed user script and 85 library script(s) using 146804virt/23700res/3012shr/21400data kb, in 160usr/10sys/172real ms.</div><div style="line-height: 23px;"   >kernel.function("tcp_v4_connect@net/ipv4/tcp_ipv4.c:158").return, 4336, 2, sk=0xffff810222892d00 uaddr=0xffff8100aa631ec8 addr_len=0x10 inet=? tp=? usin=? rt=? daddr=0xffff8102 nexthop=? tmp=? err=? inet_opt=?, {.__sk_common={.skc_family=2, .skc_state='\a', .skc_reuse='\000', .skc_bound_dev_if=0, .skc_node={.next=0x0, .pprev=0x0}, .skc_bind_node={.next=0x0, .pprev=0x0}, .skc_refcnt={.counter=1}, .skc_hash=0, .skc_prot=0xffffffff80370780}, .sk_shutdown=0, .sk_no_check=0, .sk_userlocks=0, .sk_protocol='\006', .sk_type=1, .sk_rcvbuf=87380, .sk_lock={.slock={.raw_lock={.slock=1}}, .owner=0x1, .wq={.lock={.raw_lock={.slock=1}}, .task_list={.next=0xffff810222892d58, .prev=0xffff810222892d58}}}, .sk_sleep=0xffff81022bcc</div><div style="line-height: 23px;"   ># 在.return探针中可以得到$return变量的值.</div><div>[root@db-172-16-3-39 ~]# stap --vp 5 -e 'probe kernel.function("tcp_v4_connect").return {printf("%s, %d, %d, %s\n", pp(), pid(), cpu(), $return$$);}'<br>Parsed kernel "/lib/modules/2.6.18-348.12.1.el5/build/.config", containing 1977 tuples<br>Parsed kernel /lib/modules/2.6.18-348.12.1.el5/build/Module.symvers, which contained 3546 vmlinux exports<br>Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 4, processed: 4<br>Searched: " /usr/share/systemtap/tapset/*.stp ", found: 81, processed: 81<br>Pass 1: parsed user script and 85 library script(s) using 146796virt/23704res/3012shr/21392data kb, in 160usr/10sys/171real ms.<br>kernel.function("tcp_v4_connect@net/ipv4/tcp_ipv4.c:158").return, 6461, 2, 0</div></font></div><p></p></pre></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >函数可用的三个过滤规则如下 : </font></div><div><font size="2"   >The <u>.inline</u> modifier for <u>.function</u> filters the results to include only instances of inlined functions.&nbsp;</font></div><div><font size="2"   >The <u>.call </u>modifier selects the opposite subset.&nbsp;</font></div><div><font size="2"   >The <u>.exported</u> modifier filters the results to include only exported functions.&nbsp;</font></div><div><font size="2"   >Inline functions do not have an identifiable return point, so<u> .return</u> is not supported on <u>.inline </u>probes.</font></div><div><font size="2"   >inline过滤器不能使用.return指定返回probe, 因为inline没有返回点.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The <u>.statement</u> variant places a probe at the exact spot, exposing those local variables that are visible there.</font></div><div><font size="2"   >语句级的探针, 用于指定源码中的指定行或者行范围, 一般用于观察变量的值在函数中的变化.</font></div><div><font size="2"   >另外, 其实如果使用statement探针, 指定行为funciton开头的行号. 那么和使用funciton探针效果是一样的.</font></div><p></p></pre></div><div>inline函数过滤参考 :&nbsp;</div><div><a rel="nofollow" href="http://en.wikipedia.org/wiki/Inline_function"   >http://en.wikipedia.org/wiki/Inline_function</a></div><div><span style="line-height: 23px;"   >例子3 :&nbsp;</span></div><div>probe kernel.statement("*@net/ipv4/tcp_ipv4.c:159")</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -e 'probe kernel.statement("*@net/ipv4/tcp_ipv4.c:159") {printf("%s, %d, %d, %s, %s\n", pp(), pid(), cpu(), $$vars, $sk$$.$uaddr$$.$addr_len$$.$inet$$.$tp$$.$usin$$.$rt$$.$daddr$$.$nexthop$$.$tmp$$.$err$$.$inet_opt$$);}'</font></div><div><font size="2"   >kernel.statement("tcp_v4_connect@net/ipv4/tcp_ipv4.c:168"), 4761, 2, sk=0xffff810222892d00 uaddr=0xffff8100acfc1ec8 addr_len=0x10 inet=? tp=? usin=? rt=? daddr=0xffff8102 nexthop=? tmp=? err=? inet_opt=?, {.__sk_common={.skc_family=2, .skc_state='\a', .skc_reuse='\000', .skc_bound_dev_if=0, .skc_node={.next=0x0, .pprev=0x0}, .skc_bind_node={.next=0x0, .pprev=0x0}, .skc_refcnt={.counter=1}, .skc_hash=0, .skc_prot=0xffffffff80370780}, .sk_shutdown=0, .sk_no_check=0, .sk_userlocks=0, .sk_protocol='\006', .sk_type=1, .sk_rcvbuf=87380, .sk_lock={.slock={.raw_lock={.slock=1}}, .owner=0x1, .wq={.lock={.raw_lock={.slock=1}}, .task_list={.next=0xffff810222892d58, .prev=0xffff810222892d58}}}, .sk_sleep=0xffff81022327</font></div><p></p></pre></div><div>注意以上输出, pp()函数输出的位置为168行. 参见本文末尾, 168行所有的变量定义都好了.</div><div>改成169行, 实际上输出的是171行的位置. 171是下一个语句开始前.</div><div>probe kernel.statement("*@net/ipv4/tcp_ipv4.c:169")</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -e 'probe kernel.statement("*@net/ipv4/tcp_ipv4.c:169") {printf("%s, %d, %d, %s, %s\n", pp(), pid(), cpu(), $$vars, $sk$$.$uaddr$$.$addr_len$$.$inet$$.$tp$$.$usin$$.$rt$$.$daddr$$.$nexthop$$.$tmp$$.$err$$.$inet_opt$$);}'</font></div><div><font size="2"   >kernel.statement("tcp_v4_connect@net/ipv4/tcp_ipv4.c:171"), 4907, 5, sk=0xffff81012d214080 uaddr=0xffff8100afb07ec8 addr_len=0x10 inet=? tp=? usin=? rt=? daddr=0xffff8101 nexthop=? tmp=? err=? inet_opt=?, {.__sk_common={.skc_family=2, .skc_state='\a', .skc_reuse='\000', .skc_bound_dev_if=0, .skc_node={.next=0x0, .pprev=0x0}, .skc_bind_node={.next=0x0, .pprev=0x0}, .skc_refcnt={.counter=1}, .skc_hash=0, .skc_prot=0xffffffff80370780}, .sk_shutdown=0, .sk_no_check=0, .sk_userlocks=0, .sk_protocol='\006', .sk_type=1, .sk_rcvbuf=87380, .sk_lock={.slock={.raw_lock={.slock=1}}, .owner=0x1, .wq={.lock={.raw_lock={.slock=1}}, .task_list={.next=0xffff81012d2140d8, .prev=0xffff81012d2140d8}}}, .sk_sleep=0xffff81012d0d</font></div><p></p></pre></div><div>使用statement探针时, 不需要指定函数名. 关键是要指定文件和行号.</div><div><br></div><div>接下来对通配符做一些介绍 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >kernel.function(PATTERN)</font></div><div><font size="2"   >kernel.function(PATTERN).call</font></div><div><font size="2"   >kernel.function(PATTERN).return</font></div><div><font size="2"   >kernel.function(PATTERN).return.maxactive(VALUE)</font></div><div><font size="2"   >kernel.function(PATTERN).inline</font></div><div><font size="2"   >kernel.function(PATTERN).label(LPATTERN)</font></div><div><font size="2"   >module(MPATTERN).function(PATTERN)</font></div><div><font size="2"   >module(MPATTERN).function(PATTERN).call</font></div><div><font size="2"   >module(MPATTERN).function(PATTERN).return.maxactive(VALUE)</font></div><div><font size="2"   >module(MPATTERN).function(PATTERN).inline</font></div><div><font size="2"   >kernel.statement(PATTERN)</font></div><div><font size="2"   >kernel.statement(ADDRESS).absolute</font></div><div><font size="2"   >module(MPATTERN).statement(PATTERN)</font></div><p></p></pre></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >In the above probe descriptions, MPATTERN stands for a string literal that identifies the loaded kernel module of interest and LPATTERN stands for a source program label. Both MPATTERN and LPATTERN may include asterisk (*), square brackets "[]", and question mark (?) wildcards.</font></div><div><font size="2"   ><span style="line-height: 23px;"   >MPATTERN 和&nbsp;</span><span style="line-height: 23px;"   >LPATTERN</span><span style="line-height: 23px;"   >&nbsp;分别表示模块和label的表达样式字符串, 字符串外必须使用""双引号, 字符串中可以使用*, [], ? 等通配符.</span></font></div><div><font size="2"   >PATTERN stands for a string literal that identifies a point in the program. It is composed of three parts:</font></div><div><font size="2"   >以上PATTERN代表funciton和statement中<span style="line-height: 23px;"   >的表达样式字符串,&nbsp;</span><span style="line-height: 23px;"   >字符串外必须使用""双引号. 字符串包含3个部分.</span></font></div><div><font size="2"   >The first part is the name of a function, as would appear in the nm program's output. This part may use the asterisk and question mark wildcard operators to match multiple names.</font></div><div><font size="2"   >第一个部分是函数名, 可以使用<span style="line-height: 23px;"   >*, [], ? 等通配符.</span></font></div><div><font size="2"   >The second part is optional, and begins with the ampersand (@) character. It is followed by the path to the source file containing the function, which may include a wildcard pattern, such as mm/slab*. In most cases, the path should be relative to the top of the linux source directory, although an absolute path may be necessary for some kernels. If a relative pathname doesn't work, try absolute.</font></div><div><font size="2"   >第二个部分是源文件(可选), 以@开头, 后面跟字符串(源文件路径), 字符串<span style="line-height: 23px;"   >可以使用</span><span style="line-height: 23px;"   >*, [], ? 等通配符.</span></font></div><div><font size="2"   >源文件一般使用的是相对路径, 例如本文用到的<span style="line-height: 23px;"   >/usr/src/debug/kernel-2.6.18/linux-2.6.18-348.12.1.el5.x86_64/net/ipv4/tcp_ipv4.c</span></font></div><div><font size="2"   ><span style="line-height: 23px;"   >在使用时输入相对路径@</span><span style="line-height: 23px;"   >net/ipv4/tcp_ipv4.c</span></font></div><div><span style="line-height: 23px;"   ><font size="2"   >如果内核不认相对路径的话, 请使用绝对路径.</font></span></div><div><span style="line-height: 23px;"   ><font size="2"   >The third part is optional if the file name part was given. It identifies the line number in the source file, preceded by a ``:'' or ``+''.&nbsp;</font></span></div><div><span style="line-height: 23px;"   ><font size="2"   >The line number is assumed to be an absolute line number if preceded by a ``:'',&nbsp;</font></span></div><div><span style="line-height: 23px;"   ><font size="2"   >or relative to the entry of the function if preceded by a ``+''.&nbsp;</font></span></div><div><span style="line-height: 23px;"   ><font size="2"   >All the lines in the function can be matched with ``:*''. &nbsp;函数所有行用:*表示</font></span></div><div><span style="line-height: 23px;"   ><font size="2"   >A range of lines x through y can be matched with ``:x-y''. 行范围用:x-y表示.</font></span></div><div><span style="line-height: 20px; font-size: small; font-family: Arial, Helvetica, sans-serif;"   >第三个部分是第二部分的suffix, 如果没有第二部分的话就没有第三部分.</span></div></div><div><font size="2"   >第三部分指定行号.以 :或者+开头.</font></div><div><font size="2"   >:表示指定的行号</font></div><div><font size="2"   >+表示offset多少行, 相对行号.</font></div><div><font size="2"   >Alternately, specify PATTERN as a numeric constant to indicate a relative module address or an absolute kernel address.<br></font></div><div><font size="2"   >最后, PATTERN可以用模块地址或者内核地址来填充.</font></div></pre></div><div>一般用statement探针时可以指定行号或者*代表这个函数中的所有行, 在这种情况下第一部分最好指定函数.</div><div>例如 :&nbsp;</div><div>probe kernel.statement("tcp_v4_connect@net/ipv4/tcp_ipv4.c:*")</div><div>这个探针会对<span style="line-height: 23px;"   >net/ipv4/tcp_ipv4.c中函数</span><span style="line-height: 23px;"   >tcp_v4_connect的所以行触发 .&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -e 'probe kernel.statement("tcp_v4_connect@net/ipv4/tcp_ipv4.c:*") {printf("%s, %d, %d, %s, %s\n", pp(), pid(), cpu(), $$vars, $sk$$.$uaddr$$.$addr_len$$.$inet$$.$tp$$.$usin$$.$rt$$.$daddr$$.$nexthop$$.$tmp$$.$err$$.$inet_opt$$);}'</font></div><div><font size="2"   >kernel.statement("tcp_v4_connect@net/ipv4/tcp_ipv4.c:171"), 5847, 3, sk=0xffff81012d2146c0 uaddr=0xffff8100a82d1ec8 addr_len=0x10 inet=? tp=? usin=? rt=? daddr=0xffff8101 nexthop=? tmp=? err=? inet_opt=?, {.__sk_common={.skc_family=2, .skc_state='\a', .skc_reuse='\000', .skc_bound_dev_if=0, .skc_node={.next=0x0, .pprev=0x0}, .skc_bind_node={.next=0x0, .pprev=0x0}, .skc_refcnt={.counter=1}, .skc_hash=0, .skc_prot=0xffffffff80370780}, .sk_shutdown=0, .sk_no_check=0, .sk_userlocks=0, .sk_protocol='\006', .sk_type=1, .sk_rcvbuf=87380, .sk_lock={.slock={.raw_lock={.slock=1}}, .owner=0x1, .wq={.lock={.raw_lock={.slock=1}}, .task_list={.next=0xffff81012d214718, .prev=0xffff81012d214718}}}, .sk_sleep=0xffff8100b060</font></div><div><font size="2"   >kernel.statement("tcp_v4_connect@net/ipv4/tcp_ipv4.c:174"), 5847, 3, sk=0xffff81012d2146c0 uaddr=0xffff8100a82d1ec8 addr_len=0x10 inet=? tp=? usin=? rt=? daddr=0xffff8101 nexthop=? tmp=0xffffffffffffff9f err=? inet_opt=?, {.__sk_common={.skc_family=2, .skc_state='\a', .skc_reuse='\000', .skc_bound_dev_if=0, .skc_node={.next=0x0, .pprev=0x0}, .skc_bind_node={.next=0x0, .pprev=0x0}, .skc_refcnt={.counter=1}, .skc_hash=0, .skc_prot=0xffffffff80370780}, .sk_shutdown=0, .sk_no_check=0, .sk_userlocks=0, .sk_protocol='\006', .sk_type=1, .sk_rcvbuf=87380, .sk_lock={.slock={.raw_lock={.slock=1}}, .owner=0x1, .wq={.lock={.raw_lock={.slock=1}}, .task_list={.next=0xffff81012d214718, .prev=0xffff81012d214718}}}, .sk_sleep=0xffff8100b060</font></div><div><font size="2"   >kernel.statement("tcp_v4_connect@net/ipv4/tcp_ipv4.c:186"), 5847, 3, sk=0xffff81012d2146c0 uaddr=0xffff8100a82d1ec8 addr_len=? inet=? tp=? usin=? rt=0xffff81012dfaf200 daddr=0x270310ac nexthop=0x270310ac tmp=0x0 err=? inet_opt=?, {.__sk_common={.skc_family=2, .skc_state='\a', .skc_reuse='\000', .skc_bound_dev_if=0, .skc_node={.next=0x0, .pprev=0x0}, .skc_bind_node={.next=0x0, .pprev=0x0}, .skc_refcnt={.counter=1}, .skc_hash=0, .skc_prot=0xffffffff80370780}, .sk_shutdown=0, .sk_no_check=0, .sk_userlocks=0, .sk_protocol='\006', .sk_type=1, .sk_rcvbuf=87380, .sk_lock={.slock={.raw_lock={.slock=1}}, .owner=0x1, .wq={.lock={.raw_lock={.slock=1}}, .task_list={.next=0xffff81012d214718, .prev=0xffff81012d214718}}}, .sk_sleep=0xffff8100b060</font></div><div><font size="2"   >kernel.statement("tcp_v4_connect@net/ipv4/tcp_ipv4.c:192"), 5847, 3, sk=0xffff81012d2146c0 uaddr=0xffff8100a82d1ec8 addr_len=? inet=? tp=? usin=? rt=0xffff81012dfaf200 daddr=0x270310ac nexthop=0x270310ac tmp=0x0 err=? inet_opt=?, {.__sk_common={.skc_family=2, .skc_state='\a', .skc_reuse='\000', .skc_bound_dev_if=0, .skc_node={.next=0x0, .pprev=0x0}, .skc_bind_node={.next=0x0, .pprev=0x0}, .skc_refcnt={.counter=1}, .skc_hash=0, .skc_prot=0xffffffff80370780}, .sk_shutdown=0, .sk_no_check=0, .sk_userlocks=0, .sk_protocol='\006', .sk_type=1, .sk_rcvbuf=87380, .sk_lock={.slock={.raw_lock={.slock=1}}, .owner=0x1, .wq={.lock={.raw_lock={.slock=1}}, .task_list={.next=0xffff81012d214718, .prev=0xffff81012d214718}}}, .sk_sleep=0xffff8100b060</font></div><div><font size="2"   >kernel.statement("tcp_v4_connect@net/ipv4/tcp_ipv4.c:197"), 5847, 3, sk=0xffff81012d2146c0 uaddr=0xffff8100a82d1ec8 addr_len=? inet=? tp=? usin=? rt=0xffff81012dfaf200 daddr=0x270310ac nexthop=0x270310ac tmp=0x0 err=? inet_opt=?, {.__sk_common={.skc_family=2, .skc_state='\a', .skc_reuse='\000', .skc_bound_dev_if=0, .skc_node={.next=0x0, .pprev=0x0}, .skc_bind_node={.next=0x0, .pprev=0x0}, .skc_refcnt={.counter=1}, .skc_hash=0, .skc_prot=0xffffffff80370780}, .sk_shutdown=0, .sk_no_check=0, .sk_userlocks=0, .sk_protocol='\006', .sk_type=1, .sk_rcvbuf=87380, .sk_lock={.slock={.raw_lock={.slock=1}}, .owner=0x1, .wq={.lock={.raw_lock={.slock=1}}, .task_list={.next=0xffff81012d214718, .prev=0xffff81012d214718}}}, .sk_sleep=0xffff8100b060</font></div><div><font size="2"   >kernel.statement("tcp_v4_connect@net/ipv4/tcp_ipv4.c:198"), 5847, 3, sk=0xffff81012d2146c0 uaddr=0xffff8100a82d1ec8 addr_len=? inet=? tp=? usin=? rt=0xffff81012dfaf200 daddr=0x270310ac nexthop=0x270310ac tmp=0x0 err=? inet_opt=?, {.__sk_common={.skc_family=2, .skc_state='\a', .skc_reuse='\000', .skc_bound_dev_if=0, .skc_node={.next=0x0, .pprev=0x0}, .skc_bind_node={.next=0x0, .pprev=0x0}, .skc_refcnt={.counter=1}, .skc_hash=0, .skc_prot=0xffffffff80370780}, .sk_shutdown=0, .sk_no_check=0, .sk_userlocks=0, .sk_protocol='\006', .sk_type=1, .sk_rcvbuf=87380, .sk_lock={.slock={.raw_lock={.slock=1}}, .owner=0x1, .wq={.lock={.raw_lock={.slock=1}}, .task_list={.next=0xffff81012d214718, .prev=0xffff81012d214718}}}, .sk_sleep=0xffff8100b060</font></div><div><font size="2"   >kernel.statement("tcp_v4_connect@net/ipv4/tcp_ipv4.c:200"), 5847, 3, sk=0xffff81012d2146c0 uaddr=0xffff8100a82d1ec8 addr_len=? inet=? tp=? usin=? rt=0xffff81012dfaf200 daddr=0x270310ac nexthop=0x270310ac tmp=0x0 err=? inet_opt=?, {.__sk_common={.skc_family=2, .skc_state='\a', .skc_reuse='\000', .skc_bound_dev_if=0, .skc_node={.next=0x0, .pprev=0x0}, .skc_bind_node={.next=0x0, .pprev=0x0}, .skc_refcnt={.counter=1}, .skc_hash=0, .skc_prot=0xffffffff80370780}, .sk_shutdown=0, .sk_no_check=0, .sk_userlocks=0, .sk_protocol='\006', .sk_type=1, .sk_rcvbuf=87380, .sk_lock={.slock={.raw_lock={.slock=1}}, .owner=0x1, .wq={.lock={.raw_lock={.slock=1}}, .task_list={.next=0xffff81012d214718, .prev=0xffff81012d214718}}}, .sk_sleep=0xffff8100b060</font></div><div><font size="2"   >kernel.statement("tcp_v4_connect@net/ipv4/tcp_ipv4.c:201"), 5847, 3, sk=0xffff81012d2146c0 uaddr=0xffff8100a82d1ec8 addr_len=? inet=? tp=? usin=? rt=0xffff81012dfaf200 daddr=0x270310ac nexthop=0x270310ac tmp=0x0 err=? inet_opt=?, {.__sk_common={.skc_family=2, .skc_state='\a', .skc_reuse='\000', .skc_bound_dev_if=0, .skc_node={.next=0x0, .pprev=0x0}, .skc_bind_node={.next=0x0, .pprev=0x0}, .skc_refcnt={.counter=1}, .skc_hash=0, .skc_prot=0xffffffff80370780}, .sk_shutdown=0, .sk_no_check=0, .sk_userlocks=0, .sk_protocol='\006', .sk_type=1, .sk_rcvbuf=87380, .sk_lock={.slock={.raw_lock={.slock=1}}, .owner=0x1, .wq={.lock={.raw_lock={.slock=1}}, .task_list={.next=0xffff81012d214718, .prev=0xffff81012d214718}}}, .sk_sleep=0xffff8100b060</font></div><div><font size="2"   >kernel.statement("tcp_v4_connect@net/ipv4/tcp_ipv4.c:202"), 5847, 3, sk=0xffff81012d2146c0 uaddr=0xffff8100a82d1ec8 addr_len=? inet=? tp=? usin=? rt=0xffff81012dfaf200 daddr=0x270310ac nexthop=0x270310ac tmp=0x0 err=? inet_opt=?, {.__sk_common={.skc_family=2, .skc_state='\a', .skc_reuse='\000', .skc_bound_dev_if=0, .skc_node={.next=0x0, .pprev=0x0}, .skc_bind_node={.next=0x0, .pprev=0x0}, .skc_refcnt={.counter=1}, .skc_hash=0, .skc_prot=0xffffffff80370780}, .sk_shutdown=0, .sk_no_check=0, .sk_userlocks=0, .sk_protocol='\006', .sk_type=1, .sk_rcvbuf=87380, .sk_lock={.slock={.raw_lock={.slock=1}}, .owner=0x1, .wq={.lock={.raw_lock={.slock=1}}, .task_list={.next=0xffff81012d214718, .prev=0xffff81012d214718}}}, .sk_sleep=0xffff8100b060</font></div><div><font size="2"   >kernel.statement("tcp_v4_connect@net/ipv4/tcp_ipv4.c:211"), 5847, 3, sk=0xffff81012d2146c0 uaddr=0xffff8100a82d1ec8 addr_len=? inet=? tp=? usin=? rt=0xffff81012dfaf200 daddr=0x270310ac nexthop=0x270310ac tmp=0x0 err=? inet_opt=?, {.__sk_common={.skc_family=2, .skc_state='\a', .skc_reuse='\000', .skc_bound_dev_if=0, .skc_node={.next=0x0, .pprev=0x0}, .skc_bind_node={.next=0x0, .pprev=0x0}, .skc_refcnt={.counter=1}, .skc_hash=0, .skc_prot=0xffffffff80370780}, .sk_shutdown=0, .sk_no_check=0, .sk_userlocks=0, .sk_protocol='\006', .sk_type=1, .sk_rcvbuf=87380, .sk_lock={.slock={.raw_lock={.slock=1}}, .owner=0x1, .wq={.lock={.raw_lock={.slock=1}}, .task_list={.next=0xffff81012d214718, .prev=0xffff81012d214718}}}, .sk_sleep=0xffff8100b060</font></div><div><font size="2"   >kernel.statement("tcp_v4_connect@net/ipv4/tcp_ipv4.c:220"), 5847, 3, peer=0x0 sk=0xffff81012d2146c0 uaddr=0xffff8100a82d1ec8 addr_len=? inet=? tp=? usin=? rt=0xffff81012dfaf200 daddr=0x270310ac nexthop=0x270310ac tmp=0xffffffffa82d1bd8 err=? inet_opt=?, {.__sk_common={.skc_family=2, .skc_state='\a', .skc_reuse='\000', .skc_bound_dev_if=0, .skc_node={.next=0x0, .pprev=0x0}, .skc_bind_node={.next=0x0, .pprev=0x0}, .skc_refcnt={.counter=1}, .skc_hash=0, .skc_prot=0xffffffff80370780}, .sk_shutdown=0, .sk_no_check=0, .sk_userlocks=0, .sk_protocol='\006', .sk_type=1, .sk_rcvbuf=87380, .sk_lock={.slock={.raw_lock={.slock=1}}, .owner=0x1, .wq={.lock={.raw_lock={.slock=1}}, .task_list={.next=0xffff81012d214718, .prev=0xffff81012d214718}}}, .sk_sleep=0xffff8100b060</font></div><div><font size="2"   >kernel.statement("tcp_v4_connect@net/ipv4/tcp_ipv4.c:226"), 5847, 3, sk=0xffff81012d2146c0 uaddr=0xffff8100a82d1ec8 addr_len=? inet=? tp=? usin=? rt=0xffff81012dfaf200 daddr=0x270310ac nexthop=0x270310ac tmp=0xffffffffa82d1bd8 err=? inet_opt=?, {.__sk_common={.skc_family=2, .skc_state='\a', .skc_reuse='\000', .skc_bound_dev_if=0, .skc_node={.next=0x0, .pprev=0x0}, .skc_bind_node={.next=0x0, .pprev=0x0}, .skc_refcnt={.counter=1}, .skc_hash=0, .skc_prot=0xffffffff80370780}, .sk_shutdown=0, .sk_no_check=0, .sk_userlocks=0, .sk_protocol='\006', .sk_type=1, .sk_rcvbuf=87380, .sk_lock={.slock={.raw_lock={.slock=1}}, .owner=0x1, .wq={.lock={.raw_lock={.slock=1}}, .task_list={.next=0xffff81012d214718, .prev=0xffff81012d214718}}}, .sk_sleep=0xffff8100b060</font></div><div><font size="2"   >kernel.statement("tcp_v4_connect@net/ipv4/tcp_ipv4.c:229"), 5847, 3, sk=0xffff81012d2146c0 uaddr=0xffff8100a82d1ec8 addr_len=? inet=? tp=? usin=? rt=0xffff81012dfaf200 daddr=0x270310ac nexthop=0x270310ac tmp=0xffffffffa82d1bd8 err=? inet_opt=?, {.__sk_common={.skc_family=2, .skc_state='\a', .skc_reuse='\000', .skc_bound_dev_if=0, .skc_node={.next=0x0, .pprev=0x0}, .skc_bind_node={.next=0x0, .pprev=0x0}, .skc_refcnt={.counter=1}, .skc_hash=0, .skc_prot=0xffffffff80370780}, .sk_shutdown=0, .sk_no_check=0, .sk_userlocks=0, .sk_protocol='\006', .sk_type=1, .sk_rcvbuf=87380, .sk_lock={.slock={.raw_lock={.slock=1}}, .owner=0x1, .wq={.lock={.raw_lock={.slock=1}}, .task_list={.next=0xffff81012d214718, .prev=0xffff81012d214718}}}, .sk_sleep=0xffff8100b060</font></div><div><font size="2"   >kernel.statement("tcp_v4_connect@net/ipv4/tcp_ipv4.c:230"), 5847, 3, sk=0xffff81012d2146c0 uaddr=0xffff8100a82d1ec8 addr_len=? inet=? tp=? usin=? rt=0xffff81012dfaf200 daddr=0x270310ac nexthop=0x270310ac tmp=0xffffffffa82d1bd8 err=? inet_opt=?, {.__sk_common={.skc_family=2, .skc_state='\a', .skc_reuse='\000', .skc_bound_dev_if=0, .skc_node={.next=0x0, .pprev=0x0}, .skc_bind_node={.next=0x0, .pprev=0x0}, .skc_refcnt={.counter=1}, .skc_hash=0, .skc_prot=0xffffffff80370780}, .sk_shutdown=0, .sk_no_check=0, .sk_userlocks=0, .sk_protocol='\006', .sk_type=1, .sk_rcvbuf=87380, .sk_lock={.slock={.raw_lock={.slock=1}}, .owner=0x1, .wq={.lock={.raw_lock={.slock=1}}, .task_list={.next=0xffff81012d214718, .prev=0xffff81012d214718}}}, .sk_sleep=0xffff8100b060</font></div><div><font size="2"   >kernel.statement("tcp_v4_connect@net/ipv4/tcp_ipv4.c:233"), 5847, 3, sk=0xffff81012d2146c0 uaddr=0xffff8100a82d1ec8 addr_len=? inet=? tp=? usin=? rt=0xffff81012dfaf200 daddr=0x270310ac nexthop=0x270310ac tmp=0xffffffffa82d1bd8 err=? inet_opt=?, {.__sk_common={.skc_family=2, .skc_state='\a', .skc_reuse='\000', .skc_bound_dev_if=0, .skc_node={.next=0x0, .pprev=0x0}, .skc_bind_node={.next=0x0, .pprev=0x0}, .skc_refcnt={.counter=1}, .skc_hash=0, .skc_prot=0xffffffff80370780}, .sk_shutdown=0, .sk_no_check=0, .sk_userlocks=0, .sk_protocol='\006', .sk_type=1, .sk_rcvbuf=87380, .sk_lock={.slock={.raw_lock={.slock=1}}, .owner=0x1, .wq={.lock={.raw_lock={.slock=1}}, .task_list={.next=0xffff81012d214718, .prev=0xffff81012d214718}}}, .sk_sleep=0xffff8100b060</font></div><div><font size="2"   >kernel.statement("tcp_v4_connect@net/ipv4/tcp_ipv4.c:245"), 5847, 3, sk=0xffff81012d2146c0 uaddr=0xffff8100a82d1ec8 addr_len=? inet=? tp=? usin=? rt=0xffff81012dfaf200 daddr=0x270310ac nexthop=0x270310ac tmp=? err=0x0 inet_opt=?, {.__sk_common={.skc_family=2, .skc_state='\002', .skc_reuse='\000', .skc_bound_dev_if=0, .skc_node={.next=0x0, .pprev=0xffff81012f0f5c38}, .skc_bind_node={.next=0x0, .pprev=0xffff81012e9843b8}, .skc_refcnt={.counter=1}, .skc_hash=62915, .skc_prot=0xffffffff80370780}, .sk_shutdown=0, .sk_no_check=0, .sk_userlocks=0, .sk_protocol='\006', .sk_type=1, .sk_rcvbuf=87380, .sk_lock={.slock={.raw_lock={.slock=1}}, .owner=0x1, .wq={.lock={.raw_lock={.slock=1}}, .task_list={.next=0xffff81012d214718, .prev=0xffff81012</font></div><div><font size="2"   >kernel.statement("tcp_v4_connect@net/ipv4/tcp_ipv4.c:250"), 5847, 3, sk=0xffff81012d2146c0 uaddr=0xffff8100a82d1ec8 addr_len=? inet=? tp=? usin=? rt=0xffff81012dfaf200 daddr=0x270310ac nexthop=0x270310ac tmp=? err=0x0 inet_opt=?, {.__sk_common={.skc_family=2, .skc_state='\002', .skc_reuse='\000', .skc_bound_dev_if=0, .skc_node={.next=0x0, .pprev=0xffff81012f0f5c38}, .skc_bind_node={.next=0x0, .pprev=0xffff81012e9843b8}, .skc_refcnt={.counter=1}, .skc_hash=62915, .skc_prot=0xffffffff80370780}, .sk_shutdown=0, .sk_no_check=0, .sk_userlocks=0, .sk_protocol='\006', .sk_type=1, .sk_rcvbuf=87380, .sk_lock={.slock={.raw_lock={.slock=1}}, .owner=0x1, .wq={.lock={.raw_lock={.slock=1}}, .task_list={.next=0xffff81012d214718, .prev=0xffff81012</font></div><div><font size="2"   >kernel.statement("tcp_v4_connect@net/ipv4/tcp_ipv4.c:251"), 5847, 3, sk=0xffff81012d2146c0 uaddr=0xffff8100a82d1ec8 addr_len=? inet=? tp=? usin=? rt=0xffff81012dfaf200 daddr=0x270310ac nexthop=0x270310ac tmp=? err=0x0 inet_opt=?, {.__sk_common={.skc_family=2, .skc_state='\002', .skc_reuse='\000', .skc_bound_dev_if=0, .skc_node={.next=0x0, .pprev=0xffff81012f0f5c38}, .skc_bind_node={.next=0x0, .pprev=0xffff81012e9843b8}, .skc_refcnt={.counter=1}, .skc_hash=62915, .skc_prot=0xffffffff80370780}, .sk_shutdown=0, .sk_no_check=0, .sk_userlocks=0, .sk_protocol='\006', .sk_type=1, .sk_rcvbuf=87380, .sk_lock={.slock={.raw_lock={.slock=1}}, .owner=0x1, .wq={.lock={.raw_lock={.slock=1}}, .task_list={.next=0xffff81012d214718, .prev=0xffff81012</font></div><div><font size="2"   >kernel.statement("tcp_v4_connect@net/ipv4/tcp_ipv4.c:253"), 5847, 3, sk=0xffff81012d2146c0 uaddr=0xffff8100a82d1ec8 addr_len=? inet=? tp=? usin=? rt=0xffff81012dfaf200 daddr=0x270310ac nexthop=0x270310ac tmp=? err=? inet_opt=?, {.__sk_common={.skc_family=2, .skc_state='\002', .skc_reuse='\000', .skc_bound_dev_if=0, .skc_node={.next=0x0, .pprev=0xffff81012f0f5c38}, .skc_bind_node={.next=0x0, .pprev=0xffff81012e9843b8}, .skc_refcnt={.counter=1}, .skc_hash=62915, .skc_prot=0xffffffff80370780}, .sk_shutdown=0, .sk_no_check=0, .sk_userlocks=0, .sk_protocol='\006', .sk_type=1, .sk_rcvbuf=87380, .sk_lock={.slock={.raw_lock={.slock=1}}, .owner=0x1, .wq={.lock={.raw_lock={.slock=1}}, .task_list={.next=0xffff81012d214718, .prev=0xffff81012</font></div><div><font size="2"   >kernel.statement("tcp_v4_connect@net/ipv4/tcp_ipv4.c:254"), 5847, 3, sk=0xffff81012d2146c0 uaddr=0xffff8100a82d1ec8 addr_len=? inet=? tp=? usin=? rt=0xffff81012dfaf200 daddr=0x270310ac nexthop=0x270310ac tmp=? err=? inet_opt=?, {.__sk_common={.skc_family=2, .skc_state='\002', .skc_reuse='\000', .skc_bound_dev_if=0, .skc_node={.next=0x0, .pprev=0xffff81012f0f5c38}, .skc_bind_node={.next=0x0, .pprev=0xffff81012e9843b8}, .skc_refcnt={.counter=1}, .skc_hash=62915, .skc_prot=0xffffffff80370780}, .sk_shutdown=0, .sk_no_check=0, .sk_userlocks=0, .sk_protocol='\006', .sk_type=1, .sk_rcvbuf=87380, .sk_lock={.slock={.raw_lock={.slock=1}}, .owner=0x1, .wq={.lock={.raw_lock={.slock=1}}, .task_list={.next=0xffff81012d214718, .prev=0xffff81012</font></div><div><font size="2"   >kernel.statement("tcp_v4_connect@net/ipv4/tcp_ipv4.c:264"), 5847, 3, sk=0xffff81012d2146c0 uaddr=0xffff8100a82d1ec8 addr_len=? inet=? tp=? usin=? rt=0xffff81012dfaf200 daddr=0x270310ac nexthop=0x270310ac tmp=? err=? inet_opt=?, {.__sk_common={.skc_family=2, .skc_state='\002', .skc_reuse='\000', .skc_bound_dev_if=0, .skc_node={.next=0x0, .pprev=0xffff81012f0f5c38}, .skc_bind_node={.next=0x0, .pprev=0xffff81012e9843b8}, .skc_refcnt={.counter=2}, .skc_hash=62915, .skc_prot=0xffffffff80370780}, .sk_shutdown=0, .sk_no_check=0, .sk_userlocks=0, .sk_protocol='\006', .sk_type=1, .sk_rcvbuf=87380, .sk_lock={.slock={.raw_lock={.slock=1}}, .owner=0x1, .wq={.lock={.raw_lock={.slock=1}}, .task_list={.next=0xffff81012d214718, .prev=0xffff81012</font></div><div><font size="2"   >kernel.statement("tcp_v4_connect@net/ipv4/tcp_ipv4.c:262"), 5847, 3, sk=0xffff81012d2146c0 uaddr=0xffff8100a82d1ec8 addr_len=? inet=? tp=? usin=? rt=0xffff81012dfaf200 daddr=0x270310ac nexthop=0x270310ac tmp=0x0 err=0x0 inet_opt=?, {.__sk_common={.skc_family=2, .skc_state='\002', .skc_reuse='\000', .skc_bound_dev_if=0, .skc_node={.next=0x0, .pprev=0xffff81012f0f5c38}, .skc_bind_node={.next=0x0, .pprev=0xffff81012e9843b8}, .skc_refcnt={.counter=2}, .skc_hash=62915, .skc_prot=0xffffffff80370780}, .sk_shutdown=0, .sk_no_check=0, .sk_userlocks=0, .sk_protocol='\006', .sk_type=1, .sk_rcvbuf=87380, .sk_lock={.slock={.raw_lock={.slock=1}}, .owner=0x1, .wq={.lock={.raw_lock={.slock=1}}, .task_list={.next=0xffff81012d214718, .prev=0xffff81012</font></div><p></p></pre></div><div>其他例子 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   ># Refers to the statement at line 296 within the</font></div><div><font size="2"   ># kernel/time.c file:</font></div><div><font size="2"   >kernel.statement("*@kernel/time.c:296")</font></div><div><font size="2"   ># Refers to the statement at line bio_init+3 within the fs/bio.c file:</font></div><div><font size="2"   >kernel.statement("bio_init@fs/bio.c+3")</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   ># Refers to all kernel functions with "init" or "exit"</font></div><div><font size="2"   ># in the name:</font></div><div><font size="2"   >kernel.function("*init*"), kernel.function("*exit*")</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   ># Refers to any functions within the "kernel/time.c"</font></div><div><font size="2"   ># file that span line 240:</font></div><div><font size="2"   >kernel.function("*@kernel/time.c:240")</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># Refers to all functions in the ext3 module:</font></div><div><font size="2"   >module("ext3").function("*")</font></div></div><p></p></pre></div><div><br></div><div>下面讲解一下变量 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >Some of the source-level variables, such as function parameters, locals, or globals visible in the compilation unit, are visible to probe handlers. Refer to these variables by prefixing their name with a dollar sign within the scripts. In addition, a special syntax allows limited traversal of structures, pointers, arrays, taking the address of a variable or pretty printing a whole structure.</font></div><div><font size="2"   >handler中可以看到的源码级的变量一般包含函数参数, 函数内的本地变量, 以及CU(</font><span style="line-height: 21px; font-size: small; font-family: Arial, Helvetica, sans-serif;"   >编译单元</span><span style="line-height: 21px; font-size: small; font-family: Arial, Helvetica, sans-serif;"   >指一个C文件,)可见的全局变量.</span></div><div><font size="2"   >$var refers to an in-scope variable var. If it is a type similar to an integer, it will be cast to a 64-bit integer for script use. Pointers similar to a string (char *) are copied to SystemTap string values by the kernel_string() or user_string() functions.</font></div><div><font size="2"   ><span style="line-height: 23px;"   >使用$varname或者</span><span style="line-height: 23px;"   >@var("varname")</span><span style="line-height: 23px;"   >表示本地变量和参数变量. 数字直接打印, 字符串可使用kernel_string()或者user_string()函数打印.</span></font></div><div><font size="2"   >@var("varname") is an alternative syntax for $varname. It can also be used to access global variables in a particular compile unit (CU). @var("varname@src/file.c") refers to the global (either file local or external) variable varname defined when the file src/file.c was compiled. The CU in which the variable is resolved is the first CU in the module of the probe point which matches the given file name at the end and has the shortest file name path (e.g. given @var("foo@bar/baz.c") and CUs with file name paths src/sub/module/bar/baz.c and src/bar/baz.c the second CU will be chosen to resolve foo).</font></div><div><font size="2"   >对于全局变量, 必须使用另一种表示方式<span style="line-height: 23px;"   >@var("varname@src/file.c"). 对于有多个文件路径的情况, 匹配短路径.</span></font></div><div><font size="2"   ><span style="line-height: 23px;"   >例如&nbsp;</span><span style="line-height: 23px;"   >given @var("foo@bar/baz.c") and CUs with file name paths src/sub/module/bar/baz.c and src/bar/baz.c the second CU will be chosen to resolve foo</span></font></div><div><font size="2"   >$var-&gt;field or @var("var@file.c")-&gt;field traverses a structure's field. The indirection operator may be repeated to follow additional levels of pointers.</font></div><div><font size="2"   >-&gt;符号表示结构中的field, 注意不能使用点(.), 因为(.)在systemtap中是字符串连接符号 , 类似SQL中的||连接符 .</font></div><div><font size="2"   >所以在stap中统一使用-&gt;.</font></div><div><font size="2"   >例如<span style="line-height: 23px;"   >$var-&gt;field or @var("var@file.c")-&gt;field</span></font></div><div><font size="2"   >$var[N] or @var("var@file.c")[N] indexes into an array. The index is given with a literal number.</font></div><div><font size="2"   >数组则这么表示&nbsp;<span style="line-height: 23px;"   >$var[N] or @var("var@file.c")[N]</span><span style="line-height: 23px;"   >&nbsp;</span></font></div><div><font size="2"   >&amp;$var or &amp;@var("var@file.c") provides the address of a variable as a long. It can also be used in combination with field access or array indexing to provide the address of a particular field or an element in an array with &amp;var-&gt;field, &amp;@var("var@file.c")[N] or a combination of those accessors.</font></div><div><font size="2"   >取地址和c一样用&amp;, 例如<span style="line-height: 23px;"   >&amp;$var or &amp;@var("var@file.c") provides the address of a variable as a long. 取结构或数组中元素的地址如</span><span style="line-height: 23px;"   >&amp;var-&gt;field, &amp;@var("var@file.c")[N].</span></font></div><div><font size="2"   >Using a single $ or a double $$ suffix provides a swallow or deep string representation of the variable data type. Using a single $, as in $var$, will provide a string that only includes the values of all basic type values of fields of the variable structure type but not any nested complex type values (which will be represented with {...}). Using a double $$, as in @var("var")$$ will provide a string that also includes all values of nested data types.</font></div><div><font size="2"   >在结构变量末尾加$表示输出结构体内所有field的值, 如果加2个$, $$表示输出<span style="line-height: 23px;"   >结构体内所有field的值以及同样是结构体的field也继续输出, 一直到所有的基本类型都输出为止. 例如</span><span style="line-height: 23px;"   >$var$,&nbsp;</span><span style="line-height: 23px;"   >@var("var")$$</span></font></div><div><font size="2"   >$$vars expands to a character string that is equivalent to sprintf("parm1=%x ... parmN=%x var1=%x ... varN=%x", $parm1, ..., $parmN, $var1, ..., $varN)</font></div><div><font size="2"   >$$vars 将输出所有的本地变量和参数变量名称以及它的值.</font></div><div><font size="2"   >$$locals expands to a character string that is equivalent to sprintf("var1=%x ... varN=%x", $var1, ..., $varN)</font></div><div><font size="2"   ><span style="line-height: 23px;"   >$$locals&nbsp;</span><span style="line-height: 23px;"   >将输出所有的本地变量名称以及它的值.</span></font></div><div><font size="2"   >$$parms expands to a character string that is equivalent to sprintf("parm1=%x ... parmN=%x", $parm1, ..., $parmN)</font></div></div><div><font size="2"   ><span style="line-height: 23px;"   >$$parms</span><span style="line-height: 23px;"   >&nbsp;</span><span style="line-height: 23px;"   >将输出所有的参数变量名称以及它的值.</span></font></div><p></p></pre></div><div><br></div><div><span style="line-height: 23px;"   >[参考]</span></div><wbr><div>1.&nbsp;<a style="line-height: 23px;" rel="nofollow" href="https://sourceware.org/systemtap/langref/Probe_points.html"   >https://sourceware.org/systemtap/langref/Probe_points.html</a></div><div>2.&nbsp;<a style="line-height: 23px;" rel="nofollow" href="https://sourceware.org/systemtap/tapsets/"   >https://sourceware.org/systemtap/tapsets/</a></div><div>3.&nbsp;/usr/src/debug/kernel-2.6.18/linux-2.6.18-348.12.1.el5.x86_64/net/ipv4/tcp_ipv4.c</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >&nbsp; &nbsp;156 &nbsp;/* This will initiate an outgoing connection. */</font></div><div><font size="2"   >&nbsp; &nbsp;157 &nbsp;int tcp_v4_connect(struct sock *sk, struct sockaddr *uaddr, int addr_len)</font></div><div><font size="2"   >&nbsp; &nbsp;158 &nbsp;{</font></div><div><font size="2"   >&nbsp; &nbsp;159 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;struct inet_sock *inet = inet_sk(sk);</font></div><div><font size="2"   >&nbsp; &nbsp;160 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;struct tcp_sock *tp = tcp_sk(sk);</font></div><div><font size="2"   >&nbsp; &nbsp;161 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;struct sockaddr_in *usin = (struct sockaddr_in *)uaddr;</font></div><div><font size="2"   >&nbsp; &nbsp;162 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;struct rtable *rt;</font></div><div><font size="2"   >&nbsp; &nbsp;163 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;u32 daddr, nexthop;</font></div><div><font size="2"   >&nbsp; &nbsp;164 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;int tmp;</font></div><div><font size="2"   >&nbsp; &nbsp;165 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;int err;</font></div><div><font size="2"   >&nbsp; &nbsp;166 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;struct ip_options *inet_opt;</font></div><div><font size="2"   >&nbsp; &nbsp;167 &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;168 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (addr_len &lt; sizeof(struct sockaddr_in))</font></div><div><font size="2"   >&nbsp; &nbsp;169 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return -EINVAL;</font></div><div><font size="2"   >&nbsp; &nbsp;170 &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;171 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (usin-&gt;sin_family != AF_INET)</font></div><div><font size="2"   >&nbsp; &nbsp;172 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return -EAFNOSUPPORT;</font></div><div><font size="2"   >&nbsp; &nbsp;173 &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;174 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nexthop = daddr = usin-&gt;sin_addr.s_addr;</font></div><div><font size="2"   >&nbsp; &nbsp;175 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;inet_opt = rcu_dereference(inet-&gt;opt);</font></div><div><font size="2"   >&nbsp; &nbsp;176 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (inet_opt &amp;&amp; inet_opt-&gt;srr) {</font></div><div><font size="2"   >&nbsp; &nbsp;177 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (!daddr)</font></div><div><font size="2"   >&nbsp; &nbsp;178 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return -EINVAL;</font></div><div><font size="2"   >&nbsp; &nbsp;179 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;nexthop = inet_opt-&gt;faddr;</font></div><div><font size="2"   >&nbsp; &nbsp;180 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</font></div><div><font size="2"   >&nbsp; &nbsp;181 &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;182 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tmp = ip_route_connect(&amp;rt, nexthop, inet-&gt;saddr,</font></div><div><font size="2"   >&nbsp; &nbsp;183 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RT_CONN_FLAGS(sk), sk-&gt;sk_bound_dev_if,</font></div><div><font size="2"   >&nbsp; &nbsp;184 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; IPPROTO_TCP,</font></div><div><font size="2"   >&nbsp; &nbsp;185 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet-&gt;sport, usin-&gt;sin_port, sk, 1);</font></div><div><font size="2"   >&nbsp; &nbsp;186 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (tmp &lt; 0) {</font></div><div><font size="2"   >&nbsp; &nbsp;187 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (tmp == -ENETUNREACH)</font></div><div><font size="2"   >&nbsp; &nbsp;188 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;IP_INC_STATS_BH(IPSTATS_MIB_OUTNOROUTES);</font></div><div><font size="2"   >&nbsp; &nbsp;189 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return tmp;</font></div><div><font size="2"   >&nbsp; &nbsp;190 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</font></div><div><font size="2"   >&nbsp; &nbsp;191 &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;192 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (rt-&gt;rt_flags &amp; (RTCF_MULTICAST | RTCF_BROADCAST)) {</font></div></div><div><div><font size="2"   >&nbsp; &nbsp;193 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ip_rt_put(rt);</font></div><div><font size="2"   >&nbsp; &nbsp;194 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return -ENETUNREACH;</font></div><div><font size="2"   >&nbsp; &nbsp;195 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</font></div><div><font size="2"   >&nbsp; &nbsp;196 &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;197 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (!inet_opt || !inet_opt-&gt;srr)</font></div><div><font size="2"   >&nbsp; &nbsp;198 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;daddr = rt-&gt;rt_dst;</font></div><div><font size="2"   >&nbsp; &nbsp;199 &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;200 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (!inet-&gt;saddr)</font></div><div><font size="2"   >&nbsp; &nbsp;201 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;inet-&gt;saddr = rt-&gt;rt_src;</font></div><div><font size="2"   >&nbsp; &nbsp;202 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;inet-&gt;rcv_saddr = inet-&gt;saddr;</font></div><div><font size="2"   >&nbsp; &nbsp;203 &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;204 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (tp-&gt;rx_opt.ts_recent_stamp &amp;&amp; inet-&gt;daddr != daddr) {</font></div><div><font size="2"   >&nbsp; &nbsp;205 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* Reset inherited state */</font></div><div><font size="2"   >&nbsp; &nbsp;206 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tp-&gt;rx_opt.ts_recent &nbsp; &nbsp; &nbsp; = 0;</font></div><div><font size="2"   >&nbsp; &nbsp;207 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tp-&gt;rx_opt.ts_recent_stamp = 0;</font></div><div><font size="2"   >&nbsp; &nbsp;208 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tp-&gt;write_seq &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;= 0;</font></div><div><font size="2"   >&nbsp; &nbsp;209 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</font></div><div><font size="2"   >&nbsp; &nbsp;210 &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;211 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (tcp_death_row.sysctl_tw_recycle &amp;&amp;</font></div><div><font size="2"   >&nbsp; &nbsp;212 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;!tp-&gt;rx_opt.ts_recent_stamp &amp;&amp; rt-&gt;rt_dst == daddr) {</font></div><div><font size="2"   >&nbsp; &nbsp;213 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;struct inet_peer *peer = rt_get_peer(rt);</font></div><div><font size="2"   >&nbsp; &nbsp;214 &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;215 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* VJ's idea. We save last timestamp seen from</font></div><div><font size="2"   >&nbsp; &nbsp;216 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * the destination in peer table, when entering state TIME-WAIT</font></div><div><font size="2"   >&nbsp; &nbsp;217 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * and initialize rx_opt.ts_recent from it, when trying new connection.</font></div><div><font size="2"   >&nbsp; &nbsp;218 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */</font></div><div><font size="2"   >&nbsp; &nbsp;219 &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;220 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (peer &amp;&amp; peer-&gt;tcp_ts_stamp + TCP_PAWS_MSL &gt;= xtime.tv_sec) {</font></div><div><font size="2"   >&nbsp; &nbsp;221 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tp-&gt;rx_opt.ts_recent_stamp = peer-&gt;tcp_ts_stamp;</font></div><div><font size="2"   >&nbsp; &nbsp;222 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tp-&gt;rx_opt.ts_recent = peer-&gt;tcp_ts;</font></div><div><font size="2"   >&nbsp; &nbsp;223 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</font></div><div><font size="2"   >&nbsp; &nbsp;224 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</font></div><div><font size="2"   >&nbsp; &nbsp;225 &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;226 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;inet-&gt;dport = usin-&gt;sin_port;</font></div><div><font size="2"   >&nbsp; &nbsp;227 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;inet-&gt;daddr = daddr;</font></div><div><font size="2"   >&nbsp; &nbsp;228 &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;229 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;inet_csk(sk)-&gt;icsk_ext_hdr_len = 0;</font></div></div><div><div><font size="2"   >&nbsp; &nbsp;230 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (inet_opt)</font></div><div><font size="2"   >&nbsp; &nbsp;231 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;inet_csk(sk)-&gt;icsk_ext_hdr_len = inet_opt-&gt;optlen;</font></div><div><font size="2"   >&nbsp; &nbsp;232 &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;233 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tp-&gt;rx_opt.mss_clamp = 536;</font></div><div><font size="2"   >&nbsp; &nbsp;234 &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;235 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* Socket identity is still unknown (sport may be zero).</font></div><div><font size="2"   >&nbsp; &nbsp;236 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * However we set state to SYN-SENT and not releasing socket</font></div><div><font size="2"   >&nbsp; &nbsp;237 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * lock select source port, enter ourselves into the hash tables and</font></div><div><font size="2"   >&nbsp; &nbsp;238 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; * complete initialization after this.</font></div><div><font size="2"   >&nbsp; &nbsp;239 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; */</font></div><div><font size="2"   >&nbsp; &nbsp;240 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tcp_set_state(sk, TCP_SYN_SENT);</font></div><div><font size="2"   >&nbsp; &nbsp;241 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;err = inet_hash_connect(&amp;tcp_death_row, sk);</font></div><div><font size="2"   >&nbsp; &nbsp;242 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (err)</font></div><div><font size="2"   >&nbsp; &nbsp;243 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;goto failure;</font></div><div><font size="2"   >&nbsp; &nbsp;244 &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;245 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;err = ip_route_newports(&amp;rt, IPPROTO_TCP, inet-&gt;sport, inet-&gt;dport, sk);</font></div><div><font size="2"   >&nbsp; &nbsp;246 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (err)</font></div><div><font size="2"   >&nbsp; &nbsp;247 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;goto failure;</font></div><div><font size="2"   >&nbsp; &nbsp;248 &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;249 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* OK, now commit destination to socket. &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp;250 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sk-&gt;sk_gso_type = SKB_GSO_TCPV4;</font></div><div><font size="2"   >&nbsp; &nbsp;251 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sk_setup_caps(sk, &amp;rt-&gt;u.dst);</font></div><div><font size="2"   >&nbsp; &nbsp;252 &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;253 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (!tp-&gt;write_seq)</font></div><div><font size="2"   >&nbsp; &nbsp;254 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tp-&gt;write_seq = secure_tcp_sequence_number(inet-&gt;saddr,</font></div><div><font size="2"   >&nbsp; &nbsp;255 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet-&gt;daddr,</font></div><div><font size="2"   >&nbsp; &nbsp;256 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; inet-&gt;sport,</font></div><div><font size="2"   >&nbsp; &nbsp;257 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; usin-&gt;sin_port);</font></div><div><font size="2"   >&nbsp; &nbsp;258 &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;259 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;inet-&gt;id = tp-&gt;write_seq ^ jiffies;</font></div><div><font size="2"   >&nbsp; &nbsp;260 &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;261 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;err = tcp_connect(sk);</font></div><div><font size="2"   >&nbsp; &nbsp;262 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;rt = NULL;</font></div><div><font size="2"   >&nbsp; &nbsp;263 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (err)</font></div><div><font size="2"   >&nbsp; &nbsp;264 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;goto failure;</font></div><div><font size="2"   >&nbsp; &nbsp;265 &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;266 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return 0;</font></div></div><div><div><font size="2"   >&nbsp; &nbsp;267 &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp;268 &nbsp;failure:</font></div><div><font size="2"   >&nbsp; &nbsp;269 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* This unhashes the socket and releases the local port, if necessary. */</font></div><div><font size="2"   >&nbsp; &nbsp;270 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tcp_set_state(sk, TCP_CLOSE);</font></div><div><font size="2"   >&nbsp; &nbsp;271 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ip_rt_put(rt);</font></div><div><font size="2"   >&nbsp; &nbsp;272 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;sk-&gt;sk_route_caps = 0;</font></div><div><font size="2"   >&nbsp; &nbsp;273 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;inet-&gt;dport = 0;</font></div><div><font size="2"   >&nbsp; &nbsp;274 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return err;</font></div><div><font size="2"   >&nbsp; &nbsp;275 &nbsp;}</font></div></div><p></p></pre></div></div>
	</div>
</div>
</body>
</html>