<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">systemtap optimized for variables</h2>
	<h5 id="">2013-09-10 10:10:25&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020138109459201/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>在systemtap language reference中的一段话</div><div><pre class="prettyprint"   ><p><font size="2"   >Note that all variable types are inferred, and that all locals and globals are initialized. Integers are set to 0 and strings are set to the empty string.</font></p></pre></div><div>所有的变量在脚本解析时都会被自动推断<span style="line-height: 22px;"   >类型</span><span style="line-height: 22px;"   >, 所有的本地变量和全局变量都会被初始化, 例如整型初始化的值为0, 字符串为空字符串.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Global variables which are written but never read will be displayed automatically at session shutdown.</font></div><div><font size="2"   >Unused variables : </font></div><div><font size="2"   >The SystemTap translator removes unused variables. Global variable that are never written or read are discarded. Every local variables where the variable is only written but never read are also discarded. This optimization prunes unused variables defined in the probe aliases, but never used in the probe handler. If desired, this optimization can disabled with the -u option.</font></div><p></p></pre></div><div>全局变量, 如果只有写入, 没有读取操作, 那么在脚本结束时会自动显示它的值.</div><div><span style="line-height: 22px;"   >另外, 在优化模式下. 对于未使用的变量, 默认会在解析时删掉. (全局变量没有读和写的操作将丢弃, 本地变量只有写但是没有读的操作也被丢弃)</span></div><div>在probe alias中定义的变量如果在probe handler中未被使用的话也会丢弃掉.</div><div>这些优化手段可以通过stap 的-u参数关闭.</div><div><span style="line-height: 22px;"   ><br></span></div><div>例子 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# cat test.stp</font></div><div><font size="2"   >global ga, gb</font></div><div><font size="2"   >global gc</font></div><div><font size="2"   >probe begin {</font></div><div><font size="2"   >// &nbsp;a++</font></div><div><font size="2"   >&nbsp; printf("a: %d, b: %s\n", a, b)</font></div><div><font size="2"   >&nbsp; printf("ga: %d, gb: %s\n", ga, gb)</font></div><div><font size="2"   >&nbsp; exit()</font></div><div><font size="2"   >}</font></div><div><font size="2"   >执行 :&nbsp;</font></div><div><font size="2"   >[root@db-172-16-3-39 ~]# stap --vp 01 test.stp&nbsp;</font></div><div><font size="2"   >警告, 因为变量未指派任何值, 直接以指定类型输出.</font></div><div><font size="2"   >WARNING: never-assigned local variable 'a' (alternatives: b ga gb gc): identifier 'a' at test.stp:5:28</font></div><div><font size="2"   >&nbsp;source: &nbsp; printf("a: %d, b: %s\n", a, b)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^</font></div><div><font size="2"   >WARNING: never-assigned local variable 'b' (alternatives: a ga gb gc): identifier 'b' at :5:31</font></div><div><font size="2"   >&nbsp;source: &nbsp; printf("a: %d, b: %s\n", a, b)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"   >WARNING: never assigned global variable 'ga' (alternatives: gb gc): identifier 'ga' at :1:8</font></div><div><font size="2"   >&nbsp;source: global ga, gb</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^</font></div><div><font size="2"   >WARNING: never assigned global variable 'gb' (alternatives: ga gc): identifier 'gb' at :1:12</font></div><div><font size="2"   >&nbsp;source: global ga, gb</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^</font></div><div><font size="2"   >gc未在脚本中任何地方使用, 所以自动删除.</font></div><div><font size="2"   >WARNING: Eliding unused variable 'gc': identifier 'gc' at :2:8</font></div><div><font size="2"   >&nbsp;source: global gc</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^</font></div><div><font size="2"   >Pass 2: analyzed script: 1 probe(s), 1 function(s), 0 embed(s), 2 global(s) using 147328virt/24440res/3252shr/21924data kb, in 0usr/0sys/6real ms.</font></div><div><font size="2"   >a: 0, b:&nbsp;</font></div><div><font size="2"   >ga: 0, gb:&nbsp;</font></div><p></p></pre></div></div><div>如果加上-u参数的话(关闭优化模式), 如果包含未被任何地方使用的变量, 执行时将报错.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap --vp 01 -u test.stp&nbsp;</font></div><div><font size="2"   >semantic error: unresolved type : identifier 'gc' at test.stp:2:8</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; source: global gc</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"   >Pass 2: analyzed script: 1 probe(s), 7 function(s), 0 embed(s), 3 global(s) using 147892virt/24404res/3208shr/22488data kb, in 10usr/0sys/6real ms.</font></div><div><font size="2"   >Pass 2: analysis failed. &nbsp;Try again with another '--vp 01' option.</font></div><p></p></pre></div><div><br></div><div>只有写, 但是没有读的全局变量, 在会话结束时自动显示.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# cat test.stp&nbsp;</font></div><div><font size="2"   >global gc</font></div><div><font size="2"   >probe begin {</font></div><div><font size="2"   >&nbsp; gc++</font></div><div><font size="2"   >&nbsp; exit()</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div>全局变量gc没有读取操作, 所以在结束时自动打印.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap --vp 01 test.stp&nbsp;</font></div><div><font size="2"   >Pass 2: analyzed script: 2 probe(s), 1 function(s), 0 embed(s), 1 global(s) using 147316virt/24420res/3244shr/21912data kb, in 10usr/0sys/6real ms.</font></div><div><font size="2"   >gc=0x1</font></div><p></p></pre></div><div><br></div><div>既没有读也没有写的全局变量将丢弃.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# cat test.stp</font></div><div><font size="2"   >global gc</font></div><div><font size="2"   >probe begin {</font></div><div><font size="2"   >&nbsp; exit()</font></div><div><font size="2"   >}</font></div><div><font size="2"   >[root@db-172-16-3-39 ~]# stap --vp 1 test.stp</font></div><div><font size="2"   >Pass 1: parsed user script and 85 library script(s) using 146792virt/23684res/2996shr/21388data kb, in 170usr/10sys/172real ms.</font></div><div><font size="2"   >WARNING: Eliding unused variable 'gc': identifier 'gc' at test.stp:1:8</font></div><div><font size="2"   >&nbsp;source: global gc</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^</font></div><p></p></pre></div><div><br></div><div>只有写, 但是没有读的本地变量, 在优化模式下自动丢弃.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# cat test.stp</font></div><div><font size="2"   >probe begin {</font></div><div><font size="2"   >&nbsp; c++</font></div><div><font size="2"   >&nbsp; exit()</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div>这里的本地变量c将丢弃.</div><div><br></div><div>在probe alias这种定义的本地变量, 在probe handler中如果未被使用, 也会被丢弃.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# cat test.stp</font></div><div><font size="2"   >probe e1=begin {</font></div><div><font size="2"   >&nbsp; va++</font></div><div><font size="2"   >}</font></div><div><font size="2"   >probe e1 {</font></div><div><font size="2"   >&nbsp; exit()</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="https://sourceware.org/systemtap/langref/SystemTap_overview.html"   >https://sourceware.org/systemtap/langref/SystemTap_overview.html</a></div><div>2. man stap</div><div>-u &nbsp; &nbsp; Unoptimized mode. &nbsp;Disable unused code elision during elaboration.</div><div>3.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="https://sourceware.org/systemtap/langref/Components_SystemTap_script.html#SECTION00043100000000000000"   >https://sourceware.org/systemtap/langref/Components_SystemTap_script.html#SECTION00043100000000000000</a></div></div>
	</div>
</div>
</body>
</html>