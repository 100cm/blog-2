<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">systemtap local & global variables</h2>
	<h5 id="">2013-09-12 15:32:02&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201381231824237/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>前几天写过一篇blog, 关于systemtap优化模式下, 对有写, 没读, 或者没写没读的全局变量和本地变量做消除处理.</div><div>本文将讲一讲本地变量和全局变量的使用.</div><div>首先是变量的命名规范.</div><div>变量名可以包含数字,字母_,$符号. 但是必须以字母或_开头, 区分大小写.</div><div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >Identifiers for variables and functions are alphanumeric sequences, and may include the underscore (_) and the dollar sign ($) characters. They may not start with a plain digit. Each variable is by default local to the probe or function statement block where it is mentioned, and therefore its scope and lifetime is limited to a particular probe or function invocation. Scalar variables are implicitly typed as either string or integer. Associative arrays also have a string or integer value, and a tuple of strings or integers serves as a key. Arrays must be declared as global. Local arrays are not allowed.</font></div><div><font size="2"   >The translator performs type inference on all identifiers, including array indexes and function parameters. Inconsistent type-related use of identifiers results in an error.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Variables may be declared global. Global variables are shared among all probes and remain instantiated as long as the SystemTap session. There is one namespace for all global variables, regardless of the script file in which they are found. Because of possible concurrency limits, such as multiple probe handlers, each global variable used by a probe is automatically read- or write-locked while the handler is running. A global declaration may be written at the outermost level anywhere in a script file, not just within a block of code. Global variables which are written but never read will be displayed automatically at session shutdown. The following declaration marks var1 and var2 as global. The translator will infer a value type for each, and if the variable is used as an array, its key types.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >global var1[=&lt;value&gt;], var2[=&lt;value&gt;]</font></div></div><div></div><p></p></pre></div></div><div>$开头的变量为target variable, 或者context变量. 参考 :&nbsp;</div><div><a href="http://blog.163.com/digoal@126/blog/static/16387704020138113455697/"   >http://blog.163.com/digoal@126/blog/static/16387704020138113455697/</a></div><div>所以不适合用做本地变量或者全局变量名.&nbsp;<span style="line-height: 22px;"   >来看个例子 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# cat test.stp&nbsp;</font></div><div><font size="2"   >probe begin {</font></div><div><font size="2"   >&nbsp; $abc=222</font></div><div><font size="2"   >&nbsp; printf("%d\n", $abc)</font></div><div><font size="2"   >&nbsp; exit()</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-39 ~]# stap --vp 5 test.stp&nbsp;</font></div><div><font size="2"   >Parsed kernel "/lib/modules/2.6.18-348.12.1.el5/build/.config", containing 1977 tuples</font></div><div><font size="2"   >Parsed kernel /lib/modules/2.6.18-348.12.1.el5/build/Module.symvers, which contained 3546 vmlinux exports</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 4, processed: 4</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/*.stp ", found: 81, processed: 81</font></div><div><font size="2"   >Pass 1: parsed user script and 85 library script(s) using 146804virt/23708res/3008shr/21400data kb, in 160usr/10sys/173real ms.</font></div><div><font size="2"   >semantic error: unresolved target-symbol expression: identifier '$abc' at test.stp:2:3</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; source: &nbsp; $abc=222</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >semantic error: unresolved target-symbol expression: identifier '$abc' at :3:18</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; source: &nbsp; printf("%d\n", $abc)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"   >Pass 2: analysis failed. &nbsp;Try again with another '--vp 01' option.</font></div><p></p></pre></div><div>本地变量不需要加锁, 如果是多核CPU的情况下, 事件并发触发的话, 每个核管自己的本地变量, 互不干涉.</div><div><br></div><div>接下来要说的是全局变量, 全局变量写的时候是要加锁的, 所以有加锁超时的说法, 参见 :&nbsp;</div><div>systemtap SAFETY AND SECURITY</div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201381021752228/"   >http://blog.163.com/digoal@126/blog/static/163877040201381021752228/</a></div><div>同时全局变量的作用范围, 不仅仅局限在本地脚本, 而是整个stap的检索范围中.</div><div>例如 :&nbsp;</div><div>在/tmp/p.stp中定义一个全局变量</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# cat /tmp/p.stp&nbsp;</font></div><div><font size="2"   >global a="abc"</font></div><p></p></pre></div><div>在test.stp中调用这个全局变量.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# cat test.stp</font></div><div><font size="2"   >probe begin {</font></div><div><font size="2"   >&nbsp; _a$$vars=123</font></div><div><font size="2"   >&nbsp; B=123</font></div><div><font size="2"   >&nbsp; printf("%s, %d, %d, %d\n", a, _a$$vars, B, b)</font></div><div><font size="2"   >&nbsp; exit()</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div>使用-I 加载自定义脚本库. 我们看到在tmp/p.stp中定义的a这个全局变量被打印出来了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-39 ~]# stap -I /tmp --vp 5 test.stp&nbsp;</font></div><div><font size="2"   >Parsed kernel "/lib/modules/2.6.18-348.12.1.el5/build/.config", containing 1977 tuples</font></div><div><font size="2"   >Parsed kernel /lib/modules/2.6.18-348.12.1.el5/build/Module.symvers, which contained 3546 vmlinux exports</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/x86_64/*.stp ", found: 4, processed: 4</font></div><div><font size="2"   >Searched: " /usr/share/systemtap/tapset/*.stp ", found: 81, processed: 81</font></div><div><font size="2"   >Searched: " /tmp/*.stp ", found: 2, processed: 2</font></div><div><font size="2"   >Pass 1: parsed user script and 87 library script(s) using 146920virt/23716res/3012shr/21516data kb, in 160usr/20sys/173real ms.</font></div><div><font size="2"   >WARNING: never-assigned local variable 'b' (alternatives: _a$$vars B a): identifier 'b' at test.stp:4:46</font></div><div><font size="2"   >&nbsp;source: &nbsp; printf("%s, %d, %d, %d\n", a, _a$$vars, B, b)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^</font></div><div><font size="2"   >abc, 123, 123, 0</font></div><p></p></pre></div></div><div><br></div><div>最后, 数组必须定义为全局变量.</div><div><br></div>[参考]<wbr><div>1.&nbsp;systemtap optimized for variables</div><div><a href="http://blog.163.com/digoal@126/blog/static/16387704020138109459201/"   >http://blog.163.com/digoal@126/blog/static/16387704020138109459201/</a></div><div>2.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="https://sourceware.org/systemtap/langref/Components_SystemTap_script.html"   >https://sourceware.org/systemtap/langref/Components_SystemTap_script.html</a></div><div>3.&nbsp;systemtap probe point's "context variables" or "target variables"</div><div><a href="http://blog.163.com/digoal@126/blog/static/16387704020138113455697/"   >http://blog.163.com/digoal@126/blog/static/16387704020138113455697/</a></div><div>4.&nbsp;<span style="line-height: 22px;"   >systemtap SAFETY AND SECURITY</span></div><div style="line-height: 22px;"   ><a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201381021752228/"   >http://blog.163.com/digoal@126/blog/static/163877040201381021752228/</a></div></div>
	</div>
</div>
</body>
</html>