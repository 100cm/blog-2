<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL performance affected by NUMA - 1</h2>
	<h5 id="">2012-06-07 13:32:49&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402012571831555/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">以前写过几篇关于NUMA的BLOG, 今天主要测试一下NUMA策略的配置与PostgreSQL性能的关系.<br>理论上交错访问的代价要比CPU本地节点访问的代价高, 这点从测试结果上有微小的体现, 但是可能CPU以及到达瓶颈, 所以就只有微小的差异了.<wbr><div>我的测试环境 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >PostgreSQL 9.2beta2</font></div><div><font size="2"  >DELL R610</font></div><div><font size="2"  >Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5504 &nbsp;@ 2.00GHz</font></div><div><font size="2"  >内存 RDIMM&nbsp;Speed: 1333 MHz</font></div><p></p></pre></div><div><br></div><div>测试5000W记录的表按主键查询的效率.</div><div><br></div><div>测试表 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >psql digoal digoal</font></div><div><font size="2"  >create schema digoal;</font></div><div><font size="2"  >create table user_info (id int, info text);</font></div><div><font size="2"  >insert into user_info select generate_series(1,50000000),'digoal'||generate_series(1,50000000);</font></div><div><font size="2"  >alter table user_info add primary key (id);</font></div><div><font size="2"  >\c digoal postgres</font></div><div><font size="2"  >create extension pgfincore;</font></div></div><div><font size="2"  >-- 测试数据导入os cache</font></div><div><div><font size="2"  >select pgfadvise_willneed('pg_toast.'||relname) from pg_class where oid in (select reltoastrelid from pg_class where relname='user_info');</font></div><div><font size="2"  >select * from pgfadvise_willneed('digoal.user_info');</font></div><div><font size="2"  >select * from pgfadvise_willneed('digoal.user_info_pkey');</font></div></div><p></p></pre></div><div><br></div><div>测试脚本 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >postgres@172_16_3_52-&gt; vi sel.sql</font></div><div><font size="2"  >\setrandom id 1 50000000</font></div><div><font size="2"  >select * from digoal.user_info where id=:id;</font></div></div><div><font size="2"  >postgres@172_16_3_52-&gt; pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -U digoal -r -T 60 -c 8 -j 8 digoal</font></div><p></p></pre></div><div><br></div><div>NUMA 状态信息 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@172_16_3_52 ~]# numactl --hardware</font></div><div><font size="2"  >available: 2 nodes (0-1)</font></div><div><font size="2"  >node 0 size: 4040 MB</font></div><div><font size="2"  >node 0 free: 2978 MB</font></div><div><font size="2"  >node 1 size: 4014 MB</font></div><div><font size="2"  >node 1 free: 3616 MB</font></div><div><font size="2"  >node distances:</font></div><div><font size="2"  >node &nbsp; 0 &nbsp; 1&nbsp;</font></div><div><font size="2"  >&nbsp; 0: &nbsp;10 &nbsp;20&nbsp;</font></div><div><font size="2"  >&nbsp; 1: &nbsp;20 &nbsp;10&nbsp;</font></div><p></p></pre></div><div><br></div><div>接下来分三别测试三个NUMA策略 :&nbsp;</div><div>default, localalloc,&nbsp;interleave</div><div>其中理论上来说localalloc的内存访问应该是最快的.</div><div><br></div><div>一、default</div><div>-- 清除OS缓存, 以清理分配出去的内存.</div><div><div><pre class="prettyprint"  ><p><font size="2"  >echo 3 &gt; /proc/sys/vm/drop_caches</font></p></pre></div><div>-- 启动数据库</div><div><pre class="prettyprint"  ><p><font size="2"  >pg_ctl start</font></p></pre></div><div>-- 查看默认情况下postgres进程的numa策略</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@172_16_3_52 opt]# ps -ewf|grep postgres</font></div><div><font size="2"  >root &nbsp; &nbsp; 29400 29047 &nbsp;0 12:04 pts/1 &nbsp; &nbsp;00:00:00 su - postgres</font></div><div><font size="2"  >postgres 29401 29400 &nbsp;0 12:04 pts/1 &nbsp; &nbsp;00:00:00 -bash</font></div><div><font size="2"  >postgres 29704 &nbsp; &nbsp; 1 &nbsp;0 12:23 pts/1 &nbsp; &nbsp;00:00:00 /opt/pgsql/bin/postgres</font></div><div><font size="2"  >postgres 29705 29704 &nbsp;0 12:23 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: logger process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 29707 29704 &nbsp;0 12:23 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: writer process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 29708 29704 &nbsp;0 12:23 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: checkpointer process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 29709 29704 &nbsp;0 12:23 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: wal writer process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 29710 29704 &nbsp;0 12:23 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: autovacuum launcher process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 29711 29704 &nbsp;0 12:23 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: stats collector process &nbsp;&nbsp;</font></div><div><font size="2"  >root &nbsp; &nbsp; 29714 28774 &nbsp;0 12:23 pts/0 &nbsp; &nbsp;00:00:00 grep postgres</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >[root@172_16_3_52 opt]# cat /proc/29704/numa_maps&nbsp;</font></div><div><font size="2"  >00400000 default file=/opt/pgsql/bin/postgres mapped=237 mapmax=7 N0=237</font></div><div><font size="2"  >00aeb000 default file=/opt/pgsql/bin/postgres anon=14 dirty=14 mapmax=7 N0=3 N1=11</font></div><div><font size="2"  >00af9000 default anon=12 dirty=12 mapmax=7 N0=5 N1=7</font></div><div><font size="2"  >1a2d1000 default heap anon=37 dirty=37 mapmax=7 N0=21 N1=16</font></div><div><font size="2"  >3213000000 default file=/lib64/ld-2.5.so mapped=25 mapmax=53 N0=25</font></div><div><font size="2"  >321321b000 default file=/lib64/ld-2.5.so anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >321321c000 default file=/lib64/ld-2.5.so anon=1 dirty=1 N1=1</font></div><div><font size="2"  >3213400000 default file=/lib64/libc-2.5.so mapped=121 mapmax=63 active=120 N0=116 N1=5</font></div><div><font size="2"  >321354e000 default file=/lib64/libc-2.5.so</font></div><div><font size="2"  >321374d000 default file=/lib64/libc-2.5.so anon=2 dirty=2 mapped=4 mapmax=39 N0=2 N1=2</font></div><div><font size="2"  >3213751000 default file=/lib64/libc-2.5.so anon=1 dirty=1 N0=1</font></div><div><font size="2"  >3213752000 default anon=5 dirty=5 mapmax=7 N0=4 N1=1</font></div><div><font size="2"  >3213800000 default file=/lib64/libdl-2.5.so mapped=2 mapmax=27 N0=2</font></div><div><font size="2"  >3213802000 default file=/lib64/libdl-2.5.so</font></div><div><font size="2"  >3213a02000 default file=/lib64/libdl-2.5.so anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >3213a03000 default file=/lib64/libdl-2.5.so anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >3213c00000 default file=/lib64/libm-2.5.so mapped=6 mapmax=16 N0=6</font></div><div><font size="2"  >3213c82000 default file=/lib64/libm-2.5.so</font></div><div><font size="2"  >3213e81000 default file=/lib64/libm-2.5.so anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >3213e82000 default file=/lib64/libm-2.5.so anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >3214400000 default file=/usr/lib64/libz.so.1.2.3 mapped=4 mapmax=10 N0=4</font></div><div><font size="2"  >3214414000 default file=/usr/lib64/libz.so.1.2.3</font></div><div><font size="2"  >3214613000 default file=/usr/lib64/libz.so.1.2.3 anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >3214c00000 default file=/lib64/libselinux.so.1 mapped=11 mapmax=15 N0=11</font></div><div><font size="2"  >3214c15000 default file=/lib64/libselinux.so.1</font></div><div><font size="2"  >3214e15000 default file=/lib64/libselinux.so.1 anon=2 dirty=2 mapmax=7 N1=2</font></div><div><font size="2"  >3214e17000 default anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >3215000000 default file=/lib64/libsepol.so.1 mapped=5 mapmax=12 N0=5</font></div><div><font size="2"  >321503b000 default file=/lib64/libsepol.so.1</font></div><div><font size="2"  >321523b000 default file=/lib64/libsepol.so.1 anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >321523c000 default</font></div><div><font size="2"  >3217400000 default file=/lib64/libcom_err.so.2.1 mapped=2 mapmax=6 N0=2</font></div><div><font size="2"  >3217402000 default file=/lib64/libcom_err.so.2.1</font></div><div><font size="2"  >3217601000 default file=/lib64/libcom_err.so.2.1 anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >3217800000 default file=/lib64/libresolv-2.5.so mapped=5 mapmax=9 N0=5</font></div><div><font size="2"  >3217811000 default file=/lib64/libresolv-2.5.so</font></div><div><font size="2"  >3217a11000 default file=/lib64/libresolv-2.5.so anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >3217a12000 default file=/lib64/libresolv-2.5.so anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >3217a13000 default</font></div><div><font size="2"  >3217c00000 default file=/usr/lib64/libxml2.so.2.6.26 mapped=25 mapmax=9 N0=25</font></div><div><font size="2"  >3217d33000 default file=/usr/lib64/libxml2.so.2.6.26</font></div><div><font size="2"  >3217f33000 default file=/usr/lib64/libxml2.so.2.6.26 anon=4 dirty=4 mapped=5 mapmax=10 N0=1 N1=4</font></div><div><font size="2"  >3217f3c000 default</font></div><div><font size="2"  >3218c00000 default file=/lib64/libcrypto.so.0.9.8e mapped=26 mapmax=16 N0=26</font></div><div><font size="2"  >3218d2d000 default file=/lib64/libcrypto.so.0.9.8e</font></div><div><font size="2"  >3218f2c000 default file=/lib64/libcrypto.so.0.9.8e anon=3 dirty=3 mapped=5 mapmax=14 N0=2 N1=3</font></div><div><font size="2"  >3218f4d000 default anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >3219c00000 default file=/usr/lib64/libkrb5support.so.0.1 mapped=4 mapmax=5 N0=4</font></div><div><font size="2"  >3219c08000 default file=/usr/lib64/libkrb5support.so.0.1</font></div><div><font size="2"  >3219e07000 default file=/usr/lib64/libkrb5support.so.0.1 anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >321a800000 default file=/lib64/libkeyutils-1.2.so mapped=2 mapmax=5 N0=2</font></div><div><font size="2"  >321a802000 default file=/lib64/libkeyutils-1.2.so</font></div><div><font size="2"  >321aa01000 default file=/lib64/libkeyutils-1.2.so anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >321bc00000 default file=/usr/lib64/libk5crypto.so.3.1 mapped=7 mapmax=6 N0=7</font></div><div><font size="2"  >321bc24000 default file=/usr/lib64/libk5crypto.so.3.1</font></div><div><font size="2"  >321be23000 default file=/usr/lib64/libk5crypto.so.3.1 anon=2 dirty=2 mapmax=7 N1=2</font></div><div><font size="2"  >321d600000 default file=/usr/lib64/libgssapi_krb5.so.2.2 mapped=10 mapmax=6 N0=10</font></div><div><font size="2"  >321d62c000 default file=/usr/lib64/libgssapi_krb5.so.2.2</font></div><div><font size="2"  >321d82c000 default file=/usr/lib64/libgssapi_krb5.so.2.2 anon=2 dirty=2 mapmax=7 N1=2</font></div><div><font size="2"  >321da00000 default file=/usr/lib64/libkrb5.so.3.3 mapped=22 mapmax=6 N0=22</font></div><div><font size="2"  >321da91000 default file=/usr/lib64/libkrb5.so.3.3</font></div><div><font size="2"  >321dc91000 default file=/usr/lib64/libkrb5.so.3.3 anon=3 dirty=3 mapped=4 mapmax=14 N0=1 N1=3</font></div><div><font size="2"  >321fa00000 default file=/lib64/libssl.so.0.9.8e mapped=13 mapmax=12 N0=13</font></div><div><font size="2"  >321fa46000 default file=/lib64/libssl.so.0.9.8e</font></div><div><font size="2"  >321fc46000 default file=/lib64/libssl.so.0.9.8e anon=3 dirty=3 mapmax=7 N1=3</font></div><div><font size="2"  >3220600000 default file=/lib64/libaudit.so.0.0.0 mapped=4 mapmax=10 N1=4</font></div><div><font size="2"  >3220617000 default file=/lib64/libaudit.so.0.0.0</font></div><div><font size="2"  >3220816000 default file=/lib64/libaudit.so.0.0.0 anon=2 dirty=2 mapmax=7 N1=2</font></div><div><font size="2"  >3221200000 default file=/lib64/libpam.so.0.81.5 mapped=4 mapmax=16 N0=4</font></div><div><font size="2"  >322120b000 default file=/lib64/libpam.so.0.81.5</font></div><div><font size="2"  >322140a000 default file=/lib64/libpam.so.0.81.5 anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >3225e00000 default file=/lib64/libcrypt-2.5.so mapped=2 mapmax=18 N0=2</font></div><div><font size="2"  >3225e09000 default file=/lib64/libcrypt-2.5.so</font></div><div><font size="2"  >3226008000 default file=/lib64/libcrypt-2.5.so anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >3226009000 default file=/lib64/libcrypt-2.5.so anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >322600a000 default</font></div><div><font size="2"  >3228600000 default file=/usr/lib64/libxslt.so.1.1.17 mapped=11 mapmax=7 N0=11</font></div><div><font size="2"  >3228634000 default file=/usr/lib64/libxslt.so.1.1.17</font></div><div><font size="2"  >3228833000 default file=/usr/lib64/libxslt.so.1.1.17 anon=2 dirty=2 mapmax=7 N1=2</font></div><div><font size="2"  >2ad4bf342000 default anon=10 dirty=10 mapmax=7 N0=3 N1=7</font></div><div><font size="2"  >2ad4bf34c000 default file=/usr/lib/locale/locale-archive mapped=10 mapmax=14 N1=10</font></div><div><font size="2"  >2ad4c291e000 default file=/opt/pgsql/lib/pg_stat_statements.so mapped=6 N0=6</font></div><div><font size="2"  >2ad4c2924000 default file=/opt/pgsql/lib/pg_stat_statements.so</font></div><div><font size="2"  >2ad4c2b23000 default file=/opt/pgsql/lib/pg_stat_statements.so anon=1 dirty=1 mapmax=7 N0=1</font></div><div><font size="2"  >2ad4c2b24000 default file=/SYSV001d4fe9\040(deleted) dirty=22976 mapmax=5 active=708 N0=22976</font></div><div><font size="2"  >2ad549ada000 default file=/lib64/libnss_files-2.5.so mapped=5 mapmax=23 N1=5</font></div><div><font size="2"  >2ad549ae4000 default file=/lib64/libnss_files-2.5.so</font></div><div><font size="2"  >2ad549ce3000 default file=/lib64/libnss_files-2.5.so anon=1 dirty=1 mapmax=6 N0=1</font></div><div><font size="2"  >2ad549ce4000 default file=/lib64/libnss_files-2.5.so anon=1 dirty=1 mapmax=6 N0=1</font></div><div><font size="2"  >7fff1a766000 default stack anon=13 dirty=13 mapmax=7 N0=11 N1=2</font></div><p></p></pre></div><div><br></div><div>-- 记录下当前的numastat, 在执行完pgbench后再来比对一下统计数据的差异.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@172_16_3_52 opt]# numastat&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node1</font></div><div><font size="2"  >numa_hit &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 9773006 &nbsp; &nbsp; &nbsp; &nbsp; 7337498</font></div><div><font size="2"  >numa_miss &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1274778 &nbsp; &nbsp; &nbsp; &nbsp; 2394678</font></div><div><font size="2"  >numa_foreign &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2394678 &nbsp; &nbsp; &nbsp; &nbsp; 1274778</font></div><div><font size="2"  >interleave_hit &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;178418 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;178256</font></div><div><font size="2"  >local_node &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 9679155 &nbsp; &nbsp; &nbsp; &nbsp; 7117199</font></div><div><font size="2"  >other_node &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1368629 &nbsp; &nbsp; &nbsp; &nbsp; 2614977</font></div><p></p></pre></div><div><br></div><div>-- 加载数据至内存</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >select pgfadvise_willneed('pg_toast.'||relname) from pg_class where oid in (select reltoastrelid from pg_class where relname='user_info');</font></div><div><font size="2"  >select * from pgfadvise_willneed('digoal.user_info');</font></div><div><font size="2"  >select * from pgfadvise_willneed('digoal.user_info_pkey');</font></div><p></p></pre></div><div><br></div><div>-- 开始使用pgbench压</div><div><pre class="prettyprint"  ><p><font size="2"  >pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -U digoal -r -T 60 -c 8 -j 8 digoal</font></p></pre></div><div><br></div><div>-- 查看backend process的numa策略, 和主进程一样</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@172_16_3_52 opt]# ps -efw|grep postgres</font></div><div><font size="2"  >root &nbsp; &nbsp; 29400 29047 &nbsp;0 12:04 pts/1 &nbsp; &nbsp;00:00:00 su - postgres</font></div><div><font size="2"  >postgres 29401 29400 &nbsp;0 12:04 pts/1 &nbsp; &nbsp;00:00:00 -bash</font></div><div><font size="2"  >postgres 29704 &nbsp; &nbsp; 1 &nbsp;0 12:23 pts/1 &nbsp; &nbsp;00:00:00 /opt/pgsql/bin/postgres</font></div><div><font size="2"  >postgres 29705 29704 &nbsp;0 12:23 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: logger process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 29707 29704 &nbsp;0 12:23 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: writer process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 29708 29704 &nbsp;0 12:23 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: checkpointer process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 29709 29704 &nbsp;0 12:23 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: wal writer process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 29710 29704 &nbsp;0 12:23 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: autovacuum launcher process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 29711 29704 &nbsp;0 12:23 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: stats collector process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 29726 29401 99 12:25 pts/1 &nbsp; &nbsp;00:00:38 pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -U digoal -r -T 60 -c 8 -j 8 digoal</font></div><div><font size="2"  >postgres 29735 29704 76 12:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:16 postgres: digoal digoal 127.0.0.1(60708) idle</font></div><div><font size="2"  >postgres 29736 29704 76 12:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:16 postgres: digoal digoal 127.0.0.1(60709) BIND</font></div><div><font size="2"  >postgres 29737 29704 78 12:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:16 postgres: digoal digoal 127.0.0.1(60710) BIND</font></div><div><font size="2"  >postgres 29738 29704 77 12:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:16 postgres: digoal digoal 127.0.0.1(60711) BIND</font></div><div><font size="2"  >postgres 29739 29704 76 12:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:16 postgres: digoal digoal 127.0.0.1(60712) SELECT</font></div><div><font size="2"  >postgres 29740 29704 77 12:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:16 postgres: digoal digoal 127.0.0.1(60713) BIND</font></div><div><font size="2"  >postgres 29741 29704 75 12:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:15 postgres: digoal digoal 127.0.0.1(60714) SELECT</font></div><div><font size="2"  >postgres 29742 29704 76 12:25 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:16 postgres: digoal digoal 127.0.0.1(60715) BIND</font></div><div><font size="2"  >root &nbsp; &nbsp; 29745 28774 &nbsp;0 12:25 pts/0 &nbsp; &nbsp;00:00:00 grep postgres</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >[root@172_16_3_52 opt]# cat /proc/29735/numa_maps&nbsp;</font></div><div><font size="2"  >00400000 default file=/opt/pgsql/bin/postgres mapped=425 mapmax=15 N0=405 N1=20</font></div><div><font size="2"  >00aeb000 default file=/opt/pgsql/bin/postgres anon=14 dirty=14 mapmax=15 N0=8 N1=6</font></div><div><font size="2"  >00af9000 default anon=14 dirty=14 mapmax=15 N0=13 N1=1</font></div><div><font size="2"  >1a2d1000 default heap anon=241 dirty=241 mapmax=15 N0=229 N1=12</font></div><div><font size="2"  >3213000000 default file=/lib64/ld-2.5.so mapped=7 mapmax=62 N0=7</font></div><div><font size="2"  >321321b000 default file=/lib64/ld-2.5.so anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >321321c000 default file=/lib64/ld-2.5.so anon=1 dirty=1 N0=1</font></div><div><font size="2"  >3213400000 default file=/lib64/libc-2.5.so mapped=79 mapmax=72 N0=77 N1=2</font></div><div><font size="2"  >321354e000 default file=/lib64/libc-2.5.so</font></div><div><font size="2"  >321374d000 default file=/lib64/libc-2.5.so anon=2 dirty=2 mapped=4 mapmax=48 N0=2 N1=2</font></div><div><font size="2"  >3213751000 default file=/lib64/libc-2.5.so anon=1 dirty=1 N0=1</font></div><div><font size="2"  >3213752000 default anon=5 dirty=5 mapmax=14 N0=5</font></div><div><font size="2"  >3213800000 default file=/lib64/libdl-2.5.so mapped=1 mapmax=36 N0=1</font></div><div><font size="2"  >3213802000 default file=/lib64/libdl-2.5.so</font></div><div><font size="2"  >3213a02000 default file=/lib64/libdl-2.5.so anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >3213a03000 default file=/lib64/libdl-2.5.so anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >3213c00000 default file=/lib64/libm-2.5.so mapped=7 mapmax=25 N0=7</font></div><div><font size="2"  >3213c82000 default file=/lib64/libm-2.5.so</font></div><div><font size="2"  >3213e81000 default file=/lib64/libm-2.5.so anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >3213e82000 default file=/lib64/libm-2.5.so anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >3214400000 default file=/usr/lib64/libz.so.1.2.3</font></div><div><font size="2"  >3214414000 default file=/usr/lib64/libz.so.1.2.3</font></div><div><font size="2"  >3214613000 default file=/usr/lib64/libz.so.1.2.3 anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >3214c00000 default file=/lib64/libselinux.so.1</font></div><div><font size="2"  >3214c15000 default file=/lib64/libselinux.so.1</font></div><div><font size="2"  >3214e15000 default file=/lib64/libselinux.so.1 anon=2 dirty=2 mapmax=15 N1=2</font></div><div><font size="2"  >3214e17000 default anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >3215000000 default file=/lib64/libsepol.so.1</font></div><div><font size="2"  >321503b000 default file=/lib64/libsepol.so.1</font></div><div><font size="2"  >321523b000 default file=/lib64/libsepol.so.1 anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >321523c000 default</font></div><div><font size="2"  >3217400000 default file=/lib64/libcom_err.so.2.1</font></div><div><font size="2"  >3217402000 default file=/lib64/libcom_err.so.2.1</font></div><div><font size="2"  >3217601000 default file=/lib64/libcom_err.so.2.1 anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >3217800000 default file=/lib64/libresolv-2.5.so</font></div><div><font size="2"  >3217811000 default file=/lib64/libresolv-2.5.so</font></div><div><font size="2"  >3217a11000 default file=/lib64/libresolv-2.5.so anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >3217a12000 default file=/lib64/libresolv-2.5.so anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >3217a13000 default</font></div><div><font size="2"  >3217c00000 default file=/usr/lib64/libxml2.so.2.6.26 mapped=3 mapmax=18 N0=3</font></div><div><font size="2"  >3217d33000 default file=/usr/lib64/libxml2.so.2.6.26</font></div><div><font size="2"  >3217f33000 default file=/usr/lib64/libxml2.so.2.6.26 anon=4 dirty=4 mapped=5 mapmax=19 N0=1 N1=4</font></div><div><font size="2"  >3217f3c000 default</font></div><div><font size="2"  >3218c00000 default file=/lib64/libcrypto.so.0.9.8e mapped=2 mapmax=25 N0=2</font></div><div><font size="2"  >3218d2d000 default file=/lib64/libcrypto.so.0.9.8e</font></div><div><font size="2"  >3218f2c000 default file=/lib64/libcrypto.so.0.9.8e anon=3 dirty=3 mapped=5 mapmax=23 N0=2 N1=3</font></div><div><font size="2"  >3218f4d000 default anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >3219c00000 default file=/usr/lib64/libkrb5support.so.0.1</font></div><div><font size="2"  >3219c08000 default file=/usr/lib64/libkrb5support.so.0.1</font></div><div><font size="2"  >3219e07000 default file=/usr/lib64/libkrb5support.so.0.1 anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >321a800000 default file=/lib64/libkeyutils-1.2.so</font></div><div><font size="2"  >321a802000 default file=/lib64/libkeyutils-1.2.so</font></div><div><font size="2"  >321aa01000 default file=/lib64/libkeyutils-1.2.so anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >321bc00000 default file=/usr/lib64/libk5crypto.so.3.1</font></div><div><font size="2"  >321bc24000 default file=/usr/lib64/libk5crypto.so.3.1</font></div><div><font size="2"  >321be23000 default file=/usr/lib64/libk5crypto.so.3.1 anon=2 dirty=2 mapmax=15 N1=2</font></div><div><font size="2"  >321d600000 default file=/usr/lib64/libgssapi_krb5.so.2.2</font></div><div><font size="2"  >321d62c000 default file=/usr/lib64/libgssapi_krb5.so.2.2</font></div><div><font size="2"  >321d82c000 default file=/usr/lib64/libgssapi_krb5.so.2.2 anon=2 dirty=2 mapmax=15 N1=2</font></div><div><font size="2"  >321da00000 default file=/usr/lib64/libkrb5.so.3.3</font></div><div><font size="2"  >321da91000 default file=/usr/lib64/libkrb5.so.3.3</font></div><div><font size="2"  >321dc91000 default file=/usr/lib64/libkrb5.so.3.3 anon=3 dirty=3 mapped=4 mapmax=23 N0=1 N1=3</font></div><div><font size="2"  >321fa00000 default file=/lib64/libssl.so.0.9.8e mapped=1 mapmax=21 N0=1</font></div><div><font size="2"  >321fa46000 default file=/lib64/libssl.so.0.9.8e</font></div><div><font size="2"  >321fc46000 default file=/lib64/libssl.so.0.9.8e anon=3 dirty=3 mapmax=15 N1=3</font></div><div><font size="2"  >3220600000 default file=/lib64/libaudit.so.0.0.0</font></div><div><font size="2"  >3220617000 default file=/lib64/libaudit.so.0.0.0</font></div><div><font size="2"  >3220816000 default file=/lib64/libaudit.so.0.0.0 anon=2 dirty=2 mapmax=15 N1=2</font></div><div><font size="2"  >3221200000 default file=/lib64/libpam.so.0.81.5 mapped=1 mapmax=25 N0=1</font></div><div><font size="2"  >322120b000 default file=/lib64/libpam.so.0.81.5</font></div><div><font size="2"  >322140a000 default file=/lib64/libpam.so.0.81.5 anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >3225e00000 default file=/lib64/libcrypt-2.5.so mapped=1 mapmax=27 N0=1</font></div><div><font size="2"  >3225e09000 default file=/lib64/libcrypt-2.5.so</font></div><div><font size="2"  >3226008000 default file=/lib64/libcrypt-2.5.so anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >3226009000 default file=/lib64/libcrypt-2.5.so anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >322600a000 default</font></div><div><font size="2"  >3228600000 default file=/usr/lib64/libxslt.so.1.1.17 mapped=1 mapmax=16 N0=1</font></div><div><font size="2"  >3228634000 default file=/usr/lib64/libxslt.so.1.1.17</font></div><div><font size="2"  >3228833000 default file=/usr/lib64/libxslt.so.1.1.17 anon=2 dirty=2 mapmax=15 N1=2</font></div><div><font size="2"  >2ad4bf342000 default anon=10 dirty=10 mapmax=15 N0=3 N1=7</font></div><div><font size="2"  >2ad4bf34c000 default file=/usr/lib/locale/locale-archive mapped=1 mapmax=22 N1=1</font></div><div><font size="2"  >2ad4c291e000 default file=/opt/pgsql/lib/pg_stat_statements.so mapped=5 mapmax=9 N0=5</font></div><div><font size="2"  >2ad4c2924000 default file=/opt/pgsql/lib/pg_stat_statements.so</font></div><div><font size="2"  >2ad4c2b23000 default file=/opt/pgsql/lib/pg_stat_statements.so anon=1 dirty=1 N0=1</font></div><div><font size="2"  >2ad4c2b24000 default file=/SYSV001d4fe9\040(deleted) dirty=495456 mapmax=13 active=495420 N0=261430 N1=234026</font></div><div><font size="2"  >2ad549ada000 default file=/lib64/libnss_files-2.5.so</font></div><div><font size="2"  >2ad549ae4000 default file=/lib64/libnss_files-2.5.so</font></div><div><font size="2"  >2ad549ce3000 default file=/lib64/libnss_files-2.5.so anon=1 dirty=1 mapmax=14 N0=1</font></div><div><font size="2"  >2ad549ce4000 default file=/lib64/libnss_files-2.5.so anon=1 dirty=1 mapmax=14 N0=1</font></div><div><font size="2"  >2ad549ce5000 default anon=291 dirty=291 N0=291</font></div><div><font size="2"  >2ad549e48000 default anon=38 dirty=38 N0=38</font></div><div><font size="2"  >7fff1a766000 default stack anon=14 dirty=14 mapmax=15 N0=14</font></div><p></p></pre></div><div><br></div><div>-- 压力测试结果</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@172_16_3_52-&gt; pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -U digoal -r -T 60 -c 8 -j 8 digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: prepared</font></div><div><font size="2"  >number of clients: 8</font></div><div><font size="2"  >number of threads: 8</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 4556832</font></div><div><font size="2"  >tps = 75870.674309 (including connections establishing)</font></div><div><font size="2"  >tps = 75879.187429 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.002581 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 50000000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.100240 &nbsp; &nbsp; &nbsp; &nbsp;select * from digoal.user_info where id=:id;</font></div><p></p></pre></div></div><div><br></div><div>-- 记录压力测试结束后的numastat</div><div><div><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >[root@172_16_3_52 opt]# numastat&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node1</font></div><div style="line-height: 22px;"  ><font size="2"  >numa_hit &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;10068127 &nbsp; &nbsp; &nbsp; &nbsp; 8336063</font></div><div style="line-height: 22px;"  ><font size="2"  >numa_miss &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1478811 &nbsp; &nbsp; &nbsp; &nbsp; 2394678</font></div><div style="line-height: 22px;"  ><font size="2"  >numa_foreign &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2394678 &nbsp; &nbsp; &nbsp; &nbsp; 1478811</font></div><div style="line-height: 22px;"  ><font size="2"  >interleave_hit &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;178453 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;178276</font></div><div style="line-height: 22px;"  ><font size="2"  >local_node &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 9974250 &nbsp; &nbsp; &nbsp; &nbsp; 8115725</font></div><div style="line-height: 22px;"  ><font size="2"  >other_node &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1572688 &nbsp; &nbsp; &nbsp; &nbsp; 2615016</font></div><p></p></pre></div></div><div style="line-height: 22px;"  >-- 根据差异可以看出default模式下, numa_hit, numa_miss, local_node, other_node都有分布.</div><div style="line-height: 22px;"  ><br></div><div style="line-height: 22px;"  >二、interleave=all</div><div style="line-height: 22px;"  >-- 首先把数据库关掉</div><div><div><pre class="prettyprint"  ><p><font size="2"  >pg_ctl stop -m fast</font></p></pre></div><div>-- 清除OS缓存, 以清理分配出去的内存.</div><div><pre class="prettyprint"  ><p><font size="2"  >echo 3 &gt; /proc/sys/vm/drop_caches</font></p></pre></div><div>-- 启动数据库, 注意此时选择numa策略interleave=all</div><div><pre class="prettyprint"  ><p><font size="2"  >postgres@172_16_3_52-&gt; numactl --interleave=all pg_ctl start</font></p></pre></div><div>-- 查看默认情况下postgres进程的numa策略</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@172_16_3_52 opt]# ps -ewf|grep postgres</font></div><div><font size="2"  >root &nbsp; &nbsp; 29400 29047 &nbsp;0 12:04 pts/1 &nbsp; &nbsp;00:00:00 su - postgres</font></div><div><font size="2"  >postgres 29401 29400 &nbsp;0 12:04 pts/1 &nbsp; &nbsp;00:00:00 -bash</font></div><div><font size="2"  >postgres 29860 &nbsp; &nbsp; 1 &nbsp;1 12:34 pts/1 &nbsp; &nbsp;00:00:00 /opt/pgsql/bin/postgres</font></div><div><font size="2"  >postgres 29861 29860 &nbsp;0 12:34 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: logger process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 29863 29860 &nbsp;0 12:34 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: writer process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 29864 29860 &nbsp;0 12:34 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: checkpointer process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 29865 29860 &nbsp;0 12:34 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: wal writer process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 29866 29860 &nbsp;0 12:34 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: autovacuum launcher process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 29867 29860 &nbsp;0 12:34 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: stats collector process &nbsp;&nbsp;</font></div><div><font size="2"  >root &nbsp; &nbsp; 29869 28774 &nbsp;0 12:34 pts/0 &nbsp; &nbsp;00:00:00 grep postgres</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >[root@172_16_3_52 opt]# cat /proc/29860/numa_maps&nbsp;</font></div><div><font size="2"  >00400000 interleave=0-1 file=/opt/pgsql/bin/postgres mapped=237 mapmax=7 active=149 N0=118 N1=119</font></div><div><font size="2"  >00aeb000 interleave=0-1 file=/opt/pgsql/bin/postgres anon=14 dirty=14 mapmax=7 N0=7 N1=7</font></div><div><font size="2"  >00af9000 interleave=0-1 anon=12 dirty=12 mapmax=7 N0=6 N1=6</font></div><div><font size="2"  >1324f000 interleave=0-1 heap anon=37 dirty=37 mapmax=7 N0=18 N1=19</font></div><div><font size="2"  >3213000000 interleave=0-1 file=/lib64/ld-2.5.so mapped=25 mapmax=53 N0=25</font></div><div><font size="2"  >321321b000 interleave=0-1 file=/lib64/ld-2.5.so anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >321321c000 interleave=0-1 file=/lib64/ld-2.5.so anon=1 dirty=1 N0=1</font></div><div><font size="2"  >3213400000 interleave=0-1 file=/lib64/libc-2.5.so mapped=121 mapmax=63 N0=115 N1=6</font></div><div><font size="2"  >321354e000 interleave=0-1 file=/lib64/libc-2.5.so</font></div><div><font size="2"  >321374d000 interleave=0-1 file=/lib64/libc-2.5.so anon=2 dirty=2 mapped=4 mapmax=39 N0=3 N1=1</font></div><div><font size="2"  >3213751000 interleave=0-1 file=/lib64/libc-2.5.so anon=1 dirty=1 N1=1</font></div><div><font size="2"  >3213752000 interleave=0-1 anon=5 dirty=5 mapmax=7 N0=3 N1=2</font></div><div><font size="2"  >3213800000 interleave=0-1 file=/lib64/libdl-2.5.so mapped=2 mapmax=27 N0=2</font></div><div><font size="2"  >3213802000 interleave=0-1 file=/lib64/libdl-2.5.so</font></div><div><font size="2"  >3213a02000 interleave=0-1 file=/lib64/libdl-2.5.so anon=1 dirty=1 mapmax=7 N0=1</font></div><div><font size="2"  >3213a03000 interleave=0-1 file=/lib64/libdl-2.5.so anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >3213c00000 interleave=0-1 file=/lib64/libm-2.5.so mapped=6 mapmax=16 active=5 N0=3 N1=3</font></div><div><font size="2"  >3213c82000 interleave=0-1 file=/lib64/libm-2.5.so</font></div><div><font size="2"  >3213e81000 interleave=0-1 file=/lib64/libm-2.5.so anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >3213e82000 interleave=0-1 file=/lib64/libm-2.5.so anon=1 dirty=1 mapmax=7 N0=1</font></div><div><font size="2"  >3214400000 interleave=0-1 file=/usr/lib64/libz.so.1.2.3 mapped=4 mapmax=10 N0=4</font></div><div><font size="2"  >3214414000 interleave=0-1 file=/usr/lib64/libz.so.1.2.3</font></div><div><font size="2"  >3214613000 interleave=0-1 file=/usr/lib64/libz.so.1.2.3 anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >3214c00000 interleave=0-1 file=/lib64/libselinux.so.1 mapped=11 mapmax=15 N0=11</font></div><div><font size="2"  >3214c15000 interleave=0-1 file=/lib64/libselinux.so.1</font></div><div><font size="2"  >3214e15000 interleave=0-1 file=/lib64/libselinux.so.1 anon=2 dirty=2 mapmax=7 N0=1 N1=1</font></div><div><font size="2"  >3214e17000 interleave=0-1 anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >3215000000 interleave=0-1 file=/lib64/libsepol.so.1 mapped=5 mapmax=12 N0=5</font></div><div><font size="2"  >321503b000 interleave=0-1 file=/lib64/libsepol.so.1</font></div><div><font size="2"  >321523b000 interleave=0-1 file=/lib64/libsepol.so.1 anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >321523c000 interleave=0-1</font></div><div><font size="2"  >3217400000 interleave=0-1 file=/lib64/libcom_err.so.2.1 mapped=2 mapmax=6 N0=2</font></div><div><font size="2"  >3217402000 interleave=0-1 file=/lib64/libcom_err.so.2.1</font></div><div><font size="2"  >3217601000 interleave=0-1 file=/lib64/libcom_err.so.2.1 anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >3217800000 interleave=0-1 file=/lib64/libresolv-2.5.so mapped=5 mapmax=9 N0=5</font></div><div><font size="2"  >3217811000 interleave=0-1 file=/lib64/libresolv-2.5.so</font></div><div><font size="2"  >3217a11000 interleave=0-1 file=/lib64/libresolv-2.5.so anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >3217a12000 interleave=0-1 file=/lib64/libresolv-2.5.so anon=1 dirty=1 mapmax=7 N0=1</font></div><div><font size="2"  >3217a13000 interleave=0-1</font></div><div><font size="2"  >3217c00000 interleave=0-1 file=/usr/lib64/libxml2.so.2.6.26 mapped=25 mapmax=9 N0=21 N1=4</font></div><div><font size="2"  >3217d33000 interleave=0-1 file=/usr/lib64/libxml2.so.2.6.26</font></div><div><font size="2"  >3217f33000 interleave=0-1 file=/usr/lib64/libxml2.so.2.6.26 anon=4 dirty=4 mapped=5 mapmax=10 N0=3 N1=2</font></div><div><font size="2"  >3217f3c000 interleave=0-1</font></div><div><font size="2"  >3218c00000 interleave=0-1 file=/lib64/libcrypto.so.0.9.8e mapped=26 mapmax=16 N0=26</font></div><div><font size="2"  >3218d2d000 interleave=0-1 file=/lib64/libcrypto.so.0.9.8e</font></div><div><font size="2"  >3218f2c000 interleave=0-1 file=/lib64/libcrypto.so.0.9.8e anon=3 dirty=3 mapped=5 mapmax=14 N0=4 N1=1</font></div><div><font size="2"  >3218f4d000 interleave=0-1 anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >3219c00000 interleave=0-1 file=/usr/lib64/libkrb5support.so.0.1 mapped=4 mapmax=5 N0=4</font></div><div><font size="2"  >3219c08000 interleave=0-1 file=/usr/lib64/libkrb5support.so.0.1</font></div><div><font size="2"  >3219e07000 interleave=0-1 file=/usr/lib64/libkrb5support.so.0.1 anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >321a800000 interleave=0-1 file=/lib64/libkeyutils-1.2.so mapped=2 mapmax=5 N0=2</font></div><div><font size="2"  >321a802000 interleave=0-1 file=/lib64/libkeyutils-1.2.so</font></div><div><font size="2"  >321aa01000 interleave=0-1 file=/lib64/libkeyutils-1.2.so anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >321bc00000 interleave=0-1 file=/usr/lib64/libk5crypto.so.3.1 mapped=7 mapmax=6 N0=7</font></div><div><font size="2"  >321bc24000 interleave=0-1 file=/usr/lib64/libk5crypto.so.3.1</font></div><div><font size="2"  >321be23000 interleave=0-1 file=/usr/lib64/libk5crypto.so.3.1 anon=2 dirty=2 mapmax=7 N0=1 N1=1</font></div><div><font size="2"  >321d600000 interleave=0-1 file=/usr/lib64/libgssapi_krb5.so.2.2 mapped=10 mapmax=6 N0=10</font></div><div><font size="2"  >321d62c000 interleave=0-1 file=/usr/lib64/libgssapi_krb5.so.2.2</font></div><div><font size="2"  >321d82c000 interleave=0-1 file=/usr/lib64/libgssapi_krb5.so.2.2 anon=2 dirty=2 mapmax=7 N0=1 N1=1</font></div><div><font size="2"  >321da00000 interleave=0-1 file=/usr/lib64/libkrb5.so.3.3 mapped=22 mapmax=6 N0=22</font></div><div><font size="2"  >321da91000 interleave=0-1 file=/usr/lib64/libkrb5.so.3.3</font></div><div><font size="2"  >321dc91000 interleave=0-1 file=/usr/lib64/libkrb5.so.3.3 anon=3 dirty=3 mapped=4 mapmax=14 N0=3 N1=1</font></div><div><font size="2"  >321fa00000 interleave=0-1 file=/lib64/libssl.so.0.9.8e mapped=13 mapmax=12 N0=12 N1=1</font></div><div><font size="2"  >321fa46000 interleave=0-1 file=/lib64/libssl.so.0.9.8e</font></div><div><font size="2"  >321fc46000 interleave=0-1 file=/lib64/libssl.so.0.9.8e anon=3 dirty=3 mapmax=7 N0=1 N1=2</font></div><div><font size="2"  >3220600000 interleave=0-1 file=/lib64/libaudit.so.0.0.0 mapped=4 mapmax=10 N1=4</font></div><div><font size="2"  >3220617000 interleave=0-1 file=/lib64/libaudit.so.0.0.0</font></div><div><font size="2"  >3220816000 interleave=0-1 file=/lib64/libaudit.so.0.0.0 anon=2 dirty=2 mapmax=7 N0=1 N1=1</font></div><div><font size="2"  >3221200000 interleave=0-1 file=/lib64/libpam.so.0.81.5 mapped=4 mapmax=16 N0=4</font></div><div><font size="2"  >322120b000 interleave=0-1 file=/lib64/libpam.so.0.81.5</font></div><div><font size="2"  >322140a000 interleave=0-1 file=/lib64/libpam.so.0.81.5 anon=1 dirty=1 mapmax=7 N0=1</font></div><div><font size="2"  >3225e00000 interleave=0-1 file=/lib64/libcrypt-2.5.so mapped=2 mapmax=18 N0=2</font></div><div><font size="2"  >3225e09000 interleave=0-1 file=/lib64/libcrypt-2.5.so</font></div><div><font size="2"  >3226008000 interleave=0-1 file=/lib64/libcrypt-2.5.so anon=1 dirty=1 mapmax=7 N0=1</font></div><div><font size="2"  >3226009000 interleave=0-1 file=/lib64/libcrypt-2.5.so anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >322600a000 interleave=0-1</font></div><div><font size="2"  >3228600000 interleave=0-1 file=/usr/lib64/libxslt.so.1.1.17 mapped=11 mapmax=7 N0=5 N1=6</font></div><div><font size="2"  >3228634000 interleave=0-1 file=/usr/lib64/libxslt.so.1.1.17</font></div><div><font size="2"  >3228833000 interleave=0-1 file=/usr/lib64/libxslt.so.1.1.17 anon=2 dirty=2 mapmax=7 N0=1 N1=1</font></div><div><font size="2"  >2b0e25caf000 interleave=0-1 anon=10 dirty=10 mapmax=7 N0=5 N1=5</font></div><div><font size="2"  >2b0e25cb9000 interleave=0-1 file=/usr/lib/locale/locale-archive mapped=10 mapmax=14 N1=10</font></div><div><font size="2"  >2b0e2928b000 interleave=0-1 file=/opt/pgsql/lib/pg_stat_statements.so mapped=6 active=3 N0=3 N1=3</font></div><div><font size="2"  >2b0e29291000 interleave=0-1 file=/opt/pgsql/lib/pg_stat_statements.so</font></div><div><font size="2"  >2b0e29490000 interleave=0-1 file=/opt/pgsql/lib/pg_stat_statements.so anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >2b0e29491000 default file=/SYSV001d4fe9\040(deleted) dirty=22976 mapmax=5 active=398 N0=11492 N1=11484</font></div><div><font size="2"  >2b0eb0447000 interleave=0-1 file=/lib64/libnss_files-2.5.so mapped=5 mapmax=23 N1=5</font></div><div><font size="2"  >2b0eb0451000 interleave=0-1 file=/lib64/libnss_files-2.5.so</font></div><div><font size="2"  >2b0eb0650000 interleave=0-1 file=/lib64/libnss_files-2.5.so anon=1 dirty=1 mapmax=6 N1=1</font></div><div><font size="2"  >2b0eb0651000 interleave=0-1 file=/lib64/libnss_files-2.5.so anon=1 dirty=1 mapmax=6 N0=1</font></div><div><font size="2"  >7fffbf894000 interleave=0-1 stack anon=14 dirty=14 mapmax=7 N0=7 N1=7</font></div><p></p></pre></div><div><br></div><div>-- 记录下当前的numastat, 在执行完pgbench后再来比对一下统计数据的差异.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@172_16_3_52 opt]# numastat&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node1</font></div><div><font size="2"  >numa_hit &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;10085282 &nbsp; &nbsp; &nbsp; &nbsp; 8352101</font></div><div><font size="2"  >numa_miss &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1478811 &nbsp; &nbsp; &nbsp; &nbsp; 2394678</font></div><div><font size="2"  >numa_foreign &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2394678 &nbsp; &nbsp; &nbsp; &nbsp; 1478811</font></div><div><font size="2"  >interleave_hit &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;192452 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;192169</font></div><div><font size="2"  >local_node &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 9990841 &nbsp; &nbsp; &nbsp; &nbsp; 8118045</font></div><div><font size="2"  >other_node &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1573252 &nbsp; &nbsp; &nbsp; &nbsp; 2628734</font></div><p></p></pre></div><div><br></div><div>-- 加载数据至内存</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >select pgfadvise_willneed('pg_toast.'||relname) from pg_class where oid in (select reltoastrelid from pg_class where relname='user_info');</font></div><div><font size="2"  >select * from pgfadvise_willneed('digoal.user_info');</font></div><div><font size="2"  >select * from pgfadvise_willneed('digoal.user_info_pkey');</font></div><p></p></pre></div><div><br></div><div>-- 开始使用pgbench压</div><div><pre class="prettyprint"  ><p><font size="2"  >pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -U digoal -r -T 60 -c 8 -j 8 digoal</font></p></pre></div><div><br></div><div>-- 查看backend process的numa策略, 和主进程一样</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@172_16_3_52 opt]# ps -ewf|grep postgres</font></div><div><font size="2"  >root &nbsp; &nbsp; 29400 29047 &nbsp;0 12:04 pts/1 &nbsp; &nbsp;00:00:00 su - postgres</font></div><div><font size="2"  >postgres 29401 29400 &nbsp;0 12:04 pts/1 &nbsp; &nbsp;00:00:00 -bash</font></div><div><font size="2"  >postgres 29860 &nbsp; &nbsp; 1 &nbsp;0 12:34 pts/1 &nbsp; &nbsp;00:00:00 /opt/pgsql/bin/postgres</font></div><div><font size="2"  >postgres 29861 29860 &nbsp;0 12:34 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: logger process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 29863 29860 &nbsp;0 12:34 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: writer process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 29864 29860 &nbsp;0 12:34 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: checkpointer process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 29865 29860 &nbsp;0 12:34 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: wal writer process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 29866 29860 &nbsp;0 12:34 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: autovacuum launcher process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 29867 29860 &nbsp;0 12:34 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: stats collector process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 29881 29401 99 12:36 pts/1 &nbsp; &nbsp;00:00:07 pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -U digoal -r -T 60 -c 8 -j 8 digoal</font></div><div><font size="2"  >postgres 29890 29860 82 12:36 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:03 postgres: digoal digoal 127.0.0.1(33421) BIND</font></div><div><font size="2"  >postgres 29891 29860 83 12:36 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:03 postgres: digoal digoal 127.0.0.1(33422) BIND</font></div><div><font size="2"  >postgres 29892 29860 84 12:36 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:03 postgres: digoal digoal 127.0.0.1(33423) idle</font></div><div><font size="2"  >postgres 29893 29860 84 12:36 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:03 postgres: digoal digoal 127.0.0.1(33424) idle</font></div><div><font size="2"  >postgres 29894 29860 83 12:36 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:03 postgres: digoal digoal 127.0.0.1(33425) SELECT</font></div><div><font size="2"  >postgres 29895 29860 83 12:36 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:03 postgres: digoal digoal 127.0.0.1(33426) BIND</font></div><div><font size="2"  >postgres 29896 29860 82 12:36 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:03 postgres: digoal digoal 127.0.0.1(33427) SELECT</font></div><div><font size="2"  >postgres 29897 29860 82 12:36 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:03 postgres: digoal digoal 127.0.0.1(33428) SELECT</font></div><div><font size="2"  >root &nbsp; &nbsp; 29900 28774 &nbsp;0 12:36 pts/0 &nbsp; &nbsp;00:00:00 grep postgres</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >[root@172_16_3_52 opt]# cat /proc/29890/numa_maps&nbsp;</font></div><div><font size="2"  >00400000 interleave=0-1 file=/opt/pgsql/bin/postgres mapped=425 mapmax=15 active=424 N0=217 N1=208</font></div><div><font size="2"  >00aeb000 interleave=0-1 file=/opt/pgsql/bin/postgres anon=14 dirty=14 mapmax=15 N0=7 N1=7</font></div><div><font size="2"  >00af9000 interleave=0-1 anon=14 dirty=14 mapmax=15 N0=8 N1=6</font></div><div><font size="2"  >1324f000 interleave=0-1 heap anon=241 dirty=241 mapmax=15 N0=122 N1=119</font></div><div><font size="2"  >3213000000 interleave=0-1 file=/lib64/ld-2.5.so mapped=7 mapmax=62 N0=7</font></div><div><font size="2"  >321321b000 interleave=0-1 file=/lib64/ld-2.5.so anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >321321c000 interleave=0-1 file=/lib64/ld-2.5.so anon=1 dirty=1 N0=1</font></div><div><font size="2"  >3213400000 interleave=0-1 file=/lib64/libc-2.5.so mapped=79 mapmax=72 N0=76 N1=3</font></div><div><font size="2"  >321354e000 interleave=0-1 file=/lib64/libc-2.5.so</font></div><div><font size="2"  >321374d000 interleave=0-1 file=/lib64/libc-2.5.so anon=2 dirty=2 mapped=4 mapmax=48 N0=3 N1=1</font></div><div><font size="2"  >3213751000 interleave=0-1 file=/lib64/libc-2.5.so anon=1 dirty=1 N1=1</font></div><div><font size="2"  >3213752000 interleave=0-1 anon=5 dirty=5 mapmax=14 N0=3 N1=2</font></div><div><font size="2"  >3213800000 interleave=0-1 file=/lib64/libdl-2.5.so mapped=1 mapmax=36 N0=1</font></div><div><font size="2"  >3213802000 interleave=0-1 file=/lib64/libdl-2.5.so</font></div><div><font size="2"  >3213a02000 interleave=0-1 file=/lib64/libdl-2.5.so anon=1 dirty=1 mapmax=15 N0=1</font></div><div><font size="2"  >3213a03000 interleave=0-1 file=/lib64/libdl-2.5.so anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >3213c00000 interleave=0-1 file=/lib64/libm-2.5.so mapped=7 mapmax=25 N0=6 N1=1</font></div><div><font size="2"  >3213c82000 interleave=0-1 file=/lib64/libm-2.5.so</font></div><div><font size="2"  >3213e81000 interleave=0-1 file=/lib64/libm-2.5.so anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >3213e82000 interleave=0-1 file=/lib64/libm-2.5.so anon=1 dirty=1 mapmax=15 N0=1</font></div><div><font size="2"  >3214400000 interleave=0-1 file=/usr/lib64/libz.so.1.2.3</font></div><div><font size="2"  >3214414000 interleave=0-1 file=/usr/lib64/libz.so.1.2.3</font></div><div><font size="2"  >3214613000 interleave=0-1 file=/usr/lib64/libz.so.1.2.3 anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >3214c00000 interleave=0-1 file=/lib64/libselinux.so.1</font></div><div><font size="2"  >3214c15000 interleave=0-1 file=/lib64/libselinux.so.1</font></div><div><font size="2"  >3214e15000 interleave=0-1 file=/lib64/libselinux.so.1 anon=2 dirty=2 mapmax=15 N0=1 N1=1</font></div><div><font size="2"  >3214e17000 interleave=0-1 anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >3215000000 interleave=0-1 file=/lib64/libsepol.so.1</font></div><div><font size="2"  >321503b000 interleave=0-1 file=/lib64/libsepol.so.1</font></div><div><font size="2"  >321523b000 interleave=0-1 file=/lib64/libsepol.so.1 anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >321523c000 interleave=0-1</font></div><div><font size="2"  >3217400000 interleave=0-1 file=/lib64/libcom_err.so.2.1</font></div><div><font size="2"  >3217402000 interleave=0-1 file=/lib64/libcom_err.so.2.1</font></div><div><font size="2"  >3217601000 interleave=0-1 file=/lib64/libcom_err.so.2.1 anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >3217800000 interleave=0-1 file=/lib64/libresolv-2.5.so</font></div><div><font size="2"  >3217811000 interleave=0-1 file=/lib64/libresolv-2.5.so</font></div><div><font size="2"  >3217a11000 interleave=0-1 file=/lib64/libresolv-2.5.so anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >3217a12000 interleave=0-1 file=/lib64/libresolv-2.5.so anon=1 dirty=1 mapmax=15 N0=1</font></div><div><font size="2"  >3217a13000 interleave=0-1</font></div><div><font size="2"  >3217c00000 interleave=0-1 file=/usr/lib64/libxml2.so.2.6.26 mapped=3 mapmax=18 N0=3</font></div><div><font size="2"  >3217d33000 interleave=0-1 file=/usr/lib64/libxml2.so.2.6.26</font></div><div><font size="2"  >3217f33000 interleave=0-1 file=/usr/lib64/libxml2.so.2.6.26 anon=4 dirty=4 mapped=5 mapmax=19 N0=3 N1=2</font></div><div><font size="2"  >3217f3c000 interleave=0-1</font></div><div><font size="2"  >3218c00000 interleave=0-1 file=/lib64/libcrypto.so.0.9.8e mapped=2 mapmax=25 N0=2</font></div><div><font size="2"  >3218d2d000 interleave=0-1 file=/lib64/libcrypto.so.0.9.8e</font></div><div><font size="2"  >3218f2c000 interleave=0-1 file=/lib64/libcrypto.so.0.9.8e anon=3 dirty=3 mapped=5 mapmax=23 N0=4 N1=1</font></div><div><font size="2"  >3218f4d000 interleave=0-1 anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >3219c00000 interleave=0-1 file=/usr/lib64/libkrb5support.so.0.1</font></div><div><font size="2"  >3219c08000 interleave=0-1 file=/usr/lib64/libkrb5support.so.0.1</font></div><div><font size="2"  >3219e07000 interleave=0-1 file=/usr/lib64/libkrb5support.so.0.1 anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >321a800000 interleave=0-1 file=/lib64/libkeyutils-1.2.so</font></div><div><font size="2"  >321a802000 interleave=0-1 file=/lib64/libkeyutils-1.2.so</font></div><div><font size="2"  >321aa01000 interleave=0-1 file=/lib64/libkeyutils-1.2.so anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >321bc00000 interleave=0-1 file=/usr/lib64/libk5crypto.so.3.1</font></div><div><font size="2"  >321bc24000 interleave=0-1 file=/usr/lib64/libk5crypto.so.3.1</font></div><div><font size="2"  >321be23000 interleave=0-1 file=/usr/lib64/libk5crypto.so.3.1 anon=2 dirty=2 mapmax=15 N0=1 N1=1</font></div><div><font size="2"  >321d600000 interleave=0-1 file=/usr/lib64/libgssapi_krb5.so.2.2</font></div><div><font size="2"  >321d62c000 interleave=0-1 file=/usr/lib64/libgssapi_krb5.so.2.2</font></div><div><font size="2"  >321d82c000 interleave=0-1 file=/usr/lib64/libgssapi_krb5.so.2.2 anon=2 dirty=2 mapmax=15 N0=1 N1=1</font></div><div><font size="2"  >321da00000 interleave=0-1 file=/usr/lib64/libkrb5.so.3.3</font></div><div><font size="2"  >321da91000 interleave=0-1 file=/usr/lib64/libkrb5.so.3.3</font></div><div><font size="2"  >321dc91000 interleave=0-1 file=/usr/lib64/libkrb5.so.3.3 anon=3 dirty=3 mapped=4 mapmax=23 N0=3 N1=1</font></div><div><font size="2"  >321fa00000 interleave=0-1 file=/lib64/libssl.so.0.9.8e mapped=1 mapmax=21 N0=1</font></div><div><font size="2"  >321fa46000 interleave=0-1 file=/lib64/libssl.so.0.9.8e</font></div><div><font size="2"  >321fc46000 interleave=0-1 file=/lib64/libssl.so.0.9.8e anon=3 dirty=3 mapmax=15 N0=1 N1=2</font></div><div><font size="2"  >3220600000 interleave=0-1 file=/lib64/libaudit.so.0.0.0</font></div><div><font size="2"  >3220617000 interleave=0-1 file=/lib64/libaudit.so.0.0.0</font></div><div><font size="2"  >3220816000 interleave=0-1 file=/lib64/libaudit.so.0.0.0 anon=2 dirty=2 mapmax=15 N0=1 N1=1</font></div><div><font size="2"  >3221200000 interleave=0-1 file=/lib64/libpam.so.0.81.5 mapped=1 mapmax=25 N0=1</font></div><div><font size="2"  >322120b000 interleave=0-1 file=/lib64/libpam.so.0.81.5</font></div><div><font size="2"  >322140a000 interleave=0-1 file=/lib64/libpam.so.0.81.5 anon=1 dirty=1 mapmax=15 N0=1</font></div><div><font size="2"  >3225e00000 interleave=0-1 file=/lib64/libcrypt-2.5.so mapped=1 mapmax=27 N0=1</font></div><div><font size="2"  >3225e09000 interleave=0-1 file=/lib64/libcrypt-2.5.so</font></div><div><font size="2"  >3226008000 interleave=0-1 file=/lib64/libcrypt-2.5.so anon=1 dirty=1 mapmax=15 N0=1</font></div><div><font size="2"  >3226009000 interleave=0-1 file=/lib64/libcrypt-2.5.so anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >322600a000 interleave=0-1</font></div><div><font size="2"  >3228600000 interleave=0-1 file=/usr/lib64/libxslt.so.1.1.17 mapped=1 mapmax=16 N0=1</font></div><div><font size="2"  >3228634000 interleave=0-1 file=/usr/lib64/libxslt.so.1.1.17</font></div><div><font size="2"  >3228833000 interleave=0-1 file=/usr/lib64/libxslt.so.1.1.17 anon=2 dirty=2 mapmax=15 N0=1 N1=1</font></div><div><font size="2"  >2b0e25caf000 interleave=0-1 anon=10 dirty=10 mapmax=15 N0=5 N1=5</font></div><div><font size="2"  >2b0e25cb9000 interleave=0-1 file=/usr/lib/locale/locale-archive mapped=1 mapmax=22 N1=1</font></div><div><font size="2"  >2b0e2928b000 interleave=0-1 file=/opt/pgsql/lib/pg_stat_statements.so mapped=5 mapmax=9 N0=3 N1=2</font></div><div><font size="2"  >2b0e29291000 interleave=0-1 file=/opt/pgsql/lib/pg_stat_statements.so</font></div><div><font size="2"  >2b0e29490000 interleave=0-1 file=/opt/pgsql/lib/pg_stat_statements.so anon=1 dirty=1 N1=1</font></div><div><font size="2"  >2b0e29491000 default file=/SYSV001d4fe9\040(deleted) dirty=377404 mapmax=13 active=377361 N0=222419 N1=154985</font></div><div><font size="2"  >2b0eb0447000 interleave=0-1 file=/lib64/libnss_files-2.5.so</font></div><div><font size="2"  >2b0eb0451000 interleave=0-1 file=/lib64/libnss_files-2.5.so</font></div><div><font size="2"  >2b0eb0650000 interleave=0-1 file=/lib64/libnss_files-2.5.so anon=1 dirty=1 mapmax=14 N1=1</font></div><div><font size="2"  >2b0eb0651000 interleave=0-1 file=/lib64/libnss_files-2.5.so anon=1 dirty=1 mapmax=14 N0=1</font></div><div><font size="2"  >2b0eb0652000 interleave=0-1 anon=291 dirty=291 N0=146 N1=145</font></div><div><font size="2"  >2b0eb07b5000 interleave=0-1 anon=38 dirty=38 N0=19 N1=19</font></div><div><font size="2"  >7fffbf894000 interleave=0-1 stack anon=15 dirty=15 mapmax=15 N0=8 N1=7</font></div><p></p></pre></div><div><br></div><div>-- 压力测试结果</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@172_16_3_52-&gt; pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -U digoal -r -T 60 -c 8 -j 8 digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: prepared</font></div><div><font size="2"  >number of clients: 8</font></div><div><font size="2"  >number of threads: 8</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 4528118</font></div><div><font size="2"  >tps = 75467.159208 (including connections establishing)</font></div><div><font size="2"  >tps = 75481.596039 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.002557 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 50000000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.100864 &nbsp; &nbsp; &nbsp; &nbsp;select * from digoal.user_info where id=:id;</font></div><p></p></pre></div><div><br></div><div>-- 记录压力测试结束后的numastat</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@172_16_3_52 opt]# numastat&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node1</font></div><div><font size="2"  >numa_hit &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;10842819 &nbsp; &nbsp; &nbsp; &nbsp; 9083010</font></div><div><font size="2"  >numa_miss &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1478811 &nbsp; &nbsp; &nbsp; &nbsp; 2394678</font></div><div><font size="2"  >numa_foreign &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2394678 &nbsp; &nbsp; &nbsp; &nbsp; 1478811</font></div><div><font size="2"  >interleave_hit &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;946319 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;347903</font></div><div><font size="2"  >local_node &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;10599278 &nbsp; &nbsp; &nbsp; &nbsp; 8254638</font></div><div><font size="2"  >other_node &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1722352 &nbsp; &nbsp; &nbsp; &nbsp; 3223050</font></div><p></p></pre></div></div><div>-- 根据差异可以看出default模式下, numa_hit,&nbsp; <span style="line-height: 22px;"  >interleave_hit,&nbsp;</span>local_node, other_node都有分布.</div><div><br></div><div>三、localalloc</div><div>-- 首先把数据库关掉</div><div><div><pre class="prettyprint"  ><p><font size="2"  >pg_ctl stop -m fast</font></p></pre></div><div>-- 清除OS缓存, 以清理分配出去的内存.</div><div><pre class="prettyprint"  ><p><font size="2"  >echo 3 &gt; /proc/sys/vm/drop_caches</font></p></pre></div><div>-- 启动数据库, 注意此时选择numa策略<span style="line-height: 22px;"  >localalloc</span></div><div><pre class="prettyprint"  ><p><font size="2"  >postgres@172_16_3_52-&gt; numactl --localalloc pg_ctl start</font></p></pre></div><div>-- 查看默认情况下postgres进程的numa策略</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@172_16_3_52 opt]# ps -ewf|grep postgres</font></div><div><font size="2"  >root &nbsp; &nbsp; 29400 29047 &nbsp;0 12:04 pts/1 &nbsp; &nbsp;00:00:00 su - postgres</font></div><div><font size="2"  >postgres 29401 29400 &nbsp;0 12:04 pts/1 &nbsp; &nbsp;00:00:00 -bash</font></div><div><font size="2"  >postgres 29930 &nbsp; &nbsp; 1 &nbsp;1 12:40 pts/1 &nbsp; &nbsp;00:00:00 /opt/pgsql/bin/postgres</font></div><div><font size="2"  >postgres 29931 29930 &nbsp;0 12:40 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: logger process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 29933 29930 &nbsp;0 12:40 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: writer process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 29934 29930 &nbsp;0 12:40 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: checkpointer process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 29935 29930 &nbsp;0 12:40 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: wal writer process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 29936 29930 &nbsp;0 12:40 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: autovacuum launcher process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 29937 29930 &nbsp;0 12:40 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: stats collector process &nbsp;&nbsp;</font></div><div><font size="2"  >root &nbsp; &nbsp; 29939 28774 &nbsp;0 12:40 pts/0 &nbsp; &nbsp;00:00:00 grep postgres</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >[root@172_16_3_52 opt]# cat /proc/29930/numa_maps&nbsp;</font></div><div><font size="2"  >00400000 prefer file=/opt/pgsql/bin/postgres mapped=237 mapmax=7 active=149 N0=219 N1=18</font></div><div><font size="2"  >00aeb000 prefer file=/opt/pgsql/bin/postgres anon=14 dirty=14 mapmax=7 N0=12 N1=2</font></div><div><font size="2"  >00af9000 prefer anon=12 dirty=12 mapmax=7 N0=10 N1=2</font></div><div><font size="2"  >15aa5000 prefer heap anon=37 dirty=37 mapmax=7 N0=36 N1=1</font></div><div><font size="2"  >3213000000 prefer file=/lib64/ld-2.5.so mapped=25 mapmax=53 N0=25</font></div><div><font size="2"  >321321b000 prefer file=/lib64/ld-2.5.so anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >321321c000 prefer file=/lib64/ld-2.5.so anon=1 dirty=1 N0=1</font></div><div><font size="2"  >3213400000 prefer file=/lib64/libc-2.5.so mapped=121 mapmax=63 N0=116 N1=5</font></div><div><font size="2"  >321354e000 prefer file=/lib64/libc-2.5.so</font></div><div><font size="2"  >321374d000 prefer file=/lib64/libc-2.5.so anon=2 dirty=2 mapped=4 mapmax=39 N0=2 N1=2</font></div><div><font size="2"  >3213751000 prefer file=/lib64/libc-2.5.so anon=1 dirty=1 N0=1</font></div><div><font size="2"  >3213752000 prefer anon=5 dirty=5 mapmax=7 N0=4 N1=1</font></div><div><font size="2"  >3213800000 prefer file=/lib64/libdl-2.5.so mapped=2 mapmax=27 N0=2</font></div><div><font size="2"  >3213802000 prefer file=/lib64/libdl-2.5.so</font></div><div><font size="2"  >3213a02000 prefer file=/lib64/libdl-2.5.so anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >3213a03000 prefer file=/lib64/libdl-2.5.so anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >3213c00000 prefer file=/lib64/libm-2.5.so mapped=6 mapmax=16 active=5 N0=6</font></div><div><font size="2"  >3213c82000 prefer file=/lib64/libm-2.5.so</font></div><div><font size="2"  >3213e81000 prefer file=/lib64/libm-2.5.so anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >3213e82000 prefer file=/lib64/libm-2.5.so anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >3214400000 prefer file=/usr/lib64/libz.so.1.2.3 mapped=4 mapmax=10 N0=4</font></div><div><font size="2"  >3214414000 prefer file=/usr/lib64/libz.so.1.2.3</font></div><div><font size="2"  >3214613000 prefer file=/usr/lib64/libz.so.1.2.3 anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >3214c00000 prefer file=/lib64/libselinux.so.1 mapped=11 mapmax=15 N0=11</font></div><div><font size="2"  >3214c15000 prefer file=/lib64/libselinux.so.1</font></div><div><font size="2"  >3214e15000 prefer file=/lib64/libselinux.so.1 anon=2 dirty=2 mapmax=7 N1=2</font></div><div><font size="2"  >3214e17000 prefer anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >3215000000 prefer file=/lib64/libsepol.so.1 mapped=5 mapmax=12 N0=5</font></div><div><font size="2"  >321503b000 prefer file=/lib64/libsepol.so.1</font></div><div><font size="2"  >321523b000 prefer file=/lib64/libsepol.so.1 anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >321523c000 prefer</font></div><div><font size="2"  >3217400000 prefer file=/lib64/libcom_err.so.2.1 mapped=2 mapmax=6 N0=2</font></div><div><font size="2"  >3217402000 prefer file=/lib64/libcom_err.so.2.1</font></div><div><font size="2"  >3217601000 prefer file=/lib64/libcom_err.so.2.1 anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >3217800000 prefer file=/lib64/libresolv-2.5.so mapped=5 mapmax=9 N0=5</font></div><div><font size="2"  >3217811000 prefer file=/lib64/libresolv-2.5.so</font></div><div><font size="2"  >3217a11000 prefer file=/lib64/libresolv-2.5.so anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >3217a12000 prefer file=/lib64/libresolv-2.5.so anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >3217a13000 prefer</font></div><div><font size="2"  >3217c00000 prefer file=/usr/lib64/libxml2.so.2.6.26 mapped=25 mapmax=9 N0=25</font></div><div><font size="2"  >3217d33000 prefer file=/usr/lib64/libxml2.so.2.6.26</font></div><div><font size="2"  >3217f33000 prefer file=/usr/lib64/libxml2.so.2.6.26 anon=4 dirty=4 mapped=5 mapmax=10 N0=1 N1=4</font></div><div><font size="2"  >3217f3c000 prefer</font></div><div><font size="2"  >3218c00000 prefer file=/lib64/libcrypto.so.0.9.8e mapped=26 mapmax=16 N0=26</font></div><div><font size="2"  >3218d2d000 prefer file=/lib64/libcrypto.so.0.9.8e</font></div><div><font size="2"  >3218f2c000 prefer file=/lib64/libcrypto.so.0.9.8e anon=3 dirty=3 mapped=5 mapmax=14 N0=2 N1=3</font></div><div><font size="2"  >3218f4d000 prefer anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >3219c00000 prefer file=/usr/lib64/libkrb5support.so.0.1 mapped=4 mapmax=5 N0=4</font></div><div><font size="2"  >3219c08000 prefer file=/usr/lib64/libkrb5support.so.0.1</font></div><div><font size="2"  >3219e07000 prefer file=/usr/lib64/libkrb5support.so.0.1 anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >321a800000 prefer file=/lib64/libkeyutils-1.2.so mapped=2 mapmax=5 N0=2</font></div><div><font size="2"  >321a802000 prefer file=/lib64/libkeyutils-1.2.so</font></div><div><font size="2"  >321aa01000 prefer file=/lib64/libkeyutils-1.2.so anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >321bc00000 prefer file=/usr/lib64/libk5crypto.so.3.1 mapped=7 mapmax=6 N0=7</font></div><div><font size="2"  >321bc24000 prefer file=/usr/lib64/libk5crypto.so.3.1</font></div><div><font size="2"  >321be23000 prefer file=/usr/lib64/libk5crypto.so.3.1 anon=2 dirty=2 mapmax=7 N1=2</font></div><div><font size="2"  >321d600000 prefer file=/usr/lib64/libgssapi_krb5.so.2.2 mapped=10 mapmax=6 N0=10</font></div><div><font size="2"  >321d62c000 prefer file=/usr/lib64/libgssapi_krb5.so.2.2</font></div><div><font size="2"  >321d82c000 prefer file=/usr/lib64/libgssapi_krb5.so.2.2 anon=2 dirty=2 mapmax=7 N1=2</font></div><div><font size="2"  >321da00000 prefer file=/usr/lib64/libkrb5.so.3.3 mapped=22 mapmax=6 N0=22</font></div><div><font size="2"  >321da91000 prefer file=/usr/lib64/libkrb5.so.3.3</font></div><div><font size="2"  >321dc91000 prefer file=/usr/lib64/libkrb5.so.3.3 anon=3 dirty=3 mapped=4 mapmax=14 N0=1 N1=3</font></div><div><font size="2"  >321fa00000 prefer file=/lib64/libssl.so.0.9.8e mapped=13 mapmax=12 N0=13</font></div><div><font size="2"  >321fa46000 prefer file=/lib64/libssl.so.0.9.8e</font></div><div><font size="2"  >321fc46000 prefer file=/lib64/libssl.so.0.9.8e anon=3 dirty=3 mapmax=7 N1=3</font></div><div><font size="2"  >3220600000 prefer file=/lib64/libaudit.so.0.0.0 mapped=4 mapmax=10 N1=4</font></div><div><font size="2"  >3220617000 prefer file=/lib64/libaudit.so.0.0.0</font></div><div><font size="2"  >3220816000 prefer file=/lib64/libaudit.so.0.0.0 anon=2 dirty=2 mapmax=7 N1=2</font></div><div><font size="2"  >3221200000 prefer file=/lib64/libpam.so.0.81.5 mapped=4 mapmax=16 N0=4</font></div><div><font size="2"  >322120b000 prefer file=/lib64/libpam.so.0.81.5</font></div><div><font size="2"  >322140a000 prefer file=/lib64/libpam.so.0.81.5 anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >3225e00000 prefer file=/lib64/libcrypt-2.5.so mapped=2 mapmax=18 N0=2</font></div><div><font size="2"  >3225e09000 prefer file=/lib64/libcrypt-2.5.so</font></div><div><font size="2"  >3226008000 prefer file=/lib64/libcrypt-2.5.so anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >3226009000 prefer file=/lib64/libcrypt-2.5.so anon=1 dirty=1 mapmax=7 N1=1</font></div><div><font size="2"  >322600a000 prefer</font></div><div><font size="2"  >3228600000 prefer file=/usr/lib64/libxslt.so.1.1.17 mapped=11 mapmax=7 N0=11</font></div><div><font size="2"  >3228634000 prefer file=/usr/lib64/libxslt.so.1.1.17</font></div><div><font size="2"  >3228833000 prefer file=/usr/lib64/libxslt.so.1.1.17 anon=2 dirty=2 mapmax=7 N1=2</font></div><div><font size="2"  >2b680f8a9000 prefer anon=10 dirty=10 mapmax=7 N0=3 N1=7</font></div><div><font size="2"  >2b680f8b3000 prefer file=/usr/lib/locale/locale-archive mapped=10 mapmax=14 N1=10</font></div><div><font size="2"  >2b6812e85000 prefer file=/opt/pgsql/lib/pg_stat_statements.so mapped=6 active=3 N0=6</font></div><div><font size="2"  >2b6812e8b000 prefer file=/opt/pgsql/lib/pg_stat_statements.so</font></div><div><font size="2"  >2b681308a000 prefer file=/opt/pgsql/lib/pg_stat_statements.so anon=1 dirty=1 mapmax=7 N0=1</font></div><div><font size="2"  >2b681308b000 default file=/SYSV001d4fe9\040(deleted) dirty=22976 mapmax=5 active=523 N0=22976</font></div><div><font size="2"  >2b689a041000 prefer file=/lib64/libnss_files-2.5.so mapped=5 mapmax=23 N1=5</font></div><div><font size="2"  >2b689a04b000 prefer file=/lib64/libnss_files-2.5.so</font></div><div><font size="2"  >2b689a24a000 prefer file=/lib64/libnss_files-2.5.so anon=1 dirty=1 mapmax=6 N0=1</font></div><div><font size="2"  >2b689a24b000 prefer file=/lib64/libnss_files-2.5.so anon=1 dirty=1 mapmax=6 N0=1</font></div><div><font size="2"  >7fff95625000 prefer stack anon=14 dirty=14 mapmax=7 N0=12 N1=2</font></div><p></p></pre></div><div>-- 记录下当前的numastat, 在执行完pgbench后再来比对一下统计数据的差异.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@172_16_3_52 opt]# numastat</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node1</font></div><div><font size="2"  >numa_hit &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;10873847 &nbsp; &nbsp; &nbsp; &nbsp; 9086591</font></div><div><font size="2"  >numa_miss &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1478811 &nbsp; &nbsp; &nbsp; &nbsp; 2394678</font></div><div><font size="2"  >numa_foreign &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2394678 &nbsp; &nbsp; &nbsp; &nbsp; 1478811</font></div><div><font size="2"  >interleave_hit &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;947891 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;349529</font></div><div><font size="2"  >local_node &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;10628874 &nbsp; &nbsp; &nbsp; &nbsp; 8257857</font></div><div><font size="2"  >other_node &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1723784 &nbsp; &nbsp; &nbsp; &nbsp; 3223412</font></div><p></p></pre></div><div>-- 加载数据至内存</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >select pgfadvise_willneed('pg_toast.'||relname) from pg_class where oid in (select reltoastrelid from pg_class where relname='user_info');</font></div><div><font size="2"  >select * from pgfadvise_willneed('digoal.user_info');</font></div><div><font size="2"  >select * from pgfadvise_willneed('digoal.user_info_pkey');</font></div><p></p></pre></div><div>-- 开始使用pgbench压</div><div><pre class="prettyprint"  ><p><font size="2"  >pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -U digoal -r -T 60 -c 8 -j 8 digoal</font></p></pre></div><div><br></div><div>-- 查看backend process的numa策略, 和主进程一样</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@172_16_3_52 opt]# ps -ewf|grep postgres</font></div><div><font size="2"  >root &nbsp; &nbsp; 29400 29047 &nbsp;0 12:04 pts/1 &nbsp; &nbsp;00:00:00 su - postgres</font></div><div><font size="2"  >postgres 29401 29400 &nbsp;0 12:04 pts/1 &nbsp; &nbsp;00:00:00 -bash</font></div><div><font size="2"  >postgres 29930 &nbsp; &nbsp; 1 &nbsp;0 12:40 pts/1 &nbsp; &nbsp;00:00:00 /opt/pgsql/bin/postgres</font></div><div><font size="2"  >postgres 29931 29930 &nbsp;0 12:40 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: logger process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 29933 29930 &nbsp;0 12:40 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: writer process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 29934 29930 &nbsp;0 12:40 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: checkpointer process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 29935 29930 &nbsp;0 12:40 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: wal writer process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 29936 29930 &nbsp;0 12:40 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: autovacuum launcher process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 29937 29930 &nbsp;0 12:40 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 postgres: stats collector process &nbsp;&nbsp;</font></div><div><font size="2"  >postgres 29951 29401 99 12:42 pts/1 &nbsp; &nbsp;00:00:13 pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -U digoal -r -T 60 -c 8 -j 8 digoal</font></div><div><font size="2"  >postgres 29960 29930 76 12:42 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:06 postgres: digoal digoal 127.0.0.1(44156) SELECT</font></div><div><font size="2"  >postgres 29961 29930 75 12:42 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:06 postgres: digoal digoal 127.0.0.1(44157) SELECT</font></div><div><font size="2"  >postgres 29962 29930 75 12:42 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:06 postgres: digoal digoal 127.0.0.1(44158) idle</font></div><div><font size="2"  >postgres 29963 29930 75 12:42 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:06 postgres: digoal digoal 127.0.0.1(44159) BIND</font></div><div><font size="2"  >postgres 29964 29930 74 12:42 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:05 postgres: digoal digoal 127.0.0.1(44160) SELECT</font></div><div><font size="2"  >postgres 29965 29930 75 12:42 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:06 postgres: digoal digoal 127.0.0.1(44161) idle</font></div><div><font size="2"  >postgres 29966 29930 75 12:42 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:06 postgres: digoal digoal 127.0.0.1(44162) SELECT</font></div><div><font size="2"  >postgres 29967 29930 75 12:42 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:06 postgres: digoal digoal 127.0.0.1(44163) idle</font></div><div><font size="2"  >root &nbsp; &nbsp; 29969 28774 &nbsp;0 12:42 pts/0 &nbsp; &nbsp;00:00:00 grep postgres</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >[root@172_16_3_52 opt]# cat /proc/29960/numa_maps&nbsp;</font></div><div><font size="2"  >00400000 prefer file=/opt/pgsql/bin/postgres mapped=425 mapmax=15 active=424 N0=411 N1=14</font></div><div><font size="2"  >00aeb000 prefer file=/opt/pgsql/bin/postgres anon=14 dirty=14 mapmax=15 N0=14</font></div><div><font size="2"  >00af9000 prefer anon=14 dirty=14 mapmax=15 N0=13 N1=1</font></div><div><font size="2"  >15aa5000 prefer heap anon=241 dirty=241 mapmax=15 N0=229 N1=12</font></div><div><font size="2"  >3213000000 prefer file=/lib64/ld-2.5.so mapped=7 mapmax=62 N0=7</font></div><div><font size="2"  >321321b000 prefer file=/lib64/ld-2.5.so anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >321321c000 prefer file=/lib64/ld-2.5.so anon=1 dirty=1 N0=1</font></div><div><font size="2"  >3213400000 prefer file=/lib64/libc-2.5.so mapped=79 mapmax=72 N0=77 N1=2</font></div><div><font size="2"  >321354e000 prefer file=/lib64/libc-2.5.so</font></div><div><font size="2"  >321374d000 prefer file=/lib64/libc-2.5.so anon=2 dirty=2 mapped=4 mapmax=48 N0=2 N1=2</font></div><div><font size="2"  >3213751000 prefer file=/lib64/libc-2.5.so anon=1 dirty=1 N0=1</font></div><div><font size="2"  >3213752000 prefer anon=5 dirty=5 mapmax=14 N0=5</font></div><div><font size="2"  >3213800000 prefer file=/lib64/libdl-2.5.so mapped=1 mapmax=36 N0=1</font></div><div><font size="2"  >3213802000 prefer file=/lib64/libdl-2.5.so</font></div><div><font size="2"  >3213a02000 prefer file=/lib64/libdl-2.5.so anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >3213a03000 prefer file=/lib64/libdl-2.5.so anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >3213c00000 prefer file=/lib64/libm-2.5.so mapped=7 mapmax=25 N0=7</font></div><div><font size="2"  >3213c82000 prefer file=/lib64/libm-2.5.so</font></div><div><font size="2"  >3213e81000 prefer file=/lib64/libm-2.5.so anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >3213e82000 prefer file=/lib64/libm-2.5.so anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >3214400000 prefer file=/usr/lib64/libz.so.1.2.3</font></div><div><font size="2"  >3214414000 prefer file=/usr/lib64/libz.so.1.2.3</font></div><div><font size="2"  >3214613000 prefer file=/usr/lib64/libz.so.1.2.3 anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >3214c00000 prefer file=/lib64/libselinux.so.1</font></div><div><font size="2"  >3214c15000 prefer file=/lib64/libselinux.so.1</font></div><div><font size="2"  >3214e15000 prefer file=/lib64/libselinux.so.1 anon=2 dirty=2 mapmax=15 N1=2</font></div><div><font size="2"  >3214e17000 prefer anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >3215000000 prefer file=/lib64/libsepol.so.1</font></div><div><font size="2"  >321503b000 prefer file=/lib64/libsepol.so.1</font></div><div><font size="2"  >321523b000 prefer file=/lib64/libsepol.so.1 anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >321523c000 prefer</font></div><div><font size="2"  >3217400000 prefer file=/lib64/libcom_err.so.2.1</font></div><div><font size="2"  >3217402000 prefer file=/lib64/libcom_err.so.2.1</font></div><div><font size="2"  >3217601000 prefer file=/lib64/libcom_err.so.2.1 anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >3217800000 prefer file=/lib64/libresolv-2.5.so</font></div><div><font size="2"  >3217811000 prefer file=/lib64/libresolv-2.5.so</font></div><div><font size="2"  >3217a11000 prefer file=/lib64/libresolv-2.5.so anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >3217a12000 prefer file=/lib64/libresolv-2.5.so anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >3217a13000 prefer</font></div><div><font size="2"  >3217c00000 prefer file=/usr/lib64/libxml2.so.2.6.26 mapped=3 mapmax=18 N0=3</font></div><div><font size="2"  >3217d33000 prefer file=/usr/lib64/libxml2.so.2.6.26</font></div><div><font size="2"  >3217f33000 prefer file=/usr/lib64/libxml2.so.2.6.26 anon=4 dirty=4 mapped=5 mapmax=19 N0=1 N1=4</font></div><div><font size="2"  >3217f3c000 prefer</font></div><div><font size="2"  >3218c00000 prefer file=/lib64/libcrypto.so.0.9.8e mapped=2 mapmax=25 N0=2</font></div><div><font size="2"  >3218d2d000 prefer file=/lib64/libcrypto.so.0.9.8e</font></div><div><font size="2"  >3218f2c000 prefer file=/lib64/libcrypto.so.0.9.8e anon=3 dirty=3 mapped=5 mapmax=23 N0=2 N1=3</font></div><div><font size="2"  >3218f4d000 prefer anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >3219c00000 prefer file=/usr/lib64/libkrb5support.so.0.1</font></div><div><font size="2"  >3219c08000 prefer file=/usr/lib64/libkrb5support.so.0.1</font></div><div><font size="2"  >3219e07000 prefer file=/usr/lib64/libkrb5support.so.0.1 anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >321a800000 prefer file=/lib64/libkeyutils-1.2.so</font></div><div><font size="2"  >321a802000 prefer file=/lib64/libkeyutils-1.2.so</font></div><div><font size="2"  >321aa01000 prefer file=/lib64/libkeyutils-1.2.so anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >321bc00000 prefer file=/usr/lib64/libk5crypto.so.3.1</font></div><div><font size="2"  >321bc24000 prefer file=/usr/lib64/libk5crypto.so.3.1</font></div><div><font size="2"  >321be23000 prefer file=/usr/lib64/libk5crypto.so.3.1 anon=2 dirty=2 mapmax=15 N1=2</font></div><div><font size="2"  >321d600000 prefer file=/usr/lib64/libgssapi_krb5.so.2.2</font></div><div><font size="2"  >321d62c000 prefer file=/usr/lib64/libgssapi_krb5.so.2.2</font></div><div><font size="2"  >321d82c000 prefer file=/usr/lib64/libgssapi_krb5.so.2.2 anon=2 dirty=2 mapmax=15 N1=2</font></div><div><font size="2"  >321da00000 prefer file=/usr/lib64/libkrb5.so.3.3</font></div><div><font size="2"  >321da91000 prefer file=/usr/lib64/libkrb5.so.3.3</font></div><div><font size="2"  >321dc91000 prefer file=/usr/lib64/libkrb5.so.3.3 anon=3 dirty=3 mapped=4 mapmax=23 N0=1 N1=3</font></div><div><font size="2"  >321fa00000 prefer file=/lib64/libssl.so.0.9.8e mapped=1 mapmax=21 N0=1</font></div><div><font size="2"  >321fa46000 prefer file=/lib64/libssl.so.0.9.8e</font></div><div><font size="2"  >321fc46000 prefer file=/lib64/libssl.so.0.9.8e anon=3 dirty=3 mapmax=15 N1=3</font></div><div><font size="2"  >3220600000 prefer file=/lib64/libaudit.so.0.0.0</font></div><div><font size="2"  >3220617000 prefer file=/lib64/libaudit.so.0.0.0</font></div><div><font size="2"  >3220816000 prefer file=/lib64/libaudit.so.0.0.0 anon=2 dirty=2 mapmax=15 N1=2</font></div><div><font size="2"  >3221200000 prefer file=/lib64/libpam.so.0.81.5 mapped=1 mapmax=25 N0=1</font></div><div><font size="2"  >322120b000 prefer file=/lib64/libpam.so.0.81.5</font></div><div><font size="2"  >322140a000 prefer file=/lib64/libpam.so.0.81.5 anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >3225e00000 prefer file=/lib64/libcrypt-2.5.so mapped=1 mapmax=27 N0=1</font></div><div><font size="2"  >3225e09000 prefer file=/lib64/libcrypt-2.5.so</font></div><div><font size="2"  >3226008000 prefer file=/lib64/libcrypt-2.5.so anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >3226009000 prefer file=/lib64/libcrypt-2.5.so anon=1 dirty=1 mapmax=15 N1=1</font></div><div><font size="2"  >322600a000 prefer</font></div><div><font size="2"  >3228600000 prefer file=/usr/lib64/libxslt.so.1.1.17 mapped=1 mapmax=16 N0=1</font></div><div><font size="2"  >3228634000 prefer file=/usr/lib64/libxslt.so.1.1.17</font></div><div><font size="2"  >3228833000 prefer file=/usr/lib64/libxslt.so.1.1.17 anon=2 dirty=2 mapmax=15 N1=2</font></div><div><font size="2"  >2b680f8a9000 prefer anon=10 dirty=10 mapmax=15 N0=3 N1=7</font></div><div><font size="2"  >2b680f8b3000 prefer file=/usr/lib/locale/locale-archive mapped=1 mapmax=22 N1=1</font></div><div><font size="2"  >2b6812e85000 prefer file=/opt/pgsql/lib/pg_stat_statements.so mapped=5 mapmax=9 N0=5</font></div><div><font size="2"  >2b6812e8b000 prefer file=/opt/pgsql/lib/pg_stat_statements.so</font></div><div><font size="2"  >2b681308a000 prefer file=/opt/pgsql/lib/pg_stat_statements.so anon=1 dirty=1 N0=1</font></div><div><font size="2"  >2b681308b000 default file=/SYSV001d4fe9\040(deleted) dirty=386644 mapmax=13 active=386616 N0=69913 N1=316731</font></div><div><font size="2"  >2b689a041000 prefer file=/lib64/libnss_files-2.5.so</font></div><div><font size="2"  >2b689a04b000 prefer file=/lib64/libnss_files-2.5.so</font></div><div><font size="2"  >2b689a24a000 prefer file=/lib64/libnss_files-2.5.so anon=1 dirty=1 mapmax=14 N0=1</font></div><div><font size="2"  >2b689a24b000 prefer file=/lib64/libnss_files-2.5.so anon=1 dirty=1 mapmax=14 N0=1</font></div><div><font size="2"  >2b689a24c000 prefer anon=291 dirty=291 N0=108 N1=183</font></div><div><font size="2"  >2b689a3af000 prefer anon=38 dirty=38 N0=30 N1=8</font></div><div><font size="2"  >7fff95625000 prefer stack anon=15 dirty=15 mapmax=15 N0=14 N1=1</font></div><p></p></pre></div><div><br></div><div>-- 压力测试结果</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@172_16_3_52-&gt; pgbench -M prepared -n -f ./sel.sql -h 127.0.0.1 -U digoal -r -T 60 -c 8 -j 8 digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: prepared</font></div><div><font size="2"  >number of clients: 8</font></div><div><font size="2"  >number of threads: 8</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 4578902</font></div><div><font size="2"  >tps = 76312.188161 (including connections establishing)</font></div><div><font size="2"  >tps = 76319.864699 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.002567 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 50000000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.099755 &nbsp; &nbsp; &nbsp; &nbsp;select * from digoal.user_info where id=:id;</font></div><p></p></pre></div><div><br></div><div>-- 记录压力测试结束后的numastat</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[root@172_16_3_52 opt]# numastat&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;node0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node1</font></div><div><font size="2"  >numa_hit &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;11872269 &nbsp; &nbsp; &nbsp; &nbsp; 9371136</font></div><div><font size="2"  >numa_miss &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1478811 &nbsp; &nbsp; &nbsp; &nbsp; 2597359</font></div><div><font size="2"  >numa_foreign &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2597359 &nbsp; &nbsp; &nbsp; &nbsp; 1478811</font></div><div><font size="2"  >interleave_hit &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;947899 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;349538</font></div><div><font size="2"  >local_node &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;11627295 &nbsp; &nbsp; &nbsp; &nbsp; 8542373</font></div><div><font size="2"  >other_node &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1723785 &nbsp; &nbsp; &nbsp; &nbsp; 3426122</font></div><p></p></pre></div></div><div>-- 根据差异可以看出default模式下, numa_hit, &nbsp;numa_foreign, local_node 都有分布.</div><div><br></div><div>【小结】</div><div>1. 测试结果来看, NUMA策略性能分布 : &nbsp;localalloc &gt; interleave &gt; default .</div><div>但是瓶颈出现在了CPU处, 所以差别微小, 与预期相符.</div><div>2. 更新的测试下一篇BLOG再写.</div><div><br></div><div>【参考】</div><div>numactl command</div><div>numastat command</div><div><a target="_blank" rel="nofollow" href="http://en.wikipedia.org/wiki/Non-Uniform_Memory_Access"  >http://en.wikipedia.org/wiki/Non-Uniform_Memory_Access</a></div><div><a href="http://blog.163.com/digoal@126/blog/static/1638770402011625104031947/"  >http://blog.163.com/digoal@126/blog/static/1638770402011625104031947/</a> </div></div>
	</div>
</div>
</body>
</html>