<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL standby in 64bit to 32bit or reverse enviroment</h2>
	<h5 id="">2012-06-19 12:39:25&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402012519104435953/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">64和32位系统上安装的PostgreSQL能不能做流复制搭建standby.<br><wbr><div><br></div><div>今天问同事借了一台32位的机器测试一下.</div><div>测试环境 :&nbsp;</div><div>CentOS 5.x 32bit 和64bit 各一台.</div><div>PostgreSQL 9.1.4源码</div><div>32bit 作为primary</div><div>64bit 作为standby</div><div>结果是可行的, 只是需要在64bit上使用32bit的pgsql程序.</div><div>而反过来则不行(64bit primary , 32bit standby).</div><div>说白了, 程序要兼容. 在这种环境中建standby, 程序必须都是32bit的. 因为OS 64bit可以跑32bit的程序, 而OS 32bit 不能跑64bit的程序.</div><div><br></div><div>1. 配置OS</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >yum install -y lrzsz</font></div><div><font size="2"   >yum install -y sysstat</font></div><div><font size="2"   >yum install -y e4fsprogs</font></div><div><font size="2"   >yum install -y ntp</font></div><div><font size="2"   >yum install -y readline-devel</font></div><div><font size="2"   >yum install -y zlib</font></div><div><font size="2"   >yum install -y zlib-devel</font></div><div><font size="2"   >yum install -y openssl</font></div><div><font size="2"   >yum install -y openssl-devel</font></div><div><font size="2"   >yum install -y pam-devel</font></div><div><font size="2"   >yum install -y libxml2-devel</font></div><div><font size="2"   >yum install -y libxslt-devel</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >/usr/sbin/ntpdate asia.pool.ntp.org &amp;&amp; /sbin/hwclock --systohc</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >-- 临时关闭防火墙, 生产中则配置一下, 开放互访监听端口</font></div><div><font size="2"   >service iptables stop</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >vi /etc/sysctl.conf</font></div><div><font size="2"   >kernel.shmmni = 4096</font></div><div><font size="2"   >kernel.sem = 50100 64128000 50100 1280</font></div><div><font size="2"   >fs.file-max = 7672460</font></div><div><font size="2"   >net.ipv4.ip_local_port_range = 9000 65000</font></div><div><font size="2"   >net.core.rmem_default = 1048576</font></div><div><font size="2"   >net.core.rmem_max = 4194304</font></div><div><font size="2"   >net.core.wmem_default = 262144</font></div><div><font size="2"   >net.core.wmem_max = 1048576</font></div><div><font size="2"   >net.ipv4.tcp_tw_recycle = 1</font></div><div><font size="2"   >net.ipv4.tcp_max_syn_backlog = 4096</font></div><div><font size="2"   >net.core.netdev_max_backlog = 10000</font></div><div><font size="2"   >vm.overcommit_memory = 0</font></div><div><font size="2"   >net.ipv4.ip_conntrack_max = 655360</font></div><div><font size="2"   >fs.aio-max-nr = 1048576</font></div><div><font size="2"   >net.ipv4.tcp_timestamps = 0</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >sysctl -p</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >vi /etc/security/limits.conf</font></div><div><font size="2"   >* soft &nbsp; &nbsp;nofile &nbsp;131072</font></div><div><font size="2"   >* hard &nbsp; &nbsp;nofile &nbsp;131072</font></div><div><font size="2"   >* soft &nbsp; &nbsp;nproc &nbsp; 131072</font></div><div><font size="2"   >* hard &nbsp; &nbsp;nproc &nbsp; 131072</font></div><div><font size="2"   >* soft &nbsp; &nbsp;core &nbsp; &nbsp;unlimited</font></div><div><font size="2"   >* hard &nbsp; &nbsp;core &nbsp; &nbsp;unlimited</font></div><div><font size="2"   >* soft &nbsp; &nbsp;memlock 50000000</font></div><div><font size="2"   >* hard &nbsp; &nbsp;memlock 50000000</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >vi /etc/sysconfig/selinux</font></div><div><font size="2"   >SELINUX=disabled</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >cd /data03/soft_bak</font></div><div><font size="2"   >tar -jxvf flex-2.5.35.tar.bz2</font></div><div><font size="2"   >cd flex-2.5.35</font></div><div><font size="2"   >./configure &amp;&amp; make &amp;&amp; make install</font></div></div><p></p></pre></div><div><br></div><div>32位机器上</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >useradd platform32</font></div><div><font size="2"   >vi /home/platform32/.bash_profile</font></div><div><div><font size="2"   >export PGPORT=1616</font></div><div><font size="2"   >export PGDATA=/home/platform32/pg_root</font></div><div><font size="2"   >export LANG=en_US.utf8</font></div><div><font size="2"   >export PGHOME=/home/platform32/pgsql</font></div><div><font size="2"   >export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib</font></div><div><font size="2"   >export DATE=`date +"%Y%m%d%H%M"`</font></div><div><font size="2"   >export PATH=$PGHOME/bin:$PATH:.</font></div><div><font size="2"   >export MANPATH=$PGHOME/share/man:$MANPATH</font></div><div><font size="2"   >alias rm='rm -i'</font></div><div><font size="2"   >alias ll='ls -lh'</font></div></div><p></p></pre></div><div><br></div><div>64位机器上</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >useradd platform64</font></div><div><font size="2"   ><span style="line-height: 22px;"   >vi /home/platform64/.bash_profile</span> </font></div><div><div><font size="2"   >export PGPORT=1616</font></div><div><font size="2"   >export PGDATA=/home/platform64/pg_root</font></div><div><font size="2"   >export LANG=en_US.utf8</font></div><div><font size="2"   >export PGHOME=/home/platform64/pgsql</font></div><div><font size="2"   >export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib</font></div><div><font size="2"   >export DATE=`date +"%Y%m%d%H%M"`</font></div><div><font size="2"   >export PATH=$PGHOME/bin:$PATH:.</font></div><div><font size="2"   >export MANPATH=$PGHOME/share/man:$MANPATH</font></div><div><font size="2"   >alias rm='rm -i'</font></div><div><font size="2"   >alias ll='ls -lh'</font></div></div><p></p></pre></div><div><br></div><div>2. 编译安装PostgreSQL 9.1.4</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >64位机器</font></div><div><font size="2"   >./configure --prefix=/home/platform64/pgsql --with-pgport=1616 --with-perl --with-openssl --with-pam --without-ldap --with-libxml --with-libxslt --enable-thread-safety --with-wal-blocksize=16 &amp;&amp; gmake world</font></div><div><font size="2"   >sudo gmake install-world</font></div><div><font size="2"   ><br></font></div><div><div style="line-height: 22px;"   ><font size="2"   >32位机器</font></div><div style="line-height: 22px;"   ><font size="2"   >./configure --prefix=/home/platform32/pgsql --with-pgport=1616 --with-perl --with-openssl --with-pam --without-ldap --with-libxml --with-libxslt --enable-thread-safety --with-wal-blocksize=16 &amp;&amp; gmake world</font></div></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >sudo gmake install-world</font></span></div><p></p></pre></div><div><br></div><div>3. 在32bit 机器上初始化数据库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >initdb -D $PGDATA -E UTF8 --locale=C -U postgres -W</font></div><div><font size="2"   >vi pg_hba.conf</font></div><div><div><font size="2"   >host &nbsp; &nbsp;replication &nbsp; &nbsp; replica &nbsp; &nbsp; &nbsp; &nbsp;192.168.101.35/32 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; md5</font></div><div><font size="2"   >host all all 0.0.0.0/0 md5</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >vi postgresql.conf</font></div><div><font size="2"   >listen_addresses = '0.0.0.0'</font></div><div><font size="2"   >port = 1616</font></div><div><font size="2"   >max_connections = 100</font></div><div><font size="2"   >shared_buffers = 1024MB</font></div><div><font size="2"   >maintenance_work_mem = 512MB</font></div><div><font size="2"   >max_stack_depth = 8MB</font></div><div><font size="2"   >wal_level = hot_standby</font></div><div><font size="2"   >checkpoint_segments = 32</font></div><div><font size="2"   >max_wal_senders = 32</font></div><div><font size="2"   >wal_sender_delay = 10ms</font></div><div><font size="2"   >wal_keep_segments = 64</font></div><div><font size="2"   >hot_standby = on</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >pg_ctl start</font></div><div><font size="2"   >psql -h 127.0.0.1 postgres postgres</font></div><div><font size="2"   >create role replica nosuperuser nocreatedb nocreaterole noinherit login replication connection limit 32 encrypted password 'REPLICA';</font></div><div><font size="2"   ><br></font></div><div><div style="line-height: 22px;"   ><font size="2"   >vi /home/platform32/.pgpass</font></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >192.168.101.66:1616:replication:replica:REPLICA</font></div><div style="line-height: 22px;"   ><font size="2"   >192.168.101.35:1616:replication:replica:REPLICA</font></div></div><div style="line-height: 22px;"   ><font size="2"   >chmod 400&nbsp;<span style="line-height: 22px;"   >/home/platform32/.pgpass</span></font></div></div><p></p></pre></div><div><br></div><div>4. 配置standby</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi /home/platform64/.pgpass</font></div><div><div><font size="2"   >192.168.101.66:1616:replication:replica:REPLICA</font></div><div><font size="2"   >192.168.101.35:1616:replication:replica:REPLICA</font></div></div><div><font size="2"   >chmod 400&nbsp;<span style="line-height: 22px;"   >/home/platform64/.pgpass</span></font></div><div><span style="line-height: 22px;"   ><font size="2"   ><br></font></span></div><div><span style="line-height: 22px;"   ><font size="2"   >vi $PGDATA/recovery.conf</font></span></div><div><font size="2"   >recovery_target_timeline = 'latest'</font></div><div><font size="2"   >standby_mode = on</font></div><div><font size="2"   >primary_conninfo = 'host=192.168.101.66 port=1616 user=replica keepalives_idle=60'</font></div><div><font size="2"   >trigger_file = '/home/platform64/pg_root/.1616.PG.trigger'</font></div><p></p></pre></div><div><br></div><div>5. 初始化standby</div><div><pre class="prettyprint"   ><p><font size="2"   >pg_basebackup -D $PGDATA -F p -x -l base -P -v -h 192.168.101.66 -p 1616 -U replica</font></p></pre></div><div><br></div><div>6. 启动standby</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg_ctl start</font></div><div><font size="2"   >报错</font></div><div><font size="2"   >FATAL: &nbsp;incorrect checksum in control file</font></div><p></p></pre></div><div><br></div><div>7. 修改pg_controlfile的checksum源码, 不check.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi&nbsp;src/backend/access/transam/xlog.c</font></div><div><font size="2"   >注释checksum部分</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* if (!EQ_CRC32(crc, ControlFile-&gt;crc))</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(FATAL,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errmsg("incorrect checksum in control file")));</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; */</font></div></div><p></p></pre></div><div><br></div><div>8. 重新编译standby端的pgsql</div><div>略</div><div><br></div><div>9. 重新启动standby, 报另一个错误</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >FATAL: &nbsp;database files are incompatible with server</font></div><div><font size="2"   >DETAIL: &nbsp;The database cluster was initialized with MAXALIGN 1093850759, but the server was compiled with MAXALIGN 8.</font></div><div><font size="2"   >HINT: &nbsp;It looks like you need to initdb.</font></div><p></p></pre></div><div><br></div><div>在控制文件差别 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >32 位机器的控制文件信息 :&nbsp;</font></div><div><font size="2"   >Maximum data alignment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4</font></div><div><font size="2"   >Maximum size of a TOAST chunk: &nbsp; &nbsp; &nbsp; &nbsp;2000</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >64 位机器(initdb 后)的控制文件信息 :&nbsp;</font></div><div><font size="2"   >Maximum data alignment: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 8</font></div><div><font size="2"   >Maximum size of a TOAST chunk: &nbsp; &nbsp; &nbsp; &nbsp;1996</font></div><p></p></pre></div><div>在<span style="font-family: monospace; font-size: small; line-height: 19px; white-space: pre;"   >src/backend/access/transam/xlog.c这里面有很多的check, 不一一列出.</span></div><div><span style="font-family: monospace; font-size: small; line-height: 19px; white-space: pre;"   >要在64 bit的机器上使用到底应该怎么办呢?</span></div><div><span style="font-family: monospace; font-size: small; line-height: 19px; white-space: pre;"   >其实和程序有关系, 只要把32bit 上编译的pgsql程序拷贝过来就可以了</span></div><div><span style="font-family: monospace; font-size: small; line-height: 19px; white-space: pre;"   ><br></span></div><div><span style="font-family: monospace; font-size: small; line-height: 19px; white-space: pre;"   >10. 在64bit的机器上使用32bit的pgsql做standby .</span></div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 19px;"   ><font size="2"   >scp -r root@32bit:/home/platform32/pgsql /home/platform64/</font></span></div><div><span style="line-height: 19px;"   ><font size="2"   >pg_ctl start</font></span></div><p></p></pre></div><div><font face="monospace"   size="2"   ><span style="line-height: 19px; white-space: pre;"   >在primary上插入测试数据 : </span></font></div><div><pre class="prettyprint"   ><p><font size="2"   >[platform32@192_168_101_66 pg_root]$ psql postgres postgres -h 127.0.0.1 psql (9.1.4) Type "help" for help.  postgres=# \dt         List of relations  Schema | Name | Type  |  Owner    --------+------+-------+----------  public | t    | table | postgres (1 row)  postgres=# create table test (id int); CREATE TABLE postgres=# insert into test select generate_series (1,10000); INSERT 0 10000</font></p></pre></div><div><font face="monospace"   size="2"   ><span style="line-height: 19px; white-space: pre;"   >在standby上验证 : </span></font></div><div><font face="monospace"   size="2"   ><div style="line-height: 19px; white-space: pre;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 19px;"   >[platform64@db-192-168-101-35 ~]$ psql -h 127.0.0.1 postgres postgres</div><div style="line-height: 19px;"   >psql (9.1.4)</div><div style="line-height: 19px;"   >Type "help" for help.</div><div style="line-height: 19px;"   ><br></div><div style="line-height: 19px;"   >postgres=# select count(*) from test;</div><div style="line-height: 19px;"   >&nbsp;count&nbsp;</div><div style="line-height: 19px;"   >-------</div><div style="line-height: 19px;"   >&nbsp;10000</div><div style="line-height: 19px;"   >(1 row)</div><p></p></pre></div><div style="line-height: 19px; white-space: pre;"   ><br></div><div style="line-height: 19px; white-space: pre;"   >11. 那么反过来行不行呢? 在32bit的机器上允许64bit的程序?</div><div style="line-height: 19px; white-space: pre;"   >显然是不行的</div><div><pre class="prettyprint"   ><p></p><div>[platform32@192_168_101_66 ~]$ pg_ctl --help -bash: /home/platform32/pgsql/bin/pg_ctl: cannot execute binary file</div><div>[platform32@192_168_101_66 ~]$ postgres --help -bash: /home/platform32/pgsql/bin/postgres: cannot execute binary file</div><p></p></pre></div></font></div><div><span style="font-family: monospace; font-size: small; line-height: 19px; white-space: pre;"   ><br></span></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL standby in 64bit to 32bit or reverse enviroment - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>