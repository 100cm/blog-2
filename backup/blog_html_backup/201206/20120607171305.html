<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL seqscan performance affected by blockdev's readahead</h2>
	<h5 id="">2012-06-07 17:13:05&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020125741631670/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>昨天一位群里的兄弟在问怎么优化大表全表扫描的性能, 刚好昨天做了一下这方面的测试.</div><div>目标是测试块设备的预读的大小和读取速度的关系.</div><div>大表全表扫描和读取速度息息相关.</div><div>测试环境 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >PostgreSQL 9.2 beta2</font></div><div><font size="2"  >CentOS 5.x 64位</font></div><div><font size="2"  >DELL R610</font></div><div><font size="2"  >6块2.5寸 SAS146G RAID5</font></div><div><font size="2"  >RAID bus controller: LSI Logic / Symbios Logic MegaRAID SAS 1078</font></div><p></p></pre></div><div><br></div><div>测试表 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@172_16_3_52-&gt; psql digoal digoal</font></div><div><font size="2"  >psql (9.2beta2)</font></div><div><font size="2"  >Type "help" for help.</font></div><div><font size="2"  >digoal=&gt; drop table user_info;</font></div><div><font size="2"  >creaDROP TABLE</font></div><div><font size="2"  >digoal=&gt; create table read_ahead_test (id int,info text);</font></div><div><font size="2"  >CREATE TABLE</font></div><div><font size="2"  >digoal=&gt; alter table read_ahead_test alter column info set storage plain;</font></div><div><font size="2"  >ALTER TABLE</font></div><div><font size="2"  >\c digoal postgres</font></div><div><font size="2"  >digoal=# insert into digoal.read_ahead_test select generate_series(1,50000000),repeat('digoal',100);</font></div><div><font size="2"  >digoal=# select * from pgfadvise_dontneed('digoal.read_ahead_test');</font></div><div><font size="2"  >digoal=# checkpoint;</font></div><p></p></pre></div><div><br></div><div>测试SQL :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >date +%F%T</font></div><div><font size="2"  >psql digoal digoal -c "copy digoal.read_ahead_test to stdout" &gt;/dev/null</font></div><div><font size="2"  >date +%F%T</font></div><p></p></pre></div><div>计算耗时.</div><div><br></div><div>一、测试Linux的blockdev设置的预读和设备读取速度的关系.</div><div>1. 测试前, 关闭RAID卡读写缓存 (这个一般在RAID卡的BIOS中配置), 以免给测试带来干扰.</div><div>no read ahead</div><div>write through</div><div>2. 测试过程中记得刷掉OS cache以免影响测试结果</div><div><br></div><div>接下来开始测试, 默认的块设备的readahead是256个扇区.</div><div>分别测试一下增加readahead后, 读取速度和全表扫描的速度.</div><div>测试的表的表空间放在/dev/sda的分区上.</div><div><br></div><div>-- ra=256的测试和结果 :&nbsp;</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ># blockdev --getra /dev/sda</font></div><div><font size="2"  >256</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >$ pg_ctl stop -m fast</font></div><div><font size="2"  ># echo 3 &gt; /proc/sys/vm/drop_caches</font></div><div><font size="2"  >$ pg_ctl start</font></div><div><font size="2"  >$ date +%F%T</font></div><div><font size="2"  >$ psql digoal digoal -c "copy digoal.read_ahead_test to stdout" &gt;/dev/null</font></div><div><font size="2"  >$ date +%F%T</font></div><div><font size="2"  ><span style="line-height: 22px;"  >全表扫描时间 :</span><span style="line-height: 22px;"  >&nbsp;</span>26秒</font></div><div><font size="2"  >$ vmstat -n 3</font></div><div><font size="2"  >procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu------</font></div><div><font size="2"  >&nbsp;r &nbsp;b &nbsp; swpd &nbsp; free &nbsp; buff &nbsp;cache &nbsp; si &nbsp; so &nbsp; &nbsp;bi &nbsp; &nbsp;bo &nbsp; in &nbsp; cs us sy id wa st</font></div><div><font size="2"  >&nbsp;1 &nbsp;0 &nbsp; &nbsp;188 2930180 &nbsp; 1528 1011088 &nbsp; &nbsp;0 &nbsp; &nbsp;0 102016 &nbsp; 104 1830 24390 &nbsp;6 &nbsp;2 88 &nbsp;4 &nbsp;0</font></div><div><font size="2"  >&nbsp;0 &nbsp;1 &nbsp; &nbsp;188 2587740 &nbsp; 1536 1353056 &nbsp; &nbsp;0 &nbsp; &nbsp;0 113920 &nbsp; &nbsp; 5 1905 26957 &nbsp;7 &nbsp;2 87 &nbsp;3 &nbsp;0</font></div><div><font size="2"  >&nbsp;1 &nbsp;0 &nbsp; &nbsp;188 2174068 &nbsp; 1536 1765536 &nbsp; &nbsp;0 &nbsp; &nbsp;0 137557 &nbsp; &nbsp; 0 2083 32173 &nbsp;8 &nbsp;3 88 &nbsp;2 &nbsp;0</font></div><div><font size="2"  >&nbsp;1 &nbsp;0 &nbsp; &nbsp;188 1840024 &nbsp; 1544 2098788 &nbsp; &nbsp;0 &nbsp; &nbsp;0 111104 &nbsp; &nbsp; 4 1890 26290 &nbsp;7 &nbsp;2 87 &nbsp;4 &nbsp;0</font></div><div><font size="2"  >&nbsp;0 &nbsp;1 &nbsp; &nbsp;188 1496740 &nbsp; 1548 2441304 &nbsp; &nbsp;0 &nbsp; &nbsp;0 114177 &nbsp; &nbsp; 0 1904 26963 &nbsp;7 &nbsp;2 88 &nbsp;3 &nbsp;0</font></div><div><font size="2"  >&nbsp;0 &nbsp;1 &nbsp; &nbsp;188 1085888 &nbsp; 1556 2851280 &nbsp; &nbsp;0 &nbsp; &nbsp;0 136619 &nbsp; &nbsp; 5 2082 31962 &nbsp;8 &nbsp;3 87 &nbsp;2 &nbsp;0</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >-- ra=512的测试和结果 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ># blockdev --setra 512 /dev/sda</font></div><div><font size="2"  ><br></font></div><div><div style="line-height: 22px;"  ><font size="2"  >$ pg_ctl stop -m fast</font></div><div style="line-height: 22px;"  ><font size="2"  ># echo 3 &gt; /proc/sys/vm/drop_caches</font></div><div style="line-height: 22px;"  ><font size="2"  >$ pg_ctl start</font></div><div style="line-height: 22px;"  ><font size="2"  >$ date +%F%T</font></div><div style="line-height: 22px;"  ><font size="2"  >$ psql digoal digoal -c "copy digoal.read_ahead_test to stdout" &gt;/dev/null</font></div><div style="line-height: 22px;"  ><font size="2"  >$ date +%F%T</font></div></div><div><font size="2"  ><span style="line-height: 22px;"  >全表扫描时间 :</span><span style="line-height: 22px;"  >&nbsp;</span>24秒</font></div><div><font size="2"  >vmstat -n 3</font></div><div><font size="2"  >procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu------</font></div><div><font size="2"  >&nbsp;r &nbsp;b &nbsp; swpd &nbsp; free &nbsp; buff &nbsp;cache &nbsp; si &nbsp; so &nbsp; &nbsp;bi &nbsp; &nbsp;bo &nbsp; in &nbsp; cs us sy id wa st</font></div><div><font size="2"  >&nbsp;1 &nbsp;0 &nbsp; &nbsp;188 2708512 &nbsp; 1048 1232908 &nbsp; &nbsp;0 &nbsp; &nbsp;0 127404 &nbsp; &nbsp; 0 1522 29901 &nbsp;8 &nbsp;2 88 &nbsp;3 &nbsp;0</font></div><div><font size="2"  >&nbsp;1 &nbsp;0 &nbsp; &nbsp;188 2306600 &nbsp; 1064 1634088 &nbsp; &nbsp;0 &nbsp; &nbsp;0 133632 &nbsp; &nbsp;16 1548 31367 &nbsp;8 &nbsp;2 88 &nbsp;2 &nbsp;0</font></div><div><font size="2"  >&nbsp;1 &nbsp;0 &nbsp; &nbsp;188 1890836 &nbsp; 1064 2048856 &nbsp; &nbsp;0 &nbsp; &nbsp;0 138325 &nbsp; &nbsp; 0 1560 32336 &nbsp;8 &nbsp;3 87 &nbsp;2 &nbsp;0</font></div><div><font size="2"  >&nbsp;1 &nbsp;0 &nbsp; &nbsp;188 1510464 &nbsp; 1076 2428276 &nbsp; &nbsp;0 &nbsp; &nbsp;0 126465 &nbsp; &nbsp; 4 1524 29733 &nbsp;8 &nbsp;2 88 &nbsp;3 &nbsp;0</font></div><div><font size="2"  >&nbsp;1 &nbsp;0 &nbsp; &nbsp;188 1062712 &nbsp; 1084 2875064 &nbsp; &nbsp;0 &nbsp; &nbsp;0 148907 &nbsp; &nbsp; 5 1597 34697 &nbsp;9 &nbsp;3 88 &nbsp;1 &nbsp;0</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >-- ra=1024的测试和结果 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >blockdev --setra 1024 /dev/sda</font></div><div><font size="2"  ><br></font></div><div><div style="line-height: 22px;"  ><font size="2"  >$ pg_ctl stop -m fast</font></div><div style="line-height: 22px;"  ><font size="2"  ># echo 3 &gt; /proc/sys/vm/drop_caches</font></div><div style="line-height: 22px;"  ><font size="2"  >$ pg_ctl start</font></div><div style="line-height: 22px;"  ><font size="2"  >$ date +%F%T</font></div><div style="line-height: 22px;"  ><font size="2"  >$ psql digoal digoal -c "copy digoal.read_ahead_test to stdout" &gt;/dev/null</font></div><div style="line-height: 22px;"  ><font size="2"  >$ date +%F%T</font></div></div><div><font size="2"  ><span style="line-height: 22px;"  >全表扫描时间 :</span><span style="line-height: 22px;"  >&nbsp;</span>22秒</font></div><div><font size="2"  >vmstat -n 3</font></div><div><font size="2"  >procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu------</font></div><div><font size="2"  >&nbsp;r &nbsp;b &nbsp; swpd &nbsp; free &nbsp; buff &nbsp;cache &nbsp; si &nbsp; so &nbsp; &nbsp;bi &nbsp; &nbsp;bo &nbsp; in &nbsp; cs us sy id wa st</font></div><div><font size="2"  >&nbsp;1 &nbsp;0 &nbsp; &nbsp;188 2875852 &nbsp; 1644 1066280 &nbsp; &nbsp;0 &nbsp; &nbsp;0 143531 &nbsp; &nbsp;69 1584 33914 &nbsp;8 &nbsp;3 88 &nbsp;2 &nbsp;0</font></div><div><font size="2"  >&nbsp;1 &nbsp;0 &nbsp; &nbsp;188 2456600 &nbsp; 1648 1484564 &nbsp; &nbsp;0 &nbsp; &nbsp;0 139436 &nbsp; &nbsp;81 1572 32986 &nbsp;8 &nbsp;2 88 &nbsp;2 &nbsp;0</font></div><div><font size="2"  >&nbsp;1 &nbsp;0 &nbsp; &nbsp;188 1991844 &nbsp; 1656 1948576 &nbsp; &nbsp;0 &nbsp; &nbsp;0 154624 &nbsp; &nbsp; 5 1622 36508 &nbsp;9 &nbsp;3 87 &nbsp;1 &nbsp;0</font></div><div><font size="2"  >&nbsp;0 &nbsp;1 &nbsp; &nbsp;188 1613096 &nbsp; 1672 2326372 &nbsp; &nbsp;0 &nbsp; &nbsp;0 125953 &nbsp; &nbsp; 7 1505 29894 &nbsp;7 &nbsp;2 88 &nbsp;3 &nbsp;0</font></div><div><font size="2"  >&nbsp;2 &nbsp;0 &nbsp; &nbsp;188 1152740 &nbsp; 1676 2785708 &nbsp; &nbsp;0 &nbsp; &nbsp;0 153088 &nbsp; &nbsp; 1 1614 36147 &nbsp;9 &nbsp;3 88 &nbsp;1 &nbsp;0</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >-- ra=2048的测试和结果 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ># blockdev --setra 2048 /dev/sda</font></div><div><font size="2"  ><br></font></div><div><div style="line-height: 22px;"  ><font size="2"  >$ pg_ctl stop -m fast</font></div><div style="line-height: 22px;"  ><font size="2"  ># echo 3 &gt; /proc/sys/vm/drop_caches</font></div><div style="line-height: 22px;"  ><font size="2"  >$ pg_ctl start</font></div><div style="line-height: 22px;"  ><font size="2"  >$ date +%F%T</font></div><div style="line-height: 22px;"  ><font size="2"  >$ psql digoal digoal -c "copy digoal.read_ahead_test to stdout" &gt;/dev/null</font></div><div style="line-height: 22px;"  ><font size="2"  >$ date +%F%T</font></div></div><div><font size="2"  >全表扫描时间 : 20秒</font></div><div><font size="2"  ><span style="line-height: 22px;"  >#</span><span style="line-height: 22px;"  >&nbsp;</span>vmstat -n 3</font></div><div><font size="2"  >procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu------</font></div><div><font size="2"  >&nbsp;r &nbsp;b &nbsp; swpd &nbsp; free &nbsp; buff &nbsp;cache &nbsp; si &nbsp; so &nbsp; &nbsp;bi &nbsp; &nbsp;bo &nbsp; in &nbsp; cs us sy id wa st</font></div><div><font size="2"  >&nbsp;3 &nbsp;0 &nbsp; &nbsp;188 2589292 &nbsp; 1540 1352444 &nbsp; &nbsp;0 &nbsp; &nbsp;0 161111 &nbsp; &nbsp;71 1617 37631 &nbsp;9 &nbsp;3 88 &nbsp;1 &nbsp;0</font></div><div><font size="2"  >&nbsp;1 &nbsp;0 &nbsp; &nbsp;188 2082192 &nbsp; 1548 1858148 &nbsp; &nbsp;0 &nbsp; &nbsp;0 168619 &nbsp; &nbsp; 5 1653 39399 &nbsp;9 &nbsp;3 88 &nbsp;1 &nbsp;0</font></div><div><font size="2"  >&nbsp;1 &nbsp;0 &nbsp; &nbsp;188 1600960 &nbsp; 1552 2338564 &nbsp; &nbsp;0 &nbsp; &nbsp;0 160087 &nbsp; &nbsp; 0 1605 37485 &nbsp;9 &nbsp;3 88 &nbsp;1 &nbsp;0</font></div><div><font size="2"  >&nbsp;1 &nbsp;0 &nbsp; &nbsp;188 1112444 &nbsp; 1560 2825988 &nbsp; &nbsp;0 &nbsp; &nbsp;0 162475 &nbsp; &nbsp;64 1637 37953 &nbsp;9 &nbsp;3 88 &nbsp;1 &nbsp;0</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >-- ra=4096的测试和结果 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ><span style="line-height: 22px;"  >#</span><span style="line-height: 22px;"  >&nbsp;</span>blockdev --setra 4096 /dev/sda</font></div><div><font size="2"  ><br></font></div><div><div style="line-height: 22px;"  ><font size="2"  >$ pg_ctl stop -m fast</font></div><div style="line-height: 22px;"  ><font size="2"  ># echo 3 &gt; /proc/sys/vm/drop_caches</font></div><div style="line-height: 22px;"  ><font size="2"  >$ pg_ctl start</font></div><div style="line-height: 22px;"  ><font size="2"  >$ date +%F%T</font></div><div style="line-height: 22px;"  ><font size="2"  >$ psql digoal digoal -c "copy digoal.read_ahead_test to stdout" &gt;/dev/null</font></div><div style="line-height: 22px;"  ><font size="2"  >$ date +%F%T</font></div></div><div><font size="2"  ><span style="line-height: 22px;"  >全表扫描时间 :</span><span style="line-height: 22px;"  >&nbsp;</span>19秒</font></div><div><font size="2"  ><span style="line-height: 22px;"  >#</span><span style="line-height: 22px;"  >&nbsp;</span>vmstat -n 3</font></div><div><font size="2"  >procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu------</font></div><div><font size="2"  >&nbsp;r &nbsp;b &nbsp; swpd &nbsp; free &nbsp; buff &nbsp;cache &nbsp; si &nbsp; so &nbsp; &nbsp;bi &nbsp; &nbsp;bo &nbsp; in &nbsp; cs us sy id wa st</font></div><div><font size="2"  >&nbsp;1 &nbsp;0 &nbsp; &nbsp;188 2818292 &nbsp; 1524 1122932 &nbsp; &nbsp;0 &nbsp; &nbsp;0 171349 &nbsp; &nbsp;68 1602 39751 &nbsp;9 &nbsp;3 88 &nbsp;0 &nbsp;0</font></div><div><font size="2"  >&nbsp;1 &nbsp;0 &nbsp; &nbsp;188 2288724 &nbsp; 1524 1651320 &nbsp; &nbsp;0 &nbsp; &nbsp;0 176115 &nbsp; &nbsp; 0 1608 40758 10 &nbsp;3 88 &nbsp;0 &nbsp;0</font></div><div><font size="2"  >&nbsp;1 &nbsp;0 &nbsp; &nbsp;188 1769508 &nbsp; 1536 2169420 &nbsp; &nbsp;0 &nbsp; &nbsp;0 172716 &nbsp; &nbsp; 5 1606 40037 10 &nbsp;3 88 &nbsp;0 &nbsp;0</font></div><div><font size="2"  >&nbsp;1 &nbsp;0 &nbsp; &nbsp;188 1254188 &nbsp; 1544 2683504 &nbsp; &nbsp;0 &nbsp; &nbsp;0 171349 &nbsp; &nbsp;64 1592 39532 &nbsp;9 &nbsp;3 88 &nbsp;0 &nbsp;0</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >-- ra=8192的测试和结果 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ><span style="line-height: 22px;"  >#</span><span style="line-height: 22px;"  >&nbsp;</span>blockdev --setra 8192 /dev/sda</font></div><div><font size="2"  ><br></font></div><div><div style="line-height: 22px;"  ><font size="2"  >$ pg_ctl stop -m fast</font></div><div style="line-height: 22px;"  ><font size="2"  ># echo 3 &gt; /proc/sys/vm/drop_caches</font></div><div style="line-height: 22px;"  ><font size="2"  >$ pg_ctl start</font></div><div style="line-height: 22px;"  ><font size="2"  >$ date +%F%T</font></div><div style="line-height: 22px;"  ><font size="2"  >$ psql digoal digoal -c "copy digoal.read_ahead_test to stdout" &gt;/dev/null</font></div><div style="line-height: 22px;"  ><font size="2"  >$ date +%F%T</font></div></div><div><font size="2"  ><span style="line-height: 22px;"  >全表扫描时间 :</span><span style="line-height: 22px;"  >&nbsp;</span>18秒</font></div><div><font size="2"  ><span style="line-height: 22px;"  >#</span><span style="line-height: 22px;"  >&nbsp;</span>vmstat -n 3</font></div><div><font size="2"  >procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu------</font></div><div><font size="2"  >&nbsp;r &nbsp;b &nbsp; swpd &nbsp; free &nbsp; buff &nbsp;cache &nbsp; si &nbsp; so &nbsp; &nbsp;bi &nbsp; &nbsp;bo &nbsp; in &nbsp; cs us sy id wa st</font></div><div><font size="2"  >&nbsp;1 &nbsp;0 &nbsp; &nbsp;188 2548572 &nbsp; 1492 1393008 &nbsp; &nbsp;0 &nbsp; &nbsp;0 185687 &nbsp; &nbsp;69 1496 42820 11 &nbsp;5 84 &nbsp;0 &nbsp;0</font></div><div><font size="2"  >&nbsp;1 &nbsp;0 &nbsp; &nbsp;188 1982132 &nbsp; 1500 1958180 &nbsp; &nbsp;0 &nbsp; &nbsp;0 188416 &nbsp; &nbsp; 5 1588 43314 13 &nbsp;2 85 &nbsp;0 &nbsp;0</font></div><div><font size="2"  >&nbsp;1 &nbsp;0 &nbsp; &nbsp;188 1415632 &nbsp; 1504 2523504 &nbsp; &nbsp;0 &nbsp; &nbsp;0 188417 &nbsp; &nbsp; 0 1598 43302 12 &nbsp;2 85 &nbsp;0 &nbsp;0</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >-- ra=16384的测试和结果 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ><span style="line-height: 22px;"  >#</span><span style="line-height: 22px;"  >&nbsp;</span>blockdev --setra 16384 /dev/sda</font></div><div><font size="2"  ><br></font></div><div><div style="line-height: 22px;"  ><font size="2"  >$ pg_ctl stop -m fast</font></div><div style="line-height: 22px;"  ><font size="2"  ># echo 3 &gt; /proc/sys/vm/drop_caches</font></div><div style="line-height: 22px;"  ><font size="2"  >$ pg_ctl start</font></div><div style="line-height: 22px;"  ><font size="2"  >$ date +%F%T</font></div><div style="line-height: 22px;"  ><font size="2"  >$ psql digoal digoal -c "copy digoal.read_ahead_test to stdout" &gt;/dev/null</font></div><div style="line-height: 22px;"  ><font size="2"  >$ date +%F%T</font></div></div><div><font size="2"  ><span style="line-height: 22px;"  >全表扫描时间 :</span><span style="line-height: 22px;"  >&nbsp;</span>19秒</font></div><div><font size="2"  ><span style="line-height: 22px;"  >#</span><span style="line-height: 22px;"  >&nbsp;</span>vmstat -n 3</font></div><div><font size="2"  >procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu------</font></div><div><font size="2"  >&nbsp;r &nbsp;b &nbsp; swpd &nbsp; free &nbsp; buff &nbsp;cache &nbsp; si &nbsp; so &nbsp; &nbsp;bi &nbsp; &nbsp;bo &nbsp; in &nbsp; cs us sy id wa st</font></div><div><font size="2"  >&nbsp;2 &nbsp;0 &nbsp; &nbsp;188 2463192 &nbsp; 1484 1478880 &nbsp; &nbsp;0 &nbsp; &nbsp;0 180223 &nbsp; &nbsp; 0 1439 41479 10 &nbsp;3 87 &nbsp;0 &nbsp;0</font></div><div><font size="2"  >&nbsp;2 &nbsp;0 &nbsp; &nbsp;188 1896940 &nbsp; 1492 2044388 &nbsp; &nbsp;0 &nbsp; &nbsp;0 188416 &nbsp; &nbsp; 5 1346 43339 13 &nbsp;2 85 &nbsp;0 &nbsp;0</font></div><div><font size="2"  >&nbsp;1 &nbsp;0 &nbsp; &nbsp;188 1338660 &nbsp; 1496 2601364 &nbsp; &nbsp;0 &nbsp; &nbsp;0 185687 &nbsp; &nbsp;73 1457 43175 13 &nbsp;2 85 &nbsp;0 &nbsp;0</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >-- ra=32768的测试和结果 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ><span style="line-height: 22px;"  >#</span><span style="line-height: 22px;"  >&nbsp;</span>blockdev --setra 32768 /dev/sda</font></div><div><font size="2"  ><br></font></div><div><div style="line-height: 22px;"  ><font size="2"  >$ pg_ctl stop -m fast</font></div><div style="line-height: 22px;"  ><font size="2"  ># echo 3 &gt; /proc/sys/vm/drop_caches</font></div><div style="line-height: 22px;"  ><font size="2"  >$ pg_ctl start</font></div><div style="line-height: 22px;"  ><font size="2"  >$ date +%F%T</font></div><div style="line-height: 22px;"  ><font size="2"  >$ psql digoal digoal -c "copy digoal.read_ahead_test to stdout" &gt;/dev/null</font></div><div style="line-height: 22px;"  ><font size="2"  >$ date +%F%T</font></div></div><div><font size="2"  ><span style="line-height: 22px;"  >全表扫描时间 :</span><span style="line-height: 22px;"  >&nbsp;</span>18秒</font></div><div><font size="2"  ><span style="line-height: 22px;"  >#</span><span style="line-height: 22px;"  >&nbsp;</span>vmstat -n 3</font></div><div><font size="2"  >procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu------</font></div><div><font size="2"  >&nbsp;r &nbsp;b &nbsp; swpd &nbsp; free &nbsp; buff &nbsp;cache &nbsp; si &nbsp; so &nbsp; &nbsp;bi &nbsp; &nbsp;bo &nbsp; in &nbsp; cs us sy id wa st</font></div><div><font size="2"  >&nbsp;1 &nbsp;0 &nbsp; &nbsp;188 2569472 &nbsp; 1476 1371568 &nbsp; &nbsp;0 &nbsp; &nbsp;0 185687 &nbsp; 124 1412 42899 &nbsp;9 &nbsp;3 87 &nbsp;0 &nbsp;0</font></div><div><font size="2"  >&nbsp;1 &nbsp;0 &nbsp; &nbsp;188 2044076 &nbsp; 1484 1895808 &nbsp; &nbsp;0 &nbsp; &nbsp;0 174763 &nbsp; &nbsp; 5 1385 40608 10 &nbsp;3 87 &nbsp;0 &nbsp;0</font></div><div><font size="2"  >&nbsp;1 &nbsp;0 &nbsp; &nbsp;188 1518680 &nbsp; 1492 2420132 &nbsp; &nbsp;0 &nbsp; &nbsp;0 174764 &nbsp; &nbsp; 1 1388 40599 10 &nbsp;3 88 &nbsp;0 &nbsp;0</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >-- ra=327680的测试和结果 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ><span style="line-height: 22px;"  >#</span><span style="line-height: 22px;"  >&nbsp;</span>blockdev --setra 327680 /dev/sda</font></div><div><font size="2"  ><br></font></div><div><div style="line-height: 22px;"  ><font size="2"  >$ pg_ctl stop -m fast</font></div><div style="line-height: 22px;"  ><font size="2"  ># echo 3 &gt; /proc/sys/vm/drop_caches</font></div><div style="line-height: 22px;"  ><font size="2"  >$ pg_ctl start</font></div><div style="line-height: 22px;"  ><font size="2"  >$ date +%F%T</font></div><div style="line-height: 22px;"  ><font size="2"  >$ psql digoal digoal -c "copy digoal.read_ahead_test to stdout" &gt;/dev/null</font></div><div style="line-height: 22px;"  ><font size="2"  >$ date +%F%T</font></div></div><div><font size="2"  ><span style="line-height: 22px;"  >全表扫描时间 :</span><span style="line-height: 22px;"  >&nbsp;</span>24秒</font></div><div><font size="2"  ><span style="line-height: 22px;"  >#</span><span style="line-height: 22px;"  >&nbsp;</span>vmstat -n 3</font></div><div><font size="2"  >procs -----------memory---------- ---swap-- -----io---- --system-- -----cpu------</font></div><div><font size="2"  >&nbsp;r &nbsp;b &nbsp; swpd &nbsp; free &nbsp; buff &nbsp;cache &nbsp; si &nbsp; so &nbsp; &nbsp;bi &nbsp; &nbsp; &nbsp; bo &nbsp; in &nbsp; cs us sy id wa st</font></div><div><font size="2"  >&nbsp;0 &nbsp;1 &nbsp; &nbsp;188 2983212 &nbsp; 1444 906140 &nbsp; &nbsp; 0 &nbsp; &nbsp;0 146656 &nbsp; &nbsp; 0 1360 32821 &nbsp;8 &nbsp;2 88 &nbsp;3 &nbsp;0</font></div><div><font size="2"  >&nbsp;1 &nbsp;0 &nbsp; &nbsp;188 2829776 &nbsp; 1460 1110860 &nbsp; &nbsp;0 &nbsp; &nbsp;0 68160 &nbsp; &nbsp; 68 1245 36021 &nbsp;8 &nbsp;2 88 &nbsp;2 &nbsp;0</font></div><div><font size="2"  >&nbsp;3 &nbsp;0 &nbsp; &nbsp;188 2260452 &nbsp; 1472 1678712 &nbsp; &nbsp;0 &nbsp; &nbsp;0 189324 &nbsp; &nbsp; 5 1506 29839 &nbsp;7 &nbsp;2 88 &nbsp;3 &nbsp;0</font></div><div><font size="2"  >&nbsp;1 &nbsp;0 &nbsp; &nbsp;188 1778992 &nbsp; 1472 2159408 &nbsp; &nbsp;0 &nbsp; &nbsp;0 160203 &nbsp; &nbsp; 3 1442 30208 &nbsp;7 &nbsp;2 88 &nbsp;3 &nbsp;0</font></div><div><font size="2"  >&nbsp;2 &nbsp;0 &nbsp; &nbsp;188 1373900 &nbsp; 1488 2563432 &nbsp; &nbsp;0 &nbsp; &nbsp;0 134711 &nbsp; &nbsp; 5 1338 32042 &nbsp;8 &nbsp;2 88 &nbsp;3 &nbsp;0</font></div><div><font size="2"  >&nbsp;1 &nbsp;0 &nbsp; &nbsp;188 881388 &nbsp; &nbsp;1488 2944896 &nbsp; &nbsp;0 &nbsp; &nbsp;0 128165 &nbsp; &nbsp;13 1329 34959 &nbsp;8 &nbsp;2 87 &nbsp;2 &nbsp;0</font></div><div><font size="2"  >&nbsp;1 &nbsp;0 &nbsp; &nbsp;188 727952 &nbsp; &nbsp;1496 3207964 &nbsp; &nbsp;0 &nbsp; &nbsp;0 86656 &nbsp; &nbsp; 24 1294 36210 &nbsp;9 &nbsp;2 88 &nbsp;2 &nbsp;0</font></div><div><font size="2"  >&nbsp;0 &nbsp;0 &nbsp; &nbsp;188 541092 &nbsp; &nbsp;1508 3395564 &nbsp; &nbsp;0 &nbsp; &nbsp;0 62537 &nbsp; &nbsp; &nbsp;8 1170 16217 &nbsp;4 &nbsp;1 94 &nbsp;1 &nbsp;0</font></div><p></p></pre></div><div><br></div></div><div>二、RAID卡或存储控制器上的readahead和Linux下设置的readahead有同样效果.&nbsp;</div><div>测试略.</div><div><br></div><div>【小结】</div><div>1. 当RAID通道的速度不是瓶颈的时候,readahead加大是可以提升RAID的读取速度的. 但是当达到RAID通道的瓶颈后, 提升就不明显了.</div><div>2. readahead持续增加到达一定量的时候性能会出现拐点, 继续加大则会导致性能下降.</div><div>3. 本例选择COPY TO STDOUT重定向到/dev/null目的为降低OS CACHE对性能测试的影响.</div><div>4. OLTP系统不适合使用大的readahead, 更适合数据仓库系统. OLTP的特点是请求密集型, 每次IO的数据量是比较小的, 且离散的. 如果设置大的readahead 虽然读速度(每秒读取数据量MB)提高了, 但是必将影响OLTP系统的单次IO请求时间.&nbsp;</div></div>
	</div>
</div>
</body>
</html>