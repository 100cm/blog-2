<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">USE hstore store table's trace record</h2>
	<h5 id="">2012-06-25 10:59:11&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201252575529358/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>在数据库应用中，某些数据表的记录更改可能会需要跟踪，例如删除，新增，更新。</div><div>跟踪的信息包括：老的记录值，新的记录值，记录变更时间，哪个用户操作的等等。</div><div>在数据库中，跟踪可以通过触发器来做。</div><div>因为每个表的结构都不一样，要设计一个比较通用的存储跟踪记录的表的话，需要使用通用的存储类型，例如 text 类型，但是text类型存储的值未来要展现的话又比较费劲，还得根据表结构来抽取原来存储的变更信息，本文试图使用 hstore 类型来存储变更前后的row信息。并且使用hstore提供的each函数，可以很方便的取出原来存储的值。</div><div>测试 :&nbsp;</div><div>-- 创建需要被跟踪的测试表</div><div><div><pre class="prettyprint"   ><p><font size="2"   >CREATE TABLE test (id int primary key, info text, crt_time timestamp(0));</font></p></pre></div><div><br></div><div>-- 创建hstore extension;</div><div><pre class="prettyprint"   ><p><font size="2"   >CREATE EXTENSION hstore;</font></p></pre></div><div><br></div><div>-- 创建通用的存储跟踪记录的记录表</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE TABLE table_change_rec (</font></div><div><font size="2"   >id serial8 primary key,</font></div><div><font size="2"   >relid oid,</font></div><div><font size="2"   >table_schema text,</font></div><div><font size="2"   >table_name text,</font></div><div><font size="2"   >when_tg text,</font></div><div><font size="2"   >level text,</font></div><div><font size="2"   >op text,</font></div><div><font size="2"   >old_rec hstore,</font></div><div><font size="2"   >new_rec hstore,</font></div><div><font size="2"   >crt_time timestamp without time zone DEFAULT now(),</font></div><div><font size="2"   >username text,</font></div><div><font size="2"   >client_addr inet,<br>client_port int</font></div><div><font size="2"   >);</font></div><p></p></pre></div><div><br></div><div>-- 创建通用的触发器函数</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 19px;"   >CREATE OR REPLACE FUNCTION dml_trace()<br>RETURNS trigger<br>LANGUAGE plpgsql<br>AS $BODY$<br>DECLARE<br>v_new_rec hstore;<br>v_old_rec hstore;<br>v_username text := session_user;<br>v_client_addr inet := inet_client_addr();<br>v_client_port int := inet_client_port();<br>BEGIN<br>case TG_OP<br>when 'DELETE' then <br>  v_old_rec := hstore(OLD.*);<br>  insert into table_change_rec (relid, table_schema, table_name, when_tg, level, op, old_rec, username, client_addr, client_port)<br>    values (tg_relid, tg_table_schema, tg_table_name, tg_when, tg_level, tg_op, v_old_rec, v_username, v_client_addr, v_client_port);<br>when 'INSERT' then <br>  v_new_rec := hstore(NEW.*);<br>  insert into table_change_rec (relid, table_schema, table_name, when_tg, level, op, new_rec, username, client_addr, client_port)<br>    values (tg_relid, tg_table_schema, tg_table_name, tg_when, tg_level, tg_op, v_new_rec, v_username, v_client_addr, v_client_port);<br>when 'UPDATE' then <br>  v_old_rec := hstore(OLD.*);<br>  v_new_rec := hstore(NEW.*);<br>  insert into table_change_rec (relid, table_schema, table_name, when_tg, level, op, old_rec, new_rec, username, client_addr, client_port)<br>    values (tg_relid, tg_table_schema, tg_table_name, tg_when, tg_level, tg_op, v_old_rec, v_new_rec, v_username, v_client_addr, v_client_port);<br>else<br>  return null;<br>end case;<br>  RETURN null;<br>END;<br>$BODY$ strict;</span></font></div><p></p></pre></div><div><span style="line-height: 22px;"   >-- 在测试表上分别创建插入, 更新, 删除的三个触发器.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CREATE TRIGGER tg AFTER DELETE or INSERT or UPDATE ON test FOR EACH ROW EXECUTE PROCEDURE dml_trace();</font></div></pre></div><div>-- 测试插入, 删除, 更新操作是否被跟踪.</div><div>(已更新dml_trace, 以下例子未包含client_addr和client_port)</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# insert into test values (1, 'digoal', now());</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >postgres=# select * from test;</font></div><div><font size="2"   >&nbsp;id | &nbsp;info &nbsp;| &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----+--------+---------------------</font></div><div><font size="2"   >&nbsp; 1 | digoal | 2012-06-25 10:54:43</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select * from table_change_rec;</font></div><div><font size="2"   >&nbsp;id | relid | table_schema | table_name | when_tg | level | &nbsp; op &nbsp; | old_rec | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;new_rec &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| username&nbsp;</font></div><div><font size="2"   >----+-------+--------------+------------+---------+-------+--------+---------+------------------------------------------------------</font></div><div><font size="2"   >----------+----------------------------+----------</font></div><div><font size="2"   >&nbsp; 4 | 23731 | public &nbsp; &nbsp; &nbsp; | test &nbsp; &nbsp; &nbsp; | AFTER &nbsp; | ROW &nbsp; | INSERT | &nbsp; &nbsp; &nbsp; &nbsp; | "id"=&gt;"1", "info"=&gt;"digoal", "crt_time"=&gt;"2012-06-25&nbsp;</font></div><div><font size="2"   >10:54:43" | 2012-06-25 10:54:42.839553 | postgres</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# update test set info='DIGOAL' where id=1;</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >postgres=# select * from test;</font></div><div><font size="2"   >&nbsp;id | &nbsp;info &nbsp;| &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >----+--------+---------------------</font></div><div><font size="2"   >&nbsp; 1 | DIGOAL | 2012-06-25 10:54:43</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select * from table_change_rec;</font></div><div><font size="2"   >&nbsp;id | relid | table_schema | table_name | when_tg | level | &nbsp; op &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;old_rec &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;new_rec &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| username&nbsp;</font></div><div><font size="2"   >----+-------+--------------+------------+---------+-------+--------+----------------------------------------------------------------</font></div><div><font size="2"   >+----------------------------------------------------------------+----------------------------+----------</font></div><div><font size="2"   >&nbsp; 4 | 23731 | public &nbsp; &nbsp; &nbsp; | test &nbsp; &nbsp; &nbsp; | AFTER &nbsp; | ROW &nbsp; | INSERT | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >| "id"=&gt;"1", "info"=&gt;"digoal", "crt_time"=&gt;"2012-06-25 10:54:43" | 2012-06-25 10:54:42.839553 | postgres</font></div><div><font size="2"   >&nbsp; 5 | 23731 | public &nbsp; &nbsp; &nbsp; | test &nbsp; &nbsp; &nbsp; | AFTER &nbsp; | ROW &nbsp; | UPDATE | "id"=&gt;"1", "info"=&gt;"digoal", "crt_time"=&gt;"2012-06-25 10:54:43"&nbsp;</font></div><div><font size="2"   >| "id"=&gt;"1", "info"=&gt;"DIGOAL", "crt_time"=&gt;"2012-06-25 10:54:43" | 2012-06-25 10:55:41.006069 | postgres</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# delete from test where id=1;</font></div><div><font size="2"   >DELETE 1</font></div><div><font size="2"   >postgres=# select * from test;</font></div><div><font size="2"   >&nbsp;id | info | crt_time&nbsp;</font></div><div><font size="2"   >----+------+----------</font></div><div><font size="2"   >(0 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select * from table_change_rec;</font></div><div><font size="2"   >&nbsp;id | relid | table_schema | table_name | when_tg | level | &nbsp; op &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;old_rec &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;new_rec &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;crt_time &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| username&nbsp;</font></div><div><font size="2"   >----+-------+--------------+------------+---------+-------+--------+----------------------------------------------------------------</font></div><div><font size="2"   >+----------------------------------------------------------------+----------------------------+----------</font></div><div><font size="2"   >&nbsp; 4 | 23731 | public &nbsp; &nbsp; &nbsp; | test &nbsp; &nbsp; &nbsp; | AFTER &nbsp; | ROW &nbsp; | INSERT | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >| "id"=&gt;"1", "info"=&gt;"digoal", "crt_time"=&gt;"2012-06-25 10:54:43" | 2012-06-25 10:54:42.839553 | postgres</font></div><div><font size="2"   >&nbsp; 5 | 23731 | public &nbsp; &nbsp; &nbsp; | test &nbsp; &nbsp; &nbsp; | AFTER &nbsp; | ROW &nbsp; | UPDATE | "id"=&gt;"1", "info"=&gt;"digoal", "crt_time"=&gt;"2012-06-25 10:54:43"&nbsp;</font></div><div><font size="2"   >| "id"=&gt;"1", "info"=&gt;"DIGOAL", "crt_time"=&gt;"2012-06-25 10:54:43" | 2012-06-25 10:55:41.006069 | postgres</font></div><div><font size="2"   >&nbsp; 6 | 23731 | public &nbsp; &nbsp; &nbsp; | test &nbsp; &nbsp; &nbsp; | AFTER &nbsp; | ROW &nbsp; | DELETE | "id"=&gt;"1", "info"=&gt;"DIGOAL", "crt_time"=&gt;"2012-06-25 10:54:43"&nbsp;</font></div><div><font size="2"   >| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| 2012-06-25 10:56:00.862319 | postgres</font></div><div><font size="2"   >(3 rows)</font></div></pre></div><div>-- 使用each函数分解显示hstore存储的信息.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# select id,(each(old_rec)).* from table_change_rec;</font></div><div><font size="2"   >&nbsp;id | &nbsp; key &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;value &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+----------+---------------------</font></div><div><font size="2"   >&nbsp; 5 | id &nbsp; &nbsp; &nbsp; | 1</font></div><div><font size="2"   >&nbsp; 5 | info &nbsp; &nbsp; | digoal</font></div><div><font size="2"   >&nbsp; 5 | crt_time | 2012-06-25 10:54:43</font></div><div><font size="2"   >&nbsp; 6 | id &nbsp; &nbsp; &nbsp; | 1</font></div><div><font size="2"   >&nbsp; 6 | info &nbsp; &nbsp; | DIGOAL</font></div><div><font size="2"   >&nbsp; 6 | crt_time | 2012-06-25 10:54:43</font></div><div><font size="2"   >(6 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select id,(each(new_rec)).* from table_change_rec;</font></div><div><font size="2"   >&nbsp;id | &nbsp; key &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp;value &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+----------+---------------------</font></div><div><font size="2"   >&nbsp; 4 | id &nbsp; &nbsp; &nbsp; | 1</font></div><div><font size="2"   >&nbsp; 4 | info &nbsp; &nbsp; | digoal</font></div><div><font size="2"   >&nbsp; 4 | crt_time | 2012-06-25 10:54:43</font></div><div><font size="2"   >&nbsp; 5 | id &nbsp; &nbsp; &nbsp; | 1</font></div><div><font size="2"   >&nbsp; 5 | info &nbsp; &nbsp; | DIGOAL</font></div><div><font size="2"   >&nbsp; 5 | crt_time | 2012-06-25 10:54:43</font></div><div><font size="2"   >(6 rows)</font></div><p></p></pre></div></div><div><br></div><div>【触发器变量】</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >When a PL/pgSQL function is called as a trigger, several special variables are created automatically in the top-level block. They are:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >NEW</font></div><div><font size="2"   >Data type RECORD; variable holding the new database row for INSERT/UPDATE operations in row-level triggers. This variable is NULL in statement-level triggers and for DELETE operations.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >OLD</font></div><div><font size="2"   >Data type RECORD; variable holding the old database row for UPDATE/DELETE operations in row-level triggers. This variable is NULL in statement-level triggers and for INSERT operations.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >TG_NAME</font></div><div><font size="2"   >Data type name; variable that contains the name of the trigger actually fired.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >TG_WHEN</font></div><div><font size="2"   >Data type text; a string of BEFORE, AFTER, or INSTEAD OF, depending on the trigger's definition.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >TG_LEVEL</font></div><div><font size="2"   >Data type text; a string of either ROW or STATEMENT depending on the trigger's definition.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >TG_OP</font></div><div><font size="2"   >Data type text; a string of INSERT, UPDATE, DELETE, or TRUNCATE telling for which operation the trigger was fired.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >TG_RELID</font></div><div><font size="2"   >Data type oid; the object ID of the table that caused the trigger invocation.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >TG_RELNAME</font></div><div><font size="2"   >Data type name; the name of the table that caused the trigger invocation. This is now deprecated, and could disappear in a future release. Use TG_TABLE_NAME instead.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >TG_TABLE_NAME</font></div><div><font size="2"   >Data type name; the name of the table that caused the trigger invocation.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >TG_TABLE_SCHEMA</font></div><div><font size="2"   >Data type name; the name of the schema of the table that caused the trigger invocation.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >TG_NARGS</font></div><div><font size="2"   >Data type integer; the number of arguments given to the trigger procedure in the CREATE TRIGGER statement.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >TG_ARGV[]</font></div><div><font size="2"   >Data type array of text; the arguments from the CREATE TRIGGER statement. The index counts from 0. Invalid indexes (less than 0 or greater than or equal to tg_nargs) result in a null value.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >A trigger function must return either NULL or a record/row value having exactly the structure of the table the trigger was fired for.</font></div><p></p></pre></div><div><br></div><div>【参考】</div><a rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/plpgsql-trigger.html"   >http://www.postgresql.org/docs/9.2/static/plpgsql-trigger.html</a><wbr><div><a rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/hstore.html"   >http://www.postgresql.org/docs/9.2/static/hstore.html</a> </div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">ohyoyo@yeah - 2014-04-19 13:13:28</h5>
				<div>make一下</div>
			</div>
	</div>
</div>
</body>
</html>