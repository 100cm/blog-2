<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL排序索引建立不当造成的显性Sort现象优化一例</h2>
	<h5 id="">2012-06-20 16:47:37&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201252044737172/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>今天一位同事找到我, 在一个业务中有个查询在三个表之间JOIN, 发现当用到order by ext.current_dc desc时特别慢, 其他的速度都很快.</div><div>SQL 如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >SELECT apk.id, apk.app_id, apk.app_ver, apk.app_show_ver, apk.cn_name, apk.apk_size, apk.authentic, apk.app_class_id, apk.create_time, apk.deleted, apk.promotion, COALESCE(ext.current_dc, 0::numeric) AS current_dc, COALESCE(price.price, 0::numeric) AS price</font></div><div><font size="2"   >FROM</font></div><div><font size="2"   >tbl_digoal_1 apk</font></div><div><font size="2"   >JOIN tbl_digoal_2 ext</font></div><div><font size="2"   >ON (apk.app_id = ext.app_id AND apk.deleted = 0::numeric and ext.current_dc is not null)</font></div><div><font size="2"   >LEFT JOIN tbl_digoal_3 price</font></div><div><font size="2"   >ON (apk.app_id = price.app_id and price.start_date::date &lt;= now()::date AND price.end_date::date &gt;= now()::date)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--where apk.cn_name like '%WPS%'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;order by ext.current_dc desc</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--order by apk.create_time desc</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--order by apk.apk_size desc</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--order by apk.id desc</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--order by apk.cn_name desc</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;limit 24</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--offset 48</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;</font></div><p></p></pre></div><div><br></div><div>三个表的结构和count(distinct)如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; \d+ tbl_digoal_1</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Table "digoal.tbl_digoal_1"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; Column &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; Modifiers &nbsp; &nbsp; &nbsp; &nbsp;| Storage &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Description &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >------------------+-----------------------------+------------------------+----------+---------------------------------</font></div><div><font size="2"   >&nbsp;id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | numeric(19,0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | not null &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | main &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;app_id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | numeric(19,0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | not null &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | main &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;app_ver &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| numeric(19,0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | not null &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | main &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;app_show_ver &nbsp; &nbsp; | character varying(32) &nbsp; &nbsp; &nbsp; | not null &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | extended |&nbsp;</font></div><div><font size="2"   >&nbsp;cn_name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| character varying(128) &nbsp; &nbsp; &nbsp;| not null &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | extended |&nbsp;</font></div><div><font size="2"   >&nbsp;eng_name &nbsp; &nbsp; &nbsp; &nbsp; | character varying(128) &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| extended |&nbsp;</font></div><div><font size="2"   >&nbsp;apk_md5 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| character varying(32) &nbsp; &nbsp; &nbsp; | not null &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | extended |&nbsp;</font></div><div><font size="2"   >&nbsp;apk_size &nbsp; &nbsp; &nbsp; &nbsp; | numeric(19,0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | not null &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | main &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;sdk_ver &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| numeric(19,0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| main &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;authentic &nbsp; &nbsp; &nbsp; &nbsp;| numeric(10,0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | not null &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | main &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;app_class_id &nbsp; &nbsp; | numeric(19,0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | not null &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | main &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;description &nbsp; &nbsp; &nbsp;| character varying(1024) &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| extended |&nbsp;</font></div><div><font size="2"   >&nbsp;block_size &nbsp; &nbsp; &nbsp; | numeric(10,0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| main &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;package &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| character varying(128) &nbsp; &nbsp; &nbsp;| not null &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | extended |&nbsp;</font></div><div><font size="2"   >&nbsp;developer_id &nbsp; &nbsp; | numeric(19,0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | not null &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | main &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;content_provider | numeric(10,0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | not null &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | main &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;create_user &nbsp; &nbsp; &nbsp;| character varying(32) &nbsp; &nbsp; &nbsp; | not null &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | extended |&nbsp;</font></div><div><font size="2"   >&nbsp;create_time &nbsp; &nbsp; &nbsp;| timestamp without time zone | not null default now() | plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;modify_user &nbsp; &nbsp; &nbsp;| character varying(32) &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| extended |&nbsp;</font></div><div><font size="2"   >&nbsp;modify_time &nbsp; &nbsp; &nbsp;| timestamp without time zone | default now() &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;deleted &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| numeric(5,0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null default 0 &nbsp; &nbsp; | main &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;new_feature_desc | character varying(512) &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| extended |&nbsp;</font></div><div><font size="2"   >&nbsp;on_off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | numeric(1,0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| default 1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| main &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;promotion &nbsp; &nbsp; &nbsp; &nbsp;| numeric(1,0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| default 1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| main &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >Indexes:</font></div><div><font size="2"   >&nbsp; &nbsp; "pk_tbl_digoal_1" PRIMARY KEY, btree (id)</font></div><div><font size="2"   >&nbsp; &nbsp; "idx_tbl_digoal_1_ctime" btree (create_time, modify_time), tablespace "tbs_digoal_idx"</font></div><div><font size="2"   >&nbsp; &nbsp; "idx_tbl_digoal_1_tbl_digoal_1_apk_size" btree (apk_size), tablespace "tbs_digoal_idx"</font></div><div><font size="2"   >&nbsp; &nbsp; "tbl_digoal_1_app_id_index" btree (app_id), tablespace "tbs_digoal_idx"</font></div><div><font size="2"   >&nbsp; &nbsp; "tbl_digoal_1_cn_name_index" btree (cn_name), tablespace "tbs_digoal_idx"</font></div><div><font size="2"   >&nbsp; &nbsp; "tbl_digoal_1_create_time_index" btree (create_time), tablespace "tbs_digoal_idx"</font></div><div><font size="2"   >Has OIDs: no</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=&gt; \d tbl_digoal_2</font></div><div><font size="2"   >&nbsp; &nbsp; Table "digoal.tbl_digoal_2"</font></div><div><font size="2"   >&nbsp; &nbsp; Column &nbsp; &nbsp; | &nbsp; &nbsp; Type &nbsp; &nbsp; &nbsp;| Modifiers&nbsp;</font></div><div><font size="2"   >---------------+---------------+-----------</font></div><div><font size="2"   >&nbsp;id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| numeric(19,0) | not null</font></div><div><font size="2"   >&nbsp;app_id &nbsp; &nbsp; &nbsp; &nbsp;| numeric(19,0) | not null</font></div><div><font size="2"   >&nbsp;current_dc &nbsp; &nbsp;| numeric(19,0) | default 0</font></div><div><font size="2"   >&nbsp;current_cc &nbsp; &nbsp;| numeric(19,0) | default 0</font></div><div><font size="2"   >&nbsp;day_dc &nbsp; &nbsp; &nbsp; &nbsp;| numeric(19,0) |&nbsp;</font></div><div><font size="2"   >&nbsp;day_cc &nbsp; &nbsp; &nbsp; &nbsp;| numeric(19,0) |&nbsp;</font></div><div><font size="2"   >&nbsp;week_dc &nbsp; &nbsp; &nbsp; | numeric(19,0) |&nbsp;</font></div><div><font size="2"   >&nbsp;week_cc &nbsp; &nbsp; &nbsp; | numeric(19,0) |&nbsp;</font></div><div><font size="2"   >&nbsp;month_dc &nbsp; &nbsp; &nbsp;| numeric(19,0) |&nbsp;</font></div><div><font size="2"   >&nbsp;month_cc &nbsp; &nbsp; &nbsp;| numeric(19,0) |&nbsp;</font></div><div><font size="2"   >&nbsp;comment_score | numeric(19,0) |&nbsp;</font></div><div><font size="2"   >&nbsp;base_dc &nbsp; &nbsp; &nbsp; | numeric(19,0) | default 0</font></div><div><font size="2"   >&nbsp;base_cc &nbsp; &nbsp; &nbsp; | numeric(19,0) | default 0</font></div><div><font size="2"   >&nbsp;score_manual &nbsp;| numeric(1,0) &nbsp;| default 0</font></div><div><font size="2"   >Indexes:</font></div><div><font size="2"   >&nbsp; &nbsp; "pk_tbl_digoal_2" PRIMARY KEY, btree (id)</font></div><div><font size="2"   >&nbsp; &nbsp; "tbl_digoal_2_app_id_index" btree (app_id), tablespace "tbs_digoal_idx"</font></div><div><font size="2"   >&nbsp; &nbsp; "tbl_digoal_2_app_id_index2" btree (current_dc) WHERE current_dc IS NOT NULL</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=&gt; \d tbl_digoal_3</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;Table "digoal.tbl_digoal_3"</font></div><div><font size="2"   >&nbsp; &nbsp;Column &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; Modifiers &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-------------+-----------------------------+--------------------</font></div><div><font size="2"   >&nbsp;id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| numeric(19,0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | not null</font></div><div><font size="2"   >&nbsp;app_id &nbsp; &nbsp; &nbsp;| numeric(19,0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;app_name &nbsp; &nbsp;| character varying(64) &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;app_pkg &nbsp; &nbsp; | character varying(128) &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;price &nbsp; &nbsp; &nbsp; | numeric(19,0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;settle_type | numeric(9,0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;description | character varying(1024) &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;cpcode &nbsp; &nbsp; &nbsp;| character varying(128) &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;create_user | character varying(30) &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;create_time | timestamp(0) with time zone | default now()</font></div><div><font size="2"   >&nbsp;modify_user | character varying(30) &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;modify_time | timestamp(0) with time zone |&nbsp;</font></div><div><font size="2"   >&nbsp;deleted &nbsp; &nbsp; | numeric(1,0) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null default 0</font></div><div><font size="2"   >&nbsp;start_date &nbsp;| timestamp(0) with time zone |&nbsp;</font></div><div><font size="2"   >&nbsp;end_date &nbsp; &nbsp;| timestamp(0) with time zone |&nbsp;</font></div><div><font size="2"   >Indexes:</font></div><div><font size="2"   >&nbsp; &nbsp; "pk_tbl_digoal_3" PRIMARY KEY, btree (id)</font></div><div><font size="2"   >&nbsp; &nbsp; "tbl_digoal_3_app_id_index" btree (app_id), tablespace "tbs_digoal_idx"</font></div><div><font size="2"   >&nbsp; &nbsp; "tbl_digoal_3_price_index" btree (price), tablespace "tbs_digoal_idx"</font></div><p></p></pre></div><div><br></div><div>使用到order by的字段的distinct值如下, 一开始我怀疑是distinct值的原因, 后来仔细看才发现是索引建立的有问题 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select count(distinct cn_name),count(distinct create_time),count(distinct apk_size),count(distinct id),count(*) from tbl_digoal_1;</font></div><div><font size="2"   >&nbsp;count | count &nbsp;| count &nbsp;| count &nbsp;| count &nbsp;</font></div><div><font size="2"   >-------+--------+--------+--------+--------</font></div><div><font size="2"   >&nbsp;79770 | 108583 | 105912 | 108584 | 108584</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=&gt; select count(distinct current_dc),count(*) from tbl_digoal_2;</font></div><div><font size="2"   >&nbsp;count | count&nbsp;</font></div><div><font size="2"   >-------+-------</font></div><div><font size="2"   >&nbsp; &nbsp;215 | 91292</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>各种order by执行计划如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; explain SELECT apk.id, apk.app_id, apk.app_ver, apk.app_show_ver, apk.cn_name, apk.apk_size, apk.authentic, apk.app_class_id, apk.create_time, apk.deleted, apk.promotion, COALESCE(current_dc, 0::numeric) AS current_dc, COALESCE(price.price, 0::numeric) AS price</font></div><div><font size="2"   >digoal-&gt; FROM</font></div><div><font size="2"   >tbl_digoal_1 apk</font></div><div><font size="2"   >digoal-&gt; tbl_digoal_1 apk</font></div><div><font size="2"   >digoal-&gt; JOIN tbl_digoal_2 ext</font></div><div><font size="2"   >digoal-&gt; ON (apk.app_id = ext.app_id AND apk.deleted = 0::numeric)</font></div><div><font size="2"   >digoal-&gt; LEFT JOIN tbl_digoal_3 price</font></div><div><font size="2"   >digoal-&gt; ON (apk.app_id = price.app_id and price.start_date::date &lt;= now()::date AND price.end_date::date &gt;= now()::date)</font></div><div><font size="2"   >digoal-&gt; &nbsp;-- where apk.cn_name like '%WPS%'</font></div><div><font size="2"   >digoal-&gt; &nbsp;order by ext.current_dc desc</font></div><div><font size="2"   >digoal-&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--order by apk.create_time desc</font></div><div><font size="2"   >digoal-&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--order by apk.apk_size desc</font></div><div><font size="2"   >digoal-&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--order by apk.id desc</font></div><div><font size="2"   >digoal-&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--order by apk.cn_name desc</font></div><div><font size="2"   >digoal-&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;limit 24</font></div><div><font size="2"   >digoal-&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--offset 48</font></div><div><font size="2"   >digoal-&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >---------------------</font></div><div><font size="2"   >&nbsp;Limit &nbsp;(cost=38680.15..38680.21 rows=24 width=77)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=38680.15..38951.09 rows=108377 width=77)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: ext.current_dc</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Hash Left Join &nbsp;(cost=19202.26..35653.74 rows=108377 width=77)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Hash Cond: (apk.app_id = price.app_id)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Hash Join &nbsp;(cost=19197.44..35242.44 rows=108377 width=73)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Hash Cond: (apk.app_id = ext.app_id)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan using tbl_digoal_1_app_id_index on tbl_digoal_1 apk &nbsp;(cost=0.00..11293.87 rows=108377 width=70)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (deleted = 0::numeric)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Hash &nbsp;(cost=17604.37..17604.37 rows=91606 width=9)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan using tbl_digoal_2_app_id_index on tbl_digoal_2 ext &nbsp;(cost=0.00..17604.37 rows=91606 width=9</font></div><div><font size="2"   >)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Hash &nbsp;(cost=4.76..4.76 rows=5 width=10)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan using tbl_digoal_3_app_id_index on tbl_digoal_3 price &nbsp;(cost=0.00..4</font></div><div><font size="2"   >.76 rows=5 width=10)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (((start_date)::date &lt;= (now())::date) AND ((end_date)::date &gt;= (now())::date))</font></div><div><font size="2"   >(14 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Time: 1.789 ms</font></div><p></p></pre></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; explain SELECT apk.id, apk.app_id, apk.app_ver, apk.app_show_ver, apk.cn_name, apk.apk_size, apk.authentic, apk.app_class_id, apk.create_time, apk.deleted, apk.promotion, COALESCE(current_dc, 0::numeric) AS current_dc, COALESCE(price.price, 0::numeric) AS price</font></div><div><font size="2"   >digoal-&gt; FROM</font></div><div><font size="2"   >digoal-&gt; tbl_digoal_1 apk</font></div><div><font size="2"   >digoal-&gt; JOIN tbl_digoal_2 ext</font></div><div><font size="2"   >digoal-&gt; ON (apk.app_id = ext.app_id AND apk.deleted = 0::numeric)</font></div><div><font size="2"   >digoal-&gt; LEFT JOIN tbl_digoal_3 price</font></div><div><font size="2"   >digoal-&gt; ON (apk.app_id = price.app_id and price.start_date::date &lt;= now()::date AND price.end_date::date &gt;= now()::date)</font></div><div><font size="2"   >digoal-&gt; &nbsp;-- where apk.cn_name like '%WPS%'</font></div><div><font size="2"   >digoal-&gt; &nbsp;--order by ext.current_dc desc</font></div><div><font size="2"   >digoal-&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;order by apk.create_time desc</font></div><div><font size="2"   >digoal-&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--order by apk.apk_size desc</font></div><div><font size="2"   >digoal-&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--order by apk.id desc</font></div><div><font size="2"   >digoal-&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--order by apk.cn_name desc</font></div><div><font size="2"   >digoal-&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;limit 24</font></div><div><font size="2"   >digoal-&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--offset 48</font></div><div><font size="2"   >digoal-&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp;Limit &nbsp;(cost=0.00..15.31 rows=24 width=77)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Nested Loop Left Join &nbsp;(cost=0.00..69125.92 rows=108377 width=77)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Join Filter: (apk.app_id = price.app_id)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Nested Loop &nbsp;(cost=0.00..60992.87 rows=108377 width=73)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan Backward using tbl_digoal_1_create_time_index on tbl_digoal_1 apk &nbsp;(cost=0.00..11241.87 rows=108377 widt</font></div><div><font size="2"   >h=70)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (deleted = 0::numeric)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan using tbl_digoal_2_app_id_index on tbl_digoal_2 ext &nbsp;(cost=0.00..0.45 rows=1 width=9)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (app_id = apk.app_id)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Materialize &nbsp;(cost=0.00..4.78 rows=5 width=10)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan using tbl_digoal_3_app_id_index on tbl_digoal_3 price &nbsp;(cost=0.00..4.76 ro</font></div><div><font size="2"   >ws=5 width=10)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (((start_date)::date &lt;= (now())::date) AND ((end_date)::date &gt;= (now())::date))</font></div><div><font size="2"   >(11 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Time: 2.389 ms</font></div><p></p></pre></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; explain SELECT apk.id, apk.app_id, apk.app_ver, apk.app_show_ver, apk.cn_name, apk.apk_size, apk.authentic, apk.app_class_id, apk.create_time, apk.deleted, apk.promotion, COALESCE(current_dc, 0::numeric) AS current_dc, COALESCE(price.price, 0::numeric) AS price</font></div><div><font size="2"   >FROM</font></div><div><font size="2"   >tbl_digoal_1 apk</font></div><div><font size="2"   >JOIN tbl_digoal_2 ext</font></div><div><font size="2"   >ON (apk.app_id = ext.app_id AND apk.deleted = 0::numeric)</font></div><div><font size="2"   >LEFT JOIN tbl_digoal_3 price</font></div><div><font size="2"   >ON (apk.app_id = price.app_id and price.start_date::date &lt;= now()::date AND price.end_date::date &gt;= now()::date)</font></div><div><font size="2"   >&nbsp;-- where apk.cn_name like '%WPS%'</font></div><div><font size="2"   >&nbsp;--order by ext.current_dc desc</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--order by apk.create_time desc</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;order by apk.apk_size desc &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--order by apk.id desc</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--order by apk.cn_name desc</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;limit 24</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--offset 48</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp;Limit &nbsp;(cost=0.00..15.31 rows=24 width=77)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Nested Loop Left Join &nbsp;(cost=0.00..69123.92 rows=108377 width=77)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Join Filter: (apk.app_id = price.app_id)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Nested Loop &nbsp;(cost=0.00..60990.87 rows=108377 width=73)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan Backward using idx_tbl_digoal_1_tbl_digoal_1_apk_size on tbl_digoal_1 apk &nbsp;(cost=0.00..11239.87 rows=1083</font></div><div><font size="2"   >77 width=70)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (deleted = 0::numeric)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan using tbl_digoal_2_app_id_index on tbl_digoal_2 ext &nbsp;(cost=0.00..0.45 rows=1 width=9)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (app_id = apk.app_id)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Materialize &nbsp;(cost=0.00..4.78 rows=5 width=10)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan using tbl_digoal_3_app_id_index on tbl_digoal_3 price &nbsp;(cost=0.00..4.76 ro</font></div><div><font size="2"   >ws=5 width=10)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (((start_date)::date &lt;= (now())::date) AND ((end_date)::date &gt;= (now())::date))</font></div><div><font size="2"   >(11 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Time: 3.317 ms</font></div><p></p></pre></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; explain SELECT apk.id, apk.app_id, apk.app_ver, apk.app_show_ver, apk.cn_name, apk.apk_size, apk.authentic, apk.app_class_id, apk.create_time, apk.deleted, apk.promotion, COALESCE(current_dc, 0::numeric) AS current_dc, COALESCE(price.price, 0::numeric) AS price</font></div><div><font size="2"   >FROM</font></div><div><font size="2"   >tbl_digoal_1 apk</font></div><div><font size="2"   >JOIN tbl_digoal_2 ext</font></div><div><font size="2"   >ON (apk.app_id = ext.app_id AND apk.deleted = 0::numeric)</font></div><div><font size="2"   >LEFT JOIN tbl_digoal_3 price</font></div><div><font size="2"   >ON (apk.app_id = price.app_id and price.start_date::date &lt;= now()::date AND price.end_date::date &gt;= now()::date)</font></div><div><font size="2"   >&nbsp;-- where apk.cn_name like '%WPS%'</font></div><div><font size="2"   >&nbsp;--order by ext.current_dc desc</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--order by apk.create_time desc</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--order by apk.apk_size desc</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;order by apk.id desc &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--order by apk.cn_name desc</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;limit 24</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--offset 48</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp;Limit &nbsp;(cost=0.00..15.33 rows=24 width=77)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Nested Loop Left Join &nbsp;(cost=0.00..69234.92 rows=108377 width=77)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Join Filter: (apk.app_id = price.app_id)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Nested Loop &nbsp;(cost=0.00..61101.88 rows=108377 width=73)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan Backward using pk_app_apk on tbl_digoal_1 apk &nbsp;(cost=0.00..11350.87 rows=108377 width=70)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (deleted = 0::numeric)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan using tbl_digoal_2_app_id_index on tbl_digoal_2 ext &nbsp;(cost=0.00..0.45 rows=1 width=9)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (app_id = apk.app_id)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Materialize &nbsp;(cost=0.00..4.78 rows=5 width=10)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan using tbl_digoal_3_app_id_index on tbl_digoal_3 price &nbsp;(cost=0.00..4.76 ro</font></div><div><font size="2"   >ws=5 width=10)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (((start_date)::date &lt;= (now())::date) AND ((end_date)::date &gt;= (now())::date))</font></div><div><font size="2"   >(11 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Time: 1.800 ms</font></div><p></p></pre></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; explain SELECT apk.id, apk.app_id, apk.app_ver, apk.app_show_ver, apk.cn_name, apk.apk_size, apk.authentic, apk.app_class_id, apk.create_time, apk.deleted, apk.promotion, COALESCE(current_dc, 0::numeric) AS current_dc, COALESCE(price.price, 0::numeric) AS price</font></div><div><font size="2"   >FROM</font></div><div><font size="2"   >tbl_digoal_1 apk</font></div><div><font size="2"   >JOIN tbl_digoal_2 ext</font></div><div><font size="2"   >ON (apk.app_id = ext.app_id AND apk.deleted = 0::numeric)</font></div><div><font size="2"   >LEFT JOIN tbl_digoal_3 price</font></div><div><font size="2"   >ON (apk.app_id = price.app_id and price.start_date::date &lt;= now()::date AND price.end_date::date &gt;= now()::date)</font></div><div><font size="2"   >&nbsp;-- where apk.cn_name like '%WPS%'</font></div><div><font size="2"   >&nbsp;--order by ext.current_dc desc</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--order by apk.create_time desc</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--order by apk.apk_size desc</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--order by apk.id desc</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;order by apk.cn_name desc &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;limit 24</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--offset 48</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp;Limit &nbsp;(cost=0.00..15.37 rows=24 width=77)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Nested Loop Left Join &nbsp;(cost=0.00..69428.92 rows=108377 width=77)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Join Filter: (apk.app_id = price.app_id)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Nested Loop &nbsp;(cost=0.00..61295.88 rows=108377 width=73)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan Backward using tbl_digoal_1_cn_name_index on tbl_digoal_1 apk &nbsp;(cost=0.00..11544.87 rows=108377 width=70</font></div><div><font size="2"   >)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (deleted = 0::numeric)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan using tbl_digoal_2_app_id_index on tbl_digoal_2 ext &nbsp;(cost=0.00..0.45 rows=1 width=9)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (app_id = apk.app_id)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Materialize &nbsp;(cost=0.00..4.78 rows=5 width=10)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan using tbl_digoal_3_app_id_index on tbl_digoal_3 price &nbsp;(cost=0.00..4.76 ro</font></div><div><font size="2"   >ws=5 width=10)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (((start_date)::date &lt;= (now())::date) AND ((end_date)::date &gt;= (now())::date))</font></div><div><font size="2"   >(11 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Time: 1.874 ms</font></div><p></p></pre></div><div><br></div><div>【优化】</div><div>正常的计划都没有显式的Sort这个环节, 全部都是Nested Loop的时候走了排序输出的那个索引.</div><div>而慢的这个SQL, 使用的是Merge Join, 后面显示的Sort了结果集.</div><div>原因是用于排序的列current_dc和索引建立的条件不匹配, 索引多了个WHERE.current_dc IS NOT NULL, 因此在SQL中无法使用到它.</div><div>&nbsp; &nbsp; "tbl_digoal_2_app_id_index2" btree (current_dc) WHERE current_dc IS NOT NULL</div><div>重建索引就可以了,</div><div>create index tbl_digoal_2_app_id_index2 on tbl_digoal_2 (current_dc desc) tablespace tbs_digoal_idx;</div><div><br></div><div>重看执行计划 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; explain SELECT apk.id, apk.app_id, apk.app_ver, apk.app_show_ver, apk.cn_name, apk.apk_size, apk.authentic, apk.app_class_id, apk.create_time, apk.deleted, apk.promotion, COALESCE(current_dc, 0::numeric) AS current_dc, COALESCE(price.price, 0::numeric) AS price</font></div><div><font size="2"   >digoal-&gt; FROM</font></div><div><font size="2"   >digoal-&gt; tbl_digoal_1 apk</font></div><div><font size="2"   >digoal-&gt; JOIN tbl_digoal_2 ext</font></div><div><font size="2"   >digoal-&gt; ON (apk.app_id = ext.app_id AND apk.deleted = 0::numeric)</font></div><div><font size="2"   >digoal-&gt; LEFT JOIN tbl_digoal_3 price</font></div><div><font size="2"   >digoal-&gt; ON (apk.app_id = price.app_id and price.start_date::date &lt;= now()::date AND price.end_date::date &gt;= now()::date)</font></div><div><font size="2"   >digoal-&gt; &nbsp;-- where apk.cn_name like '%WPS%'</font></div><div><font size="2"   >digoal-&gt; &nbsp;order by ext.current_dc desc</font></div><div><font size="2"   >digoal-&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--order by apk.create_time desc</font></div><div><font size="2"   >digoal-&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--order by apk.apk_size desc</font></div><div><font size="2"   >digoal-&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--order by apk.id desc</font></div><div><font size="2"   >digoal-&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--order by apk.cn_name desc</font></div><div><font size="2"   >digoal-&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;limit 24</font></div><div><font size="2"   >digoal-&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;--offset 48</font></div><div><font size="2"   >digoal-&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >---------------</font></div><div><font size="2"   >&nbsp;Limit &nbsp;(cost=0.00..13.03 rows=24 width=77)</font></div><div><font size="2"   >&nbsp; &nbsp;-&gt; &nbsp;Nested Loop Left Join &nbsp;(cost=0.00..58846.45 rows=108377 width=77)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Join Filter: (apk.app_id = price.app_id)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Nested Loop &nbsp;(cost=0.00..50713.41 rows=108377 width=73)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan using tbl_digoal_2_app_id_index2 on tbl_digoal_2 ext &nbsp;(cost=0.00..15128.34 rows=91606 width=9)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan using tbl_digoal_1_app_id_index on tbl_digoal_1 apk &nbsp;(cost=0.00..0.38 rows=1 width=70)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Index Cond: (app_id = ext.app_id)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (deleted = 0::numeric)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Materialize &nbsp;(cost=0.00..4.78 rows=5 width=10)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan using tbl_digoal_3_app_id_index on tbl_digoal_3 price &nbsp;(cost=0.00..4.76 ro</font></div><div><font size="2"   >ws=5 width=10)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Filter: (((start_date)::date &lt;= (now())::date) AND ((end_date)::date &gt;= (now())::date))</font></div><div><font size="2"   >(11 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Time: 1.988 ms</font></div><p></p></pre></div><div><br></div><div>这时候就没有显式的Sort步骤了.</div><div><br></div><div>【小结】</div></div><div>1. 由于PostgreSQL可以建立partial index, 所以需要特别注意索引是否能被真正使用和SQL有非常大的关系. 本例就是一个很典型的例子, 多了个条件, 所以不是全范围的索引, 因此也就无法满足SQL要求的使用条件.</div></div>
	</div>
</div>
</body>
</html>