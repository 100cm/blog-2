<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">improve security by use fdw within dblink</h2>
	<h5 id="">2012-06-21 20:53:49&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201252185126494/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><a target="_blank" rel="nofollow" href="https://wiki.postgresql.org/wiki/Foreign_data_wrappers"   >https://wiki.postgresql.org/wiki/Foreign_data_wrappers</a></div><div>在PostgreSQL 9.1以前使用dblink连接远程数据库时, 配置用户密码, 这些是明文的.</div><div>9.1 开始PostgreSQL加入了fdw的功能, dblink可以使用fdw创建的server连接远程数据库, 这样就可以对数据库的密码加以隐藏.&nbsp;</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >\c digoal postgres</font></div><div><font size="2"   >create extension dblink;</font></div><div><font size="2"   >CREATE FOREIGN DATA WRAPPER postgresql VALIDATOR postgresql_fdw_validator;</font></div><div><font size="2"   >CREATE SERVER srv_bill FOREIGN DATA WRAPPER postgresql OPTIONS (hostaddr '172.16.3.33', dbname 'digoal', port '5432');</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >CREATE USER MAPPING FOR digoal SERVER srv_bill OPTIONS (user 'rmt_digoal', password 'DIGOAL321');</font></div><div><font size="2"   >GRANT USAGE ON FOREIGN SERVER srv_bill TO digoal;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >\c digoal digoal</font></div><div><font size="2"   >CREATE VIEW v_bill_table_digoal AS</font></div><div><font size="2"   >&nbsp; SELECT id,cn_id,cn_name,cn_type,requestor,cn_desc,create_time,cn_code,check_type,check_msg</font></div><div><font size="2"   >&nbsp; &nbsp; FROM dblink('srv_bill',&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; 'select id,cn_id,cn_name,cn_type,requestor,cn_desc,create_time,cn_code,check_type,check_msg from smartp.table_digoal')</font></div><div><font size="2"   >&nbsp; &nbsp; AS t1(id numeric(20,0),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cn_id character varying(20),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cn_name character varying(100),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cn_type numeric(1,0),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; requestor character varying(3),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cn_desc character varying(1000),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; create_time timestamp(0) without time zone,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cn_code character varying(100),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; check_type numeric(1,0),</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; check_msg character varying(400)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; );</font></div><p></p></pre></div><div>【注意】</div><div>密码在视图中没有明文, 但是在<span style="line-height: 22px;"   >pg_user_mapping是可见的, pg_user_mapping只有超级用户可见.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from pg_user_mapping;</font></div><div><font size="2"   >&nbsp;umuser | umserver | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; umoptions &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >--------+----------+---------------------------------------------------------------</font></div><div><font size="2"   >&nbsp; 16388 | &nbsp; &nbsp;33957 | {user=rmt_digoal,password=DIGOAL321}</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>普通用户没有权限查询 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select * from pg_user_mapping;</font></div><div><font size="2"   >ERROR: &nbsp;permission denied for relation pg_user_mapping</font></div><p></p></pre></div><div><br></div><div>【参考】</div><div><a rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/contrib-dblink-function.html"   >http://www.postgresql.org/docs/9.2/static/contrib-dblink-function.html</a> </div></div>
	</div>
</div>
</body>
</html>