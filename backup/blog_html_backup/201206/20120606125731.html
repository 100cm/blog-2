<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL Wrap Function code like Oracle package</h2>
	<h5 id="">2012-06-06 12:57:31&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201256056352/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>封装函数主要是为了隐藏函数体的内容(业务逻辑),这个在Oracle里面是通过package来实现的.</div><div>在PostgreSQL里面, 原生是不带这个功能的, 但是EnterpriseDB的AS版本支持这一操作,</div><div>通过edbwrap可以实现代码的封装.</div><div>例如 :&nbsp;</div><div>未封装的函数通过pg_proc.prosrc可以查看它的源码.</div><div><br></div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >edb=# SELECT prosrc FROM pg_proc WHERE proname = 'list_emp';</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prosrc &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >--------------------------------------------------------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;v_empno &nbsp; &nbsp; &nbsp; &nbsp; NUMBER(4); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;v_ename &nbsp; &nbsp; &nbsp; &nbsp; VARCHAR2(10); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;CURSOR emp_cur IS &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SELECT empno, ename FROM emp ORDER BY empno; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >&nbsp;BEGIN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;OPEN emp_cur; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;DBMS_OUTPUT.PUT_LINE('EMPNO &nbsp; &nbsp;ENAME'); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;DBMS_OUTPUT.PUT_LINE('----- &nbsp; &nbsp;-------'); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;LOOP &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;FETCH emp_cur INTO v_empno, v_ename; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;EXIT WHEN emp_cur%NOTFOUND; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;DBMS_OUTPUT.PUT_LINE(v_empno || ' &nbsp; &nbsp; ' || v_ename);&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;END LOOP; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;CLOSE emp_cur; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >&nbsp;END &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >(1 row) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >edb=# quit</font></div><p></p></pre></div><div><br></div><div>-- 使用edbwrap封装这个创建函数的文件</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[bash] edbwrap -i listemp.sql &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >EDB*Wrap Utility: Release 8.4.3.2</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Copyright (c) 2004-2010 EnterpriseDB Corporation. &nbsp;All Rights Reserved.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Using encoding UTF8 for input</font></div><div><font size="2"  >Processing listemp.sql to listemp.plb</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Examining the contents of the output file (listemp.plb) file reveals that the code is obfuscated:</font></div><p></p></pre></div><div>-- 封装后就变成这样了.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[bash] cat listemp.plb&nbsp;</font></div><div><font size="2"  >$__EDBwrapped__$ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >UTF8 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >d+6DL30RVaGjYMIzkuoSzAQgtBw7MhYFuAFkBsfYfhdJ0rjwBv+bHr1FCyH6j9SgH</font></div><div><font size="2"  >movU+bYI+jR+hR2jbzq3sovHKEyZIp9y3/GckbQgualRhIlGpyWfE0dltDUpkYRLN</font></div><div><font size="2"  >/OUXmk0/P4H6EI98sAHevGDhOWI+58DjJ44qhZ+l5NNEVxbWDztpb/s5sdx4660qQ</font></div><div><font size="2"  >Ozx3/gh8VkqS2JbcxYMpjmrwVr6fAXfb68Ml9mW2Hl7fNtxcb5kjSzXvfWR2XYzJf</font></div><div><font size="2"  >KFNrEhbL1DTVlSEC5wE6lGlwhYvXOf22m1R2IFns0MtF9fwcnBWAs1YqjR00j6+fc</font></div><div><font size="2"  >er/f/efAFh4=</font></div><div><font size="2"  >$__EDBwrapped__$</font></div><p></p></pre></div><div><br></div><div>-- 使用封装后的代码创建函数</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >[bash] edb-psql edb</font></div><div><font size="2"  >Welcome to edb-psql 8.4.3.2, the EnterpriseDB interactive terminal.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >Type: &nbsp;\copyright for distribution terms</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;\h for help with SQL commands</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;\? for help with edb-psql commands</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;\g or terminate with semicolon to execute query</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp;\q to quit</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >edb=# \i listemp.plb</font></div><div><font size="2"  >CREATE PROCEDURE</font></div><p></p></pre></div><div><br></div><div>-- 那么再查看pg_proc.prosrc就变成封装后的代码了</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >edb=# SELECT prosrc FROM pg_proc WHERE proname = 'list_emp';</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; prosrc</font></div><div><font size="2"  >----------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;$__EDBwrapped__$</font></div><div><font size="2"  >&nbsp;UTF8</font></div><div><font size="2"  >&nbsp;dw4B9Tz69J3WOsy0GgYJQa+G2sLZ3IOyxS8pDyuOTFuiYe/EXiEatwwG3h3tdJk</font></div><div><font size="2"  >&nbsp;ea+AIp35dS/4idbN8wpegM3s994dQ3R97NgNHfvTQnO2vtd4wQtsQ/Zc4v4Lhfj</font></div><div><font size="2"  >&nbsp;nlV+A4UpHI5oQEnXeAch2LcRD87hkU0uo1ESeQV8IrXaj9BsZr+ueROnwhGs/Ec</font></div><div><font size="2"  >&nbsp;pva/tRV4m9RusFn0wyr38u4Z8w4dfnPW184Y3o6It4b3aH07WxTkWrMLmOZW1jJ</font></div><div><font size="2"  >&nbsp;Nu6u4o+ezO64G9QKPazgehslv4JB9NQnuocActfDSPMY7R7anmgw</font></div><div><font size="2"  >&nbsp;$__EDBwrapped__$</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div></div><div><br></div>【参考】<div><div>Postgres Plus Advanced Server Oracle Compatibility Developer's Guide</div><div><a target="_blank" rel="nofollow" href="http://www.enterprisedb.com/docs/en/9.1/oracompat/Postgres_Plus_Advanced_Server_Oracle_Compatibility_Guide-194.htm#P19537_909450"  >http://www.enterprisedb.com/docs/en/9.1/oracompat/Postgres_Plus_Advanced_Server_Oracle_Compatibility_Guide-194.htm#P19537_909450</a></div><br><wbr></div></div>
	</div>
</div>
</body>
</html>