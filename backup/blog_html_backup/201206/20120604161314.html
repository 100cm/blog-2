<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Londiste 3 Cascaded Replication case</h2>
	<h5 id="">2012-06-04 16:13:14&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020125441314324/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>londiste利用PostgreSQL的cascaded queue实现了cascaded replication, cascaded queue的术语如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >set::</font></div><div><font size="2"  >&nbsp; Group of nodes that distribute a single queue. &nbsp;In addition to</font></div><div><font size="2"  >&nbsp; copying events around, they also keep same batch boundaries</font></div><div><font size="2"  >&nbsp; and tick_ids.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >node::</font></div><div><font size="2"  >&nbsp; A database that participates in cascaded copy of a queue.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >provider::</font></div><div><font size="2"  >&nbsp; Node that provides queue data to another.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >subscriber::</font></div><div><font size="2"  >&nbsp; Node that receives queue data from another.</font></div><p></p></pre></div><div><br></div><div>cascaded queue中, 一个集群里面的所有节点共享queue的信息, 包括事件, batchs, tick_ids都相同. 因此可以改变provider, 所以后面测试的root节点以及branch节点的角色转换才能实现.</div><div>cascaded queue集群中包含以下角色, 有一些角色会在merge replication和split replication中讲解.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >root::</font></div><div><font size="2"  >&nbsp; Place where queue data is generated.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >branch::</font></div><div><font size="2"  >&nbsp; * Carries full contents of the queue.</font></div><div><font size="2"  >&nbsp; * (Londiste) May subscribe to all/some/none of the tables.</font></div><div><font size="2"  >&nbsp; * (Londiste) Can be provider for initial copy only if subscribes to table</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >leaf::</font></div><div><font size="2"  >&nbsp; Data-only node. &nbsp;Events are replayed, but no queue, thus cannot be provider to other nodes.</font></div><div><font size="2"  >&nbsp; Nodes where sets from partitions are merged together are also tagged 'leaf', because</font></div><div><font size="2"  >&nbsp; in per-partition set it cannot be provider to other nodes.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >merge-leaf::</font></div><div><font size="2"  >&nbsp; [Does not exist as separate type, detected as 'leaf' that has 'combined_queue' set.]</font></div><div><font size="2"  >&nbsp; Exists in per-partition set.</font></div><div><font size="2"  >&nbsp; - Does not have it's own queue.</font></div><div><font size="2"  >&nbsp; - (Londiste) Initial COPY is done with --skip-truncate,</font></div><div><font size="2"  >&nbsp; - Event data is sent to combined queue.</font></div><div><font size="2"  >&nbsp; - tick_id for each batch is sent to combined queue.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >&nbsp; - Queue reader from partition to combined-failover must lag behind</font></div><div><font size="2"  >&nbsp; &nbsp; combined queue coming from combined-root</font></div><div><font size="2"  >&nbsp;&nbsp;</font></div><div><font size="2"  >combined-root::</font></div><div><font size="2"  >&nbsp; [Does not exist as separate type, detected as 'root' that has 'leaf's with 'combined_queue' set.]</font></div><div><font size="2"  >&nbsp; - Master for combined queue. &nbsp;Received data from several per-partition queues.</font></div><div><font size="2"  >&nbsp; - Also is merge-leaf in every per-partition queue.</font></div><div><font size="2"  >&nbsp; - Queue is filled directly from partition queues.</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >combined-failover::</font></div><div><font size="2"  >&nbsp; [Does not exist as separate type, detected as 'branch' that has 'leaf's with 'combined_queue' set.]</font></div><div><font size="2"  >&nbsp; - participates in combined-set, receives events.</font></div><div><font size="2"  >&nbsp; - also is queue-only node in every part-set.</font></div><div><font size="2"  >&nbsp; - but no processing is done, just tracking</font></div><p></p></pre></div><div>-- 接下来使用5个节点测试一下londiste3的级联复制.</div><div>-- 测试环境</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >skytools3.0.3</font></div><div><font size="2"  >root: &nbsp; 172.16.3.33:1919:digoal &nbsp;PostgreSQL 9.2beta1</font></div><div><font size="2"  >branch: 172.16.3.39:1921:digoal &nbsp;PostgreSQL 9.1.3</font></div><div><font size="2"  >branch: 172.16.3.40:1921:digoal &nbsp;PostgreSQL 9.1.3</font></div><div><font size="2"  >branch: 172.16.3.150:1919:digoal PostgreSQL 9.1.3</font></div><div><font size="2"  >branch: 172.16.3.176:1921:digoal PostgreSQL 9.1.3</font></div><p></p></pre></div><div><br></div><div>一、在所有节点上安装skytools3.0.3.</div><div>-- 参考《londist3 install》</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201242945632912/"  >http://blog.163.com/digoal@126/blog/static/163877040201242945632912/</a></div><div><br></div><div><br></div><div>二、选择一个节点运行worker进程, 当然也可以各自运行在各自的节点上. 本例选择172.16.3.33作为运行worker进程的服务器.</div><div><br></div><div>三、在所有节点上创建用于复制的超级用户londiste(也可以叫别的名字),并且所有节点都允许172.16.3.33通过londiste访问所有库.可能需要配置防火墙,pg_hba.conf等.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres@db5-&gt; psql</font></div><div><font size="2"  >postgres=# create role londiste superuser nocreatedb nocreaterole noinherit login encrypted password 'londiste';</font></div><div><font size="2"  >CREATE ROLE</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >-- 在所有节点创建测试用户和测试库</font></div><div><font size="2"  >postgres@db5-&gt; psql</font></div><div><font size="2"  >postgres=# create role digoal nosuperuser nocreatedb nocreaterole noinherit login encrypted password 'digoal';</font></div><div><font size="2"  >CREATE ROLE</font></div><div><font size="2"  >postgres=# create database digoal encoding 'UTF8' template template0 owner digoal;</font></div><div><font size="2"  >CREATE DATABASE</font></div><div><font size="2"  >postgres=# \c digoal digoal</font></div><div><font size="2"  >You are now connected to database "digoal" as user "digoal".</font></div><div><font size="2"  >digoal=&gt; create schema digoal authorization digoal;</font></div><div><font size="2"  >CREATE SCHEMA</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >-- 在所有节点创建测试表</font></div><div><font size="2"  >create table user_info</font></div><div><font size="2"  >(userid int,</font></div><div><font size="2"  >engname text,</font></div><div><font size="2"  >cnname text,</font></div><div><font size="2"  >occupation text,</font></div><div><font size="2"  >birthday date,</font></div><div><font size="2"  >signname text,</font></div><div><font size="2"  >email text,</font></div><div><font size="2"  >qq numeric,</font></div><div><font size="2"  >crt_time timestamp without time zone,</font></div><div><font size="2"  >mod_time timestamp without time zone</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table user_session</font></div><div><font size="2"  >(userid int,</font></div><div><font size="2"  >logintime timestamp(0) without time zone,</font></div><div><font size="2"  >login_count bigint default 0,</font></div><div><font size="2"  >logouttime timestamp(0) without time zone,</font></div><div><font size="2"  >online_interval interval default interval '0'</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table user_login_rec</font></div><div><font size="2"  >(</font></div><div><font size="2"  >id serial8 primary key,</font></div><div><font size="2"  >userid int,</font></div><div><font size="2"  >login_time timestamp without time zone,</font></div><div><font size="2"  >ip inet</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >create table user_logout_rec</font></div><div><font size="2"  >(</font></div><div><font size="2"  >id serial8 primary key,</font></div><div><font size="2"  >userid int,</font></div><div><font size="2"  >logout_time timestamp without time zone,</font></div><div><font size="2"  >ip inet</font></div><div><font size="2"  >);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >-- 在172.16.3.33上面初始化数据,作为root节点.</font></div><div><font size="2"  >insert into user_info (userid,engname,cnname,occupation,birthday,signname,email,qq,crt_time,mod_time)</font></div><div><font size="2"  >select generate_series(1,200000),</font></div><div><font size="2"  >'digoal.zhou',</font></div><div><font size="2"  >'德哥',</font></div><div><font size="2"  >'DBA',</font></div><div><font size="2"  >'1970-01-01'</font></div><div><font size="2"  >,E'公益是一辈子的事, I\'m Digoal.Zhou, Just do it!',</font></div><div><font size="2"  >'digoal@126.com',</font></div><div><font size="2"  >276732431,</font></div><div><font size="2"  >clock_timestamp(),</font></div><div><font size="2"  >NULL;</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >insert into user_session (userid) select generate_series(1,200000);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >-- 在所有节点添加这两个表的主键</font></div><div><font size="2"  >set work_mem='2048MB';</font></div><div><font size="2"  >set maintenance_work_mem='2048MB';</font></div><div><font size="2"  >alter table user_info add constraint pk_user_info primary key (userid);</font></div><div><font size="2"  >alter table user_session add constraint pk_user_session primary key (userid);</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >-- 在所有节点创建业务函数</font></div><div><font size="2"  >-- 模拟用户登录的函数</font></div><div><font size="2"  >create or replace function f_user_login&nbsp;</font></div><div><font size="2"  >(i_userid int,</font></div><div><font size="2"  >OUT o_userid int,</font></div><div><font size="2"  >OUT o_engname text,</font></div><div><font size="2"  >OUT o_cnname text,</font></div><div><font size="2"  >OUT o_occupation text,</font></div><div><font size="2"  >OUT o_birthday date,</font></div><div><font size="2"  >OUT o_signname text,</font></div><div><font size="2"  >OUT o_email text,</font></div><div><font size="2"  >OUT o_qq numeric</font></div><div><font size="2"  >)</font></div><div><font size="2"  >as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >select userid,engname,cnname,occupation,birthday,signname,email,qq</font></div><div><font size="2"  >into o_userid,o_engname,o_cnname,o_occupation,o_birthday,o_signname,o_email,o_qq</font></div><div><font size="2"  >from user_info where userid=i_userid;</font></div><div><font size="2"  >insert into user_login_rec (userid,login_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div><font size="2"  >update user_session set logintime=now(),login_count=login_count+1 where userid=i_userid;</font></div><div><font size="2"  >return;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$BODY$</font></div><div><font size="2"  >language plpgsql;</font></div><div><font size="2"  >-- 模拟用户退出的函数</font></div><div><font size="2"  >create or replace function f_user_logout</font></div><div><font size="2"  >(i_userid int,</font></div><div><font size="2"  >OUT o_result int</font></div><div><font size="2"  >)</font></div><div><font size="2"  >as $BODY$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >insert into user_logout_rec (userid,logout_time,ip) values (i_userid,now(),inet_client_addr());</font></div><div><font size="2"  >update user_session set logouttime=now(),online_interval=online_interval+(now()-logintime) where userid=i_userid;</font></div><div><font size="2"  >o_result := 0;</font></div><div><font size="2"  >return;</font></div><div><font size="2"  >exception&nbsp;</font></div><div><font size="2"  >when others then</font></div><div><font size="2"  >o_result := 1;</font></div><div><font size="2"  >return;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$BODY$</font></div><div><font size="2"  >language plpgsql;</font></div><p></p></pre></div><div><br></div><div><br></div><div>四、级联复制测试</div><div>-- 在运行worker进程的服务器上(本例选择的是172.16.3.33)创建配置文件目录, 日志目录, pid文件目录等</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >mkdir -p /home/pg92/skylondist/log</font></div><div><font size="2"  >mkdir -p /home/pg92/skylondist/pid</font></div><div><font size="2"  >mkdir -p /home/pg92/skylondist/etc</font></div><p></p></pre></div><div>-- 创建pgqd配置文件, database_list表示这个QUEUE要级联的涉及的库, 本例全部用的是digoal, 所以不需要配置其他的, 如果后续增加了其他库名加入到级联, 则需要添加到database_list中,逗号隔开.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >vi /home/pg92/skylondist/etc/pgqd.ini</font></div><div><font size="2"  >[pgqd]</font></div><div><font size="2"  >base_connstr = host=172.16.3.33 port=1919 user=londiste password=londiste</font></div><div><font size="2"  >initial_database = template1</font></div><div><font size="2"  >database_list = digoal</font></div><div><font size="2"  >logfile = /home/pg92/skylondist/log/pgqd.log</font></div><div><font size="2"  >pidfile = /home/pg92/skylondist/pid/pgqd.pid</font></div><p></p></pre></div><div><br></div><div>-- 创建级联中包含的节点的配置文件,节点1</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >vi /home/pg92/skylondist/etc/digoal_33.ini</font></div><div><font size="2"  >[londiste3]</font></div><div><font size="2"  >job_name = digoal_33</font></div><div><font size="2"  >db = host=172.16.3.33 port=1919 user=londiste dbname=digoal password=londiste</font></div><div><font size="2"  >queue_name = replika</font></div><div><font size="2"  >logfile = /home/pg92/skylondist/log/%(job_name)s.log</font></div><div><font size="2"  >pidfile = /home/pg92/skylondist/pid/%(job_name)s.pid</font></div><div><font size="2"  >pgq_autocommit = 1</font></div><div><font size="2"  >pgq_lazy_fetch = 0</font></div><div><font size="2"  >parallel_copies = 16</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >vi /home/pg92/skylondist/etc/digoal_39.ini</font></div><div><font size="2"  >[londiste3]</font></div><div><font size="2"  >job_name = digoal_39</font></div><div><font size="2"  >db = host=172.16.3.39 port=1921 user=londiste dbname=digoal password=londiste</font></div><div><font size="2"  >queue_name = replika</font></div><div><font size="2"  >logfile = /home/pg92/skylondist/log/%(job_name)s.log</font></div><div><font size="2"  >pidfile = /home/pg92/skylondist/pid/%(job_name)s.pid</font></div><div><font size="2"  >pgq_autocommit = 1</font></div><div><font size="2"  >pgq_lazy_fetch = 0</font></div><div><font size="2"  >parallel_copies = 16</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >vi /home/pg92/skylondist/etc/digoal_40.ini</font></div><div><font size="2"  >[londiste3]</font></div><div><font size="2"  >job_name = digoal_40</font></div><div><font size="2"  >db = host=172.16.3.40 port=1921 user=londiste dbname=digoal password=londiste</font></div><div><font size="2"  >queue_name = replika</font></div><div><font size="2"  >logfile = /home/pg92/skylondist/log/%(job_name)s.log</font></div><div><font size="2"  >pidfile = /home/pg92/skylondist/pid/%(job_name)s.pid</font></div><div><font size="2"  >pgq_autocommit = 1</font></div><div><font size="2"  >pgq_lazy_fetch = 0</font></div><div><font size="2"  >parallel_copies = 16</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >vi /home/pg92/skylondist/etc/digoal_150.ini</font></div><div><font size="2"  >[londiste3]</font></div><div><font size="2"  >job_name = digoal_150</font></div><div><font size="2"  >db = host=172.16.3.150 port=1919 user=londiste dbname=digoal password=londiste</font></div><div><font size="2"  >queue_name = replika</font></div><div><font size="2"  >logfile = /home/pg92/skylondist/log/%(job_name)s.log</font></div><div><font size="2"  >pidfile = /home/pg92/skylondist/pid/%(job_name)s.pid</font></div><div><font size="2"  >pgq_autocommit = 1</font></div><div><font size="2"  >pgq_lazy_fetch = 0</font></div><div><font size="2"  >parallel_copies = 16</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >vi /home/pg92/skylondist/etc/digoal_176.ini</font></div><div><font size="2"  >[londiste3]</font></div><div><font size="2"  >job_name = digoal_176</font></div><div><font size="2"  >db = host=172.16.3.176 port=1921 user=londiste dbname=digoal password=londiste</font></div><div><font size="2"  >queue_name = replika</font></div><div><font size="2"  >logfile = /home/pg92/skylondist/log/%(job_name)s.log</font></div><div><font size="2"  >pidfile = /home/pg92/skylondist/pid/%(job_name)s.pid</font></div><div><font size="2"  >pgq_autocommit = 1</font></div><div><font size="2"  >pgq_lazy_fetch = 0</font></div><div><font size="2"  >parallel_copies = 16</font></div><p></p></pre></div><div><br></div><div><br></div><div>-- 在172.16.3.33上使用以上配置文件执行londiste3加载londiste3以及初始化节点</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >londiste3 -v /home/pg92/skylondist/etc/digoal_33.ini create-root digoal_33 "host=172.16.3.33 port=1919 user=londiste dbname=digoal password=londiste"</font></div><div><font size="2"  >londiste3 -v /home/pg92/skylondist/etc/digoal_39.ini create-branch digoal_39 "host=172.16.3.39 port=1921 user=londiste dbname=digoal password=londiste" --provider="host=172.16.3.33 port=1919 user=londiste dbname=digoal password=londiste"</font></div><div><font size="2"  >londiste3 -v /home/pg92/skylondist/etc/digoal_40.ini create-branch digoal_40 "host=172.16.3.40 port=1921 user=londiste dbname=digoal password=londiste" --provider="host=172.16.3.33 port=1919 user=londiste dbname=digoal password=londiste"</font></div><div><font size="2"  >londiste3 -v /home/pg92/skylondist/etc/digoal_150.ini create-branch digoal_150 "host=172.16.3.150 port=1919 user=londiste dbname=digoal password=londiste" --provider="host=172.16.3.33 port=1919 user=londiste dbname=digoal password=londiste"</font></div><div><font size="2"  >londiste3 -v /home/pg92/skylondist/etc/digoal_176.ini create-branch digoal_176 "host=172.16.3.176 port=1921 user=londiste dbname=digoal password=londiste" --provider="host=172.16.3.33 port=1919 user=londiste dbname=digoal password=londiste"</font></div><p></p></pre></div><div><br></div><div>-- 详细的初始化日志</div><div><br></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pg92@db-172-16-3-33-&gt; londiste3 -v /home/pg92/skylondist/etc/digoal_33.ini create-root digoal_33 "host=172.16.3.33 port=1919 user=londiste dbname=digoal password=londiste"</font></div><div><font size="2"  >2012-06-05 09:10:36,740 7240 DEBUG Connect 'new_node' to 'host=172.16.3.33 port=1919 user=londiste dbname=digoal &nbsp;[...]'</font></div><div><font size="2"  >2012-06-05 09:10:36,745 7240 INFO plpgsql is installed</font></div><div><font size="2"  >2012-06-05 09:10:36,746 7240 INFO Installing pgq</font></div><div><font size="2"  >2012-06-05 09:10:36,746 7240 INFO &nbsp; Reading from /opt/python2.7.3/share/skytools3/pgq.sql</font></div><div><font size="2"  >2012-06-05 09:10:37,050 7240 INFO pgq.get_batch_cursor is installed</font></div><div><font size="2"  >2012-06-05 09:10:37,050 7240 INFO Installing pgq_ext</font></div><div><font size="2"  >2012-06-05 09:10:37,050 7240 INFO &nbsp; Reading from /opt/python2.7.3/share/skytools3/pgq_ext.sql</font></div><div><font size="2"  >2012-06-05 09:10:37,208 7240 INFO Installing pgq_node</font></div><div><font size="2"  >2012-06-05 09:10:37,208 7240 INFO &nbsp; Reading from /opt/python2.7.3/share/skytools3/pgq_node.sql</font></div><div><font size="2"  >2012-06-05 09:10:37,443 7240 INFO Installing londiste</font></div><div><font size="2"  >2012-06-05 09:10:37,443 7240 INFO &nbsp; Reading from /opt/python2.7.3/share/skytools3/londiste.sql</font></div><div><font size="2"  >2012-06-05 09:10:37,680 7240 INFO londiste.global_add_table is installed</font></div><div><font size="2"  >2012-06-05 09:10:37,681 7240 DEBUG exec_query: select * from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-06-05 09:10:37,683 7240 INFO Initializing node</font></div><div><font size="2"  >2012-06-05 09:10:37,683 7240 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'digoal_33', 'host=172.16.3.33 port=1919 user=londiste dbname=digoal password=londiste', false)</font></div><div><font size="2"  >2012-06-05 09:10:37,684 7240 INFO Location registered</font></div><div><font size="2"  >2012-06-05 09:10:37,685 7240 DEBUG exec_cmd: select * from pgq_node.create_node('replika', 'root', 'digoal_33', 'digoal_33', null, null, null)</font></div><div><font size="2"  >2012-06-05 09:10:37,872 7240 INFO Node "digoal_33" initialized for queue "replika" with type "root"</font></div><div><font size="2"  >2012-06-05 09:10:37,872 7240 INFO Done</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >pg92@db-172-16-3-33-&gt; londiste3 -v /home/pg92/skylondist/etc/digoal_39.ini create-branch digoal_39 "host=172.16.3.39 port=1921 user=londiste dbname=digoal password=londiste" --provider="host=172.16.3.33 port=1919 user=londiste dbname=digoal password=londiste"</font></div><div><font size="2"  >2012-06-05 09:18:50,148 7309 DEBUG Connect 'new_node' to 'host=172.16.3.39 port=1921 user=londiste dbname=digoal &nbsp;[...]'</font></div><div><font size="2"  >2012-06-05 09:18:50,157 7309 INFO plpgsql is installed</font></div><div><font size="2"  >2012-06-05 09:18:50,158 7309 INFO pgq is installed</font></div><div><font size="2"  >2012-06-05 09:18:50,159 7309 INFO pgq.get_batch_cursor is installed</font></div><div><font size="2"  >2012-06-05 09:18:50,160 7309 INFO pgq_ext is installed</font></div><div><font size="2"  >2012-06-05 09:18:50,160 7309 INFO pgq_node is installed</font></div><div><font size="2"  >2012-06-05 09:18:50,160 7309 INFO londiste is installed</font></div><div><font size="2"  >2012-06-05 09:18:50,161 7309 INFO londiste.global_add_table is installed</font></div><div><font size="2"  >2012-06-05 09:18:50,162 7309 DEBUG exec_query: select * from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-06-05 09:18:50,166 7309 INFO Initializing node</font></div><div><font size="2"  >2012-06-05 09:18:50,166 7309 DEBUG Connect 'root_db' to 'host=172.16.3.33 port=1919 user=londiste dbname=digoal &nbsp;[...]'</font></div><div><font size="2"  >2012-06-05 09:18:50,169 7309 DEBUG exec_query: select * from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-06-05 09:18:50,176 7309 DEBUG db='host=172.16.3.33 port=1919 user=londiste dbname=digoal password=londiste' -- type='root' provider='host=172.16.3.33 port=1919 user=londiste dbname=digoal password=londiste'</font></div><div><font size="2"  >2012-06-05 09:18:50,176 7309 DEBUG exec_query: select * from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-06-05 09:18:50,178 7309 DEBUG exec_query: select * from pgq_node.get_queue_locations('replika')</font></div><div><font size="2"  >2012-06-05 09:18:50,179 7309 DEBUG Connect 'provider_db' to 'host=172.16.3.33 port=1919 user=londiste dbname=digoal &nbsp;[...]'</font></div><div><font size="2"  >2012-06-05 09:18:50,181 7309 DEBUG exec_query: select node_type, node_name from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-06-05 09:18:50,188 7309 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'digoal_39', 'host=172.16.3.39 port=1921 user=londiste dbname=digoal password=londiste', false)</font></div><div><font size="2"  >2012-06-05 09:18:50,191 7309 INFO Location registered</font></div><div><font size="2"  >2012-06-05 09:18:50,191 7309 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'digoal_39', 'host=172.16.3.39 port=1921 user=londiste dbname=digoal password=londiste', false)</font></div><div><font size="2"  >2012-06-05 09:18:50,194 7309 INFO Location registered</font></div><div><font size="2"  >2012-06-05 09:18:50,194 7309 DEBUG exec_cmd: select * from pgq_node.register_subscriber('replika', 'digoal_39', 'digoal_39', null)</font></div><div><font size="2"  >2012-06-05 09:18:50,198 7309 INFO Subscriber registered: digoal_39</font></div><div><font size="2"  >2012-06-05 09:18:50,198 7309 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'digoal_39', 'host=172.16.3.39 port=1921 user=londiste dbname=digoal password=londiste', false)</font></div><div><font size="2"  >2012-06-05 09:18:50,200 7309 INFO Location registered</font></div><div><font size="2"  >2012-06-05 09:18:50,200 7309 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'digoal_33', 'host=172.16.3.33 port=1919 user=londiste dbname=digoal password=londiste', 'False')</font></div><div><font size="2"  >2012-06-05 09:18:50,201 7309 INFO Location registered</font></div><div><font size="2"  >2012-06-05 09:18:50,202 7309 DEBUG exec_cmd: select * from pgq_node.create_node('replika', 'branch', 'digoal_39', 'digoal_39', 'digoal_33', '1', null)</font></div><div><font size="2"  >2012-06-05 09:18:50,261 7309 INFO Node "digoal_39" initialized for queue "replika" with type "branch"</font></div><div><font size="2"  >2012-06-05 09:18:50,263 7309 INFO Done</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >pg92@db-172-16-3-33-&gt; londiste3 -v /home/pg92/skylondist/etc/digoal_40.ini create-branch digoal_40 "host=172.16.3.40 port=1921 user=londiste dbname=digoal password=londiste" --provider="host=172.16.3.33 port=1919 user=londiste dbname=digoal password=londiste"</font></div><div><font size="2"  >2012-06-05 09:19:00,842 7314 DEBUG Connect 'new_node' to 'host=172.16.3.40 port=1921 user=londiste dbname=digoal &nbsp;[...]'</font></div><div><font size="2"  >2012-06-05 09:19:00,852 7314 INFO plpgsql is installed</font></div><div><font size="2"  >2012-06-05 09:19:00,853 7314 INFO Installing pgq</font></div><div><font size="2"  >2012-06-05 09:19:00,853 7314 INFO &nbsp; Reading from /opt/python2.7.3/share/skytools3/pgq.sql</font></div><div><font size="2"  >2012-06-05 09:19:00,971 7314 INFO pgq.get_batch_cursor is installed</font></div><div><font size="2"  >2012-06-05 09:19:00,972 7314 INFO Installing pgq_ext</font></div><div><font size="2"  >2012-06-05 09:19:00,972 7314 INFO &nbsp; Reading from /opt/python2.7.3/share/skytools3/pgq_ext.sql</font></div><div><font size="2"  >2012-06-05 09:19:01,023 7314 INFO Installing pgq_node</font></div><div><font size="2"  >2012-06-05 09:19:01,023 7314 INFO &nbsp; Reading from /opt/python2.7.3/share/skytools3/pgq_node.sql</font></div><div><font size="2"  >2012-06-05 09:19:01,121 7314 INFO Installing londiste</font></div><div><font size="2"  >2012-06-05 09:19:01,122 7314 INFO &nbsp; Reading from /opt/python2.7.3/share/skytools3/londiste.sql</font></div><div><font size="2"  >2012-06-05 09:19:01,211 7314 INFO londiste.global_add_table is installed</font></div><div><font size="2"  >2012-06-05 09:19:01,212 7314 DEBUG exec_query: select * from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-06-05 09:19:01,216 7314 INFO Initializing node</font></div><div><font size="2"  >2012-06-05 09:19:01,216 7314 DEBUG Connect 'root_db' to 'host=172.16.3.33 port=1919 user=londiste dbname=digoal &nbsp;[...]'</font></div><div><font size="2"  >2012-06-05 09:19:01,220 7314 DEBUG exec_query: select * from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-06-05 09:19:01,227 7314 DEBUG db='host=172.16.3.33 port=1919 user=londiste dbname=digoal password=londiste' -- type='root' provider='host=172.16.3.33 port=1919 user=londiste dbname=digoal password=londiste'</font></div><div><font size="2"  >2012-06-05 09:19:01,227 7314 DEBUG exec_query: select * from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-06-05 09:19:01,229 7314 DEBUG exec_query: select * from pgq_node.get_queue_locations('replika')</font></div><div><font size="2"  >2012-06-05 09:19:01,229 7314 DEBUG Connect 'provider_db' to 'host=172.16.3.33 port=1919 user=londiste dbname=digoal &nbsp;[...]'</font></div><div><font size="2"  >2012-06-05 09:19:01,232 7314 DEBUG exec_query: select node_type, node_name from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-06-05 09:19:01,239 7314 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'digoal_40', 'host=172.16.3.40 port=1921 user=londiste dbname=digoal password=londiste', false)</font></div><div><font size="2"  >2012-06-05 09:19:01,242 7314 INFO Location registered</font></div><div><font size="2"  >2012-06-05 09:19:01,242 7314 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'digoal_40', 'host=172.16.3.40 port=1921 user=londiste dbname=digoal password=londiste', false)</font></div><div><font size="2"  >2012-06-05 09:19:01,244 7314 INFO Location registered</font></div><div><font size="2"  >2012-06-05 09:19:01,244 7314 DEBUG exec_cmd: select * from pgq_node.register_subscriber('replika', 'digoal_40', 'digoal_40', null)</font></div><div><font size="2"  >2012-06-05 09:19:01,248 7314 INFO Subscriber registered: digoal_40</font></div><div><font size="2"  >2012-06-05 09:19:01,248 7314 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'digoal_40', 'host=172.16.3.40 port=1921 user=londiste dbname=digoal password=londiste', false)</font></div><div><font size="2"  >2012-06-05 09:19:01,250 7314 INFO Location registered</font></div><div><font size="2"  >2012-06-05 09:19:01,250 7314 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'digoal_33', 'host=172.16.3.33 port=1919 user=londiste dbname=digoal password=londiste', 'False')</font></div><div><font size="2"  >2012-06-05 09:19:01,251 7314 INFO Location registered</font></div><div><font size="2"  >2012-06-05 09:19:01,251 7314 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'digoal_39', 'host=172.16.3.39 port=1921 user=londiste dbname=digoal password=londiste', 'False')</font></div><div><font size="2"  >2012-06-05 09:19:01,252 7314 INFO Location registered</font></div><div><font size="2"  >2012-06-05 09:19:01,252 7314 DEBUG exec_cmd: select * from pgq_node.create_node('replika', 'branch', 'digoal_40', 'digoal_40', 'digoal_33', '1', null)</font></div><div><font size="2"  >2012-06-05 09:19:01,298 7314 INFO Node "digoal_40" initialized for queue "replika" with type "branch"</font></div><div><font size="2"  >2012-06-05 09:19:01,300 7314 INFO Done</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >pg92@db-172-16-3-33-&gt; londiste3 -v /home/pg92/skylondist/etc/digoal_150.ini create-branch digoal_150 "host=172.16.3.150 port=1919 user=londiste dbname=digoal password=londiste" --provider="host=172.16.3.33 port=1919 user=londiste dbname=digoal password=londiste"</font></div><div><font size="2"  >2012-06-05 09:19:07,065 7317 DEBUG Connect 'new_node' to 'host=172.16.3.150 port=1919 user=londiste dbname=digoal &nbsp;[...]'</font></div><div><font size="2"  >2012-06-05 09:19:07,073 7317 INFO plpgsql is installed</font></div><div><font size="2"  >2012-06-05 09:19:07,073 7317 INFO Installing pgq</font></div><div><font size="2"  >2012-06-05 09:19:07,074 7317 INFO &nbsp; Reading from /opt/python2.7.3/share/skytools3/pgq.sql</font></div><div><font size="2"  >2012-06-05 09:19:07,223 7317 INFO pgq.get_batch_cursor is installed</font></div><div><font size="2"  >2012-06-05 09:19:07,223 7317 INFO Installing pgq_ext</font></div><div><font size="2"  >2012-06-05 09:19:07,223 7317 INFO &nbsp; Reading from /opt/python2.7.3/share/skytools3/pgq_ext.sql</font></div><div><font size="2"  >2012-06-05 09:19:07,270 7317 INFO Installing pgq_node</font></div><div><font size="2"  >2012-06-05 09:19:07,271 7317 INFO &nbsp; Reading from /opt/python2.7.3/share/skytools3/pgq_node.sql</font></div><div><font size="2"  >2012-06-05 09:19:07,325 7317 INFO Installing londiste</font></div><div><font size="2"  >2012-06-05 09:19:07,325 7317 INFO &nbsp; Reading from /opt/python2.7.3/share/skytools3/londiste.sql</font></div><div><font size="2"  >2012-06-05 09:19:07,408 7317 INFO londiste.global_add_table is installed</font></div><div><font size="2"  >2012-06-05 09:19:07,409 7317 DEBUG exec_query: select * from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-06-05 09:19:07,413 7317 INFO Initializing node</font></div><div><font size="2"  >2012-06-05 09:19:07,413 7317 DEBUG Connect 'root_db' to 'host=172.16.3.33 port=1919 user=londiste dbname=digoal &nbsp;[...]'</font></div><div><font size="2"  >2012-06-05 09:19:07,416 7317 DEBUG exec_query: select * from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-06-05 09:19:07,423 7317 DEBUG db='host=172.16.3.33 port=1919 user=londiste dbname=digoal password=londiste' -- type='root' provider='host=172.16.3.33 port=1919 user=londiste dbname=digoal password=londiste'</font></div><div><font size="2"  >2012-06-05 09:19:07,423 7317 DEBUG exec_query: select * from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-06-05 09:19:07,425 7317 DEBUG exec_query: select * from pgq_node.get_queue_locations('replika')</font></div><div><font size="2"  >2012-06-05 09:19:07,425 7317 DEBUG Connect 'provider_db' to 'host=172.16.3.33 port=1919 user=londiste dbname=digoal &nbsp;[...]'</font></div><div><font size="2"  >2012-06-05 09:19:07,429 7317 DEBUG exec_query: select node_type, node_name from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-06-05 09:19:07,436 7317 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'digoal_150', 'host=172.16.3.150 port=1919 user=londiste dbname=digoal password=londiste', false)</font></div><div><font size="2"  >2012-06-05 09:19:07,438 7317 INFO Location registered</font></div><div><font size="2"  >2012-06-05 09:19:07,439 7317 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'digoal_150', 'host=172.16.3.150 port=1919 user=londiste dbname=digoal password=londiste', false)</font></div><div><font size="2"  >2012-06-05 09:19:07,441 7317 INFO Location registered</font></div><div><font size="2"  >2012-06-05 09:19:07,441 7317 DEBUG exec_cmd: select * from pgq_node.register_subscriber('replika', 'digoal_150', 'digoal_150', null)</font></div><div><font size="2"  >2012-06-05 09:19:07,445 7317 INFO Subscriber registered: digoal_150</font></div><div><font size="2"  >2012-06-05 09:19:07,445 7317 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'digoal_150', 'host=172.16.3.150 port=1919 user=londiste dbname=digoal password=londiste', false)</font></div><div><font size="2"  >2012-06-05 09:19:07,447 7317 INFO Location registered</font></div><div><font size="2"  >2012-06-05 09:19:07,447 7317 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'digoal_33', 'host=172.16.3.33 port=1919 user=londiste dbname=digoal password=londiste', 'False')</font></div><div><font size="2"  >2012-06-05 09:19:07,448 7317 INFO Location registered</font></div><div><font size="2"  >2012-06-05 09:19:07,449 7317 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'digoal_39', 'host=172.16.3.39 port=1921 user=londiste dbname=digoal password=londiste', 'False')</font></div><div><font size="2"  >2012-06-05 09:19:07,449 7317 INFO Location registered</font></div><div><font size="2"  >2012-06-05 09:19:07,450 7317 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'digoal_40', 'host=172.16.3.40 port=1921 user=londiste dbname=digoal password=londiste', 'False')</font></div><div><font size="2"  >2012-06-05 09:19:07,450 7317 INFO Location registered</font></div><div><font size="2"  >2012-06-05 09:19:07,451 7317 DEBUG exec_cmd: select * from pgq_node.create_node('replika', 'branch', 'digoal_150', 'digoal_150', 'digoal_33', '1', null)</font></div><div><font size="2"  >2012-06-05 09:19:07,490 7317 INFO Node "digoal_150" initialized for queue "replika" with type "branch"</font></div><div><font size="2"  >2012-06-05 09:19:07,492 7317 INFO Done</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >pg92@db-172-16-3-33-&gt; londiste3 -v /home/pg92/skylondist/etc/digoal_176.ini create-branch digoal_176 "host=172.16.3.176 port=1921 user=londiste dbname=digoal password=londiste" --provider="host=172.16.3.33 port=1919 user=londiste dbname=digoal password=londiste"</font></div><div><font size="2"  >2012-06-05 09:19:14,456 7321 DEBUG Connect 'new_node' to 'host=172.16.3.176 port=1921 user=londiste dbname=digoal &nbsp;[...]'</font></div><div><font size="2"  >2012-06-05 09:19:14,464 7321 INFO plpgsql is installed</font></div><div><font size="2"  >2012-06-05 09:19:14,465 7321 INFO Installing pgq</font></div><div><font size="2"  >2012-06-05 09:19:14,465 7321 INFO &nbsp; Reading from /opt/python2.7.3/share/skytools3/pgq.sql</font></div><div><font size="2"  >2012-06-05 09:19:14,922 7321 INFO pgq.get_batch_cursor is installed</font></div><div><font size="2"  >2012-06-05 09:19:14,923 7321 INFO Installing pgq_ext</font></div><div><font size="2"  >2012-06-05 09:19:14,923 7321 INFO &nbsp; Reading from /opt/python2.7.3/share/skytools3/pgq_ext.sql</font></div><div><font size="2"  >2012-06-05 09:19:15,159 7321 INFO Installing pgq_node</font></div><div><font size="2"  >2012-06-05 09:19:15,160 7321 INFO &nbsp; Reading from /opt/python2.7.3/share/skytools3/pgq_node.sql</font></div><div><font size="2"  >2012-06-05 09:19:15,422 7321 INFO Installing londiste</font></div><div><font size="2"  >2012-06-05 09:19:15,422 7321 INFO &nbsp; Reading from /opt/python2.7.3/share/skytools3/londiste.sql</font></div><div><font size="2"  >2012-06-05 09:19:15,724 7321 INFO londiste.global_add_table is installed</font></div><div><font size="2"  >2012-06-05 09:19:15,725 7321 DEBUG exec_query: select * from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-06-05 09:19:15,728 7321 INFO Initializing node</font></div><div><font size="2"  >2012-06-05 09:19:15,729 7321 DEBUG Connect 'root_db' to 'host=172.16.3.33 port=1919 user=londiste dbname=digoal &nbsp;[...]'</font></div><div><font size="2"  >2012-06-05 09:19:15,731 7321 DEBUG exec_query: select * from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-06-05 09:19:15,739 7321 DEBUG db='host=172.16.3.33 port=1919 user=londiste dbname=digoal password=londiste' -- type='root' provider='host=172.16.3.33 port=1919 user=londiste dbname=digoal password=londiste'</font></div><div><font size="2"  >2012-06-05 09:19:15,739 7321 DEBUG exec_query: select * from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-06-05 09:19:15,740 7321 DEBUG exec_query: select * from pgq_node.get_queue_locations('replika')</font></div><div><font size="2"  >2012-06-05 09:19:15,741 7321 DEBUG Connect 'provider_db' to 'host=172.16.3.33 port=1919 user=londiste dbname=digoal &nbsp;[...]'</font></div><div><font size="2"  >2012-06-05 09:19:15,744 7321 DEBUG exec_query: select node_type, node_name from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-06-05 09:19:15,751 7321 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'digoal_176', 'host=172.16.3.176 port=1921 user=londiste dbname=digoal password=londiste', false)</font></div><div><font size="2"  >2012-06-05 09:19:15,754 7321 INFO Location registered</font></div><div><font size="2"  >2012-06-05 09:19:15,754 7321 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'digoal_176', 'host=172.16.3.176 port=1921 user=londiste dbname=digoal password=londiste', false)</font></div><div><font size="2"  >2012-06-05 09:19:15,756 7321 INFO Location registered</font></div><div><font size="2"  >2012-06-05 09:19:15,756 7321 DEBUG exec_cmd: select * from pgq_node.register_subscriber('replika', 'digoal_176', 'digoal_176', null)</font></div><div><font size="2"  >2012-06-05 09:19:15,760 7321 INFO Subscriber registered: digoal_176</font></div><div><font size="2"  >2012-06-05 09:19:15,760 7321 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'digoal_176', 'host=172.16.3.176 port=1921 user=londiste dbname=digoal password=londiste', false)</font></div><div><font size="2"  >2012-06-05 09:19:15,761 7321 INFO Location registered</font></div><div><font size="2"  >2012-06-05 09:19:15,762 7321 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'digoal_33', 'host=172.16.3.33 port=1919 user=londiste dbname=digoal password=londiste', 'False')</font></div><div><font size="2"  >2012-06-05 09:19:15,762 7321 INFO Location registered</font></div><div><font size="2"  >2012-06-05 09:19:15,763 7321 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'digoal_150', 'host=172.16.3.150 port=1919 user=londiste dbname=digoal password=londiste', 'False')</font></div><div><font size="2"  >2012-06-05 09:19:15,763 7321 INFO Location registered</font></div><div><font size="2"  >2012-06-05 09:19:15,764 7321 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'digoal_39', 'host=172.16.3.39 port=1921 user=londiste dbname=digoal password=londiste', 'False')</font></div><div><font size="2"  >2012-06-05 09:19:15,764 7321 INFO Location registered</font></div><div><font size="2"  >2012-06-05 09:19:15,765 7321 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'digoal_40', 'host=172.16.3.40 port=1921 user=londiste dbname=digoal password=londiste', 'False')</font></div><div><font size="2"  >2012-06-05 09:19:15,765 7321 INFO Location registered</font></div><div><font size="2"  >2012-06-05 09:19:15,765 7321 DEBUG exec_cmd: select * from pgq_node.create_node('replika', 'branch', 'digoal_176', 'digoal_176', 'digoal_33', '1', null)</font></div><div><font size="2"  >2012-06-05 09:19:16,041 7321 INFO Node "digoal_176" initialized for queue "replika" with type "branch"</font></div><div><font size="2"  >2012-06-05 09:19:16,043 7321 INFO Done</font></div><p></p></pre></div><div><br></div><div><br></div><div>-- 启动pgqd进程</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pg92@db-172-16-3-33-&gt; pgqd -d /home/pg92/skylondist/etc/pgqd.ini</font></div><div><font size="2"  >2012-06-05 09:20:57.298 7346 LOG Starting pgqd 3.0.3</font></div><p></p></pre></div><div><br></div><div><br></div><div>-- 查看当前的TOP和membership</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pg92@db-172-16-3-33-&gt; londiste3 -v /home/pg92/skylondist/etc/digoal_33.ini status</font></div><div><font size="2"  >2012-06-05 09:21:44,988 7363 DEBUG Connect 'db' to 'host=172.16.3.33 port=1919 user=londiste dbname=digoal &nbsp;[...]'</font></div><div><font size="2"  >2012-06-05 09:21:44,991 7363 DEBUG exec_query: select * from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-06-05 09:21:44,999 7363 DEBUG exec_query: select * from pgq_node.get_queue_locations('replika')</font></div><div><font size="2"  >2012-06-05 09:21:45,000 7363 DEBUG Connect 'look_db' to 'host=172.16.3.33 port=1919 user=londiste dbname=digoal &nbsp;[...]'</font></div><div><font size="2"  >2012-06-05 09:21:45,014 7363 DEBUG Connect 'look_db' to 'host=172.16.3.150 port=1919 user=londiste dbname=digoal &nbsp;[...]'</font></div><div><font size="2"  >2012-06-05 09:21:45,038 7363 DEBUG Connect 'look_db' to 'host=172.16.3.39 port=1921 user=londiste dbname=digoal &nbsp;[...]'</font></div><div><font size="2"  >2012-06-05 09:21:45,058 7363 DEBUG Connect 'look_db' to 'host=172.16.3.40 port=1921 user=londiste dbname=digoal &nbsp;[...]'</font></div><div><font size="2"  >2012-06-05 09:21:45,077 7363 DEBUG Connect 'look_db' to 'host=172.16.3.176 port=1921 user=londiste dbname=digoal &nbsp;[...]'</font></div><div><font size="2"  >Queue: replika &nbsp; Local node: digoal_33</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal_33 (root)</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Tables: 0/0/0</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Lag: 22s, Tick: 5, NOT UPTODATE</font></div><div><font size="2"  >&nbsp; +--digoal_150 (branch)</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Tables: 0/0/0</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Lag: 11m7s, Tick: 1, NOT UPTODATE</font></div><div><font size="2"  >&nbsp; +--digoal_176 (branch)</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Tables: 0/0/0</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Lag: 11m7s, Tick: 1, NOT UPTODATE</font></div><div><font size="2"  >&nbsp; +--digoal_39 (branch)</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Tables: 0/0/0</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Lag: 11m7s, Tick: 1, NOT UPTODATE</font></div><div><font size="2"  >&nbsp; +--digoal_40 (branch)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Tables: 0/0/0</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Lag: 11m7s, Tick: 1, NOT UPTODATE</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >pg92@db-172-16-3-33-&gt; londiste3 -v /home/pg92/skylondist/etc/digoal_33.ini members</font></div><div><font size="2"  >2012-06-05 09:21:51,517 7366 DEBUG Connect 'db' to 'host=172.16.3.33 port=1919 user=londiste dbname=digoal &nbsp;[...]'</font></div><div><font size="2"  >2012-06-05 09:21:51,520 7366 DEBUG exec_query: select * from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-06-05 09:21:51,528 7366 DEBUG exec_query: select * from pgq_node.get_queue_locations('replika')</font></div><div><font size="2"  >2012-06-05 09:21:51,528 7366 DEBUG display_table: select node_name, dead, node_location from pgq_node.get_queue_locations('replika') order by 1</font></div><div><font size="2"  >Member info on digoal_33@replika:</font></div><div><font size="2"  >node_name &nbsp; &nbsp; &nbsp; &nbsp;dead &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; node_location</font></div><div><font size="2"  >--------------- &nbsp;--------------- &nbsp;-------------------------------------------------------------------------</font></div><div><font size="2"  >digoal_150 &nbsp; &nbsp; &nbsp; False &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;host=172.16.3.150 port=1919 user=londiste dbname=digoal password=londiste</font></div><div><font size="2"  >digoal_176 &nbsp; &nbsp; &nbsp; False &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;host=172.16.3.176 port=1921 user=londiste dbname=digoal password=londiste</font></div><div><font size="2"  >digoal_33 &nbsp; &nbsp; &nbsp; &nbsp;False &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;host=172.16.3.33 port=1919 user=londiste dbname=digoal password=londiste</font></div><div><font size="2"  >digoal_39 &nbsp; &nbsp; &nbsp; &nbsp;False &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;host=172.16.3.39 port=1921 user=londiste dbname=digoal password=londiste</font></div><div><font size="2"  >digoal_40 &nbsp; &nbsp; &nbsp; &nbsp;False &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;host=172.16.3.40 port=1921 user=londiste dbname=digoal password=londiste</font></div><p></p></pre></div><div><br></div><div><br></div><div>-- 启动worker进程</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >londiste3 -d /home/pg92/skylondist/etc/digoal_33.ini worker</font></div><div><font size="2"  >londiste3 -d /home/pg92/skylondist/etc/digoal_39.ini worker</font></div><div><font size="2"  >londiste3 -d /home/pg92/skylondist/etc/digoal_40.ini worker</font></div><div><font size="2"  >londiste3 -d /home/pg92/skylondist/etc/digoal_150.ini worker</font></div><div><font size="2"  >londiste3 -d /home/pg92/skylondist/etc/digoal_176.ini worker</font></div><p></p></pre></div><div><br></div><div>-- 查看进程</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pg92@db-172-16-3-33-&gt; ps -ewf|grep python</font></div><div><font size="2"  >pg92 &nbsp; &nbsp; &nbsp;7385 &nbsp; &nbsp; 1 &nbsp;0 09:23 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 /opt/python2.7.3/bin/python /opt/skytools3.0.3/bin/londiste3 -d /home/pg92/skylondist/etc/digoal_33.ini worker</font></div><div><font size="2"  >pg92 &nbsp; &nbsp; &nbsp;7389 &nbsp; &nbsp; 1 &nbsp;0 09:23 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 /opt/python2.7.3/bin/python /opt/skytools3.0.3/bin/londiste3 -d /home/pg92/skylondist/etc/digoal_39.ini worker</font></div><div><font size="2"  >pg92 &nbsp; &nbsp; &nbsp;7392 &nbsp; &nbsp; 1 &nbsp;0 09:23 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 /opt/python2.7.3/bin/python /opt/skytools3.0.3/bin/londiste3 -d /home/pg92/skylondist/etc/digoal_40.ini worker</font></div><div><font size="2"  >pg92 &nbsp; &nbsp; &nbsp;7395 &nbsp; &nbsp; 1 &nbsp;0 09:23 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 /opt/python2.7.3/bin/python /opt/skytools3.0.3/bin/londiste3 -d /home/pg92/skylondist/etc/digoal_150.ini worker</font></div><div><font size="2"  >pg92 &nbsp; &nbsp; &nbsp;7398 &nbsp; &nbsp; 1 &nbsp;0 09:23 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 /opt/python2.7.3/bin/python /opt/skytools3.0.3/bin/londiste3 -d /home/pg92/skylondist/etc/digoal_176.ini worker</font></div><p></p></pre></div><div><br></div><div>-- 使用root的配置文件, 查看未加入复制的表</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pg92@db-172-16-3-33-&gt; londiste3 -v /home/pg92/skylondist/etc/digoal_33.ini missing</font></div><div><font size="2"  >2012-06-05 09:25:25,876 7431 DEBUG Connect 'db' to 'host=172.16.3.33 port=1919 user=londiste dbname=digoal &nbsp;[...]'</font></div><div><font size="2"  >2012-06-05 09:25:25,880 7431 DEBUG display_table: select * from londiste.local_show_missing('replika')</font></div><div><font size="2"  >Missing objects on node</font></div><div><font size="2"  >obj_kind &nbsp; &nbsp; &nbsp; &nbsp; obj_name</font></div><div><font size="2"  >--------------- &nbsp;-----------------------------</font></div><div><font size="2"  >S &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;digoal.user_login_rec_id_seq</font></div><div><font size="2"  >S &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;digoal.user_logout_rec_id_seq</font></div><div><font size="2"  >r &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;digoal.user_info</font></div><div><font size="2"  >r &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;digoal.user_login_rec</font></div><div><font size="2"  >r &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;digoal.user_logout_rec</font></div><div><font size="2"  >r &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;digoal.user_session</font></div><p></p></pre></div><div><br></div><div>-- 在root节点上注册要复制的表和序列</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >londiste3 -v /home/pg92/skylondist/etc/digoal_33.ini add-table digoal.user_info digoal.user_login_rec digoal.user_logout_rec digoal.user_session</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >londiste3 -v /home/pg92/skylondist/etc/digoal_33.ini add-seq digoal.user_login_rec_id_seq digoal.user_logout_rec_id_seq</font></div><p></p></pre></div><div><br></div><div>-- 在branch节点上添加要复制的表, 由于在branch节点上, 这些表和序列都已经提前创建好了, 所以这里直接添加就行了.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >londiste3 -v /home/pg92/skylondist/etc/digoal_39.ini add-table digoal.user_info digoal.user_login_rec digoal.user_logout_rec digoal.user_session</font></div><div><font size="2"  >londiste3 -v /home/pg92/skylondist/etc/digoal_39.ini add-seq digoal.user_login_rec_id_seq digoal.user_logout_rec_id_seq</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >londiste3 -v /home/pg92/skylondist/etc/digoal_40.ini add-table digoal.user_info digoal.user_login_rec digoal.user_logout_rec digoal.user_session</font></div><div><font size="2"  >londiste3 -v /home/pg92/skylondist/etc/digoal_40.ini add-seq digoal.user_login_rec_id_seq digoal.user_logout_rec_id_seq</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >londiste3 -v /home/pg92/skylondist/etc/digoal_150.ini add-table digoal.user_info digoal.user_login_rec digoal.user_logout_rec digoal.user_session</font></div><div><font size="2"  >londiste3 -v /home/pg92/skylondist/etc/digoal_150.ini add-seq digoal.user_login_rec_id_seq digoal.user_logout_rec_id_seq</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >londiste3 -v /home/pg92/skylondist/etc/digoal_176.ini add-table digoal.user_info digoal.user_login_rec digoal.user_logout_rec digoal.user_session</font></div><div><font size="2"  >londiste3 -v /home/pg92/skylondist/etc/digoal_176.ini add-seq digoal.user_login_rec_id_seq digoal.user_logout_rec_id_seq</font></div><p></p></pre></div><div><br></div><div>五、数据比较</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pg92@db-172-16-3-33-&gt; londiste3 /home/pg92/skylondist/etc/digoal_39.ini compare</font></div><div><font size="2"  >2012-06-05 09:43:17,395 7916 INFO Locking digoal.user_info</font></div><div><font size="2"  >2012-06-05 09:43:17,396 7916 INFO Syncing digoal.user_info</font></div><div><font size="2"  >2012-06-05 09:43:20,404 7916 INFO Counting digoal.user_info</font></div><div><font size="2"  >2012-06-05 09:43:21,176 7916 INFO srcdb: 200000 rows, checksum=-154935147736</font></div><div><font size="2"  >2012-06-05 09:43:22,267 7916 INFO dstdb: 200000 rows, checksum=-154935147736</font></div><div><font size="2"  >2012-06-05 09:43:22,268 7916 INFO Locking digoal.user_login_rec</font></div><div><font size="2"  >2012-06-05 09:43:22,269 7916 INFO Syncing digoal.user_login_rec</font></div><div><font size="2"  >2012-06-05 09:43:25,275 7916 INFO Counting digoal.user_login_rec</font></div><div><font size="2"  >2012-06-05 09:43:25,275 7916 INFO srcdb: 0 rows, checksum=None</font></div><div><font size="2"  >2012-06-05 09:43:25,276 7916 INFO dstdb: 0 rows, checksum=None</font></div><div><font size="2"  >2012-06-05 09:43:25,278 7916 INFO Locking digoal.user_logout_rec</font></div><div><font size="2"  >2012-06-05 09:43:25,278 7916 INFO Syncing digoal.user_logout_rec</font></div><div><font size="2"  >2012-06-05 09:43:28,283 7916 INFO Counting digoal.user_logout_rec</font></div><div><font size="2"  >2012-06-05 09:43:28,283 7916 INFO srcdb: 0 rows, checksum=None</font></div><div><font size="2"  >2012-06-05 09:43:28,284 7916 INFO dstdb: 0 rows, checksum=None</font></div><div><font size="2"  >2012-06-05 09:43:28,285 7916 INFO Locking digoal.user_session</font></div><div><font size="2"  >2012-06-05 09:43:28,286 7916 INFO Syncing digoal.user_session</font></div><div><font size="2"  >2012-06-05 09:43:31,290 7916 INFO Counting digoal.user_session</font></div><div><font size="2"  >2012-06-05 09:43:31,573 7916 INFO srcdb: 200000 rows, checksum=318647160593</font></div><div><font size="2"  >2012-06-05 09:43:32,001 7916 INFO dstdb: 200000 rows, checksum=318647160593</font></div><div><font size="2"  >pg92@db-172-16-3-33-&gt; londiste3 /home/pg92/skylondist/etc/digoal_40.ini compare</font></div><div><font size="2"  >2012-06-05 09:43:51,611 7931 INFO Locking digoal.user_info</font></div><div><font size="2"  >2012-06-05 09:43:51,612 7931 INFO Syncing digoal.user_info</font></div><div><font size="2"  >2012-06-05 09:43:54,620 7931 INFO Counting digoal.user_info</font></div><div><font size="2"  >2012-06-05 09:43:55,392 7931 INFO srcdb: 200000 rows, checksum=-154935147736</font></div><div><font size="2"  >2012-06-05 09:43:56,422 7931 INFO dstdb: 200000 rows, checksum=-154935147736</font></div><div><font size="2"  >2012-06-05 09:43:56,424 7931 INFO Locking digoal.user_login_rec</font></div><div><font size="2"  >2012-06-05 09:43:56,424 7931 INFO Syncing digoal.user_login_rec</font></div><div><font size="2"  >2012-06-05 09:43:59,933 7931 INFO Counting digoal.user_login_rec</font></div><div><font size="2"  >2012-06-05 09:43:59,934 7931 INFO srcdb: 0 rows, checksum=None</font></div><div><font size="2"  >2012-06-05 09:43:59,934 7931 INFO dstdb: 0 rows, checksum=None</font></div><div><font size="2"  >2012-06-05 09:43:59,936 7931 INFO Locking digoal.user_logout_rec</font></div><div><font size="2"  >2012-06-05 09:43:59,937 7931 INFO Syncing digoal.user_logout_rec</font></div><div><font size="2"  >2012-06-05 09:44:03,943 7931 INFO Counting digoal.user_logout_rec</font></div><div><font size="2"  >2012-06-05 09:44:03,944 7931 INFO srcdb: 0 rows, checksum=None</font></div><div><font size="2"  >2012-06-05 09:44:03,945 7931 INFO dstdb: 0 rows, checksum=None</font></div><div><font size="2"  >2012-06-05 09:44:03,946 7931 INFO Locking digoal.user_session</font></div><div><font size="2"  >2012-06-05 09:44:03,947 7931 INFO Syncing digoal.user_session</font></div><div><font size="2"  >2012-06-05 09:44:07,954 7931 INFO Counting digoal.user_session</font></div><div><font size="2"  >2012-06-05 09:44:08,238 7931 INFO srcdb: 200000 rows, checksum=318647160593</font></div><div><font size="2"  >2012-06-05 09:44:08,649 7931 INFO dstdb: 200000 rows, checksum=318647160593</font></div><div><font size="2"  >pg92@db-172-16-3-33-&gt; londiste3 /home/pg92/skylondist/etc/digoal_150.ini compare</font></div><div><font size="2"  >2012-06-05 09:44:29,421 7942 INFO Locking digoal.user_info</font></div><div><font size="2"  >2012-06-05 09:44:29,422 7942 INFO Syncing digoal.user_info</font></div><div><font size="2"  >2012-06-05 09:44:32,430 7942 INFO Counting digoal.user_info</font></div><div><font size="2"  >2012-06-05 09:44:33,206 7942 INFO srcdb: 200000 rows, checksum=-154935147736</font></div><div><font size="2"  >2012-06-05 09:44:34,310 7942 INFO dstdb: 200000 rows, checksum=-154935147736</font></div><div><font size="2"  >2012-06-05 09:44:34,312 7942 INFO Locking digoal.user_login_rec</font></div><div><font size="2"  >2012-06-05 09:44:34,313 7942 INFO Syncing digoal.user_login_rec</font></div><div><font size="2"  >2012-06-05 09:44:37,819 7942 INFO Counting digoal.user_login_rec</font></div><div><font size="2"  >2012-06-05 09:44:37,820 7942 INFO srcdb: 0 rows, checksum=None</font></div><div><font size="2"  >2012-06-05 09:44:37,821 7942 INFO dstdb: 0 rows, checksum=None</font></div><div><font size="2"  >2012-06-05 09:44:37,822 7942 INFO Locking digoal.user_logout_rec</font></div><div><font size="2"  >2012-06-05 09:44:37,823 7942 INFO Syncing digoal.user_logout_rec</font></div><div><font size="2"  >2012-06-05 09:44:40,828 7942 INFO Counting digoal.user_logout_rec</font></div><div><font size="2"  >2012-06-05 09:44:40,828 7942 INFO srcdb: 0 rows, checksum=None</font></div><div><font size="2"  >2012-06-05 09:44:40,829 7942 INFO dstdb: 0 rows, checksum=None</font></div><div><font size="2"  >2012-06-05 09:44:40,831 7942 INFO Locking digoal.user_session</font></div><div><font size="2"  >2012-06-05 09:44:40,831 7942 INFO Syncing digoal.user_session</font></div><div><font size="2"  >2012-06-05 09:44:43,836 7942 INFO Counting digoal.user_session</font></div><div><font size="2"  >2012-06-05 09:44:44,121 7942 INFO srcdb: 200000 rows, checksum=318647160593</font></div><div><font size="2"  >2012-06-05 09:44:44,549 7942 INFO dstdb: 200000 rows, checksum=318647160593</font></div><div><font size="2"  >pg92@db-172-16-3-33-&gt; londiste3 /home/pg92/skylondist/etc/digoal_176.ini compare</font></div><div><font size="2"  >2012-06-05 09:44:50,190 7949 INFO Locking digoal.user_info</font></div><div><font size="2"  >2012-06-05 09:44:50,191 7949 INFO Syncing digoal.user_info</font></div><div><font size="2"  >2012-06-05 09:44:54,200 7949 INFO Counting digoal.user_info</font></div><div><font size="2"  >2012-06-05 09:44:54,973 7949 INFO srcdb: 200000 rows, checksum=-154935147736</font></div><div><font size="2"  >2012-06-05 09:44:56,100 7949 INFO dstdb: 200000 rows, checksum=-154935147736</font></div><div><font size="2"  >2012-06-05 09:44:56,101 7949 INFO Locking digoal.user_login_rec</font></div><div><font size="2"  >2012-06-05 09:44:56,102 7949 INFO Syncing digoal.user_login_rec</font></div><div><font size="2"  >2012-06-05 09:45:00,107 7949 INFO Counting digoal.user_login_rec</font></div><div><font size="2"  >2012-06-05 09:45:00,107 7949 INFO srcdb: 0 rows, checksum=None</font></div><div><font size="2"  >2012-06-05 09:45:00,108 7949 INFO dstdb: 0 rows, checksum=None</font></div><div><font size="2"  >2012-06-05 09:45:00,109 7949 INFO Locking digoal.user_logout_rec</font></div><div><font size="2"  >2012-06-05 09:45:00,110 7949 INFO Syncing digoal.user_logout_rec</font></div><div><font size="2"  >2012-06-05 09:45:04,116 7949 INFO Counting digoal.user_logout_rec</font></div><div><font size="2"  >2012-06-05 09:45:04,117 7949 INFO srcdb: 0 rows, checksum=None</font></div><div><font size="2"  >2012-06-05 09:45:04,117 7949 INFO dstdb: 0 rows, checksum=None</font></div><div><font size="2"  >2012-06-05 09:45:04,118 7949 INFO Locking digoal.user_session</font></div><div><font size="2"  >2012-06-05 09:45:04,119 7949 INFO Syncing digoal.user_session</font></div><div><font size="2"  >2012-06-05 09:45:08,125 7949 INFO Counting digoal.user_session</font></div><div><font size="2"  >2012-06-05 09:45:08,408 7949 INFO srcdb: 200000 rows, checksum=318647160593</font></div><div><font size="2"  >2012-06-05 09:45:08,867 7949 INFO dstdb: 200000 rows, checksum=318647160593</font></div><p></p></pre></div><div><br></div><div>六、角色切换(branch和branch, branch和root的互相切换)</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pg92@db-172-16-3-33-&gt; londiste3 /home/pg92/skylondist/etc/digoal_33.ini status</font></div><div><font size="2"  >Queue: replika &nbsp; Local node: digoal_33</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal_33 (root)</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Tables: 4/0/0</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Lag: 10s, Tick: 152</font></div><div><font size="2"  >&nbsp; +--digoal_150 (branch)</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Tables: 4/0/0</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Lag: 10s, Tick: 152</font></div><div><font size="2"  >&nbsp; +--digoal_176 (branch)</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Tables: 4/0/0</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Lag: 10s, Tick: 152</font></div><div><font size="2"  >&nbsp; +--digoal_39 (branch)</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Tables: 4/0/0</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Lag: 10s, Tick: 152</font></div><div><font size="2"  >&nbsp; +--digoal_40 (branch)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Tables: 4/0/0</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Lag: 10s, Tick: 152</font></div><p></p></pre></div><div><br></div><div>-- 把digoal_40的provider从digoal_33改成digoal_150</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pg92@db-172-16-3-33-&gt; londiste3 -v /home/pg92/skylondist/etc/digoal_40.ini change-provider --provider=digoal_150</font></div><div><font size="2"  >2012-06-05 09:48:05,457 7990 DEBUG Connect 'db' to 'host=172.16.3.40 port=1921 user=londiste dbname=digoal &nbsp;[...]'</font></div><div><font size="2"  >2012-06-05 09:48:05,462 7990 DEBUG exec_query: select * from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-06-05 09:48:05,472 7990 DEBUG exec_query: select * from pgq_node.get_queue_locations('replika')</font></div><div><font size="2"  >2012-06-05 09:48:05,474 7990 DEBUG exec_query: select consumer_name, provider_node, last_tick_id from pgq_node.get_consumer_info('replika')</font></div><div><font size="2"  >2012-06-05 09:48:05,475 7990 DEBUG exec_query: select consumer_name, provider_node, last_tick_id from pgq_node.get_consumer_info('replika')</font></div><div><font size="2"  >2012-06-05 09:48:05,476 7990 DEBUG exec_cmd: select * from pgq_node.set_consumer_paused('replika', 'digoal_40', 'True')</font></div><div><font size="2"  >2012-06-05 09:48:05,478 7990 INFO [digoal_40] Consumer digoal_40 tagged as paused</font></div><div><font size="2"  >2012-06-05 09:48:05,478 7990 INFO Waiting for worker to accept</font></div><div><font size="2"  >2012-06-05 09:48:05,478 7990 DEBUG exec_cmd: select * from pgq_node.get_consumer_state('replika', 'digoal_40')</font></div><div><font size="2"  >2012-06-05 09:48:05,480 7990 DEBUG [digoal_40] 100 Ok</font></div><div><font size="2"  >2012-06-05 09:48:06,480 7990 DEBUG exec_cmd: select * from pgq_node.get_consumer_state('replika', 'digoal_40')</font></div><div><font size="2"  >2012-06-05 09:48:06,481 7990 DEBUG [digoal_40] 100 Ok</font></div><div><font size="2"  >2012-06-05 09:48:06,481 7990 INFO Consumer 'digoal_40' on node 'digoal_40' paused</font></div><div><font size="2"  >2012-06-05 09:48:06,482 7990 DEBUG exec_query: select * from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-06-05 09:48:06,483 7990 DEBUG exec_query: select * from pgq_node.get_queue_locations('replika')</font></div><div><font size="2"  >2012-06-05 09:48:06,485 7990 DEBUG exec_query: select consumer_name, provider_node, last_tick_id from pgq_node.get_consumer_info('replika')</font></div><div><font size="2"  >2012-06-05 09:48:06,486 7990 DEBUG Connect 'node.digoal_150' to 'host=172.16.3.150 port=1919 user=londiste dbname=digoal &nbsp;[...]'</font></div><div><font size="2"  >2012-06-05 09:48:06,490 7990 DEBUG exec_cmd: select * from pgq_node.register_location('replika', 'digoal_40', 'host=172.16.3.40 port=1921 user=londiste dbname=digoal password=londiste', false)</font></div><div><font size="2"  >2012-06-05 09:48:06,495 7990 INFO [digoal_150] Location registered</font></div><div><font size="2"  >2012-06-05 09:48:06,495 7990 DEBUG exec_cmd: select * from pgq_node.register_subscriber('replika', 'digoal_40', 'digoal_40', '153')</font></div><div><font size="2"  >2012-06-05 09:48:06,504 7990 INFO [digoal_150] Subscriber registered: digoal_40</font></div><div><font size="2"  >2012-06-05 09:48:06,505 7990 DEBUG exec_cmd: select * from pgq_node.change_consumer_provider('replika', 'digoal_40', 'digoal_150')</font></div><div><font size="2"  >2012-06-05 09:48:06,507 7990 INFO [digoal_40] Consumer provider node set to : digoal_150</font></div><div><font size="2"  >2012-06-05 09:48:06,507 7990 DEBUG exec_cmd: select * from pgq_node.set_consumer_paused('replika', 'digoal_40', 'False')</font></div><div><font size="2"  >2012-06-05 09:48:06,508 7990 INFO [digoal_40] Consumer digoal_40 tagged as resumed</font></div><div><font size="2"  >2012-06-05 09:48:06,508 7990 INFO Waiting for worker to accept</font></div><div><font size="2"  >2012-06-05 09:48:06,509 7990 DEBUG exec_cmd: select * from pgq_node.get_consumer_state('replika', 'digoal_40')</font></div><div><font size="2"  >2012-06-05 09:48:06,509 7990 DEBUG [digoal_40] 100 Ok</font></div><div><font size="2"  >2012-06-05 09:48:07,510 7990 DEBUG exec_cmd: select * from pgq_node.get_consumer_state('replika', 'digoal_40')</font></div><div><font size="2"  >2012-06-05 09:48:07,511 7990 DEBUG [digoal_40] 100 Ok</font></div><div><font size="2"  >2012-06-05 09:48:07,512 7990 INFO Consumer 'digoal_40' on node 'digoal_40' resumed</font></div><div><font size="2"  >2012-06-05 09:48:07,512 7990 DEBUG Connect 'node.digoal_33' to 'host=172.16.3.33 port=1919 user=londiste dbname=digoal &nbsp;[...]'</font></div><div><font size="2"  >2012-06-05 09:48:07,515 7990 DEBUG exec_cmd: select * from pgq_node.unregister_subscriber('replika', 'digoal_40')</font></div><div><font size="2"  >2012-06-05 09:48:07,520 7990 INFO [digoal_33] Subscriber unregistered: digoal_40</font></div><p></p></pre></div><div><br></div><div>-- 查看角色切换后的状态</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pg92@db-172-16-3-33-&gt; londiste3 /home/pg92/skylondist/etc/digoal_33.ini status</font></div><div><font size="2"  >Queue: replika &nbsp; Local node: digoal_33</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal_33 (root)</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Tables: 4/0/0</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Lag: 11s, Tick: 153</font></div><div><font size="2"  >&nbsp; +--digoal_176 (branch)</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Tables: 4/0/0</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Lag: 11s, Tick: 153</font></div><div><font size="2"  >&nbsp; +--digoal_39 (branch)</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Tables: 4/0/0</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Lag: 11s, Tick: 153</font></div><div><font size="2"  >&nbsp; +--digoal_150 (branch)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Tables: 4/0/0</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Lag: 11s, Tick: 153</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;+--digoal_40 (branch)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Tables: 4/0/0</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Lag: 11s, Tick: 153</font></div><p></p></pre></div><div><br></div><div>-- 使用takeover切换root节点, 把digoal_39切换成root节点, 在切换前, 在digoal_39上执行一条更新user_info操作的SQL, 看看能不能成功.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; update user_info set engname='test' where userid=1;</font></div><div><font size="2"  >ERROR: &nbsp;Insert into queue disallowed</font></div><div><font size="2"  >CONTEXT: &nbsp;PL/pgSQL function "insert_event" line 24 at RETURN</font></div><div><font size="2"  >SQL statement "select pgq.insert_event($1, $2, $3, $4, $5, $6, $7)"</font></div><p></p></pre></div><div>-- 触发器制止了执行</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >Triggers:</font></div><div><font size="2"  >&nbsp; &nbsp; _londiste_replika AFTER INSERT OR DELETE OR UPDATE ON user_info FOR EACH ROW EXECUTE PROCEDURE pgq.logutriga('replika')</font></div><div><font size="2"  >&nbsp; &nbsp; _londiste_replika_truncate AFTER TRUNCATE ON user_info FOR EACH STATEMENT EXECUTE PROCEDURE pgq.sqltriga('replika')</font></div><div><font size="2"  >-- 所以数据未被修改</font></div><div><font size="2"  >digoal=&gt; select engname from user_info where userid =1;</font></div><div><font size="2"  >&nbsp; &nbsp;engname &nbsp;&nbsp;</font></div><div><font size="2"  >-------------</font></div><div><font size="2"  >&nbsp;digoal.zhou</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>-- 接下来把digoal_39切换成root, digoal_33切换成branch.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pg92@db-172-16-3-33-&gt; londiste3 -v /home/pg92/skylondist/etc/digoal_39.ini takeover digoal_33</font></div><div><font size="2"  >2012-06-05 09:56:36,656 8096 INFO old: digoal_33</font></div><div><font size="2"  >2012-06-05 09:56:36,656 8096 DEBUG Connect 'db' to 'host=172.16.3.39 port=1921 user=londiste dbname=digoal &nbsp;[...]'</font></div><div><font size="2"  >2012-06-05 09:56:36,661 8096 DEBUG exec_query: select * from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-06-05 09:56:36,671 8096 DEBUG exec_query: select * from pgq_node.get_queue_locations('replika')</font></div><div><font size="2"  >2012-06-05 09:56:36,672 8096 DEBUG Connect 'node.digoal_33' to 'host=172.16.3.33 port=1919 user=londiste dbname=digoal &nbsp;[...]'</font></div><div><font size="2"  >2012-06-05 09:56:36,675 8096 DEBUG exec_query: select * from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-06-05 09:56:36,682 8096 DEBUG exec_query: select * from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-06-05 09:56:36,684 8096 DEBUG exec_cmd: select * from pgq_node.set_consumer_paused('replika', 'digoal_33', 'True')</font></div><div><font size="2"  >2012-06-05 09:56:36,685 8096 INFO [digoal_33] Consumer digoal_33 tagged as paused</font></div><div><font size="2"  >2012-06-05 09:56:36,685 8096 INFO Waiting for worker to accept</font></div><div><font size="2"  >2012-06-05 09:56:36,686 8096 DEBUG exec_cmd: select * from pgq_node.get_consumer_state('replika', 'digoal_33')</font></div><div><font size="2"  >2012-06-05 09:56:36,687 8096 DEBUG [digoal_33] 100 Ok</font></div><div><font size="2"  >2012-06-05 09:56:37,687 8096 DEBUG exec_cmd: select * from pgq_node.get_consumer_state('replika', 'digoal_33')</font></div><div><font size="2"  >2012-06-05 09:56:37,688 8096 DEBUG [digoal_33] 100 Ok</font></div><div><font size="2"  >2012-06-05 09:56:38,688 8096 DEBUG exec_cmd: select * from pgq_node.get_consumer_state('replika', 'digoal_33')</font></div><div><font size="2"  >2012-06-05 09:56:38,688 8096 DEBUG [digoal_33] 100 Ok</font></div><div><font size="2"  >2012-06-05 09:56:39,688 8096 DEBUG exec_cmd: select * from pgq_node.get_consumer_state('replika', 'digoal_33')</font></div><div><font size="2"  >2012-06-05 09:56:39,689 8096 DEBUG [digoal_33] 100 Ok</font></div><div><font size="2"  >2012-06-05 09:56:39,689 8096 INFO Consumer 'digoal_33' on node 'digoal_33' paused</font></div><div><font size="2"  >2012-06-05 09:56:39,689 8096 DEBUG exec_cmd: select * from pgq_node.demote_root('replika', '1', 'digoal_39')</font></div><div><font size="2"  >2012-06-05 09:56:39,690 8096 INFO [digoal_33] Step 1: Writing disabled for: replika</font></div><div><font size="2"  >2012-06-05 09:56:39,690 8096 DEBUG exec_cmd: select * from pgq_node.demote_root('replika', '2', 'digoal_39')</font></div><div><font size="2"  >2012-06-05 09:56:39,694 8096 INFO [digoal_33] Step 2: Inserted last tick: replika</font></div><div><font size="2"  >2012-06-05 09:56:39,694 8096 DEBUG exec_query: select * from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-06-05 09:56:39,696 8096 DEBUG waiting for catchup: need=164, cur=163</font></div><div><font size="2"  >2012-06-05 09:56:40,696 8096 DEBUG exec_query: select * from pgq_node.get_node_info('replika')</font></div><div><font size="2"  >2012-06-05 09:56:40,698 8096 DEBUG exec_cmd: select * from pgq_node.set_consumer_paused('replika', 'digoal_39', 'True')</font></div><div><font size="2"  >2012-06-05 09:56:40,701 8096 INFO [digoal_39] Consumer digoal_39 tagged as paused</font></div><div><font size="2"  >2012-06-05 09:56:40,701 8096 INFO Waiting for worker to accept</font></div><div><font size="2"  >2012-06-05 09:56:40,702 8096 DEBUG exec_cmd: select * from pgq_node.get_consumer_state('replika', 'digoal_39')</font></div><div><font size="2"  >2012-06-05 09:56:40,703 8096 DEBUG [digoal_39] 100 Ok</font></div><div><font size="2"  >2012-06-05 09:56:41,705 8096 DEBUG exec_cmd: select * from pgq_node.get_consumer_state('replika', 'digoal_39')</font></div><div><font size="2"  >2012-06-05 09:56:41,706 8096 DEBUG [digoal_39] 100 Ok</font></div><div><font size="2"  >2012-06-05 09:56:41,706 8096 INFO Consumer 'digoal_39' on node 'digoal_39' paused</font></div><div><font size="2"  >2012-06-05 09:56:41,706 8096 DEBUG exec_cmd: select * from pgq_node.promote_branch('replika')</font></div><div><font size="2"  >2012-06-05 09:56:41,711 8096 INFO [digoal_39] Branch node promoted to root</font></div><div><font size="2"  >2012-06-05 09:56:41,711 8096 DEBUG exec_cmd: select * from pgq_node.register_subscriber('replika', 'digoal_33', 'digoal_33', '164')</font></div><div><font size="2"  >2012-06-05 09:56:41,717 8096 INFO [digoal_39] Subscriber registered: digoal_33</font></div><div><font size="2"  >2012-06-05 09:56:41,717 8096 DEBUG exec_cmd: select * from pgq_node.unregister_subscriber('replika', 'digoal_39')</font></div><div><font size="2"  >2012-06-05 09:56:41,720 8096 INFO [digoal_33] Subscriber unregistered: digoal_39</font></div><div><font size="2"  >2012-06-05 09:56:41,720 8096 DEBUG exec_cmd: select * from pgq_node.set_consumer_paused('replika', 'digoal_39', 'False')</font></div><div><font size="2"  >2012-06-05 09:56:41,721 8096 INFO [digoal_39] Consumer digoal_39 tagged as resumed</font></div><div><font size="2"  >2012-06-05 09:56:41,721 8096 INFO Waiting for worker to accept</font></div><div><font size="2"  >2012-06-05 09:56:41,721 8096 DEBUG exec_cmd: select * from pgq_node.get_consumer_state('replika', 'digoal_39')</font></div><div><font size="2"  >2012-06-05 09:56:41,722 8096 DEBUG [digoal_39] 100 Ok</font></div><div><font size="2"  >2012-06-05 09:56:42,722 8096 DEBUG exec_cmd: select * from pgq_node.get_consumer_state('replika', 'digoal_39')</font></div><div><font size="2"  >2012-06-05 09:56:42,723 8096 DEBUG [digoal_39] 100 Ok</font></div><div><font size="2"  >2012-06-05 09:56:42,723 8096 INFO Consumer 'digoal_39' on node 'digoal_39' resumed</font></div><div><font size="2"  >2012-06-05 09:56:42,723 8096 DEBUG exec_cmd: select * from pgq_node.demote_root('replika', '3', 'digoal_39')</font></div><div><font size="2"  >2012-06-05 09:56:42,725 8096 INFO [digoal_33] Step 3: Demoted root to branch: replika</font></div><div><font size="2"  >2012-06-05 09:56:42,725 8096 DEBUG exec_cmd: select * from pgq_node.set_consumer_paused('replika', 'digoal_33', 'False')</font></div><div><font size="2"  >2012-06-05 09:56:42,726 8096 INFO [digoal_33] Consumer digoal_33 tagged as resumed</font></div><div><font size="2"  >2012-06-05 09:56:42,726 8096 INFO Waiting for worker to accept</font></div><div><font size="2"  >2012-06-05 09:56:42,726 8096 DEBUG exec_cmd: select * from pgq_node.get_consumer_state('replika', 'digoal_33')</font></div><div><font size="2"  >2012-06-05 09:56:42,727 8096 DEBUG [digoal_33] 100 Ok</font></div><div><font size="2"  >2012-06-05 09:56:43,727 8096 DEBUG exec_cmd: select * from pgq_node.get_consumer_state('replika', 'digoal_33')</font></div><div><font size="2"  >2012-06-05 09:56:43,728 8096 DEBUG [digoal_33] 100 Ok</font></div><div><font size="2"  >2012-06-05 09:56:43,728 8096 INFO Consumer 'digoal_33' on node 'digoal_33' resumed</font></div><p></p></pre></div><div>-- 查看状态</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pg92@db-172-16-3-33-&gt; londiste3 /home/pg92/skylondist/etc/digoal_39.ini status</font></div><div><font size="2"  >Queue: replika &nbsp; Local node: digoal_39</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal_39 (root)</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Tables: 4/0/0</font></div><div><font size="2"  >&nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Lag: -1d23h46m26s, Tick: 164</font></div><div><font size="2"  >&nbsp; +--digoal_33 (branch)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Tables: 4/0/0</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Lag: (n/a), Tick: 164</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;+--digoal_176 (branch)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Tables: 4/0/0</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Lag: (n/a), Tick: 164</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;+--digoal_150 (branch)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Tables: 4/0/0</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Lag: (n/a), Tick: 164</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; +--digoal_40 (branch)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Tables: 4/0/0</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Lag: (n/a), Tick: 164</font></div><p></p></pre></div><div>-- 在到digoal_39上执行update</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; update user_info set engname='test' where userid=1;</font></div><div><font size="2"  >UPDATE 1</font></div><div><font size="2"  >digoal=&gt; select engname from user_info where userid =1;</font></div><div><font size="2"  >&nbsp;engname&nbsp;</font></div><div><font size="2"  >---------</font></div><div><font size="2"  >&nbsp;test</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>-- 查看是否已经复制到其他节点</div><div>-- 结果当然是没有复制, 因为pgqd还连在老的root上.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pg92@db-172-16-3-33-&gt; londiste3 /home/pg92/skylondist/etc/digoal_33.ini compare</font></div><div><font size="2"  >2012-06-05 10:00:37,847 8183 INFO Locking digoal.user_info</font></div><div><font size="2"  >2012-06-05 10:00:37,848 8183 INFO Syncing digoal.user_info</font></div><div><font size="2"  >2012-06-05 10:00:47,862 8183 ERROR Job digoal_33 crashed: Ticker seems dead</font></div><div><font size="2"  >Traceback (most recent call last):</font></div><div><font size="2"  >&nbsp; File "/opt/python2.7.3/lib/python2.7/site-packages/skytools/scripting.py", line 597, in run_func_safely</font></div><div><font size="2"  >&nbsp; &nbsp; return func()</font></div><div><font size="2"  >&nbsp; File "/opt/python2.7.3/lib/python2.7/site-packages/londiste/syncer.py", line 140, in work</font></div><div><font size="2"  >&nbsp; &nbsp; self.check_table(t1.dest_table, t2.dest_table, lock_db, src_db, dst_db, setup_curs)</font></div><div><font size="2"  >&nbsp; File "/opt/python2.7.3/lib/python2.7/site-packages/londiste/syncer.py", line 194, in check_table</font></div><div><font size="2"  >&nbsp; &nbsp; tick_id = self.force_tick(setup_curs)</font></div><div><font size="2"  >&nbsp; File "/opt/python2.7.3/lib/python2.7/site-packages/londiste/syncer.py", line 166, in force_tick</font></div><div><font size="2"  >&nbsp; &nbsp; raise Exception("Ticker seems dead")</font></div><div><font size="2"  >Exception: Ticker seems dead</font></div><p></p></pre></div><div><br></div><div>-- 所以在更改root后一定要更改pgqd的连接</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pg92@db-172-16-3-33-&gt; vi pgqd.ini&nbsp;</font></div><div><font size="2"  >[pgqd]</font></div><div><font size="2"  >base_connstr = host=172.16.3.39 port=1921 user=londiste password=londiste</font></div><div><font size="2"  >initial_database = template1</font></div><div><font size="2"  >database_list = digoal</font></div><div><font size="2"  >logfile = /home/pg92/skylondist/log/pgqd.log</font></div><div><font size="2"  >pidfile = /home/pg92/skylondist/pid/pgqd.pid</font></div><p></p></pre></div><div><br></div><div>-- 重启pgqd</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pg92@db-172-16-3-33-&gt; pgqd -s /home/pg92/skylondist/etc/pgqd.ini&nbsp;</font></div><div><font size="2"  >SIGINT sent</font></div><div><font size="2"  >pg92@db-172-16-3-33-&gt; pgqd -d /home/pg92/skylondist/etc/pgqd.ini&nbsp;</font></div><div><font size="2"  >2012-06-05 10:02:04.714 8240 LOG Starting pgqd 3.0.3</font></div><p></p></pre></div><div><br></div><div>-- 再次比较数据是否一致</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pg92@db-172-16-3-33-&gt; londiste3 /home/pg92/skylondist/etc/digoal_33.ini compare</font></div><div><font size="2"  >2012-06-05 10:02:18,340 8248 INFO Locking digoal.user_info</font></div><div><font size="2"  >2012-06-05 10:02:18,341 8248 INFO Syncing digoal.user_info</font></div><div><font size="2"  >2012-06-05 10:02:21,350 8248 INFO Counting digoal.user_info</font></div><div><font size="2"  >2012-06-05 10:02:22,441 8248 INFO srcdb: 200000 rows, checksum=-156218497941</font></div><div><font size="2"  >2012-06-05 10:02:23,216 8248 INFO dstdb: 200000 rows, checksum=-156218497941</font></div><div><font size="2"  >2012-06-05 10:02:23,218 8248 INFO Locking digoal.user_login_rec</font></div><div><font size="2"  >2012-06-05 10:02:23,219 8248 INFO Syncing digoal.user_login_rec</font></div><div><font size="2"  >2012-06-05 10:02:26,226 8248 INFO Counting digoal.user_login_rec</font></div><div><font size="2"  >2012-06-05 10:02:26,227 8248 INFO srcdb: 0 rows, checksum=None</font></div><div><font size="2"  >2012-06-05 10:02:26,228 8248 INFO dstdb: 0 rows, checksum=None</font></div><div><font size="2"  >2012-06-05 10:02:26,229 8248 INFO Locking digoal.user_logout_rec</font></div><div><font size="2"  >2012-06-05 10:02:26,230 8248 INFO Syncing digoal.user_logout_rec</font></div><div><font size="2"  >2012-06-05 10:02:29,237 8248 INFO Counting digoal.user_logout_rec</font></div><div><font size="2"  >2012-06-05 10:02:29,238 8248 INFO srcdb: 0 rows, checksum=None</font></div><div><font size="2"  >2012-06-05 10:02:29,239 8248 INFO dstdb: 0 rows, checksum=None</font></div><div><font size="2"  >2012-06-05 10:02:29,240 8248 INFO Locking digoal.user_session</font></div><div><font size="2"  >2012-06-05 10:02:29,241 8248 INFO Syncing digoal.user_session</font></div><div><font size="2"  >2012-06-05 10:02:32,748 8248 INFO Counting digoal.user_session</font></div><div><font size="2"  >2012-06-05 10:02:33,171 8248 INFO srcdb: 200000 rows, checksum=318647160593</font></div><div><font size="2"  >2012-06-05 10:02:33,461 8248 INFO dstdb: 200000 rows, checksum=318647160593</font></div><p></p></pre></div><div><br></div><div>-- 查看172.16.3.33上的数据, 已经更新</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >pg92@db-172-16-3-33-&gt; psql digoal digoal</font></div><div><font size="2"  >psql (9.2beta1)</font></div><div><font size="2"  >Type "help" for help.</font></div><div><font size="2"  >digoal=&gt; select engname from user_info where userid =1;</font></div><div><font size="2"  >&nbsp;engname&nbsp;</font></div><div><font size="2"  >---------</font></div><div><font size="2"  >&nbsp;test</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div><div>-- 查看172.16.3.40, 150, 176上的数据, 已经更新</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select engname from user_info where userid=1;</font></div><div><font size="2"  >&nbsp;engname&nbsp;</font></div><div><font size="2"  >---------</font></div><div><font size="2"  >&nbsp;test</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><br></div><div><br></div><div>七、 压力测试</div><div>略, 请参考如下</div><div>《Londiste 3 replicate case - 1 上节》</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201243051338137/"  >http://blog.163.com/digoal@126/blog/static/163877040201243051338137/</a></div><div>《Londiste 3 replicate case - 1 下节》</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402012431102448951/"  >http://blog.163.com/digoal@126/blog/static/1638770402012431102448951/</a></div><div><br></div><div><br></div><div><br></div><div>【参考】</div><div><a target="_blank" rel="nofollow" href="http://skytools.projects.postgresql.org/skytools-3.0/api/"  >http://skytools.projects.postgresql.org/skytools-3.0/api/</a></div><div><a target="_blank" rel="nofollow" href="http://skytools.projects.postgresql.org/skytools-3.0/pgq/files/external-sql.html"  >http://skytools.projects.postgresql.org/skytools-3.0/pgq/files/external-sql.html</a></div><div><a target="_blank" rel="nofollow" href="http://skytools.projects.postgresql.org/skytools-3.0/pgq_coop/files/functions-sql.html"  >http://skytools.projects.postgresql.org/skytools-3.0/pgq_coop/files/functions-sql.html</a></div><div><a target="_blank" rel="nofollow" href="http://skytools.projects.postgresql.org/skytools-3.0/pgq_ext/files/functions-sql.html"  >http://skytools.projects.postgresql.org/skytools-3.0/pgq_ext/files/functions-sql.html</a></div><div><a target="_blank" rel="nofollow" href="http://skytools.projects.postgresql.org/skytools-3.0/pgq_node/files/functions-sql.html"  >http://skytools.projects.postgresql.org/skytools-3.0/pgq_node/files/functions-sql.html</a></div><div><a target="_blank" rel="nofollow" href="http://skytools.projects.postgresql.org/skytools-3.0/londiste/files/functions-sql.html"  >http://skytools.projects.postgresql.org/skytools-3.0/londiste/files/functions-sql.html</a></div><div><a target="_blank" rel="nofollow" href="https://github.com/markokr/skytools"  >https://github.com/markokr/skytools</a></div><div><br></div><div><br></div></div></div>
	</div>
</div>
</body>
</html>