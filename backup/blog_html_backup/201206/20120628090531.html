<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.3 plpgsql_check_function patch</h2>
	<h5 id="">2012-06-28 9:05:31&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201252885331153/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>早上看到一篇关于PostgreSQL plpgsql函数检查的文章, 说的是PostgreSQL函数关于变量这块, 在创建时不会检查变量的模糊定义, 如表中和函数中定义了同名的变量, 在定义函数时不会报错, 但是在使用中如果出现模糊概念了, 将或报错.</div><div>PostgreSQL 9.3将会引入一个plpgsql_check_function函数, 用来检测诸如此类的错误.</div><div>下面来以9.2的源码为例子, 打上这个补丁</div><div>1. 首先下载PostgreSQL 9.2的源码, 以及补丁</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >wget&nbsp;http://ftp.postgresql.org/pub/source/v9.2.0beta2/postgresql-9.2beta2.tar.bz2</font></div><div><font size="2"  >wget&nbsp;http://archives.postgresql.org/pgsql-hackers/2012-06/binooyMWTCfxi.bin</font></div><p></p></pre></div><div><br></div><div>2. 打上补丁</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ># tar -jxvf&nbsp;<span style="line-height: 22px;"  >postgresql-9.2beta2.tar.bz2</span></font></div><div><font size="2"  ><span style="line-height: 22px;"  ># cd&nbsp;</span><span style="line-height: 22px;"  >postgresql-9.2beta2</span></font></div><div><div><font size="2"  ># patch -p1 &lt; ../binooyMWTCfxi.bin&nbsp;</font></div><div><font size="2"  >patching file doc/src/sgml/plpgsql.sgml</font></div><div><font size="2"  >patching file src/pl/plpgsql/src/Makefile</font></div><div><font size="2"  >patching file src/pl/plpgsql/src/pl_check.c</font></div><div><font size="2"  >patching file src/pl/plpgsql/src/pl_comp.c</font></div><div><font size="2"  >patching file src/pl/plpgsql/src/pl_exec.c</font></div><div><font size="2"  >patching file src/pl/plpgsql/src/pl_handler.c</font></div><div><font size="2"  >patching file src/pl/plpgsql/src/plpgsql--1.0--1.1.sql</font></div><div><font size="2"  >patching file src/pl/plpgsql/src/plpgsql--1.1.sql</font></div><div><font size="2"  >patching file src/pl/plpgsql/src/plpgsql.control</font></div><div><font size="2"  >patching file src/pl/plpgsql/src/plpgsql.h</font></div><div><font size="2"  >patching file src/test/regress/expected/plpgsql.out</font></div><div><font size="2"  >patching file src/test/regress/sql/plpgsql.sql</font></div></div><p></p></pre></div><div><br></div><div>3. 编译安装</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >cd&nbsp;<span style="line-height: 22px;"  >postgresql-9.2beta2</span></font></div><div><font size="2"  >./configure --prefix=/home/pg92/pgsql --with-pgport=9999 --with-perl --with-python --with-tcl --with-openssl --with-pam --without-ldap --with-libxml --with-libxslt --enable-thread-safety --with-wal-blocksize=16 --enable-debug &amp;&amp; gmake</font></div><div><font size="2"  >sudo gmake install</font></div><p></p></pre></div><div><br></div><div>4. 测试</div><div>创建测试表</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# create table test (id int,info text);</font></div><div><font size="2"  >CREATE TABLE</font></div><p></p></pre></div><div>创建测试函数, 这个函数创建正常, 但是调用时将会报模糊错误, 因为id既是表字段, 又是函数中的变量.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# create or replace function f_test () returns int as $$</font></div><div><font size="2"  >postgres$# declare</font></div><div><font size="2"  >postgres$# id int;</font></div><div><font size="2"  >postgres$# begin</font></div><div><font size="2"  >postgres$# select id into id from test limit 1;</font></div><div><font size="2"  >postgres$# return id;</font></div><div><font size="2"  >postgres$# end;</font></div><div><font size="2"  >postgres$# $$ language plpgsql;</font></div><div><font size="2"  >CREATE FUNCTION</font></div><p></p></pre></div><div><br></div><div>调用这个函数时将报错</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# \set VERBOSITY verbose</font></div><div><div><font size="2"  >postgres=# select * from f_test();</font></div><div><font size="2"  >ERROR: &nbsp;42702: column reference "id" is ambiguous</font></div><div><font size="2"  >LINE 1: select id &nbsp; &nbsp; &nbsp; &nbsp; from test limit 1</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"  >DETAIL: &nbsp;It could refer to either a PL/pgSQL variable or a table column.</font></div><div><font size="2"  >QUERY: &nbsp;select id &nbsp; &nbsp; &nbsp; &nbsp; from test limit 1</font></div><div><font size="2"  >CONTEXT: &nbsp;PL/pgSQL function f_test() line 5 at SQL statement</font></div><div><font size="2"  >LOCATION: &nbsp;plpgsql_post_column_ref, pl_comp.c:1046</font></div></div><p></p></pre></div><div><br></div><div>使用<span style="line-height: 22px;"  >plpgsql_check_function这个函数来检测函数定义中的错误.</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >postgres=# select oid,* from pg_language ;</font></div><div><font size="2"  >&nbsp; oid &nbsp;| lanname &nbsp;| lanowner | lanispl | lanpltrusted | lanplcallfoid | laninline | lanvalidator | lanacl&nbsp;</font></div><div><font size="2"  >-------+----------+----------+---------+--------------+---------------+-----------+--------------+--------</font></div><div><font size="2"  >&nbsp; &nbsp; 12 | internal | &nbsp; &nbsp; &nbsp; 10 | f &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; 2246 |&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; 13 | c &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 10 | f &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; 2247 |&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; 14 | sql &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; 10 | f &nbsp; &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; 2248 |&nbsp;</font></div><div><font size="2"  >&nbsp;12517 | plpgsql &nbsp;| &nbsp; &nbsp; &nbsp; 10 | t &nbsp; &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; 12514 | &nbsp; &nbsp; 12515 | &nbsp; &nbsp; &nbsp; &nbsp;12516 |&nbsp;</font></div><div><font size="2"  >(4 rows)</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >postgres=# select proname,plpgsql_check_function(oid) from pg_proc where prolang=12517;</font></div><div><font size="2"  >&nbsp;proname | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; plpgsql_check_function &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >---------+-------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;f_test &nbsp;| error:42702:5:SQL statement:column reference "id" is ambiguous</font></div><div><font size="2"  >&nbsp;f_test &nbsp;| Query: select id &nbsp; &nbsp; &nbsp; &nbsp; from test limit 1</font></div><div><font size="2"  >&nbsp;f_test &nbsp;| -- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"  >&nbsp;f_test &nbsp;| Detail: It could refer to either a PL/pgSQL variable or a table column.</font></div><div><font size="2"  >(4 rows)</font></div><p></p></pre></div><div><br></div><div>【错误】</div><div>如果编译时使用gmake workd的话, 会报关于文档编译的错误, 可能这个补丁目前还没有完善, 或者不是针对9.2源码的. 其他版本我没有测试过.</div><div>所以可以选择gmake</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >gmake[3]: *** [bookindex.sgml] Error 1</font></div><div><font size="2"  >gmake[3]: Leaving directory `/home/pg92/postgresql-9.2beta2/doc/src/sgml'</font></div><div><font size="2"  >gmake[2]: *** [install] Error 2</font></div><div><font size="2"  >gmake[2]: Leaving directory `/home/pg92/postgresql-9.2beta2/doc/src'</font></div><div><font size="2"  >gmake[1]: *** [install] Error 2</font></div><div><font size="2"  >gmake[1]: Leaving directory `/home/pg92/postgresql-9.2beta2/doc'</font></div><div><font size="2"  >gmake: *** [install-world-doc-recurse] Error 2</font></div><p></p></pre></div><div><br></div>【参考】<div><a rel="nofollow" href="http://joelonsql.com/2012/06/27/postgresql-9-3devel-plpgsql-check-function/"  >http://joelonsql.com/2012/06/27/postgresql-9-3devel-plpgsql-check-function/</a> </div><div><a rel="nofollow" href="http://archives.postgresql.org/message-id/CAFj8pRAYVTQYCL8_NF_hDQjc0m+JBvbwR6E_ZJ0SJfkKQ9m2kA@mail.gmail.com"  >http://archives.postgresql.org/message-id/CAFj8pRAYVTQYCL8_NF_hDQjc0m+JBvbwR6E_ZJ0SJfkKQ9m2kA@mail.gmail.com</a> </div><div><a href="http://blog.163.com/digoal@126/blog/static/163877040201252884053930/"  >http://blog.163.com/digoal@126/blog/static/163877040201252884053930/</a> </div></div>
	</div>
</div>
</body>
</html>