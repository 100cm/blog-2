<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">It seems my pgpool-II does not do load balancing. Why?</h2>
	<h5 id="">2014-10-08 10:44:21&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201498104421585/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>pgpool-II负载均衡应用注意事项</div><div>1. pgpool-II 3.0+版本, 使用master/slave模式可以在事务中实施负载均衡.</div><div>2. 低版本的pgpool-II只能实施基于会话的负载均衡.</div><div>3. 使用replication模式时, 游标需要在所有节点执行, 因此游标在这种场景不能实现负载均衡.</div><div>4. backend的选择优先级和pgpool.conf的weight配置有关.</div><div><br></div><div><h3 style="font-weight: normal; margin: 0px 0px 0.3em; overflow: hidden; padding-top: 0.5em; padding-bottom: 0.17em; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(204, 204, 204); width: auto; font-size: 17px; font-family: sans-serif; line-height: 19.2000007629395px; background-image: none; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"   ><span id="It_seems_my_pgpool-II_does_not_do_load_balancing._Why.3F"   ><b>It seems my pgpool-II does not do load balancing. Why?</b></span></h3><dl style="margin-top: 0.2em; margin-bottom: 0.5em; font-family: sans-serif; font-size: 13px; line-height: 19.2000007629395px;"   ><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >First of all, pgpool-II' load balancing is "session base", not "statement base". That means, DB node selection for load balancing is decided at the beginning of session. So all SQL statements are sent to the same DB node until the session ends.</dd></dl><dl style="margin-top: 0.2em; margin-bottom: 0.5em; font-family: sans-serif; font-size: 13px; line-height: 19.2000007629395px;"   ><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >Another point is, whether statement is in an explicit transaction or not. If the statement is in a transaction, it will not be load balanced in the replication mode. In pgpool-II 3.0 or later, SELECT will be load balanced even in a transaction if operated in the master/slave mode.</dd></dl><dl style="margin-top: 0.2em; margin-bottom: 0.5em; font-family: sans-serif; font-size: 13px; line-height: 19.2000007629395px;"   ><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >Note the method to choose DB node is not LRU or some such. Pgpool-II chooses DB node randomly considering the "weight" parameter in pgpool.conf. This means that the chosen DB node is not uniformly distributed among DB nodes in short term. You might want to inspect the effect of load balancing after ~100 queries have been sent.</dd></dl><dl style="margin-top: 0.2em; margin-bottom: 0.5em; font-family: sans-serif; font-size: 13px; line-height: 19.2000007629395px;"   ><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >Also cursor statements are not load balanced in replication mode. i.e.:DECLARE..FETCH are sent to all DB nodes in replication mode. This is because the SELECT might come with FOR UPDATE/FOR SHARE. Note that some applications including psql could use CURSOR for SELECT. For example, from PostgreSQL 8.2, if "\set FETCH_COUNT n" is executed, psql unconditionaly uses a curor named "_psql_cursor".</dd></dl></div><wbr><div><br></div><div>如何跟踪负载均衡,&nbsp;</div><div>设<font size="3"   >置参数<span style="line-height: 19.5px; font-family: sans-serif;"   >log_per_node_statement, 查看日志.</span></font></div><div><h3 style="font-weight: normal; margin: 0px 0px 0.3em; overflow: hidden; padding-top: 0.5em; padding-bottom: 0.17em; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(204, 204, 204); width: auto; font-size: 17px; font-family: sans-serif; line-height: 19.2000007629395px; background-image: none; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"   ><span id="How_can_I_observe_the_effect_of_load_balancing.3F"   ><b>How can I observe the effect of load balancing?</b></span></h3><dl style="margin-top: 0.2em; margin-bottom: 0.5em; font-family: sans-serif; font-size: 13px; line-height: 19.2000007629395px;"   ><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >We recommend to enable "log_per_node_statement" directive in pgpool.conf for this. Here is an example of the log:</dd><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   ><pre style="font-family: monospace, 'Courier New'; padding: 1em; border: 1px dashed rgb(47, 111, 171); line-height: 1.1em; background-color: rgb(249, 249, 249);"   >2011-05-07 08:42:42 LOG:   pid 22382: DB node id: 1 backend pid: 22409 statement: SELECT abalance FROM pgbench_accounts WHERE aid = 62797;</pre></dd><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >The "DB node id: 1" shows which DB node was chosen for this loadbalancing session.</dd></dl><dl style="margin-top: 0.2em; margin-bottom: 0.5em; font-family: sans-serif; font-size: 13px; line-height: 19.2000007629395px;"   ><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >Please make sure that you start pgpool-II with "-n" option to get pgpool-II log. (or you can use syslog in pgpool-II 3.1 or later)</dd></dl></div><div><br></div>[参考]<div><br></div><div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="It seems my pgpool-II does not do load balancing. Why? - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a><br></div></div>
	</div>
</div>
</body>
</html>