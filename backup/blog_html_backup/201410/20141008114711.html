<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">pgpool-II md5 auth configure attention</h2>
	<h5 id="">2014-10-08 11:47:11&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201498111213508/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>使用pgpool-II后, 密码认证配置需要注意以下问题 :&nbsp;</div><div>1. pg_hba.conf, pool_hba.conf, pool_passwd的配置. (只有当pg_hba.conf, pool_hba.conf开启了md5, 并且在正确的路径配置了正确的pool_passwd文件才能正常的完成md5认证.)</div><div>2.&nbsp;<span style="line-height: 28px;"   >pool_passwd文件的位置.</span></div><div><span style="line-height: 28px;"   >3. 密码文件的格式, 属性(owner, group), 以及权限.</span></div><div><span style="line-height: 28px;"   >4. 密码文件的访问权限最好是400.</span></div><div><br></div><div><h3 style="font-weight: normal; margin: 0px 0px 0.3em; overflow: hidden; padding-top: 0.5em; padding-bottom: 0.17em; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(204, 204, 204); width: auto; font-size: 17px; font-family: sans-serif; line-height: 19.2000007629395px; background-image: none; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"   ><span id="I_created_pool_hba.conf_and_pool_passwd_to_enable_md5_authentication_through_pgpool-II_but_it_does_not_work._Why.3F"   ><b>I created pool_hba.conf and pool_passwd to enable md5 authentication through pgpool-II but it does not work. Why?</b></span></h3><dl style="margin-top: 0.2em; margin-bottom: 0.5em; font-family: sans-serif; font-size: 13px; line-height: 19.2000007629395px;"   ><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >Probably you made mistake somewhere. For your help here is a table which describes error patterns depending on the setting of pg_hba.conf, pool_hba.conf and pool_passwd.</dd></dl><p style="margin-top: 0.4em; margin-bottom: 0.5em; line-height: 19.2000007629395px; font-family: sans-serif; font-size: 13px;"   ></p><dl style="margin-top: 0.2em; margin-bottom: 0.5em; font-family: sans-serif; font-size: 13px; line-height: 19.2000007629395px;"   ><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   ><p style="margin-top: 0.4em; margin-bottom: 0.5em; line-height: 1.5em;"   ></p><table border="1"   style="font-size: 13px; border-collapse: collapse;"   ><tbody><tr><td style="border: 1px solid rgb(204, 204, 204); padding-left: 5px; padding-right: 5px;"   >pg_hba.conf</td><td style="border: 1px solid rgb(204, 204, 204); padding-left: 5px; padding-right: 5px;"   >pool_hba.conf</td><td style="border: 1px solid rgb(204, 204, 204); padding-left: 5px; padding-right: 5px;"   >pool_passwd</td><td style="border: 1px solid rgb(204, 204, 204); padding-left: 5px; padding-right: 5px;"   >result</td></tr><tr><td style="border: 1px solid rgb(204, 204, 204); padding-left: 5px; padding-right: 5px;"   >md5</td><td style="border: 1px solid rgb(204, 204, 204); padding-left: 5px; padding-right: 5px;"   >md5</td><td style="border: 1px solid rgb(204, 204, 204); padding-left: 5px; padding-right: 5px;"   >yes</td><td style="border: 1px solid rgb(204, 204, 204); padding-left: 5px; padding-right: 5px;"   >md5 auth</td></tr><tr><td style="border: 1px solid rgb(204, 204, 204); padding-left: 5px; padding-right: 5px;"   >md5</td><td style="border: 1px solid rgb(204, 204, 204); padding-left: 5px; padding-right: 5px;"   >md5</td><td style="border: 1px solid rgb(204, 204, 204); padding-left: 5px; padding-right: 5px;"   >no</td><td style="border: 1px solid rgb(204, 204, 204); padding-left: 5px; padding-right: 5px;"   >"MD5" authentication with pgpool failed for user "XX"</td></tr><tr><td style="border: 1px solid rgb(204, 204, 204); padding-left: 5px; padding-right: 5px;"   >md5</td><td style="border: 1px solid rgb(204, 204, 204); padding-left: 5px; padding-right: 5px;"   >trust</td><td style="border: 1px solid rgb(204, 204, 204); padding-left: 5px; padding-right: 5px;"   >yes/no</td><td style="border: 1px solid rgb(204, 204, 204); padding-left: 5px; padding-right: 5px;"   >MD5 authentication is unsupported in replication, master-slave and parallel mode</td></tr><tr><td style="border: 1px solid rgb(204, 204, 204); padding-left: 5px; padding-right: 5px;"   >trust</td><td style="border: 1px solid rgb(204, 204, 204); padding-left: 5px; padding-right: 5px;"   >md5</td><td style="border: 1px solid rgb(204, 204, 204); padding-left: 5px; padding-right: 5px;"   >yes</td><td style="border: 1px solid rgb(204, 204, 204); padding-left: 5px; padding-right: 5px;"   >no auth</td></tr><tr><td style="border: 1px solid rgb(204, 204, 204); padding-left: 5px; padding-right: 5px;"   >trust</td><td style="border: 1px solid rgb(204, 204, 204); padding-left: 5px; padding-right: 5px;"   >md5</td><td style="border: 1px solid rgb(204, 204, 204); padding-left: 5px; padding-right: 5px;"   >no</td><td style="border: 1px solid rgb(204, 204, 204); padding-left: 5px; padding-right: 5px;"   >"MD5" authentication with pgpool failed for user "XX"</td></tr><tr><td style="border: 1px solid rgb(204, 204, 204); padding-left: 5px; padding-right: 5px;"   >trust</td><td style="border: 1px solid rgb(204, 204, 204); padding-left: 5px; padding-right: 5px;"   >trust</td><td style="border: 1px solid rgb(204, 204, 204); padding-left: 5px; padding-right: 5px;"   >yes/no</td><td style="border: 1px solid rgb(204, 204, 204); padding-left: 5px; padding-right: 5px;"   >no auth</td></tr></table></dd></dl></div><div>为了确保搜索到正确路径下的pool_passwd 文件, 建议使用-n参数启动pgpool, 或者-f使用相对路径.&nbsp;</div><div>如果未使用-n , 并且-f使用了绝对路径的话, 那么会在根目录寻找pool_passwd文件.</div><div>可以使用http://www.pgpool.net/pipermail/pgpool-general/2013-May/001773.html提供的方法确认打开的pool_passwd文件是哪个, 当然也可以使用lsof来查看.</div><div><h3 style="font-weight: normal; margin: 0px 0px 0.3em; overflow: hidden; padding-top: 0.5em; padding-bottom: 0.17em; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(204, 204, 204); width: auto; font-size: 17px; font-family: sans-serif; line-height: 19.2000007629395px; background-image: none; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"   ><span id="I_cannot_use_MD5_authentication_if_start_pgpool_without_-n_option._Why.3F"   ><b>I cannot use MD5 authentication if start pgpool without -n option. Why?</b></span></h3><dl style="margin-top: 0.2em; margin-bottom: 0.5em; font-family: sans-serif; font-size: 13px; line-height: 19.2000007629395px;"   ><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >You must have given -f option as a relative path: i.e. "-f pgpool.conf", rather than full path: i.e. "-f /usr/local/etc/pgpool.conf". Pgpool tries to locate the full path of pool_passwd (which is neccesary for MD5 auth) from pgpool.conf path. This is fine with -n option. However if pgpool starts without -n option, it changes current directory to "/", which is neccessary processs for daemonizing. As a result, pgpool tries to open "/pool_passwd", which will not successs.</dd></dl></div><div><br></div><div><h3 style="font-weight: normal; margin: 0px 0px 0.3em; overflow: hidden; padding-top: 0.5em; padding-bottom: 0.17em; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(204, 204, 204); width: auto; font-size: 17px; font-family: sans-serif; line-height: 19.2000007629395px; background-image: none; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"   ><span id="md5_authentication_does_not_work._Please_help"   ><b>md5 authentication does not work. Please help</b></span></h3><dl style="margin-top: 0.2em; margin-bottom: 0.5em; font-family: sans-serif; font-size: 13px; line-height: 19.2000007629395px;"   ><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >There's an excellent summary of various check points to set up md5 authentication. Please take a look at it.</dd><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   ><a class="external free" rel="nofollow" href="http://www.pgpool.net/pipermail/pgpool-general/2013-May/001773.html"   >http://www.pgpool.net/pipermail/pgpool-general/2013-May/001773.html</a></dd></dl></div><div><span style="line-height: 28px;"   >pgpool 密码文件格式 :&nbsp;</span></div><div><span style="line-height: 28px;"   >密码可以从</span>pg_shadow.passwd取, 或者使用pg_md5命令生成.</div><div><h3 style="font-weight: normal; margin: 0px 0px 0.3em; overflow: hidden; padding-top: 0.5em; padding-bottom: 0.17em; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(204, 204, 204); width: auto; font-size: 17px; font-family: sans-serif; line-height: 19.2000007629395px; background-image: none; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"   ><span id="Can_I_use_.23_comments_or_blank_lines_in_pool_passwd.3F"   ><b>Can I use # comments or blank lines in pool_passwd?</b></span></h3><dl style="margin-top: 0.2em; margin-bottom: 0.5em; font-family: sans-serif; font-size: 13px; line-height: 19.2000007629395px;"   ><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >The answer is simple. No (just like /etc/passwd).</dd></dl></div><wbr><div><br></div>[参考]<div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.pgpool.net/pipermail/pgpool-general/2013-May/001773.html"   >http://www.pgpool.net/pipermail/pgpool-general/2013-May/001773.html</a></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >1)Getting the location of the pool_passwd file right is critical to getting authentication working. Getting the right entries is equally important. When we use pg_md5 to generate the password, it asks for the password, but not user. pg_md5 assumes $USER. In my case, I had logged in as root and &nbsp;executed pg_md5</font></div><div><font size="2"   >pg_md5 -p -m</font></div><div><font size="2"   >[root at n3170 etc]# more /usr/local/etc/pool_passwd</font></div><div><font size="2"   >root:md5e7630668fa08e27bb93b5e7db30725f2</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >So you have to either login as postgres and then execute pg_md5 or pass postgres as the user.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root at n3170 etc]# pg_md5 -p -m -u postgers</font></div><div><font size="2"   >password:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root at n3170 etc]# more /usr/local/etc/pool_passwd</font></div><div><font size="2"   >root:md5e7630668fa08e27bb93b5e7db30725f2</font></div><div><font size="2"   >postgers:md58f2fae75e1816d3d19e648e1bea21140</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >I wish pg_md5 could also verify against the database if the user exists.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >2) You can also copy/paste the entry from pg_shadow.</font></div><div><font size="2"   >postgres=# select &nbsp;passwd &nbsp;from pg_shadow where usename = 'postgres';</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;passwd</font></div><div><font size="2"   >-------------------------------------</font></div><div><font size="2"   >md5c719888b07cdc2f8c50c01e8e16996b9</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >In this scenario, you have to use the entire string - 'md5c719888b07cdc2f8c50c01e8e16996b9' , not just the portion after md5. I was using just 'c719888b07cdc2f8c50c01e8e16996b9' and the authentication kept failing.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >3) Use strace extensively to debug issues. To help identify the issues, set num_init_children = 1 in pgpool.conf. By default it is 32. When you run with 32, you will have so many process, you won't know which one to strace.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root at n3170 etc]# ps -eaf | grep pgpool | wc -l</font></div><div><font size="2"   >36</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Once you set it to 1, you will have fewer processes -</font></div><div><font size="2"   >[root at n3170 etc]# grep children pgpool.conf</font></div><div><font size="2"   >num_init_children = 1</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root at n3170 etc]# ps -eaf | grep pgpool | wc -l</font></div><div><font size="2"   >5</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root at n3170 etc]# ps -eaf | grep pgpool</font></div><div><font size="2"   >root &nbsp; &nbsp; 30642 &nbsp; &nbsp; 1 &nbsp;0 09:34 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 pgpool</font></div><div><font size="2"   >root &nbsp; &nbsp; 30643 30642 &nbsp;0 09:34 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 pgpool: wait for connection request</font></div><div><font size="2"   >root &nbsp; &nbsp; 30644 30642 &nbsp;0 09:34 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 pgpool: PCP: wait for connection request</font></div><div><font size="2"   >root &nbsp; &nbsp; 30645 30642 &nbsp;0 09:34 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 pgpool: worker process</font></div><div><font size="2"   >root &nbsp; &nbsp; 30681 14622 &nbsp;0 09:35 pts/0 &nbsp; &nbsp;00:00:00 grep pgpool</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >It is 30643, the process waiting for connection requests, that you want to strace.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >When you strace, use -s option (string size ) to get more characters from the output. Default value of s is 32. So a lot of useful information may get truncated.</font></div><div><font size="2"   >Something like</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >strace -p 30643 -s 500 -o connectattempts.txt</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >To make sure the program has picked the right files, you can use ls like this</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >ls -lv /proc/*pid*/fd</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Here pid is 30642</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root at n3170 etc]# ls -lv /proc/*30642*/fd</font></div><div><font size="2"   >total 0</font></div><div><font size="2"   >lrwx------. 1 root root 64 May 15 09:44 0 -&gt; /dev/null</font></div><div><font size="2"   >lrwx------. 1 root root 64 May 15 09:44 1 -&gt; /dev/null</font></div><div><font size="2"   >lrwx------. 1 root root 64 May 15 09:44 2 -&gt; /dev/null</font></div><div><font size="2"   >lrwx------. 1 root root 64 May 15 09:44 3 -&gt; /usr/local/etc/pool_passwd</font></div><p></p></pre></div><div><br></div><div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="pgpool-II md5 auth configure attention - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a><br></div></div>
	</div>
</div>
</body>
</html>