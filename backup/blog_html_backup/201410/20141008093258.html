<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL 9.4+ functions for get the OID of the named xxx</h2>
	<h5 id="">2014-10-08 9:32:58&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020149892122458/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>PostgreSQL 9.4 新增了一系列返回OID的系统函数, 例如to_regclass返回对象的OID, 这些函数可以被pgpool-II等类似应用, 用于区分在不同schema下, 重名的对象.</div><div>在PostgreSQL9.4版本前, pgpool-II需要安装pgpool_regclass来获取oid.</div><div>pgpool的需求 :&nbsp;</div><div><h3 style="font-weight: normal; margin: 0px 0px 0.3em; overflow: hidden; padding-top: 0.5em; padding-bottom: 0.17em; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(204, 204, 204); width: auto; font-size: 17px; font-family: sans-serif; line-height: 19.2000007629395px; background-image: none; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"   ><span id="When_I_use_schema_qualified_table_names.2C_pgpool-II_does_not_invalidate_on_memory_query_cache_and_I_got_outdated_data._Why.3F"   ><b>When I use schema qualified table names, pgpool-II does not invalidate on memory query cache and I got outdated data. Why?</b></span></h3><dl style="margin-top: 0.2em; margin-bottom: 0.5em; font-family: sans-serif; font-size: 13px; line-height: 19.2000007629395px;"   ><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >It seems you did not install "pgpool_regclass" function. Without the function, pgpool-II ignores the schema name pat of the schema qualified table name and the cache invalidation fails.</dd></dl></div><div><h3 style="font-weight: normal; margin: 0px 0px 0.3em; overflow: hidden; padding-top: 0.5em; padding-bottom: 0.17em; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(204, 204, 204); width: auto; font-size: 17px; font-family: sans-serif; line-height: 19.2000007629395px; background-image: none; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"   ><span id="I.27m_using_pgpool-II_in_replication_mode._I_expected_that_pgpool-II_replaces_current_timestamp_call_with_time_constants_in_my_INSERT_query.2C_but_actually_it_doesn.27t._Why.3F"   ><b>I'm using pgpool-II in replication mode. I expected that pgpool-II replaces current_timestamp call with time constants in my INSERT query, but actually it doesn't. Why?</b></span></h3><dl style="margin-top: 0.2em; margin-bottom: 0.5em; font-family: sans-serif; font-size: 13px; line-height: 19.2000007629395px;"   ><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >Probably your INSERT query uses schema qualied table name (like public.mytable) and you did not install pool_regclass function coming pgpool. Without pgpool_reglclass, pgpool-II only deals with table names without schema qualification.</dd></dl></div><div><h3 style="font-weight: normal; margin: 0px 0px 0.3em; overflow: hidden; padding-top: 0.5em; padding-bottom: 0.17em; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(204, 204, 204); width: auto; font-size: 17px; font-family: sans-serif; line-height: 19.2000007629395px; background-image: none; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"   ><span id="Why_do_I_need_to_install_pgpool_regclass.3F"   ><b>Why do I need to install pgpool_regclass?</b></span></h3><dl style="margin-top: 0.2em; margin-bottom: 0.5em; font-family: sans-serif; font-size: 13px; line-height: 19.2000007629395px;"   ><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >If you are using PostgreSQL 8.0 or later, installing pgpool_regclass function on all PostgreSQL to be accessed by pgpool-II is strongly recommended, as it is used internally by pgpool-II. Without this, handling of duplicate table names in different schema might cause trouble (temporary tables aren't a problem).</dd><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >Related FAQ is here&nbsp;<a class="external free" rel="nofollow" href="http://www.pgpool.net/mediawiki/index.php?title=FAQ&amp;action=submit#I.27m_using_pgpool-II_in_replication_mode._I_expected_that_pgpool-II_replaces_current_timestamp_call_with_time_constants_in_my_INSERT_query.2C_but_actually_it_doesn.27t._Why.3F"   >http://www.pgpool.net/mediawiki/index.php?title=FAQ&amp;action=submit#I.27m_using_pgpool-II_in_replication_mode._I_expected_that_pgpool-II_replaces_current_timestamp_call_with_time_constants_in_my_INSERT_query.2C_but_actually_it_doesn.27t._Why.3F</a></dd><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >If you are using PostgreSQL 9.4.0 or later and pgpool-II 3.3.4 or later, 3.4.0 or later, you don't need to install pgpool_regclass since PostgreSQL 9.4 has built-in pgpool_regclass like function "to_regclass".</dd></dl></div><div><h3 style="font-weight: normal; margin: 0px 0px 0.3em; overflow: hidden; padding-top: 0.5em; padding-bottom: 0.17em; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(204, 204, 204); width: auto; font-size: 17px; font-family: sans-serif; line-height: 19.2000007629395px; background-image: none; background-attachment: initial; background-size: initial; background-origin: initial; background-clip: initial; background-position: initial; background-repeat: initial;"   ><span id="When_I_check_pg_stat_activity_view.2C_I_see_a_query_like_.22SELECT_count.28.2A.29_FROM_pg_catalog.pg_class_AS_c_WHERE_c.oid_.3D_pgpool_regclass.28.27pgbench_accounts.27.29_AND_c.relpersistence_.3D_.27u.27.22_in_active_state_for_very_long_time._Why.3F"   ><b>When I check pg_stat_activity view, I see a query like "SELECT count(*) FROM pg_catalog.pg_class AS c WHERE c.oid = pgpool_regclass('pgbench_accounts') AND c.relpersistence = 'u'" in active state for very long time. Why?</b></span></h3><dl style="margin-top: 0.2em; margin-bottom: 0.5em; font-family: sans-serif; font-size: 13px; line-height: 19.2000007629395px;"   ><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >It's a limitation of pg_stat_activity. You can safely ignore it.</dd><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >Pgpool-II issues queries like above for internal use to master node. When user query runs in extended protocol mode (sent from JDBC driver, for example), pgpool-II's query also runs in the mode. To make pg_stat_activity recognize the query finishes, pgpool-II needs to send a packet called "Sync", which unfortunately breaks user's query (more precisely, unnamed portal). Thus pgpool-II sends "Flush" packet instead but then pg_stat_activity does not recognize the end of the query.</dd><dd style="line-height: 1.5em; margin-left: 2em; margin-bottom: 0.1em;"   >Interesting thing is, if you enable log_duration, it logs the query finishes.</dd></dl></div><div><br></div><div><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18.2399997711182px;"   >The&nbsp;</span><code style="font-size: 12px; line-height: 18.2399997711182px;"   >to_regclass</code><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18.2399997711182px;"   >,&nbsp;</span><code style="font-size: 12px; line-height: 18.2399997711182px;"   >to_regproc</code><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18.2399997711182px;"   >,&nbsp;</span><code style="font-size: 12px; line-height: 18.2399997711182px;"   >to_regprocedure</code><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18.2399997711182px;"   >,&nbsp;</span><code style="font-size: 12px; line-height: 18.2399997711182px;"   >to_regoper</code><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18.2399997711182px;"   >,&nbsp;</span><code style="font-size: 12px; line-height: 18.2399997711182px;"   >to_regoperator</code><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18.2399997711182px;"   >, and&nbsp;</span><code style="font-size: 12px; line-height: 18.2399997711182px;"   >to_regtype</code><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18.2399997711182px;"   >&nbsp;functions translate relation, function, operator, and type names to objects of type&nbsp;</span><tt style="font-size: 12px; line-height: 18.2399997711182px;"   >regclass</tt><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18.2399997711182px;"   >,&nbsp;</span><tt style="font-size: 12px; line-height: 18.2399997711182px;"   >regproc</tt><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18.2399997711182px;"   >,</span><tt style="font-size: 12px; line-height: 18.2399997711182px;"   >regprocedure</tt><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18.2399997711182px;"   >,&nbsp;</span><tt style="font-size: 12px; line-height: 18.2399997711182px;"   >regoper</tt><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18.2399997711182px;"   >,&nbsp;</span><tt style="font-size: 12px; line-height: 18.2399997711182px;"   >regoperator</tt><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18.2399997711182px;"   >, and&nbsp;</span><tt style="font-size: 12px; line-height: 18.2399997711182px;"   >regtype</tt><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18.2399997711182px;"   >, respectively. These functions differ from a cast from text in that they don't accept a numeric OID, and that they return null rather than throwing an error if the name is not found (or, for&nbsp;</span><code style="font-size: 12px; line-height: 18.2399997711182px;"   >to_regproc</code><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18.2399997711182px;"   >&nbsp;and&nbsp;</span><code style="font-size: 12px; line-height: 18.2399997711182px;"   >to_regoper</code><span style="font-family: verdana, sans-serif; font-size: 12px; line-height: 18.2399997711182px;"   >, if the given name matches multiple objects).</span></div><div><br></div><div><table border="1"   style="margin: 2ex 0px 2ex 2ex; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border-spacing: 0px; border-collapse: collapse; border: 2px solid rgb(167, 198, 223); color: rgb(0, 0, 0); font-family: verdana, sans-serif; font-size: 12px; line-height: normal; background-color: rgb(224, 236, 239);"   ><tbody><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>to_regclass(<tt style="font-size: 1em;"   >rel_name</tt>)</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>regclass</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >get the OID of the named relation</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>to_regproc(<tt style="font-size: 1em;"   >func_name</tt>)</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>regproc</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >get the OID of the named function</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>to_regprocedure(<tt style="font-size: 1em;"   >func_name</tt>)</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>regprocedure</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >get the OID of the named function</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(239, 239, 239);"   ><tt>to_regoper(<tt style="font-size: 1em;"   >operator_name</tt>)</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(239, 239, 239);"   ><tt>regoper</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(239, 239, 239);"   >get the OID of the named operator</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>to_regoperator(<tt style="font-size: 1em;"   >operator_name</tt>)</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>regoperator</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >get the OID of the named operator</td></tr><tr><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>to_regtype(<tt style="font-size: 1em;"   >type_name</tt>)</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   ><tt>regtype</tt></td><td style="border: 1px solid rgb(167, 198, 223); padding: 0.5ex; background-color: rgb(255, 255, 255);"   >get the OID of the named type</td></tr></table></div><wbr><div><br></div><div>使用cast, 当对象不存在时返回错误.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-172-16-3-221-&gt; psql</font></div><div><font size="2"   >psql (9.3.5)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select 'tes'::regclass;</font></div><div><font size="2"   >ERROR: &nbsp;relation "tes" does not exist</font></div><div><font size="2"   >LINE 1: select 'tes'::regclass;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"   >digoal=# select 'test'::regclass;</font></div><div><font size="2"   >&nbsp;regclass&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp;test</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><br></div><div>9.4使用to_regclass函数获取oid, 当对象不存在时返回空, 不返回错误.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg94@db-172-16-3-221-&gt; psql postgres postgres</font></div><div><font size="2"   >psql (9.4beta2)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=#&nbsp;</font></div></div><div><div><font size="2"   >postgres=# select to_regclass('test');</font></div><div><font size="2"   >&nbsp;to_regclass&nbsp;</font></div><div><font size="2"   >-------------</font></div><div><font size="2"   >&nbsp;test</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# select to_regclass('tes');</font></div><div><font size="2"   >&nbsp;to_regclass&nbsp;</font></div><div><font size="2"   >-------------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >postgres=# select 'tes'::regclass;</font></div><div><font size="2"   >ERROR: &nbsp;relation "tes" does not exist</font></div><div><font size="2"   >LINE 1: select 'tes'::regclass;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div></div><p></p></pre></div><div><br></div>[参考]<wbr>&nbsp;<div>1.&nbsp;<span style="line-height: 28px;"   >src/backend/utils/adt/regproc.c</span><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >/*</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;* to_regclass &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;- converts "classname" to class OID</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;*</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;* If the name is not found, we return NULL.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;*/</font></div><div style="line-height: 28px;"   ><font size="2"   >Datum</font></div><div style="line-height: 28px;"   ><font size="2"   >to_regclass(PG_FUNCTION_ARGS)</font></div><div style="line-height: 28px;"   ><font size="2"   >{</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; char &nbsp; &nbsp; &nbsp; *class_name = PG_GETARG_CSTRING(0);</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; List &nbsp; &nbsp; &nbsp; *names;</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Parse the name into components and see if it matches any pg_class</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* entries in the current search path.</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; names = stringToQualifiedNameList(class_name);</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* We might not even have permissions on this relation; don't lock it. */</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; result = RangeVarGetRelid(makeRangeVarFromNameList(names), NoLock, true);</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (OidIsValid(result))</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_OID(result);</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PG_RETURN_NULL();</font></div><div style="line-height: 28px;"   ><font size="2"   >}</font></div><p></p></pre></div></div><div><br></div><div><a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL 9.4+ functions for get the OID of the named xxx - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a><br></div></div></div>
	</div>
</div>
</body>
</html>