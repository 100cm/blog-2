<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL rows return by ProcessQuery queryDesc->estate->es_processed</h2>
	<h5 id="">2014-10-24 17:31:17&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201492452049196/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>群里一位朋友问到的, 关于执行插入SQL后, 有些返回0, 有些返回1的情况.</div><div>一般我们执行一条插入, 可以看到两个值, 一个是last oid, 一个是有多少行被插入.</div><div>代码如下 :&nbsp;</div><div><div style="line-height: 28px; font-family: monospace; white-space: pre;"   ><font size="2"   style="line-height: 21px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snprintf(completionTag, COMPLETION_TAG_BUFSIZE,</font></div><div style="line-height: 28px; font-family: monospace; white-space: pre;"   ><font size="2"   style="line-height: 21px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"INSERT %u %u", lastOid, queryDesc-&gt;estate-&gt;es_processed);</font></div></div><div><div>例子 :&nbsp;</div><div>创建两个表, 分别使用oids和不使用oids.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# create table tt(id int, info text) with oids;</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# create table tt1(id int, info text) without oids;</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >批量插入没有返回oid的信息, 但是被插入的行如实返回.</font></div><div><font size="2"   >digoal=# insert into tt values (1,'test'),(2,'test');</font></div><div><font size="2"   >INSERT 0 2</font></div><div><font size="2"   >digoal=# insert into tt1 values (1,'test'),(2,'test');</font></div><div><font size="2"   >INSERT 0 2</font></div><div><font size="2"   >插入单条时, 可以正常返回oid和插入的行.</font></div><div><font size="2"   >digoal=# insert into tt1 values (1,'test');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# insert into tt values (1,'test');</font></div><div><font size="2"   >INSERT 4710093 1</font></div><div><font size="2"   >digoal=# select oid,* from tt;</font></div><div><font size="2"   >&nbsp; &nbsp;oid &nbsp; | id | info&nbsp;</font></div><div><font size="2"   >---------+----+------</font></div><div><font size="2"   >&nbsp;4710091 | &nbsp;1 | test</font></div><div><font size="2"   >&nbsp;4710092 | &nbsp;2 | test</font></div><div><font size="2"   >&nbsp;4710093 | &nbsp;1 | test</font></div><div><font size="2"   >(3 rows)</font></div><p></p></pre></div><div><br></div><div>有一种场景是使用触发器来实现数据插入分区表的情况, 例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# create table a(id int, info text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# create table b(id int, info text);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# create or replace function tg1() returns trigger as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; if NEW.id&gt;10000 then</font></div><div><font size="2"   >&nbsp; &nbsp; insert into b values (NEW.*);</font></div><div><font size="2"   >&nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; return NEW;</font></div><div><font size="2"   >&nbsp; end if;</font></div><div><font size="2"   >&nbsp; return null; &nbsp;-- 注意触发器返回null, before触发器, null的话就等于没什么好做的了</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql strict;</font></div><div><font size="2"   >CREATE FUNCTION</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# create trigger tg1 before insert on a for each row execute procedure tg1();</font></div><div><font size="2"   >CREATE TRIGGER</font></div><div><font size="2"   >这条记录被插入到B表了, 所以返回的行为0. 但是实际上已经插入了.</font></div><div><font size="2"   >digoal=# insert into a values (10001,'test');</font></div><div><font size="2"   >INSERT 0 0</font></div><div><font size="2"   >digoal=# insert into a values (1,'test');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# select * from a;</font></div><div><font size="2"   >&nbsp;id | info&nbsp;</font></div><div><font size="2"   >----+------</font></div><div><font size="2"   >&nbsp; 1 | test</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >digoal=# select * from b;</font></div><div><font size="2"   >&nbsp; id &nbsp; | info&nbsp;</font></div><div><font size="2"   >-------+------</font></div><div><font size="2"   >&nbsp;10001 | test</font></div><div><font size="2"   >(1 row)</font></div></div><div><div><font size="2"   >digoal=# insert into a values (10001,'test'),(1,'test'),(10001,'test'),(1,'test');</font></div><div><font size="2"   >INSERT 0 2</font></div></div><div><font size="2"   >这条SQL实际插入了4行, 但是对于入口表a来说, 只插入了2行. 还有2行通过触发器插入了b表.</font></div><p></p></pre></div></div><div><br></div><div>另外, 如果使用LIBPQ的话, 可以使用PQcmdTuples来获得类似的信息.</div><div><dt style="font-family: verdana, sans-serif; font-size: 12px; line-height: normal;"   ><code>PQcmdTuples</code></dt><dd style="font-family: verdana, sans-serif; font-size: 12px; line-height: normal;"   ><p style="font-size: 1em; line-height: 1.5em; margin: 1.2em 0em;"   >Returns the number of rows affected by the SQL command.</p><pre style="font-size: 1em; -webkit-box-shadow: rgb(223, 223, 223) 3px 3px 5px; box-shadow: rgb(223, 223, 223) 3px 3px 5px; border: 1px solid rgb(207, 207, 207); padding: 2ex; margin-top: 2ex; margin-bottom: 2ex; margin-left: 2ex; overflow: auto; border-top-left-radius: 8px; border-top-right-radius: 8px; border-bottom-right-radius: 8px; border-bottom-left-radius: 8px; background-color: rgb(247, 247, 247);"   >char *PQcmdTuples(PGresult *res);
</pre><p style="font-size: 1em; line-height: 1.5em; margin: 1.2em 0em;"   >This function returns a string containing the number of rows affected by the&nbsp;<acronym>SQL&nbsp;statement that generated the&nbsp;<tt>PGresult</tt>. This function can only be used following the execution of a<tt>SELECT</tt>,&nbsp;<tt>CREATE TABLE AS</tt>,&nbsp;<tt>INSERT</tt>,&nbsp;<tt>UPDATE</tt>,&nbsp;<tt>DELETE</tt>,&nbsp;<tt>MOVE</tt>,&nbsp;<tt>FETCH</tt>, or&nbsp;<tt>COPY</tt>&nbsp;statement, or an&nbsp;<tt>EXECUTE</tt>&nbsp;of a prepared query that contains an&nbsp;<tt>INSERT</tt>,&nbsp;<tt>UPDATE</tt>, or&nbsp;<tt>DELETE</tt>&nbsp;statement. If the command that generated the&nbsp;<tt>PGresult</tt>&nbsp;was anything else,&nbsp;<code>PQcmdTuples</code>&nbsp;returns an empty string. The caller should not free the return value directly. It will be freed when the associated&nbsp;<tt>PGresult</tt>&nbsp;handle is passed to&nbsp;<code>PQclear</code>.</p></dd></div><wbr><div><br></div>[参考]<div>1.&nbsp;</div><div>src/include/executor/execdesc.h</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >/* ----------------</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;query descriptor:</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;a QueryDesc encapsulates everything that the executor</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;needs to execute the query.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;For the convenience of SQL-language functions, we also support QueryDescs</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;containing utility statements; these must not be passed to the executor</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;however.</font></div><div><font size="2"   >&nbsp;* ---------------------</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >typedef struct QueryDesc</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* These fields are provided by CreateQueryDesc */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; CmdType &nbsp; &nbsp; &nbsp; &nbsp; operation; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* CMD_SELECT, CMD_UPDATE, etc. */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PlannedStmt *plannedstmt; &nbsp; &nbsp; &nbsp; /* planner's output, or null if utility */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Node &nbsp; &nbsp; &nbsp; *utilitystmt; &nbsp; &nbsp; &nbsp; &nbsp;/* utility statement, or null */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; const char *sourceText; &nbsp; &nbsp; &nbsp; &nbsp; /* source text of the query */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Snapshot &nbsp; &nbsp; &nbsp; &nbsp;snapshot; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* snapshot to use for query */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Snapshot &nbsp; &nbsp; &nbsp; &nbsp;crosscheck_snapshot; &nbsp; &nbsp;/* crosscheck for RI update/delete */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; DestReceiver *dest; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* the destination for tuple output */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ParamListInfo params; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* param values being passed in */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; instrument_options; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* OR of InstrumentOption flags */</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* These fields are set by ExecutorStart */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TupleDesc &nbsp; &nbsp; &nbsp; tupDesc; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* descriptor for result tuples */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; EState &nbsp; &nbsp; *estate; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* executor's query-wide state */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; PlanState &nbsp;*planstate; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* tree of per-plan-node state */</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* This is always set NULL by the core system, but plugins can change it */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; struct Instrumentation *totaltime; &nbsp; &nbsp; &nbsp;/* total time spent in ExecutorRun */</font></div><div><font size="2"   >} QueryDesc;</font></div><p></p></pre></div><div>2.&nbsp;</div><div>src/include/nodes/execnodes.h</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >/* ----------------</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp;ExprContext</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;This class holds the "current context" information</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;needed to evaluate expressions for doing tuple qualifications</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;and tuple projections. &nbsp;For example, if an expression refers</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;to an attribute in the current inner tuple then we need to know</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;what the current inner tuple is and so we look at the expression</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;context.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;There are two memory contexts associated with an ExprContext:</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;* ecxt_per_query_memory is a query-lifespan context, typically the same</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp;context the ExprContext node itself is allocated in. &nbsp;This context</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp;can be used for purposes such as storing function call cache info.</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;* ecxt_per_tuple_memory is a short-term context for expression results.</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp;As the name suggests, it will typically be reset once per tuple,</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp;before we begin to evaluate expressions for that tuple. &nbsp;Each</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp;ExprContext normally has its very own per-tuple memory context.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;CurrentMemoryContext should be set to ecxt_per_tuple_memory before</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;calling ExecEvalExpr() --- see ExecEvalExprSwitchContext().</font></div><div><font size="2"   >&nbsp;* ----------------</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >typedef struct ExprContext</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; NodeTag &nbsp; &nbsp; &nbsp; &nbsp; type;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Tuples that Var nodes in expression may refer to */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TupleTableSlot *ecxt_scantuple;</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TupleTableSlot *ecxt_innertuple;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; TupleTableSlot *ecxt_outertuple;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Memory contexts for expression evaluation --- see notes above */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; MemoryContext ecxt_per_query_memory;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; MemoryContext ecxt_per_tuple_memory;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Values to substitute for Param nodes in expression */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ParamExecData *ecxt_param_exec_vals; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/* for PARAM_EXEC params */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ParamListInfo ecxt_param_list_info; /* for other param types */</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Values to substitute for Aggref nodes in the expressions of an Agg</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* node, or for WindowFunc nodes within a WindowAgg node.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Datum &nbsp; &nbsp; &nbsp;*ecxt_aggvalues; /* precomputed values for aggs/windowfuncs */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bool &nbsp; &nbsp; &nbsp; *ecxt_aggnulls; &nbsp; &nbsp; &nbsp;/* null flags for aggs/windowfuncs */</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Value to substitute for CaseTestExpr nodes in expression */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Datum &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; caseValue_datum;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bool &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;caseValue_isNull;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Value to substitute for CoerceToDomainValue nodes in expression */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; Datum &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; domainValue_datum;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; bool &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;domainValue_isNull;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Link to containing EState (NULL if a standalone ExprContext) */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; struct EState *ecxt_estate;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /* Functions to call back when ExprContext is shut down */</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ExprContext_CB *ecxt_callbacks;</font></div><div><font size="2"   >} ExprContext;</font></div></div><p></p></pre></div><div><br></div><wbr><div>3.&nbsp;src/backend/tcop/pquery.c</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >/*</font></div><div><font size="2"   >&nbsp;* ProcessQuery</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Execute a single plannable query within a PORTAL_MULTI_QUERY,</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;PORTAL_ONE_RETURNING, or PORTAL_ONE_MOD_WITH portal</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;plan: the plan tree for the query</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;sourceText: the source text of the query</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;params: any parameters needed</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;dest: where to send results</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp;completionTag: points to a buffer of size COMPLETION_TAG_BUFSIZE</font></div><div><font size="2"   >&nbsp;* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;in which to store a command completion status string.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* completionTag may be NULL if caller doesn't want a status string.</font></div><div><font size="2"   >&nbsp;*</font></div><div><font size="2"   >&nbsp;* Must be called in a memory context that will be reset or deleted on</font></div><div><font size="2"   >&nbsp;* error; otherwise the executor's memory usage will be leaked.</font></div><div><font size="2"   >&nbsp;*/</font></div><div><font size="2"   >static void</font></div></div><div><div><font size="2"   >ProcessQuery(PlannedStmt *plan,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;const char *sourceText,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ParamListInfo params,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;DestReceiver *dest,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;char *completionTag)</font></div><div><font size="2"   >{</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; QueryDesc &nbsp;*queryDesc;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; elog(DEBUG3, "ProcessQuery");</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Create the QueryDesc object</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; queryDesc = CreateQueryDesc(plan, sourceText,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GetActiveSnapshot(), InvalidSnapshot,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dest, params, 0);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Call ExecutorStart to prepare the plan for execution</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ExecutorStart(queryDesc, 0);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Run the plan to completion.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ExecutorRun(queryDesc, ForwardScanDirection, 0L);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Build command completion status string, if caller wants one.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; if (completionTag)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lastOid;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; switch (queryDesc-&gt;operation)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case CMD_SELECT:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snprintf(completionTag, COMPLETION_TAG_BUFSIZE,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"SELECT %u", queryDesc-&gt;estate-&gt;es_processed);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case CMD_INSERT:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (queryDesc-&gt;estate-&gt;es_processed == 1)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lastOid = queryDesc-&gt;estate-&gt;es_lastoid;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lastOid = InvalidOid;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snprintf(completionTag, COMPLETION_TAG_BUFSIZE,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"INSERT %u %u", lastOid, queryDesc-&gt;estate-&gt;es_processed);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case CMD_UPDATE:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snprintf(completionTag, COMPLETION_TAG_BUFSIZE,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"UPDATE %u", queryDesc-&gt;estate-&gt;es_processed);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; case CMD_DELETE:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; snprintf(completionTag, COMPLETION_TAG_BUFSIZE,</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;"DELETE %u", queryDesc-&gt;estate-&gt;es_processed);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; strcpy(completionTag, "???");</font></div></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Now, we close down all the scans and free allocated resources.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ExecutorFinish(queryDesc);</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; ExecutorEnd(queryDesc);</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; FreeQueryDesc(queryDesc);</font></div><div><font size="2"   >}</font></div></div><p></p></pre></div><div>4.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.4/static/libpq-exec.html"   >http://www.postgresql.org/docs/9.4/static/libpq-exec.html<br></a><span style="line-height: 28px;"   >
</span><a style="line-height: 28px;" rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL rows return by ProcessQuery queryDesc-estate-es_processed - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div></div></div>
	</div>
</div>
</body>
</html>