<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL column based storage extension - IMCS</h2>
	<h5 id="">2014-10-30 16:55:27&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020149245325263/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><div>IMCS是PostgreSQL的一个列存储扩展插件, 它并没有改变PostgreSQL的核心代码.</div><div>IMCS使用共享内存来存储数据, 所以使用IMCS后, 数据量受到内存大小的限制.</div><div>IMCS不能使用普通的SQL操作列存储的数据, 只能使用imcs定义好的函数, 或者你自己写扩展函数.</div><div>IMCS允许某些查询使用多核, 所以对某些查询的效率非常高.</div><div>因为使用低级的MVCC, 所以IMCS的并发能力相比PG普通的表操作差很多.</div><div>优缺点 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Advantages and disadvantages of IMCS approach:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >+ Fast execution based on vector operations</font></div><div><font size="2"   >+ Parallel execution of query (for some operations)</font></div><div><font size="2"   >+ No changes in PostgreSQL core (just standard extension)</font></div><div><font size="2"   >+ No MVCC overhead (MURSIW isolation level)</font></div><div><font size="2"   >+ No disk IO (in-memory store)</font></div><div><font size="2"   >+ Optimized for timeseries (massive operations with time slices)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >- Requires special queries (standard SQL queries can not be executed for IMCS data)</font></div><div><font size="2"   >- Need to reload data on server restart</font></div><div><font size="2"   >- Size of database is limited by size of RAM</font></div><div><font size="2"   >- Maintaining alternative representation of data requires extra memory and CPU.</font></div><div><font size="2"   >- Less level of concurrency for execution of multiple queries (it is not possible for example to append and query some table at the same time)</font></div><div><font size="2"   >- Not able to perform joins, index searches (only by timestamp)</font></div><div><font size="2"   >- Supports only fixed size string types</font></div><p></p></pre></div><div><br></div><div>测试 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 ~]# git clone https://github.com/knizhnik/imcs</font></div><div><font size="2"   >[root@db-172-16-3-221 ~]# cd imcs/</font></div><div><font size="2"   >[root@db-172-16-3-221 imcs]# ll</font></div><div><font size="2"   >total 1000</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp; 7836 Oct 30 16:08 about.txt</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp;54094 Oct 30 16:08 btree.c</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp; 3367 Oct 30 16:08 btree.h</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp; 2219 Oct 30 16:08 CHANGES</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp; 9411 Oct 30 16:08 disk.c</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp; 2689 Oct 30 16:08 disk.h</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp; 4062 Oct 30 16:08 example.sql</font></div><div><font size="2"   >drwxr-xr-x 2 root root &nbsp; 4096 Oct 30 16:08 expected</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp; 2886 Oct 30 16:08 fileio.c</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp; &nbsp;526 Oct 30 16:08 fileio.h</font></div><div><font size="2"   >-rw-r--r-- 1 root root 419943 Oct 30 16:08 func.c</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp;15988 Oct 30 16:08 func.h</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp;78159 Oct 30 16:08 imcs--1.1.sql</font></div><div><font size="2"   >-rw-r--r-- 1 root root 201930 Oct 30 16:08 imcs.c</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp; &nbsp;130 Oct 30 16:08 imcs.control</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp;10221 Oct 30 16:08 imcs.h</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp; &nbsp;154 Oct 30 16:08 INSTALL</font></div><div><font size="2"   >-rwxr-xr-x 1 root root &nbsp; &nbsp;220 Oct 30 16:08 install.sh</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp;11325 Oct 30 16:08 LICENSE</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp; 1201 Oct 30 16:08 Makefile</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp; 1499 Oct 30 16:08 META.json</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp; &nbsp; 61 Oct 30 16:08 README.md</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp;10613 Oct 30 16:08 smp.c</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp; 1919 Oct 30 16:08 smp.h</font></div><div><font size="2"   >drwxr-xr-x 2 root root &nbsp; 4096 Oct 30 16:08 sql</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp; 1249 Oct 30 16:08 sysv_shmem.patch</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp; 3565 Oct 30 16:08 threadpool.c</font></div><div><font size="2"   >-rw-r--r-- 1 root root 112010 Oct 30 16:08 user_guide.html</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-221 imcs]# cd ..</font></div><div><font size="2"   >[root@db-172-16-3-221 ~]# mv imcs /opt/soft_bak/postgresql-9.3.5/contrib/</font></div><div><font size="2"   >[root@db-172-16-3-221 ~]# cd /opt/soft_bak/postgresql-9.3.5/contrib/</font></div><div><font size="2"   >[root@db-172-16-3-221 contrib]# cd imcs</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-221 imcs]# which pg_config</font></div><div><font size="2"   >/opt/pgsql/bin/pg_config</font></div><div><font size="2"   >[root@db-172-16-3-221 imcs]# psql -V</font></div><div><font size="2"   >psql (PostgreSQL) 9.3.5</font></div><p></p></pre></div><div><br></div><div>安装, 需要修改一下install.sh的PATH, 指向正确的pg_config.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 imcs]# vi install.sh&nbsp;</font></div><div><font size="2"   ># Use -O3 instead of default for PostgreSQL -O2 to enable loop and vectorization optiomizations in GCC.</font></div><div><font size="2"   >PATH=/opt/pgsql/bin:$PATH make USE_PGXS=1 CFLAGS="-O3 -Wall -Wno-format-security" &nbsp;LDFLAGS="-pthread" install</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-221 imcs]# ./install.sh&nbsp;</font></div><div><font size="2"   >gcc -O3 -Wall -Wno-format-security -fpic -I. -I. -I/opt/pgsql9.3.5/include/server -I/opt/pgsql9.3.5/include/internal -D_GNU_SOURCE -I/usr/include/libxml2 &nbsp; -c -o imcs.o imcs.c</font></div><div><font size="2"   >gcc -O3 -Wall -Wno-format-security -fpic -I. -I. -I/opt/pgsql9.3.5/include/server -I/opt/pgsql9.3.5/include/internal -D_GNU_SOURCE -I/usr/include/libxml2 &nbsp; -c -o func.o func.c</font></div><div><font size="2"   >gcc -O3 -Wall -Wno-format-security -fpic -I. -I. -I/opt/pgsql9.3.5/include/server -I/opt/pgsql9.3.5/include/internal -D_GNU_SOURCE -I/usr/include/libxml2 &nbsp; -c -o smp.o smp.c</font></div><div><font size="2"   >gcc -O3 -Wall -Wno-format-security -fpic -I. -I. -I/opt/pgsql9.3.5/include/server -I/opt/pgsql9.3.5/include/internal -D_GNU_SOURCE -I/usr/include/libxml2 &nbsp; -c -o btree.o btree.c</font></div><div><font size="2"   >gcc -O3 -Wall -Wno-format-security -fpic -I. -I. -I/opt/pgsql9.3.5/include/server -I/opt/pgsql9.3.5/include/internal -D_GNU_SOURCE -I/usr/include/libxml2 &nbsp; -c -o threadpool.o threadpool.c</font></div><div><font size="2"   >gcc -O3 -Wall -Wno-format-security -fpic -shared -o imcs.so imcs.o func.o smp.o btree.o threadpool.o -pthread &nbsp;-lm&nbsp;</font></div><div><font size="2"   >/bin/mkdir -p '/opt/pgsql9.3.5/lib'</font></div><div><font size="2"   >/bin/mkdir -p '/opt/pgsql9.3.5/share/extension'</font></div><div><font size="2"   >/bin/mkdir -p '/opt/pgsql9.3.5/share/extension'</font></div><div><font size="2"   >/usr/bin/install -c -m 755 &nbsp;imcs.so '/opt/pgsql9.3.5/lib/imcs.so'</font></div><div><font size="2"   >/usr/bin/install -c -m 644 ./imcs.control '/opt/pgsql9.3.5/share/extension/'</font></div><div><font size="2"   >/usr/bin/install -c -m 644 ./imcs--1.1.sql &nbsp;'/opt/pgsql9.3.5/share/extension/'</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@db-172-16-3-221 imcs]# cd /opt/pgsql/</font></div><div><font size="2"   >[root@db-172-16-3-221 pgsql]# cd share/extension/</font></div><div><font size="2"   >[root@db-172-16-3-221 extension]# ll -rt</font></div><div><font size="2"   >total 992</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp; 130 Oct 30 16:19 imcs.control</font></div><div><font size="2"   >-rw-r--r-- 1 root root 78159 Oct 30 16:19 imcs--1.1.sql</font></div><p></p></pre></div><div>会创建一些类型, 函数. 具体内容详见imcs--1.1.sql</div><div><br></div><div>修改postgresql.conf重启数据库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >cd $PGDATA</font></div><div><font size="2"   >vi postgresql.conf</font></div><div><font size="2"   >shared_preload_libraries='imcs'</font></div><div><div><font size="2"   >postgres@db-172-16-3-221-&gt; pg_ctl restart -m fast</font></div><div><font size="2"   >waiting for server to shut down.... done</font></div><div><font size="2"   >server stopped</font></div><div><font size="2"   >server starting</font></div><div><font size="2"   >postgres@db-172-16-3-221-&gt; LOG: &nbsp;00000: loaded library "imcs"</font></div><div><font size="2"   >LOCATION: &nbsp;load_libraries, miscinit.c:1296</font></div><div><font size="2"   >LOG: &nbsp;00000: redirecting log output to logging collector process</font></div><div><font size="2"   >HINT: &nbsp;Future log output will appear in directory "pg_log".</font></div><div><font size="2"   >LOCATION: &nbsp;SysLogger_Start, syslogger.c:638</font></div><div><font size="2"   >postgres@db-172-16-3-221-&gt; psql</font></div><div><font size="2"   >psql (9.3.5)</font></div><div><font size="2"   >Type "help" for help.</font></div></div><p></p></pre></div><div><br></div><div>创建extension.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-172-16-3-221-&gt; psql</font></div><div><font size="2"   >psql (9.3.5)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# create extension imcs;</font></div><div><font size="2"   >CREATE EXTENSION</font></div><div><font size="2"   >digoal=# \dT</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of data types</font></div><div><font size="2"   >&nbsp;Schema | &nbsp; &nbsp; &nbsp;Name &nbsp; &nbsp; &nbsp; | Description&nbsp;</font></div><div><font size="2"   >--------+-----------------+-------------</font></div><div><font size="2"   >&nbsp;public | cs_agg_result &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;public | cs_elem_type &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;public | cs_profile_item |&nbsp;</font></div><div><font size="2"   >&nbsp;public | cs_sort_order &nbsp; |&nbsp;</font></div><div><font size="2"   >&nbsp;public | timeseries &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >(5 rows)</font></div><p></p></pre></div><div><br></div><div>性能测试, 可以参考imcs提供的example.sql</div><div><br></div><div><span style="line-height: 28px;"   >下载测试数据 :&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 ~]# su - postgres</font></div><div><font size="2"   >postgres@db-172-16-3-221-&gt; wget http://www.garret.ru/NYSE_2003_2013.csv.gz</font></div><div><font size="2"   >postgres@db-172-16-3-221-&gt; gunzip NYSE_2003_2013.csv.gz&nbsp;</font></div><div><div><font size="2"   >postgres@db-172-16-3-221-&gt; ll</font></div><div><font size="2"   >total 264M</font></div><div><font size="2"   >-rw-r--r-- &nbsp;1 postgres postgres 264M Oct 30 16:38 NYSE_2003_2013.csv</font></div><div><font size="2"   >postgres@db-172-16-3-221-&gt; less NYSE_2003_2013.csv&nbsp;</font></div><div><font size="2"   >Symbol,Date,Open,High,Low,Close,Volume</font></div><div><font size="2"   >A,01-Jan-2003,17.96,17.96,17.96,17.96,0</font></div><div><font size="2"   >AA,01-Jan-2003,22.78,22.78,22.78,22.78,0</font></div><div><font size="2"   >AAP,01-Jan-2003,16.308,16.308,16.308,16.308,0</font></div><div><font size="2"   >ABB,01-Jan-2003,2.3,2.3,2.3,2.3,0</font></div><div><font size="2"   >ABC,01-Jan-2003,13.5775,13.5775,13.5775,13.5775,0</font></div><div><font size="2"   >ABG,01-Jan-2003,8.41,8.41,8.41,8.41,0</font></div><div><font size="2"   >ABM,01-Jan-2003,15.5,15.5,15.5,15.5,0</font></div><div><font size="2"   >ABT,01-Jan-2003,40,40,40,40,0</font></div><div><font size="2"   >ABV,01-Jan-2003,3.112,3.112,3.112,3.112,0</font></div><div><font size="2"   >ABV.C,01-Jan-2003,2.166,2.166,2.166,2.166,0</font></div></div><div><font size="2"   >....</font></div><p></p></pre></div><div><br></div><div>测试example.sql</div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-221 ~]# cd /opt/soft_bak/postgresql-9.3.5/contrib/imcs</font></div><div style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-221 imcs]# cat example.sql&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >\timing</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >-- Table with quotes. Do not use index to make inserts faster</font></div><div style="line-height: 28px;"   ><font size="2"   >create table Quote (Symbol char(10), Day date, Open real, High real, Low real, Close real, Volume integer);</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >-- Load NYSE data for ten year (can be obtained from http://www.garret.ru/NYSE_2003_2013.csv.gz)</font></div><div style="line-height: 28px;"   ><font size="2"   >\copy Quote from 'NYSE_2003_2013.csv' with csv header;</font></div><div style="line-height: 28px;"   ><font size="2"   >-- 2m31.435s</font></div><div style="line-height: 28px;"   ><font size="2"   >-- with triggers: 6m30.939s</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >-- This table should actually contain more information about companies, but for this example we need just symbol name</font></div><div style="line-height: 28px;"   ><font size="2"   >create table Securities (Symbol char(10));</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >-- It is certainly not efficient way of populating Securities table, usually information about all used symbols is available</font></div><div style="line-height: 28px;"   ><font size="2"   >insert into Securities select distinct Symbol from Quote;</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >/*&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >digoal=# \df cs_create</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of functions</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;Schema | &nbsp; Name &nbsp; &nbsp;| Result data type | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Argument data types &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;Type &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >--------+-----------+------------------+--------------------------------------------------------------------------------------------</font></div><div style="line-height: 28px;"   ><font size="2"   >-----------------+--------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;public | cs_create | void &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | table_name text, timestamp_id text, timeseries_id text DEFAULT NULL::text, autoupdate boole</font></div><div style="line-height: 28px;"   ><font size="2"   >an DEFAULT false | normal</font></div><div style="line-height: 28px;"   ><font size="2"   >(1 row)</font></div></div><div style="line-height: 28px;"   ><font size="2"   >*/</font></div><div style="line-height: 28px;"   ><font size="2"   >-- Generate timeseries functions&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >select cs_create('Quote', 'Day', 'Symbol');</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >/*</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >digoal=# \df Quote_load</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of functions</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;Schema | &nbsp; &nbsp;Name &nbsp; &nbsp;| Result data type | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Argument data types &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp;Type &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >--------+------------+------------------+----------------------------------------------------------------------+--------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;public | quote_load | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | already_sorted boolean DEFAULT false, filter text DEFAULT NULL::text | normal</font></div><div style="line-height: 28px;"   ><font size="2"   >(1 row)</font></div></div><div style="line-height: 28px;"   ><font size="2"   >*/</font></div><div style="line-height: 28px;"   ><font size="2"   >-- 加载到内存</font></div><div style="line-height: 28px;"   ><font size="2"   >select Quote_load();&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >/*&nbsp;</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >&nbsp;quote_load&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >------------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; 6101167</font></div><div style="line-height: 28px;"   ><font size="2"   >(1 row)</font></div></div><div style="line-height: 28px;"   ><font size="2"   >*/&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >--- Time: 10222.079 ms</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >-- We will use this view to perform queries for all quotes for symbols</font></div><div style="line-height: 28px;"   ><font size="2"   >--create view SecurityQuotes as select * from Quote_get(array(select Symbol from Securities));</font></div><div style="line-height: 28px;"   ><font size="2"   >create view SecurityQuotes as select (Quote_get(Symbol)).* from Securities;</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >-- Calculate VWAP (volume-weighted average price) for each symbol</font></div><div style="line-height: 28px;"   ><font size="2"   >-- 这条查询会用到多核</font></div><div style="line-height: 28px;"   ><font size="2"   >select Symbol,cs_sum(Close*Volume) / cs_sum(Volume) as VWAP from SecurityQuotes;</font></div><div style="line-height: 28px;"   ><font size="2"   >--- Time: 386.528 ms</font></div><div style="line-height: 28px;"   ><font size="2"   >/*</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >digoal=# select count(*) from (select Symbol,cs_sum(Close*Volume) / cs_sum(Volume) as VWAP from SecurityQuotes) t;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;count&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >-------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; 3274</font></div><div style="line-height: 28px;"   ><font size="2"   >(1 row)</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >Time: 0.817 ms</font></div></div><div style="line-height: 28px;"   ><font size="2"   >*/</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >-- Show growth days for symbol ABB during first quoter of 2010&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >select (Quote_project(abb.*,cs_top_max_pos(Close, 10))).* from Quote_get('ABB', date('01-Jan-2010'), date('31-Mar-2010')) abb;</font></div><div style="line-height: 28px;"   ><font size="2"   >/*</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >&nbsp;symbol | &nbsp; &nbsp;day &nbsp; &nbsp; | open &nbsp;| high &nbsp;| &nbsp;low &nbsp;| close | volume &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >--------+------------+-------+-------+-------+-------+---------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;ABB &nbsp; &nbsp;| 2010-03-31 | 21.72 | 21.96 | 21.62 | 21.84 | 1658500</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;ABB &nbsp; &nbsp;| 2010-03-23 | 21.56 | 21.79 | 21.52 | 21.79 | 2004500</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;ABB &nbsp; &nbsp;| 2010-03-30 | 21.67 | 21.72 | 21.48 | 21.64 | 1131800</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;ABB &nbsp; &nbsp;| 2010-03-18 | 21.51 | 21.59 | 21.33 | 21.59 | 1430000</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;ABB &nbsp; &nbsp;| 2010-03-17 | 21.61 | 21.74 | 21.51 | 21.56 | 1614200</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;ABB &nbsp; &nbsp;| 2010-03-26 | 21.51 | &nbsp;21.7 | 21.27 | 21.49 | 1877100</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;ABB &nbsp; &nbsp;| 2010-03-29 | 21.45 | 21.52 | &nbsp;21.3 | 21.49 | 1356500</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;ABB &nbsp; &nbsp;| 2010-03-24 | 21.37 | &nbsp;21.5 | 21.29 | 21.38 | 1453400</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;ABB &nbsp; &nbsp;| 2010-03-16 | 21.11 | &nbsp;21.4 | 21.07 | 21.36 | 1731300</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;ABB &nbsp; &nbsp;| 2010-03-22 | 20.88 | 21.42 | 20.87 | 21.35 | 2588000</font></div><div style="line-height: 28px;"   ><font size="2"   >(10 rows)</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >Time: 2.969 ms</font></div></div><div style="line-height: 28px;"   ><font size="2"   >*/</font></div><div style="line-height: 28px;"   ><font size="2"   >select (Quote_project(abb.*,cs_filter_pos(Close&gt;Open*1.01))).* from Quote_get('ABB', date('01-Jan-2010'), date('31-Mar-2010')) abb;</font></div><div style="line-height: 28px;"   ><font size="2"   >/*</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >&nbsp;symbol | &nbsp; &nbsp;day &nbsp; &nbsp; | open &nbsp;| high &nbsp;| &nbsp;low &nbsp;| close | volume &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >--------+------------+-------+-------+-------+-------+---------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;ABB &nbsp; &nbsp;| 2010-01-08 | 20.23 | 20.81 | 20.18 | 20.74 | 4832900</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;ABB &nbsp; &nbsp;| 2010-01-19 | 19.46 | 19.85 | 19.43 | 19.83 | 4019300</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;ABB &nbsp; &nbsp;| 2010-02-02 | 18.74 | 19.01 | 18.66 | 18.95 | 2635100</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;ABB &nbsp; &nbsp;| 2010-02-11 | 17.92 | 18.19 | 17.71 | 18.19 | 3116900</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;ABB &nbsp; &nbsp;| 2010-02-12 | &nbsp;17.6 | 17.95 | 17.54 | 17.87 | 2351600</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;ABB &nbsp; &nbsp;| 2010-02-16 | 17.82 | 18.35 | 17.81 | 18.31 | 2327000</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;ABB &nbsp; &nbsp;| 2010-02-18 | 19.39 | 19.96 | 19.35 | 19.91 | 6326800</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;ABB &nbsp; &nbsp;| 2010-02-25 | 19.61 | 20.18 | 19.56 | 20.15 | 2367700</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;ABB &nbsp; &nbsp;| 2010-02-26 | 19.99 | 20.28 | &nbsp;19.8 | 20.26 | 1782500</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;ABB &nbsp; &nbsp;| 2010-03-05 | 20.86 | 21.13 | 20.82 | 21.11 | 2602200</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;ABB &nbsp; &nbsp;| 2010-03-09 | 20.76 | 21.09 | 20.75 | &nbsp; &nbsp;21 | 2425500</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;ABB &nbsp; &nbsp;| 2010-03-16 | 21.11 | &nbsp;21.4 | 21.07 | 21.36 | 1731300</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;ABB &nbsp; &nbsp;| 2010-03-22 | 20.88 | 21.42 | 20.87 | 21.35 | 2588000</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;ABB &nbsp; &nbsp;| 2010-03-23 | 21.56 | 21.79 | 21.52 | 21.79 | 2004500</font></div><div style="line-height: 28px;"   ><font size="2"   >(14 rows)</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >Time: 1.639 ms</font></div></div><div style="line-height: 28px;"   ><font size="2"   >*/</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >select cs_count(cs_filter_pos(Close&gt;Open*1.01)) &nbsp;from Quote_get('ABB');</font></div><div style="line-height: 28px;"   ><font size="2"   >/*</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >&nbsp;cs_count&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >----------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; 534</font></div><div style="line-height: 28px;"   ><font size="2"   >(1 row)</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >Time: 3.933 ms</font></div></div><div style="line-height: 28px;"   ><font size="2"   >*/</font></div><div style="line-height: 28px;"   ><font size="2"   >-- Now calculate VWAP using standard Postgress aggregates.</font></div><div style="line-height: 28px;"   ><font size="2"   >select Symbol,sum(Close*Volume)/sum(Volume) as VWAP from Quote group by Symbol;</font></div><div style="line-height: 28px;"   ><font size="2"   >--- Time: 2184.646 ms</font></div><div style="line-height: 28px;"   ><font size="2"   >/*</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >digoal=# select count(*) from (select Symbol,sum(Close*Volume)/sum(Volume) as VWAP from Quote group by Symbol) t;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;count&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >-------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; 3274</font></div><div style="line-height: 28px;"   ><font size="2"   >(1 row)</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >Time: 4200.106 ms</font></div></div><div style="line-height: 28px;"   ><font size="2"   >*/</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >select Symbol,cs_sum(Close*Volume) / cs_sum(Volume) as VWAP from Quote_get('ABB');</font></div><div style="line-height: 28px;"   ><font size="2"   >--- Time: 0.506 ms</font></div><div style="line-height: 28px;"   ><font size="2"   >/*</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >&nbsp;symbol | &nbsp; &nbsp; &nbsp; vwap &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >--------+------------------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;ABB &nbsp; &nbsp;| 18.8058676363441</font></div><div style="line-height: 28px;"   ><font size="2"   >(1 row)</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >Time: 5.479 ms</font></div></div><div style="line-height: 28px;"   ><font size="2"   >*/</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >select Symbol,sum(Close*Volume)/sum(Volume) as VWAP from Quote group by Symbol having Symbol='ABB';</font></div><div style="line-height: 28px;"   ><font size="2"   >--- Time: 2.818 ms</font></div><div style="line-height: 28px;"   ><font size="2"   >/*</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;symbol &nbsp; | &nbsp; &nbsp; &nbsp; vwap &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >------------+------------------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;ABB &nbsp; &nbsp; &nbsp; &nbsp;| 18.8058676263111</font></div><div style="line-height: 28px;"   ><font size="2"   >(1 row)</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >Time: 1231.209 ms</font></div></div><div style="line-height: 28px;"   ><font size="2"   >*/</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >select cs_sum(Close) from Quote_concat(array(select Symbol from Securities));</font></div><div style="line-height: 28px;"   ><font size="2"   >--- Time: 76.167 ms</font></div><div style="line-height: 28px;"   ><font size="2"   >/*</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; cs_sum &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >------------------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;450031829.244867</font></div><div style="line-height: 28px;"   ><font size="2"   >(1 row)</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >Time: 138.147 ms</font></div></div><div style="line-height: 28px;"   ><font size="2"   >*/</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >--- Average True Range (ATR) indicator with 14 days period for last quarter of ABB</font></div><div style="line-height: 28px;"   ><font size="2"   >select cs_window_atr(cs_maxof(High-Low,0|||cs_maxof(cs_abs((High&lt;&lt;1) - Close), cs_abs((Low&lt;&lt;1) - Close))), 14) &lt;&lt; 13 from Quote_get('ABB', date('01-Jan-2010'), date('31-Mar-2010'));</font></div><div style="line-height: 28px;"   ><font size="2"   >/*</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >&nbsp;float8:{0.257856777736119,0.288009750599764,0.310294795661904,0.316702283009645,0.326223603004631,0.330779152575519,0.3450091259127</font></div><div style="line-height: 28px;"   ><font size="2"   >59,0.358222808822241,0.350492608192081,0.350457449140484,0.346853291134775,0.35993524795697,0.387797015960043,0.38581155841658,0.403</font></div><div style="line-height: 28px;"   ><font size="2"   >967832075999,0.403684388251304,0.409135606917994,0.409197338381859,0.379968957068869,0.391399811244475,0.383442730915977,0.399625300</font></div><div style="line-height: 28px;"   ><font size="2"   >350759,0.398937735300594,0.382585045371547,0.392400431970985,0.390086022758981,0.406508509650011,0.41175800535965,0.405918142384393,</font></div><div style="line-height: 28px;"   ><font size="2"   >0.394781132214079,0.388725298908958,0.377387744860913,0.372574296366732,0.360247615407641,0.358801368063373,0.351029841773132,0.3409</font></div><div style="line-height: 28px;"   ><font size="2"   >5621625167,0.328030761334558,0.332457091928407,0.332281579912524,0.32497572007851,0.320334613564462,0.324596503175232,0.340696698452</font></div><div style="line-height: 28px;"   ><font size="2"   >754,0.335646966974963,0.326672118224798,0.331909796818046,0.338916261700741,0.330422330200912,0.323963575980715,0.325108909499183}</font></div><div style="line-height: 28px;"   ><font size="2"   >(1 row)</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >Time: 1.509 ms</font></div></div><div style="line-height: 28px;"   ><font size="2"   >*/</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >--- Relative Strength Index (RSI) indicator with 14 days period for last quarter of ABB</font></div><div style="line-height: 28px;"   ><font size="2"   >select 100-(100/(1+cs_window_ema(cs_maxof(cs_diff(Close), 0), 14)/cs_window_ema(cs_maxof(-cs_diff(Close), 0), 14))) from Quote_get('ABB', date('01-Jan-2010'), date('31-Mar-2010'));</font></div><div style="line-height: 28px;"   ><font size="2"   >/*</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >&nbsp;float8:{-nan,100,100,100,100,100,81.0050021300039,60.5785874200606,62.7464222862852,64.9691804755226,55.4291774948804,55.4291774948</font></div><div style="line-height: 28px;"   ><font size="2"   >804,45.9889174578991,27.023178278228,21.3373568059468,15.3806633696472,31.2468069552894,32.464425840207,43.2004159705009,32.18957646</font></div><div style="line-height: 28px;"   ><font size="2"   >43253,30.1345542340998,42.1249241675097,52.0435717778121,46.3840719698246,35.2502498227066,31.0141700715262,28.0926808760699,43.3672</font></div><div style="line-height: 28px;"   ><font size="2"   >794025951,39.0785526057631,49.1383286652419,43.9815087175945,43.9815087175945,53.0091179978955,56.6713413607401,73.4093634793448,70.</font></div><div style="line-height: 28px;"   ><font size="2"   >4917502153137,73.0578703192237,64.2263814314996,67.0806363506567,69.9658440366047,71.2962859494959,73.9583756960014,75.0506064926819</font></div><div style="line-height: 28px;"   ><font size="2"   >,76.5629100698097,77.4816148977032,81.6348543203112,82.7861694271446,72.3231122226793,73.2109786195316,65.0271130697741,70.973353080</font></div><div style="line-height: 28px;"   ><font size="2"   >4915,61.5775451557452,70.5689006029185,73.9219586741707,74.42624897266,55.1485998854667,60.8713002878127,69.4698944221917,56.1930452</font></div><div style="line-height: 28px;"   ><font size="2"   >665804,55.5950534472502,58.8773912204727,58.8773912204727,...}</font></div><div style="line-height: 28px;"   ><font size="2"   >(1 row)</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >Time: 1.864 ms</font></div></div><div style="line-height: 28px;"   ><font size="2"   >*/</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >--- Now place all quotes in single timeseries (no symbol)</font></div><div style="line-height: 28px;"   ><font size="2"   >drop view securityquotes ;</font></div><div style="line-height: 28px;"   ><font size="2"   >select Quote_drop();</font></div><div style="line-height: 28px;"   ><font size="2"   >select cs_create('Quote', 'Day');</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >select Quote_load();</font></div><div style="line-height: 28px;"   ><font size="2"   >--- Time: 7658.043 ms</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >--- Calculate VWAP for the whole timeseries with ~6 millions elments</font></div><div style="line-height: 28px;"   ><font size="2"   >select cs_sum(Close*Volume) / cs_sum(Volume) as VWAP from Quote_get();</font></div><div style="line-height: 28px;"   ><font size="2"   >--- Time: 7.616 ms</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >--- Yet another way of calculating VWAP using cs_wavg</font></div><div style="line-height: 28px;"   ><font size="2"   >select Volume//Close as VWAP from Quote_get();</font></div><div style="line-height: 28px;"   ><font size="2"   >--- Time: 6.501 ms</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >--- The same query using standard Postgress aggregates</font></div><div style="line-height: 28px;"   ><font size="2"   >select sum(Close*Volume)/sum(Volume) as VWAP from Quote;</font></div><div style="line-height: 28px;"   ><font size="2"   >--- Time: 1078.843 ms</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >--- Select top 5 symbols with largest average prices</font></div><div style="line-height: 28px;"   ><font size="2"   >select cs_project(q, cs_top_max_pos((q).avg, 5)) from (select cs_hash_avg(Close, Symbol) q from Quote_get() offset 0) s;</font></div><div style="line-height: 28px;"   ><font size="2"   >--- Time: 76.214 ms</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >--- The same using standard SQL</font></div><div style="line-height: 28px;"   ><font size="2"   >select avg(Close) ac,Symbol from Quote group by Symbol order by ac desc limit 5;</font></div><div style="line-height: 28px;"   ><font size="2"   >--- Time: 1621.042 ms</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >--- Find longest periods when NYSE is not working</font></div><div style="line-height: 28px;"   ><font size="2"   >select cs_map(Day, cs_top_max_pos(cs_diff(Day), 5)),cs_top_max(cs_diff(Day), 5) from Quote_get();</font></div><div style="line-height: 28px;"   ><font size="2"   >--- Time: 38.448 ms</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >--- Number of unique values of close prices for 10 years</font></div><div style="line-height: 28px;"   ><font size="2"   >select cs_count(cs_unique(cs_sort(Close))) from Quote_get();</font></div><div style="line-height: 28px;"   ><font size="2"   >--- Time: 866.869 ms</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >select cs_quantile(Close,5) from Quote_get();</font></div><div style="line-height: 28px;"   ><font size="2"   >--- Time: 810.362 ms</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >--- Delete all records</font></div><div style="line-height: 28px;"   ><font size="2"   >select StackOptions_delete();</font></div><div style="line-height: 28px;"   ><font size="2"   >select sum(Quote_delete(Symbol)) from Securities;</font></div><p></p></pre></div></div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://github.com/knizhnik/imcs"   >https://github.com/knizhnik/imcs</a></div><div><span style="line-height: 28px;"   >2. IMCS介绍</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-221 imcs]# cat about.txt&nbsp;</font></div><div><font size="2"   >In-Memory Columnar Store for PostgreSQL</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Columnar store manager stores data tables as sections of columns of data rather than as rows of data.</font></div><div><font size="2"   >Most of traditional DBMS-es &nbsp;store data in rows ("horizontally"): all record attributes are stored together.</font></div><div><font size="2"   >Such approach allows to load the whole record using one read operation which usually leads to better performance for OLTP&nbsp;</font></div><div><font size="2"   >queries (which access or update single records). But OLAP queries are mostly performing operations on individual columns,&nbsp;</font></div><div><font size="2"   >for example calculating sum or average of some column. In this case vertical data representation, when data for each column&nbsp;</font></div><div><font size="2"   >is stored independently, is more efficient. There are several DBMS-es in marker which are based on vertical model: Vertica,&nbsp;</font></div><div><font size="2"   >SciDB,... Also most of mainstream commercial databases also provide OLAP extensions based on vertical storage:</font></div><div><font size="2"   >Blue Acceleration for DB2, Oracle Database In-Memory Option, Microsoft SQL server column store...</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Columnar store or vertical representation of data allows to achieve better performance in comparison with classical horizontal representation due to three factors:</font></div><div><font size="2"   >* Reducing size of fetched data: only columns involved in query are accessed.</font></div><div><font size="2"   >* Vector operations. Applying an operator to set of values (tile) makes it possible to minimize interpretation cost.</font></div><div><font size="2"   >Also SIMD instructions of modern processors accelerate execution of vector operations.</font></div><div><font size="2"   >* Compression of data. Certainly compression can also be used for all the records, but independent compression of each column can give much better results without significant extra CPU overhead. For example such simple compression algorithm like RLE&nbsp;</font></div><div><font size="2"   >(run-length-encoding) allows not only to reduce used space, but also minimize number of performed operations.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Modern servers usually have large amount of operating memory. Server with terabyte of RAM is not something very exotic now,&nbsp;</font></div><div><font size="2"   >especially in financial world. So volumes of RAM which few years ago are available only at supercomputers can now met in configurations&nbsp;</font></div><div><font size="2"   >of standard &nbsp;servers... Certainly there are databases which requires petabyte and more memory, which still can not fit in RAM.</font></div><div><font size="2"   >But size of most databases is comparable with size of available RAM, which allows to keep all data in memory.</font></div><div><font size="2"   >It requires special algorithms for main-memory databases. For example it is possible to configure size of buffers (disk cache)&nbsp;</font></div><div><font size="2"   >in traditional database to be large enough to fit the complete database in memory. But still algorithms oriented on work with disk&nbsp;</font></div><div><font size="2"   >and optimized to reduce number of IO operations will be inefficient for in-memory data and have to do a lot of redundant work.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >IMCS provides columnar store for PostgreSQL.</font></div><div><font size="2"   >There is some specific of PostgreSQL which affects design of IMCS:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >* PostgreSQL is not able to parallelize execution of an individual query. It may be normal for OLTP where larger number of simples</font></div><div><font size="2"   >queries are usually executed concurrently. For for OLAP situation is quite opposite: there is small number of queries but execution of&nbsp;</font></div><div><font size="2"   >each query may take significant amount of time.</font></div><div><font size="2"   >* PostgreSQL has multiversion concurrency control (MVCC). It allows to execute larger number of queries concurrently,</font></div><div><font size="2"   >but adds significant space and CPU overhead. As it was mentioned above, in case of OLAP we rarely need concurrent execution of multiple queries, but it is important to make execution of single complex query as fast as possible and so minimize locking overhead.</font></div><div><font size="2"   >* MVCC nature of PostgreSQL makes it difficult to work with large updatable objects (because MVCC requires cloning of an object&nbsp;</font></div><div><font size="2"   >for each update). So it is not possible to efficiently work with columnar store data using standard PostgreSQL data model.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Taken in account all above we decided to&nbsp;</font></div><div><font size="2"   >* Store MVCC data in PostgreSQL shared memory (to allow access to it from all PostgreSQL server processes).</font></div><div><font size="2"   >* Provide own executor for columnar store functions allowing to use vector operations and execute them concurrently by multiple thread.</font></div><div><font size="2"   >* Do not touch standard PostgreSQL query executor and optimizer.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >So IMCS is implemented as standard PostgreSQL extension, providing set of special functions and operators for columnar data.</font></div><div><font size="2"   >Some of these functions and operators are analog of standard SQL operators. For example binary and unary arithmetic operators,</font></div><div><font size="2"   >comparisons, match string operations, sorting, aggregation, inserting/deleting data.</font></div><div><font size="2"   >But there are a number of sophisticated analytic operators, for example finding extremum, crosses with zero, building histogram,&nbsp;</font></div><div><font size="2"   >calculating ranks, percentiles, ... IMCS provides extended set of aggregates which are required for financial application,&nbsp;</font></div><div><font size="2"   >like calculation of split-adjusted price, volume-weighted average price, moving average... All this aggregates can be calculated in parallel, utilizing all available CPU cores.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >IMCS is first of all oriented on work with timeseries. Timeseries is sequence of usually small fixed size elements ordered by some&nbsp;</font></div><div><font size="2"   >timestamp. Operations with timeseries rarely access some particular timeseries element, instead of it them operate either with whole&nbsp;</font></div><div><font size="2"   >timeseries either with some time interval. Such specific of timeseries operation requires special index for timeseries,&nbsp;</font></div><div><font size="2"   >which is different from traditional database indexes. &nbsp;Such index should not provide efficient way of locating arbitrary timeseries&nbsp;</font></div><div><font size="2"   >element. Instead of it this index should be able to efficiently extract range of timeseries elements.&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Our experiments show that IMCS provides 10-100 times improvement in performance comparing with standard SQL queries.</font></div><div><font size="2"   >The larger size of manipulated data is, the large is advantage in performance. If for timeseries with thousands elements improvement</font></div><div><font size="2"   >is about ten times, for timeseries with millions elements advantage in performance is more than 100 times.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >IMCS is integrated with standard SQL model, providing functions to switch from horizontal to vertical representation and vice versa.</font></div><div><font size="2"   >So IMCS usage pattern is the following:&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >* You should first of all choose which tables in your database requires vertical representation. If you wan to have vertical representation only for subset of table columns, then create a view.</font></div><div><font size="2"   >* IMCS generates PL/pgSQL functions to work with vertical representation of this table.</font></div><div><font size="2"   >* Data is loaded in PostgreSQL table in standard way (imported from CSV file, inserted using SQL,...).</font></div><div><font size="2"   >* Either automatically using trigger, either explicitly calling IMCS load function, this data is inserted in columnar store.</font></div><div><font size="2"   >* You query this data using IMCS functions and operators. Result of such query can be a tuple with timeseries. Or alternatively it is&nbsp;</font></div><div><font size="2"   >possible to flip this result back to horizontal representation, so you will get standard SQL set of tuples. In the last case it is possible</font></div><div><font size="2"   >to continue processing of results using standard SQL queries. Also you can convert timeseries to PostgreSQL array which may be useful</font></div><div><font size="2"   >to deal with timeseries from programming languages which API already supports arrays.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Advantages and disadvantages of IMCS approach:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >+ Fast execution based on vector operations</font></div><div><font size="2"   >+ Parallel execution of query (for some operations)</font></div><div><font size="2"   >+ No changes in PostgreSQL core (just standard extension)</font></div><div><font size="2"   >+ No MVCC overhead (MURSIW isolation level)</font></div><div><font size="2"   >+ No disk IO (in-memory store)</font></div><div><font size="2"   >+ Optimized for timeseries (massive operations with time slices)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >- Requires special queries (standard SQL queries can not be executed for IMCS data)</font></div><div><font size="2"   >- Need to reload data on server restart</font></div><div><font size="2"   >- Size of database is limited by size of RAM</font></div><div><font size="2"   >- Maintaining alternative representation of data requires extra memory and CPU.</font></div><div><font size="2"   >- Less level of concurrency for execution of multiple queries (it is not possible for example to append and query some table at the same time)</font></div><div><font size="2"   >- Not able to perform joins, index searches (only by timestamp)</font></div><div><font size="2"   >- Supports only fixed size string types</font></div><p></p></pre></div><div><br></div></div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL column based storage extension - IMCS - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>