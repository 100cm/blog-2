<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Berkeley Packet Filter (BPF) zero copy buffer</h2>
	<h5 id="">2014-10-10 9:10:14&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201491083218459/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div><p style="margin-top: 0.5em; margin-bottom: 0.5em; line-height: 22.3999996185303px; color: rgb(37, 37, 37); font-family: sans-serif; font-size: 14px;"   >The&nbsp;<b>Berkeley Packet Filter</b>&nbsp;or BPF provides, on some&nbsp;<a title="Unix-like" style="text-decoration: none; color: rgb(11, 0, 128); background: none;" rel="nofollow" href="http://en.wikipedia.org/wiki/Unix-like"   >Unix-like</a>&nbsp;systems, a raw interface to&nbsp;<a title="Data link layer" style="text-decoration: none; color: rgb(11, 0, 128); background: none;" rel="nofollow" href="http://en.wikipedia.org/wiki/Data_link_layer"   >data link layers</a>, permitting raw link-layer packets to be sent and received. In addition, if the driver for the network interface supports&nbsp;<a title="Promiscuous mode" style="text-decoration: none; color: rgb(11, 0, 128); background: none;" rel="nofollow" href="http://en.wikipedia.org/wiki/Promiscuous_mode"   >promiscuous mode</a>, it allows the interface to be put into that mode, so that all packets on the&nbsp;<a title="Computer network" style="text-decoration: none; color: rgb(11, 0, 128); background: none;" rel="nofollow" href="http://en.wikipedia.org/wiki/Computer_network"   >network</a>, even those destined for other hosts, can be received.&nbsp;</p><p style="margin-top: 0.5em; margin-bottom: 0.5em; line-height: 22.3999996185303px; color: rgb(37, 37, 37); font-family: sans-serif; font-size: 14px;"   >In addition, it supports "filtering" packets, so that only "interesting" packets will be supplied to the software using BPF; this can avoid copying "uninteresting" packets from the&nbsp;<a title="Operating system" style="text-decoration: none; color: rgb(11, 0, 128); background: none;" rel="nofollow" href="http://en.wikipedia.org/wiki/Operating_system"   >operating system</a>&nbsp;<a title="Kernel (computer science)" style="text-decoration: none; color: rgb(11, 0, 128); background: none;" class="mw-redirect" rel="nofollow" href="http://en.wikipedia.org/wiki/Kernel_(computer_science)"   >kernel</a>&nbsp;to software running in user mode, reducing the CPU requirement to capture packets and the&nbsp;<a title="Buffer (computer science)" style="text-decoration: none; color: rgb(11, 0, 128); background: none;" class="mw-redirect" rel="nofollow" href="http://en.wikipedia.org/wiki/Buffer_(computer_science)"   >buffer</a>&nbsp;space required to avoid dropping packets. BPF's filtering capabilities are implemented as an interpreter for a&nbsp;<a title="Machine language" style="text-decoration: none; color: rgb(11, 0, 128); background: none;" class="mw-redirect" rel="nofollow" href="http://en.wikipedia.org/wiki/Machine_language"   >machine language</a>&nbsp;for the BPF&nbsp;<a title="Virtual machine" style="text-decoration: none; color: rgb(11, 0, 128); background: none;" rel="nofollow" href="http://en.wikipedia.org/wiki/Virtual_machine"   >virtual machine</a>; programs in that language can fetch data from the packet, perform&nbsp;<a title="Arithmetic" style="text-decoration: none; color: rgb(11, 0, 128); background: none;" rel="nofollow" href="http://en.wikipedia.org/wiki/Arithmetic"   >arithmetic</a>&nbsp;operations on data from the packet, and compare the results against constants or against data in the packet or test&nbsp;<a title="Bit" style="text-decoration: none; color: rgb(11, 0, 128); background: none;" rel="nofollow" href="http://en.wikipedia.org/wiki/Bit"   >bits</a>&nbsp;in the results, accepting or rejecting the packet based on the results of those tests. On some platforms, including&nbsp;<a title="FreeBSD" style="text-decoration: none; color: rgb(11, 0, 128); background: none;" rel="nofollow" href="http://en.wikipedia.org/wiki/FreeBSD"   >FreeBSD</a>&nbsp;and<a title="WinPcap" style="text-decoration: none; color: rgb(11, 0, 128); background: none;" class="mw-redirect" rel="nofollow" href="http://en.wikipedia.org/wiki/WinPcap"   >WinPcap</a>,&nbsp;<a title="Just-in-time compilation" style="text-decoration: none; color: rgb(11, 0, 128); background: none;" rel="nofollow" href="http://en.wikipedia.org/wiki/Just-in-time_compilation"   >just-in-time compilation</a>&nbsp;is used to convert virtual machine instructions into native code in order to further avoid overhead.</p><p style="margin-top: 0.5em; margin-bottom: 0.5em; line-height: 22.3999996185303px; color: rgb(37, 37, 37); font-family: sans-serif; font-size: 14px;"   >Kernel-mode interpreters for that same virtual machine language are used in raw data link layer mechanisms in other operating systems, such as&nbsp;<a title="Tru64 Unix" style="text-decoration: none; color: rgb(11, 0, 128); background: none;" class="mw-redirect" rel="nofollow" href="http://en.wikipedia.org/wiki/Tru64_Unix"   >Tru64 Unix</a>, and for socket filters in&nbsp;<a title="Linux" style="text-decoration: none; color: rgb(11, 0, 128); background: none;" rel="nofollow" href="http://en.wikipedia.org/wiki/Linux"   >Linux</a>&nbsp;and in the WinPcap packet capture mechanism.</p><p style="margin-top: 0.5em; margin-bottom: 0.5em; line-height: 22.3999996185303px; color: rgb(37, 37, 37); font-family: sans-serif; font-size: 14px;"   >A user-mode interpreter for it is provided with the libpcap/WinPcap implementation of the&nbsp;<a title="Pcap" style="text-decoration: none; color: rgb(11, 0, 128); background: none;" rel="nofollow" href="http://en.wikipedia.org/wiki/Pcap"   >pcap</a>&nbsp;<a title="Application programming interface" style="text-decoration: none; color: rgb(11, 0, 128); background: none;" rel="nofollow" href="http://en.wikipedia.org/wiki/Application_programming_interface"   >application programming interface</a>&nbsp;(API), so that, when capturing packets on systems without kernel-mode support for that filtering mechanism, packets can be filtered in user mode; code using the pcap API will work on both types of systems, although, on systems where the filtering is done in user mode, all packets, including those that will be filtered out, are copied from the kernel to user space. That interpreter can also be used when reading a file containing packets captured using pcap.</p><p style="margin-top: 0.5em; margin-bottom: 0.5em; line-height: 22.3999996185303px; color: rgb(37, 37, 37); font-family: sans-serif; font-size: 14px;"   >BPF is sometimes used to refer just to the filtering mechanism, rather than to the entire interface.</p><p style="margin-top: 0.5em; margin-bottom: 0.5em; line-height: 22.3999996185303px; color: rgb(37, 37, 37); font-family: sans-serif; font-size: 14px;"   >BSD kernels implement routines such as&nbsp;<code style="font-family: monospace, Courier; color: black; border: 1px solid rgb(221, 221, 221); border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px; padding: 1px 4px; background-color: rgb(249, 249, 249);"   >bpf_mtap()</code>&nbsp;and&nbsp;<code style="font-family: monospace, Courier; color: black; border: 1px solid rgb(221, 221, 221); border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px; padding: 1px 4px; background-color: rgb(249, 249, 249);"   >bpf_tap()</code>, with some wrapping them in macros such as&nbsp;<code style="font-family: monospace, Courier; color: black; border: 1px solid rgb(221, 221, 221); border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px; padding: 1px 4px; background-color: rgb(249, 249, 249);"   >BPF_MTAP()</code>&nbsp;and&nbsp;<code style="font-family: monospace, Courier; color: black; border: 1px solid rgb(221, 221, 221); border-top-left-radius: 2px; border-top-right-radius: 2px; border-bottom-right-radius: 2px; border-bottom-left-radius: 2px; padding: 1px 4px; background-color: rgb(249, 249, 249);"   >BPF_TAP()</code>, which are called by network interface drivers (and pseudo-drivers) to deliver incoming and outgoing packets to the BPF mechanism.</p></div><div><br></div><div><div><img title="Berkeley Packet Filter (BPF) zero copy buffer - 德哥@Digoal - PostgreSQL research"   alt="Berkeley Packet Filter (BPF) zero copy buffer - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/QAEfqPKhgx-plf9t-XWTbQ==/1461699554158721739.png"   ></div>&nbsp;<div><img title="Berkeley Packet Filter (BPF) zero copy buffer - 德哥@Digoal - PostgreSQL research"   alt="Berkeley Packet Filter (BPF) zero copy buffer - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/TXfHjD-oRlrLpONsUjMTPw==/3788371711649075790.png"   ></div>&nbsp;<div><img title="Berkeley Packet Filter (BPF) zero copy buffer - 德哥@Digoal - PostgreSQL research"   alt="Berkeley Packet Filter (BPF) zero copy buffer - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img2.ph.126.net/R_7dx2nGFy5I3sPec-ENoQ==/6597307261170003581.png"   ></div>&nbsp;<div><img title="Berkeley Packet Filter (BPF) zero copy buffer - 德哥@Digoal - PostgreSQL research"   alt="Berkeley Packet Filter (BPF) zero copy buffer - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/dQ2N1CwY9L_lR-n-Rjso9A==/1461699554158721742.png"   ></div>&nbsp;<div><img title="Berkeley Packet Filter (BPF) zero copy buffer - 德哥@Digoal - PostgreSQL research"   alt="Berkeley Packet Filter (BPF) zero copy buffer - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img2.ph.126.net/NKSG8WVnuniLYKzclVcaGA==/6597557949821262971.png"   ></div>&nbsp;<div><img title="Berkeley Packet Filter (BPF) zero copy buffer - 德哥@Digoal - PostgreSQL research"   alt="Berkeley Packet Filter (BPF) zero copy buffer - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img1.ph.126.net/_Hu4bM391vR3ZLaL0DlNJQ==/6597935082309590932.png"   ></div>&nbsp;<div><img title="Berkeley Packet Filter (BPF) zero copy buffer - 德哥@Digoal - PostgreSQL research"   alt="Berkeley Packet Filter (BPF) zero copy buffer - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/wt3ffnxDNrR5OlAoTqoIQw==/1237926947673832005.png"   ></div>&nbsp;<div><img title="Berkeley Packet Filter (BPF) zero copy buffer - 德哥@Digoal - PostgreSQL research"   alt="Berkeley Packet Filter (BPF) zero copy buffer - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img2.ph.126.net/s4CIDJlMJFCRgea59R4Dwg==/4891190670401512352.png"   ></div>&nbsp;<div><img title="Berkeley Packet Filter (BPF) zero copy buffer - 德哥@Digoal - PostgreSQL research"   alt="Berkeley Packet Filter (BPF) zero copy buffer - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img1.ph.126.net/ca7RgVUNQDZe0DEbGi-naA==/1795247401560872935.png"   ></div><br></div><div><br></div>[参考]<div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.watson.org/~robert/freebsd/2007asiabsdcon/20070309-devsummit-zerocopybpf.pdf"   >http://www.watson.org/~robert/freebsd/2007asiabsdcon/20070309-devsummit-zerocopybpf.pdf</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://en.wikipedia.org/wiki/Berkeley_Packet_Filter"   >http://en.wikipedia.org/wiki/Berkeley_Packet_Filter</a></div><div><wbr>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="Berkeley Packet Filter (BPF) zero copy buffer - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a><br></div></div>
	</div>
</div>
</body>
</html>