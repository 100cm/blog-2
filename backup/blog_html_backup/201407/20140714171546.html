<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">mediawiki, nginx, PHP, PostgreSQL, zhparser on CentOS 6.4 x64</h2>
	<h5 id="">2014-07-14 17:15:46&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201461391320568/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>本文介绍一下如何部署wiki网站.</div><div>目前wikimedia网站的架构 :&nbsp;</div><div><div><img title="mediawiki, nginx, PHP, PostgreSQL, zhparser on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   alt="mediawiki, nginx, PHP, PostgreSQL, zhparser on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://upload.wikimedia.org/wikipedia/commons/thumb/8/84/Wikimedia_Server_Architecture_%28simplified%29.svg/640px-Wikimedia_Server_Architecture_%28simplified%29.svg.png"   ></div>&nbsp;</div><div>本文测试环境 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >CentOS 6.x x64</font></div><div><font size="2"   >mediawiki 1.23.1</font></div><div><font size="2"   >php 5.5.14</font></div><div><font size="2"   >nginx 1.6.0</font></div><div><font size="2"   >PostgreSQL 9.3.x</font></div><div><font size="2"   >zhparser 中文分词</font></div><p></p></pre></div><div><br></div><div><div><img title="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   alt="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/W-vqdfCjd0Kry7CE4kuqyA==/3177289537210369266.png"   ></div>选择mediawiki 的 lts版本.&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># wget&nbsp;http://releases.wikimedia.org/mediawiki/1.23/mediawiki-1.23.1.tar.gz</font></div><font size="2"   ><wbr></font><div><font size="2"   ># tar -zxvf mediawiki-1.23.1.tar.gz&nbsp;</font></div><div><font size="2"   ># mv mediawiki-1.23.1 /opt/site/mediawiki</font></div><p></p></pre></div><div>配置数据库 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 soft_bak]# su - pg93</font></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; cd /ssd4/pg93</font></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; mkdir tbs_mediawiki</font></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; psql</font></div><div><font size="2"   >psql (9.3.3)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# create role mediawiki nosuperuser login encrypted password 'mediawiki';</font></div><div><font size="2"   >CREATE ROLE</font></div><div><font size="2"   >digoal=# create tablespace tbs_mediawiki location '/ssd4/pg93/tbs_mediawiki';</font></div><div><font size="2"   >CREATE TABLESPACE</font></div><div><font size="2"   >digoal=# create database mediawiki with template template0 encoding 'UTF8' tablespace tbs_mediawiki owner mediawiki;</font></div><div><font size="2"   >CREATE DATABASE</font></div><div><font size="2"   >digoal=# \c mediawiki mediawiki</font></div><div><font size="2"   >You are now connected to database "mediawiki" as user "mediawiki".</font></div><div><font size="2"   >mediawiki=&gt; create schema mediawiki;</font></div><div><font size="2"   >CREATE SCHEMA</font></div><p></p></pre></div><div>配置PostgreSQL 中文全文检索功能</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># wget&nbsp;http://www.xunsearch.com/site/downfile?file=xunsearch-full-latest.tar.bz2</font></div><div><font size="2"   ># tar -jxvf xunsearch-full-latest.tar.bz2</font></div><div><div><font size="2"   >[root@db-172-16-3-150 soft_bak]# cd xunsearch-full-1.4.8/</font></div><div><font size="2"   >[root@db-172-16-3-150 xunsearch-full-1.4.8]# ll</font></div><div><font size="2"   >total 20</font></div><div><font size="2"   >drwxr-xr-x 2 pg90 games &nbsp;4096 Jul 14 09:47 packages</font></div><div><font size="2"   >-rw-r--r-- 1 pg90 games &nbsp;2937 Jul &nbsp;2 &nbsp;2012 README.md</font></div><div><font size="2"   >-rwxr-xr-x 1 pg90 games 11069 Aug 27 &nbsp;2013 setup.sh</font></div><div><font size="2"   >[root@db-172-16-3-150 xunsearch-full-1.4.8]# cd packages/</font></div><div><font size="2"   >[root@db-172-16-3-150 packages]# ll</font></div><div><font size="2"   >total 9744</font></div><div><font size="2"   >-rw-r--r-- 1 pg90 games &nbsp;694445 Aug 27 &nbsp;2013 libevent-2.0.21-stable.tar.bz2</font></div><div><font size="2"   >-rw-r--r-- 1 pg90 games &nbsp;160888 Sep 21 &nbsp;2011 libuuid-1.0.0.tar.bz2</font></div><div><font size="2"   >-rw-r--r-- 1 pg90 games &nbsp; &nbsp; &nbsp;42 Sep &nbsp;6 &nbsp;2011 README</font></div><div><font size="2"   >-rw-r--r-- 1 pg90 games &nbsp;434924 Aug 23 &nbsp;2013 scws-1.2.3-dev.tar.bz2</font></div><div><font size="2"   >-rw-r--r-- 1 pg90 games 4090111 Dec 30 &nbsp;2010 scws-dict-chs-utf8.tar.bz2</font></div><div><font size="2"   >-rw-r--r-- 1 pg90 games 3476028 Aug 16 &nbsp;2013 xapian-core-scws-1.2.15.tar.bz2</font></div><div><font size="2"   >-rw-r--r-- 1 pg90 games &nbsp;676474 Dec 11 &nbsp;2013 xunsearch-1.4.8.tar.bz2</font></div><div><font size="2"   >-rw-r--r-- 1 pg90 games &nbsp;423087 Dec 11 &nbsp;2013 xunsearch-sdk-1.4.8.zip</font></div></div><div><font size="2"   >[root@db-172-16-3-150 packages]# tar -jxvf scws-1.2.3-dev.tar.bz2</font></div><div><div><font size="2"   >[root@db-172-16-3-150 packages]# cd scws-1.2.3-dev</font></div><div><font size="2"   >[root@db-172-16-3-150 scws-1.2.3-dev]# ./configure --prefix=/opt/scws-1.2.3-dev &amp;&amp; make &amp;&amp; make install</font></div></div><div><font size="2"   >[root@db-172-16-3-150 scws-1.2.3-dev]# cd /opt/soft_bak/</font></div><div><font size="2"   >[root@db-172-16-3-150 soft_bak]# git clone https://github.com/amutu/zhparser.git</font></div><div><div><font size="2"   >[root@db-172-16-3-150 soft_bak]# cd zhparser/</font></div><div><font size="2"   >[root@db-172-16-3-150 zhparser]# export PATH=/home/pg93/pgsql/bin:$PATH</font></div><div><font size="2"   >[root@db-172-16-3-150 zhparser]# which pg_config</font></div><div><font size="2"   >/home/pg93/pgsql/bin/pg_config</font></div><div><font size="2"   ># SCWS_HOME=/opt/scws-1.2.3-dev make</font></div><div><font size="2"   ># make install</font></div><div><font size="2"   >[root@db-172-16-3-150 zhparser]# su - pg93</font></div><div><font size="2"   >pg93@db-172-16-3-150-&gt; psql mediawiki postgres</font></div><div><font size="2"   >psql (9.3.3)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >mediawiki=# create extension zhparser;</font></div><div><font size="2"   >CREATE EXTENSION</font></div><div><font size="2"   >mediawiki=# select * from pg_ts_parser ;</font></div><div><font size="2"   >&nbsp;prsname &nbsp;| prsnamespace | &nbsp;prsstart &nbsp; | &nbsp; &nbsp;prstoken &nbsp; &nbsp; | &nbsp;prsend &nbsp; | &nbsp;prsheadline &nbsp;| &nbsp;prslextype &nbsp;&nbsp;</font></div><div><font size="2"   >----------+--------------+-------------+-----------------+-----------+---------------+---------------</font></div><div><font size="2"   >&nbsp;default &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 11 | prsd_start &nbsp;| prsd_nexttoken &nbsp;| prsd_end &nbsp;| prsd_headline | prsd_lextype</font></div><div><font size="2"   >&nbsp;zhparser | &nbsp; &nbsp; &nbsp; &nbsp; 2200 | zhprs_start | zhprs_getlexeme | zhprs_end | prsd_headline | zhprs_lextype</font></div><div><font size="2"   >(2 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >mediawiki=# CREATE TEXT SEARCH CONFIGURATION testzhcfg (PARSER = zhparser);</font></div><div><font size="2"   >CREATE TEXT SEARCH CONFIGURATION</font></div><div><font size="2"   >mediawiki=# select * from pg_ts_config where cfgname='testzhcfg';</font></div><div><font size="2"   >&nbsp; cfgname &nbsp;| cfgnamespace | cfgowner | cfgparser&nbsp;</font></div><div><font size="2"   >-----------+--------------+----------+-----------</font></div><div><font size="2"   >&nbsp;testzhcfg | &nbsp; &nbsp; &nbsp; &nbsp; 2200 | &nbsp; &nbsp; &nbsp; 10 | &nbsp; &nbsp; 37586</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><div><br></div><div>配置token type, 参考&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/textsearch-parsers.html"   >http://www.postgresql.org/docs/9.3/static/textsearch-parsers.html</a></div><div><br></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >mediawiki=# ALTER TEXT SEARCH CONFIGURATION testzhcfg ADD MAPPING FOR n,v,a,i,e,l WITH simple;</font></div><div><font size="2"   >ALTER TEXT SEARCH CONFIGURATION</font></div><div><font size="2"   >mediawiki=# select * from pg_ts_config_map where mapcfg=(select oid from pg_ts_config where cfgname='testzhcfg');</font></div><div><font size="2"   >&nbsp;mapcfg | maptokentype | mapseqno | mapdict&nbsp;</font></div><div><font size="2"   >--------+--------------+----------+---------</font></div><div><font size="2"   >&nbsp; 37587 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;110 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;3765</font></div><div><font size="2"   >&nbsp; 37587 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;118 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;3765</font></div><div><font size="2"   >&nbsp; 37587 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 97 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;3765</font></div><div><font size="2"   >&nbsp; 37587 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;105 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;3765</font></div><div><font size="2"   >&nbsp; 37587 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;101 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;3765</font></div><div><font size="2"   >&nbsp; 37587 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;108 | &nbsp; &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp;3765</font></div><div><font size="2"   >(6 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >mediawiki=# SELECT * FROM ts_parse('zhparser', 'hello world! 2010年保障房建设在全国范围内获全面启动，从中央到地方纷纷加大 了 保 障 &nbsp;房 的 建 设 和 投 入 力 度 。2011年，保障房进入了更大规模的建设阶段。住房城乡建设部党组书记、部长姜伟新去年底在全国住房城乡建设工作 会议上表示，要继续推进保障性安居工程建设。');</font></div><div><font size="2"   >&nbsp;tokid | &nbsp;token &nbsp;&nbsp;</font></div><div><font size="2"   >-------+----------</font></div><div><font size="2"   >&nbsp; &nbsp;101 | hello</font></div><div><font size="2"   >&nbsp; &nbsp;101 | world</font></div><div><font size="2"   >&nbsp; &nbsp;117 | !</font></div><div><font size="2"   >&nbsp; &nbsp;101 | 2010</font></div><div><font size="2"   >&nbsp; &nbsp;113 | 年</font></div><div><font size="2"   >&nbsp; &nbsp;118 | 保障</font></div><div><font size="2"   >&nbsp; &nbsp;110 | 房建</font></div><div><font size="2"   >&nbsp; &nbsp;118 | 设在</font></div><div><font size="2"   >&nbsp; &nbsp;110 | 全国</font></div><div><font size="2"   >&nbsp; &nbsp;110 | 范围</font></div><div><font size="2"   >&nbsp; &nbsp;102 | 内</font></div><div><font size="2"   >&nbsp; &nbsp;118 | 获</font></div><div><font size="2"   >&nbsp; &nbsp; 97 | 全面</font></div><div><font size="2"   >&nbsp; &nbsp;118 | 启动</font></div><div><font size="2"   >&nbsp; &nbsp;117 | ，</font></div><div><font size="2"   >&nbsp; &nbsp;110 | 从中</font></div><div><font size="2"   >&nbsp; &nbsp;118 | 央</font></div><div><font size="2"   >&nbsp; &nbsp;118 | 到</font></div><div><font size="2"   >&nbsp; &nbsp;110 | 地方</font></div><div><font size="2"   >&nbsp; &nbsp;100 | 纷纷</font></div><div><font size="2"   >&nbsp; &nbsp;118 | 加大</font></div><div><font size="2"   >&nbsp; &nbsp;118 | 了</font></div><div><font size="2"   >&nbsp; &nbsp;118 | 保</font></div><div><font size="2"   >&nbsp; &nbsp;110 | 障</font></div><div><font size="2"   >&nbsp; &nbsp;110 | 房</font></div><div><font size="2"   >&nbsp; &nbsp;117 | 的</font></div><div><font size="2"   >&nbsp; &nbsp;118 | 建</font></div><div><font size="2"   >&nbsp; &nbsp;118 | 设</font></div><div><font size="2"   >&nbsp; &nbsp; 99 | 和</font></div><div><font size="2"   >&nbsp; &nbsp;118 | 投</font></div><div><font size="2"   >&nbsp; &nbsp;118 | 入</font></div><div><font size="2"   >&nbsp; &nbsp;110 | 力</font></div><div><font size="2"   >&nbsp; &nbsp;107 | 度</font></div><div><font size="2"   >&nbsp; &nbsp;117 | 。</font></div><div><font size="2"   >&nbsp; &nbsp;101 | 2011</font></div><div><font size="2"   >&nbsp; &nbsp;113 | 年</font></div><div><font size="2"   >&nbsp; &nbsp;117 | ，</font></div><div><font size="2"   >&nbsp; &nbsp;118 | 保障</font></div><div><font size="2"   >&nbsp; &nbsp;110 | 房</font></div><div><font size="2"   >&nbsp; &nbsp;118 | 进入</font></div><div><font size="2"   >&nbsp; &nbsp;118 | 了</font></div><div><font size="2"   >&nbsp; &nbsp;100 | 更</font></div><div><font size="2"   >&nbsp; &nbsp;110 | 大规模</font></div><div><font size="2"   >&nbsp; &nbsp;117 | 的</font></div><div><font size="2"   >&nbsp; &nbsp;118 | 建设</font></div><div><font size="2"   >&nbsp; &nbsp;110 | 阶段</font></div><div><font size="2"   >&nbsp; &nbsp;117 | 。</font></div><div><font size="2"   >&nbsp; &nbsp;110 | 住房</font></div><div><font size="2"   >&nbsp; &nbsp;110 | 城乡建设</font></div><div><font size="2"   >&nbsp; &nbsp;110 | 部党组</font></div><div><font size="2"   >&nbsp; &nbsp;110 | 书记</font></div><div><font size="2"   >&nbsp; &nbsp;117 | 、</font></div><div><font size="2"   >&nbsp; &nbsp;110 | 部长</font></div><div><font size="2"   >&nbsp; &nbsp;110 | 姜伟新</font></div><div><font size="2"   >&nbsp; &nbsp;116 | 去年底</font></div><div><font size="2"   >&nbsp; &nbsp;112 | 在</font></div><div><font size="2"   >&nbsp; &nbsp;110 | 全国</font></div><div><font size="2"   >&nbsp; &nbsp;110 | 住房</font></div><div><font size="2"   >&nbsp; &nbsp;110 | 城乡建设</font></div><div><font size="2"   >&nbsp; &nbsp;118 | 工作</font></div><div><font size="2"   >&nbsp; &nbsp;110 | 会议</font></div><div><font size="2"   >&nbsp; &nbsp;110 | 上表</font></div><div><font size="2"   >&nbsp; &nbsp;118 | 示</font></div><div><font size="2"   >&nbsp; &nbsp;117 | ，</font></div><div><font size="2"   >&nbsp; &nbsp;118 | 要</font></div><div><font size="2"   >&nbsp; &nbsp;118 | 继续</font></div><div><font size="2"   >&nbsp; &nbsp;118 | 推进</font></div><div><font size="2"   >&nbsp; &nbsp;110 | 保障性</font></div><div><font size="2"   >&nbsp; &nbsp;118 | 安居</font></div><div><font size="2"   >&nbsp; &nbsp;110 | 工程建设</font></div><div><font size="2"   >&nbsp; &nbsp;117 | 。</font></div><div><font size="2"   >(71 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >mediawiki=# SELECT to_tsvector('testzhcfg','“今年保障房新开工数量虽然有所下调，但实际的年度在建规模以及竣工规模会超以往年份，相对应的对资金的需求也会创历史纪录。”陈国强说。在他看来，与2011年相比，2012年的保障房建设在资金配套上的压力将更为严峻。');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; to_tsvector &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >---------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;'2011':27 '2012':29 '上':35 '下调':7 '严峻':37 '会':14 '会创':20 '保障':1,30 '历史':21 '压力':36 '国强':24 '在建':10 '实际':8 '对应</font></div><div><font size="2"   >':17 '年份':16 '年度':9 '开工':4 '房':2 '房建':31 '数量':5 '新':3 '有所':6 '相比':28 '看来':26 '竣工':12 '纪录':22 '规模':11,13 '设</font></div><div><font size="2"   >':32 '说':25 '资金':18,33 '超':15 '配套':34 '陈':23 '需求':19</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >mediawiki=# SELECT to_tsquery('testzhcfg', '保障房资金压力');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;to_tsquery &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------------------------------</font></div><div><font size="2"   >&nbsp;'保障' &amp; '房' &amp; '资金' &amp; '压力'</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>设置mediawiki数据库的默认分词为中文分词.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# alter database mediawiki set default_text_search_config='testzhcfg';</font></div><div></div><p></p></pre></div></div><div><br></div><div>配置nginx, 参考&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://wiki.nginx.org/MediaWiki"   >http://wiki.nginx.org/MediaWiki</a></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-150 zhparser]# cd /etc/nginx/conf.d</font></div><div><font size="2"   >[root@db-172-16-3-150 conf.d]# cp default.conf default.conf.bak</font></div><div><font size="2"   >[root@db-172-16-3-150 conf.d]# vi default.conf</font></div></div><div><div><font size="2"   >server {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; server_name digoal;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; root /opt/site/mediawiki; &nbsp; &nbsp;## &lt;-- Your only path reference.</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; # Enable compression, this will help if you have for instance advagg? module</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; # by serving Gzip versions of the files.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; gzip_static on;</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; location = /favicon.ico {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log_not_found off;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; access_log off;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; location = /robots.txt {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; allow all;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log_not_found off;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; access_log off;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; # This matters if you use drush prior to 5.x</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; # After 5.x backups are stored outside the Drupal install.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; #location = /backup {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; &nbsp; &nbsp; &nbsp;deny all;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; #}</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; # Very rarely should these ever be accessed outside of your lan</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; location ~* \.(txt|log)$ {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; allow 172.16.0.0/16;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; deny all;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; location ~ \..*/.*\.php$ {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return 403;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; # No no for private</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; location ~ ^/sites/.*/private/ {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return 403;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; # Block access to "hidden" files and directories whose names begin with a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; # period. This includes directories used by version control systems such</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; # as Subversion or Git to store control files.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; location ~ (^|/)\. {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return 403;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; location / {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # This is cool because no php is touched for static content</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; try_files $uri @rewrite;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; location @rewrite {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # You have 2 options here</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # For D7 and above:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Clean URLs are handled in drupal_environment_initialize().</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rewrite ^ /index.php;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # For Drupal 6 and bwlow:</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Some modules enforce no slash (/) at the end of the URL</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # Else this rewrite block wouldn't be needed (GlobalRedirect)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #rewrite ^/(.*)$ /index.php?q=$1;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; location ~ \.php$ {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; root&nbsp;<span style="line-height: 28px;"   >/opt/site/mediawiki</span>;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; include /etc/nginx/fastcgi_params;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fastcgi_pass &nbsp; 127.0.0.1:9000;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fastcgi_index &nbsp;index.php;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fastcgi_param SCRIPT_FILENAME &nbsp;$document_root$fastcgi_script_name;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; # Fighting with Styles? This little gem is amazing.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; # This is for D6</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; #location ~ ^/sites/.*/files/imagecache/ {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; # This is for D7 and D8</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; location ~ ^/sites/.*/files/styles/ {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; try_files $uri @rewrite;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; location ~* \.(js|css|png|jpg|jpeg|gif|ico)$ {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; expires max;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log_not_found off;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >}</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@db-172-16-3-150 conf.d]# service nginx restart</font></div><div><font size="2"   >Stopping nginx: [ &nbsp;OK &nbsp;]</font></div><div><font size="2"   >Starting nginx: [ &nbsp;OK &nbsp;]</font></div></div><p></p></pre></div><div><br></div><div><br></div><div>配置mediawiki</div><div>http://172.16.3.150/mw-config/index.php</div><div><br></div><div><div><img title="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   alt="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img2.ph.126.net/f3K7gQJVLKWgueOv_deUww==/4906953269097105635.png"   ></div>&nbsp;<div><img title="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   alt="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img2.ph.126.net/4Nyvkg1XoHX4xs-MlVy5EA==/2072218778644075727.png"   ></div></div><div><br></div><div>解决对象缓存的问题, 安装php-apc.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 conf.d]# yum install -y php-apc</font></div><div><div style="line-height: 28px;"   ><font size="2"   >[root@db-172-16-3-150 conf.d]# service php-fpm restart</font></div><div style="line-height: 28px;"   ><font size="2"   >Stopping php-fpm: [ &nbsp;OK &nbsp;]</font></div><div style="line-height: 28px;"   ><font size="2"   >Starting php-fpm: [ &nbsp;OK &nbsp;]</font></div></div><p></p></pre></div><div><br></div><div>解决PCRE_UTF8的问题.</div><div>这个报错来自&nbsp;/opt/site/mediawiki/includes/installer/Installer.php</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; protected function envCheckPCRE() {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wfSuppressWarnings();</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $regexd = preg_replace( '/[\x{0430}-\x{04FF}]/iu', '', '-АБВГД-' );</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // Need to check for \p support too, as PCRE can be compiled</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // with utf8 support, but not unicode property support.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // check that \p{Zs} (space separators) matches</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // U+3000 (Ideographic space)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $regexprop = preg_replace( '/\p{Zs}/u', '', "-\xE3\x80\x80-" );</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wfRestoreWarnings();</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ( $regexd != '--' || $regexprop != '--' ) {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $this-&gt;showError( 'config-pcre-no-utf8' );</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return false;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return true;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><p></p></pre></div><div>把这一段拷贝到一个脚本里面执行</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   ># vi test.php</font></div><div><font size="2"   >&lt;?php</font></div><div><font size="2"   >$regexd = preg_replace( '/[\x{0430}-\x{04FF}]/iu', '', '-АБВГД-' );</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // Need to check for \p support too, as PCRE can be compiled</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // with utf8 support, but not unicode property support.</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // check that \p{Zs} (space separators) matches</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // U+3000 (Ideographic space)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $regexprop = preg_replace( '/\p{Zs}/u', '', "-\xE3\x80\x80-" );</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >var_dump($regexd);</font></div><div><font size="2"   >var_dump($regexprop);</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   ># /usr/bin/php ./test.php</font></div><div><font size="2"   >string(7) "-?????-"</font></div><div><font size="2"   >string(2) "--"</font></div></div><p></p></pre></div><div>确实, RPM安装的php有问题.</div><div>因为pcre已经打包到php-common, 并没有使用服务器安装的pcre包.</div><div>例如系统安装的pcre带了utf8选项. 版本是7.8</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@db-172-16-3-150 etc]# which pcretest</font></div><div><font size="2"   >/usr/bin/pcretest</font></div><div><font size="2"   >[root@db-172-16-3-150 etc]# pcretest -C</font></div><div><font size="2"   >PCRE version 7.8 2008-09-05</font></div><div><font size="2"   >Compiled with</font></div><div><font size="2"   >&nbsp; UTF-8 support</font></div><div><font size="2"   >&nbsp; Unicode properties support</font></div><div><font size="2"   >&nbsp; Newline sequence is LF</font></div><div><font size="2"   >&nbsp; \R matches all Unicode newlines</font></div><div><font size="2"   >&nbsp; Internal link size = 2</font></div><div><font size="2"   >&nbsp; POSIX malloc threshold = 10</font></div><div><font size="2"   >&nbsp; Default match limit = 10000000</font></div><div><font size="2"   >&nbsp; Default recursion depth limit = 10000000</font></div><div><font size="2"   >&nbsp; Match recursion uses stack</font></div><div><font size="2"   >[root@db-172-16-3-150 etc]# rpm -qf /usr/bin/pcretest</font></div><div><font size="2"   >pcre-7.8-6.el6.x86_64</font></div></div><div><font size="2"   >但是php安装的是8.3的pcre, 显然没有使用系统的7.8版本.</font></div><div><font size="2"   ># php -i</font></div><div><div><font size="2"   >pcre</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >PCRE (Perl Compatible Regular Expressions) Support =&gt; enabled</font></div><div><font size="2"   >PCRE Library Version =&gt; 8.32 2012-11-30</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Directive =&gt; Local Value =&gt; Master Value</font></div><div><font size="2"   >pcre.backtrack_limit =&gt; 100000 =&gt; 100000</font></div><div><font size="2"   >pcre.recursion_limit =&gt; 100000 =&gt; 100000</font></div></div><p></p></pre></div><div><br></div><div>解决办法是自行编译安装php, 并且指定pcre库.</div><div><a target="_blank" rel="nofollow" href="http://cn2.php.net/manual/en/pcre.installation.php"   >http://cn2.php.net/manual/en/pcre.installation.php</a></div><div>The PCRE extension is a core PHP extension, so it is always enabled. By default, this extension is compiled using the bundled PCRE library. Alternatively, an external PCRE library can be used by passing in the --with-pcre-regex=DIR configuration option where DIR is the location of PCRE's include and library files.</div><div><br></div><div>安装php</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >wget http://cn2.php.net/distributions/php-5.5.14.tar.bz2</font></div><div><font size="2"   >tar -jxvf php-5.5.14.tar.bz2</font></div><div><font size="2"   >cd php-5.5.14</font></div></div><div><font size="2"   >指定pcre库和pcre.h</font></div><div><div><font size="2"   ># rpm -ql pcre-devel</font></div><div><font size="2"   >/usr/bin/pcre-config</font></div><div><font size="2"   >/usr/include/pcre.h</font></div><div><font size="2"   >/usr/include/pcre_scanner.h</font></div><div><font size="2"   >/usr/include/pcre_stringpiece.h</font></div><div><font size="2"   >/usr/include/pcrecpp.h</font></div><div><font size="2"   >/usr/include/pcrecpparg.h</font></div><div><font size="2"   >/usr/include/pcreposix.h</font></div><div><font size="2"   >/usr/lib64/libpcre.so</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   ># cp&nbsp;<span style="line-height: 28px;"   >/usr/include/pcre.h&nbsp;</span><span style="line-height: 28px;"   >/usr/lib64</span></font></div><div><font size="2"   ># ./configure --with-pcre-regex=/usr/lib64 --enable-fpm --enable-opcache --with-pdo-pgsql=/home/pg93/pgsql/bin --with-pgsql=/home/pg93/pgsql/bin</font></div><div><font size="2"   ># make &amp;&amp; make install</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >/bin/sh /root/php-5.5.14/libtool --silent --preserve-dup-deps --mode=install cp ext/opcache/opcache.la /root/php-5.5.14/modules</font></div><div><font size="2"   >Installing shared extensions: &nbsp; &nbsp; /usr/local/lib/php/extensions/no-debug-non-zts-20121212/</font></div><div><font size="2"   >Installing PHP CLI binary: &nbsp; &nbsp; &nbsp; &nbsp;/usr/local/bin/</font></div><div><font size="2"   >Installing PHP CLI man page: &nbsp; &nbsp; &nbsp;/usr/local/php/man/man1/</font></div><div><font size="2"   >Installing PHP FPM binary: &nbsp; &nbsp; &nbsp; &nbsp;/usr/local/sbin/</font></div><div><font size="2"   >Installing PHP FPM config: &nbsp; &nbsp; &nbsp; &nbsp;/usr/local/etc/</font></div><div><font size="2"   >Installing PHP FPM man page: &nbsp; &nbsp; &nbsp;/usr/local/php/man/man8/</font></div><div><font size="2"   >Installing PHP FPM status page: &nbsp; &nbsp; &nbsp;/usr/local/php/fpm/</font></div><div><font size="2"   >Installing PHP CGI binary: &nbsp; &nbsp; &nbsp; &nbsp;/usr/local/bin/</font></div><div><font size="2"   >Installing PHP CGI man page: &nbsp; &nbsp; &nbsp;/usr/local/php/man/man1/</font></div><div><font size="2"   >Installing build environment: &nbsp; &nbsp; /usr/local/lib/php/build/</font></div><div><font size="2"   >Installing header files: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/usr/local/include/php/</font></div><div><font size="2"   >Installing helper programs: &nbsp; &nbsp; &nbsp; /usr/local/bin/</font></div><div><font size="2"   >&nbsp; program: phpize</font></div><div><font size="2"   >&nbsp; program: php-config</font></div><div><font size="2"   >Installing man pages: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /usr/local/php/man/man1/</font></div><div><font size="2"   >&nbsp; page: phpize.1</font></div><div><font size="2"   >&nbsp; page: php-config.1</font></div><div><font size="2"   >Installing PEAR environment: &nbsp; &nbsp; &nbsp;/usr/local/lib/php/</font></div><div><font size="2"   >[PEAR] Archive_Tar &nbsp; &nbsp;- already installed: 1.3.11</font></div><div><font size="2"   >[PEAR] Console_Getopt - already installed: 1.3.1</font></div><div><font size="2"   >[PEAR] PEAR &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; - already installed: 1.9.4</font></div><div><font size="2"   >Wrote PEAR system config file at: /usr/local/etc/pear.conf</font></div><div><font size="2"   >You may want to add: /usr/local/lib/php to your php.ini include_path</font></div><div><font size="2"   >[PEAR] Structures_Graph- already installed: 1.0.4</font></div><div><font size="2"   >[PEAR] XML_Util &nbsp; &nbsp; &nbsp; - already installed: 1.2.1</font></div><div><font size="2"   >/root/php-5.5.14/build/shtool install -c ext/phar/phar.phar /usr/local/bin</font></div><div><font size="2"   >ln -s -f /usr/local/bin/phar.phar /usr/local/bin/phar</font></div><div><font size="2"   >Installing PDO headers: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/usr/local/include/php/ext/pdo/</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   ># cp /root/php-5.5.14/php.ini-production /usr/local/lib/php.ini</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   ># php --ini</font></div><div><font size="2"   >Configuration File (php.ini) Path: /usr/local/lib</font></div><div><font size="2"   >Loaded Configuration File: &nbsp; &nbsp; &nbsp; &nbsp; /usr/local/lib/php.ini</font></div><div><font size="2"   >Scan for additional .ini files in: (none)</font></div><div><font size="2"   >Additional .ini files parsed: &nbsp; &nbsp; &nbsp;(none)</font></div></div><p></p></pre></div><div><br></div><div>配置php-fpm</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># cp /usr/local/etc/php-fpm.conf.default /usr/local/etc/php-fpm.conf</font></div><div><font size="2"   ># service php-fpm stop</font></div><div><font size="2"   ># chkconfig php-fpm off</font></div><p></p></pre></div><div># 使用新装的php-fpm启动</div><pre class="prettyprint"   ><p></p><div><div><font size="2"   ># /usr/local/sbin/php-fpm -R -y /usr/local/etc/php-fpm.conf</font></div></div><div><div></div></div><p></p></pre><div><br></div><div><img title="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   alt="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   src="http://img2.ph.126.net/eo54CGLLbpVizk_yhz0hBA==/3668181896593776218.png"   style="line-height: 28px; margin: 0px 10px 0px 0px;"   ></div></div><div>因为自行编译了php, 所以警告需要另外安装apc和intl.</div><div>对应的包是 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >php-pecl-apc-3.1.15-0.4.20130912.el6.remi.5.4.x86_64</font></div><div><font size="2"   >php-intl-5.4.30-1.el6.remi.x86_64</font></div><p></p></pre></div><div>安装参考 :&nbsp;</div><div><a target="_blank" rel="nofollow" href="http://cn2.php.net/manual/en/apc.installation.php"   >http://cn2.php.net/manual/en/apc.installation.php</a></div><div><pre class="prettyprint"   ><div><font size="2"   ># pecl install intl</font></div><div><font size="2"   >如果遇到这个错误, 需要安装libicu-devel libicu.&nbsp;</font></div><div><font size="2"   >configure: error: Unable to detect ICU prefix or no failed. Please verify ICU install prefix and make sure icu-config works.</font></div><div><span style="line-height: 28px;"   ><font size="2"   >最好安装最新的.不要使用yum安装.</font></span></div><div><font size="2"   >wget http://download.icu-project.org/files/icu4c/53.1/icu4c-53_1-src.tgz</font></div><div><font size="2"   >tar -zxvf&nbsp;<span style="line-height: 28px;"   >icu4c-53_1-src.tgz</span></font></div><div><font size="2"   ><span style="line-height: 28px;"   >cd&nbsp;</span><span style="line-height: 28px;"   >icu/source</span></font></div><div><font size="2"   ># ./configure --enable-shared</font></div><div><font size="2"   ># make &amp;&amp; make install</font></div><div><div><font size="2"   >[root@db-172-16-3-150 local]# icu-config --version</font></div><div><font size="2"   >53.1</font></div><div><font size="2"   >[root@db-172-16-3-150 local]# which icu-config</font></div><div><font size="2"   >/usr/local/bin/icu-config</font></div></div><div><font size="2"   >安装intl</font></div><div><span style="line-height: 28px;"   ><font size="2"   ># pecl install intl</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >...</font></span></div><div><div><font size="2"   >Build process completed successfully</font></div><div><font size="2"   >Installing '/usr/local/lib/php/extensions/no-debug-non-zts-20121212/intl.so'</font></div><div><font size="2"   >install ok: channel://pecl.php.net/intl-3.0.0</font></div><div><font size="2"   >configuration option "php_ini" is not set to php.ini location</font></div><div><font size="2"   >You should add "extension=intl.so" to php.ini</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >配置 intl.</font></div><div><div><font size="2"   >[root@db-172-16-3-150 php-5.5.14]# echo "extension=intl.so" &gt;&gt;/usr/local/lib/php.ini&nbsp;</font></div><div><font size="2"   >[root@db-172-16-3-150 php-5.5.14]# ps -ewf|grep fpm</font></div><div><font size="2"   >root &nbsp; &nbsp; &nbsp;8963 &nbsp; &nbsp; 1 &nbsp;0 15:47 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 php-fpm: master process (/usr/local/etc/php-fpm.conf)</font></div><div><font size="2"   >nobody &nbsp; &nbsp;8964 &nbsp;8963 &nbsp;0 15:47 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 php-fpm: pool www &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >nobody &nbsp; &nbsp;8965 &nbsp;8963 &nbsp;0 15:47 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 php-fpm: pool www &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >root &nbsp; &nbsp; 12112 &nbsp;8977 &nbsp;0 16:07 pts/1 &nbsp; &nbsp;00:00:00 grep fpm</font></div><div><font size="2"   >[root@db-172-16-3-150 php-5.5.14]# kill 8963</font></div><div><font size="2"   >[root@db-172-16-3-150 php-5.5.14]# php-fpm -R -y /usr/local/etc/php-fpm.conf</font></div></div><p></p></pre></div><div><br></div><div>现在就差apc模块了, 但是好像有BUG. 无法安装.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># pecl install apc</font></div><div><div><font size="2"   >/tmp/pear/temp/APC/apc_compile.c: In function ‘my_copy_class_entry’:</font></div><div><font size="2"   >/tmp/pear/temp/APC/apc_compile.c:755: warning: assignment from incompatible pointer type</font></div><div><font size="2"   >/tmp/pear/temp/APC/apc_compile.c: In function ‘apc_copy_class_entry_for_execution’:</font></div><div><font size="2"   >/tmp/pear/temp/APC/apc_compile.c:1956: warning: assignment from incompatible pointer type</font></div><div><font size="2"   >/tmp/pear/temp/APC/apc_compile.c: In function ‘apc_copy_trait_alias’:</font></div><div><font size="2"   >/tmp/pear/temp/APC/apc_compile.c:2379: error: ‘zend_trait_alias’ has no member named ‘function’</font></div><div><font size="2"   >/tmp/pear/temp/APC/apc_compile.c:2380: error: ‘zend_trait_alias’ has no member named ‘function’</font></div><div><font size="2"   >/tmp/pear/temp/APC/apc_compile.c:2380: error: ‘zend_trait_alias’ has no member named ‘function’</font></div><div><font size="2"   >/tmp/pear/temp/APC/apc_compile.c: In function ‘apc_copy_trait_precedence’:</font></div><div><font size="2"   >/tmp/pear/temp/APC/apc_compile.c:2416: error: ‘zend_trait_precedence’ has no member named ‘function’</font></div><div><font size="2"   >/tmp/pear/temp/APC/apc_compile.c:2417: error: ‘zend_trait_precedence’ has no member named ‘function’</font></div><div><font size="2"   >/tmp/pear/temp/APC/apc_compile.c:2417: error: ‘zend_trait_precedence’ has no member named ‘function’</font></div><div><font size="2"   >make: *** [apc_compile.lo] Error 1</font></div><div><font size="2"   >ERROR: `make' failed</font></div></div><p></p></pre></div><div><br></div><div><div><img title="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   alt="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/Bf2AZa8pGzlPRE8FXLKn7g==/3674655821058121143.png"   ></div>配置数据库连接</div><div><div><img title="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   alt="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img2.ph.126.net/N8FnDXw2hALt48mHnjo3oA==/1337006139476018687.png"   ></div><span style="line-height: 28px;"   >配置网页数据库账号</span><br><div><img title="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   alt="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img1.ph.126.net/H9PCbnRjGirYxY5B_Yov9Q==/2858659863574327534.png"   ></div>配置账号</div><div><div><img title="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   alt="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img1.ph.126.net/uDiGehqToth33H_0PSQTcQ==/2849934139296282430.png"   ></div>&nbsp;<div><img title="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   alt="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img1.ph.126.net/uMeR86KpRapXXUSBF1bbKg==/2674293753828335527.png"   ></div>配置wiki.</div><div><div><img title="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   alt="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img1.ph.126.net/iFynpFTyA7BmgA80mL8WEw==/6608434318841035735.png"   ></div>&nbsp;<div><img title="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   alt="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/FHNy0iAts6iTAjXhzRCSGQ==/2982227378349684519.png"   ></div>&nbsp;<div><img title="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   alt="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/-PZkpPcvZh6TiJvwOr7uEA==/6608919203468886000.png"   ></div>&nbsp;<div><img title="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   alt="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img1.ph.126.net/9e9q0Wlvb-D78F4TqgwoAA==/6608935696143304804.png"   ></div>&nbsp;<div><img title="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   alt="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/Iz1LtWMw75N8kA-qGrRzFg==/6608844436678196274.png"   ></div><br></div><div>修改images的权限.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 mediawiki]# cd /opt/site/mediawiki/</font></div><div><font size="2"   >[root@db-172-16-3-150 mediawiki]# chmod -R 777 images</font></div><p></p></pre></div><div><br></div><div><div><img title="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   alt="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img2.ph.126.net/oGSdSFfA9E5fXrQLfkTa5w==/6608462906143358381.png"   ></div>&nbsp;<div><img title="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   alt="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img1.ph.126.net/QkokxDkHCdIBeWup124oPw==/6608741082585185632.png"   ></div></div><div>这个警告, 需要配置一下php.ini.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># vi /usr/local/lib/php.ini</font></div><div><font size="2"   >allow_url_fopen = On</font></div><div><div><font size="2"   >[root@db-172-16-3-150 images]# ps -ewf|grep fpm</font></div><div><font size="2"   >root &nbsp; &nbsp; &nbsp;3912 &nbsp; &nbsp; 1 &nbsp;0 16:48 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 php-fpm: master process (/usr/local/etc/php-fpm.conf)</font></div><div><font size="2"   >nobody &nbsp; &nbsp;3913 &nbsp;3912 &nbsp;0 16:48 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:04 php-fpm: pool www &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >nobody &nbsp; &nbsp;3914 &nbsp;3912 &nbsp;0 16:48 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:04 php-fpm: pool www &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >root &nbsp; &nbsp; &nbsp;4392 &nbsp;8977 &nbsp;0 17:05 pts/1 &nbsp; &nbsp;00:00:00 grep fpm</font></div><div><font size="2"   >[root@db-172-16-3-150 images]# kill 3912</font></div><div><font size="2"   >[root@db-172-16-3-150 images]# php-fpm -R -y /usr/local/etc/php-fpm.conf</font></div></div><div><font size="2"   >继续</font></div><p></p></pre></div><div><div><br></div><div><img title="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   alt="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img1.ph.126.net/ZERlaczQ3_hacgTWNV-HHQ==/6608732286492162547.png"   ></div>下载这个文件LocalSettings.php, 并放到/opt/site/mediawiki/</div><div>然后就可以点击"进入您的wiki了"</div><div><div><img title="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   alt="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   style="margin: 0px 10px 0px 0px; width: 750px; height: auto;"   src="http://img2.ph.126.net/fy-_gZ_tQvcLbf-ugtWcTA==/6608471702236380632.png"   ></div></div><div><br></div><div>[其他]</div><div>1. 数据库在这里使用了短连接, 所以我们可以使用pgbouncer来作为连接池.</div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.mediawiki.org/wiki/MediaWiki"   >http://www.mediawiki.org/wiki/MediaWiki</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.mediawiki.org/wiki/Download"   >http://www.mediawiki.org/wiki/Download</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.mediawiki.org/wiki/Installation"   >http://www.mediawiki.org/wiki/Installation</a></div><div>4.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.mediawiki.org/wiki/Manual:Installing_MediaWiki"   >http://www.mediawiki.org/wiki/Manual:Installing_MediaWiki<br></a><span style="line-height: 28px;"   >5.&nbsp;</span><a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201422410175698/"   >http://blog.163.com/digoal@126/blog/static/163877040201422410175698/</a></div><div>6.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://wiki.nginx.org/MediaWiki"   >http://wiki.nginx.org/MediaWiki</a></div><div>7.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.3/static/textsearch-parsers.html"   >http://www.postgresql.org/docs/9.3/static/textsearch-parsers.html</a></div><div>8.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.pcre.org/"   >http://www.pcre.org/</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="mediawiki, nginx, PHP, PostgreSQL on CentOS 6.4 x64 - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>