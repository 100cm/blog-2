<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">nginx http proxy exp.</h2>
	<h5 id="">2014-07-18 23:56:33&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201461885116384/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>本文演示一下nginx的http代理功能, 更多详细配置查看proxy模块reference.</div><div><br></div><div>nginx的安装参考 :&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201461822210354/"   >http://blog.163.com/digoal@126/blog/static/163877040201461822210354/</a></div><div><br></div><div>在172.16.3.150服务器上配置代理 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># cd /opt/nginx1.6.0/conf/</font></div><div><font size="2"   ># less nginx.conf</font></div><div><font size="2"   >http {</font></div><div><font size="2"   >...</font></div><div><div><font size="2"   >&nbsp; &nbsp; server {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; listen &nbsp; &nbsp; &nbsp; 80;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; server_name &nbsp;localhost default_server; &nbsp; &nbsp;# default_server表示当前http配置内, 所有server都无法匹配时的默认配置.</font></div></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # 如果没有配置default_server, 默认选择排第一的server作为默认的配置.</font></div><div><font size="2"   >...</font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; location / { &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# / 表示匹配所有URI. (不包括http://server_name:port)</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; proxy_pass http://172.16.3.67; &nbsp;# 表示代理到<span style="line-height: 28px;"   >http://172.16.3.67</span></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #root &nbsp; html;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; #index &nbsp;index.html index.htm;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div></div><div><font size="2"   >...</font></div><div><font size="2"   >&nbsp; &nbsp; }</font></div><div><font size="2"   >...</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >nginx -s reload</font></div><p></p></pre></div><div><br></div><div>例如请求<span style="line-height: 28px;"   >http://172.16.3.150将代理页面发到</span><span style="line-height: 28px;"   >http://172.16.3.67</span></div><div><span style="line-height: 28px;"   >例如, 访问代理站点</span><span style="line-height: 28px;"   >http://172.16.3.150</span><span style="line-height: 28px;"   >&nbsp;:&nbsp;</span></div><div><div><img title="nginx http proxy exp. - 德哥@Digoal - PostgreSQL research"   alt="nginx http proxy exp. - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/IKv7ttZ-dVlkOxPy0_t7pQ==/6619495405816127799.png"   ></div><div><br></div><div>直接访问主站.</div><div><img title="nginx http proxy exp. - 德哥@Digoal - PostgreSQL research"   alt="nginx http proxy exp. - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img2.ph.126.net/AtCVL9j5LcNyvh2MSsi3lg==/6619494306304500056.png"   ></div>&nbsp;</div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >使用tcpdump可以跟踪到http代理服务器172.16.3.150和后端的web server 172.16.3.67的数据流.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# tcpdump -i em1|grep 172.16.3.67</font></div><div><font size="2"   >tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</font></div><div><font size="2"   >listening on em1, link-type EN10MB (Ethernet), capture size 65535 bytes</font></div><div><font size="2"   >23:43:57.434669 IP db-172-16-3-150.sky-mobi.com.36179 &gt; 172.16.3.67.http: Flags [S], seq 3777998277, win 14600, options [mss 1460,nop,nop,sackOK,nop,wscale 7], length 0</font></div><div><font size="2"   >23:43:57.434955 IP 172.16.3.67.http &gt; db-172-16-3-150.sky-mobi.com.36179: Flags [S.], seq 3245637592, ack 3777998278, win 14600, options [mss 1460,nop,nop,sackOK,nop,wscale 7], length 0</font></div><div><font size="2"   >23:43:57.434979 IP db-172-16-3-150.sky-mobi.com.36179 &gt; 172.16.3.67.http: Flags [.], ack 1, win 115, length 0</font></div><div><font size="2"   >23:43:57.435011 IP db-172-16-3-150.sky-mobi.com.36179 &gt; 172.16.3.67.http: Flags [P.], seq 1:707, ack 1, win 115, length 706</font></div><div><font size="2"   >23:43:57.435241 IP 172.16.3.67.http &gt; db-172-16-3-150.sky-mobi.com.36179: Flags [.], ack 707, win 126, length 0</font></div><div><font size="2"   >23:43:57.651972 IP 172.16.3.67.http &gt; db-172-16-3-150.sky-mobi.com.36179: Flags [P.], seq 1:335, ack 707, win 126, length 334</font></div><div><font size="2"   >23:43:57.651994 IP db-172-16-3-150.sky-mobi.com.36179 &gt; 172.16.3.67.http: Flags [.], ack 335, win 123, length 0</font></div><div><font size="2"   >23:43:57.652043 IP 172.16.3.67.http &gt; db-172-16-3-150.sky-mobi.com.36179: Flags [F.], seq 335, ack 707, win 126, length 0</font></div><div><font size="2"   >23:43:57.652078 IP db-172-16-3-150.sky-mobi.com.36179 &gt; 172.16.3.67.http: Flags [F.], seq 707, ack 336, win 123, length 0</font></div><div><font size="2"   >23:43:57.652340 IP 172.16.3.67.http &gt; db-172-16-3-150.sky-mobi.com.36179: Flags [.], ack 708, win 126, length 0</font></div><div><font size="2"   >23:44:29.255686 IP db-172-16-3-150.sky-mobi.com.36182 &gt; 172.16.3.67.http: Flags [S], seq 499805544, win 14600, options [mss 1460,nop,nop,sackOK,nop,wscale 7], length 0</font></div><div><font size="2"   >23:44:29.255968 IP 172.16.3.67.http &gt; db-172-16-3-150.sky-mobi.com.36182: Flags [S.], seq 2904580936, ack 499805545, win 14600, options [mss 1460,nop,nop,sackOK,nop,wscale 7], length 0</font></div><div><font size="2"   >23:44:29.255996 IP db-172-16-3-150.sky-mobi.com.36182 &gt; 172.16.3.67.http: Flags [.], ack 1, win 115, length 0</font></div><div><font size="2"   >23:44:29.256032 IP db-172-16-3-150.sky-mobi.com.36182 &gt; 172.16.3.67.http: Flags [P.], seq 1:752, ack 1, win 115, length 751</font></div><div><font size="2"   >23:44:29.256274 IP 172.16.3.67.http &gt; db-172-16-3-150.sky-mobi.com.36182: Flags [.], ack 752, win 126, length 0</font></div><div><font size="2"   >23:44:29.891224 IP 172.16.3.67.http &gt; db-172-16-3-150.sky-mobi.com.36182: Flags [.], seq 1:2921, ack 752, win 126, length 2920</font></div><p></p></pre></div><div><br></div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201461822210354/"   >http://blog.163.com/digoal@126/blog/static/163877040201461822210354/</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://nginx.com/resources/admin-guide/reverse-proxy/"   >http://nginx.com/resources/admin-guide/reverse-proxy/</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://nginx.org/en/docs/http/request_processing.html"   >http://nginx.org/en/docs/http/request_processing.html</a></div><div>4.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html"   >http://nginx.org/en/docs/http/ngx_http_proxy_module.html</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="nginx http proxy exp. - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>