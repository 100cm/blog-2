<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL xlog $PGDATA and zfs snapshot based central backup & PITR case</h2>
	<h5 id="">2014-07-01 15:30:31&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201451894734122/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>最近在写一个集中式的PostgreSQL基于块的增量备份的CASE.</div><div>(因Oracle有块级别增量备份, PG这块是个空白, 不过可以通过第三方软件来实现)</div><div>视频参考6月28日的杭州PG交流视频</div><div><a target="_blank" rel="nofollow" href="http://pan.baidu.com/share/home?uk=1982970774#category/type=0"   >http://pan.baidu.com/share/home?uk=1982970774#category/type=0</a></div><div><br></div><div>方案参考</div><div><a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201451711013770/"   >http://blog.163.com/digoal@126/blog/static/163877040201451711013770/</a></div><div>本文将写一下实际的操作和优化点.</div><div>集中备份主机环境 :&nbsp;</div><div>CentOS 6.5 x64</div><div>ZFS 0.6.3</div><div>磁盘12*4TB SATA + 2*300G SAS, 其中4TB的盘使用RAW模式, 未配置RAID卡. 300G的使用RAID1</div><div>内存32G</div><div>CPU&nbsp;Intel(R) Xeon(R) CPU E5-2609 v2 @ 2.50GHz 8核</div><div>架构图 :&nbsp;</div><div><div><img title="PostgreSQL xlog PGDATA and zfs snapshot based central backup  PITR case - 德哥@Digoal - PostgreSQL"   alt="PostgreSQL xlog PGDATA and zfs snapshot based central backup  PITR case - 德哥@Digoal - PostgreSQL"   style="margin:0 10px 0 0;"   src="http://img2.ph.126.net/5rt_XEElHuaJdp8U2u-kAw==/6608895014212923824.png"   ></div></div><div><br></div><div><div style="line-height: 28px;"   >归档主机配置(本例归档主机和备机主机使用同一台主机) :&nbsp;</div><div style="line-height: 28px;"   >配置ZFS, 开启压缩, 同时注意写性能至少要和网卡带宽相当, 否则容易造成瓶颈. 一旦造成瓶颈, 可能导致主库XLOG堵塞膨胀(因为归档完成的XLOG才可以重用或被删除).</div><div><div style="line-height: 28px;"   >考虑到写居多, 所以考虑加一个性能好的ilog设备. l2arc没必要加.</div><div style="line-height: 28px;"   >zpool使用raidz1+ilog+spare的模式.</div><div style="line-height: 28px;"   >raidz1盘的数量9=2^3+1, 实际上本例使用的盘数11(当然你可以多vdev strip的模式例如12块盘分4组vdev raidz1 3+3+3+3, 可用容量为8块盘).</div><div style="line-height: 28px;"   >1个ilog因为这个设备底层使用了RAID1 的模式, 所以没有再次mirror. 如果底层是JBOD模式的话, 建议用mirror防止ilog数据损坏. 1块hot spare.</div><div style="line-height: 28px;"   >磁盘个数的选择参考&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201451725147753/"   >http://blog.163.com/digoal@126/blog/static/163877040201451725147753/</a></div><div style="line-height: 28px;"   >扇区大小选择4KB.&nbsp;</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   ># zpool create -o ashift=12 zp1 raidz1 sdb sdc sdd sde sdf sdg sdh sdi sdj sdk sdl spare sdm&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   ># zpool add zp1 log /dev/sda4</font></div><p></p></pre></div><div style="line-height: 28px;"   >配置zpool 根 zfs默认选项, 后面创建的zfs可以继承这些选项.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >zfs set compression=lz4 zp1</font></div></div><div><font size="2"   >zfs set canmount=off zp1</font></div><div><font size="2"   >zfs set atime=off zp1</font></div><p></p></pre></div></div><div style="line-height: 28px;"   ># 创建归档目录, 日志目录, PGHOME目录等.</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >zfs create -o mountpoint=<span style="line-height: 28px;"   >/pg168104 zp1/pg168104</span></font></div><div style="line-height: 28px;"   ><font size="2"   ><span style="line-height: 28px;"   >zfs create -o mountpoint=/pg_log&nbsp;</span><span style="line-height: 28px;"   >zp1/pg_log</span></font></div><div style="line-height: 28px;"   ><font size="2"   ><span style="line-height: 28px;"   >zfs create -o mountpoint=/pg_home&nbsp;</span><span style="line-height: 28px;"   >zp1/pg_home</span></font></div><div style="line-height: 28px;"   ><font size="2"   ><span style="line-height: 28px;"   >zfs create -o mountpoint=/pg_arch&nbsp;</span><span style="line-height: 28px;"   >zp1/pg_arch</span></font></div><div><div><font size="2"   >df -h</font></div><div><font size="2"   >zp1/pg168104 &nbsp; &nbsp; 35T &nbsp; 32G &nbsp; 35T &nbsp; 1% /pg168104</font></div><div><font size="2"   >zp1/pg_log &nbsp; &nbsp; &nbsp; 35T &nbsp;256K &nbsp; 35T &nbsp; 1% /pg_log</font></div><div><font size="2"   >zp1/pg_arch &nbsp; &nbsp; &nbsp;35T &nbsp;256K &nbsp; 35T &nbsp; 1% /pg_arch</font></div><div><font size="2"   >zp1/pg_home &nbsp; &nbsp; &nbsp;35T &nbsp;149M &nbsp; 35T &nbsp; 1% /pg_home</font></div></div><p></p></pre></div><div><br></div><div style="line-height: 28px;"   >配置PostgreSQL归档, 例如rsync服务端, nfs, ftp 等, 如果使用NFS注意固定一下NFS端口.</div><div style="line-height: 28px;"   >本文以NFS为例介绍归档配置.&nbsp;</div><div style="line-height: 28px;"   >配置NFS端口固定</div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   ># grep "^[A-Z]" /etc/sysconfig/nfs&nbsp;</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >RQUOTAD_PORT=875</font></div><div style="line-height: 28px;"   ><font size="2"   >LOCKD_TCPPORT=32803</font></div><div style="line-height: 28px;"   ><font size="2"   >LOCKD_UDPPORT=32769</font></div><div style="line-height: 28px;"   ><font size="2"   >MOUNTD_PORT=892</font></div><div style="line-height: 28px;"   ><font size="2"   >STATD_PORT=662</font></div><div style="line-height: 28px;"   ><font size="2"   >STATD_OUTGOING_PORT=2020</font></div><div style="line-height: 28px;"   ><font size="2"   >RDMA_PORT=20049&nbsp;</font></div></div><p></p></pre></div><div style="line-height: 28px;"   ><br></div></div><div style="line-height: 28px;"   >配置nfs目录, 每个PG集群一个目录, 存放该集群的归档文件.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># mkdir /pg_arch/pg168104</font></div><div><font size="2"   ># vi /etc/exports &nbsp;(注意如果主节点有流复制的HA的话, 主备都需要配置权限)</font></div><div><font size="2"   >/pg_arch/pg168104 &nbsp; &nbsp; &nbsp; 192.168.168.16/32(rw,no_root_squash,sync)</font></div><div><div style="line-height: 28px;"   ><font size="2"   >/pg_arch/pg168104 &nbsp; &nbsp; &nbsp; 192.168.168.17/32(rw,no_root_squash,sync)</font></div></div><p></p></pre></div><div><br></div><div>开启NFS服务, OR service nfs reload.</div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   ># service nfs start</font></div><div style="line-height: 28px;"   ><font size="2"   ># chkconfig nfs on</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >主节点集群配置(<span style="line-height: 28px;"   >&nbsp;(注意如果主节点有流复制的HA的话, 主备都需要配置)&nbsp;</span><span style="line-height: 28px;"   >)</span></div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >配置nfs挂载, 数据库启动用户的权限, 如果有必要的话, 可以配置NFS超时.</font></div><div style="line-height: 28px;"   ><font size="2"   ># mkdir /pgarch</font></div><div style="line-height: 28px;"   ><font size="2"   ># vi /etc/fstab &nbsp;(尽量不要配置在这里, 如果挂载失败的话, 可能导致操作系统启动失败)</font></div><div><font size="2"   >192.168.168.131:<span style="line-height: 28px;"   >/pg_arch/pg168104 /pgarch</span>&nbsp;nfs &nbsp; &nbsp; defaults,tcp &nbsp;0 0</font></div><div><span style="line-height: 28px;"   ><font size="2"   ># mount -a</font></span></div><div><div style="line-height: 28px;"   ><font size="2"   ><br></font></div><div style="line-height: 28px;"   ><font size="2"   ># 推荐以下配置</font></div><div style="line-height: 28px;"   ><font size="2"   ># 另一种是配置在启动脚本里面</font></div><div style="line-height: 28px;"   ><font size="2"   ># vi /etc/rc.local</font></div></div><div><font size="2"   >/bin/mount -t nfs -o tcp 192.168.168.131:/pg_arch/pg168104 /pgarch</font></div><div><font size="2"   ># df -k</font></div><div><div><font size="2"   >192.168.168.131:/pg_arch/pg168104</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;37497821184 &nbsp; &nbsp; &nbsp; &nbsp; 0 37497821184 &nbsp; 0% /pgarch</font></div></div><div><font size="2"   >创建归档目录</font></div><div><font size="2"   ># mkdir -p&nbsp;<span style="line-height: 28px;"   >/pgarch/arch</span></font></div><div><font size="2"   ><span style="line-height: 28px;"   ># chown postgres:postgres&nbsp;</span><span style="line-height: 28px;"   >/pgarch/arch</span></font></div><div><span style="line-height: 28px;"   ><font size="2"   ># chmod 777 /pgarch/arch</font></span></div><p></p></pre></div><div><br></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >主节点集群配置归档命令(如果以前没有开启归档的话, 需要重启数据库开启归档)&nbsp;</span><span style="line-height: 28px;"   >&nbsp;(注意如果主节点有流复制的HA的话, 主备都需要配置)</span></div></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >首先要配置SUDO, 因为NFS挂载过来权限后面需要调整, 所以最好使用SUDO以免归档和还原失败.</span></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >sudoedit /etc/sudoers</font></div><div style="line-height: 28px;"   ><font size="2"   >#Defaults &nbsp; &nbsp;requiretty</font></div><div style="line-height: 28px;"   ><font size="2"   >postgres ALL=(ALL) NOPASSWD: /bin/cp</font></div><div style="line-height: 28px;"   ><font size="2"   >postgres ALL=(ALL) NOPASSWD: /usr/bin/test</font></div><div style="line-height: 28px;"   ><font size="2"   >postgres ALL=(ALL) NOPASSWD: /bin/mkdir</font></div><p></p></pre></div><div style="line-height: 28px;"   >配置归档和还原命令 :&nbsp;</div></span></div><div><pre class="prettyprint"   ><p style="line-height: 28px;"   ></p><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><font size="2"   >vi $PGDATA/postgresql.conf</font></span></div><div style="line-height: 28px;"   ><font size="2"   >archive_mode = on</font></div><div><font size="2"   ><span style="line-height: 28px;"   >archive_command = '</span>DIR=/pgarch/arch/`date +%F`; sudo test ! -d $DIR &amp;&amp; sudo mkdir $DIR; sudo test ! -f $DIR/%f &amp;&amp; sudo cp %p $DIR/%f; chmod +r $DIR/%f<span style="line-height: 28px;"   >'</span></font></div><div><font size="2"   ><br></font></div><div><font size="2"   >vi $PGDATA/recovery.conf<br>restore_command = 'cp /pgarch/arch/*/%f %p'</font></div><div><font size="2"   ><span style="line-height: 28px;"   ><br></span></font></div><div style="line-height: 28px;"   ><font size="2"   >pg_ctl reload</font></div><p style="line-height: 28px;"   ></p></pre></div><div>主备同时配归档没有问题(因为原版的PostgreSQL备节点不会触发归档), 除非你像我那样改了PG代码.</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201452004721783/"   >http://blog.163.com/digoal@126/blog/static/163877040201452004721783/</a></div><div><br></div><div>流复制主机(PITR)配置 :&nbsp;</div><div>配置ZFS(同上)</div><div>考虑到写居多, 所以需要加一个ilog设备. l2arc没必要加.</div><div>zpool使用raidz1+ilog+spare的模式, 盘的数量11+1+1, 1个ilog因为这个设备底层使用了RAID1 的模式, 所以没有再次mirror.如果底层是JBOD模式的话, 建议用mirror防止ilog数据损坏.</div><div>扇区大小选择4KB.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># zpool create -o ashift=12 zp1 raidz1 sdb sdc sdd sde sdf sdg sdh sdi sdj sdk sdl spare sdm&nbsp;</font></div><div><font size="2"   ># zpool add zp1 log /dev/sda4</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   ># zpool status</font></div><div><font size="2"   >&nbsp; pool: zp1</font></div><div><font size="2"   >&nbsp;state: ONLINE</font></div><div><font size="2"   >&nbsp; scan: none requested</font></div><div><font size="2"   >config:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; NAME &nbsp; &nbsp; &nbsp; &nbsp;STATE &nbsp; &nbsp; READ WRITE CKSUM</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; zp1 &nbsp; &nbsp; &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; raidz1-0 &nbsp;ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sdb &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sdc &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sdd &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sde &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sdf &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sdg &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sdh &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sdi &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sdj &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sdk &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sdl &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; logs</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sda4 &nbsp; &nbsp; &nbsp;ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; spares</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sdm &nbsp; &nbsp; &nbsp; AVAIL &nbsp;&nbsp;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >errors: No known data errors</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   ># zpool get all</font></div><div><font size="2"   >NAME &nbsp;PROPERTY &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; VALUE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SOURCE</font></div><div><font size="2"   >zp1 &nbsp; size &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 40T &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div><font size="2"   >zp1 &nbsp; capacity &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0% &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -</font></div><div><font size="2"   >zp1 &nbsp; altroot &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div><font size="2"   >zp1 &nbsp; health &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -</font></div><div><font size="2"   >zp1 &nbsp; guid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 11462343615959745695 &nbsp; default</font></div><div><font size="2"   >zp1 &nbsp; version &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div><font size="2"   >zp1 &nbsp; bootfs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; - &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div><font size="2"   >zp1 &nbsp; delegation &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div><font size="2"   >zp1 &nbsp; autoreplace &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div><font size="2"   >zp1 &nbsp; cachefile &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div><font size="2"   >zp1 &nbsp; failmode &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; wait &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div><font size="2"   >zp1 &nbsp; listsnapshots &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div><font size="2"   >zp1 &nbsp; autoexpand &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div><font size="2"   >zp1 &nbsp; dedupditto &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div><font size="2"   >zp1 &nbsp; dedupratio &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1.00x &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div><font size="2"   >zp1 &nbsp; free &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 40.0T &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div><font size="2"   >zp1 &nbsp; allocated &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;3.98G &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div><font size="2"   >zp1 &nbsp; readonly &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div><font size="2"   >zp1 &nbsp; ashift &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 12 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; local</font></div><div><font size="2"   >zp1 &nbsp; comment &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;- &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div><font size="2"   >zp1 &nbsp; expandsize &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div><font size="2"   >zp1 &nbsp; freeing &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div><font size="2"   >zp1 &nbsp; feature@async_destroy &nbsp;enabled &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;local</font></div><div><font size="2"   >zp1 &nbsp; feature@empty_bpobj &nbsp; &nbsp;active &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; local</font></div><div><font size="2"   >zp1 &nbsp; feature@lz4_compress &nbsp; active &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; local</font></div></div><p></p></pre></div><div><br></div><div>设置zpool默认zfs的属性, 以便创建后面的zfs继承这些属性(同上). 主要修改压缩和文件访问时间.&nbsp;</div><div>因为是集中式的流复制场景, 所以存储的IO可能会比较大, 前面我们考虑了使用ilog来提高写性能, 同时我们还需要考虑数据压缩, 节约存储空间, 我们这里选择lz4压缩算法, 速度和压缩比比较均衡.</div><div>去重(dedup)暂时不开, 因为需要消耗大量的内存, 具体耗多少内存, 可以使用zdb -S zp1来评估. 参考&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020145173939183/"   >http://blog.163.com/digoal@126/blog/static/16387704020145173939183/</a></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># zfs set compression=lz4 zp1</font></div><div><font size="2"   ># zfs set atime=off zp1</font></div><div><font size="2"   ># zfs set canmount=off zp1</font></div><div><div><font size="2"   ># zfs get all zp1</font></div><div><font size="2"   >NAME &nbsp;PROPERTY &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;VALUE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SOURCE</font></div><div><font size="2"   >zp1 &nbsp; type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;filesystem &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -</font></div><div><font size="2"   >zp1 &nbsp; creation &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Tue Jul &nbsp;1 13:49 2014 &nbsp;-</font></div><div><font size="2"   >zp1 &nbsp; used &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4.62G &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div><font size="2"   >zp1 &nbsp; available &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 35.0T &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div><font size="2"   >zp1 &nbsp; referenced &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;242K &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -</font></div><div><font size="2"   >zp1 &nbsp; compressratio &nbsp; &nbsp; &nbsp; &nbsp; 2.81x &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div><font size="2"   >zp1 &nbsp; mounted &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; no &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -</font></div><div><font size="2"   >zp1 &nbsp; quota &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; none &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div><font size="2"   >zp1 &nbsp; reservation &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; none &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div><font size="2"   >zp1 &nbsp; recordsize &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;128K &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div><font size="2"   >zp1 &nbsp; mountpoint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;/zp1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div><font size="2"   >zp1 &nbsp; sharenfs &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div><font size="2"   >zp1 &nbsp; checksum &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div><font size="2"   >zp1 &nbsp; compression &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; lz4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;local</font></div><div><font size="2"   >zp1 &nbsp; atime &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;local</font></div><div><font size="2"   >zp1 &nbsp; devices &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div><font size="2"   >zp1 &nbsp; exec &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div><font size="2"   >zp1 &nbsp; setuid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div><font size="2"   >zp1 &nbsp; readonly &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div><font size="2"   >zp1 &nbsp; zoned &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div><font size="2"   >zp1 &nbsp; snapdir &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hidden &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div><font size="2"   >zp1 &nbsp; aclinherit &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;restricted &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div><font size="2"   >zp1 &nbsp; canmount &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;local</font></div><div><font size="2"   >zp1 &nbsp; xattr &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; on &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div><font size="2"   >zp1 &nbsp; copies &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div><font size="2"   >zp1 &nbsp; version &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 5 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div><font size="2"   >zp1 &nbsp; utf8only &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div><font size="2"   >zp1 &nbsp; normalization &nbsp; &nbsp; &nbsp; &nbsp; none &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -</font></div><div><font size="2"   >zp1 &nbsp; casesensitivity &nbsp; &nbsp; &nbsp; sensitive &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div><font size="2"   >zp1 &nbsp; vscan &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div><font size="2"   >zp1 &nbsp; nbmand &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div><font size="2"   >zp1 &nbsp; sharesmb &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div><font size="2"   >zp1 &nbsp; refquota &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;none &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div><font size="2"   >zp1 &nbsp; refreservation &nbsp; &nbsp; &nbsp; &nbsp;none &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div><font size="2"   >zp1 &nbsp; primarycache &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div><font size="2"   >zp1 &nbsp; secondarycache &nbsp; &nbsp; &nbsp; &nbsp;all &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div><font size="2"   >zp1 &nbsp; usedbysnapshots &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div><font size="2"   >zp1 &nbsp; usedbydataset &nbsp; &nbsp; &nbsp; &nbsp; 242K &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -</font></div><div><font size="2"   >zp1 &nbsp; usedbychildren &nbsp; &nbsp; &nbsp; &nbsp;4.62G &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div><font size="2"   >zp1 &nbsp; usedbyrefreservation &nbsp;0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div><font size="2"   >zp1 &nbsp; logbias &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; latency &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div><font size="2"   >zp1 &nbsp; dedup &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div><font size="2"   >zp1 &nbsp; mlslabel &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;none &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div><font size="2"   >zp1 &nbsp; sync &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;standard &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div><font size="2"   >zp1 &nbsp; refcompressratio &nbsp; &nbsp; &nbsp;1.00x &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div><font size="2"   >zp1 &nbsp; written &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 242K &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; -</font></div><div><font size="2"   >zp1 &nbsp; logicalused &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 11.6G &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div><font size="2"   >zp1 &nbsp; logicalreferenced &nbsp; &nbsp; 15K &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-</font></div><div><font size="2"   >zp1 &nbsp; snapdev &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; hidden &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div><font size="2"   >zp1 &nbsp; acltype &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div><div><font size="2"   >zp1 &nbsp; context &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; none &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div><font size="2"   >zp1 &nbsp; fscontext &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; none &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div><font size="2"   >zp1 &nbsp; defcontext &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;none &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div><font size="2"   >zp1 &nbsp; rootcontext &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; none &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; default</font></div><div><font size="2"   >zp1 &nbsp; relatime &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;off &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;default</font></div></div><p></p></pre></div><div><br></div><div>创建数据库集群对应的zfs, 一个数据库集群对应一个zfs, 方便我们做zfs snapshot.</div><div>命名的话, 最好结合IP和数据库的业务名称.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >zfs create -o mountpoint=/pg168104&nbsp;zp1/pg168104</font></div><div></div><p></p></pre></div><div><br></div><div>配置网卡绑定(可选), 当带宽不够时可选.</div><div>参考</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201451823232145/"   >http://blog.163.com/digoal@126/blog/static/163877040201451823232145/</a></div><div>如果所有主数据库节点产生xlog的速率超过了网卡速率, 那么建议多网卡绑定来解决网络带宽的问题.</div><div><br></div><div>配置虚拟IP, 路由. (这样的话所有的主节点pg_hba.conf的配置都指向这个虚拟IP, 以后迁移的话, 虚拟IP迁移走, 主节点的pg_hba.conf可以不用修改, (当然如果有DNS的话, 也可以配置为主机名, 就没有这么麻烦了))</div><div>参考&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020145181134983/"   >http://blog.163.com/digoal@126/blog/static/16387704020145181134983/</a></div><div>主节点配置pg_hba.conf允许虚拟IP过来的流复制协议连接.&nbsp;</div><div><br></div><div>配置PITR备节点, 一个用户对应一个主节点, 每个用户编译各自的PG软件.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># zfs create -o mountpoint=/pg_home zp1/pg_home</font></div><div><font size="2"   ># mkdir -p&nbsp;<span style="line-height: 28px;"   >/pg_home/pg168104/soft_bak</span></font></div><div><font size="2"   ><span style="line-height: 28px;"   ># cd&nbsp;</span><span style="line-height: 28px;"   >/pg_home/pg168104/soft_bak</span></font></div><div><font size="2"   ><span style="line-height: 28px;"   ># wget&nbsp;</span><span style="line-height: 28px;"   >pgsql9.0.17 , pgfincore , 等其他和主节点一致的软件(如果只作为备份的话, 无所谓, 如果要打开只读, 那么尽量一致的SO)</span></font></div><p></p></pre></div><div>编译与主节点一致的postgresql软件以及插件.&nbsp;</div><div>编译项见主节点的pg_config输出或查看源编译文件的config.log.</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># less config.log</font></div><div><font size="2"   >&nbsp; $ ./configure --prefix=/pg_home/pg168104/pgsql9.0.17 --with-wal-segsize=64 --with-perl --with-python --with-openssl --with-pam --with-ldap --with-libxml --with-libxslt --enable-thread-safety</font></div><p></p></pre></div><div>或</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >$&nbsp;pg_config</font></div><div><font size="2"   >BINDIR = /home/pg168104/pgsql9.0.17/bin</font></div><div><font size="2"   >DOCDIR = /home/pg168104/pgsql9.0.17/share/doc</font></div><div><font size="2"   >HTMLDIR = /home/pg168104/pgsql9.0.17/share/doc</font></div><div><font size="2"   >INCLUDEDIR = /home/pg168104/pgsql9.0.17/include</font></div><div><font size="2"   >PKGINCLUDEDIR = /home/pg168104/pgsql9.0.17/include</font></div><div><font size="2"   >INCLUDEDIR-SERVER = /home/pg168104/pgsql9.0.17/include/server</font></div><div><font size="2"   >LIBDIR = /home/pg168104/pgsql9.0.17/lib</font></div><div><font size="2"   >PKGLIBDIR = /home/pg168104/pgsql9.0.17/lib</font></div><div><font size="2"   >LOCALEDIR = /home/pg168104/pgsql9.0.17/share/locale</font></div><div><font size="2"   >MANDIR = /home/pg168104/pgsql9.0.17/share/man</font></div><div><font size="2"   >SHAREDIR = /home/pg168104/pgsql9.0.17/share</font></div><div><font size="2"   >SYSCONFDIR = /home/pg168104/pgsql9.0.17/etc</font></div><div><font size="2"   >PGXS = /home/pg168104/pgsql9.0.17/lib/pgxs/src/makefiles/pgxs.mk</font></div><div><font size="2"   >CONFIGURE = '--prefix=/home/pg168104/pgsql9.0.17' '--with-pgport=1921' '--with-wal-segsize=64' '--with-perl' '--with-python' '--with-openssl' '--with-pam' '--with-ldap' '--with-libxml' '--with-libxslt' '--enable-thread-safety'</font></div><div><font size="2"   >CC = gcc</font></div><div><font size="2"   >CPPFLAGS = -D_GNU_SOURCE -I/usr/include/libxml2</font></div><div><font size="2"   >CFLAGS = -O2 -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Wendif-labels -fno-strict-aliasing -fwrapv</font></div><div><font size="2"   >CFLAGS_SL = -fpic</font></div><div><font size="2"   >LDFLAGS = -Wl,--as-needed -Wl,-rpath,'/home/pg168104/pgsql9.0.17/lib',--enable-new-dtags</font></div><div><font size="2"   >LDFLAGS_EX =&nbsp;</font></div><div><font size="2"   >LDFLAGS_SL =&nbsp;</font></div><div><font size="2"   >LIBS = -lpgport -lxslt -lxml2 -lpam -lssl -lcrypto -lz -lreadline -lcrypt -ldl -lm&nbsp;</font></div><div><font size="2"   >VERSION = PostgreSQL 9.0.17</font></div><p></p></pre></div><div>自定义的插件查看, 可以查看$PGHOME/lib目录或, 最好是拿到数据库档案, 翻阅编译过的插件, 新增的动态链接库等.</div><div>例如</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp;ll -rt $PGHOME/lib/</font></div><div><font size="2"   >pgfincore.so</font></div><div><font size="2"   ># ln -s /pg_home/pg168104/pgsql9.0.17 /pg_home/pg168104/pgsql</font></div><div><font size="2"   ># useradd pg168104</font></div><div><font size="2"   ># su - pg168104</font></div><div><font size="2"   >vi .bash_profile</font></div><div><div><font size="2"   >export PS1="$USER@`/bin/hostname -s`-&gt; "</font></div><div><font size="2"   >export DATE=`date +"%Y%m%d%H%M"`</font></div><div><font size="2"   >export LANG=en_US.utf8</font></div><div><font size="2"   >export PGHOME=/pg_home/pg168104/pgsql</font></div><div><font size="2"   >export PATH=$PGHOME/bin:$PATH:.</font></div><div><font size="2"   >export LD_LIBRARY_PATH=$PGHOME/lib:/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib</font></div><div><font size="2"   >export MANPATH=$PGHOME/share/man:$MANPATH</font></div><div><font size="2"   >export PGDATA=/pg168104/pg_root</font></div><div><font size="2"   >export PGPORT=19211</font></div><div><font size="2"   >export PGHOST=$PGDATA</font></div><div><font size="2"   >export PGUSER=postgres</font></div><div><font size="2"   >export PGDATABASE=postgres</font></div><div><font size="2"   >alias rm='rm -i'</font></div><div><font size="2"   >alias ll='ls -lh'</font></div></div><p></p></pre></div><div><br></div><div>创建基础备份, 在备份机, 所有的表空间都不使用软链接, 直接使用$PGDATA/pg_tblspc/oid目录.</div><div>方法见&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201451713724384/"   >http://blog.163.com/digoal@126/blog/static/163877040201451713724384/</a></div><div>例如</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi /etc/exports</font></div><div><font size="2"   >/pgxxxxxx &nbsp; &nbsp; &nbsp; 192.168.xxx.xxx/32(rw,no_root_squash,sync)</font></div><div><font size="2"   >service nfs reload</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >mount -t nfs -o tcp 192.168.xxx.xxx:/pgxxxxxx /mnt</font></div><div><div><font size="2"   ># echo $PGDATA</font></div><div><font size="2"   >/xxx/xxx/xxx</font></div></div><div><font size="2"   ># su - postgres</font></div><div><font size="2"   >$ psql -c "select pg_start_backup(now()::text);"</font></div><div><font size="2"   >cp -rL $PGDATA mnt/</font></div><div><span style="line-height: 28px;"   ><font size="2"   >$ psql -c "select pg_stop_backup();"</font></span></div><div><span style="line-height: 28px;"   ><font size="2"   >umount /mnt</font></span></div><p></p></pre></div><div><br></div><div>配置standby :&nbsp;</div><div>recovery.conf, postgresql.conf, (注意监听端口的修改, 因为一台主机开启多个standby, 避免端口冲突., 注意pg_log位置的修改. )</div><div>配置.pgpass</div><div>配置主节点pg_hba.conf, 允许备机的虚拟IP访问. (如果是流复制集群的话, 主备两边都需要配置.)</div><div>开启standby进行恢复, (随便使用open模式hot_standby = on 或 recovery模式hot_standby = off)</div><div>recovery.conf中添加 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >restore_command = 'cp --preserve=timestamps /pg_arch/pgxxxxxx/arch/*/%f %p'</font></p></pre></div><div><br></div><div>配置snapshot crontab</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >#vi /root/script/zfs_snap.sh</font></div><div><div><font size="2"   >#!/bin/bash</font></div><div><font size="2"   >/sbin/zfs snapshot zp1/pg168104@`date +%Y%m%d`</font></div></div><div><font size="2"   >chmod 500&nbsp;<span style="line-height: 28px;"   >/root/script/zfs_snap.sh</span></font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># crontab -e</font></div><div><font size="2"   >1 8 * * * /root/script/zfs_snap.sh</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >配置监控</span></div><div><span style="line-height: 28px;"   >1. nfs 监控</span></div><div>showmount -e 192.168.168.131</div><div>2. nfs 端口监控</div><div><span style="line-height: 28px;"   >3. PITR上所有数据库集群的端口监控</span></div><div><span style="line-height: 28px;"   >4.&nbsp;</span><span style="line-height: 28px;"   >PITR上所有数据库集群的</span><span style="line-height: 28px;"   >stream wal receiver进程</span><span style="line-height: 28px;"   >监控</span></div><div><span style="line-height: 28px;"   >5. 流复制延迟监控</span></div><div><span style="line-height: 28px;"   >6. 归档文件时间戳监控, 发现归档失败.&nbsp;</span></div><div><span style="line-height: 28px;"   >7. 恢复监控, 10分钟内如果没有新建的XLOG文件则告警.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># cat /usr/local/nagios/libexec/mon_pitr.sh&nbsp;</font></div><div><font size="2"   ><span style="line-height: 21px;"   >#!/bin/bash<br><br>EXIT=0<br><br>DATE="`date +%F`"<br>DIR="pgxxxxxx pgxxxxxx pgxxxxxx"<br><br>for i in $DIR<br>do<br>CNT=""<br>CNT=`find /$i/pg_root/pg_xlog -maxdepth 1 -size +15M -mmin -10`<br>if [ "" == "$CNT" ]; then<br>  echo -e "$i restore delay"<br>  EXIT=1<br>fi<br><br>CNT=""<br>CNT=`find /pg_arch/$i/arch/$DATE -maxdepth 1 -size +15M -mmin -20`<br>if [ "" == "$CNT" ]; then<br>  echo -e "$i archive delay"<br>  EXIT=1<br>fi<br>done<br><br>exit $EXIT</span></font></div><p></p></pre></div><div>因为PGDATA是700的权限, 所以find这些目录会受到权限限制, nagios监控用户会报错, 所以可以把这个命令加入SUDO</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># sudoedit /etc/sudoers</font></div><div><font size="2"   >ALL ALL=(ALL) NOPASSWD: /usr/local/nagios/libexec/mon_pitr.sh</font></div><div><font size="2"   ># cat /usr/local/nagios/etc/nrpe.cfg&nbsp;</font></div><div><font size="2"   >command[mon_pitr]=sudo /usr/local/nagios/libexec/mon_pitr.sh</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >[注意事项]</span></div><div>1. 如果归档失败, 主节点的pg_xlog目录会暴增, 不能rotate. 所以pg_xlog目录尽量配置大一些, 同时加上监控.&nbsp;</div><div>当然更靠谱的方法是使用多个归档路径, 一个失败就归档到下一个路径. 但是需要注意调小一点超时. 否则每次归档都要等待超时也会造成拥堵.</div><div>2. 对NFS主机需要添加监控, 以防有问题.</div><div>3. 对于主节点有流复制HA的情况, NFS挂载, 归档都需要在主备节点同时配置. NFS的exports也需要配置允许主备节点的IP rw.</div><div>4. 因为是集中的归档和流复制所以务必注意网络带宽是否够用. 不够用的话, 可以考虑多网卡绑定增加带宽.</div><div>5. NFS端口固定后, 可以防止NFS服务器重启后或服务重启后, NFS CLIENT需要重新MOUNT的问题. 或者防火墙精确控制的问题.</div><div><div style="line-height: 28px;"   >6. 关于使用虚拟IP后路由出口IP的选择问题. 参见&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020145181134983/"   >http://blog.163.com/digoal@126/blog/static/16387704020145181134983/</a></div><div style="line-height: 28px;"   >7. 关于zpool raidz的底层块设备个数选择. 参见&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201451725147753/"   >http://blog.163.com/digoal@126/blog/static/163877040201451725147753/</a></div><div style="line-height: 28px;"   >8. 关于zfs的写入优化. 参见末尾</div><div style="line-height: 28px;"   >9. 关于zfs的压缩优化. 参见末尾</div><div style="line-height: 28px;"   >10. 多数据库集群的路径冲突问题. 不使用pg_tblspc/link, 直接一个集群一个zfs dataset来解决.</div><div style="line-height: 28px;"   >11. 开启归档后, standby节点参数修改, 如wal keep 改小, listen port 修改避免冲突, log_directory目录位置修改.等</div><div style="line-height: 28px;"   >12. zpool创建时, 务必设备名建议by-id, 放在因为设备别名变更后导致无法使用.</div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   ># ll /dev/disk/by-id/</font></div><div style="line-height: 28px;"   ><font size="2"   >total 0</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root &nbsp;9 Jun 18 17:33 scsi-36c81f660eb18e8001af8e4ec0420e21f -&gt; ../../sda</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jun 18 09:33 scsi-36c81f660eb18e8001af8e4ec0420e21f-part1 -&gt; ../../sda1</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jun 18 17:33 scsi-36c81f660eb18e8001af8e4ec0420e21f-part2 -&gt; ../../sda2</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jun 18 17:33 scsi-36c81f660eb18e8001af8e4ec0420e21f-part3 -&gt; ../../sda3</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:50 scsi-36c81f660eb18e8001af8e4ec0420e21f-part4 -&gt; ../../sda4</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root &nbsp;9 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c448038b992a -&gt; ../../sdb</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c448038b992a-part1 -&gt; ../../sdb1</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c448038b992a-part9 -&gt; ../../sdb9</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root &nbsp;9 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c44f03f8bc42 -&gt; ../../sdc</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c44f03f8bc42-part1 -&gt; ../../sdc1</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c44f03f8bc42-part9 -&gt; ../../sdc9</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root &nbsp;9 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c48e07b42c1c -&gt; ../../sdd</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c48e07b42c1c-part1 -&gt; ../../sdd1</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c48e07b42c1c-part9 -&gt; ../../sdd9</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root &nbsp;9 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c49e08a8b85a -&gt; ../../sde</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c49e08a8b85a-part1 -&gt; ../../sde1</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c49e08a8b85a-part9 -&gt; ../../sde9</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root &nbsp;9 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c4b90a4c8813 -&gt; ../../sdf</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c4b90a4c8813-part1 -&gt; ../../sdf1</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c4b90a4c8813-part9 -&gt; ../../sdf9</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root &nbsp;9 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c4c60b0d6236 -&gt; ../../sdg</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c4c60b0d6236-part1 -&gt; ../../sdg1</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c4c60b0d6236-part9 -&gt; ../../sdg9</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root &nbsp;9 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c4d00baa0784 -&gt; ../../sdh</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c4d00baa0784-part1 -&gt; ../../sdh1</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c4d00baa0784-part9 -&gt; ../../sdh9</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root &nbsp;9 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c5070eed3bc5 -&gt; ../../sdi</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c5070eed3bc5-part1 -&gt; ../../sdi1</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c5070eed3bc5-part9 -&gt; ../../sdi9</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root &nbsp;9 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c534119bcc85 -&gt; ../../sdj</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c534119bcc85-part1 -&gt; ../../sdj1</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c534119bcc85-part9 -&gt; ../../sdj9</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root &nbsp;9 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c53a11f82f4c -&gt; ../../sdk</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c53a11f82f4c-part1 -&gt; ../../sdk1</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c53a11f82f4c-part9 -&gt; ../../sdk9</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root &nbsp;9 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c543127efb6d -&gt; ../../sdl</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c543127efb6d-part1 -&gt; ../../sdl1</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c543127efb6d-part9 -&gt; ../../sdl9</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root &nbsp;9 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c5c61a48318a -&gt; ../../sdm</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c5c61a48318a-part1 -&gt; ../../sdm1</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 scsi-36c81f660eb18e8001b32c5c61a48318a-part9 -&gt; ../../sdm9</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root &nbsp;9 Jun 18 17:33 wwn-0x6c81f660eb18e8001af8e4ec0420e21f -&gt; ../../sda</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jun 18 09:33 wwn-0x6c81f660eb18e8001af8e4ec0420e21f-part1 -&gt; ../../sda1</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jun 18 17:33 wwn-0x6c81f660eb18e8001af8e4ec0420e21f-part2 -&gt; ../../sda2</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jun 18 17:33 wwn-0x6c81f660eb18e8001af8e4ec0420e21f-part3 -&gt; ../../sda3</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:50 wwn-0x6c81f660eb18e8001af8e4ec0420e21f-part4 -&gt; ../../sda4</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root &nbsp;9 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c448038b992a -&gt; ../../sdb</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c448038b992a-part1 -&gt; ../../sdb1</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c448038b992a-part9 -&gt; ../../sdb9</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root &nbsp;9 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c44f03f8bc42 -&gt; ../../sdc</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c44f03f8bc42-part1 -&gt; ../../sdc1</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c44f03f8bc42-part9 -&gt; ../../sdc9</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root &nbsp;9 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c48e07b42c1c -&gt; ../../sdd</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c48e07b42c1c-part1 -&gt; ../../sdd1</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c48e07b42c1c-part9 -&gt; ../../sdd9</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root &nbsp;9 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c49e08a8b85a -&gt; ../../sde</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c49e08a8b85a-part1 -&gt; ../../sde1</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c49e08a8b85a-part9 -&gt; ../../sde9</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root &nbsp;9 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c4b90a4c8813 -&gt; ../../sdf</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c4b90a4c8813-part1 -&gt; ../../sdf1</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c4b90a4c8813-part9 -&gt; ../../sdf9</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root &nbsp;9 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c4c60b0d6236 -&gt; ../../sdg</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c4c60b0d6236-part1 -&gt; ../../sdg1</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c4c60b0d6236-part9 -&gt; ../../sdg9</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root &nbsp;9 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c4d00baa0784 -&gt; ../../sdh</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c4d00baa0784-part1 -&gt; ../../sdh1</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c4d00baa0784-part9 -&gt; ../../sdh9</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root &nbsp;9 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c5070eed3bc5 -&gt; ../../sdi</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c5070eed3bc5-part1 -&gt; ../../sdi1</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c5070eed3bc5-part9 -&gt; ../../sdi9</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root &nbsp;9 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c534119bcc85 -&gt; ../../sdj</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c534119bcc85-part1 -&gt; ../../sdj1</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c534119bcc85-part9 -&gt; ../../sdj9</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root &nbsp;9 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c53a11f82f4c -&gt; ../../sdk</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c53a11f82f4c-part1 -&gt; ../../sdk1</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c53a11f82f4c-part9 -&gt; ../../sdk9</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root &nbsp;9 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c543127efb6d -&gt; ../../sdl</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c543127efb6d-part1 -&gt; ../../sdl1</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c543127efb6d-part9 -&gt; ../../sdl9</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root &nbsp;9 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c5c61a48318a -&gt; ../../sdm</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c5c61a48318a-part1 -&gt; ../../sdm1</font></div><div style="line-height: 28px;"   ><font size="2"   >lrwxrwxrwx 1 root root 10 Jul &nbsp;1 13:49 wwn-0x6c81f660eb18e8001b32c5c61a48318a-part9 -&gt; ../../sdm9</font></div><p></p></pre></div></div><div style="line-height: 28px;"   >例如把zil和spare设备换成uuid.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># zpool remove zp1 sdm</font></div><div><font size="2"   ># zpool remove zp1 sda4</font></div><div><font size="2"   ># zpool add zp1 log /dev/disk/by-id/scsi-36c81f660eb18e8001af8e4ec0420e21f-part4</font></div><div><font size="2"   ># zpool add zp1 spare /dev/disk/by-id/scsi-36c81f660eb18e8001b32c5c61a48318a</font></div><div><div><font size="2"   ># zpool status</font></div><div><font size="2"   >&nbsp; pool: zp1</font></div><div><font size="2"   >&nbsp;state: ONLINE</font></div><div><font size="2"   >&nbsp; scan: none requested</font></div><div><font size="2"   >config:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; NAME &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;STATE &nbsp; &nbsp; READ WRITE CKSUM</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; zp1 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; raidz1-0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sdb &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sdc &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sdd &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sde &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sdf &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sdg &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sdh &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sdi &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sdj &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sdk &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sdl &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; logs</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; scsi-36c81f660eb18e8001af8e4ec0420e21f-part4 &nbsp;ONLINE &nbsp; &nbsp; &nbsp; 0 &nbsp; &nbsp; 0 &nbsp; &nbsp; 0</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; spares</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; scsi-36c81f660eb18e8001b32c5c61a48318a &nbsp; &nbsp; &nbsp; &nbsp;AVAIL &nbsp;&nbsp;</font></div></div><p></p></pre></div><div style="line-height: 28px;"   >13. slog的大小4G 上下就足够了.</div></div><div style="line-height: 28px;"   >14. 操作系统内核参数稍作调整.</div><div style="line-height: 28px;"   >15. 不建议使用linux, 因为zfs在linux下有一定的性能问题, 可以考虑FreeBSD. 参见</div><div style="line-height: 28px;"   ><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020145253599111/"   >http://blog.163.com/digoal@126/blog/static/16387704020145253599111/</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014526992910/"   >http://blog.163.com/digoal@126/blog/static/1638770402014526992910/</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020145264116819/"   >http://blog.163.com/digoal@126/blog/static/16387704020145264116819/</a></div><div>16. 集中式的配置standby节点可能导致资源不够用, 例如shared_buffer, 要调小的话同时还需要调小connection_max 等关联参数, 而这些参数在postgresql.conf - hot_standby=on 的情况下, 需要检测是否大于等于上游节点的参数, 所以建议standby节点的hot_standby=off, 然后就不需要检测了, 然后就可以调小shared_buffer, connection_max等了.</div><div>如果要打开hot_standby=on, 那么再调会<span style="line-height: 28px;"   >connection_max</span><span style="line-height: 28px;"   >&nbsp;等检测项即可.</span></div><div><span style="line-height: 28px;"   >17. 原来如果主节点已是流复制的HA节点, 可以把recovery.conf或recovery.done修改一下.</span></div><div><span style="line-height: 28px;"   >因为默认情况下standby节点不会产生archive, 所以不必担心重复的archive文件.</span></div><div><span style="line-height: 28px;"   >所以双方挂载对方的pgarch目录到pgrestore即可.</span></div><div><span style="line-height: 28px;"   >如果想让standby也产生archive, 参考我前面写的blog, 修改一些源代码.</span></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201452004721783/"   >http://blog.163.com/digoal@126/blog/static/163877040201452004721783/</a></div><div><p></p><div><p></p><div><p></p><div><p></p><div><pre class="prettyprint"   ><p></p><div><font size="2"   ><span style="line-height: 22.75px;"   ># mount -t nfs -o tcp bi_host:/pgarch /pgrestore</span></font></div><div><font size="2"   ><span style="line-height: 22.75px;"   ><br></span></font></div><div><font size="2"   ><span style="line-height: 22.75px;"   >$ vi $PGDATA/recovery.conf</span></font></div><div><font size="2"   ><span style="line-height: 22.75px;"   >restore_command = 'cp --preserve=timestamps /pgrestore/arch/*/%f %p'</span></font></div><p></p></pre></div><p></p></div><p></p></div><p></p></div><p></p></div><div>重启流复制备库生效.</div><div><br></div><div><span style="line-height: 28px;"   >[参考]</span></div><wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201451713724384/"   >http://blog.163.com/digoal@126/blog/static/163877040201451713724384/</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201451711013770/"   >http://blog.163.com/digoal@126/blog/static/163877040201451711013770/</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201451725147753/"   >http://blog.163.com/digoal@126/blog/static/163877040201451725147753/</a></div><div>4.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020145173939183/"   >http://blog.163.com/digoal@126/blog/static/16387704020145173939183/</a></div><div>5.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020145181134983/"   >http://blog.163.com/digoal@126/blog/static/16387704020145181134983/</a></div><div>6.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201451823232145/"   >http://blog.163.com/digoal@126/blog/static/163877040201451823232145/</a></div><div>7.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="https://pthree.org/2012/12/13/zfs-administration-part-viii-zpool-best-practices-and-caveats/"   >https://pthree.org/2012/12/13/zfs-administration-part-viii-zpool-best-practices-and-caveats/</a></div><div>8.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201452004721783/"   >http://blog.163.com/digoal@126/blog/static/163877040201452004721783/</a></div><div>9. man nfs 超时</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;timeo=n &nbsp; &nbsp; &nbsp; &nbsp;The &nbsp;value &nbsp;in &nbsp;tenths &nbsp;of &nbsp;a second before sending the first retransmission after an RPC</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; timeout. &nbsp;The default value depends on whether proto=udp or proto=tcp is in &nbsp;effect &nbsp;(see</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; below). &nbsp;The default value for UDP is 7 tenths of a second. &nbsp;The default value for TCP is</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 60 seconds. &nbsp;After the first timeout, the timeout is doubled after each successive &nbsp;time-</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; out &nbsp;until &nbsp;a maximum timeout of 60 seconds is reached or the enough retransmissions have</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; occured to cause a major timeout. &nbsp;Then, if the filesystem &nbsp;is &nbsp;hard &nbsp;mounted, &nbsp;each &nbsp;new</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; timeout &nbsp;cascade &nbsp;restarts at twice the initial value of the previous cascade, again dou-</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; bling at each retransmission. &nbsp;The maximum timeout is always 60 seconds.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;retrans=n &nbsp; &nbsp; &nbsp;The number of minor timeouts and retransmissions that must occur before a &nbsp;major &nbsp;timeout</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; occurs. &nbsp; The &nbsp;default &nbsp;is 5 timeouts for proto=udp and 2 timeouts for proto=tcp. &nbsp;When a</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; major timeout occurs, the file operation is either aborted or a "server &nbsp;not &nbsp;responding"</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; message is printed on the console.</font></div><p></p></pre></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL xlog PGDATA and zfs snapshot based central backup  PITR case - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">Foxson - 2014-07-01 15:43:31</h5>
				<div><IMG src="http://b.bst.126.net/common/portrait/face/preview/face55.gif"  >&nbsp;牛</div>
			</div>
			<div id="">
				<h5 id="">francs - 2014-07-01 15:39:50</h5>
				<div><img src="http://b.bst.126.net/common/portrait/face/preview/face55.gif"  ></div>
			</div>
	</div>
</div>
</body>
</html>