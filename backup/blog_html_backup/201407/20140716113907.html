<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL or greenplum pg_attribute table bloat case</h2>
	<h5 id="">2014-07-16 11:39:07&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402014616113353555/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">群里一位兄弟问到的一个问题, 他们的GreenPlum数据库的pg_attribute表达到了4TB的大小.<div>这个表的膨胀原因是业务程序频繁的建表和删表导致的, 因为业务可能使用了大量的临时表, 临时表是会话级别的, 在其他会话看不到, 或者重连后也需要重建临时表.</div><div>PG的临时表和ORACLE不太一样, ORACLE临时表结构建好的话, 不需要重建. 数据各会话不同而已.</div><div>但是PG的临时表, 每个会话都要重建, 所以如果大量的建立和删除临时表, 会导致PG的catalog 产生大量的垃圾.</div><div>例如pg_attribute表就是其中一个例子,&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# create temp table t(id int);</font></div><div><font size="2"   >CREATE TABLE</font></div><div><font size="2"   >digoal=# \dt</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of relations</font></div><div><font size="2"   >&nbsp; Schema &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Type &nbsp;| &nbsp;Owner &nbsp;&nbsp;</font></div><div><font size="2"   >-----------+-------------------------------------+-------+----------</font></div><div><font size="2"   >&nbsp;pg_temp_2 | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | table | postgres</font></div><div><font size="2"   >&nbsp;public &nbsp; &nbsp;| tbl_android_collect_run_info_201407 | table | postgres</font></div><div><font size="2"   >&nbsp;public &nbsp; &nbsp;| tbl_android_terminal_info_201407 &nbsp; &nbsp;| table | postgres</font></div><div><font size="2"   >&nbsp;public &nbsp; &nbsp;| test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| table | postgres</font></div><div><font size="2"   >(4 rows)</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal=# select * from pg_attribute where attrelid='t'::regclass;</font></div><div><font size="2"   >&nbsp;attrelid | attname &nbsp;| atttypid | attstattarget | attlen | attnum | attndims | attcacheoff | atttypmod | attbyval | attstorage | att</font></div><div><font size="2"   >align | attnotnull | atthasdef | attisdropped | attislocal | attinhcount | attcollation | attacl | attoptions | attfdwoptions&nbsp;</font></div><div><font size="2"   >----------+----------+----------+---------------+--------+--------+----------+-------------+-----------+----------+------------+----</font></div><div><font size="2"   >------+------------+-----------+--------------+------------+-------------+--------------+--------+------------+---------------</font></div><div><font size="2"   >&nbsp; &nbsp; 38439 | id &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 23 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-1 | &nbsp; &nbsp; &nbsp;4 | &nbsp; &nbsp; &nbsp;1 | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-1 | &nbsp; &nbsp; &nbsp; &nbsp;-1 | t &nbsp; &nbsp; &nbsp; &nbsp;| p &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| i &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; 38439 | ctid &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 27 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp;6 | &nbsp; &nbsp; -1 | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-1 | &nbsp; &nbsp; &nbsp; &nbsp;-1 | f &nbsp; &nbsp; &nbsp; &nbsp;| p &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| s &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; 38439 | xmin &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 28 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp;4 | &nbsp; &nbsp; -3 | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-1 | &nbsp; &nbsp; &nbsp; &nbsp;-1 | t &nbsp; &nbsp; &nbsp; &nbsp;| p &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| i &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; 38439 | cmin &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 29 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp;4 | &nbsp; &nbsp; -4 | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-1 | &nbsp; &nbsp; &nbsp; &nbsp;-1 | t &nbsp; &nbsp; &nbsp; &nbsp;| p &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| i &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; 38439 | xmax &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 28 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp;4 | &nbsp; &nbsp; -5 | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-1 | &nbsp; &nbsp; &nbsp; &nbsp;-1 | t &nbsp; &nbsp; &nbsp; &nbsp;| p &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| i &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; 38439 | cmax &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; 29 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp;4 | &nbsp; &nbsp; -6 | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-1 | &nbsp; &nbsp; &nbsp; &nbsp;-1 | t &nbsp; &nbsp; &nbsp; &nbsp;| p &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| i &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; 38439 | tableoid | &nbsp; &nbsp; &nbsp; 26 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp;4 | &nbsp; &nbsp; -7 | &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-1 | &nbsp; &nbsp; &nbsp; &nbsp;-1 | t &nbsp; &nbsp; &nbsp; &nbsp;| p &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| i &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; | t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| f &nbsp; &nbsp; &nbsp; &nbsp; | f &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0 | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0 | &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >(7 rows)</font></div></div></div><div><div><font size="2"   >digoal=# drop table t;</font></div><div><font size="2"   >DROP TABLE</font></div><div><font size="2"   >digoal=# select * from pg_attribute where attrelid='t'::regclass;</font></div><div><font size="2"   >ERROR: &nbsp;relation "t" does not exist</font></div><div><font size="2"   >LINE 1: select * from pg_attribute where attrelid='t'::regclass;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ^</font></div></div><p></p></pre></div><div>这样就产生了7条垃圾记录, 如果不及时vacuum , 这些记录就膨胀了.</div><div>greenplum使用的是8.2的postgresql, 垃圾回收也比较烂, 因为没有fsm, vm文件, 需要固定内存跟踪relation的垃圾数据.</div><div>所以比较容易产生大量的垃圾, 除非内存区域分配得比较大.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >These parameters control the size of the shared free space map, which tracks the locations of unused space in the database. An undersized free space map may cause the database to consume increasing amounts of disk space over time, because free space that is not in the map cannot be re-used; instead PostgreSQL will request more disk space from the operating system when it needs to store new data. The last few lines displayed by a database-wide VACUUM VERBOSE command can help in determining if the current settings are adequate. A NOTICE message is also printed during such an operation if the current settings are too low.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Increasing these parameters may cause PostgreSQL to request more System V shared memory than your operating system's default configuration allows. See Section 16.4.1 for information on how to adjust those parameters, if necessary.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >max_fsm_pages (integer)</font></div><div><font size="2"   >Sets the maximum number of disk pages for which free space will be tracked in the shared free-space map. Six bytes of shared memory are consumed for each page slot. This setting must be at least 16 * max_fsm_relations. The default is chosen by initdb depending on the amount of available memory, and can range from 20k to 200k pages. This parameter can only be set at server start.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >max_fsm_relations (integer)</font></div><div><font size="2"   >Sets the maximum number of relations (tables and indexes) for which free space will be tracked in the shared free-space map. Roughly seventy bytes of shared memory are consumed for each slot. The default is one thousand relations. This parameter can only be set at server start.</font></div><p></p></pre></div><div><br></div><div>如果要回收这部分空间, 可以cluster这个表.</div><div>8.2 的vacuum full不建议使用, 因为索引不会重建. 所以即使表变小了, 索引还是那么大.</div><div>例子 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi postgresql.conf</font></div><div><font size="2"   >allow_system_table_mods=on</font></div><div><font size="2"   >pg_ctl restart -m fast</font></div><div><font size="2"   >digoal=# create index CONCURRENTLY&nbsp;idx_1 on pg_attribute(ctid);</font></div><div><font size="2"   >digoal=# cluster pg_attribute using idx_1;</font></div><p></p></pre></div><div>或者直接使用已有的索引pg_attribute_relid_attnam_index,&nbsp;pg_attribute_relid_attnum_index.</div><div><pre class="prettyprint"   ><p><font size="2"   ><span style="line-height: 28px;"   >cluster pg_attribute using&nbsp;</span><span style="line-height: 28px;"   >pg_attribute_relid_attnam_index</span><span style="line-height: 28px;"   >;</span></font></p></pre></div><div><br></div><div>[参考]</div><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/8.2/static/runtime-config-resource.html#RUNTIME-CONFIG-RESOURCE-FSM"   >http://www.postgresql.org/docs/8.2/static/runtime-config-resource.html#RUNTIME-CONFIG-RESOURCE-FSM</a></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL or greenplum pg_attribute table bloat case - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>