<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">oVirt host deploy</h2>
	<h5 id="">2014-07-31 23:36:38&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402014631991672/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>前面介绍了oVirt engine和report的部署, 参考 :&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/1638770402014628114756319/"   >http://blog.163.com/digoal@126/blog/static/1638770402014628114756319/</a></div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201462942137640/"   >http://blog.163.com/digoal@126/blog/static/163877040201462942137640/</a></div><div>这里要介绍一下使用ovirt engine管理平台进行oVirt宿主机的部署.</div><div>oVirt的架构介绍参考 :&nbsp;</div><div><a target="_blank" rel="nofollow" href="http://www.ovirt.org/Architecture"   >http://www.ovirt.org/Architecture</a></div><div><br></div><div>部署oVirt宿主机, 宿主机需要联通网络, 配置ovirt yum源, 配置DNS可以解析ovirt yum源, 另外宿主机的CPU需要支持虚拟化, 同时在BIOS打开虚拟化开关, 等.</div><div><br></div><div>本文部署HOST节点的主机为DELL R610,&nbsp;E5504的CPU.</div><div>部署步骤 :&nbsp;</div>1. 首先检查宿主机的CPU是否支持虚拟化, 并且在BIOS开启它.<div><div><img title="oVirt host deploy - 德哥@Digoal - PostgreSQL research"   alt="oVirt host deploy - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img2.ph.126.net/unhjXvT-NJWXNGjys5bJsg==/6619232622537135725.png"   ></div></div><div><br><div>2. 然后需要给宿主机安装CentOS 6.x x64.</div><div><br></div><div>3. 配置宿主机的主机名, 最好整个oVirt环境部署DNS, 用于解析所有的宿主机和管理机, 存储的主机名.</div><div>没有的话, 需要配置/etc/hosts.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   ># vi /etc/hosts</font></div><div><font size="2"   >127.0.0.1 &nbsp; localhost localhost.localdomain localhost4 localhost4.localdomain4</font></div><div><span style="line-height: 28px;"   ><font size="2"   >172.16.3.40 40.sky-mobi.com</font></span></div></div><div><span style="line-height: 28px;"   ><font size="2"   ><br></font></span></div><div><font size="2"   ># cat /etc/sysconfig/network</font></div><div><font size="2"   >NETWORKING=yes</font></div><div><font size="2"   >HOSTNAME=40.sky-mobi.com</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># vi /etc/resolv.conf <br>nameserver 202.101.172.35</font></div><p></p></pre></div><div><br></div><div>4. 配置防火墙, 打开宿主机和存储网络, 与ovirt engine的连通性.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># vi /etc/sysconfig/iptables</font></div><div><div><font size="2"   ># Firewall configuration written by system-config-firewall</font></div><div><font size="2"   ># Manual customization of this file is not recommended.</font></div><div><font size="2"   >*filter</font></div><div><font size="2"   >:INPUT ACCEPT [0:0]</font></div><div><font size="2"   >:FORWARD ACCEPT [0:0]</font></div><div><font size="2"   >:OUTPUT ACCEPT [0:0]</font></div><div><font size="2"   >-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT</font></div><div><font size="2"   >-A INPUT -p icmp -j ACCEPT</font></div><div><font size="2"   >-A INPUT -i lo -j ACCEPT</font></div><div><font size="2"   >-A INPUT -s 192.168.0.0/16 -j ACCEPT</font></div><div><font size="2"   >-A INPUT -s 10.0.0.0/8 -j ACCEPT</font></div><div><font size="2"   >-A INPUT -s 172.16.0.0/16 -j ACCEPT</font></div><div><font size="2"   >-A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j ACCEPT</font></div><div><font size="2"   >-A INPUT -j REJECT --reject-with icmp-host-prohibited</font></div><div><font size="2"   >-A FORWARD -j REJECT --reject-with icmp-host-prohibited</font></div><div><font size="2"   >COMMIT</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   ># service iptables restart</font></div><p></p></pre></div><div><br></div><div>5. 配置时钟同步</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># yum install -y ntpdate</font></div><div><div><font size="2"   ># crontab -e</font></div><div><span style="line-height: 28px;"   ><font size="2"   >8 * * * * /usr/sbin/ntpdate asia.pool.ntp.org &amp;&amp; /sbin/hwclock --systohc</font></span></div></div><div><span style="line-height: 28px;"   ><font size="2"   ><br></font></span></div><div><font size="2"   ><span style="line-height: 28px;"   >#&nbsp;</span><span style="line-height: 28px;"   >/usr/sbin/ntpdate asia.pool.ntp.org &amp;&amp; /sbin/hwclock --systohc</span></font></div><p></p></pre></div><div><br></div><div>6. 关闭SELINUX&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># setenforce 0</font></div><div><font size="2"   ># vi /etc/selinux/config</font></div><div><font size="2"   >SELINUX=disabled</font></div><p></p></pre></div><div><br></div><div>7. 配置limit.conf, sysctl.conf</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >vi /etc/sysctl.conf</font></div><div><div><font size="2"   >kernel.shmmni = 4096</font></div><div><font size="2"   >kernel.sem = 50100 64128000 50100 1280</font></div><div><font size="2"   >fs.file-max = 7672460</font></div><div><font size="2"   >net.ipv4.ip_local_port_range = 9000 65000</font></div><div><font size="2"   >net.core.rmem_default = 1048576</font></div><div><font size="2"   >net.core.rmem_max = 4194304</font></div><div><font size="2"   >net.core.wmem_default = 262144</font></div><div><font size="2"   >net.core.wmem_max = 1048576</font></div><div><font size="2"   >net.ipv4.tcp_tw_recycle = 1</font></div><div><font size="2"   >net.ipv4.tcp_max_syn_backlog = 4096</font></div><div><font size="2"   >net.core.netdev_max_backlog = 10000</font></div><div><font size="2"   >vm.overcommit_memory = 0</font></div><div><font size="2"   >net.ipv4.ip_conntrack_max = 655360</font></div><div><font size="2"   >fs.aio-max-nr = 1048576</font></div><div><font size="2"   >net.ipv4.tcp_timestamps = 0</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   ># sysctl -p</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ># vi&nbsp;/etc/security/limits.conf</font></div><div><div><font size="2"   >* soft &nbsp; &nbsp;nofile &nbsp;131072</font></div><div><font size="2"   >* hard &nbsp; &nbsp;nofile &nbsp;131073</font></div><div><font size="2"   >* soft &nbsp; &nbsp;nproc &nbsp; 131072</font></div><div><font size="2"   >* hard &nbsp; &nbsp;nproc &nbsp; 131073</font></div><div><font size="2"   >* soft &nbsp; &nbsp;core &nbsp; &nbsp;unlimited</font></div><div><font size="2"   >* hard &nbsp; &nbsp;core &nbsp; &nbsp;unlimited</font></div><div><font size="2"   >* soft &nbsp; &nbsp;memlock 50000000</font></div><div><font size="2"   >* hard &nbsp; &nbsp;memlock 50000001</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   ># vi&nbsp;/etc/security/limits.d/90-nproc.conf</font></div><div><div><font size="2"   >#* &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;soft &nbsp; &nbsp;nproc &nbsp; &nbsp; 1024</font></div><div><font size="2"   >#root &nbsp; &nbsp; &nbsp; soft &nbsp; &nbsp;nproc &nbsp; &nbsp; unlimited</font></div><div><font size="2"   >* soft &nbsp; &nbsp;nproc &nbsp; 131072</font></div><div><font size="2"   >* hard &nbsp; &nbsp;nproc &nbsp; 131073</font></div></div><p></p></pre></div><div><br></div><div>8. 配置yum</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >yum localinstall -y http://plain.resources.ovirt.org/pub/yum-repo/ovirt-release34.rpm</font></div><div><div><font size="2"   >[root@40 ~]# cd /etc/yum.repos.d/</font></div><div><font size="2"   >[root@40 yum.repos.d]# ll</font></div><div><font size="2"   >total 24</font></div><div><font size="2"   >-rw-r--r--. 1 root root 1926 Nov 27 &nbsp;2013 CentOS-Base.repo</font></div><div><font size="2"   >-rw-r--r--. 1 root root &nbsp;638 Nov 27 &nbsp;2013 CentOS-Debuginfo.repo</font></div><div><font size="2"   >-rw-r--r--. 1 root root &nbsp;630 Nov 27 &nbsp;2013 CentOS-Media.repo</font></div><div><font size="2"   >-rw-r--r--. 1 root root 3664 Nov 27 &nbsp;2013 CentOS-Vault.repo</font></div><div><font size="2"   >-rw-r--r--. 1 root root 1498 Jul 31 22:33 ovirt-3.4-dependencies.repo</font></div><div><font size="2"   >-rw-r--r--. 1 root root &nbsp;292 Jul 31 22:33 ovirt-3.4.repo</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >关闭gpg校验</font></div><div><font size="2"   ># vi ovirt-3.4-dependencies.repo</font></div><div><span style="line-height: 28px;"   ><font size="2"   ># vi ovirt-3.4.repo</font></span></div><div><font size="2"   >gpgcheck=0</font></div><p></p></pre></div><div><br></div><div>9. 配置宿主机的硬件管理卡, 用户权限, 开放LAN IPMI功能, 测试fence接口.</div><div><div><img title="oVirt host deploy - 德哥@Digoal - PostgreSQL research"   alt="oVirt host deploy - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/B2JdEyJYfFbpa5z8NCwR7Q==/6619520694583612377.png"   ></div>&nbsp;<div><img title="oVirt host deploy - 德哥@Digoal - PostgreSQL research"   alt="oVirt host deploy - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img2.ph.126.net/K1jmke32diywqIAKClZ65A==/6619343673211541108.png"   ></div></div><div><br></div><div>10. 使用ovirt-engine管理平台添加主机, 并配置电源管理模块, 有很多FENCE接口, 我们这里使用ipmi, HP的话可以使用ilo. 其他厂商的自己参考一下厂商的说明.</div><div><div><img title="oVirt host deploy - 德哥@Digoal - PostgreSQL research"   alt="oVirt host deploy - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img1.ph.126.net/yoTtFCQufFHC5TcVLF0I3g==/6619379957095257466.png"   ></div>&nbsp;<div><img title="oVirt host deploy - 德哥@Digoal - PostgreSQL research"   alt="oVirt host deploy - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img1.ph.126.net/tJvjak9xR_K87BxiVSpstA==/6619078690909246984.png"   ></div></div><div><br></div><div>11. 如果安装有错误的话, 可以查看host的event, 或者到ovirt engine主机查看日志&nbsp;/var/log/ovirt-engine/host-deploy/*.log</div><div><div><img title="oVirt host deploy - 德哥@Digoal - PostgreSQL research"   alt="oVirt host deploy - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/04x-D_U9GKpJlfhglEZ9-A==/6608580553887602124.png"   ></div></div><div><div><br></div><div>[其他]</div><div>1. 在HP DL360 G5 E5405的机器上部署host节点失败.&nbsp;</div><div><pre class="prettyprint"   ><div><font size="2"   >processor &nbsp; &nbsp; &nbsp; : 7</font></div><div><font size="2"   >vendor_id &nbsp; &nbsp; &nbsp; : GenuineIntel</font></div><div><font size="2"   >cpu family &nbsp; &nbsp; &nbsp;: 6</font></div><div><font size="2"   >model &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : 23</font></div><div><font size="2"   >model name &nbsp; &nbsp; &nbsp;: Intel(R) Xeon(R) CPU &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; E5405 &nbsp;@ 2.00GHz</font></div><div><font size="2"   >stepping &nbsp; &nbsp; &nbsp; &nbsp;: 6</font></div><div><font size="2"   >cpu MHz &nbsp; &nbsp; &nbsp; &nbsp; : 2000.003</font></div><div><font size="2"   >cache size &nbsp; &nbsp; &nbsp;: 6144 KB</font></div><div><font size="2"   >physical id &nbsp; &nbsp; : 1</font></div><div><font size="2"   >siblings &nbsp; &nbsp; &nbsp; &nbsp;: 4</font></div><div><font size="2"   >core id &nbsp; &nbsp; &nbsp; &nbsp; : 3</font></div><div><font size="2"   >cpu cores &nbsp; &nbsp; &nbsp; : 4</font></div><div><font size="2"   >apicid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: 7</font></div><div><font size="2"   >initial apicid &nbsp;: 7</font></div><div><font size="2"   >fpu &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : yes</font></div><div><font size="2"   >fpu_exception &nbsp; : yes</font></div><div><font size="2"   >cpuid level &nbsp; &nbsp; : 10</font></div><div><font size="2"   >wp &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: yes</font></div><div><font size="2"   >flags &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx lm constant_tsc arch_perfmon pebs bts rep_good aperfmperf pni dtes64 monitor ds_cpl vmx tm2 ssse3 cx16 xtpr pdcm dca sse4_1 lahf_lm dts tpr_shadow vnmi flexpriority</font></div><div><font size="2"   >bogomips &nbsp; &nbsp; &nbsp; &nbsp;: 4000.00</font></div><div><font size="2"   >clflush size &nbsp; &nbsp;: 64</font></div><div><font size="2"   >cache_alignment : 64</font></div><div><font size="2"   >address sizes &nbsp; : 38 bits physical, 48 bits virtual</font></div><div><font size="2"   >power management:</font></div><p></p></pre></div><div><br></div><div>报错如下</div><div><pre class="prettyprint"   ><p><font size="2"   >Host 176 is missing the NX cpu flag. This flag can be enabled via the host BIOS. Please set Disable Execute (XD) for an Intel host, or No Execute (NX) for AMD. &nbsp;Please make sure to completely power off the host for this change to take effect.</font></p></pre></div><div><span style="line-height: 28px;"   >配置如下, nx 配置enable , disable都一样, 每次到配置的最后会自动重启, 并且无法配置虚拟网卡.</span></div><div><div><img title="oVirt host deploy - 德哥@Digoal - PostgreSQL research"   alt="oVirt host deploy - 德哥@Digoal - PostgreSQL research"   style="margin:0 10px 0 0;"   src="http://img1.ph.126.net/33NSmbmDG6kw85DS8_ZraA==/6619429435118506885.png"   ></div><br></div><div>最终的报错信息2条, 貌似是CPU的问题, 少了一个特性 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Host 176 does not comply with the cluster Default networks, the following networks are missing on host: 'ovirtmgmt'</font></div><div><font size="2"   >Host 176 moved to Non-Operational state as host does not meet the cluster's minimum CPU level. Missing CPU features : model_Nehalem</font></div><p></p></pre></div><div>罢了, 用这台老机器来做ovirt-engine节点吧, HOST节点还是用比较给力的CPU.</div><div><br></div><div><br></div><div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.ovirt.org/Quick_Start_Guide"   >http://www.ovirt.org/Quick_Start_Guide</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.ovirt.org/Architecture"   >http://www.ovirt.org/Architecture</a></div></div></div></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="oVirt host deploy - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>