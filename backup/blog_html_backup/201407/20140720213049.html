<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">nginx beginner's guide</h2>
	<h5 id="">2014-07-20 21:30:49&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020146205145554/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>nginx的安装参考</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201461822210354/"   >http://blog.163.com/digoal@126/blog/static/163877040201461822210354/</a></div><div>本文简单的讲一下nginx的使用, 配置文件的结构, 简单的代理服务器的配置, fastcgi的代理配置, 静态页面服务的配置等.</div><div><br></div><div>首先来看一下根据前面提供的安装方法, 编译好之后的nginx HOME目录结构.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-172-16-3-150 ~]# cd /opt/nginx1.6.0/</font></div><div><font size="2"   >[root@db-172-16-3-150 nginx1.6.0]# ll</font></div><div><font size="2"   >total 36</font></div><div><font size="2"   >drwx------ 2 nobody root 4096 Jul 18 20:25 client_body_temp</font></div><div><font size="2"   >drwxr-xr-x 2 root &nbsp; root 4096 Jul 20 16:50 conf</font></div><div><font size="2"   >drwx------ 2 nobody root 4096 Jul 18 20:25 fastcgi_temp</font></div><div><font size="2"   >drwxr-xr-x 2 root &nbsp; root 4096 Jul 18 15:48 html</font></div><div><font size="2"   >drwxr-xr-x 2 root &nbsp; root 4096 Jul 18 23:18 logs</font></div><div><font size="2"   >drwx------ 6 nobody root 4096 Jul 18 23:43 proxy_temp</font></div><div><font size="2"   >drwxr-xr-x 2 root &nbsp; root 4096 Jul 18 22:45 sbin</font></div><div><font size="2"   >drwx------ 2 nobody root 4096 Jul 18 20:25 scgi_temp</font></div><div><font size="2"   >drwx------ 2 nobody root 4096 Jul 18 20:25 uwsgi_temp</font></div><div><font size="2"   >[root@db-172-16-3-150 nginx1.6.0]# cd logs</font></div><div><font size="2"   >[root@db-172-16-3-150 logs]# ll</font></div><div><font size="2"   >total 84</font></div><div><font size="2"   >-rw-r--r-- 1 root root 69856 Jul 20 17:17 access.log</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp; 708 Jul 20 16:50 error.log</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp; &nbsp; 5 Jul 18 23:18 nginx.pid</font></div><div><font size="2"   >[root@db-172-16-3-150 logs]# cd ../conf/</font></div><div><font size="2"   >[root@db-172-16-3-150 conf]# ll</font></div><div><font size="2"   >total 60</font></div><div><font size="2"   >-rw-r--r-- 1 root root 1034 Jul 18 15:48 fastcgi.conf</font></div><div><font size="2"   >-rw-r--r-- 1 root root 1034 Jul 18 22:43 fastcgi.conf.default</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp;964 Jul 18 15:48 fastcgi_params</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp;964 Jul 18 22:43 fastcgi_params.default</font></div><div><font size="2"   >-rw-r--r-- 1 root root 2837 Jul 18 22:43 koi-utf</font></div><div><font size="2"   >-rw-r--r-- 1 root root 2223 Jul 18 22:43 koi-win</font></div><div><font size="2"   >-rw-r--r-- 1 root root 3957 Jul 18 15:48 mime.types</font></div><div><font size="2"   >-rw-r--r-- 1 root root 3957 Jul 18 22:43 mime.types.default</font></div><div><font size="2"   >-rw-r--r-- 1 root root 2765 Jul 20 16:50 nginx.conf</font></div><div><font size="2"   >-rw-r--r-- 1 root root 2656 Jul 18 22:43 nginx.conf.default</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp;596 Jul 18 15:48 scgi_params</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp;596 Jul 18 22:43 scgi_params.default</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp;623 Jul 18 15:48 uwsgi_params</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp;623 Jul 18 22:43 uwsgi_params.default</font></div><div><font size="2"   >-rw-r--r-- 1 root root 3610 Jul 18 22:43 win-utf</font></div><p></p></pre></div><div>默认情况下, nginx的配置文件在conf目录, nginx的日志和pid文件在logs目录.</div><div><br></div><div>接下来简单的说一下主配置文件nginx.conf的结构.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >nginx consists of modules which are controlled by directives specified in the configuration file. Directives are divided into simple directives and block directives. A simple directive consists of the name and parameters separated by spaces and ends with a semicolon (;). A block directive has the same structure as a simple directive, but instead of the semicolon it ends with a set of additional instructions surrounded by braces ({ and }). If a block directive can have other directives inside braces, it is called a context (examples: events, http, server, and location).</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Directives placed in the configuration file outside of any contexts are considered to be in the main context. The events and http directives reside in the main context, server in http, and location in server.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >The rest of a line after the # sign is considered a comment.</font></div><p></p></pre></div><div>配置文件有指令+参数+分号结束 组成; 有些指令如server的参数是一堆其他的指令构成(使用{}, 并且在}后不需要分号结束), 这种称为context, 也就是说server这样的指令称为context.</div><div>配置文件称为main context. 所以写在配置文件最外层(即不在类似server context指令{}包围内) 的指令, 也称为写在main context中.</div><div>例如server指令可以写在main context中, location指令可以写在server context中.</div><div>这样有助于我们看配置说明, 例如 :&nbsp;</div><div><a target="_blank" rel="nofollow" href="http://nginx.org/en/docs/http/ngx_http_core_module.html"   >http://nginx.org/en/docs/http/ngx_http_core_module.html</a></div><div></div><div><pre class="prettyprint"   ><table cellspacing="0"   style="color: rgb(0, 0, 0); font-family: Georgia, serif; line-height: normal;"   ><tbody><tr><th style="padding-left: 0px; padding-right: 0.5em; vertical-align: baseline; font-weight: normal;"   ><font size="2"   >Syntax:</font></th><td style="vertical-align: baseline;"   ><font size="2"   ><code><strong>listen</strong>&nbsp;<code><i>address</i></code>[:<code><i>port</i></code>] [<code>default_server</code>] [<code>ssl</code>] [<code>spdy</code>] [<code>proxy_protocol</code>] [<code>setfib</code>=<code><i>number</i></code>] [<code>fastopen</code>=<code><i>number</i></code>] [<code>backlog</code>=<code><i>number</i></code>] [<code>rcvbuf</code>=<code><i>size</i></code>] [<code>sndbuf</code>=<code><i>size</i></code>] [<code>accept_filter</code>=<code><i>filter</i></code>] [<code>deferred</code>] [<code>bind</code>] [<code>ipv6only</code>=<code>on</code>|<code>off</code>] [<code>so_keepalive</code>=<code>on</code>|<code>off</code>|[<code><i>keepidle</i></code>]:[<code><i>keepintvl</i></code>]:[<code><i>keepcnt</i></code>]];</code><br><code><strong>listen</strong>&nbsp;<code><i>port</i></code>&nbsp;[<code>default_server</code>] [<code>ssl</code>] [<code>spdy</code>] [<code>proxy_protocol</code>] [<code>setfib</code>=<code><i>number</i></code>] [<code>fastopen</code>=<code><i>number</i></code>] [<code>backlog</code>=<code><i>number</i></code>] [<code>rcvbuf</code>=<code><i>size</i></code>] [<code>sndbuf</code>=<code><i>size</i></code>] [<code>accept_filter</code>=<code><i>filter</i></code>] [<code>deferred</code>] [<code>bind</code>] [<code>ipv6only</code>=<code>on</code>|<code>off</code>] [<code>so_keepalive</code>=<code>on</code>|<code>off</code>|[<code><i>keepidle</i></code>]:[<code><i>keepintvl</i></code>]:[<code><i>keepcnt</i></code>]];</code><br><code><strong>listen</strong>&nbsp;<code>unix:</code><code><i>path</i></code>&nbsp;[<code>default_server</code>] [<code>ssl</code>] [<code>spdy</code>] [<code>proxy_protocol</code>] [<code>backlog</code>=<code><i>number</i></code>] [<code>rcvbuf</code>=<code><i>size</i></code>] [<code>sndbuf</code>=<code><i>size</i></code>] [<code>accept_filter</code>=<code><i>filter</i></code>] [<code>deferred</code>] [<code>bind</code>] [<code>so_keepalive</code>=<code>on</code>|<code>off</code>|[<code><i>keepidle</i></code>]:[<code><i>keepintvl</i></code>]:[<code><i>keepcnt</i></code>]];</code><br></font></td></tr><tr><th style="padding-left: 0px; padding-right: 0.5em; vertical-align: baseline; font-weight: normal;"   ><font size="2"   >Default:</font></th><td style="vertical-align: baseline;"   ><pre style="padding: 0px; margin-top: 0px; margin-bottom: 0px;"   ><font size="2"   >listen *:80 | *:8000;</font></pre></td></tr><tr><th style="padding-left: 0px; padding-right: 0.5em; vertical-align: baseline; font-weight: normal;"   ><font size="2"   >Context:</font></th><td style="vertical-align: baseline;"   ><code><font size="2"   >server</font></code></td></tr></table></pre><span style="line-height: 28px;"   >linsten这个指令可以写在server context中.</span></div><div></div><div><pre class="prettyprint"   ><table cellspacing="0"   style="color: rgb(0, 0, 0); font-family: Georgia, serif; line-height: normal;"   ><tbody><tr><th style="padding-left: 0px; padding-right: 0.5em; vertical-align: baseline; font-weight: normal;"   ><font size="2"   >Syntax:</font></th><td style="vertical-align: baseline;"   ><font size="2"   ><code><strong>location</strong>&nbsp;[&nbsp;<code>=</code>&nbsp;|&nbsp;<code>~</code>&nbsp;|&nbsp;<code>~*</code>&nbsp;|&nbsp;<code>^~</code>&nbsp;]&nbsp;<code><i>uri</i></code>&nbsp;{ ... }</code><br><code><strong>location</strong>&nbsp;<code>@</code><code><i>name</i></code>&nbsp;{ ... }</code><br></font></td></tr><tr><th style="padding-left: 0px; padding-right: 0.5em; vertical-align: baseline; font-weight: normal;"   ><font size="2"   >Default:</font></th><td style="vertical-align: baseline;"   ><font size="2"   >―</font></td></tr><tr><th style="padding-left: 0px; padding-right: 0.5em; vertical-align: baseline; font-weight: normal;"   ><font size="2"   >Context:</font></th><td style="vertical-align: baseline;"   ><font size="2"   ><code>server</code>,&nbsp;<code>location</code></font></td></tr></table></pre>location这个指令可以写在server或者location context中.</div><div><br></div><div>一个基本的配置文件例子 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >user nobody; # a directive in the 'main' context</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >events {</font></div><div><font size="2"   >&nbsp; &nbsp; # configuration of events</font></div><div><font size="2"   >}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >http {</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; # Configuration specific to HTTP and affecting all virtual servers</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; server {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; # configuration of virtual server 1</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; location /one {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # configuration for processing URIs with '/one'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; location /two {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; # configuration for processing URIs with '/two'</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div><font size="2"   >&nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; server {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; # configuration of virtual server 2</font></div><div><font size="2"   >&nbsp; &nbsp; }</font></div><div><font size="2"   >}</font></div><p></p></pre></div><div><br></div><div>接下来说一下nginx的进程,&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >nginx has one master process and several worker processes. The main purpose of the master process is to read and evaluate configuration, and maintain worker processes. Worker processes do actual processing of requests. nginx employs event-based model and OS-dependent mechanisms to efficiently distribute requests among worker processes. The number of worker processes is defined in the configuration file and may be fixed for a given configuration or automatically adjusted to the number of available CPU cores (see worker_processes).</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >nginx.conf 配置 :&nbsp;</font></div><div><div><font size="2"   >#user &nbsp;nobody;</font></div><div><font size="2"   >worker_processes &nbsp;1;</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@db-172-16-3-150 conf]# ps -ewf|grep nginx</font></div><div><font size="2"   >root &nbsp; &nbsp; &nbsp;3222 &nbsp; &nbsp; 1 &nbsp;0 Jul18 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 nginx: master process nginx</font></div><div><font size="2"   >nobody &nbsp; 28309 &nbsp;3222 &nbsp;0 16:50 ? &nbsp; &nbsp; &nbsp; &nbsp;00:00:00 nginx: worker process</font></div></div><div><font size="2"   >worker进程1个. 还有一个主进程.</font></div><div><font size="2"   >nginx 主进程负责检查配置文件的正确性, 读取配置文件, 维护work进程(例如reload, stop等).</font></div><div><font size="2"   >worker进程负责处理用户请求.&nbsp;</font></div><p></p></pre></div><div><br></div><div>nginx进程管理, 启动, 重载配置文件, 停止.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >nginx -h</font></div><div><font size="2"   >nginx version: nginx/1.6.0</font></div><div><font size="2"   >Usage: nginx [-?hvVtq] [-s signal] [-c filename] [-p prefix] [-g directives]</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Options:</font></div><div><font size="2"   >&nbsp; -?,-h &nbsp; &nbsp; &nbsp; &nbsp; : this help</font></div><div><font size="2"   >&nbsp; -v &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: show version and exit</font></div><div><font size="2"   >&nbsp; -V &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: show version and configure options then exit</font></div><div><font size="2"   >&nbsp; -t &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: test configuration and exit</font></div><div><font size="2"   >&nbsp; -q &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;: suppress non-error messages during configuration testing</font></div><div><font size="2"   >&nbsp; -s signal &nbsp; &nbsp; : send signal to a master process: stop, quit, reopen, reload</font></div><div><font size="2"   >&nbsp; -p prefix &nbsp; &nbsp; : set prefix path (default: /opt/nginx1.6.0/)</font></div><div><font size="2"   >&nbsp; -c filename &nbsp; : set configuration file (default: conf/nginx.conf)</font></div><div><font size="2"   >&nbsp; -g directives : set global directives out of configuration file</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >To start nginx, run the executable file. Once nginx is started, it can be controlled by invoking the executable with the -s parameter. Use the following syntax:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >nginx -s signal</font></div><div><font size="2"   >Where signal may be one of the following:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >stop ― fast shutdown &nbsp;直接关闭nginx</font></div><div><font size="2"   >quit ― graceful shutdown &nbsp;拒绝新建请求, 同时处理完当前请求后关闭nginx</font></div><div><font size="2"   >reload ― reloading the configuration file 重载配置文件</font></div><div><font size="2"   >reopen ― reopening the log files &nbsp;重新打开日志文件</font></div><div><font size="2"   >For example, to stop nginx processes with waiting for the worker processes to finish serving current requests, the following command can be executed:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >nginx -s quit</font></div><div><font size="2"   >This command should be executed under the same user that started nginx.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Changes made in the configuration file will not be applied until the command to reload configuration is sent to nginx or it is restarted.&nbsp;</font></div><div><font size="2"   >To reload configuration, execute:</font></div><div><font size="2"   >nginx -s reload</font></div><div><font size="2"   >Once the master process receives the signal to reload configuration, it checks the syntax validity of the new configuration file and tries to apply the configuration provided in it. If this is a success, the master process starts new worker processes and sends messages to old worker processes, requesting them to shut down. Otherwise, the master process rolls back the changes and continues to work with the old configuration. Old worker processes, receiving a command to shut down, stop accepting new connections and continue to service current requests until all such requests are serviced. After that, the old worker processes exit.</font></div><div><font size="2"   >或者直接给nginx进程发出信号, 例如QUIT信号, 相当于-s quit.</font></div><div><font size="2"   >A signal may also be sent to nginx processes with the help of Unix tools such as the kill utility. In this case a signal is sent directly to a process with a given process ID. The process ID of the nginx master process is written, by default, to the nginx.pid in the directory /usr/local/nginx/logs or /var/run. For example, if the master process ID is 1628, to send the QUIT signal resulting in nginx’s graceful shutdown, execute:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >kill -s QUIT 1628</font></div><div><font size="2"   >For getting the list of all running nginx processes, the ps utility may be used, for example, in the following way:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >ps -ax | grep nginx</font></div><div><font size="2"   >For more information on sending signals to nginx, see Controlling nginx.</font></div></div><div><font size="2"   ><span style="line-height: 21px;"   >nginx对信号的处理见</span></font></div><div><a target="_blank" rel="nofollow" href="http://nginx.org/en/docs/control.html"   ><font size="2"   >http://nginx.org/en/docs/control.html</font></a></div><p></p></pre></div><div><br></div><div>nginx作为静态页面网站server的配置例子.</div><div>nginx处理请求的简要步骤 :&nbsp;</div><div>1. 首先是nginx server配置的监听, 客户端从dns解析出被请求的域名对应的IP. 客户端向这个IP和指定的端口(http 默认是80)发出相应的HTTP请求, 例如 http://dba.sky-mobi.com/index.html.</div><div>例如nginx server配置 监听 0.0.0.0:80</div><div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >&nbsp; &nbsp; server {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; listen &nbsp; &nbsp; &nbsp; 0.0.0.0:80;</font></div></div><div></div><p></p></pre></div></div><div>2. 然后匹配server_name</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; server {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; listen &nbsp; &nbsp; &nbsp; 0.0.0.0:80;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; server_name &nbsp;dba.sky-mobi.com;</font></div><p></p></pre></div><div>因为同一个nginx可以配置同样的监听, 不同的server_name, 来为多个域名服务. 例如 :&nbsp;</div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; server {</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; listen &nbsp; &nbsp; &nbsp; 0.0.0.0:80;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; server_name &nbsp;dba.sky-mobi.com;</font></div></div><div style="line-height: 28px;"   ><font size="2"   >...</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; server {</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; listen &nbsp; &nbsp; &nbsp; 0.0.0.0:80;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; server_name &nbsp;www.sky-mobi.com default_server;</font></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   >...</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div></div></div><p></p></pre></div></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><div style="line-height: 28px;"   >也就是说<span style="line-height: 28px;"   >dba.sky-mobi.com和</span><span style="line-height: 28px;"   >www.sky-mobi.com都在这台主机上, 域名解析都解析到这台主机, nginx server只有从客户端发送的http请求的HOST信息来分辨如何处理.&nbsp;</span></div><div style="line-height: 28px;"   ><br></div></div></div><div>3. 如果没有匹配的server_name选择默认server_name, 例如我们请求的是abc.sky-mobi.com, 如果域名也解析到了这台主机, 但是这台主机的nginx值配置了www和dba.sky-mobi.com这两个server_name 的话, 其他的客户端请求的HOST就都会发到默认的server_name, 也就是<span style="line-height: 28px;"   >server_name &nbsp;www.sky-mobi.com default_server; &nbsp;# default_server指定默认server_name.</span></div><div><span style="line-height: 28px;"   >如果配置文件中没有指定默认server_name选择nginx.conf中第一个server作为目标server来处理客户端请求.</span></div><div><span style="line-height: 28px;"   ><br></span></div><div>4. 在匹配到具体的server后, 开始匹配server context中配置的 location .</div><div>即客户端请求的URI和location的匹配.</div><div>location的匹配顺序.</div><div>(精确, 规则表达式匹配, longest prefix匹配)</div><div>location语法</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Syntax:<span>	</span>location [ = | ~ | ~* | ^~ ] uri { ... }</font></div><div><font size="2"   >location @name { ... }</font></div><div><font size="2"   >Default:<span>	</span>―</font></div><div><font size="2"   >Context:<span>	</span>server, location</font></div><p></p></pre></div><div><pre class="prettyprint"   ><p><font size="2"   >A location can either be defined by a prefix string, or by a regular expression. Regular expressions are specified with the preceding “~*” modifier (for case-insensitive matching), or the “~” modifier (for case-sensitive matching).&nbsp;</font></p></pre></div><div>location只有两种匹配规则, prefix string(不加任何modifier或者加=, ^~ modifier)和规则表达式(加modifier ~或~*)</div><div>=表示精确的prefix string URI匹配.</div><div>^~表示如果这个location最终是longest location, 那么将不继续检查规则表达式, 直接用这个location处理客户端请求.</div><div>没有任何modifier是普通的prefix string URI匹配.</div><div>~和~*是规则表达式匹配, ~*忽略大小写.</div><div><br></div><div>规则 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Higher priority is given to regular expressions, unless the “^~” modifier is used. Among the prefix strings NGINX selects the most specific one (that is, the longest and most complete string). The exact logic for selecting a location to process a request is given below:</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >1. Test the URI against all prefix strings.</font></div><div><font size="2"   >2. The “=” modifier defines an exact match of the URI and a prefix string. If the exact match is found, the search stops.</font></div><div><font size="2"   >3. If the “^~” modifier prepends the longest matching prefix string, the regular expressions are not checked.</font></div><div><font size="2"   >4. Store the longest matching prefix string.</font></div><div><font size="2"   >5. Start testing the URI against regular expressions.</font></div><div><font size="2"   >6. Break on the first matching regular expression and use the corresponding location.</font></div><div><font size="2"   >7. If no regular expression matches, use the location corresponding to the stored prefix string.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >A typical example of using the “=” modifier is with the usage of “/”. If the “/” request needs to be served often, specifying the location parameter as “= /” will speed up processing of these requests. As noted above, this is due to the search being stopped after the first comparison.</font></div><p></p></pre></div><div>因为server中可以配置很多的location, 那么如果有多个location都能匹配一个URI的话, 最终是由哪个location来处理呢? 规则:</div><div>1. 首先测试URI和所有的prefix string.</div><div>2. 如果prefix string匹配过程中有= modifier的location匹配成功, 则直接使用这个location处理客户端请求.&nbsp;<span style="line-height: 28px;"   >不必继续匹配location</span>.</div><div>3. 如果prefix string匹配完成后, 最长的匹配到的location带有^~ modifier, 则这个location处理客户端请求. 不必继续匹配location.</div><div>4. 如果没有= location匹配成功, 并且匹配成功的longest location没有^~ modifier, 则存储这个longest location.</div><div>5. 开始匹配规则表达式类型的location.</div><div>6. 如果规则表达式类型的location匹配成功, 则使用这个location, 并且不必继续匹配其他规则表达式location.</div><div>7. 如果所有的规则表达式locatio都匹配不成功, 则使用存储的longest location.</div><div><br></div><div>根据location context中配置的root, 在服务器上找到响应的文件或页面返回给client.</div><div>如果location中配置了rewrite, 代理的话, 则处理响应的rewrite和proxy pass.</div><div><br></div><div>配置的继承和覆盖.</div><div><pre class="prettyprint"   ><p><font size="2"   >In most cases, a context that is defined inside another context will inherits its directives. When that happens, and you then declare the the same directive on the current level, the directive on the current level will override the inherited one. For more information on context inheritence see the proxy_set_header documentation.</font></p></pre></div><div>8. 根据location中配置的root, 找到相应的静态页面.</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >server {</font></div><div><font size="2"   >&nbsp; &nbsp; location / {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; root /data/www;</font></div><div><font size="2"   >&nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; location /images/ {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; root /data;</font></div><div><font size="2"   >&nbsp; &nbsp; }</font></div><div><font size="2"   >}</font></div></div><div><font size="2"   >This is already a working configuration of a server that listens on the standard port 80 and is accessible on the local machine at http://localhost/.&nbsp;</font></div><div><font size="2"   >In response to requests with URIs starting with /images/, the server will send files from the /data/images directory. For example, in response to the http://localhost/images/example.png request nginx will send the /data/images/example.png file.&nbsp;</font></div><div><font size="2"   >If such file does not exist, nginx will send a response indicating the 404 error. Requests with URIs not starting with /images/ will be mapped onto the /data/www directory.&nbsp;</font></div><div><font size="2"   >For example, in response to the http://localhost/some/example.html request nginx will send the /data/www/some/example.html file.</font></div><p></p></pre></div><div>返回root+URI</div><div>例如&nbsp;<span style="line-height: 28px;"   >http://localhost/images/example.png</span></div><div>URI&nbsp;<span style="line-height: 28px;"   >/images/example.png 匹配到longest&nbsp;</span><span style="line-height: 28px;"   >location /images/, &nbsp;返回</span><span style="line-height: 28px;"   >/data+</span><span style="line-height: 28px;"   >/images/example.png即</span><span style="line-height: 28px;"   >/data</span><span style="line-height: 28px;"   >/images/example.png</span></div><div><span style="line-height: 28px;"   ><br></span></div><div>接下来聊一下简单的HTTP代理设置, 顾名思义, 将客户端请求发送到其他服务, 从其他服务返回的数据, 在转发给客户端.</div><div>客户端不与其他服务器直接传输数据, 数据由nginx代为中转.</div><div>http代理设置需要proxy_pass指令配置, 语法如下 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Syntax:<span>	</span>proxy_pass URL;</font></div><div><font size="2"   >Default:<span>	</span>―</font></div><div><font size="2"   >Context:<span>	</span>location, if in location, limit_except</font></div><p></p></pre></div><div><pre class="prettyprint"   ><p></p><p style="text-align: justify; font-family: Georgia, serif; line-height: normal;"   ><font size="2"   >Sets the protocol and address of a proxied server and an optional URI to which a location should be mapped. As a protocol, “<code>http</code>” or “<code>https</code>” can be specified. The address can be specified as a domain name or IP address, and an optional port:</font></p><blockquote style="margin-top: 1em; margin-bottom: 1em; margin-left: 1em; padding: 0.5em; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(187, 187, 187); font-family: Georgia, serif; line-height: normal;"   ><pre style="padding: 0px; margin-top: 0px; margin-bottom: 0px;"   ><font size="2"   >proxy_pass http://localhost:8000/uri/;
</font></pre></blockquote><p style="text-align: justify; font-family: Georgia, serif; line-height: normal;"   ><font size="2"   >or as a UNIX-domain socket path specified after the word “<code>unix</code>” and enclosed in colons:</font></p><blockquote style="margin-top: 1em; margin-bottom: 1em; margin-left: 1em; padding: 0.5em; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(187, 187, 187); font-family: Georgia, serif; line-height: normal;"   ><pre style="padding: 0px; margin-top: 0px; margin-bottom: 0px;"   ><font size="2"   >proxy_pass http://unix:/tmp/backend.socket:/uri/;
</font></pre></blockquote><p style="text-align: justify; font-family: Georgia, serif; line-height: normal;"   ></p><p style="text-align: justify; font-family: Georgia, serif; line-height: normal;"   ><font size="2"   >If a domain name resolves to several addresses, all of them will be used in a round-robin fashion. In addition, an address can be specified as a&nbsp;<a rel="nofollow" href="http://nginx.org/en/docs/http/ngx_http_upstream_module.html"   >server group</a>.</font></p><p style="text-align: justify; font-family: Georgia, serif; line-height: normal;"   ><font size="2"   >A request URI is passed to the server as follows:</font></p><ul style="margin-top: 0.5em; margin-bottom: 1em; margin-left: 1em; padding-right: 0.5em; padding-left: 0.5em; font-family: Georgia, serif; line-height: normal;"   ><li style="text-align: justify; padding: 0.5em 0px 0px 1px;"   ><font size="2"   >If the&nbsp;<code>proxy_pass</code>&nbsp;directive is specified with a URI, then when a request is passed to the server, the part of a&nbsp;<a rel="nofollow" href="http://nginx.org/en/docs/http/ngx_http_core_module.html#location"   >normalized</a>request URI matching the location is replaced by a URI specified in the directive:</font><blockquote style="margin-top: 0.7em; margin-bottom: 0.7em; margin-left: 0px; padding: 0.5em; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(187, 187, 187);"   ><pre style="padding: 0px; margin-top: 0px; margin-bottom: 0px;"   ><font size="2"   >location /name/ {
    proxy_pass http://127.0.0.1/remote/;
}
</font></pre></blockquote></li><li style="text-align: justify; padding: 0.5em 0px 0px 1px;"   ><font size="2"   >If&nbsp;<code>proxy_pass</code>&nbsp;is specified without a URI, the request URI is passed to the server in the same form as sent by a client when the original request is processed, or the full normalized request URI is passed when processing the changed URI:</font><blockquote style="margin-top: 0.7em; margin-bottom: 0.7em; margin-left: 0px; padding: 0.5em; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(187, 187, 187);"   ><pre style="padding: 0px; margin-top: 0px; margin-bottom: 0px;"   ><font size="2"   >location /some/path/ {
    proxy_pass http://127.0.0.1;
}
</font></pre></blockquote><blockquote style="margin-top: 0.7em; margin-bottom: 0.7em; margin-left: 0px; padding: 0.5em; border: 1px dotted rgb(153, 153, 153);"   ><font size="2"   >Before version 1.1.12, if&nbsp;<code>proxy_pass</code>&nbsp;is specified without a URI, the original request URI might be passed instead of the changed URI in some cases.</font></blockquote></li></ul><p style="text-align: justify; font-family: Georgia, serif; line-height: normal;"   ></p><p style="text-align: justify; font-family: Georgia, serif; line-height: normal;"   ><font size="2"   >In some cases, the part of a request URI to be replaced cannot be determined:</font></p><ul style="margin-top: 0.5em; margin-bottom: 1em; margin-left: 1em; padding-right: 0.5em; padding-left: 0.5em; font-family: Georgia, serif; line-height: normal;"   ><li style="text-align: justify; padding: 0.5em 0px 0px 1px;"   ><font size="2"   >When location is specified using a regular expression.</font><p><font size="2"   >In this case, the directive should be specified without a URI.</font></p></li><li style="text-align: justify; padding: 0.5em 0px 0px 1px;"   ><font size="2"   >When the URI is changed inside a proxied location using the&nbsp;<a rel="nofollow" href="http://nginx.org/en/docs/http/ngx_http_rewrite_module.html#rewrite"   >rewrite</a>&nbsp;directive, and this same configuration will be used to process a request (<code>break</code>):</font><blockquote style="margin-top: 0.7em; margin-bottom: 0.7em; margin-left: 0px; padding: 0.5em; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(187, 187, 187);"   ><pre style="padding: 0px; margin-top: 0px; margin-bottom: 0px;"   ><font size="2"   >location /name/ {
    rewrite    /name/([^/]+) /users?name=$1 break;
    proxy_pass http://127.0.0.1;
}
</font></pre></blockquote><p><font size="2"   >In this case, the URI specified in the directive is ignored and the full changed request URI is passed to the server.</font></p></li></ul><p style="text-align: justify; font-family: Georgia, serif; line-height: normal;"   ></p><p style="text-align: justify; font-family: Georgia, serif; line-height: normal;"   ><font size="2"   >A server name, its port and the passed URI can also be specified using variables:</font></p><blockquote style="margin-top: 1em; margin-bottom: 1em; margin-left: 1em; padding: 0.5em; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(187, 187, 187); font-family: Georgia, serif; line-height: normal;"   ><pre style="padding: 0px; margin-top: 0px; margin-bottom: 0px;"   ><font size="2"   >proxy_pass http://$host$uri;
</font></pre></blockquote><p style="text-align: justify; font-family: Georgia, serif; line-height: normal;"   ><font size="2"   >or even like this:</font></p><blockquote style="margin-top: 1em; margin-bottom: 1em; margin-left: 1em; padding: 0.5em; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(187, 187, 187); font-family: Georgia, serif; line-height: normal;"   ><pre style="padding: 0px; margin-top: 0px; margin-bottom: 0px;"   ><font size="2"   >proxy_pass $request;
</font></pre></blockquote><p style="text-align: justify; font-family: Georgia, serif; line-height: normal;"   ></p><p style="text-align: justify; font-family: Georgia, serif; line-height: normal;"   ><font size="2"   >In this case, the server name is searched among the described&nbsp;<a rel="nofollow" href="http://nginx.org/en/docs/http/ngx_http_upstream_module.html"   >server groups</a>, and, if not found, is determined using a&nbsp;<a rel="nofollow" href="http://nginx.org/en/docs/http/ngx_http_core_module.html#resolver"   >resolver</a>.</font></p><p style="text-align: justify; font-family: Georgia, serif; line-height: normal;"   ><font size="2"   ><a rel="nofollow" href="http://nginx.org/en/docs/http/websocket.html"   >WebSocket</a>&nbsp;proxying requires special configuration and is supported since version 1.3.13.</font></p><p></p></pre></div><div><span style="line-height: 28px;"   >完整的http代理相关指令参考</span></div><div><a target="_blank" rel="nofollow" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html"   >http://nginx.org/en/docs/http/ngx_http_proxy_module.html</a></div><div><br></div><div><br></div><div>http代理配置例子:&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >server {</font></div><div><font size="2"   >&nbsp; &nbsp; listen 8080;</font></div><div><font size="2"   >&nbsp; &nbsp; root /data/up1;</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; location / {</font></div><div><font size="2"   >&nbsp; &nbsp; }</font></div><div><font size="2"   >}</font></div></div><div><div><font size="2"   >server {</font></div><div><font size="2"   >&nbsp; &nbsp; location / {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; proxy_pass http://localhost:8080/;</font></div><div><font size="2"   >&nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; location ~ \.(gif|jpg|png)$ {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; root /data/images;</font></div><div><font size="2"   >&nbsp; &nbsp; }</font></div><div><font size="2"   >}</font></div></div><p></p></pre></div><div>以上nginx配置了2个server, 第二个server监听没有配置, 使用了标准端口80.</div><div>客户端请求http://domain/xxx/xx...., nginx将匹配</div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; location / {</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; proxy_pass http://localhost:8080/;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; }</font></div><p></p></pre></div></div><div style="line-height: 28px;"   >作为代理, 请求转发给<span style="line-height: 28px;"   >http://localhost:8080/</span></div><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   ><span style="line-height: 28px;"   >http://localhost:8080/</span><span style="line-height: 28px;"   >xxx/xx....</span></font></div><div style="line-height: 28px;"   ></div><p></p></pre><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >也就是</span></div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >server {</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; listen 8080;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; root /data/up1;</font></div><div style="line-height: 28px;"   ><font size="2"   ><br style="line-height: 28px;"   ></font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; location / {</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; }</font></div><div style="line-height: 28px;"   ><font size="2"   >}</font></div><p></p></pre></div><div style="line-height: 28px;"   >从<span style="line-height: 28px;"   >&nbsp;</span><span style="line-height: 28px;"   >/data/up1</span><span style="line-height: 28px;"   >/</span><span style="line-height: 28px;"   >xxx/xx....取数据, 再有代理返回给客户端.</span></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >如果客户端请求的是</span><span style="line-height: 28px;"   >\.(gif|jpg|png)结尾的url, 将</span></div></div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; location ~ \.(gif|jpg|png)$ {</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; root /data/images;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; }</font></div><p></p></pre></div><div style="line-height: 28px;"   >例如返回&nbsp;<span style="line-height: 28px;"   >/data/images/xxx/xxx.gif .</span></div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >FastCGI代理, 详细配置项参见 :&nbsp;</div><div><a target="_blank" rel="nofollow" href="http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html"   >http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html</a></div><div><div style="margin: 1em 0px 1em -1em; padding: 0.7em 0.7em 0.7em 1em; border-top-width: 2px; border-top-style: solid; border-top-color: rgb(221, 221, 221); font-family: Georgia, serif; font-size: medium; line-height: normal; background: rgb(242, 242, 242);"   ><table cellspacing="0"   ><tbody><tr><th style="padding-left: 0px; padding-right: 0.5em; vertical-align: baseline; font-weight: normal;"   >Syntax:</th><td style="vertical-align: baseline;"   ><code><strong>fastcgi_pass</strong>&nbsp;<code><i>address</i></code>;</code><br></td></tr><tr><th style="padding-left: 0px; padding-right: 0.5em; vertical-align: baseline; font-weight: normal;"   >Default:</th><td style="vertical-align: baseline;"   >―</td></tr><tr><th style="padding-left: 0px; padding-right: 0.5em; vertical-align: baseline; font-weight: normal;"   >Context:</th><td style="vertical-align: baseline;"   ><code>location</code>,&nbsp;<code>if in location</code><br></td></tr></table></div><p style="text-align: justify; font-family: Georgia, serif; font-size: medium; line-height: normal;"   >Sets the address of a FastCGI server. The address can be specified as a domain name or IP address, and an optional port:</p><blockquote style="margin-top: 1em; margin-bottom: 1em; margin-left: 1em; padding: 0.5em; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(187, 187, 187); font-family: Georgia, serif; font-size: medium; line-height: normal;"   ><pre style="padding: 0px; margin-top: 0px; margin-bottom: 0px;"   >fastcgi_pass localhost:9000;
</pre></blockquote><p style="text-align: justify; font-family: Georgia, serif; font-size: medium; line-height: normal;"   >or as a UNIX-domain socket path:</p><blockquote style="margin-top: 1em; margin-bottom: 1em; margin-left: 1em; padding: 0.5em; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(187, 187, 187); font-family: Georgia, serif; font-size: medium; line-height: normal;"   ><pre style="padding: 0px; margin-top: 0px; margin-bottom: 0px;"   >fastcgi_pass unix:/tmp/fastcgi.socket;
</pre></blockquote><p style="text-align: justify; font-family: Georgia, serif; font-size: medium; line-height: normal;"   ></p><p style="text-align: justify; font-family: Georgia, serif; font-size: medium; line-height: normal;"   >If a domain name resolves to several addresses, all of them will be used in a round-robin fashion. In addition, an address can be specified as a&nbsp;<a rel="nofollow" href="http://nginx.org/en/docs/http/ngx_http_upstream_module.html"   >server group</a>.</p></div><div><div style="margin: 1em 0px 1em -1em; padding: 0.7em 0.7em 0.7em 1em; border-top-width: 2px; border-top-style: solid; border-top-color: rgb(221, 221, 221); font-family: Georgia, serif; font-size: medium; line-height: normal; background: rgb(242, 242, 242);"   ><table cellspacing="0"   ><tbody><tr><th style="padding-left: 0px; padding-right: 0.5em; vertical-align: baseline; font-weight: normal;"   >Syntax:</th><td style="vertical-align: baseline;"   ><code><strong>fastcgi_param</strong>&nbsp;<code><i>parameter</i></code>&nbsp;<code><i>value</i></code>&nbsp;[<code>if_not_empty</code>];</code><br></td></tr><tr><th style="padding-left: 0px; padding-right: 0.5em; vertical-align: baseline; font-weight: normal;"   >Default:</th><td style="vertical-align: baseline;"   >―</td></tr><tr><th style="padding-left: 0px; padding-right: 0.5em; vertical-align: baseline; font-weight: normal;"   >Context:</th><td style="vertical-align: baseline;"   ><code>http</code>,&nbsp;<code>server</code>,&nbsp;<code>location</code><br></td></tr></table></div><p style="text-align: justify; font-family: Georgia, serif; font-size: medium; line-height: normal;"   >Sets a&nbsp;<code><i>parameter</i></code>&nbsp;that should be passed to the FastCGI server. The&nbsp;<code><i>value</i></code>&nbsp;can contain text, variables, and their combination. These directives are inherited from the previous level if and only if there are no&nbsp;<code>fastcgi_param</code>&nbsp;directives defined on the current level.</p><p style="text-align: justify; font-family: Georgia, serif; font-size: medium; line-height: normal;"   >The following example shows the minimum required settings for PHP:</p><blockquote style="margin-top: 1em; margin-bottom: 1em; margin-left: 1em; padding: 0.5em; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(187, 187, 187); font-family: Georgia, serif; font-size: medium; line-height: normal;"   ><pre style="padding: 0px; margin-top: 0px; margin-bottom: 0px;"   >fastcgi_param SCRIPT_FILENAME /home/www/scripts/php$fastcgi_script_name;
fastcgi_param QUERY_STRING    $query_string;
</pre></blockquote><p style="text-align: justify; font-family: Georgia, serif; font-size: medium; line-height: normal;"   ></p><p style="text-align: justify; font-family: Georgia, serif; font-size: medium; line-height: normal;"   >The&nbsp;<code>SCRIPT_FILENAME</code>&nbsp;parameter is used in PHP for determining the script name, and the&nbsp;<code>QUERY_STRING</code>&nbsp;parameter is used to pass request parameters.</p><p style="text-align: justify; font-family: Georgia, serif; font-size: medium; line-height: normal;"   >For scripts that process&nbsp;<code>POST</code>&nbsp;requests, the following three parameters are also required:</p><blockquote style="margin-top: 1em; margin-bottom: 1em; margin-left: 1em; padding: 0.5em; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(187, 187, 187); font-family: Georgia, serif; font-size: medium; line-height: normal;"   ><pre style="padding: 0px; margin-top: 0px; margin-bottom: 0px;"   >fastcgi_param REQUEST_METHOD  $request_method;
fastcgi_param CONTENT_TYPE    $content_type;
fastcgi_param CONTENT_LENGTH  $content_length;
</pre></blockquote><p style="text-align: justify; font-family: Georgia, serif; font-size: medium; line-height: normal;"   ></p><p style="text-align: justify; font-family: Georgia, serif; font-size: medium; line-height: normal;"   >If PHP was built with the&nbsp;<code>--enable-force-cgi-redirect</code>&nbsp;configuration parameter, the&nbsp;<code>REDIRECT_STATUS</code>&nbsp;parameter should also be passed with the value “200”:</p><blockquote style="margin-top: 1em; margin-bottom: 1em; margin-left: 1em; padding: 0.5em; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(187, 187, 187); font-family: Georgia, serif; font-size: medium; line-height: normal;"   ><pre style="padding: 0px; margin-top: 0px; margin-bottom: 0px;"   >fastcgi_param REDIRECT_STATUS 200;
</pre></blockquote><p style="text-align: justify; font-family: Georgia, serif; font-size: medium; line-height: normal;"   ></p><p style="text-align: justify; font-family: Georgia, serif; font-size: medium; line-height: normal;"   >If a directive is specified with&nbsp;<code>if_not_empty</code>&nbsp;(1.1.11) then such a parameter will not be passed to the server until its value is not empty:</p><blockquote style="margin-top: 1em; margin-bottom: 1em; margin-left: 1em; padding: 0.5em; border-left-width: 1px; border-left-style: solid; border-left-color: rgb(187, 187, 187); font-family: Georgia, serif; font-size: medium; line-height: normal;"   ><pre style="padding: 0px; margin-top: 0px; margin-bottom: 0px;"   >fastcgi_param HTTPS           $https if_not_empty;</pre></blockquote></div><div>变量:&nbsp;</div><div><a target="_blank" rel="nofollow" href="http://nginx.org/en/docs/http/ngx_http_core_module.html#var_document_root"   >http://nginx.org/en/docs/http/ngx_http_core_module.html#var_document_root</a></div><div><a target="_blank" rel="nofollow" href="http://nginx.org/en/docs/varindex.html"   >http://nginx.org/en/docs/varindex.html</a></div><div><br></div><div>fastcgi的配置, 主要需要配置 fastcgi_pass 和<span style="line-height: 28px;"   >fastcgi_param</span><span style="line-height: 28px;"   >&nbsp;.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >nginx can be used to route requests to FastCGI servers which run applications built with various frameworks and programming languages such as PHP.</font></div><div><font size="2"   >The most basic nginx configuration to work with a FastCGI server includes using the fastcgi_pass directive instead of the proxy_pass directive, and fastcgi_param directives to set parameters passed to a FastCGI server.&nbsp;</font></div><div><font size="2"   >Suppose the FastCGI server is accessible on localhost:9000. Taking the proxy configuration from the previous section as a basis, replace the proxy_pass directive with the fastcgi_pass directive and change the parameter to localhost:9000.&nbsp;</font></div><div><font size="2"   >In PHP, the SCRIPT_FILENAME parameter is used for determining the script name, and the QUERY_STRING parameter is used to pass request parameters. The resulting configuration would be:</font></div><div><font size="2"   >server {</font></div><div><font size="2"   >&nbsp; &nbsp; location / {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fastcgi_pass &nbsp;localhost:9000;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; fastcgi_param QUERY_STRING &nbsp; &nbsp;$query_string;</font></div><div><font size="2"   >&nbsp; &nbsp; }</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; location ~ \.(gif|jpg|png)$ {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; root /data/images;</font></div><div><font size="2"   >&nbsp; &nbsp; }</font></div><div><font size="2"   >}</font></div><div><font size="2"   >This will set up a server that will route all requests except for requests for static images to the proxied server operating on localhost:9000 through the FastCGI protocol.</font></div><p></p></pre></div><div>还有一个例子, 以.php结尾的文件交给fastcgi处理, 例如php-fpm :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; #</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; #location ~ \.php$ {</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; &nbsp;root &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; html;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; &nbsp;fastcgi_pass &nbsp; 127.0.0.1:9000;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; &nbsp;fastcgi_index &nbsp;index.php;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; &nbsp;fastcgi_param &nbsp;SCRIPT_FILENAME &nbsp;/scripts$fastcgi_script_name;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; # &nbsp; &nbsp;include &nbsp; &nbsp; &nbsp; &nbsp;fastcgi_params;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; #}</font></div><p></p></pre></div><div><br></div><div style="line-height: 28px;"   ><br></div></div><div>[参考]<wbr><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://nginx.org/en/docs/beginners_guide.html"   >http://nginx.org/en/docs/beginners_guide.html</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201461822210354/"   >http://blog.163.com/digoal@126/blog/static/163877040201461822210354/</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://nginx.org/en/docs/http/ngx_http_core_module.html"   >http://nginx.org/en/docs/http/ngx_http_core_module.html</a></div><div>4.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://nginx.org/en/docs/control.html"   >http://nginx.org/en/docs/control.html</a></div><div>5.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html"   >http://nginx.org/en/docs/http/ngx_http_proxy_module.html</a></div><div>6.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html"   >http://nginx.org/en/docs/http/ngx_http_fastcgi_module.html</a></div><div>7.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://nginx.org/en/docs/http/ngx_http_core_module.html#var_document_root"   >http://nginx.org/en/docs/http/ngx_http_core_module.html#var_document_root</a></div><div>8.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://nginx.org/en/docs/varindex.html"   >http://nginx.org/en/docs/varindex.html<br></a><span style="line-height: 28px;"   >
</span><a style="line-height: 28px;" rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="nginx beginners guide - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div></div></div>
	</div>
</div>
</body>
</html>