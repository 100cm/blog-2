<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Use pgbouncer connect to GreenPlum's segment node</h2>
	<h5 id="">2012-01-13 9:00:20&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020120138306999/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>pgbouncer是PostgreSQL数据库的轻量级开源连接池，有着非常好的性能。</div><div>源码修改部分来自老唐(osdba)写的一篇BLOG，《让pgbouncer可以连接到greenplum的segment上》本文末尾有链接。</div><div>下面参照他在BLOG中提到的方法测试了一下，测试如下 :&nbsp;</div><div>软件准备 :&nbsp;</div><div>1. greenplum环境(本例使用的是3.3.3.4) ,</div><div>2. pgbouncer 1.4.2</div><div>3. libevent 2.0</div><div><br></div><div>操作过程 :&nbsp;</div><div>1. 安装libevent :&nbsp;</div><div><div>tar -zxvf libevent-2.0.16-stable.tar.gz&nbsp;</div><div>cd libevent-2.0.16-stable</div><div>./configure &amp;&amp; make &amp;&amp; make install</div></div><div><br></div><div>2. 修改pgbouncer源码, 参考osdba的BLOG :&nbsp;</div><div><div>修改src/client.c, (新增第127, 128行)增加对options的支持:&nbsp;</div><div>123 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else if (varcache_set(&amp;client-&gt;vars, key, val)) {</div><div>124 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slog_debug(client, "got var: %s=%s", key, val);</div><div>125 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else if (strlist_contains(cf_ignore_startup_params, key)) {</div><div>126 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slog_debug(client, "ignoring startup parameter: %s=%s", key, val);</div><div># add start point</div><div>127 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else if (strcmp(key,"options") == 0 ) {</div><div>128 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slog_debug(client, "ignoring startup parameter: %s=%s", key, val);</div><div># add stop point</div><div>129 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else {</div><div>130 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; slog_warning(client, "unsupported startup parameter: %s=%s", key, val);</div><div>131 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; disconnect_client(client, true, "Unsupported startup parameter: %s", key);</div><div>132 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return false;</div><div>133 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</div><div>&nbsp;</div><div>修改src/loader.c文件(新增第192,238-239,348-351行):</div><div>172 bool parse_database(void *base, const char *name, const char *connstr)</div><div>173 {</div><div>174 &nbsp; &nbsp; &nbsp; &nbsp; char *p, *key, *val;</div><div>175 &nbsp; &nbsp; &nbsp; &nbsp; PktBuf *msg;</div><div>176 &nbsp; &nbsp; &nbsp; &nbsp; PgDatabase *db;</div><div>177 &nbsp; &nbsp; &nbsp; &nbsp; int pool_size = -1;</div><div>178 &nbsp; &nbsp; &nbsp; &nbsp; int res_pool_size = -1;</div><div>179 &nbsp; &nbsp; &nbsp; &nbsp; int dbname_ofs;</div><div>180&nbsp;</div><div>181 &nbsp; &nbsp; &nbsp; &nbsp; char *tmp_connstr;</div><div>182 &nbsp; &nbsp; &nbsp; &nbsp; const char *dbname = name;</div><div>183 &nbsp; &nbsp; &nbsp; &nbsp; char *host = NULL;</div><div>184 &nbsp; &nbsp; &nbsp; &nbsp; char *port = "5432";</div><div>185 &nbsp; &nbsp; &nbsp; &nbsp; char *username = NULL;</div><div>186 &nbsp; &nbsp; &nbsp; &nbsp; char *password = "";</div><div>187 &nbsp; &nbsp; &nbsp; &nbsp; char *client_encoding = NULL;</div><div>188 &nbsp; &nbsp; &nbsp; &nbsp; char *datestyle = NULL;</div><div>189 &nbsp; &nbsp; &nbsp; &nbsp; char *timezone = NULL;</div><div>190 &nbsp; &nbsp; &nbsp; &nbsp; char *connect_query = NULL;</div><div>191 &nbsp; &nbsp; &nbsp; &nbsp; char *appname = NULL;</div><div># add start point</div><div>192 &nbsp; &nbsp; &nbsp; &nbsp; char *options = NULL;</div><div># add stop point</div><div>.....</div><div>206 &nbsp; &nbsp; &nbsp; &nbsp; while (*p) {</div><div>207 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; p = cstr_get_pair(p, &amp;key, &amp;val);</div><div>208 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (p == NULL) {</div><div>209 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; log_error("%s: syntax error in connstring", name);</div><div>210 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; goto fail;</div><div>211 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else if (!key[0])</div><div>212 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; break;</div><div>213&nbsp;</div><div>214 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (strcmp("dbname", key) == 0)</div><div>215 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dbname = val;</div><div>216 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (strcmp("host", key) == 0)</div><div>217 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; host = val;</div><div>218 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (strcmp("port", key) == 0)</div><div>219 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; port = val;</div><div>220 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (strcmp("user", key) == 0)</div><div>221 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; username = val;</div><div>222 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (strcmp("password", key) == 0)</div><div>223 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; password = val;</div><div>224 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (strcmp("client_encoding", key) == 0)</div><div>225 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; client_encoding = val;</div><div>226 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (strcmp("datestyle", key) == 0)</div><div>227 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; datestyle = val;</div><div>228 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (strcmp("timezone", key) == 0)</div><div>229 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; timezone = val;</div><div>230 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (strcmp("pool_size", key) == 0)</div><div>231 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pool_size = atoi(val);</div><div>232 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (strcmp("reserve_pool", key) == 0)</div><div>233 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; res_pool_size = atoi(val);</div><div>234 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (strcmp("connect_query", key) == 0)</div><div>235 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; connect_query = val;</div><div>236 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (strcmp("application_name", key) == 0)</div><div>237 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; appname = val;</div><div># add start point</div><div>238 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if (strcmp("options", key) == 0)</div><div>239 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; options = val;</div><div># add stop point</div><div>.....</div><div>343 &nbsp; &nbsp; &nbsp; &nbsp; if (appname) {</div><div>344 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pktbuf_put_string(msg, "application_name");</div><div>345 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pktbuf_put_string(msg, appname);</div><div>346 &nbsp; &nbsp; &nbsp; &nbsp; }</div><div>347&nbsp;</div><div># add start point</div><div>348 &nbsp; &nbsp; &nbsp; &nbsp; if (options) {</div><div>349 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pktbuf_put_string(msg, "options");</div><div>350 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pktbuf_put_string(msg, options);</div><div>351 &nbsp; &nbsp; &nbsp; &nbsp; }</div><div># add stop point</div></div><div><br></div><div>3. 编译安装修改过的pgbouncer1.4.2</div><div>tar -zxvf pgbouncer-1.4.2.tgz</div><div>cd pgbouncer-1.4.2</div><div>./configure --prefix=/opt/pgbouncer</div><div>gmake</div><div>gmake install</div><div><br></div><div>4. 配置某个需要被pgbouncer连接的greenplum segment节点的pg_hba.conf, reload配置文件,</div><div>在pg_hba.conf加入对pgbouncer服务器的允许, 例如 :&nbsp;</div><div>host all all 0.0.0.0/0 md5</div><div>pg_ctl reload -D $PGDATA</div><div><br></div><div>5. 配置pgbouncer, 启动</div><div># 在[databases]章节多出的部分是&nbsp;<span style="line-height: 22px;"  >options='-c gp_session_role=utility'&nbsp;</span></div><div><div>vi config.ini&nbsp;</div><div>[databases]</div><div>sanpdw = host=172.16.12.12 dbname=digoal port=50001 pool_size=5 options='-c gp_session_role=utility'</div><div>[pgbouncer]</div><div>pool_mode = transaction</div><div>listen_port = 11111</div><div>unix_socket_dir = /opt/pgbouncer/etc</div><div>listen_addr = *</div><div>auth_type = md5</div><div>auth_file = /opt/pgbouncer/etc/users11111.txt</div><div>logfile = /dev/null</div><div>pidfile = /opt/pgbouncer/etc/pgbouncer11111.pid</div><div>max_client_conn = 10000</div><div>reserve_pool_timeout = 0</div><div>server_reset_query =&nbsp;</div><div>admin_users = pgbouncer_admin</div><div>stats_users = pgbouncer_guest</div><div>ignore_startup_parameters = extra_float_digits</div><div>server_lifetime = 60</div><div>server_check_query = select 1</div><div>server_check_delay = 5</div></div><div><br></div><div><div>vi users11111.txt&nbsp;</div><div>"digoal" "md57bc4a6cbe56da1w1f1cbf27d3d3045d5"</div></div><div><br></div><div>chmod 700&nbsp;<span style="line-height: 22px;"  >config.ini</span></div><div><span style="line-height: 22px;"  >chmod 400 users11111.txt</span></div><div><span style="line-height: 22px;"  ><br></span></div><div><span style="line-height: 22px;"  >启动pgbouncer</span></div><div>export LD_LIBRARY_PATH=/lib64:/usr/lib64:/usr/local/lib64:/lib:/usr/lib:/usr/local/lib</div><div>./pgbouncer/bin/pgbouncer -d -u postgres ./pgbouncer/etc/config.ini</div><div><br></div><div>6. 连接测试</div><div>找一台安装了PostgreSQL客户端的机子连接pgbouncer的11111端口 :&nbsp;</div><div>psql -h 172.16.13.13 -p 11111 -U digoal -d digoal -W</div><div>输入密码后就登陆到GreenPlum的segment （<span style="line-height: 22px;"  >172.16.12.12:50001</span>）了.</div><div><div>psql -h 172.16.13.13 -p 11111 -U digoal -d digoal -W</div><div>Password for user digoal:&nbsp;</div><div>psql (9.0.1, server 8.2.13)</div><div>WARNING: psql version 9.0, server version 8.2.</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Some psql features might not work.</div><div>Type "help" for help.</div><div>digoal=&gt;&nbsp;</div></div><div><br></div><div>【小结】</div><div>1. 这种连接方式可以干什么事情呢? 我想了想, 以前遇到过在主节点无法创建表的情形, 原因是该表名在segment节点存在了, 遇到这种情况可能是删表的时候主节点删除了但是segment节点未删除, 当然这种情况很少见.</div><div>2. 在主库无法使用的时候可以利用这种方法对外提供少量服务.&nbsp;</div><div>3. 通过这种方式连进去一定要小心操作, 千万别在里面胡乱建表, greenplum的正规操作还是通过master来做比较靠谱.&nbsp;</div><div><br></div>【参考】<div><a rel="nofollow" href="http://blog.osdba.net/?post=69"  >http://blog.osdba.net/?post=69</a>&nbsp;<br><br><wbr></div></div>
	</div>
</div>
</body>
</html>