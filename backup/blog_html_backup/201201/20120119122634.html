<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL per database or per user audit use pg_log_userqueries</h2>
	<h5 id="">2012-01-19 12:26:34&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402012019112218804/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">PostgreSQL 本身并不带针对某数据库或某用户的SQL审计功能。<wbr><div>通过pg_log_userqueries可以达到这样的目的。</div><div><br></div><div>首先到pgxn下载pg_log_userqueries模块 :&nbsp;</div><div>我测试的是0.4.0版本。</div><div><br></div><div>1. 安装</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># unzip&nbsp;pg_log_userqueries-0.4.0.zip</font></div><div><font size="2"   ># mv&nbsp;<span style="line-height: 22px;"   >pg_log_userqueries-0.4.0&nbsp;</span>/opt/soft_bak/postgresql-9.1.2/contrib/</font></div><div><font size="2"   ># . /home/postgres/.bash_profile</font></div><div><font size="2"   >&gt; cd&nbsp;<span style="line-height: 22px;"   >/opt/soft_bak/postgresql-9.1.2/contrib/</span><span style="line-height: 22px;"   >pg_log_userqueries-0.4.0</span></font></div><div><span style="line-height: 22px;"   ><font size="2"   >&gt; make &amp;&amp; make install</font></span></div><p></p></pre></div><div><br></div><div>2. 修改postgresql.conf 配置文件 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >shared_preload_libraries = 'pg_log_userqueries' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# 如果以前已经配置了其他模块,则用逗号隔开.</font></div><div><div><font size="2"   >custom_variable_classes = 'pg_log_userqueries' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;# list of custom variable class names</font></div><div><font size="2"   >pg_log_userqueries.log_db = 'digoal'</font></div><div><font size="2"   >pg_log_userqueries.log_user = 'digoal'</font></div><div><font size="2"   >pg_log_userqueries.syslog_facility = 'LOCAL0'</font></div><div><font size="2"   >pg_log_userqueries.syslog_ident = 'pg_log_userqueries'</font></div><div><font size="2"   >pg_log_userqueries.log_level = 'NOTICE'</font></div><div><font size="2"   >pg_log_userqueries.log_label = 'user query: '</font></div><div><font size="2"   >pg_log_userqueries.log_destination = 'syslog'</font></div></div><p></p></pre></div><div><br></div><div>2.1 解释 :&nbsp;</div><div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><div style="line-height: 22px;"   ><font size="2"   ><span style="line-height: 22px;"   >log_db='digoal',&nbsp;</span><span style="line-height: 22px;"   >表示我需要审计digoal库的所有查询,</span></font></div></div><div style="line-height: 22px;"   ><font size="2"   >log_user='digoal' 表示我需要审计digoal用户的所有查询</font></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >log_level = 'NOTICE' 审计的日志级别.</font></span></div><p></p></pre></div></div><div style="line-height: 22px;"   ><br></div><div>3. 我这里配置的log_destination是syslog, 因此需要配置操作系统的syslog.conf。</div><div>可以参考我前一篇BLOG。例如 &nbsp;:&nbsp;</div><div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >3.1. 配置操作系统/etc/syslog.conf</div><div style="line-height: 25px; font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><pre class="prettyprint"   ><p style="color: rgb(51, 51, 51);"   ></p><div style="line-height: 25px; font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><font size="2"   >把local0.*;加入到以下行的头部 :&nbsp;</font></div><div style="line-height: 25px; font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><font size="2"   >*.info;mail.none;authpriv.none;cron.none &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /var/log/messages</font></div><div style="line-height: 25px; font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><font size="2"   >更改后变成</font></div><div style="line-height: 25px; font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><font size="2"   >local0.*;*.info;mail.none;authpriv.none;cron.none &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /var/log/messages</font></div><p style="color: rgb(51, 51, 51);"   ></p></pre></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >3.2. 重启syslog服务</div><div style="line-height: 25px; font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><pre class="prettyprint"   ><p><font size="2"   >service syslog restart</font></p></pre></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   >3.3. 确保syslog服务是自动启动的,</div><div style="line-height: 25px; font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><pre class="prettyprint"   ><p style="color: rgb(51, 51, 51);"   ></p><div style="line-height: 25px; font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><font size="2"   >chkconfig --list|grep syslog</font></div><div style="line-height: 25px; font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><font size="2"   >syslog &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0:off &nbsp; 1:off &nbsp; 2:on &nbsp; &nbsp;3:on &nbsp; &nbsp;4:on &nbsp; &nbsp;5:on &nbsp; &nbsp;6:off</font></div><p style="color: rgb(51, 51, 51);"   ></p></pre></div></div><div style="line-height: 25px; color: rgb(51, 51, 51); font-family: Arial, Helvetica, simsun, u5b8bu4f53;"   ><br></div><div>4. 重启数据库</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg_ctl stop -m fast -D $PGDATA</font></div><div><font size="2"   >pg_ctl start -D $PGDATA</font></div><div><font size="2"   >Jan 19 11:15:26 db-172 postgres[6229]: [1-1] LOG: &nbsp;loaded library "pg_log_userqueries"</font></div><p></p></pre></div><div><br></div><div>5. 测试 :&nbsp;</div><div>5.1 查看连接到digoal库的审计</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-172-&gt; psql -h 127.0.0.1 -U postgres digoal</font></div><div><font size="2"   >psql (9.1.2)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >digoal=# select now();</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; now &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-------------------------------</font></div><div><font size="2"   >&nbsp;2012-01-19 11:57:30.678585+08</font></div><p></p></pre></div><div>日志 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >Jan 19 11:57:30 db-172 postgres[6690]: [1] user query: select now();</font></p></pre></div><div><div style="line-height: 22px;"   >5.2 查看用户digoal的审计</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres@db-172-&gt; psql -h 127.0.0.1 -U digoal postgres</font></div><div><font size="2"   >psql (9.1.2)</font></div><div><font size="2"   >Type "help" for help.</font></div><div><font size="2"   >postgres=&gt; select current_date;</font></div><div><font size="2"   >&nbsp; &nbsp; date &nbsp; &nbsp;</font></div><div><font size="2"   >------------</font></div><div><font size="2"   >&nbsp;2012-01-19</font></div><p></p></pre></div><div style="line-height: 22px;"   >日志 :&nbsp;</div><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p><font size="2"   >Jan 19 12:00:22 db-172 postgres[6729]: [1]&nbsp; <span style="line-height: 22px;"   >user query</span>&nbsp;: select current_date;</font></p></pre></div></div><div><div style="line-height: 22px;"   >5.3 验证非审计范围的SQL无输出</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=&gt; \c postgres postgres</font></div><div><font size="2"   >You are now connected to database "postgres" as user "postgres".</font></div><div><font size="2"   >postgres=# select 1;</font></div><div><font size="2"   >&nbsp;?column?&nbsp;</font></div><div><font size="2"   >----------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div style="line-height: 22px;"   >日志 :&nbsp;</div><div style="line-height: 22px;"   >无</div></div><div style="line-height: 22px;"   ><br></div><div style="line-height: 22px;"   >【缺陷】</div><div style="line-height: 22px;"   >暂时没有办法记录用户名和库名. 例如配置以下无法解析到用户名和库名 :&nbsp;</div><div style="line-height: 22px;"   >希望下一版本可以支持.</div><div><pre class="prettyprint"   ><p><font size="2"   >pg_log_userqueries.log_label = '"$dbname" "$user": '</font></p></pre></div><div style="line-height: 22px;"   ><br></div><div>【参考】</div><div><a rel="nofollow" href="http://pgxn.org/dist/pg_log_userqueries/0.4.0/"   >http://pgxn.org/dist/pg_log_userqueries/0.4.0/</a> </div><div><div style="line-height: 22px;"   >可配置参数 ( 截取自源代码文件) :&nbsp;</div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >DefineCustomStringVariable( "pg_log_userqueries.log_label",</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; "Label in front of the user query."</font></div><div style="line-height: 22px;"   ><font size="2"   >DefineCustomStringVariable( "pg_log_userqueries.log_user",</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;&nbsp;"Log statement according to the given user."</font></div><div style="line-height: 22px;"   ><font size="2"   >DefineCustomStringVariable( "pg_log_userqueries.log_db",</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;&nbsp;"Log statement according to the given database."</font></div><div style="line-height: 22px;"   ><font size="2"   >DefineCustomEnumVariable( "pg_log_userqueries.log_destination",</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;&nbsp;"Selects log destination (either stderr or syslog)."</font></div><div style="line-height: 22px;"   ><font size="2"   >DefineCustomEnumVariable( "pg_log_userqueries.syslog_facility",</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;&nbsp;"Selects syslog level of log (same options than PostgreSQL syslog_facility)."</font></div><div style="line-height: 22px;"   ><span style="line-height: 22px;"   ><font size="2"   >DefineCustomStringVariable( "pg_log_userqueries.syslog_ident",</font></span></div><div style="line-height: 22px;"   ><font size="2"   ><span style="line-height: 22px;"   >&nbsp;&nbsp;</span>"Select syslog program identity name."</font></div><div style="line-height: 22px;"   ><font size="2"   >DefineCustomEnumVariable( "pg_log_userqueries.log_level",</font></div></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;&nbsp;"Selects level of log (same options than log_min_messages."</font></div><p></p></pre></div></div></div></div>
	</div>
</div>
</body>
</html>