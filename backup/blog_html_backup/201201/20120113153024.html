<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Use timetravel function trace tuple's DML.</h2>
	<h5 id="">2012-01-13 15:30:24&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020120133019990/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">很久以前, PostgreSQL曾有内建函数来跟踪每条tuple的insert, delete时间。<br><wbr><div>现在使用timetravel也可以来模拟这个功能.&nbsp;</div><div>首先需要创建这个extension :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal=&gt; \c digoal pg92</font></div><div><font size="2"  >You are now connected to database "digoal" as user "pg92".</font></div><div><font size="2"  >digoal=# create extension timetravel;</font></div></div><div><font size="2"  >digoal=# \c digoal digoal</font></div><p></p></pre></div><div>-- 创建测试表 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; create table timetravel_test (id int primary key,info text,insert_user text,update_user text, delete_user text,start_time abstime,stop_time abstime);</font></div><div><font size="2"  >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "timetravel_test_pkey" for table "timetravel_test"</font></div><div><font size="2"  >CREATE TABLE</font></div><p></p></pre></div><div>-- 创建触发器 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; create trigger timetravel</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; before insert or delete or update on timetravel_test</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; for each row</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; execute procedure</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; timetravel (start_time, stop_time, insert_user, update_user, delete_user);</font></div><div><font size="2"  >CREATE TRIGGER</font></div><p></p></pre></div><div>-- 注意创建触发器的时候,&nbsp;<span style="line-height: 22px;"  >insert_user, update_user, delete_user 这几个列都是可选的. 不选择的话则不跟踪是哪个用户做的insert, update, delete操作.</span></div><div><span style="line-height: 22px;"  >-- 插入测试数据 :&nbsp;</span></div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; insert into timetravel_test (id,info) select generate_series(1,10),'digoal';</font></div><div><font size="2"  >INSERT 0 10</font></div><div><font size="2"  >digoal=&gt; select * from timetravel_test ;</font></div><div><font size="2"  >&nbsp;id | &nbsp;info &nbsp;| insert_user | update_user | delete_user | &nbsp; &nbsp; &nbsp; start_time &nbsp; &nbsp; &nbsp; | stop_time&nbsp;</font></div><div><font size="2"  >----+--------+-------------+-------------+-------------+------------------------+-----------</font></div><div><font size="2"  >&nbsp; 1 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp; 2 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp; 3 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp; 4 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp; 5 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp; 6 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp; 7 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp; 8 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp; 9 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp;10 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><p></p></pre></div><div style="line-height: 22px;"  >-- 从测试数据来看，<span style="line-height: 22px;"  >&nbsp;</span><span style="line-height: 22px;"  >timetravel函数帮我们记录了这条tuple是哪个用户插入的, 并且记录了tuple的插入时间, infinity在这里表示这条tuple是有效的。</span></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >-- 下面来更新一条记录看看 :&nbsp;</span></div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; update timetravel_test set info='new' where id=1;</font></div><div><font size="2"  >ERROR: &nbsp;duplicate key value violates unique constraint "timetravel_test_pkey"</font></div><div><font size="2"  >DETAIL: &nbsp;Key (id)=(1) already exists.</font></div><div><font size="2"  >CONTEXT: &nbsp;SQL statement "INSERT INTO timetravel_test VALUES ( $1,$2,$3,$4,$5,$6,$7)"</font></div><p></p></pre></div><div style="line-height: 22px;"  >-- 由于<span style="line-height: 22px;"  >timetravel触发器的原因，更新操作实际上是把被更新的记录的stop_time修改为当前时间，再新增一条start_time为当前时间并且stop_time为infinity的记录. 所以就导致违反了ID的PK约束。</span></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >-- 下面我们把约束去掉重新测试 :&nbsp;</span></div><div style="line-height: 22px;"  ><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; alter table timetravel_test drop CONSTRAINT timetravel_test_pkey;</font></div><div><font size="2"  >ALTER TABLE</font></div><div><font size="2"  >digoal=&gt; update timetravel_test set info='new' where id=1;</font></div><div><font size="2"  >UPDATE 1</font></div><div><div><font size="2"  >digoal=&gt; select * from timetravel_test ;</font></div><div><font size="2"  >&nbsp;id | &nbsp;info &nbsp;| insert_user | update_user | delete_user | &nbsp; &nbsp; &nbsp; start_time &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; stop_time &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+--------+-------------+-------------+-------------+------------------------+------------------------</font></div><div><font size="2"  >&nbsp; 2 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp; 3 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp; 4 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp; 5 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp; 6 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp; 7 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp; 8 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp; 9 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp;10 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp; 1 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | 2012-01-13 15:16:42+08</font></div><div><font size="2"  >&nbsp; 1 | new &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:16:42+08 | infinity</font></div></div><p></p></pre></div></div></div><div>-- 没错，<span style="line-height: 22px;"  >更新操作实际上是把被更新的记录的stop_time修改为当前时间，再新增一条start_time为当前时间并且stop_time为infinity的记录.</span></div><div>-- 再更新一次 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; update timetravel_test set info='new2' where id=1;</font></div><div><font size="2"  >UPDATE 1</font></div><div><font size="2"  >digoal=&gt; select * from timetravel_test ;</font></div><div><font size="2"  >&nbsp;id | &nbsp;info &nbsp;| insert_user | update_user | delete_user | &nbsp; &nbsp; &nbsp; start_time &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; stop_time &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+--------+-------------+-------------+-------------+------------------------+------------------------</font></div><div><font size="2"  >&nbsp; 2 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp; 3 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp; 4 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp; 5 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp; 6 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp; 7 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp; 8 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp; 9 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp;10 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp; 1 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | 2012-01-13 15:16:42+08</font></div><div><font size="2"  >&nbsp; 1 | new &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:16:42+08 | 2012-01-13 15:17:22+08</font></div><div><font size="2"  >&nbsp; 1 | new2 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:17:22+08 | infinity</font></div><p></p></pre></div><div>-- 接下来测试一下删除操作 :&nbsp;</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; delete from timetravel_test where id=2;</font></div><div><font size="2"  >DELETE 1</font></div><div><font size="2"  >digoal=&gt; select * from timetravel_test ;</font></div><div><font size="2"  >&nbsp;id | &nbsp;info &nbsp;| insert_user | update_user | delete_user | &nbsp; &nbsp; &nbsp; start_time &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; stop_time &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >----+--------+-------------+-------------+-------------+------------------------+------------------------</font></div><div><font size="2"  >&nbsp; 3 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp; 4 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp; 5 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp; 6 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp; 7 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp; 8 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp; 9 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp;10 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | infinity</font></div><div><font size="2"  >&nbsp; 1 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:08:52+08 | 2012-01-13 15:16:42+08</font></div><div><font size="2"  >&nbsp; 1 | new &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:16:42+08 | 2012-01-13 15:17:22+08</font></div><div><font size="2"  >&nbsp; 1 | new2 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 2012-01-13 15:17:22+08 | infinity</font></div><div><font size="2"  >&nbsp; 2 | digoal | digoal &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | digoal &nbsp; &nbsp; &nbsp;| 2012-01-13 15:08:52+08 | 2012-01-13 15:18:03+08</font></div><p></p></pre></div><div>-- 说明delete操作是把stop_time修改为当前时间了.</div></div><div>-- 因此创建了timetravel触发器后的表，只有stop_time为infinity 的记录对我们来说是有效记录。</div><div>-- 接下来看看能不能修改start_time和stop_time :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >digoal=&gt; update timetravel_test set stop_time=now() where id=1;</font></div><div><font size="2"  >ERROR: &nbsp;timetravel (timetravel_test): you cannot change start_time and/or stop_time columns (use set_timetravel)</font></div></div><div><div><font size="2"  >digoal=&gt; update timetravel_test set start_time=now() where id=1;</font></div><div><font size="2"  >ERROR: &nbsp;timetravel (timetravel_test): you cannot change start_time and/or stop_time columns (use set_timetravel)</font></div></div><p></p></pre></div><div>-- 没错,&nbsp;<span style="line-height: 22px;"  >timetravel</span><span style="line-height: 22px;"  >&nbsp;对这两个字段进行了保护，不允许用户对这两个字段进行修改。</span></div><div><br></div><div>另外2个函数 :&nbsp;</div><div>-- 关闭<span style="line-height: 22px;"  >timetravel</span><span style="line-height: 22px;"  >&nbsp;对</span>当前session的作用. 其他SESSION不影响. 参数0表示关闭, 1 表示打开.</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select set_timetravel('timetravel_test',0);</font></div><div><font size="2"  >&nbsp;set_timetravel&nbsp;</font></div><div><font size="2"  >----------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div>-- 查看当前SESSION的timetravel 状态, 是否启用. 结果<span style="line-height: 22px;"  >0表示关闭, 1 表示打开.</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select get_timetravel('timetravel_test');</font></div><div><font size="2"  >&nbsp;get_timetravel&nbsp;</font></div><div><font size="2"  >----------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div></div><div>-- 此时在这个SESSION里面就可以修改start_time和stop_time了.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; update timetravel_test set start_time=now() where id=1;</font></div><div><font size="2"  >UPDATE 4</font></div><p></p></pre></div><div><br></div><div>-- 进入另一个SESSION, 是不可以修改的.&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; update timetravel_test set start_time=now() where id=1;</font></div><div><font size="2"  >ERROR: &nbsp;timetravel (timetravel_test): you cannot change start_time and/or stop_time columns (use set_timetravel)</font></div><p></p></pre></div><div><br></div><div>【小结】</div><div>1. timetravel可以对平时变更非常少，但是每次变更都需要有变更轨迹记录的情况。当然这部分功能很容易由应用程序来完成。使用timetravel并不是一个很好的方法，但是timetravel的想法是值得借鉴的。</div><div>【参考】</div><div><a rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/contrib-spi.html"  >http://www.postgresql.org/docs/9.1/static/contrib-spi.html</a> </div></div>
	</div>
</div>
</body>
</html>