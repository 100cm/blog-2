<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL array subscript out of range error explain</h2>
	<h5 id="">2012-01-12 7:41:36&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201201272718196/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">昨天群里一位网友问了一个array相关的问题, 如下 :&nbsp;<div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function ta() returns record as</font></div><div><font size="2"  >&nbsp;$BODY$</font></div><div><font size="2"  >&nbsp;declare</font></div><div><font size="2"  >&nbsp;A INT[10][10];</font></div><div><font size="2"  >&nbsp;begin</font></div><div><font size="2"  >&nbsp;for i in 1..3 loop</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; for j in 1..3 loop</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; A[i][j]:=i*10+j;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; raise notice '%',A[i][j];</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; end loop;</font></div><div><font size="2"  >&nbsp;end loop;</font></div><div><font size="2"  >&nbsp;end;</font></div><div><font size="2"  >&nbsp;$BODY$</font></div><div><font size="2"  >&nbsp;LANGUAGE 'plpgsql' VOLATILE;</font></div><p></p></pre></div><div>大家帮我看看这个函数 , 调用的时候老是报数组下标超出范围。</div><div><br></div><div>执行时报错如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; DO</font></div><div><font size="2"  >digoal-&gt; $$</font></div><div><font size="2"  >digoal$&gt; &nbsp;declare</font></div><div><font size="2"  >digoal$&gt; &nbsp;A INT[10][10];</font></div><div><font size="2"  >digoal$&gt; &nbsp;begin</font></div><div><font size="2"  >digoal$&gt; &nbsp;for i in 1..3 loop</font></div><div><font size="2"  >digoal$&gt; &nbsp; &nbsp; &nbsp; for j in 1..3 loop</font></div><div><font size="2"  >digoal$&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; A[i][j]:=i*10+j;</font></div><div><font size="2"  >digoal$&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; raise notice '%',A[i][j];</font></div><div><font size="2"  >digoal$&gt; &nbsp; &nbsp; &nbsp; end loop;</font></div><div><font size="2"  >digoal$&gt; &nbsp;end loop;</font></div><div><font size="2"  >digoal$&gt; &nbsp;end;</font></div><div><font size="2"  >digoal$&gt; $$;</font></div><div><font size="2"  >NOTICE: &nbsp;11</font></div><div><font size="2"  >ERROR: &nbsp;array subscript out of range</font></div><div><font size="2"  >CONTEXT: &nbsp;PL/pgSQL function "inline_code_block" line 7 at assignment</font></div><p></p></pre></div><div>也就是说第一次赋值是成功的, 后面就失败了.&nbsp;</div><div><br></div><div>于是我专门看了一下手册的8.14章节, 和报错的相关源码部分. 这个报错的原因是PostgreSQL仅支持一位数组的扩展, 但不支持多维数组的扩展.</div><div>手册原文如下 :&nbsp;</div><div><pre class="prettyprint"  ><p><font size="2"  ><span style="font-family: verdana, sans-serif; line-height: 18px;"  >An array can also be constructed by using the functions&nbsp;</span><code style="line-height: 18px;"  >array_prepend</code><span style="font-family: verdana, sans-serif; line-height: 18px;"  >,&nbsp;</span><code style="line-height: 18px;"  >array_append</code><span style="font-family: verdana, sans-serif; line-height: 18px;"  >, or&nbsp;</span><code style="line-height: 18px;"  >array_cat</code><span style="font-family: verdana, sans-serif; line-height: 18px;"  >. The first two only support one-dimensional arrays, but&nbsp;</span><code style="line-height: 18px;"  >array_cat</code><span style="font-family: verdana, sans-serif; line-height: 18px;"  >&nbsp;supports multidimensional arrays.</span></font></p></pre></div><div>也就是说多一位数组可以往数组的前面或后方添加元素，并且可以做数组的连接。但是多维数组只能做连接，不能做前后添加元素。</div><div><br></div><div>下面来举个例子, 例如 :&nbsp;</div><div>一元数组往后添加元素，</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select array_append(ARRAY['digoal','francs'],'david');</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;array_append &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >-----------------------</font></div><div><font size="2"  >&nbsp;{digoal,francs,david}</font></div><p></p></pre></div><div>一元数组在前面插入元素</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select array_prepend('david',ARRAY['digoal','francs']);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;array_prepend &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >-----------------------</font></div><div><font size="2"  >&nbsp;{david,digoal,francs}</font></div><p></p></pre></div><div>二维数组操作则报错 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select array_prepend(ARRAY['david','guo'],ARRAY[['digoal','zhou'],['francs','tan']]);</font></div><div><font size="2"  >ERROR: &nbsp;function array_prepend(text[], text[]) does not exist</font></div><div><font size="2"  >LINE 1: select array_prepend(ARRAY['david','guo'],ARRAY[['digoal','z...</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"  >HINT: &nbsp;No function matches the given name and argument types. You might need to add explicit type casts.</font></div><div><font size="2"  >digoal=&gt; select array_append(ARRAY[['digoal','zhou'],['francs','tan']], ARRAY['david','guo']);</font></div><div><font size="2"  >ERROR: &nbsp;function array_append(text[], text[]) does not exist</font></div><div><font size="2"  >LINE 1: select array_append(ARRAY[['digoal','zhou'],['francs','tan']...</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;^</font></div><div><font size="2"  >HINT: &nbsp;No function matches the given name and argument types. You might need to add explicit type casts.</font></div><p></p></pre></div><div><br><wbr></div></div><div>但是二维数组支持连接操作如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select array_cat(ARRAY[['digoal','zhou'],['francs','tan']], ARRAY['david','guo']);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; array_cat &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >------------------------------------------</font></div><div><font size="2"  >&nbsp;{{digoal,zhou},{francs,tan},{david,guo}}</font></div><p></p></pre></div><div><br></div><div>接下来看看源码部分对这个错误的解释 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >src/backend/utils/adt/arrayfuncs.c</font></div><div><div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /*</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* XXX currently we do not support extending multi-dimensional arrays</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* during assignment</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*/</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for (i = 0; i &lt; ndim; i++)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (indx[i] &lt; lb[i] ||</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; indx[i] &gt;= (dim[i] + lb[i]))</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ereport(ERROR,</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (errcode(ERRCODE_ARRAY_SUBSCRIPT_ERROR),</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;errmsg("array subscript out of range")));</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</font></div></div></div><p></p></pre></div><div><br></div><div>另外, 手册上还指出, 查询array中指定的元素可能是数据库设计上的失误, 如果要查询的话推荐用表字段存储元素来代替array, 对扩展性也是有好处的, 原文如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >Tip:&nbsp;</font></div><div><font size="2"  >Arrays are not sets; searching for specific array elements can be a sign of database misdesign.&nbsp;</font></div><div><font size="2"  >Consider using a separate table with a row for each item that would be an array element.&nbsp;</font></div><div><font size="2"  >This will be easier to search, and is likely to scale better for a large number of elements.</font></div><p></p></pre></div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">晴天 - 2012-01-12 10:23:58</h5>
				<div>受教了<br><br></div>
			</div>
	</div>
</div>
</body>
</html>