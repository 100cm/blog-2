<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Use insert_username Tracking Who Changed a Table</h2>
	<h5 id="">2012-01-13 15:41:16&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201201333830383/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>上一篇BLOG讲的是使用timetravel跟踪TUPLE的DML操作，但是对于有PK的表没有办法实现跟踪，因为每次的UPDATE和DELETE都需要新建一条记录。</div><div><a href="http://blog.163.com/digoal@126/blog/static/16387704020120133019990/"   >http://blog.163.com/digoal@126/blog/static/16387704020120133019990/</a> </div><div><br></div><div>insert_username这个函数是用来跟踪TUPLE被哪个用户修改或者插入的，不涉及新建记录的情况，因此有PK的表也可以跟踪，如下是测试过程 :&nbsp;</div><div>-- 首先创建<span style="line-height: 22px;"   >insert_username extension;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; \c digoal pg92</font></div><div><font size="2"   >You are now connected to database "digoal" as user "pg92".</font></div><div><font size="2"   >digoal=# create extension insert_username;</font></div><div><font size="2"   >CREATE EXTENSION</font></div><p></p></pre></div><div>-- 创建测试表</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# \c digoal digoal</font></div><div><font size="2"   >You are now connected to database "digoal" as user "digoal".</font></div><div><font size="2"   >digoal=&gt; create table trace_username (id int primary key,info text,username text);</font></div><div><font size="2"   >NOTICE: &nbsp;CREATE TABLE / PRIMARY KEY will create implicit index "trace_username_pkey" for table "trace_username"</font></div><div><font size="2"   >CREATE TABLE</font></div><p></p></pre></div><div>-- 创建触发器</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; CREATE TRIGGER insert_usernames</font></div><div><font size="2"   >digoal-&gt; &nbsp; &nbsp; &nbsp; &nbsp; BEFORE INSERT OR UPDATE ON trace_username</font></div><div><font size="2"   >digoal-&gt; &nbsp; &nbsp; &nbsp; &nbsp; FOR EACH ROW</font></div><div><font size="2"   >digoal-&gt; &nbsp; &nbsp; &nbsp; &nbsp; EXECUTE PROCEDURE insert_username (username);</font></div><div><font size="2"   >CREATE TRIGGER</font></div><p></p></pre></div><div>-- 插入测试记录</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; insert into trace_username (id,info) select generate_series(1,10),'digoal';</font></div><div><font size="2"   >INSERT 0 10</font></div><p></p></pre></div><div>-- 可以看到username字段被自动填充了插入这些记录时使用的用户名.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select * from trace_username ;</font></div><div><font size="2"   >&nbsp;id | &nbsp;info &nbsp;| username&nbsp;</font></div><div><font size="2"   >----+--------+----------</font></div><div><font size="2"   >&nbsp; 1 | digoal | digoal</font></div><div><font size="2"   >&nbsp; 2 | digoal | digoal</font></div><div><font size="2"   >&nbsp; 3 | digoal | digoal</font></div><div><font size="2"   >&nbsp; 4 | digoal | digoal</font></div><div><font size="2"   >&nbsp; 5 | digoal | digoal</font></div><div><font size="2"   >&nbsp; 6 | digoal | digoal</font></div><div><font size="2"   >&nbsp; 7 | digoal | digoal</font></div><div><font size="2"   >&nbsp; 8 | digoal | digoal</font></div><div><font size="2"   >&nbsp; 9 | digoal | digoal</font></div><div><font size="2"   >&nbsp;10 | digoal | digoal</font></div><div><font size="2"   >(10 rows)</font></div><p></p></pre></div><div>-- 连接到pg92用户下面，测试插入和更新记录.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; \c digoal pg92</font></div><div><font size="2"   >You are now connected to database "digoal" as user "pg92".</font></div><p></p></pre></div><div>-- 使用pg92用户插入的记录username='pg92'</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# insert into digoal.trace_username (id,info) values (11,'digoal');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=# select * from digoal.trace_username ;</font></div><div><font size="2"   >&nbsp;id | &nbsp;info &nbsp;| username&nbsp;</font></div><div><font size="2"   >----+--------+----------</font></div><div><font size="2"   >&nbsp; 1 | digoal | digoal</font></div><div><font size="2"   >&nbsp; 2 | digoal | digoal</font></div><div><font size="2"   >&nbsp; 3 | digoal | digoal</font></div><div><font size="2"   >&nbsp; 4 | digoal | digoal</font></div><div><font size="2"   >&nbsp; 5 | digoal | digoal</font></div><div><font size="2"   >&nbsp; 6 | digoal | digoal</font></div><div><font size="2"   >&nbsp; 7 | digoal | digoal</font></div><div><font size="2"   >&nbsp; 8 | digoal | digoal</font></div><div><font size="2"   >&nbsp; 9 | digoal | digoal</font></div><div><font size="2"   >&nbsp;10 | digoal | digoal</font></div><div><font size="2"   >&nbsp;11 | digoal | pg92</font></div><div><font size="2"   >(11 rows)</font></div><p></p></pre></div><div>-- 测试使用pg92用户更新一条tuple, 更新后看到username='pg92'</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# update digoal.trace_username set info='new' where id=9;</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   >digoal=# select * from digoal.trace_username ;</font></div><div><font size="2"   >&nbsp;id | &nbsp;info &nbsp;| username&nbsp;</font></div><div><font size="2"   >----+--------+----------</font></div><div><font size="2"   >&nbsp; 1 | digoal | digoal</font></div><div><font size="2"   >&nbsp; 2 | digoal | digoal</font></div><div><font size="2"   >&nbsp; 3 | digoal | digoal</font></div><div><font size="2"   >&nbsp; 4 | digoal | digoal</font></div><div><font size="2"   >&nbsp; 5 | digoal | digoal</font></div><div><font size="2"   >&nbsp; 6 | digoal | digoal</font></div><div><font size="2"   >&nbsp; 7 | digoal | digoal</font></div><div><font size="2"   >&nbsp; 8 | digoal | digoal</font></div><div><font size="2"   >&nbsp;10 | digoal | digoal</font></div><div><font size="2"   >&nbsp;11 | digoal | pg92</font></div><div><font size="2"   >&nbsp; 9 | new &nbsp; &nbsp;| pg92</font></div><div><font size="2"   >(11 rows)</font></div><p></p></pre></div><div><br></div><div>[其他]</div><div>实际上这个需求, 自己编辑触发器也可以实现, 不需要使用这个插件, 例如使用who字段存储用户名.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# create table test (id int, info text, who name);</font></div><div><font size="2"   >CREATE TABLE</font></div></div><div><div><font size="2"   >postgres=# create or replace function tg1() returns trigger as $$</font></div><div><font size="2"   >declare</font></div><div><font size="2"   >begin</font></div><div><font size="2"   >&nbsp; NEW.who := current_user;</font></div><div><font size="2"   >&nbsp; return NEW; &nbsp;</font></div><div><font size="2"   >end;</font></div><div><font size="2"   >$$ language plpgsql;</font></div><div><font size="2"   >CREATE FUNCTION</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres=# create trigger tg1 before insert or update on test for each row execute procedure tg1()</font></div><div><font size="2"   >postgres-# ;</font></div><div><font size="2"   >CREATE TRIGGER</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >postgres=# insert into test values (1,'test','');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# select * from test;</font></div><div><font size="2"   >&nbsp;id | info | &nbsp; who &nbsp; &nbsp;</font></div><div><font size="2"   >----+------+----------</font></div><div><font size="2"   >&nbsp; 1 | test | postgres</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# \du</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of roles</font></div><div><font size="2"   >&nbsp;Role name | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Attributes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Member of&nbsp;</font></div><div><font size="2"   >-----------+------------------------------------------------+-----------</font></div><div><font size="2"   >&nbsp;postgres &nbsp;| Superuser, Create role, Create DB, Replication | {}</font></div><div><font size="2"   >&nbsp;test &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| {}</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# grant all on table test to test;</font></div><div><font size="2"   >GRANT</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=# \c postgres test</font></div><div><font size="2"   >You are now connected to database "postgres" as user "test".</font></div><div><font size="2"   >postgres=&gt; update test set info='new' where id=1;</font></div><div><font size="2"   >UPDATE 1</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >postgres=&gt; select * from test;</font></div><div><font size="2"   >&nbsp;id | info | who &nbsp;</font></div><div><font size="2"   >----+------+------</font></div><div><font size="2"   >&nbsp; 1 | new &nbsp;| test</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div><br></div><div>【参考】</div><div><a rel="nofollow" href="http://www.postgresql.org/docs/9.1/static/contrib-spi.html"   >http://www.postgresql.org/docs/9.1/static/contrib-spi.html</a> </div><div><br></div><wbr></div>
	</div>
</div>
</body>
</html>