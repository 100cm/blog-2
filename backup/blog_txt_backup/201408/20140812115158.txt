PostgreSQL research

Linux iptables SNAT exp

2014-08-12 11:51:58   查看原文>>

本文介绍一下使用linux iptables防火墙实现源地址转换, 达到内网机器通过可以访问外网的Linux机器来访问外网的目的.
例如
Linux机器有2个网卡, eth0和eth1.
eth0连接外网, eth1连接内网, 内网机器可以通过linux来访问外网.
Linux iptables SNAT exp - 德哥@Digoal - PostgreSQL research

又例如, br0网段可以访问外网, 但是如果虚拟机使用的网段不是br0网段的话,  可以在Linux主机配置br0:1, br0:1和虚拟机同网段, 首先让Linux主机和虚拟机可以相互通讯, 然后在Linux主机做SNAT, 达到虚拟机也可以访问外网的目的.
Linux iptables SNAT exp - 德哥@Digoal - PostgreSQL research

环境介绍
虚拟机网段: 172.16.13.0/24

# ifconfig
eth0      Link encap:Ethernet  HWaddr 00:1A:4A:9A:38:1C  
          inet addr:172.16.13.2  Bcast:172.16.13.255  Mask:255.255.255.0
          inet6 addr: fe80::21a:4aff:fe9a:381c/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:243952 errors:0 dropped:0 overruns:0 frame:0
          TX packets:6416 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:35806421 (34.1 MiB)  TX bytes:483841 (472.5 KiB)



Linux主机br0网段: 172.16.3.0/24
Linux主机br0:1网段: 172.16.13.0/24

# ifconfig
br0 Link encap:Ethernet  HWaddr 00:23:7D:A3:F0:4E  
          inet addr:172.16.3.176  Bcast:172.16.3.255  Mask:255.255.255.0
          inet6 addr: fe80::223:7dff:fea3:f04e/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:5573697 errors:0 dropped:0 overruns:0 frame:0
          TX packets:4202453 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:2475677006 (2.3 GiB)  TX bytes:522026043 (497.8 MiB)

br0:1 Link encap:Ethernet  HWaddr 00:23:7D:A3:F0:4E  
          inet addr:172.16.13.103  Bcast:172.16.13.255  Mask:255.255.255.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1



测试Linux 主机和虚拟机可以相互通讯.

[root@176 ~]# ping 172.16.13.2
PING 172.16.13.2 (172.16.13.2) 56(84) bytes of data.
64 bytes from 172.16.13.2: icmp_seq=1 ttl=64 time=0.447 ms



配置虚拟机网关, dns

[root@13 ~]# cat /etc/sysconfig/network
NETWORKING=yes
HOSTNAME=13.2.sky-mobi.com
GATEWAY=172.16.13.103

[root@13 ~]# cat /etc/sysconfig/network-scripts/ifcfg-eth0
DEVICE=eth0
TYPE=Ethernet
UUID=d6da67cd-092d-4a0d-a165-0a8d397c1e9c
ONBOOT=yes
NM_CONTROLLED=yes
BOOTPROTO=none
HWADDR=00:1A:4A:9A:38:1C
IPADDR=172.16.13.2
PREFIX=24
GATEWAY=172.16.13.103
DEFROUTE=yes
IPV4_FAILURE_FATAL=yes
IPV6INIT=no
NAME=eth0

[root@13 ~]# cat /etc/resolv.conf 
nameserver 202.101.172.35
[root@13 ~]# service network restart



配置Linux主机的iptables
分别对nat和filter链表插入几条记录.
172.16.3.176是Linux主机br0的地址, 用于外部通讯,
172.16.13.103是Linux主机br0:1的地址, 用于与虚拟机通讯,
172.16.13.2是虚拟机eth0的地址.

[root@176 ~]# iptables -t nat -I POSTROUTING -s 172.16.13.0/24 -j SNAT --to-source 172.16.3.176
[root@176 ~]# iptables -t filter -I FORWARD -d 172.16.13.0/24 -j ACCEPT
[root@176 ~]# iptables -t filter -I FORWARD -s 172.16.13.0/24 -j ACCEPT

查看当前配置
[root@176 ~]# iptables-save
# Generated by iptables-save v1.4.7 on Tue Aug 12 11:40:51 2014
*nat
:PREROUTING ACCEPT [179:25078]
:POSTROUTING ACCEPT [1:76]
:OUTPUT ACCEPT [1:76]
-A POSTROUTING -s 172.16.13.0/24 -j SNAT --to-source 172.16.3.176 
COMMIT
# Completed on Tue Aug 12 11:40:51 2014
# Generated by iptables-save v1.4.7 on Tue Aug 12 11:40:51 2014
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [835:177362]
-A INPUT -p gre -j ACCEPT 
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT 
-A INPUT -p icmp -j ACCEPT 
-A INPUT -i lo -j ACCEPT 
-A INPUT -s 192.168.0.0/16 -j ACCEPT 
-A INPUT -s 10.0.0.0/8 -j ACCEPT 
-A INPUT -s 172.16.0.0/16 -j ACCEPT 
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT 
-A INPUT -j REJECT --reject-with icmp-host-prohibited 
-A FORWARD -s 172.16.13.0/24 -j ACCEPT 
-A FORWARD -d 172.16.13.0/24 -j ACCEPT 
-A FORWARD -j REJECT --reject-with icmp-host-prohibited 
COMMIT
# Completed on Tue Aug 12 11:40:51 2014


以上内容拷贝到配置文件 /etc/sysconfig/iptables .

查看nat和filter链表当前情况.

[root@176 ~]# iptables -L -v -n -t nat
Chain PREROUTING (policy ACCEPT 810 packets, 98255 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain POSTROUTING (policy ACCEPT 16 packets, 1038 bytes)
 pkts bytes target     prot opt in     out     source               destination         
   51  3318 SNAT       all  --  *      *       172.16.13.0/24       0.0.0.0/0           to:172.16.3.176 

Chain OUTPUT (policy ACCEPT 16 packets, 1038 bytes)
 pkts bytes target     prot opt in     out     source               destination         

[root@176 ~]# iptables -L -v -n -t filter
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 ACCEPT     47   --  *      *       0.0.0.0/0            0.0.0.0/0           
  28M 9271M ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED 
    7   588 ACCEPT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0           
 1031 53181 ACCEPT     all  --  lo     *       0.0.0.0/0            0.0.0.0/0           
    0     0 ACCEPT     all  --  *      *       192.168.0.0/16       0.0.0.0/0           
    0     0 ACCEPT     all  --  *      *       10.0.0.0/8           0.0.0.0/0           
 162K   11M ACCEPT     all  --  *      *       172.16.0.0/16        0.0.0.0/0           
    0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           state NEW tcp dpt:22 
 116K   58M REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           reject-with icmp-host-prohibited 

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         
  351 29448 ACCEPT     all  --  *      *       172.16.13.0/24       0.0.0.0/0           
  350 29650 ACCEPT     all  --  *      *       0.0.0.0/0            172.16.13.0/24      
  308 25550 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           reject-with icmp-host-prohibited 

Chain OUTPUT (policy ACCEPT 24597 packets, 6048K bytes)
 pkts bytes target     prot opt in     out     source               destination

[root@176 ~]# iptables -L -v -n -t mangle
Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

[root@176 ~]# iptables -L -v -n -t raw
Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
 pkts bytes target     prot opt in     out     source               destination         



如果写错了用-D删除, 别忘记指定链表, 例如

[root@176 ~]# iptables -t filter -D FORWARD -d 172.16.13.0/24 -j ACCEPT


也可以指定行号删除.

[root@176 ~]# iptables -t filter -L -v -n --line-numbers
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        0     0 ACCEPT     47   --  *      *       0.0.0.0/0            0.0.0.0/0           
2     229K   87M ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED 
3        0     0 ACCEPT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0           
4       13  1474 ACCEPT     all  --  lo     *       0.0.0.0/0            0.0.0.0/0           
5        0     0 ACCEPT     all  --  *      *       192.168.0.0/16       0.0.0.0/0           
6        0     0 ACCEPT     all  --  *      *       10.0.0.0/8           0.0.0.0/0           
7      658 51009 ACCEPT     all  --  *      *       172.16.0.0/16        0.0.0.0/0           
8        0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           state NEW tcp dpt:22 
9      850  426K REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           reject-with icmp-host-prohibited 

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        0     0 ACCEPT     all  --  *      *       172.16.13.0/24       0.0.0.0/0           
2        0     0 ACCEPT     all  --  *      *       0.0.0.0/0            172.16.13.0/24      
3        0     0 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           reject-with icmp-host-prohibited 

Chain OUTPUT (policy ACCEPT 230K packets, 57M bytes)
num   pkts bytes target     prot opt in     out     source               destination 


删除第一行

iptables -t filter -D INPUT 1


配置Linux主机ipforward, icmp转发.
开启ip_forward.

[root@176 ~]# sysctl -w net.ipv4.ip_forward=1

[root@176 ~]# vi /etc/sysctl.conf
# Controls IP packet forwarding
net.ipv4.ip_forward = 1



默认已经开启了ICMP转发.所以不需要配置.

[root@176 ~]# sysctl -a|grep send_redirects
net.ipv4.conf.all.send_redirects = 1
net.ipv4.conf.default.send_redirects = 1
net.ipv4.conf.lo.send_redirects = 1
net.ipv4.conf.eth0.send_redirects = 1
net.ipv4.conf.eth1.send_redirects = 1
net.ipv4.conf.ovirtmgmt.send_redirects = 1



测试虚拟机是否可以上外网.

[root@13 ~]# ping www.baidu.com
PING www.a.shifen.com (115.239.210.27) 56(84) bytes of data.
64 bytes from 115.239.210.27: icmp_seq=1 ttl=55 time=2.47 ms



[参考]
1. man iptables
2. http://www.netfilter.org/documentation/HOWTO//NAT-HOWTO.html
Flag Counter
